<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng Qu·∫£n L√Ω Trung T√¢m - V4.0</title>

    <!-- ========== TH∆Ø VI·ªÜN B√äN NGO√ÄI ========== -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- Chart.js v4 - Lightweight -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <!-- CryptoJS - Th∆∞ vi·ªán m√£ h√≥a -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>

    <style>
        /* ============================================================
   üé® PH·∫¶N 1: CSS VARIABLES (Bi·∫øn m√†u s·∫Øc)
   ============================================================ */
        :root {
            /* M√†u ch√≠nh - Xanh d∆∞∆°ng nh·∫π (t√¥ng gi√°o d·ª•c) */
            --primary-color: #4A90A4;
            --primary-dark: #357A8C;
            --primary-light: #6BA3B5;
            --primary-lighter: #E8F4F8;

            /* Gradient ch√≠nh */
            --primary-gradient: linear-gradient(135deg, #4A90A4 0%, #5BA0B5 50%, #6BB0C5 100%);
            --sidebar-gradient: linear-gradient(180deg, #00639971 0%, #006399 100%);

            /* M√†u n·ªÅn */
            --bg-main: #F5F7FA;
            --bg-white: #FFFFFF;
            --bg-light: #F8FAFB;
            --bg-dark: #006399;

            /* M√†u ch·ªØ */
            --text-primary: #2C3E50;
            --text-secondary: #5D6D7E;
            --text-muted: #95A5A6;
            --text-white: #FFFFFF;

            /* M√†u tr·∫°ng th√°i */
            --status-hoc-thu: #3498DB;
            --status-cho-dk: #F39C12;
            --status-da-dk: #27AE60;
            --status-hoan-thanh: #9B59B6;
            --status-cancel: #E74C3C;

            /* M√†u button */
            --btn-success: #27AE60;
            --btn-info: #3498DB;
            --btn-warning: #F39C12;
            --btn-danger: #E74C3C;
            --btn-secondary: #95A5A6;

            /* Border & Shadow */
            --border-color: #E1E8ED;
            --border-radius: 8px;
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.15);

            /* K√≠ch th∆∞·ªõc */
            --sidebar-width: 260px;
            --sidebar-collapsed-width: 70px;
            --header-height: 60px;
        }

        /* ============================================================
   üîß PH·∫¶N 2: CSS RESET & BASE
   ============================================================ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 14px;
            color: var(--text-primary);
            background: var(--bg-main);
            line-height: 1.5;
            overflow-x: hidden;
        }

        /* ============================================================
   üîê PH·∫¶N 3: LOGIN SCREEN
   ============================================================ */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #4A90A4 0%, #2C3E50 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .login-screen.hidden {
            display: none;
        }

        .login-container {
            background: var(--bg-white);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 420px;
            animation: loginSlideIn 0.5s ease;
        }

        @keyframes loginSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .login-logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-logo .logo-icon {
            width: 80px;
            height: 80px;
            background: var(--primary-gradient);
            border-radius: 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            margin-bottom: 15px;
            box-shadow: var(--shadow-md);
        }

        .login-logo h1 {
            color: var(--text-primary);
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .login-logo p {
            color: var(--text-muted);
            font-size: 14px;
        }

        .login-form .form-group {
            margin-bottom: 20px;
            position: relative;
        }

        .login-form .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 13px;
        }

        .login-form .input-wrapper {
            position: relative;
        }

        .login-form .input-wrapper .input-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 16px;
            color: var(--text-muted);
        }

        .login-form .form-group input {
            width: 100%;
            padding: 14px 15px 14px 45px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.3s;
        }

        .login-form .form-group input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(74, 144, 164, 0.1);
        }

        .login-form .form-group input.error {
            border-color: var(--btn-danger);
        }

        .login-form .form-options {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .login-form .remember-me {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .login-form .remember-me input {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .login-form .btn-login {
            width: 100%;
            padding: 14px;
            background: var(--primary-gradient);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .login-form .btn-login:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(74, 144, 164, 0.4);
        }

        .login-form .btn-login:active {
            transform: translateY(0);
        }

        .login-form .btn-login:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .login-error {
            background: #FDEDEC;
            color: var(--btn-danger);
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
            align-items: center;
            gap: 10px;
        }

        .login-error.show {
            display: flex;
        }

        .login-footer {
            text-align: center;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }

        .login-footer p {
            color: var(--text-muted);
            font-size: 13px;
        }

        /* Password toggle */
        .password-toggle {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: var(--text-muted);
            padding: 5px;
        }

        .password-toggle:hover {
            color: var(--primary-color);
        }

        /* ============================================================
   üìê PH·∫¶N 4: APP LAYOUT (Sidebar, Header, Content)
   ============================================================ */
        .app-container {
            display: none;
            min-height: 100vh;
        }

        .app-container.show {
            display: flex;
        }

        /* ----- Sidebar ----- */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--sidebar-gradient);
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            z-index: 1000;
            transition: width 0.3s ease;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-lg);
        }

        .sidebar.collapsed {
            width: var(--sidebar-collapsed-width);
        }

        .sidebar-logo {
            height: var(--header-height);
            display: flex;
            align-items: center;
            padding: 0 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            gap: 12px;
        }

        .sidebar-logo .logo-icon {
            width: 40px;
            height: 40px;
            background: var(--primary-gradient);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
        }

        .sidebar-logo .logo-text {
            color: var(--text-white);
            font-size: 16px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            transition: opacity 0.3s;
        }

        .sidebar.collapsed .logo-text {
            opacity: 0;
            width: 0;
        }

        /* Navigation */
        .sidebar-nav {
            flex: 1;
            overflow-y: auto;
            padding: 15px 0;
        }

        .sidebar-nav::-webkit-scrollbar {
            width: 5px;
        }

        .sidebar-nav::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }

        .nav-item {
            margin: 2px 10px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.2s;
            gap: 12px;
        }

        .nav-link:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-white);
        }

        .nav-link.active {
            background: var(--primary-color);
            color: var(--text-white);
            box-shadow: var(--shadow-sm);
        }

        .nav-link .nav-icon {
            width: 22px;
            text-align: center;
            font-size: 16px;
            flex-shrink: 0;
        }

        .nav-link .nav-text {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            transition: opacity 0.3s;
        }

        .sidebar.collapsed .nav-text {
            opacity: 0;
            width: 0;
        }

        .nav-link .nav-arrow {
            font-size: 12px;
            transition: transform 0.3s;
        }

        .nav-link.expanded .nav-arrow {
            transform: rotate(90deg);
        }

        .sidebar.collapsed .nav-arrow {
            display: none;
        }

        /* Submenu */
        .nav-submenu {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background: rgba(0, 0, 0, 0.15);
            border-radius: var(--border-radius);
            margin-top: 2px;
        }

        .nav-submenu.open {
            max-height: 500px;
        }

        .sidebar.collapsed .nav-submenu {
            display: none;
        }

        .nav-submenu .nav-link {
            padding: 10px 15px 10px 49px;
            font-size: 13px;
        }

        .nav-submenu .nav-link::before {
            content: '';
            width: 6px;
            height: 6px;
            background: rgba(255, 255, 255, 0.4);
            border-radius: 50%;
            margin-right: 10px;
        }

        .nav-submenu .nav-link.active::before,
        .nav-submenu .nav-link:hover::before {
            background: var(--text-white);
        }

        /* Sidebar Footer */
        .sidebar-footer {
            padding: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-footer .version {
            color: rgba(255, 255, 255, 0.5);
            font-size: 12px;
            text-align: center;
        }

        .sidebar.collapsed .sidebar-footer .version {
            display: none;
        }

        /* ----- Main Wrapper ----- */
        .main-wrapper {
            flex: 1;
            margin-left: var(--sidebar-width);
            transition: margin-left 0.3s ease;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .sidebar.collapsed~.main-wrapper {
            margin-left: var(--sidebar-collapsed-width);
        }

        /* ----- Header ----- */
        .main-header {
            height: var(--header-height);
            background: var(--bg-white);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 25px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-sm);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .toggle-sidebar-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: var(--bg-light);
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 18px;
            color: var(--text-secondary);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .toggle-sidebar-btn:hover {
            background: var(--primary-lighter);
            color: var(--primary-color);
        }

        .page-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: var(--bg-light);
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 16px;
            color: var(--text-secondary);
            transition: all 0.2s;
            position: relative;
        }

        .header-btn:hover {
            background: var(--primary-lighter);
            color: var(--primary-color);
        }

        .header-btn .badge {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 18px;
            height: 18px;
            background: var(--btn-danger);
            color: white;
            border-radius: 50%;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* User Dropdown */
        .user-dropdown {
            position: relative;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 5px 12px;
            background: var(--bg-light);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .user-info:hover {
            background: var(--primary-lighter);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            background: var(--primary-gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            font-weight: 600;
        }

        .user-name {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .user-role {
            font-size: 11px;
            color: var(--text-muted);
            background: var(--bg-main);
            padding: 2px 8px;
            border-radius: 10px;
        }

        .user-menu {
            position: absolute;
            top: calc(100% + 10px);
            right: 0;
            background: var(--bg-white);
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            min-width: 200px;
            padding: 8px 0;
            display: none;
            z-index: 1000;
            border: 1px solid var(--border-color);
        }

        .user-menu.show {
            display: block;
            animation: fadeIn 0.2s ease;
        }

        .user-menu-header {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 8px;
        }

        .user-menu-header .name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .user-menu-header .email {
            font-size: 12px;
            color: var(--text-muted);
        }

        .user-menu-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }

        .user-menu-item:hover {
            background: var(--bg-light);
            color: var(--primary-color);
        }

        .user-menu-item.danger {
            color: var(--btn-danger);
        }

        .user-menu-item.danger:hover {
            background: #FDEDEC;
        }

        .user-menu-divider {
            height: 1px;
            background: var(--border-color);
            margin: 8px 0;
        }

        /* ----- Main Content ----- */
        .main-content {
            flex: 1;
            padding: 25px;
            background: var(--bg-main);
        }

        /* ============================================================
   üì¶ PH·∫¶N 5: COMPONENTS (Cards, Tables, Buttons, Forms...)
   ============================================================ */

        /* ----- Page Header ----- */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .page-header h2 {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .page-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* ----- Stats Cards ----- */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: var(--bg-white);
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s;
            border: 1px solid var(--border-color);
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .stat-icon.blue {
            background: linear-gradient(135deg, #3498DB 0%, #5DADE2 100%);
        }

        .stat-icon.orange {
            background: linear-gradient(135deg, #F39C12 0%, #F5B041 100%);
        }

        .stat-icon.green {
            background: linear-gradient(135deg, #27AE60 0%, #52D681 100%);
        }

        .stat-icon.purple {
            background: linear-gradient(135deg, #9B59B6 0%, #BB8FCE 100%);
        }

        .stat-icon.red {
            background: linear-gradient(135deg, #E74C3C 0%, #EC7063 100%);
        }

        .stat-icon.teal {
            background: linear-gradient(135deg, #4A90A4 0%, #6BB0C5 100%);
        }

        .stat-info h3 {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 3px;
        }

        .stat-info p {
            font-size: 13px;
            color: var(--text-muted);
        }

        /* ----- Cards ----- */
        .card {
            background: var(--bg-white);
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            margin-bottom: 20px;
        }

        .card-header {
            padding: 18px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-header h3 {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-body {
            padding: 20px;
        }

        /* ----- Tables ----- */
        .table-container {
            overflow-x: auto;
            background: var(--bg-white);
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: var(--primary-gradient);
            color: white;
        }

        th {
            padding: 14px 16px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            white-space: nowrap;
        }

        td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            font-size: 14px;
        }

        tbody tr:hover {
            background: var(--primary-lighter);
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        /* ----- Buttons ----- */
        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: var(--border-radius);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--primary-gradient);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(74, 144, 164, 0.4);
        }

        .btn-success {
            background: var(--btn-success);
            color: white;
        }

        .btn-success:hover {
            background: #219A52;
        }

        .btn-info {
            background: var(--btn-info);
            color: white;
        }

        .btn-info:hover {
            background: #2980B9;
        }

        .btn-warning {
            background: var(--btn-warning);
            color: white;
        }

        .btn-warning:hover {
            background: #D68910;
        }

        .btn-danger {
            background: var(--btn-danger);
            color: white;
        }

        .btn-danger:hover {
            background: #C0392B;
        }

        .btn-secondary {
            background: var(--btn-secondary);
            color: white;
        }

        .btn-secondary:hover {
            background: #7F8C8D;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
        }

        .btn-outline:hover {
            background: var(--primary-color);
            color: white;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 13px;
        }

        .btn-icon {
            width: 32px;
            height: 32px;
            padding: 0;
            justify-content: center;
        }

        /* ----- Action Buttons ----- */
        .action-buttons {
            display: flex;
            gap: 5px;
        }

        .action-btn {
            width: 30px;
            height: 30px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .action-btn:hover {
            transform: scale(1.1);
        }

        .action-btn.view {
            background: #E8F4FD;
            color: #3498DB;
        }

        .action-btn.edit {
            background: #E8F8F0;
            color: #27AE60;
        }

        .action-btn.delete {
            background: #FDEDEC;
            color: #E74C3C;
        }

        .action-btn.schedule {
            background: #FEF5E7;
            color: #F39C12;
        }

        .action-btn.receipt {
            background: #F5EEF8;
            color: #9B59B6;
        }

        .action-btn.lock {
            background: #FDEDEC;
            color: #E74C3C;
        }

        .action-btn.unlock {
            background: #E8F8F0;
            color: #27AE60;
        }

        .action-btn.key {
            background: #FEF5E7;
            color: #F39C12;
        }

        /* ----- Status Badges ----- */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-badge.hoc-thu {
            background: #E8F4FD;
            color: var(--status-hoc-thu);
        }

        .status-badge.cho-dk {
            background: #FEF5E7;
            color: var(--status-cho-dk);
        }

        .status-badge.da-dk {
            background: #E8F8F0;
            color: var(--status-da-dk);
        }

        .status-badge.hoan-thanh {
            background: #F5EEF8;
            color: var(--status-hoan-thanh);
        }

        .status-badge.cancel {
            background: #FDEDEC;
            color: var(--status-cancel);
        }

        .status-badge.active {
            background: #E8F8F0;
            color: var(--btn-success);
        }

        .status-badge.locked {
            background: #FDEDEC;
            color: var(--btn-danger);
        }

        /* Role badges */
        .role-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: 600;
        }

        .role-badge.admin {
            background: #FDEDEC;
            color: #E74C3C;
        }

        .role-badge.manager {
            background: #FEF5E7;
            color: #F39C12;
        }

        .role-badge.user {
            background: #E8F4FD;
            color: #3498DB;
        }

        /* ----- Filter Bar ----- */
        .filter-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 2px solid var(--border-color);
            border-radius: 20px;
            background: white;
            cursor: pointer;
            font-weight: 500;
            font-size: 13px;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .filter-btn:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        .filter-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .filter-btn .count {
            background: rgba(0, 0, 0, 0.1);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
        }

        .filter-btn.active .count {
            background: rgba(255, 255, 255, 0.3);
        }

        .search-box {
            position: relative;
            flex: 1;
            min-width: 200px;
            max-width: 300px;
        }

        .search-box input {
            width: 100%;
            padding: 10px 15px 10px 40px;
            border: 2px solid var(--border-color);
            border-radius: 20px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .search-box::before {
            content: 'üîç';
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 14px;
        }

        /* ----- Forms ----- */
        .form-section {
            background: var(--bg-light);
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            border: 2px solid var(--border-color);
            display: none;
        }

        .form-section.show {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-15px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }

        .form-section-header h3 {
            color: var(--primary-color);
            font-size: 16px;
        }

        .form-group {
            margin-bottom: 18px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 13px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 14px;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .form-group input:disabled,
        .form-group select:disabled {
            background: var(--bg-light);
            cursor: not-allowed;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        .checkbox-item input {
            width: auto;
        }

        /* ----- Permission Matrix ----- */
        .permission-matrix {
            background: var(--bg-white);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .permission-matrix table {
            width: 100%;
        }

        .permission-matrix th {
            background: var(--bg-light);
            color: var(--text-primary);
            font-weight: 600;
            padding: 12px 15px;
            text-align: center;
            border-bottom: 2px solid var(--border-color);
        }

        .permission-matrix th:first-child {
            text-align: left;
        }

        .permission-matrix td {
            padding: 10px 15px;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
        }

        .permission-matrix td:first-child {
            text-align: left;
            font-weight: 500;
        }

        .permission-matrix tr:last-child td {
            border-bottom: none;
        }

        .permission-matrix .tab-name {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .permission-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        /* ----- Pagination ----- */
        .pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding: 15px 20px;
            background: var(--bg-white);
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
            flex-wrap: wrap;
            gap: 15px;
        }

        .pagination-info {
            color: var(--text-muted);
            font-size: 14px;
        }

        .pagination {
            display: flex;
            gap: 5px;
        }

        .pagination button {
            padding: 8px 14px;
            border: 2px solid var(--border-color);
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.2s;
        }

        .pagination button:hover:not(:disabled) {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        .pagination button.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .page-size-select {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: var(--text-muted);
        }

        .page-size-select select {
            padding: 6px 10px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
        }

        /* ----- Modals ----- */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlideIn 0.3s ease;
            box-shadow: var(--shadow-lg);
        }

        .modal-lg {
            max-width: 800px;
        }

        .modal-sm {
            max-width: 450px;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 25px;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-header h2 {
            color: var(--primary-color);
            font-size: 18px;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border: none;
            background: var(--bg-light);
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            color: var(--text-muted);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            background: var(--btn-danger);
            color: white;
        }

        .modal-body {
            padding: 25px;
        }

        .modal-footer {
            padding: 15px 25px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        /* ----- Notifications ----- */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 12px;
            background: white;
            box-shadow: var(--shadow-lg);
            z-index: 3000;
            display: none;
            align-items: center;
            gap: 12px;
            max-width: 350px;
            animation: slideInRight 0.3s ease;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .notification.show {
            display: flex;
        }

        .notification.success {
            border-left: 4px solid var(--btn-success);
        }

        .notification.error {
            border-left: 4px solid var(--btn-danger);
        }

        .notification.warning {
            border-left: 4px solid var(--btn-warning);
        }

        .notification.info {
            border-left: 4px solid var(--btn-info);
        }

        /* ----- Empty State ----- */
        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .empty-state p {
            font-size: 16px;
        }

        /* ----- Tags ----- */
        .subject-tag {
            display: inline-block;
            padding: 3px 10px;
            background: var(--primary-lighter);
            color: var(--primary-dark);
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            margin: 2px;
        }

        /* ----- Quick View ----- */
        .quick-view-section {
            background: var(--bg-light);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .quick-view-section h4 {
            color: var(--primary-color);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
            font-size: 14px;
        }

        .quick-view-row {
            display: flex;
            padding: 6px 0;
            font-size: 14px;
        }

        .quick-view-label {
            font-weight: 600;
            color: var(--text-secondary);
            min-width: 120px;
        }

        .quick-view-value {
            color: var(--text-primary);
            flex: 1;
        }

        /* ----- Chart ----- */
        .chart-container {
            background: var(--bg-white);
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
        }

        .chart-bars {
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            height: 180px;
            padding: 15px 0;
            border-bottom: 2px solid var(--border-color);
        }

        .chart-bar-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
        }

        .chart-bar {
            width: 40px;
            background: var(--primary-gradient);
            border-radius: 6px 6px 0 0;
            transition: all 0.3s;
            position: relative;
            min-height: 5px;
        }

        .chart-bar:hover {
            opacity: 0.8;
        }

        .chart-bar-value {
            position: absolute;
            top: -22px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 11px;
            font-weight: 600;
            color: var(--primary-color);
            white-space: nowrap;
        }

        .chart-bar-label {
            margin-top: 8px;
            font-size: 12px;
            color: var(--text-muted);
        }

        /* ----- Settings ----- */
        .settings-group {
            background: var(--bg-white);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .settings-group h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-color);
            font-size: 16px;
        }

        .logo-preview {
            width: 100px;
            height: 100px;
            border: 2px dashed var(--border-color);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 10px 0;
            overflow: hidden;
        }

        .logo-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        /* ----- Upcoming Items ----- */
        .upcoming-item {
            background: #FEF9E7;
            padding: 12px 15px;
            border-radius: 8px;
            border-left: 4px solid var(--btn-warning);
            margin-bottom: 10px;
            font-size: 14px;
        }

        /* ============================================================
   üîß PH·∫¶N 6: UTILITIES
   ============================================================ */
        .text-center {
            text-align: center;
        }

        .text-muted {
            color: var(--text-muted);
        }

        .text-success {
            color: var(--btn-success);
        }

        .text-danger {
            color: var(--btn-danger);
        }

        .text-primary {
            color: var(--primary-color);
        }

        .text-warning {
            color: var(--btn-warning);
        }

        .d-flex {
            display: flex;
        }

        .d-none {
            display: none !important;
        }

        .gap-10 {
            gap: 10px;
        }

        .gap-15 {
            gap: 15px;
        }

        .gap-20 {
            gap: 20px;
        }

        .justify-between {
            justify-content: space-between;
        }

        .justify-center {
            justify-content: center;
        }

        .align-center {
            align-items: center;
        }

        .flex-wrap {
            flex-wrap: wrap;
        }

        .flex-1 {
            flex: 1;
        }

        .mt-10 {
            margin-top: 10px;
        }

        .mt-15 {
            margin-top: 15px;
        }

        .mt-20 {
            margin-top: 20px;
        }

        .mb-10 {
            margin-bottom: 10px;
        }

        .mb-15 {
            margin-bottom: 15px;
        }

        .mb-20 {
            margin-bottom: 20px;
        }

        .p-20 {
            padding: 20px;
        }

        .fw-600 {
            font-weight: 600;
        }

        .fw-700 {
            font-weight: 700;
        }

        /* ============================================================
   üì± PH·∫¶N 7: RESPONSIVE
   ============================================================ */
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.mobile-open {
                transform: translateX(0);
            }

            .main-wrapper {
                margin-left: 0;
            }

            .sidebar.collapsed~.main-wrapper {
                margin-left: 0;
            }
        }

        @media (max-width: 768px) {

            .form-row,
            .form-row-3 {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }

            .page-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .filter-bar {
                flex-direction: column;
                align-items: stretch;
            }

            .search-box {
                max-width: none;
            }

            .pagination-container {
                flex-direction: column;
            }

            .user-name,
            .user-role {
                display: none;
            }

            .login-container {
                padding: 30px 20px;
                margin: 15px;
            }
        }

        @media (max-width: 480px) {
            .main-content {
                padding: 15px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .page-title {
                font-size: 16px;
            }
        }

        /* ============================================================
   üñ®Ô∏è PH·∫¶N 8: PRINT STYLES
   ============================================================ */
        @media print {

            .sidebar,
            .main-header,
            .page-actions,
            .filter-bar,
            .pagination-container,
            .action-buttons,
            .login-screen {
                display: none !important;
            }

            .main-wrapper {
                margin-left: 0 !important;
            }

            .main-content {
                padding: 0;
            }
        }

        /* ----- Report Tabs ----- */
        .report-tabs {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .report-tab {
            padding: 10px 20px;
            border: none;
            background: var(--bg-light);
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .report-tab:hover {
            background: var(--primary-lighter);
            color: var(--primary-color);
        }

        .report-tab.active {
            background: var(--primary-color);
            color: white;
        }

        .report-content {
            border-top: 2px solid var(--primary-color);
        }

        .p-20 {
            padding: 20px;
        }

        /* ============================================================
        ‚ú® PH·∫¶N 9: ANIMATIONS
        ============================================================ */
        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .fade-in {
            animation: fadeIn 0.3s ease;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        /* Loading spinner */
        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        /* ============================================================
        üñ®Ô∏è PH·∫¶N 10: PRINT STYLES - PHI·∫æU ƒêƒÇNG K√ù & BI√äN LAI (V2 - FIX)
        ============================================================ */

        /* ----- Print Preview - Hi·ªán full kh√¥ng scroll ----- */
        .print-preview-wrapper {
            background: #f1f5f9;
            border-radius: 8px;
            padding: 15px;
            display: flex;
            justify-content: center;
        }

        /* ----- Print Document - Thu nh·ªè trong preview ----- */
        .print-document {
            width: 100%;
            max-width: 500px;
            padding: 25px 30px;
            background: white;
            font-family: 'Times New Roman', Times, serif;
            font-size: 13px;
            color: #1a1a1a;
            line-height: 1.5;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border-radius: 4px;
        }

        /* ----- Print Header ----- */
        .print-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding-bottom: 12px;
            border-bottom: 2px solid #1e40af;
            margin-bottom: 15px;
        }

        .print-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .print-logo {
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            color: white;
            flex-shrink: 0;
        }

        .print-logo img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 6px;
        }

        .print-company-info {
            flex: 1;
        }

        .print-company-info h2 {
            color: #1e40af;
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 2px;
            text-transform: uppercase;
        }

        .print-company-info p {
            font-size: 11px;
            color: #475569;
            margin: 1px 0;
        }

        .print-qr-code {
            width: 55px;
            height: 55px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 3px;
            background: white;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .print-qr-code img,
        .print-qr-code canvas {
            max-width: 100% !important;
            max-height: 100% !important;
        }

        /* ----- Print Title ----- */
        .print-title {
            text-align: center;
            margin: 15px 0;
        }

        .print-title h1 {
            color: #1e40af;
            font-size: 16px;
            font-weight: 700;
            text-transform: uppercase;
            margin-bottom: 5px;
            letter-spacing: 0.5px;
        }

        .print-title .doc-number {
            font-size: 13px;
            color: #475569;
            font-weight: 500;
        }

        /* ----- Print Section ----- */
        .print-section {
            margin-bottom: 12px;
        }

        .print-section-title {
            font-size: 11px;
            font-weight: 700;
            color: #1e40af;
            text-transform: uppercase;
            padding-bottom: 5px;
            border-bottom: 1px solid #e2e8f0;
            margin-bottom: 8px;
            letter-spacing: 0.3px;
        }

        /* ----- Print Row ----- */
        .print-row {
            display: flex;
            padding: 4px 0;
            border-bottom: 1px dotted #e5e7eb;
        }

        .print-row:last-child {
            border-bottom: none;
        }

        .print-label {
            width: 110px;
            font-weight: 500;
            color: #64748b;
            flex-shrink: 0;
            font-size: 12px;
        }

        .print-value {
            flex: 1;
            color: #1a1a1a;
            font-size: 12px;
        }

        .print-value.highlight {
            font-weight: 700;
            color: #1e40af;
        }

        /* ----- Print Amount Row ----- */
        .print-amount-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px dotted #e5e7eb;
            font-size: 12px;
        }

        .print-amount-row:last-child {
            border-bottom: none;
        }

        .print-amount-label {
            color: #64748b;
        }

        .print-amount-value {
            font-weight: 500;
            min-width: 120px;
            text-align: right;
        }

        .print-amount-value.negative {
            color: #dc2626;
        }

        /* ----- Print Total ----- */
        .print-total {
            background: #eff6ff;
            border: 2px solid #1e40af;
            border-radius: 6px;
            padding: 10px 15px;
            margin: 12px 0;
        }

        .print-total-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .print-total-label {
            font-size: 13px;
            font-weight: 700;
            color: #1e40af;
        }

        .print-total-value {
            font-size: 15px;
            font-weight: 700;
            color: #1e40af;
        }

        .print-total-words {
            font-size: 11px;
            color: #64748b;
            font-style: italic;
            margin-top: 3px;
            text-align: right;
        }

        /* ----- Print Debt Row ----- */
        .print-debt-row {
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 5px;
            padding: 8px 12px;
            margin-top: 8px;
        }

        .print-debt-row.paid {
            background: #f0fdf4;
            border-color: #bbf7d0;
        }

        .print-debt-row .print-total-label,
        .print-debt-row .print-total-value {
            color: #dc2626;
            font-size: 12px;
        }

        .print-debt-row.paid .print-total-label,
        .print-debt-row.paid .print-total-value {
            color: #16a34a;
        }

        /* ----- Print Info Row ----- */
        .print-info-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 10px 0;
            font-size: 12px;
        }

        .print-info-item {
            display: flex;
            gap: 8px;
        }

        .print-checkbox {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
        }

        .print-checkbox-box {
            width: 12px;
            height: 12px;
            border: 1.5px solid #64748b;
            border-radius: 2px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
        }

        .print-checkbox-box.checked {
            background: #1e40af;
            border-color: #1e40af;
            color: white;
        }

        /* ----- Print Bank Info ----- */
        .print-bank-info {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 5px;
            padding: 8px 12px;
            margin: 10px 0;
            font-size: 11px;
        }

        .print-bank-info-title {
            font-weight: 600;
            color: #475569;
            margin-bottom: 4px;
        }

        .print-bank-info-content {
            color: #1a1a1a;
        }

        /* ----- Print Footer (Signatures) ----- */
        .print-footer {
            margin-top: 25px;
            padding-top: 15px;
        }

        .print-signatures {
            display: flex;
            justify-content: space-between;
            text-align: center;
        }

        .print-signature-block {
            width: 45%;
        }

        .print-signature-title {
            font-weight: 600;
            color: #475569;
            font-size: 12px;
            margin-bottom: 40px;
        }

        .print-signature-line {
            border-top: 1px solid #1a1a1a;
            padding-top: 4px;
            font-size: 10px;
            color: #64748b;
        }

        .print-signature-note {
            font-size: 10px;
            color: #94a3b8;
            font-style: italic;
            margin-top: 3px;
        }

        /* ----- Print Notes ----- */
        .print-notes {
            background: #fffbeb;
            border: 1px solid #fde68a;
            border-radius: 5px;
            padding: 8px 12px;
            margin: 10px 0;
            font-size: 11px;
        }

        .print-notes-label {
            font-weight: 600;
            color: #92400e;
        }

        .print-notes-content {
            color: #78350f;
        }

        /* ----- Preview Modal Options ----- */
        .print-options {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px 15px;
            margin-bottom: 15px;
        }

        .print-options-title {
            font-size: 12px;
            font-weight: 600;
            color: #475569;
            margin-bottom: 10px;
        }

        .print-options-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .print-option-item {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .print-option-item input {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .print-option-item:hover {
            color: var(--primary-color);
        }

        /* ----- Modal size cho view phi·∫øu ----- */
        #viewRegistrationModal .modal-content,
        #viewReceiptModal .modal-content {
            max-width: 650px;
        }

        #viewRegistrationModal .modal-body,
        #viewReceiptModal .modal-body {
            padding: 15px 20px;
            max-height: none;
        }

        /* ----- Actual Print Styles - Full A4 ----- */
        @media print {
            .print-document {
                width: 210mm !important;
                max-width: none !important;
                min-height: 297mm;
                padding: 15mm 20mm !important;
                font-size: 14px !important;
                box-shadow: none !important;
                border-radius: 0 !important;
            }

            .print-header {
                padding-bottom: 15px;
                margin-bottom: 20px;
            }

            .print-logo {
                width: 60px;
                height: 60px;
                font-size: 32px;
            }

            .print-company-info h2 {
                font-size: 18px;
            }

            .print-company-info p {
                font-size: 12px;
            }

            .print-qr-code {
                width: 70px;
                height: 70px;
            }

            .print-title h1 {
                font-size: 22px;
            }

            .print-title .doc-number {
                font-size: 15px;
            }

            .print-section-title {
                font-size: 13px;
            }

            .print-label {
                width: 140px;
                font-size: 14px;
            }

            .print-value,
            .print-amount-row {
                font-size: 14px;
            }

            .print-total {
                padding: 15px 20px;
            }

            .print-total-label {
                font-size: 15px;
            }

            .print-total-value {
                font-size: 18px;
            }

            .print-total-words {
                font-size: 13px;
            }

            .print-signature-title {
                font-size: 14px;
                margin-bottom: 60px;
            }

            .print-signature-line {
                font-size: 12px;
            }

            .print-options {
                display: none !important;
            }
        }

        /* ----- Attendance Edit Mode ----- */
        .edit-attendance-status {
            padding: 5px 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 13px;
            width: 100%;
            cursor: pointer;
        }

        .edit-attendance-status:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        .attendance-status-edit,
        .attendance-note-edit {
            transition: all 0.2s;
        }

        #attendanceDetailTable tbody tr:hover {
            background: var(--bg-light);
        }
    </style>
</head>

<body>
    <!-- ============================================================
         üîê M√ÄN H√åNH ƒêƒÇNG NH·∫¨P
         ============================================================ -->
    <div class="login-screen" id="loginScreen">
        <div class="login-container">
            <div class="login-logo">
                <div class="logo-icon">üìö</div>
                <h1>H·ªÜ TH·ªêNG QU·∫¢N L√ù</h1>
                <p>Trung T√¢m D·∫°y H·ªçc</p>
            </div>

            <div class="login-error" id="loginError">
                <span>‚ö†Ô∏è</span>
                <span id="loginErrorText">Sai t√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u</span>
            </div>

            <form class="login-form" id="loginForm" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label>T√™n ƒëƒÉng nh·∫≠p</label>
                    <div class="input-wrapper">
                        <span class="input-icon">üë§</span>
                        <input type="text" id="loginUsername" placeholder="Nh·∫≠p t√™n ƒëƒÉng nh·∫≠p" required
                            autocomplete="username">
                    </div>
                </div>

                <div class="form-group">
                    <label>M·∫≠t kh·∫©u</label>
                    <div class="input-wrapper">
                        <span class="input-icon">üîí</span>
                        <input type="password" id="loginPassword" placeholder="Nh·∫≠p m·∫≠t kh·∫©u" required
                            autocomplete="current-password">
                        <button type="button" class="password-toggle" onclick="togglePasswordVisibility()">üëÅÔ∏è</button>
                    </div>
                </div>

                <div class="form-options">
                    <label class="remember-me">
                        <input type="checkbox" id="rememberMe">
                        <span>Ghi nh·ªõ ƒëƒÉng nh·∫≠p</span>
                    </label>
                </div>

                <button type="submit" class="btn-login" id="btnLogin">
                    <span>ƒêƒÉng nh·∫≠p</span>
                </button>
            </form>

            <div class="login-footer">
                <p>Version 4.0 - VSHüì®2026</p>
            </div>
        </div>
    </div>

    <!-- ============================================================
         üìê ·ª®NG D·ª§NG CH√çNH
         ============================================================ -->
    <div class="app-container" id="appContainer">

        <!-- ==================== SIDEBAR ==================== -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-logo">
                <div class="logo-icon">üìö</div>
                <span class="logo-text">Qu·∫£n L√Ω Trung T√¢m</span>
            </div>

            <nav class="sidebar-nav" id="sidebarNav">
                <!-- Menu s·∫Ω ƒë∆∞·ª£c render b·∫±ng JS d·ª±a tr√™n quy·ªÅn -->
            </nav>

            <div class="sidebar-footer">
                <p class="version">VSHüì®2026</p>
            </div>
        </aside>

        <!-- ==================== MAIN WRAPPER ==================== -->
        <div class="main-wrapper">

            <!-- Header -->
            <header class="main-header">
                <div class="header-left">
                    <button class="toggle-sidebar-btn" onclick="toggleSidebar()" title="·∫®n/Hi·ªán menu">‚ò∞</button>
                    <h1 class="page-title" id="pageTitle">üìä T·ªïng quan</h1>
                </div>
                <div class="header-right">
                    <button class="header-btn" onclick="createManualBackup()" title="Backup">üíæ</button>
                    <button class="header-btn" title="Th√¥ng b√°o">üîî</button>

                    <!-- User Dropdown -->
                    <div class="user-dropdown">
                        <div class="user-info" onclick="toggleUserMenu()">
                            <div class="user-avatar" id="userAvatar">A</div>
                            <span class="user-name" id="userName">Admin</span>
                            <span class="user-role" id="userRoleBadge">Admin</span>
                        </div>
                        <div class="user-menu" id="userMenu">
                            <div class="user-menu-header">
                                <div class="name" id="userMenuName">Admin</div>
                                <div class="email" id="userMenuRole">Qu·∫£n tr·ªã vi√™n</div>
                            </div>
                            <div class="user-menu-item" onclick="openChangePasswordModal()">
                                <span>üîë</span>
                                <span>ƒê·ªïi m·∫≠t kh·∫©u</span>
                            </div>
                            <div class="user-menu-item" onclick="openProfileModal()">
                                <span>üë§</span>
                                <span>Th√¥ng tin c√° nh√¢n</span>
                            </div>
                            <div class="user-menu-divider"></div>
                            <div class="user-menu-item danger" onclick="handleLogout()">
                                <span>üö™</span>
                                <span>ƒêƒÉng xu·∫•t</span>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Main Content -->
            <main class="main-content">

                <!-- ==================== TAB: T·ªîNG QUAN ==================== -->
                <div id="dashboard" class="tab-content active">
                    <div class="page-header">
                        <h2>üìä T·ªïng quan h·ªá th·ªëng</h2>
                    </div>
                    <div class="stats-grid" id="dashboardStats"></div>
                    <div class="d-flex gap-20 flex-wrap">
                        <div class="flex-1" style="min-width: 300px;">
                            <div class="chart-container">
                                <h3 class="mb-15">üìà Doanh thu 6 th√°ng g·∫ßn nh·∫•t</h3>
                                <div class="chart-bars" id="revenueChart"></div>
                            </div>
                        </div>
                        <div style="min-width: 300px; max-width: 400px;">
                            <div class="card">
                                <div class="card-header">
                                    <h3>üìÖ L·ªãch h·∫πn s·∫Øp t·ªõi</h3>
                                </div>
                                <div class="card-body" id="upcomingAppointments"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ==================== TAB: DANH S√ÅCH H·ªåC VI√äN ==================== -->
                <div id="students" class="tab-content">
                    <div class="page-header">
                        <h2>üë©‚Äçüéì Danh s√°ch H·ªçc vi√™n</h2>
                        <div class="page-actions" id="studentsActions">
                            <button class="btn btn-info" onclick="exportStudentsToExcel()">üì§ Export Excel</button>
                            <button class="btn btn-success" onclick="toggleStudentForm()">‚ûï Th√™m h·ªçc vi√™n</button>
                        </div>
                    </div>

                    <div class="form-section" id="studentFormSection">
                        <div class="form-section-header">
                            <h3 id="studentFormTitle">‚ûï Th√™m H·ªçc Vi√™n M·ªõi</h3>
                            <button class="btn btn-sm btn-secondary" onclick="toggleStudentForm()">‚úï ƒê√≥ng</button>
                        </div>
                        <form id="studentForm" onsubmit="saveStudent(event)">
                            <input type="hidden" id="editStudentId" value="">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>T√™n H·ªçc Vi√™n *</label>
                                    <input type="text" id="studentName" required placeholder="Nh·∫≠p t√™n h·ªçc vi√™n">
                                </div>
                                <div class="form-group">
                                    <label>Tu·ªïi *</label>
                                    <input type="number" id="studentAge" required min="3" max="100"
                                        placeholder="Nh·∫≠p tu·ªïi">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>T√™n Ph·ª• Huynh *</label>
                                    <input type="text" id="parentName" required placeholder="Nh·∫≠p t√™n ph·ª• huynh">
                                </div>
                                <div class="form-group">
                                    <label>S·ªë ƒêi·ªán Tho·∫°i *</label>
                                    <input type="tel" id="parentPhone" required placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Email Ph·ª• Huynh</label>
                                    <input type="email" id="parentEmail" placeholder="Nh·∫≠p email (t√πy ch·ªçn)">
                                </div>
                                <div class="form-group">
                                    <label>Tr·∫°ng Th√°i *</label>
                                    <select id="studentStatus" required>
                                        <option value="H·ªçc Th·ª≠">üÜï H·ªçc Th·ª≠</option>
                                        <option value="Ch·ªù ƒêƒÉng K√Ω">‚è≥ Ch·ªù ƒêƒÉng K√Ω</option>
                                        <option value="ƒê√£ ƒêƒÉng K√Ω">‚úÖ ƒê√£ ƒêƒÉng K√Ω</option>
                                        <option value="Ho√†n Th√†nh">üéì Ho√†n Th√†nh</option>
                                        <option value="Cancel">‚ùå Cancel</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>M√¥n H·ªçc Quan T√¢m *</label>
                                <div class="checkbox-group" id="subjectCheckboxes"></div>
                            </div>
                            <div class="form-group">
                                <label>Ghi Ch√∫</label>
                                <textarea id="studentNotes" rows="2" placeholder="Nh·∫≠p ghi ch√∫ (t√πy ch·ªçn)"></textarea>
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary" id="saveStudentBtn">üíæ L∆∞u H·ªçc
                                    Vi√™n</button>
                                <button type="button" class="btn btn-secondary" onclick="toggleStudentForm()">‚ùå
                                    H·ªßy</button>
                            </div>
                        </form>
                    </div>

                    <div class="filter-bar">
                        <button class="filter-btn active" onclick="filterStudents('all')" data-filter="all">üìã T·∫•t c·∫£
                            <span class="count" id="countAll">0</span></button>
                        <button class="filter-btn" onclick="filterStudents('H·ªçc Th·ª≠')" data-filter="H·ªçc Th·ª≠">üÜï H·ªçc Th·ª≠
                            <span class="count" id="countHocThu">0</span></button>
                        <button class="filter-btn" onclick="filterStudents('Ch·ªù ƒêƒÉng K√Ω')" data-filter="Ch·ªù ƒêƒÉng K√Ω">‚è≥
                            Ch·ªù ƒêK <span class="count" id="countChoDangKy">0</span></button>
                        <button class="filter-btn" onclick="filterStudents('ƒê√£ ƒêƒÉng K√Ω')" data-filter="ƒê√£ ƒêƒÉng K√Ω">‚úÖ ƒê√£
                            ƒêK <span class="count" id="countDaDangKy">0</span></button>
                        <button class="filter-btn" onclick="filterStudents('Ho√†n Th√†nh')" data-filter="Ho√†n Th√†nh">üéì
                            Ho√†n Th√†nh <span class="count" id="countHoanThanh">0</span></button>
                        <button class="filter-btn" onclick="filterStudents('Cancel')" data-filter="Cancel">‚ùå Cancel
                            <span class="count" id="countCancel">0</span></button>
                        <div class="search-box">
                            <input type="text" id="searchStudent" placeholder="T√¨m ki·∫øm h·ªçc vi√™n..."
                                oninput="searchStudents()">
                        </div>
                    </div>

                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>T√™n HV</th>
                                    <th>Tu·ªïi</th>
                                    <th>Ph·ª• Huynh</th>
                                    <th>SƒêT</th>
                                    <th>M√¥n H·ªçc</th>
                                    <th>Tr·∫°ng Th√°i</th>
                                    <th>Thao T√°c</th>
                                </tr>
                            </thead>
                            <tbody id="studentsTableBody"></tbody>
                        </table>
                    </div>
                    <div class="pagination-container" id="studentsPagination"></div>
                </div>

                <!-- ==================== TAB: H·ªåC TH·ª¨ ==================== -->
                <div id="trial" class="tab-content">
                    <div class="page-header">
                        <h2>üéì Danh s√°ch H·ªçc th·ª≠ & Ch·ªù ƒëƒÉng k√Ω</h2>
                        <div class="page-actions"><button class="btn btn-info" onclick="exportTrialStudentsToExcel()">üì§
                                Export Excel</button></div>
                    </div>
                    <div class="filter-bar">
                        <button class="filter-btn active" onclick="filterTrialStudents('all')" data-filter="all">üìã T·∫•t
                            c·∫£ <span class="count" id="trialCountAll">0</span></button>
                        <button class="filter-btn" onclick="filterTrialStudents('H·ªçc Th·ª≠')" data-filter="H·ªçc Th·ª≠">üÜï H·ªçc
                            Th·ª≠ <span class="count" id="trialCountHocThu">0</span></button>
                        <button class="filter-btn" onclick="filterTrialStudents('Ch·ªù ƒêƒÉng K√Ω')"
                            data-filter="Ch·ªù ƒêƒÉng K√Ω">‚è≥ Ch·ªù ƒêK <span class="count"
                                id="trialCountChoDangKy">0</span></button>
                        <div class="search-box"><input type="text" id="searchTrialStudent" placeholder="T√¨m ki·∫øm..."
                                oninput="searchTrialStudents()"></div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>T√™n HV</th>
                                    <th>Tu·ªïi</th>
                                    <th>Ph·ª• Huynh</th>
                                    <th>SƒêT</th>
                                    <th>M√¥n H·ªçc</th>
                                    <th>Tr·∫°ng Th√°i</th>
                                    <th>L·ªãch H·∫πn</th>
                                    <th>Thao T√°c</th>
                                </tr>
                            </thead>
                            <tbody id="trialStudentsTableBody"></tbody>
                        </table>
                    </div>
                    <div class="pagination-container" id="trialPagination"></div>
                </div>

                <!-- ==================== TAB: L·ªäCH H·∫∏N ==================== -->
                <div id="appointments" class="tab-content">
                    <div class="page-header">
                        <h2>üìÖ Qu·∫£n l√Ω L·ªãch h·∫πn</h2>
                        <div class="page-actions" id="appointmentsActions">
                            <button class="btn btn-info" onclick="exportAppointmentsToExcel()">üì§ Export Excel</button>
                            <button class="btn btn-success" onclick="openNewAppointmentModal()">‚ûï Th√™m l·ªãch h·∫πn</button>
                        </div>
                    </div>
                    <div class="filter-bar">
                        <button class="filter-btn active" onclick="filterAppointments('all')">üìã T·∫•t c·∫£</button>
                        <button class="filter-btn" onclick="filterAppointments('upcoming')">‚è∞ S·∫Øp t·ªõi</button>
                        <button class="filter-btn" onclick="filterAppointments('past')">‚úÖ ƒê√£ qua</button>
                        <div class="search-box"><input type="text" id="searchAppointment"
                                placeholder="T√¨m ki·∫øm l·ªãch h·∫πn..." oninput="searchAppointments()"></div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>H·ªçc Vi√™n</th>
                                    <th>Ph·ª• Huynh</th>
                                    <th>SƒêT</th>
                                    <th>M√¥n H·ªçc</th>
                                    <th>Ng√†y</th>
                                    <th>Gi·ªù</th>
                                    <th>Tr·∫°ng Th√°i</th>
                                    <th>Thao T√°c</th>
                                </tr>
                            </thead>
                            <tbody id="appointmentsTableBody"></tbody>
                        </table>
                    </div>
                    <div class="pagination-container" id="appointmentsPagination"></div>
                </div>

                <!-- ==================== TAB: PHI·∫æU ƒêƒÇNG K√ù ==================== -->
                <div id="registrations" class="tab-content">
                    <div class="page-header">
                        <h2>üìã Qu·∫£n l√Ω Phi·∫øu ƒëƒÉng k√Ω</h2>
                        <div class="page-actions" id="registrationsActions">
                            <button class="btn btn-info" onclick="exportRegistrationsToExcel()">üì§ Export Excel</button>
                            <button class="btn btn-success" onclick="openNewRegistrationModal()">‚ûï T·∫°o phi·∫øu ƒêK</button>
                        </div>
                    </div>
                    <div class="filter-bar">
                        <div class="search-box"><input type="text" id="searchRegistration"
                                placeholder="T√¨m ki·∫øm phi·∫øu ƒëƒÉng k√Ω..." oninput="searchRegistrations()"></div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>M√£ Phi·∫øu</th>
                                    <th>H·ªçc Vi√™n</th>
                                    <th>M√¥n H·ªçc / G√≥i</th>
                                    <th>Gi·∫£m Gi√°</th>
                                    <th>Th√†nh Ti·ªÅn</th>
                                    <th>Ng√†y ƒêK</th>
                                    <th>Thao T√°c</th>
                                </tr>
                            </thead>
                            <tbody id="registrationsTableBody"></tbody>
                        </table>
                    </div>
                    <div class="pagination-container" id="registrationsPagination"></div>
                </div>

                <!-- ==================== TAB: BI√äN LAI ==================== -->
                <div id="receipts" class="tab-content">
                    <div class="page-header">
                        <h2>üßæ Qu·∫£n l√Ω Bi√™n lai</h2>
                        <div class="page-actions" id="receiptsActions">
                            <button class="btn btn-info" onclick="exportReceiptsToExcel()">üì§ Export Excel</button>
                            <button class="btn btn-success" onclick="openReceiptModal()">‚ûï T·∫°o bi√™n lai</button>
                        </div>
                    </div>
                    <!-- T·ªïng h·ª£p bi√™n lai -->
                    <div class="stats-grid mb-20" id="receiptSummaryStats">
                        <div class="stat-card">
                            <div class="stat-icon green">üí∞</div>
                            <div class="stat-info">
                                <h3 id="receiptTotalIncome">0</h3>
                                <p>T·ªïng thu</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon red">üí∏</div>
                            <div class="stat-info">
                                <h3 id="receiptTotalExpense">0</h3>
                                <p>T·ªïng chi (ho√†n ti·ªÅn)</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon blue">üìä</div>
                            <div class="stat-info">
                                <h3 id="receiptBalance">0</h3>
                                <p>S·ªë d∆∞</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon teal">üßæ</div>
                            <div class="stat-info">
                                <h3 id="receiptTotalCount">0</h3>
                                <p>T·ªïng bi√™n lai</p>
                            </div>
                        </div>
                    </div>

                    <!-- B·ªô l·ªçc th·ªùi gian -->
                    <div class="card mb-20">
                        <div class="card-body" style="padding: 15px;">
                            <div class="d-flex gap-15 flex-wrap align-center">
                                <div class="form-group" style="margin-bottom: 0; min-width: 150px;">
                                    <label style="font-size: 12px; margin-bottom: 4px;">Kho·∫£ng th·ªùi gian</label>
                                    <select id="receiptPeriodFilter" onchange="onReceiptPeriodChange()">
                                        <option value="all">T·∫•t c·∫£</option>
                                        <option value="thisMonth" selected>Th√°ng n√†y</option>
                                        <option value="lastMonth">Th√°ng tr∆∞·ªõc</option>
                                        <option value="thisQuarter">Qu√Ω n√†y</option>
                                        <option value="thisYear">NƒÉm nay</option>
                                        <option value="custom">T√πy ch·ªçn</option>
                                    </select>
                                </div>
                                <div class="form-group" style="margin-bottom: 0;" id="receiptFromDateGroup">
                                    <label style="font-size: 12px; margin-bottom: 4px;">T·ª´ ng√†y</label>
                                    <input type="date" id="receiptFilterFromDate" onchange="filterReceiptsByDate()">
                                </div>
                                <div class="form-group" style="margin-bottom: 0;" id="receiptToDateGroup">
                                    <label style="font-size: 12px; margin-bottom: 4px;">ƒê·∫øn ng√†y</label>
                                    <input type="date" id="receiptFilterToDate" onchange="filterReceiptsByDate()">
                                </div>
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label style="font-size: 12px; margin-bottom: 4px;">Lo·∫°i</label>
                                    <select id="receiptTypeFilter" onchange="filterReceiptsByDate()">
                                        <option value="all">T·∫•t c·∫£ lo·∫°i</option>
                                        <option value="thu">Ch·ªâ Thu</option>
                                        <option value="chi">Ch·ªâ Chi (Ho√†n ti·ªÅn)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="filter-bar">
                        <div class="search-box"><input type="text" id="searchReceipt" placeholder="T√¨m ki·∫øm bi√™n lai..."
                                oninput="searchReceipts()"></div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>M√£ BL</th>
                                    <th>Lo·∫°i</th>
                                    <th>H·ªçc Vi√™n</th>
                                    <th>N·ªôi Dung</th>
                                    <th>S·ªë Ti·ªÅn</th>
                                    <th>Ng√†y</th>
                                    <th>Thao T√°c</th>
                                </tr>
                            </thead>
                            <tbody id="receiptsTableBody"></tbody>
                        </table>
                    </div>
                    <div class="pagination-container" id="receiptsPagination"></div>
                </div>


                <!-- ==================== TAB: C√îNG N·ª¢ ==================== -->
                <div id="debts" class="tab-content">
                    <div class="page-header">
                        <h2>üí≥ Qu·∫£n l√Ω C√¥ng n·ª£</h2>
                        <div class="page-actions">
                            <button class="btn btn-info" onclick="exportDebtsToExcel()">üì§ Export Excel</button>
                        </div>
                    </div>

                    <!-- Th·ªëng k√™ c√¥ng n·ª£ -->
                    <div class="stats-grid mb-20">
                        <div class="stat-card">
                            <div class="stat-icon green">üí∞</div>
                            <div class="stat-info">
                                <h3 id="debtTotalAmount">0</h3>
                                <p>T·ªïng ph·∫£i thu</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon blue">‚úÖ</div>
                            <div class="stat-info">
                                <h3 id="debtPaidAmount">0</h3>
                                <p>ƒê√£ thu</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon red">‚ö†Ô∏è</div>
                            <div class="stat-info">
                                <h3 id="debtRemainingAmount">0</h3>
                                <p>C√≤n n·ª£</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon orange">üìã</div>
                            <div class="stat-info">
                                <h3 id="debtStudentCount">0</h3>
                                <p>HV c√≤n n·ª£</p>
                            </div>
                        </div>
                    </div>

                    <!-- C·∫£nh b√°o -->
                    <div class="card mb-20" id="debtWarningsCard">
                        <div class="card-header">
                            <h3>‚ö†Ô∏è C·∫£nh b√°o c·∫ßn x·ª≠ l√Ω</h3>
                            <button class="btn btn-sm btn-outline" onclick="refreshDebtWarnings()">üîÑ L√†m m·ªõi</button>
                        </div>
                        <div class="card-body" id="debtWarningsList">
                            <p class="text-muted">ƒêang t·∫£i...</p>
                        </div>
                    </div>

                    <!-- B·ªô l·ªçc -->
                    <div class="filter-bar">
                        <button class="filter-btn active" onclick="filterDebts('all')" data-filter="all">üìã T·∫•t
                            c·∫£</button>
                        <button class="filter-btn" onclick="filterDebts('unpaid')" data-filter="unpaid">üî¥ Ch∆∞a
                            ƒë√≥ng</button>
                        <button class="filter-btn" onclick="filterDebts('partial')" data-filter="partial">üü° ƒê√≥ng 1
                            ph·∫ßn</button>
                        <button class="filter-btn" onclick="filterDebts('paid')" data-filter="paid">üü¢ ƒê√£ ƒë√≥ng
                            ƒë·ªß</button>
                        <button class="filter-btn" onclick="filterDebts('warning')" data-filter="warning">‚ö†Ô∏è C·∫ßn nh·∫Øc
                            nh·ªü</button>
                        <div class="search-box">
                            <input type="text" id="searchDebt" placeholder="T√¨m ki·∫øm..." oninput="searchDebts()">
                        </div>
                    </div>

                    <!-- B·∫£ng c√¥ng n·ª£ -->
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>H·ªçc vi√™n</th>
                                    <th>M√£ Phi·∫øu ƒêK</th>
                                    <th>M√¥n h·ªçc</th>
                                    <th>T·ªïng ti·ªÅn</th>
                                    <th>ƒê√£ ƒë√≥ng</th>
                                    <th>C√≤n n·ª£</th>
                                    <th>C√≤n bu·ªïi</th>
                                    <th>Tr·∫°ng th√°i</th>
                                    <th>Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody id="debtsTableBody"></tbody>
                        </table>
                    </div>
                    <div class="pagination-container" id="debtsPagination"></div>
                </div>



                <!-- ==================== TAB: GI√ÅO VI√äN ==================== -->
                <div id="teachers" class="tab-content">
                    <div class="page-header">
                        <h2>üë®‚Äçüè´ Qu·∫£n l√Ω Gi√°o vi√™n</h2>
                        <div class="page-actions" id="teachersActions">
                            <button class="btn btn-success" onclick="openTeacherModal()">‚ûï Th√™m gi√°o vi√™n</button>
                        </div>
                    </div>

                    <div class="filter-bar">
                        <div class="search-box">
                            <input type="text" id="searchTeacher" placeholder="T√¨m ki·∫øm gi√°o vi√™n..."
                                oninput="searchTeachers()">
                        </div>
                    </div>

                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>H·ªç t√™n</th>
                                    <th>S·ªë ƒëi·ªán tho·∫°i</th>
                                    <th>M√¥n d·∫°y</th>
                                    <th>Lo·∫°i l∆∞∆°ng</th>
                                    <th>Tr·∫°ng th√°i</th>
                                    <th>Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody id="teachersTableBody"></tbody>
                        </table>
                    </div>
                    <div class="pagination-container" id="teachersPagination"></div>
                </div>

                <!-- ==================== TAB: L·ªöP H·ªåC ==================== -->
                <div id="classes" class="tab-content">
                    <div class="page-header">
                        <h2>üìö Qu·∫£n l√Ω L·ªõp h·ªçc</h2>
                        <div class="page-actions" id="classesActions">
                            <button class="btn btn-success" onclick="openClassModal()">‚ûï Th√™m l·ªõp m·ªõi</button>
                        </div>
                    </div>

                    <div class="filter-bar">
                        <select id="filterClassSubject" onchange="filterClasses()">
                            <option value="">üìñ T·∫•t c·∫£ m√¥n h·ªçc</option>
                        </select>
                        <select id="filterClassTeacher" onchange="filterClasses()">
                            <option value="">üë®‚Äçüè´ T·∫•t c·∫£ gi√°o vi√™n</option>
                        </select>
                        <select id="filterClassStatus" onchange="filterClasses()">
                            <option value="">üìä T·∫•t c·∫£ tr·∫°ng th√°i</option>
                            <option value="new">üÜï L·ªõp m·ªõi</option>
                            <option value="active">üü¢ ƒêang h·ªçc</option>
                            <option value="completed">‚úÖ Ho√†n th√†nh</option>
                            <option value="cancelled">‚ùå ƒê√£ h·ªßy</option>
                        </select>
                        <div class="search-box">
                            <input type="text" id="searchClass" placeholder="T√¨m ki·∫øm l·ªõp h·ªçc..."
                                oninput="searchClasses()">
                        </div>
                    </div>

                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>T√™n l·ªõp</th>
                                    <th>M√¥n h·ªçc</th>
                                    <th>Gi√°o vi√™n</th>
                                    <th>Lo·∫°i</th>
                                    <th>Sƒ© s·ªë</th>
                                    <th>L·ªãch h·ªçc</th>
                                    <th>Tr·∫°ng th√°i</th>
                                    <th>Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody id="classesTableBody"></tbody>
                        </table>
                    </div>
                    <div class="pagination-container" id="classesPagination"></div>
                </div>


                <!-- ==================== TAB: ƒêI·ªÇM DANH ==================== -->
                <div id="attendance" class="tab-content">
                    <div class="page-header">
                        <h2>‚úÖ ƒêi·ªÉm danh</h2>
                        <div class="page-actions">
                            <button class="btn btn-info" onclick="exportAttendanceToExcel()">üì§ Export Excel</button>
                        </div>
                    </div>

                    <!-- B·ªô ch·ªçn ƒëi·ªÉm danh -->
                    <div class="card mb-20">
                        <div class="card-body">
                            <div class="d-flex gap-15 flex-wrap align-center">
                                <div class="form-group" style="margin-bottom: 0; min-width: 200px;">
                                    <label style="font-size: 12px; margin-bottom: 4px;">Ch·ªçn l·ªõp *</label>
                                    <select id="attendanceClassSelect" onchange="onAttendanceClassChange()">
                                        <option value="">-- Ch·ªçn l·ªõp h·ªçc --</option>
                                    </select>
                                </div>
                                <div class="form-group" style="margin-bottom: 0; min-width: 150px;">
                                    <label style="font-size: 12px; margin-bottom: 4px;">Ng√†y ƒëi·ªÉm danh *</label>
                                    <input type="date" id="attendanceDate" onchange="onAttendanceDateChange()">
                                </div>
                                <div class="form-group" style="margin-bottom: 0; min-width: 180px;">
                                    <label style="font-size: 12px; margin-bottom: 4px;">Ca h·ªçc *</label>
                                    <select id="attendanceScheduleSelect" onchange="loadAttendanceList()">
                                        <option value="">-- Ch·ªçn ca h·ªçc --</option>
                                    </select>
                                </div>
                                <div style="padding-top: 18px;">
                                    <button class="btn btn-primary" onclick="loadAttendanceList()">üîÑ T·∫£i danh
                                        s√°ch</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- L·ªãch h·ªçc h√¥m nay -->
                    <div class="card mb-20" id="todaySchedulesCard">
                        <div class="card-header">
                            <h3>üìÖ L·ªãch h·ªçc h√¥m nay</h3>
                            <button class="btn btn-sm btn-outline" onclick="refreshTodaySchedules()">üîÑ L√†m m·ªõi</button>
                        </div>
                        <div class="card-body" id="todaySchedulesList">
                            <p class="text-muted">ƒêang t·∫£i...</p>
                        </div>
                    </div>

                    <!-- B·∫£ng ƒëi·ªÉm danh -->
                    <div class="card" id="attendanceTableCard" style="display: none;">
                        <div class="card-header">
                            <h3 id="attendanceTableTitle">üìã ƒêi·ªÉm danh</h3>
                            <div class="d-flex gap-10">
                                <button class="btn btn-sm btn-success" onclick="markAllPresent()">‚úÖ T·∫•t c·∫£ C√≥
                                    m·∫∑t</button>
                                <button class="btn btn-sm btn-primary" onclick="saveAttendance()">üíæ L∆∞u ƒëi·ªÉm
                                    danh</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-container" style="box-shadow: none; border: none;">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>H·ªçc vi√™n</th>
                                            <th>T·ªïng bu·ªïi</th>
                                            <th>ƒê√£ h·ªçc</th>
                                            <th>C√≤n l·∫°i</th>
                                            <th style="min-width: 280px;">Tr·∫°ng th√°i ƒëi·ªÉm danh</th>
                                            <th>Ghi ch√∫</th>
                                        </tr>
                                    </thead>
                                    <tbody id="attendanceTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- L·ªãch s·ª≠ ƒëi·ªÉm danh -->
                    <div class="card mt-20">
                        <div class="card-header">
                            <h3>üìú L·ªãch s·ª≠ ƒëi·ªÉm danh g·∫ßn ƒë√¢y</h3>
                        </div>
                        <div class="card-body">
                            <div class="table-container" style="box-shadow: none; border: none;">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Ng√†y</th>
                                            <th>L·ªõp</th>
                                            <th>Ca h·ªçc</th>
                                            <th>Sƒ© s·ªë</th>
                                            <th>C√≥ m·∫∑t</th>
                                            <th>V·∫Øng</th>
                                            <th>Thao t√°c</th>
                                        </tr>
                                    </thead>
                                    <tbody id="attendanceHistoryBody"></tbody>
                                </table>
                            </div>
                            <div class="pagination-container" id="attendanceHistoryPagination"></div>
                        </div>
                    </div>
                    <!-- Th·ªëng k√™ ƒëi·ªÉm danh theo h·ªçc vi√™n -->
                    <div class="card mt-20">
                        <div class="card-header">
                            <h3>üìä Th·ªëng k√™ theo H·ªçc vi√™n</h3>
                            <div class="d-flex gap-10">
                                <select id="attendanceStatClassFilter" onchange="loadAttendanceStatsByStudent()"
                                    style="padding: 6px 12px; border: 1px solid var(--border-color); border-radius: 6px;">
                                    <option value="">T·∫•t c·∫£ l·ªõp</option>
                                </select>
                                <select id="attendanceStatPeriodFilter" onchange="onAttendanceStatPeriodChange()"
                                    style="padding: 6px 12px; border: 1px solid var(--border-color); border-radius: 6px;">
                                    <option value="thisMonth">Th√°ng n√†y</option>
                                    <option value="lastMonth">Th√°ng tr∆∞·ªõc</option>
                                    <option value="thisQuarter">Qu√Ω n√†y</option>
                                    <option value="all">T·∫•t c·∫£</option>
                                </select>
                                <button class="btn btn-sm btn-info" onclick="exportAttendanceStatsByStudent()">üì§
                                    Export</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-container" style="box-shadow: none; border: none;">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>H·ªçc vi√™n</th>
                                            <th>L·ªõp</th>
                                            <th>T·ªïng bu·ªïi ƒêD</th>
                                            <th>‚úÖ C√≥ m·∫∑t</th>
                                            <th>üü° Mu·ªôn</th>
                                            <th>‚ùå V·∫Øng KP</th>
                                            <th>üìù C√≥ ph√©p</th>
                                            <th>T·ª∑ l·ªá CM</th>
                                            <th>Chi ti·∫øt</th>
                                        </tr>
                                    </thead>
                                    <tbody id="attendanceStatsByStudentBody">
                                        <tr>
                                            <td colspan="9" class="text-center text-muted">ƒêang t·∫£i...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="pagination-container" id="attendanceStatsPagination"></div>
                        </div>
                    </div>

                </div>

                <!-- ==================== TAB: H·ªåC B√ô ==================== -->
                <div id="makeup" class="tab-content">
                    <div class="page-header">
                        <h2>üìù Qu·∫£n l√Ω H·ªçc b√π</h2>
                        <div class="page-actions">
                            <button class="btn btn-success" onclick="openCreateMakeupModal()">‚ûï T·∫°o y√™u c·∫ßu h·ªçc
                                b√π</button>
                        </div>
                    </div>

                    <!-- Th·ªëng k√™ -->
                    <div class="stats-grid mb-20">
                        <div class="stat-card">
                            <div class="stat-icon orange">‚è≥</div>
                            <div class="stat-info">
                                <h3 id="makeupPendingCount">0</h3>
                                <p>Ch·ªù x·∫øp l·ªãch</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon blue">üìÖ</div>
                            <div class="stat-info">
                                <h3 id="makeupApprovedCount">0</h3>
                                <p>ƒê√£ x·∫øp l·ªãch</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon red">‚ö†Ô∏è</div>
                            <div class="stat-info">
                                <h3 id="makeupExpiringCount">0</h3>
                                <p>S·∫Øp h·∫øt h·∫°n (‚â§7 ng√†y)</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon green">‚úÖ</div>
                            <div class="stat-info">
                                <h3 id="makeupCompletedCount">0</h3>
                                <p>ƒê√£ ho√†n th√†nh</p>
                            </div>
                        </div>
                    </div>

                    <!-- B·ªô l·ªçc -->
                    <div class="filter-bar">
                        <button class="filter-btn active" onclick="filterMakeupRequests('all')" data-filter="all">üìã T·∫•t
                            c·∫£</button>
                        <button class="filter-btn" onclick="filterMakeupRequests('pending')" data-filter="pending">‚è≥ Ch·ªù
                            x·∫øp l·ªãch</button>
                        <button class="filter-btn" onclick="filterMakeupRequests('approved')" data-filter="approved">üìÖ
                            ƒê√£ x·∫øp l·ªãch</button>
                        <button class="filter-btn" onclick="filterMakeupRequests('expiring')" data-filter="expiring">‚ö†Ô∏è
                            S·∫Øp h·∫øt h·∫°n</button>
                        <button class="filter-btn" onclick="filterMakeupRequests('completed')" data-filter="completed">‚úÖ
                            Ho√†n th√†nh</button>
                        <button class="filter-btn" onclick="filterMakeupRequests('expired')" data-filter="expired">‚ùå ƒê√£
                            h·∫øt h·∫°n</button>
                    </div>

                    <!-- B·∫£ng y√™u c·∫ßu h·ªçc b√π -->
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>H·ªçc vi√™n</th>
                                    <th>L·ªõp g·ªëc</th>
                                    <th>Ng√†y ngh·ªâ</th>
                                    <th>H·∫°n h·ªçc b√π</th>
                                    <th>L·ªõp h·ªçc b√π</th>
                                    <th>Ng√†y h·ªçc b√π</th>
                                    <th>Tr·∫°ng th√°i</th>
                                    <th>Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody id="makeupRequestsBody"></tbody>
                        </table>
                    </div>
                    <div class="pagination-container" id="makeupPagination"></div>
                </div>


                <!-- ==================== TAB: M√îN H·ªåC ==================== -->
                <div id="subjects" class="tab-content">
                    <div class="page-header">
                        <h2>üìñ Danh m·ª•c M√¥n h·ªçc</h2>
                        <div class="page-actions" id="subjectsActions"><button class="btn btn-success"
                                onclick="openSubjectModal()">‚ûï Th√™m m√¥n h·ªçc</button></div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Icon</th>
                                    <th>T√™n M√¥n</th>
                                    <th>H·ªçc Ph√≠ M·∫∑c ƒê·ªãnh</th>
                                    <th>Thao T√°c</th>
                                </tr>
                            </thead>
                            <tbody id="subjectsTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- ==================== TAB: G√ìI H·ªåC PH√ç ==================== -->
                <div id="packages" class="tab-content">
                    <div class="page-header">
                        <h2>üì¶ Danh m·ª•c G√≥i h·ªçc ph√≠</h2>
                        <div class="page-actions" id="packagesActions"><button class="btn btn-success"
                                onclick="openPackageModal()">‚ûï Th√™m g√≥i</button></div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>T√™n G√≥i</th>
                                    <th>M√¥n H·ªçc</th>
                                    <th>S·ªë Bu·ªïi</th>
                                    <th>H·ªçc Ph√≠</th>
                                    <th>Thao T√°c</th>
                                </tr>
                            </thead>
                            <tbody id="packagesTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- ==================== TAB: KHUY·∫æN M√ÉI ==================== -->
                <div id="promotions" class="tab-content">
                    <div class="page-header">
                        <h2>üéÅ Danh m·ª•c Khuy·∫øn m√£i</h2>
                        <div class="page-actions" id="promotionsActions"><button class="btn btn-success"
                                onclick="openPromotionModal()">‚ûï Th√™m KM</button></div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>T√™n KM</th>
                                    <th>Lo·∫°i</th>
                                    <th>Gi√° Tr·ªã</th>
                                    <th>Th·ªùi H·∫°n</th>
                                    <th>Tr·∫°ng Th√°i</th>
                                    <th>Thao T√°c</th>
                                </tr>
                            </thead>
                            <tbody id="promotionsTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- ==================== TAB: PH√íNG H·ªåC ==================== -->
                <div id="rooms" class="tab-content">
                    <div class="page-header">
                        <h2>üè´ Qu·∫£n l√Ω Ph√≤ng h·ªçc</h2>
                        <div class="page-actions" id="roomsActions">
                            <button class="btn btn-success" onclick="openRoomModal()">‚ûï Th√™m ph√≤ng</button>
                        </div>
                    </div>

                    <!-- Th·ªëng k√™ nhanh -->
                    <div class="stats-grid mb-20">
                        <div class="stat-card">
                            <div class="stat-icon teal">üè´</div>
                            <div class="stat-info">
                                <h3 id="roomTotalCount">0</h3>
                                <p>T·ªïng ph√≤ng</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon green">‚úÖ</div>
                            <div class="stat-info">
                                <h3 id="roomActiveCount">0</h3>
                                <p>ƒêang ho·∫°t ƒë·ªông</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon orange">üîß</div>
                            <div class="stat-info">
                                <h3 id="roomMaintenanceCount">0</h3>
                                <p>ƒêang b·∫£o tr√¨</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon blue">üë•</div>
                            <div class="stat-info">
                                <h3 id="roomTotalCapacity">0</h3>
                                <p>T·ªïng s·ª©c ch·ª©a</p>
                            </div>
                        </div>
                    </div>

                    <!-- B·∫£ng danh s√°ch ph√≤ng -->
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>T√™n ph√≤ng</th>
                                    <th>S·ª©c ch·ª©a</th>
                                    <th>Trang thi·∫øt b·ªã</th>
                                    <th>Tr·∫°ng th√°i</th>
                                    <th>Ghi ch√∫</th>
                                    <th>Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody id="roomsTableBody"></tbody>
                        </table>
                    </div>

                    <!-- L·ªãch s·ª≠ d·ª•ng ph√≤ng h√¥m nay -->
                    <div class="card mt-20">
                        <div class="card-header">
                            <h3>üìÖ L·ªãch s·ª≠ d·ª•ng ph√≤ng h√¥m nay</h3>
                            <button class="btn btn-sm btn-outline" onclick="refreshRoomScheduleToday()">üîÑ L√†m
                                m·ªõi</button>
                        </div>
                        <div class="card-body" id="roomScheduleToday">
                            <p class="text-muted">ƒêang t·∫£i...</p>
                        </div>
                    </div>
                </div>



                <!-- ==================== TAB: B√ÅO C√ÅO ==================== -->
                <div id="reports" class="tab-content">
                    <div class="page-header">
                        <h2>üìà B√°o c√°o th·ªëng k√™</h2>
                        <div class="page-actions">
                            <button class="btn btn-info" onclick="exportReportToExcel()">üì§ Export Excel</button>
                            <button class="btn btn-primary" onclick="refreshReports()">üîÑ L√†m m·ªõi</button>
                        </div>
                    </div>

                    <!-- B·ªô ch·ªçn th·ªùi gian -->
                    <div class="card mb-20">
                        <div class="card-body">
                            <div class="d-flex gap-15 flex-wrap align-center">
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label style="font-size: 12px; margin-bottom: 4px;">Kho·∫£ng th·ªùi gian</label>
                                    <select id="reportPeriodType" onchange="onReportPeriodChange()">
                                        <option value="thisMonth">Th√°ng n√†y</option>
                                        <option value="lastMonth">Th√°ng tr∆∞·ªõc</option>
                                        <option value="thisQuarter">Qu√Ω n√†y</option>
                                        <option value="thisYear">NƒÉm nay</option>
                                        <option value="custom">T√πy ch·ªçn</option>
                                    </select>
                                </div>
                                <div class="form-group" style="margin-bottom: 0;" id="reportFromDateGroup">
                                    <label style="font-size: 12px; margin-bottom: 4px;">T·ª´ ng√†y</label>
                                    <input type="date" id="reportFromDate" onchange="loadReportData()">
                                </div>
                                <div class="form-group" style="margin-bottom: 0;" id="reportToDateGroup">
                                    <label style="font-size: 12px; margin-bottom: 4px;">ƒê·∫øn ng√†y</label>
                                    <input type="date" id="reportToDate" onchange="loadReportData()">
                                </div>
                                <div style="padding-top: 18px;">
                                    <button class="btn btn-success" onclick="loadReportData()">üìä Xem b√°o c√°o</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tab b√°o c√°o con -->
                    <div class="card">
                        <div class="card-header" style="border-bottom: none; padding-bottom: 0;">
                            <div class="report-tabs">
                                <button class="report-tab active" onclick="switchReportTab('revenue')"
                                    data-tab="revenue">üí∞ Doanh thu</button>
                                <button class="report-tab" onclick="switchReportTab('students')"
                                    data-tab="students">üë©‚Äçüéì H·ªçc vi√™n</button>
                                <button class="report-tab" onclick="switchReportTab('attendance')"
                                    data-tab="attendance">‚úÖ ƒêi·ªÉm danh</button>
                                <button class="report-tab" onclick="switchReportTab('debt')" data-tab="debt">üí≥ C√¥ng
                                    n·ª£</button>
                            </div>
                        </div>

                        <!-- N·ªôi dung b√°o c√°o Doanh thu -->
                        <div class="card-body report-content" id="reportRevenue">
                            <div class="stats-grid mb-20">
                                <div class="stat-card">
                                    <div class="stat-icon green">üí∞</div>
                                    <div class="stat-info">
                                        <h3 id="revenueTotalAmount">0</h3>
                                        <p>T·ªïng doanh thu</p>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon blue">üßæ</div>
                                    <div class="stat-info">
                                        <h3 id="revenueReceiptCount">0</h3>
                                        <p>S·ªë bi√™n lai</p>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon orange">üìà</div>
                                    <div class="stat-info">
                                        <h3 id="revenueAvgAmount">0</h3>
                                        <p>Trung b√¨nh/bi√™n lai</p>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon purple">üìã</div>
                                    <div class="stat-info">
                                        <h3 id="revenueRegCount">0</h3>
                                        <p>Phi·∫øu ƒêK m·ªõi</p>
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex gap-20 flex-wrap">
                                <div class="flex-1" style="min-width: 400px;">
                                    <div class="chart-container"
                                        style="background: var(--bg-white); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color);">
                                        <h4 style="margin-bottom: 15px;">üìä Doanh thu theo th·ªùi gian</h4>
                                        <div id="revenueChartLoading" class="text-center text-muted p-20">ƒêang t·∫£i bi·ªÉu
                                            ƒë·ªì...</div>
                                        <canvas id="revenueTimeChart" style="display: none;"></canvas>
                                        <div id="revenueTimeTable" style="display: none; margin-top: 15px;"></div>
                                    </div>
                                </div>
                                <div style="min-width: 300px; max-width: 400px;">
                                    <div class="chart-container"
                                        style="background: var(--bg-white); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color);">
                                        <h4 style="margin-bottom: 15px;">üéØ Doanh thu theo m√¥n h·ªçc</h4>
                                        <div id="revenueSubjectLoading" class="text-center text-muted p-20">ƒêang t·∫£i
                                            bi·ªÉu ƒë·ªì...</div>
                                        <canvas id="revenueSubjectChart" style="display: none;"></canvas>
                                        <div id="revenueSubjectTable" style="display: none; margin-top: 15px;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- N·ªôi dung b√°o c√°o H·ªçc vi√™n -->
                        <div class="card-body report-content" id="reportStudents" style="display: none;">
                            <div class="stats-grid mb-20">
                                <div class="stat-card">
                                    <div class="stat-icon teal">üë•</div>
                                    <div class="stat-info">
                                        <h3 id="studentTotalCount">0</h3>
                                        <p>T·ªïng h·ªçc vi√™n</p>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon green">üÜï</div>
                                    <div class="stat-info">
                                        <h3 id="studentNewCount">0</h3>
                                        <p>HV m·ªõi trong k·ª≥</p>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon blue">üìö</div>
                                    <div class="stat-info">
                                        <h3 id="studentActiveCount">0</h3>
                                        <p>ƒêang h·ªçc</p>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon purple">üéì</div>
                                    <div class="stat-info">
                                        <h3 id="studentCompletedCount">0</h3>
                                        <p>Ho√†n th√†nh</p>
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex gap-20 flex-wrap">
                                <div class="flex-1" style="min-width: 400px;">
                                    <div class="chart-container"
                                        style="background: var(--bg-white); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color);">
                                        <h4 style="margin-bottom: 15px;">üìä H·ªçc vi√™n m·ªõi theo th√°ng</h4>
                                        <div id="studentChartLoading" class="text-center text-muted p-20">ƒêang t·∫£i bi·ªÉu
                                            ƒë·ªì...</div>
                                        <canvas id="studentTimeChart" style="display: none;"></canvas>
                                        <div id="studentTimeTable" style="display: none; margin-top: 15px;"></div>
                                    </div>
                                </div>
                                <div style="min-width: 300px; max-width: 400px;">
                                    <div class="chart-container"
                                        style="background: var(--bg-white); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color);">
                                        <h4 style="margin-bottom: 15px;">üéØ Ph√¢n b·ªï theo tr·∫°ng th√°i</h4>
                                        <div id="studentStatusLoading" class="text-center text-muted p-20">ƒêang t·∫£i bi·ªÉu
                                            ƒë·ªì...</div>
                                        <canvas id="studentStatusChart" style="display: none;"></canvas>
                                        <div id="studentStatusTable" style="display: none; margin-top: 15px;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- N·ªôi dung b√°o c√°o ƒêi·ªÉm danh -->
                        <div class="card-body report-content" id="reportAttendance" style="display: none;">
                            <div class="stats-grid mb-20">
                                <div class="stat-card">
                                    <div class="stat-icon teal">üìã</div>
                                    <div class="stat-info">
                                        <h3 id="attendanceTotalCount">0</h3>
                                        <p>T·ªïng l∆∞·ª£t ƒëi·ªÉm danh</p>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon green">‚úÖ</div>
                                    <div class="stat-info">
                                        <h3 id="attendancePresentRate">0%</h3>
                                        <p>T·ª∑ l·ªá c√≥ m·∫∑t</p>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon red">‚ùå</div>
                                    <div class="stat-info">
                                        <h3 id="attendanceAbsentCount">0</h3>
                                        <p>L∆∞·ª£t v·∫Øng</p>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon orange">üìù</div>
                                    <div class="stat-info">
                                        <h3 id="attendanceMakeupCount">0</h3>
                                        <p>L∆∞·ª£t h·ªçc b√π</p>
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex gap-20 flex-wrap">
                                <div class="flex-1" style="min-width: 400px;">
                                    <div class="chart-container"
                                        style="background: var(--bg-white); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color);">
                                        <h4 style="margin-bottom: 15px;">üìä ƒêi·ªÉm danh theo ng√†y</h4>
                                        <div id="attendanceChartLoading" class="text-center text-muted p-20">ƒêang t·∫£i
                                            bi·ªÉu ƒë·ªì...</div>
                                        <canvas id="attendanceTimeChart" style="display: none;"></canvas>
                                        <div id="attendanceTimeTable" style="display: none; margin-top: 15px;"></div>
                                    </div>
                                </div>
                                <div style="min-width: 300px; max-width: 400px;">
                                    <div class="chart-container"
                                        style="background: var(--bg-white); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color);">
                                        <h4 style="margin-bottom: 15px;">üéØ T·ª∑ l·ªá ƒëi·ªÉm danh</h4>
                                        <div id="attendanceRateLoading" class="text-center text-muted p-20">ƒêang t·∫£i
                                            bi·ªÉu ƒë·ªì...</div>
                                        <canvas id="attendanceRateChart" style="display: none;"></canvas>
                                        <div id="attendanceRateTable" style="display: none; margin-top: 15px;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- N·ªôi dung b√°o c√°o C√¥ng n·ª£ -->
                        <div class="card-body report-content" id="reportDebt" style="display: none;">
                            <div class="stats-grid mb-20">
                                <div class="stat-card">
                                    <div class="stat-icon green">üí∞</div>
                                    <div class="stat-info">
                                        <h3 id="debtReportTotal">0</h3>
                                        <p>T·ªïng ph·∫£i thu</p>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon blue">‚úÖ</div>
                                    <div class="stat-info">
                                        <h3 id="debtReportPaid">0</h3>
                                        <p>ƒê√£ thu trong k·ª≥</p>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon red">‚ö†Ô∏è</div>
                                    <div class="stat-info">
                                        <h3 id="debtReportRemaining">0</h3>
                                        <p>C√≤n n·ª£</p>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon orange">üìà</div>
                                    <div class="stat-info">
                                        <h3 id="debtReportRate">0%</h3>
                                        <p>T·ª∑ l·ªá thu</p>
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex gap-20 flex-wrap">
                                <div class="flex-1" style="min-width: 400px;">
                                    <div class="chart-container"
                                        style="background: var(--bg-white); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color);">
                                        <h4 style="margin-bottom: 15px;">üìä Thu ti·ªÅn theo th·ªùi gian</h4>
                                        <div id="debtChartLoading" class="text-center text-muted p-20">ƒêang t·∫£i bi·ªÉu
                                            ƒë·ªì...</div>
                                        <canvas id="debtTimeChart" style="display: none;"></canvas>
                                        <div id="debtTimeTable" style="display: none; margin-top: 15px;"></div>
                                    </div>
                                </div>
                                <div style="min-width: 300px; max-width: 400px;">
                                    <div class="chart-container"
                                        style="background: var(--bg-white); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color);">
                                        <h4 style="margin-bottom: 15px;">üéØ T√¨nh tr·∫°ng c√¥ng n·ª£</h4>
                                        <div id="debtStatusLoading" class="text-center text-muted p-20">ƒêang t·∫£i bi·ªÉu
                                            ƒë·ªì...</div>
                                        <canvas id="debtStatusChart" style="display: none;"></canvas>
                                        <div id="debtStatusTable" style="display: none; margin-top: 15px;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- ==================== TAB: XU·∫§T/NH·∫¨P DATA ==================== -->
                <div id="export" class="tab-content">
                    <div class="page-header">
                        <h2>üì§ Xu·∫•t/Nh·∫≠p d·ªØ li·ªáu & Sao l∆∞u</h2>
                    </div>
                    <div class="settings-group">
                        <h3>üìä Xu·∫•t File Excel</h3>
                        <div class="d-flex gap-10 flex-wrap">
                            <button class="btn btn-success" onclick="exportAllToExcel()">üìä Xu·∫•t T·∫•t C·∫£</button>
                            <button class="btn btn-info" onclick="exportStudentsToExcel()">üë©‚Äçüéì H·ªçc Vi√™n</button>
                            <button class="btn btn-warning" onclick="exportAppointmentsToExcel()">üìÖ L·ªãch H·∫πn</button>
                            <button class="btn btn-primary" onclick="exportRegistrationsToExcel()">üìã Phi·∫øu ƒêK</button>
                            <button class="btn btn-secondary" onclick="exportReceiptsToExcel()">üßæ Bi√™n Lai</button>
                        </div>
                    </div>
                    <div class="settings-group">
                        <h3>üíæ Sao L∆∞u & Kh√¥i Ph·ª•c</h3>
                        <div class="d-flex gap-10 flex-wrap">
                            <button class="btn btn-success" onclick="exportBackupJSON()">üíæ T·∫£i Backup JSON</button>
                            <label class="btn btn-info" style="cursor: pointer;">üìÅ Kh√¥i Ph·ª•c JSON<input type="file"
                                    accept=".json" onchange="restoreFromJSON(event)" style="display: none;"></label>
                            <label class="btn btn-warning" style="cursor: pointer;">üì• Import Excel<input type="file"
                                    accept=".xlsx,.xls" onchange="importFromExcel(event)"
                                    style="display: none;"></label>
                        </div>
                    </div>
                    <div class="settings-group">
                        <h3>üìú L·ªãch S·ª≠ Backup T·ª± ƒê·ªông</h3>
                        <div id="backupHistoryList"></div>
                    </div>
                </div>

                <!-- ==================== TAB: T√ÄI KHO·∫¢N ==================== -->
                <div id="users" class="tab-content">
                    <div class="page-header">
                        <h2>üîê Qu·∫£n l√Ω T√†i kho·∫£n</h2>
                        <div class="page-actions"><button class="btn btn-success" onclick="openUserModal()">‚ûï Th√™m t√†i
                                kho·∫£n</button></div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Username</th>
                                    <th>H·ªç t√™n</th>
                                    <th>Vai tr√≤</th>
                                    <th>Tr·∫°ng th√°i</th>
                                    <th>ƒêƒÉng nh·∫≠p cu·ªëi</th>
                                    <th>Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody"></tbody>
                        </table>
                    </div>

                    <!-- Ph√¢n quy·ªÅn ƒë·ªông -->
                    <div class="card mt-20">
                        <div class="card-header">
                            <h3>‚öôÔ∏è Ph√¢n quy·ªÅn theo vai tr√≤</h3>
                            <select id="permissionRoleSelect" onchange="loadPermissionsForRole()">
                                <option value="admin">Admin</option>
                                <option value="manager">Manager</option>
                                <option value="user">User</option>
                            </select>
                        </div>
                        <div class="card-body">
                            <div class="permission-matrix" id="permissionMatrix">
                                <!-- Render b·∫±ng JS -->
                            </div>
                            <div class="form-actions mt-15">
                                <button class="btn btn-primary" onclick="savePermissions()">üíæ L∆∞u ph√¢n quy·ªÅn</button>
                                <button class="btn btn-secondary" onclick="resetPermissions()">üîÑ Reset m·∫∑c
                                    ƒë·ªãnh</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ==================== TAB: C√ÄI ƒê·∫∂T ==================== -->
                <div id="settings" class="tab-content">
                    <div class="page-header">
                        <h2>‚öôÔ∏è C√†i ƒë·∫∑t h·ªá th·ªëng</h2>
                    </div>
                    <div class="settings-group">
                        <h3>üè¢ Th√¥ng Tin Trung T√¢m</h3>
                        <form id="centerInfoForm" onsubmit="saveCenterInfo(event)">
                            <div class="form-row">
                                <div class="form-group"><label>T√™n Trung T√¢m *</label><input type="text" id="centerName"
                                        placeholder="VD: Trung T√¢m ABC"></div>
                                <div class="form-group"><label>S·ªë ƒêi·ªán Tho·∫°i *</label><input type="tel" id="centerPhone"
                                        placeholder="VD: 0912345678"></div>
                            </div>
                            <div class="form-group"><label>ƒê·ªãa Ch·ªâ *</label><input type="text" id="centerAddress"
                                    placeholder="VD: 123 ƒê∆∞·ªùng ABC"></div>
                            <div class="form-row">
                                <div class="form-group"><label>Email</label><input type="email" id="centerEmail"
                                        placeholder="VD: contact@abc.edu.vn"></div>
                                <div class="form-group"><label>Website</label><input type="url" id="centerWebsite"
                                        placeholder="VD: https://abc.edu.vn"></div>
                            </div>
                            <div class="form-group">
                                <label>Logo</label>
                                <input type="file" id="centerLogo" accept="image/*" onchange="previewLogo(event)">
                                <div class="logo-preview" id="logoPreview"><span class="text-muted">Logo</span></div>
                            </div>
                            <button type="submit" class="btn btn-primary">üíæ L∆∞u th√¥ng tin</button>
                        </form>
                    </div>
                    <div class="settings-group">
                        <h3>üí≥ Th√¥ng Tin Ng√¢n H√†ng</h3>
                        <form id="bankInfoForm" onsubmit="saveBankInfo(event)">
                            <div class="form-row">
                                <div class="form-group"><label>T√™n Ng√¢n H√†ng *</label><input type="text" id="bankName"
                                        placeholder="VD: Vietcombank"></div>
                                <div class="form-group"><label>S·ªë T√†i Kho·∫£n *</label><input type="text" id="bankAccount"
                                        placeholder="VD: 1234567890"></div>
                            </div>
                            <div class="form-row">
                                <div class="form-group"><label>Ch·ªß T√†i Kho·∫£n *</label><input type="text"
                                        id="bankAccountName" placeholder="VD: NGUYEN VAN A"></div>
                                <div class="form-group"><label>Chi Nh√°nh</label><input type="text" id="bankBranch"
                                        placeholder="VD: Chi nh√°nh T√¢n B√¨nh"></div>
                            </div>
                            <button type="submit" class="btn btn-primary">üíæ L∆∞u th√¥ng tin</button>
                        </form>
                        <div class="mt-15">
                            <h4 style="font-size: 14px; margin-bottom: 10px;">QR Chuy·ªÉn Kho·∫£n:</h4>
                            <div id="bankQRCode"></div>
                        </div>
                    </div>
                    <div class="settings-group">
                        <h3>üîÑ Sao L∆∞u T·ª± ƒê·ªông</h3>
                        <div class="d-flex align-center gap-15">
                            <label class="d-flex align-center gap-10" style="cursor: pointer;"><input type="checkbox"
                                    id="autoBackupToggle" onchange="toggleAutoBackup()"><span>B·∫≠t sao l∆∞u t·ª±
                                    ƒë·ªông</span></label>
                            <span id="autoBackupStatus" class="text-muted"></span>
                        </div>
                    </div>
                    <div class="settings-group">
                        <h3>‚ö†Ô∏è C√†i ƒê·∫∑t C·∫£nh B√°o</h3>
                        <form id="warningSettingsForm" onsubmit="saveWarningSettings(event)">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>C·∫£nh b√°o khi c√≤n √≠t bu·ªïi (ng∆∞·ª°ng 1 - Nh·∫π)</label>
                                    <input type="number" id="warningThreshold1" min="1" max="20" value="5"
                                        placeholder="VD: 5">
                                </div>
                                <div class="form-group">
                                    <label>C·∫£nh b√°o khi c√≤n √≠t bu·ªïi (ng∆∞·ª°ng 2 - Trung b√¨nh)</label>
                                    <input type="number" id="warningThreshold2" min="1" max="10" value="3"
                                        placeholder="VD: 3">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>C·∫£nh b√°o khi c√≤n √≠t bu·ªïi (ng∆∞·ª°ng 3 - Cao)</label>
                                    <input type="number" id="warningThreshold3" min="1" max="5" value="1"
                                        placeholder="VD: 1">
                                </div>
                                <div class="form-group">
                                    <label>Hi·ªÉn th·ªã c·∫£nh b√°o tr√™n Dashboard</label>
                                    <select id="showWarningOnDashboard">
                                        <option value="true">C√≥</option>
                                        <option value="false">Kh√¥ng</option>
                                    </select>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">üíæ L∆∞u c√†i ƒë·∫∑t c·∫£nh b√°o</button>
                        </form>
                    </div>

                    <div class="settings-group">
                        <h3>üóëÔ∏è X√≥a D·ªØ Li·ªáu</h3>
                        <p class="text-muted mb-15" style="font-size: 13px;">‚ö†Ô∏è H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!</p>

                        <div class="d-flex gap-10 flex-wrap">
                            <div class="settings-group">
                                <h3>üé≤ T·∫°o D·ªØ Li·ªáu Demo</h3>
                                <p class="text-muted mb-15" style="font-size: 13px;">T·∫°o d·ªØ li·ªáu m·∫´u ƒë·ªÉ test h·ªá th·ªëng.
                                    Bao g·ªìm: H·ªçc vi√™n, Gi√°o vi√™n, L·ªõp h·ªçc, Phi·∫øu ƒêK, Bi√™n lai, ƒêi·ªÉm danh, H·ªçc b√π.</p>

                                <div
                                    style="background: #EBF5FB; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                                    <h4 style="margin: 0 0 10px 0; color: #1A5276; font-size: 14px;">üìã D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c
                                        t·∫°o:</h4>
                                    <ul style="margin: 0; padding-left: 20px; font-size: 13px; color: #2471A3;">
                                        <li>15 H·ªçc vi√™n (ƒë·ªß tr·∫°ng th√°i)</li>
                                        <li>4 Gi√°o vi√™n</li>
                                        <li>6 L·ªõp h·ªçc + 12 Ca h·ªçc</li>
                                        <li>12 Phi·∫øu ƒëƒÉng k√Ω</li>
                                        <li>8 Bi√™n lai thanh to√°n</li>
                                        <li>5 L·ªãch h·∫πn h·ªçc th·ª≠</li>
                                        <li>30+ ƒêi·ªÉm danh</li>
                                        <li>3 Y√™u c·∫ßu h·ªçc b√π</li>
                                    </ul>
                                </div>

                                <button class="btn btn-success" onclick="generateDemoData()">üé≤ T·∫°o D·ªØ Li·ªáu
                                    Demo</button>
                            </div>

                            <div
                                style="flex: 1; min-width: 250px; background: #FEF9E7; padding: 15px; border-radius: 8px; border: 1px solid #F39C12;">
                                <h4 style="margin: 0 0 10px 0; color: #9A7B0A; font-size: 14px;">üßπ X√≥a D·ªØ Li·ªáu Demo
                                </h4>
                                <p style="font-size: 12px; color: #7D6608; margin-bottom: 10px;">
                                    X√≥a: H·ªçc vi√™n, L·ªãch h·∫πn, Phi·∫øu ƒêK, Bi√™n lai, Gi√°o vi√™n, L·ªõp h·ªçc, ƒêi·ªÉm danh, H·ªçc
                                    b√π.<br>
                                    <strong>Gi·ªØ l·∫°i:</strong> T√†i kho·∫£n, Ph√¢n quy·ªÅn, M√¥n h·ªçc, G√≥i h·ªçc ph√≠, Khuy·∫øn m√£i,
                                    C√†i ƒë·∫∑t.
                                </p>
                                <button class="btn btn-warning" onclick="clearDemoData()">üßπ X√≥a D·ªØ Li·ªáu Demo</button>
                            </div>

                            <div
                                style="flex: 1; min-width: 250px; background: #FDEDEC; padding: 15px; border-radius: 8px; border: 1px solid #E74C3C;">
                                <h4 style="margin: 0 0 10px 0; color: #922B21; font-size: 14px;">üóëÔ∏è X√≥a To√†n B·ªô D·ªØ Li·ªáu
                                </h4>
                                <p style="font-size: 12px; color: #7B241C; margin-bottom: 10px;">
                                    X√≥a T·∫§T C·∫¢ d·ªØ li·ªáu nghi·ªáp v·ª•.<br>
                                    <strong>Gi·ªØ l·∫°i:</strong> Ch·ªâ gi·ªØ T√†i kho·∫£n ƒëƒÉng nh·∫≠p v√† M√¥n h·ªçc m·∫∑c ƒë·ªãnh.
                                </p>
                                <button class="btn btn-danger" onclick="clearAllData()">üóëÔ∏è X√≥a To√†n B·ªô</button>
                            </div>
                        </div>
                    </div>

                </div>

            </main>
        </div>
    </div>

    <!-- ============================================================
         üîî MODALS
         ============================================================ -->

    <!-- Quick View Modal -->
    <div id="quickViewModal" class="modal">
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h2>üëÅÔ∏è Th√¥ng Tin Chi Ti·∫øt</h2><button class="modal-close"
                    onclick="closeModal('quickViewModal')">√ó</button>
            </div>
            <div class="modal-body" id="quickViewContent"></div>
            <div class="modal-footer"><button class="btn btn-secondary"
                    onclick="closeModal('quickViewModal')">ƒê√≥ng</button></div>
        </div>
    </div>

    <!-- Appointment Modal -->
    <div id="appointmentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="appointmentModalTitle">üìÖ ƒê·∫∑t L·ªãch H·∫πn</h2><button class="modal-close"
                    onclick="closeModal('appointmentModal')">√ó</button>
            </div>
            <div class="modal-body">
                <form id="appointmentForm" onsubmit="saveAppointment(event)">
                    <input type="hidden" id="appointmentStudentId"><input type="hidden" id="editAppointmentId">
                    <div class="form-group"><label>H·ªçc Vi√™n *</label><select id="appointmentStudentSelect" required
                            onchange="onAppointmentStudentChange()">
                            <option value="">-- Ch·ªçn h·ªçc vi√™n --</option>
                        </select></div>
                    <div class="form-group"><label>M√¥n H·ªçc *</label><select id="appointmentSubject" required>
                            <option value="">-- Ch·ªçn m√¥n h·ªçc --</option>
                        </select></div>
                    <div class="form-row">
                        <div class="form-group"><label>Ng√†y H·∫πn *</label><input type="date" id="appointmentDate"
                                required></div>
                        <div class="form-group"><label>Gi·ªù H·∫πn *</label><input type="time" id="appointmentTime"
                                required></div>
                    </div>
                    <div class="form-group"><label>Ghi Ch√∫</label><textarea id="appointmentNotes" rows="2"
                            placeholder="Ghi ch√∫"></textarea></div>
                    <div id="appointmentConflictWarning" class="d-none"
                        style="background: #FEF5E7; padding: 12px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #F39C12; font-size: 13px;">
                    </div>
                </form>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary"
                    onclick="closeModal('appointmentModal')">H·ªßy</button><button type="submit" form="appointmentForm"
                    class="btn btn-success">üíæ L∆∞u</button></div>
        </div>
    </div>

    <!-- Registration Modal -->
    <div id="registrationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìã T·∫°o Phi·∫øu ƒêƒÉng K√Ω</h2>
                <button class="modal-close" onclick="closeModal('registrationModal')">√ó</button>
            </div>
            <div class="modal-body">
                <form id="registrationForm" onsubmit="saveRegistration(event)">
                    <input type="hidden" id="regStudentId">
                    <input type="hidden" id="editRegId" value="">

                    <!-- Ch·ªçn h·ªçc vi√™n -->
                    <div class="form-group">
                        <label>H·ªçc Vi√™n *</label>
                        <select id="regStudentSelect" required onchange="onRegStudentChange()">
                            <option value="">-- Ch·ªçn h·ªçc vi√™n --</option>
                        </select>
                    </div>

                    <!-- M√¥n h·ªçc & G√≥i -->
                    <div class="form-row">
                        <div class="form-group">
                            <label>M√¥n H·ªçc *</label>
                            <select id="regSubject" required onchange="loadPackagesForSubject()">
                                <option value="">-- Ch·ªçn m√¥n --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>G√≥i H·ªçc Ph√≠ *</label>
                            <select id="regPackage" required onchange="applyPackageFee()">
                                <option value="">-- Ch·ªçn g√≥i --</option>
                            </select>
                        </div>
                    </div>

                    <!-- S·ªë bu·ªïi & Ng√†y b·∫Øt ƒë·∫ßu -->
                    <div class="form-row">
                        <div class="form-group">
                            <label>S·ªë Bu·ªïi H·ªçc *</label>
                            <input type="number" id="regTotalSessions" required min="1" max="200" placeholder="VD: 8">
                            <small class="text-muted" style="font-size: 11px;">T·ª± ƒë·ªông theo g√≥i, c√≥ th·ªÉ ch·ªânh
                                s·ª≠a</small>
                        </div>
                        <div class="form-group">
                            <label>Ng√†y B·∫Øt ƒê·∫ßu H·ªçc</label>
                            <input type="date" id="regStartDate">
                            <small class="text-muted" style="font-size: 11px;">ƒê·ªÉ tr·ªëng n·∫øu ch∆∞a x√°c ƒë·ªãnh</small>
                        </div>
                    </div>

                    <!-- H·ªçc ph√≠ -->
                    <div class="form-group">
                        <label>H·ªçc Ph√≠ (VNƒê) *</label>
                        <input type="text" id="regTuitionFee" required placeholder="VD: 2,000,000"
                            oninput="formatCurrencyInput(this); calculateFinalAmount()">
                    </div>

                    <!-- Khuy·∫øn m√£i -->
                    <div class="form-group">
                        <label>Khuy·∫øn M√£i</label>
                        <div id="regPromotionList" class="checkbox-group"></div>
                    </div>

                    <!-- Gi·∫£m gi√° & Th√†nh ti·ªÅn -->
                    <div class="form-row">
                        <div class="form-group">
                            <label>Gi·∫£m Gi√°</label>
                            <input type="text" id="regDiscountAmount" readonly
                                style="background: #FDEDEC; color: #E74C3C; font-weight: 600;">
                        </div>
                        <div class="form-group">
                            <label>Th√†nh Ti·ªÅn</label>
                            <input type="text" id="regFinalAmount" readonly
                                style="background: #E8F8F0; color: #27AE60; font-weight: 600;">
                        </div>
                    </div>

                    <!-- Ng√†y ƒëƒÉng k√Ω -->
                    <div class="form-group">
                        <label>Ng√†y ƒêƒÉng K√Ω *</label>
                        <input type="date" id="regDate" required>
                    </div>

                    <!-- Ghi ch√∫ -->
                    <div class="form-group">
                        <label>Ghi Ch√∫</label>
                        <textarea id="regNotes" rows="2"
                            placeholder="Ghi ch√∫ th√™m v·ªÅ phi·∫øu ƒëƒÉng k√Ω (t√πy ch·ªçn)"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('registrationModal')">H·ªßy</button>
                <button type="submit" form="registrationForm" class="btn btn-success">‚úÖ L∆∞u Phi·∫øu ƒêK</button>
            </div>
        </div>
    </div>


    <!-- View Registration Modal -->
    <div id="viewRegistrationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìã Chi Ti·∫øt Phi·∫øu ƒêƒÉng K√Ω</h2><button class="modal-close"
                    onclick="closeModal('viewRegistrationModal')">√ó</button>
            </div>
            <div class="modal-body" id="registrationPreviewContent"></div>
            <div class="modal-footer">
                <button class="btn btn-info" onclick="printRegistration()">üñ®Ô∏è In</button>
                <button class="btn btn-primary" onclick="downloadRegistrationPDF()">üìÑ T·∫£i PDF</button>
                <button class="btn btn-secondary" onclick="closeModal('viewRegistrationModal')">ƒê√≥ng</button>
            </div>
        </div>
    </div>

    <!-- Receipt Modal -->
    <div id="receiptModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üßæ T·∫°o Bi√™n Lai</h2><button class="modal-close" onclick="closeModal('receiptModal')">√ó</button>
            </div>
            <div class="modal-body">
                <form id="receiptForm" onsubmit="saveReceipt(event)">
                    <input type="hidden" id="editReceiptId">
                    <div class="form-group">
                        <label>Lo·∫°i bi√™n lai *</label>
                        <select id="receiptType" required onchange="onReceiptTypeChange()">
                            <option value="">-- Ch·ªçn lo·∫°i --</option>
                            <optgroup label="Thu ti·ªÅn">
                                <option value="Bi√™n Lai ƒêi·ªán T·ª≠">üí≥ Bi√™n Lai ƒêi·ªán T·ª≠ (Chuy·ªÉn kho·∫£n)</option>
                                <option value="Phi·∫øu Thu">üíµ Phi·∫øu Thu (Ti·ªÅn m·∫∑t)</option>
                            </optgroup>
                            <optgroup label="Chi ti·ªÅn">
                                <option value="Phi·∫øu Chi">üî¥ Phi·∫øu Chi (Ho√†n ti·ªÅn)</option>
                            </optgroup>
                        </select>
                    </div>

                    <div class="form-group"><label>H·ªçc Vi√™n *</label><select id="receiptStudentId" required
                            onchange="fillReceiptStudentInfo()">
                            <option value="">-- Ch·ªçn h·ªçc vi√™n --</option>
                        </select></div>
                    <div class="form-row">
                        <div class="form-group"><label>Ph·ª• Huynh</label><input type="text" id="receiptParentName"
                                readonly style="background: var(--bg-light);"></div>
                        <div class="form-group"><label>SƒêT</label><input type="text" id="receiptParentPhone" readonly
                                style="background: var(--bg-light);"></div>
                    </div>
                    <div class="form-group"><label>Li√™n k·∫øt Phi·∫øu ƒêK</label><select id="receiptRegistrationSelect"
                            onchange="fillFromRegistration()">
                            <option value="">-- Ch·ªçn phi·∫øu ƒêK --</option>
                        </select><input type="hidden" id="receiptRegistrationId"></div>
                    <div class="form-group"><label>N·ªôi Dung *</label><input type="text" id="receiptDescription" required
                            placeholder="VD: H·ªçc ph√≠ th√°ng 1"></div>
                    <div class="form-row">
                        <div class="form-group"><label>S·ªë Ti·ªÅn (VNƒê) *</label><input type="text" id="receiptAmount"
                                required placeholder="VD: 2,000,000" oninput="formatCurrencyInput(this)"></div>
                        <div class="form-group"><label>Ng√†y *</label><input type="date" id="receiptDate" required></div>
                    </div>
                    <div class="form-group"><label>Ghi Ch√∫</label><textarea id="receiptNotes" rows="2"
                            placeholder="Ghi ch√∫"></textarea></div>
                </form>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary"
                    onclick="closeModal('receiptModal')">H·ªßy</button><button type="submit" form="receiptForm"
                    class="btn btn-success">üíæ L∆∞u</button></div>
        </div>
    </div>

    <!-- View Receipt Modal -->
    <div id="viewReceiptModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üßæ Xem Bi√™n Lai</h2><button class="modal-close" onclick="closeModal('viewReceiptModal')">√ó</button>
            </div>
            <div class="modal-body" id="receiptPreviewContent"></div>
            <div class="modal-footer">
                <button class="btn btn-info" onclick="printReceipt()">üñ®Ô∏è In</button>
                <button class="btn btn-primary" onclick="downloadReceiptPDF()">üìÑ T·∫£i PDF</button>
                <button class="btn btn-secondary" onclick="closeModal('viewReceiptModal')">ƒê√≥ng</button>
            </div>
        </div>
    </div>

    <!-- Subject Modal -->
    <div id="subjectModal" class="modal">
        <div class="modal-content modal-sm">
            <div class="modal-header">
                <h2 id="subjectModalTitle">üìñ Th√™m M√¥n H·ªçc</h2><button class="modal-close"
                    onclick="closeModal('subjectModal')">√ó</button>
            </div>
            <div class="modal-body">
                <form id="subjectForm" onsubmit="saveSubject(event)">
                    <input type="hidden" id="editSubjectId">
                    <div class="form-row">
                        <div class="form-group"><label>Icon *</label><input type="text" id="subjectIcon" required
                                placeholder="VD: ‚ôüÔ∏è"></div>
                        <div class="form-group"><label>T√™n M√¥n *</label><input type="text" id="subjectName" required
                                placeholder="VD: C·ªù Vua"></div>
                    </div>
                    <div class="form-group"><label>H·ªçc Ph√≠ M·∫∑c ƒê·ªãnh *</label><input type="text" id="subjectDefaultFee"
                            required placeholder="VD: 2,000,000" oninput="formatCurrencyInput(this)"></div>
                </form>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary"
                    onclick="closeModal('subjectModal')">H·ªßy</button><button type="submit" form="subjectForm"
                    class="btn btn-success">üíæ L∆∞u</button></div>
        </div>
    </div>

    <!-- Package Modal -->
    <div id="packageModal" class="modal">
        <div class="modal-content modal-sm">
            <div class="modal-header">
                <h2 id="packageModalTitle">üì¶ Th√™m G√≥i H·ªçc Ph√≠</h2><button class="modal-close"
                    onclick="closeModal('packageModal')">√ó</button>
            </div>
            <div class="modal-body">
                <form id="packageForm" onsubmit="savePackage(event)">
                    <input type="hidden" id="editPackageId">
                    <div class="form-group"><label>T√™n G√≥i *</label><input type="text" id="packageName" required
                            placeholder="VD: G√≥i C∆° B·∫£n"></div>
                    <div class="form-row">
                        <div class="form-group"><label>M√¥n H·ªçc *</label><select id="packageSubject" required></select>
                        </div>
                        <div class="form-group"><label>S·ªë Bu·ªïi *</label><input type="number" id="packageSessions"
                                required min="1" placeholder="VD: 8"></div>
                    </div>
                    <div class="form-group"><label>H·ªçc Ph√≠ *</label><input type="text" id="packageFee" required
                            placeholder="VD: 1,600,000" oninput="formatCurrencyInput(this)"></div>
                </form>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary"
                    onclick="closeModal('packageModal')">H·ªßy</button><button type="submit" form="packageForm"
                    class="btn btn-success">üíæ L∆∞u</button></div>
        </div>
    </div>

    <!-- Promotion Modal -->
    <div id="promotionModal" class="modal">
        <div class="modal-content modal-sm">
            <div class="modal-header">
                <h2 id="promotionModalTitle">üéÅ Th√™m Khuy·∫øn M√£i</h2><button class="modal-close"
                    onclick="closeModal('promotionModal')">√ó</button>
            </div>
            <div class="modal-body">
                <form id="promotionForm" onsubmit="savePromotion(event)">
                    <input type="hidden" id="editPromotionId">
                    <div class="form-group"><label>T√™n KM *</label><input type="text" id="promotionName" required
                            placeholder="VD: KM Khai Tr∆∞∆°ng"></div>
                    <div class="form-row">
                        <div class="form-group"><label>Lo·∫°i *</label><select id="promotionType" required>
                                <option value="percent">Gi·∫£m %</option>
                                <option value="fixed">Gi·∫£m VNƒê</option>
                            </select></div>
                        <div class="form-group"><label>Gi√° Tr·ªã *</label><input type="number" id="promotionValue"
                                required min="0" placeholder="VD: 10"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>T·ª´ Ng√†y *</label><input type="date" id="promotionStartDate"
                                required></div>
                        <div class="form-group"><label>ƒê·∫øn Ng√†y *</label><input type="date" id="promotionEndDate"
                                required></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary"
                    onclick="closeModal('promotionModal')">H·ªßy</button><button type="submit" form="promotionForm"
                    class="btn btn-success">üíæ L∆∞u</button></div>
        </div>
    </div>

    <!-- User Modal (Th√™m/S·ª≠a t√†i kho·∫£n) -->
    <div id="userModal" class="modal">
        <div class="modal-content modal-sm">
            <div class="modal-header">
                <h2 id="userModalTitle">üë§ Th√™m T√†i Kho·∫£n</h2><button class="modal-close"
                    onclick="closeModal('userModal')">√ó</button>
            </div>
            <div class="modal-body">
                <form id="userForm" onsubmit="saveUser(event)">
                    <input type="hidden" id="editUserId">
                    <div class="form-group">
                        <label>T√™n ƒëƒÉng nh·∫≠p *</label>
                        <input type="text" id="userUsername" required placeholder="VD: nhanvien01"
                            pattern="[a-zA-Z0-9_]+" title="Ch·ªâ ch·ªØ, s·ªë v√† d·∫•u g·∫°ch d∆∞·ªõi">
                    </div>
                    <div class="form-group" id="passwordGroup">
                        <label>M·∫≠t kh·∫©u *</label>
                        <input type="password" id="userPassword" placeholder="T·ªëi thi·ªÉu 6 k√Ω t·ª±" minlength="6">
                    </div>
                    <div class="form-group">
                        <label>H·ªç t√™n *</label>
                        <input type="text" id="userFullName" required placeholder="VD: Nguy·ªÖn VƒÉn A">
                    </div>
                    <div class="form-group">
                        <label>Vai tr√≤ *</label>
                        <select id="userRole" required>
                            <option value="user">User - Ch·ªâ xem</option>
                            <option value="manager">Manager - Qu·∫£n l√Ω</option>
                            <option value="admin">Admin - To√†n quy·ªÅn</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary"
                    onclick="closeModal('userModal')">H·ªßy</button><button type="submit" form="userForm"
                    class="btn btn-success">üíæ L∆∞u</button></div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div id="changePasswordModal" class="modal">
        <div class="modal-content modal-sm">
            <div class="modal-header">
                <h2>üîë ƒê·ªïi M·∫≠t Kh·∫©u</h2><button class="modal-close"
                    onclick="closeModal('changePasswordModal')">√ó</button>
            </div>
            <div class="modal-body">
                <form id="changePasswordForm" onsubmit="handleChangePassword(event)">
                    <div class="form-group">
                        <label>M·∫≠t kh·∫©u hi·ªán t·∫°i *</label>
                        <div class="input-wrapper">
                            <input type="password" id="currentPassword" required placeholder="Nh·∫≠p m·∫≠t kh·∫©u hi·ªán t·∫°i"
                                style="padding-right: 45px;">
                            <button type="button" class="password-toggle"
                                onclick="togglePasswordField('currentPassword', this)">üëÅÔ∏è</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>M·∫≠t kh·∫©u m·ªõi *</label>
                        <div class="input-wrapper">
                            <input type="password" id="newPassword" required placeholder="T·ªëi thi·ªÉu 6 k√Ω t·ª±"
                                minlength="6" style="padding-right: 45px;">
                            <button type="button" class="password-toggle"
                                onclick="togglePasswordField('newPassword', this)">üëÅÔ∏è</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi *</label>
                        <div class="input-wrapper">
                            <input type="password" id="confirmPassword" required placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi"
                                style="padding-right: 45px;">
                            <button type="button" class="password-toggle"
                                onclick="togglePasswordField('confirmPassword', this)">üëÅÔ∏è</button>
                        </div>
                    </div>


                </form>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary"
                    onclick="closeModal('changePasswordModal')">H·ªßy</button><button type="submit"
                    form="changePasswordForm" class="btn btn-success">üíæ ƒê·ªïi m·∫≠t kh·∫©u</button></div>
        </div>
    </div>

    <!-- Force Change Password Modal (B·∫Øt bu·ªôc ƒë·ªïi m·∫≠t kh·∫©u) -->
    <div id="forceChangePasswordModal" class="modal">
        <div class="modal-content modal-sm">
            <div class="modal-header" style="background: #FEF5E7; border-bottom-color: #F39C12;">
                <h2 style="color: #D68910;">üîê B·∫Øt Bu·ªôc ƒê·ªïi M·∫≠t Kh·∫©u</h2>
                <!-- Kh√¥ng c√≥ n√∫t ƒë√≥ng - b·∫Øt bu·ªôc ph·∫£i ƒë·ªïi -->
            </div>
            <div class="modal-body">
                <div
                    style="background: #FEF9E7; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #F39C12;">
                    <p style="margin: 0; color: #9A7B0A; font-size: 14px;">
                        <strong>‚ö†Ô∏è Th√¥ng b√°o b·∫£o m·∫≠t:</strong><br>
                        H·ªá th·ªëng ƒë√£ n√¢ng c·∫•p b·∫£o m·∫≠t. Anh/Ch·ªã c·∫ßn ƒë·ªïi m·∫≠t kh·∫©u m·ªõi ƒë·ªÉ ti·∫øp t·ª•c s·ª≠ d·ª•ng.
                    </p>
                </div>
                <form id="forceChangePasswordForm" onsubmit="handleForceChangePassword(event)">
                    <div class="form-group">
                        <label>M·∫≠t kh·∫©u m·ªõi *</label>
                        <input type="password" id="forceNewPassword" required placeholder="T·ªëi thi·ªÉu 6 k√Ω t·ª±"
                            minlength="6">
                    </div>
                    <div class="form-group">
                        <label>X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi *</label>
                        <input type="password" id="forceConfirmPassword" required placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi">
                    </div>
                    <div id="forcePasswordError"
                        style="color: #E74C3C; font-size: 13px; margin-bottom: 15px; display: none;"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="submit" form="forceChangePasswordForm" class="btn btn-warning">üîê ƒê·ªïi M·∫≠t Kh·∫©u
                    Ngay</button>
            </div>
        </div>
    </div>

    <!-- Teacher Modal -->
    <div id="teacherModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="teacherModalTitle">üë®‚Äçüè´ Th√™m Gi√°o Vi√™n</h2>
                <button class="modal-close" onclick="closeModal('teacherModal')">√ó</button>
            </div>
            <div class="modal-body">
                <form id="teacherForm" onsubmit="saveTeacher(event)">
                    <input type="hidden" id="editTeacherId">
                    <div class="form-row">
                        <div class="form-group">
                            <label>H·ªç t√™n *</label>
                            <input type="text" id="teacherFullName" required placeholder="VD: Nguy·ªÖn VƒÉn A">
                        </div>
                        <div class="form-group">
                            <label>S·ªë ƒëi·ªán tho·∫°i *</label>
                            <input type="tel" id="teacherPhone" required placeholder="VD: 0901234567">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="teacherEmail" placeholder="VD: email@example.com">
                    </div>
                    <div class="form-group">
                        <label>M√¥n d·∫°y *</label>
                        <div class="checkbox-group" id="teacherSubjectsCheckboxes"></div>
                    </div>
                    <div class="form-group">
                        <label>Lo·∫°i l∆∞∆°ng *</label>
                        <select id="teacherSalaryType" required onchange="toggleSalaryFields()">
                            <option value="per_session">üíµ Theo bu·ªïi d·∫°y</option>
                            <option value="fixed">üí∞ L∆∞∆°ng c·ªë ƒë·ªãnh/th√°ng</option>
                            <option value="both">üí≥ C·∫£ hai (C·ªë ƒë·ªãnh + Theo bu·ªïi)</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <div class="form-group" id="fixedSalaryGroup" style="display: none;">
                            <label>L∆∞∆°ng c·ªë ƒë·ªãnh/th√°ng</label>
                            <input type="text" id="teacherFixedSalary" placeholder="VD: 5,000,000"
                                oninput="formatCurrencyInput(this)">
                        </div>
                        <div class="form-group" id="perSessionGroup">
                            <label>Ti·ªÅn/bu·ªïi d·∫°y</label>
                            <input type="text" id="teacherPerSession" placeholder="VD: 200,000"
                                oninput="formatCurrencyInput(this)">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Ghi ch√∫</label>
                        <textarea id="teacherNotes" rows="2" placeholder="Ghi ch√∫ th√™m..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('teacherModal')">H·ªßy</button>
                <button type="submit" form="teacherForm" class="btn btn-success">üíæ L∆∞u</button>
            </div>
        </div>
    </div>

    <!-- View Teacher Modal -->
    <div id="viewTeacherModal" class="modal">
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h2>üë®‚Äçüè´ Chi ti·∫øt Gi√°o vi√™n</h2>
                <button class="modal-close" onclick="closeModal('viewTeacherModal')">√ó</button>
            </div>
            <div class="modal-body" id="viewTeacherContent"></div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('viewTeacherModal')">ƒê√≥ng</button>
            </div>
        </div>
    </div>

    <!-- Class Modal -->
    <div id="classModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="classModalTitle">üìö Th√™m L·ªõp H·ªçc</h2>
                <button class="modal-close" onclick="closeModal('classModal')">√ó</button>
            </div>
            <div class="modal-body">
                <form id="classForm" onsubmit="saveClass(event)">
                    <input type="hidden" id="editClassId">
                    <div class="form-group">
                        <label>T√™n l·ªõp *</label>
                        <input type="text" id="className" required placeholder="VD: C·ªù Vua - L·ªõp A1">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>M√¥n h·ªçc *</label>
                            <select id="classSubject" required onchange="filterTeachersBySubject()">
                                <option value="">-- Ch·ªçn m√¥n h·ªçc --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Gi√°o vi√™n</label>
                            <select id="classTeacher">
                                <option value="">-- Ch·ªçn gi√°o vi√™n --</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Lo·∫°i l·ªõp *</label>
                            <select id="classType" required onchange="toggleMaxStudents()">
                                <option value="group">üë• L·ªõp nh√≥m</option>
                                <option value="1on1">üë§ 1 k√®m 1</option>
                            </select>
                        </div>
                        <div class="form-group" id="maxStudentsGroup">
                            <label>Sƒ© s·ªë t·ªëi ƒëa *</label>
                            <input type="number" id="classMaxStudents" required min="1" max="30" value="10">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Tr·∫°ng th√°i</label>
                        <select id="classStatus">
                            <option value="new">üÜï L·ªõp m·ªõi</option>
                            <option value="active">üü¢ ƒêang h·ªçc</option>
                            <option value="completed">‚úÖ Ho√†n th√†nh</option>
                            <option value="cancelled">‚ùå ƒê√£ h·ªßy</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Ghi ch√∫</label>
                        <textarea id="classNotes" rows="2" placeholder="Ghi ch√∫ th√™m..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('classModal')">H·ªßy</button>
                <button type="submit" form="classForm" class="btn btn-success">üíæ L∆∞u</button>
            </div>
        </div>
    </div>

    <!-- View Class Modal -->
    <div id="viewClassModal" class="modal">
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h2>üìö Chi ti·∫øt L·ªõp h·ªçc</h2>
                <button class="modal-close" onclick="closeModal('viewClassModal')">√ó</button>
            </div>
            <div class="modal-body" id="viewClassContent"></div>
            <div class="modal-footer">
                <button class="btn btn-info" onclick="openScheduleModal()">üìÖ Th√™m ca h·ªçc</button>
                <button class="btn btn-success" onclick="openAssignStudentModal()">üë§ Th√™m h·ªçc vi√™n</button>
                <button class="btn btn-secondary" onclick="closeModal('viewClassModal')">ƒê√≥ng</button>
            </div>
        </div>
    </div>

    <!-- Schedule Modal (Th√™m ca h·ªçc) -->
    <div id="scheduleModal" class="modal">
        <div class="modal-content modal-sm">
            <div class="modal-header">
                <h2>üìÖ Th√™m Ca H·ªçc</h2>
                <button class="modal-close" onclick="closeModal('scheduleModal')">√ó</button>
            </div>
            <div class="modal-body">
                <form id="scheduleForm" onsubmit="saveSchedule(event)">
                    <input type="hidden" id="scheduleClassId">
                    <input type="hidden" id="editScheduleId">
                    <div class="form-group">
                        <label>Ng√†y trong tu·∫ßn *</label>
                        <select id="scheduleDayOfWeek" required>
                            <option value="1">Th·ª© 2</option>
                            <option value="2">Th·ª© 3</option>
                            <option value="3">Th·ª© 4</option>
                            <option value="4">Th·ª© 5</option>
                            <option value="5">Th·ª© 6</option>
                            <option value="6">Th·ª© 7</option>
                            <option value="7">Ch·ªß nh·∫≠t</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Gi·ªù b·∫Øt ƒë·∫ßu *</label>
                            <input type="time" id="scheduleStartTime" required value="08:30">
                        </div>
                        <div class="form-group">
                            <label>Gi·ªù k·∫øt th√∫c *</label>
                            <input type="time" id="scheduleEndTime" required value="10:00">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Ph√≤ng h·ªçc</label>
                        <select id="scheduleRoom">
                            <option value="">-- Ch·ªçn ph√≤ng --</option>
                        </select>
                    </div>

                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('scheduleModal')">H·ªßy</button>
                <button type="submit" form="scheduleForm" class="btn btn-success">üíæ L∆∞u</button>
            </div>
        </div>
    </div>

    <!-- View Attendance Detail Modal - C·∫¨P NH·∫¨T -->
    <div id="viewAttendanceModal" class="modal">
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h2>üìã Chi ti·∫øt ƒëi·ªÉm danh</h2>
                <button class="modal-close" onclick="closeModal('viewAttendanceModal')">√ó</button>
            </div>
            <div class="modal-body" id="viewAttendanceContent"></div>
            <div class="modal-footer">
                <button class="btn btn-warning" id="btnEditAttendanceBatch" onclick="enableEditAttendanceMode()">‚úèÔ∏è S·ª≠a
                    ƒëi·ªÉm danh</button>
                <button class="btn btn-success d-none" id="btnSaveAttendanceBatch" onclick="saveEditedAttendance()">üíæ
                    L∆∞u thay ƒë·ªïi</button>
                <button class="btn btn-secondary d-none" id="btnCancelEditAttendance" onclick="cancelEditAttendance()">‚ùå
                    H·ªßy s·ª≠a</button>
                <button class="btn btn-secondary" id="btnCloseAttendanceDetail"
                    onclick="closeModal('viewAttendanceModal')">ƒê√≥ng</button>
            </div>
        </div>
    </div>
    <!-- Confirm Change Attendance Status Modal -->
    <div id="confirmAttendanceChangeModal" class="modal">
        <div class="modal-content modal-sm">
            <div class="modal-header">
                <h2 id="confirmAttendanceChangeTitle">‚ö†Ô∏è X√°c nh·∫≠n thay ƒë·ªïi</h2>
                <button class="modal-close" onclick="closeModal('confirmAttendanceChangeModal')">√ó</button>
            </div>
            <div class="modal-body">
                <div id="confirmAttendanceChangeContent"></div>
                <input type="hidden" id="confirmAttendanceId">
                <input type="hidden" id="confirmAttendanceOldStatus">
                <input type="hidden" id="confirmAttendanceNewStatus">
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('confirmAttendanceChangeModal')">H·ªßy</button>
                <button class="btn btn-warning" id="btnConfirmAttendanceChange"
                    onclick="executeAttendanceStatusChange()">‚úÖ X√°c nh·∫≠n</button>
            </div>
        </div>
    </div>


    <!-- Schedule Makeup Modal -->
    <div id="scheduleMakeupModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìÖ X·∫øp l·ªãch h·ªçc b√π</h2>
                <button class="modal-close" onclick="closeModal('scheduleMakeupModal')">√ó</button>
            </div>
            <div class="modal-body">
                <form id="scheduleMakeupForm" onsubmit="saveMakeupSchedule(event)">
                    <input type="hidden" id="makeupRequestId">

                    <div class="quick-view-section">
                        <h4>üìã Th√¥ng tin y√™u c·∫ßu</h4>
                        <div class="quick-view-row">
                            <span class="quick-view-label">H·ªçc vi√™n:</span>
                            <span class="quick-view-value" id="makeupStudentName"></span>
                        </div>
                        <div class="quick-view-row">
                            <span class="quick-view-label">L·ªõp g·ªëc:</span>
                            <span class="quick-view-value" id="makeupOriginalClass"></span>
                        </div>
                        <div class="quick-view-row">
                            <span class="quick-view-label">Ng√†y ngh·ªâ:</span>
                            <span class="quick-view-value" id="makeupOriginalDate"></span>
                        </div>
                        <div class="quick-view-row">
                            <span class="quick-view-label">H·∫°n h·ªçc b√π:</span>
                            <span class="quick-view-value" id="makeupExpiryDate"></span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Ch·ªçn l·ªõp h·ªçc b√π *</label>
                        <select id="makeupClassSelect" required onchange="loadMakeupSchedules()">
                            <option value="">-- Ch·ªçn l·ªõp --</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Ch·ªçn ng√†y h·ªçc b√π *</label>
                        <input type="date" id="makeupDate" required onchange="loadMakeupSchedules()">
                    </div>

                    <div class="form-group">
                        <label>Ch·ªçn ca h·ªçc *</label>
                        <select id="makeupScheduleSelect" required>
                            <option value="">-- Ch·ªçn ca h·ªçc --</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Ghi ch√∫</label>
                        <textarea id="makeupNotes" rows="2" placeholder="Ghi ch√∫ th√™m..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('scheduleMakeupModal')">H·ªßy</button>
                <button type="submit" form="scheduleMakeupForm" class="btn btn-success">üìÖ X·∫øp l·ªãch</button>
            </div>
        </div>
    </div>
    <!-- Debt Payment Modal -->
    <div id="debtPaymentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üí≥ Thanh To√°n C√¥ng N·ª£</h2>
                <button class="modal-close" onclick="closeModal('debtPaymentModal')">√ó</button>
            </div>
            <div class="modal-body">
                <form id="debtPaymentForm" onsubmit="saveDebtPayment(event)">
                    <input type="hidden" id="paymentRegistrationId">

                    <div class="quick-view-section">
                        <h4>üìã Th√¥ng tin c√¥ng n·ª£</h4>
                        <div class="quick-view-row">
                            <span class="quick-view-label">H·ªçc vi√™n:</span>
                            <span class="quick-view-value" id="paymentStudentName"></span>
                        </div>
                        <div class="quick-view-row">
                            <span class="quick-view-label">M√£ phi·∫øu ƒêK:</span>
                            <span class="quick-view-value" id="paymentRegCode"></span>
                        </div>
                        <div class="quick-view-row">
                            <span class="quick-view-label">T·ªïng ti·ªÅn:</span>
                            <span class="quick-view-value" id="paymentTotalAmount"></span>
                        </div>
                        <div class="quick-view-row">
                            <span class="quick-view-label">ƒê√£ ƒë√≥ng:</span>
                            <span class="quick-view-value text-success" id="paymentPaidAmount"></span>
                        </div>
                        <div class="quick-view-row">
                            <span class="quick-view-label">C√≤n n·ª£:</span>
                            <span class="quick-view-value text-danger fw-700" id="paymentDebtAmount"></span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>S·ªë ti·ªÅn thanh to√°n *</label>
                        <input type="text" id="paymentAmount" required placeholder="VD: 1,000,000"
                            oninput="formatCurrencyInput(this); calculateRemainingDebt()">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Lo·∫°i bi√™n lai *</label>
                            <select id="paymentReceiptType" required>
                                <option value="Bi√™n Lai ƒêi·ªán T·ª≠">üí≥ Bi√™n Lai ƒêi·ªán T·ª≠</option>
                                <option value="Phi·∫øu Thu">üíµ Phi·∫øu Thu</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Ng√†y thanh to√°n *</label>
                            <input type="date" id="paymentDate" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Ghi ch√∫</label>
                        <textarea id="paymentNotes" rows="2" placeholder="Ghi ch√∫ th√™m..."></textarea>
                    </div>

                    <div id="paymentPreview"
                        style="background: #E8F8F0; padding: 12px; border-radius: 8px; margin-top: 10px;">
                        <p style="margin: 0; font-size: 13px;">
                            Sau khi thanh to√°n, c√≤n n·ª£: <strong id="paymentRemainingPreview" class="text-success">0
                                ‚Ç´</strong>
                        </p>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('debtPaymentModal')">H·ªßy</button>
                <button type="submit" form="debtPaymentForm" class="btn btn-success">üí∞ Thanh to√°n</button>
            </div>
        </div>
    </div>

    <!-- Debt Detail Modal -->
    <div id="debtDetailModal" class="modal">
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h2>üìã Chi Ti·∫øt C√¥ng N·ª£</h2>
                <button class="modal-close" onclick="closeModal('debtDetailModal')">√ó</button>
            </div>
            <div class="modal-body" id="debtDetailContent"></div>
            <div class="modal-footer">
                <button class="btn btn-success" id="debtDetailPayBtn" onclick="openPaymentFromDetail()">üí∞ Thanh
                    to√°n</button>
                <button class="btn btn-secondary" onclick="closeModal('debtDetailModal')">ƒê√≥ng</button>
            </div>
        </div>
    </div>

    <!-- Adjust Debt Modal -->
    <div id="adjustDebtModal" class="modal">
        <div class="modal-content modal-sm">
            <div class="modal-header">
                <h2>‚úèÔ∏è ƒêi·ªÅu Ch·ªânh C√¥ng N·ª£</h2>
                <button class="modal-close" onclick="closeModal('adjustDebtModal')">√ó</button>
            </div>
            <div class="modal-body">
                <form id="adjustDebtForm" onsubmit="saveAdjustedDebt(event)">
                    <input type="hidden" id="adjustRegistrationId">

                    <div class="quick-view-section">
                        <h4>üìã Th√¥ng tin hi·ªán t·∫°i</h4>
                        <div class="quick-view-row">
                            <span class="quick-view-label">H·ªçc vi√™n:</span>
                            <span class="quick-view-value" id="adjustStudentName"></span>
                        </div>
                        <div class="quick-view-row">
                            <span class="quick-view-label">T·ªïng ti·ªÅn g·ªëc:</span>
                            <span class="quick-view-value" id="adjustOriginalAmount"></span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>T·ªïng ti·ªÅn m·ªõi (sau ƒëi·ªÅu ch·ªânh) *</label>
                        <input type="text" id="adjustNewAmount" required placeholder="VD: 2,000,000"
                            oninput="formatCurrencyInput(this)">
                    </div>

                    <div class="form-group">
                        <label>L√Ω do ƒëi·ªÅu ch·ªânh *</label>
                        <textarea id="adjustReason" rows="2" required
                            placeholder="VD: Gi·∫£m h·ªçc ph√≠ ƒë·∫∑c bi·ªát..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('adjustDebtModal')">H·ªßy</button>
                <button type="submit" form="adjustDebtForm" class="btn btn-warning">‚úèÔ∏è ƒêi·ªÅu ch·ªânh</button>
            </div>
        </div>
    </div>

    <!-- Create Makeup Request Modal -->
    <div id="createMakeupModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚ûï T·∫°o Y√™u C·∫ßu H·ªçc B√π</h2>
                <button class="modal-close" onclick="closeModal('createMakeupModal')">√ó</button>
            </div>
            <div class="modal-body">
                <form id="createMakeupForm" onsubmit="saveNewMakeupRequest(event)">
                    <div class="form-group">
                        <label>Ch·ªçn l·ªõp *</label>
                        <select id="newMakeupClassSelect" required onchange="loadStudentsForMakeup()">
                            <option value="">-- Ch·ªçn l·ªõp h·ªçc --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Ch·ªçn h·ªçc vi√™n *</label>
                        <select id="newMakeupStudentSelect" required>
                            <option value="">-- Ch·ªçn h·ªçc vi√™n --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Ng√†y d·ª± ki·∫øn ngh·ªâ *</label>
                        <input type="date" id="newMakeupAbsentDate" required>
                    </div>
                    <div class="form-group">
                        <label>L√Ω do ngh·ªâ</label>
                        <textarea id="newMakeupReason" rows="2"
                            placeholder="VD: B·∫≠n vi·ªác gia ƒë√¨nh, ƒëi du l·ªãch..."></textarea>
                    </div>
                    <div style="background: #FEF9E7; padding: 12px; border-radius: 8px; margin-top: 15px;">
                        <p style="margin: 0; color: #9A7B0A; font-size: 13px;">
                            ‚ö†Ô∏è <strong>L∆∞u √Ω:</strong> Y√™u c·∫ßu h·ªçc b√π n√†y s·∫Ω ƒë∆∞·ª£c t·∫°o tr∆∞·ªõc. Khi ƒë·∫øn ng√†y ngh·ªâ, anh/ch·ªã
                            v·∫´n c·∫ßn ƒëi·ªÉm danh "C√≥ ph√©p" ƒë·ªÉ tr·ª´ bu·ªïi ch√≠nh th·ª©c.
                        </p>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('createMakeupModal')">H·ªßy</button>
                <button type="submit" form="createMakeupForm" class="btn btn-success">‚ûï T·∫°o y√™u c·∫ßu</button>
            </div>
        </div>
    </div>


    <!-- Confirm Makeup Completed Modal -->
    <div id="confirmMakeupModal" class="modal">
        <div class="modal-content modal-sm">
            <div class="modal-header">
                <h2>‚úÖ X√°c nh·∫≠n h·ªçc b√π</h2>
                <button class="modal-close" onclick="closeModal('confirmMakeupModal')">√ó</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="confirmMakeupId">
                <div class="quick-view-section">
                    <p>X√°c nh·∫≠n h·ªçc vi√™n <strong id="confirmMakeupStudent"></strong> ƒë√£ ho√†n th√†nh bu·ªïi h·ªçc b√π?</p>
                    <div class="quick-view-row">
                        <span class="quick-view-label">L·ªõp h·ªçc b√π:</span>
                        <span class="quick-view-value" id="confirmMakeupClass"></span>
                    </div>
                    <div class="quick-view-row">
                        <span class="quick-view-label">Ng√†y h·ªçc b√π:</span>
                        <span class="quick-view-value" id="confirmMakeupDate"></span>
                    </div>
                </div>
                <div style="background: #E8F8F0; padding: 12px; border-radius: 8px; margin-top: 15px;">
                    <p style="margin: 0; color: #27AE60; font-size: 13px;">
                        ‚úÖ Sau khi x√°c nh·∫≠n, bu·ªïi h·ªçc b√π s·∫Ω ƒë∆∞·ª£c ghi nh·∫≠n. S·ªë bu·ªïi c√≤n l·∫°i c·ªßa h·ªçc vi√™n s·∫Ω <strong>KH√îNG
                            b·ªã tr·ª´</strong>.
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('confirmMakeupModal')">H·ªßy</button>
                <button type="button" class="btn btn-success" onclick="completeMakeupRequest()">‚úÖ X√°c nh·∫≠n ho√†n
                    th√†nh</button>
            </div>
        </div>
    </div>

    <!-- Room Modal (Th√™m/S·ª≠a ph√≤ng h·ªçc) -->
    <div id="roomModal" class="modal">
        <div class="modal-content modal-sm">
            <div class="modal-header">
                <h2 id="roomModalTitle">üè´ Th√™m Ph√≤ng H·ªçc</h2>
                <button class="modal-close" onclick="closeModal('roomModal')">√ó</button>
            </div>
            <div class="modal-body">
                <form id="roomForm" onsubmit="saveRoom(event)">
                    <input type="hidden" id="editRoomId">
                    <div class="form-group">
                        <label>T√™n ph√≤ng *</label>
                        <input type="text" id="roomName" required placeholder="VD: Ph√≤ng A1, Ph√≤ng VIP">
                    </div>
                    <div class="form-group">
                        <label>S·ª©c ch·ª©a (ng∆∞·ªùi) *</label>
                        <input type="number" id="roomCapacity" required min="1" max="100" placeholder="VD: 15">
                    </div>
                    <div class="form-group">
                        <label>Trang thi·∫øt b·ªã</label>
                        <input type="text" id="roomEquipment" placeholder="VD: M√°y chi·∫øu, ƒêi·ªÅu h√≤a, B·∫£ng tr·∫Øng">
                    </div>
                    <div class="form-group">
                        <label>Tr·∫°ng th√°i *</label>
                        <select id="roomStatus" required>
                            <option value="active">üü¢ ƒêang ho·∫°t ƒë·ªông</option>
                            <option value="maintenance">üü† ƒêang b·∫£o tr√¨</option>
                            <option value="inactive">‚ö´ Ng∆∞ng s·ª≠ d·ª•ng</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Ghi ch√∫</label>
                        <textarea id="roomNotes" rows="2" placeholder="Ghi ch√∫ th√™m..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('roomModal')">H·ªßy</button>
                <button type="submit" form="roomForm" class="btn btn-success">üíæ L∆∞u</button>
            </div>
        </div>
    </div>



    <!-- Assign Student to Class Modal -->
    <div id="assignStudentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üë§ Th√™m H·ªçc Vi√™n V√†o L·ªõp</h2>
                <button class="modal-close" onclick="closeModal('assignStudentModal')">√ó</button>
            </div>
            <div class="modal-body">
                <form id="assignStudentForm" onsubmit="assignStudentToClass(event)">
                    <input type="hidden" id="assignClassId">
                    <div class="form-group">
                        <label>Ch·ªçn Phi·∫øu ƒëƒÉng k√Ω *</label>
                        <select id="assignRegistrationId" required onchange="showRegistrationInfo()">
                            <option value="">-- Ch·ªçn phi·∫øu ƒêK ch∆∞a g√°n l·ªõp --</option>
                        </select>
                    </div>
                    <div id="assignRegistrationInfo" style="display: none;">
                        <div class="quick-view-section">
                            <h4>üìã Th√¥ng tin Phi·∫øu ƒêK</h4>
                            <div class="quick-view-row">
                                <span class="quick-view-label">H·ªçc vi√™n:</span>
                                <span class="quick-view-value" id="assignStudentName"></span>
                            </div>
                            <div class="quick-view-row">
                                <span class="quick-view-label">M√¥n h·ªçc:</span>
                                <span class="quick-view-value" id="assignSubject"></span>
                            </div>
                            <div class="quick-view-row">
                                <span class="quick-view-label">S·ªë bu·ªïi:</span>
                                <span class="quick-view-value" id="assignTotalSessions"></span>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('assignStudentModal')">H·ªßy</button>
                <button type="submit" form="assignStudentForm" class="btn btn-success">‚úÖ G√°n v√†o l·ªõp</button>
            </div>
        </div>
    </div>


    <!-- Reset Password Modal (Admin reset cho user) -->
    <div id="resetPasswordModal" class="modal">
        <div class="modal-content modal-sm">
            <div class="modal-header">
                <h2>üîÑ Reset M·∫≠t Kh·∫©u</h2><button class="modal-close"
                    onclick="closeModal('resetPasswordModal')">√ó</button>
            </div>
            <div class="modal-body">
                <form id="resetPasswordForm" onsubmit="handleResetPassword(event)">
                    <input type="hidden" id="resetPasswordUserId">
                    <p class="mb-15">Reset m·∫≠t kh·∫©u cho t√†i kho·∫£n: <strong id="resetPasswordUsername"></strong></p>
                    <div class="form-group">
                        <label>M·∫≠t kh·∫©u m·ªõi *</label>
                        <div class="input-wrapper">
                            <input type="password" id="resetNewPassword" required placeholder="T·ªëi thi·ªÉu 6 k√Ω t·ª±"
                                minlength="6" style="padding-right: 45px;">
                            <button type="button" class="password-toggle"
                                onclick="togglePasswordField('resetNewPassword', this)">üëÅÔ∏è</button>
                        </div>
                    </div>

                </form>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary"
                    onclick="closeModal('resetPasswordModal')">H·ªßy</button><button type="submit"
                    form="resetPasswordForm" class="btn btn-warning">üîÑ Reset</button></div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification"></div>

    <!-- ============================================================
         üìú JAVASCRIPT - PH·∫¶N 2/2
         ============================================================ -->
    <script>
        /* ============================================================
           üìä PH·∫¶N 1: DATA & CONFIG
           ============================================================ */

        // ===== 1.1 C·∫•u h√¨nh h·ªá th·ªëng =====
        const CONFIG = {
            APP_NAME: 'Qu·∫£n L√Ω Trung T√¢m',
            VERSION: '4.0',
            SESSION_TIMEOUT: 480, // ph√∫t (8 gi·ªù)
            MAX_LOGIN_ATTEMPTS: 5,
            LOCKOUT_DURATION: 15, // ph√∫t
            PAGE_SIZE_OPTIONS: [10, 20, 50, 100],
            DEFAULT_PAGE_SIZE: 10
        };

        // ===== 1.1.1 C·∫•u h√¨nh b·∫£o m·∫≠t =====
        const SECURITY_CONFIG = {
            // Secret key ƒë·ªÉ m√£ h√≥a d·ªØ li·ªáu users (AES-256)
            // L∆∞u √Ω: Trong m√¥i tr∆∞·ªùng production th·ª±c t·∫ø, key n√†y n√™n ƒë∆∞·ª£c b·∫£o v·ªá t·ªët h∆°n
            SECRET_KEY: 'FZ_PROFILE001_SECRET_2025_!@#$%^&*()',

            // Ti·ªÅn t·ªë ƒë·ªÉ nh·∫≠n bi·∫øt hash m·ªõi (SHA-256)
            NEW_HASH_PREFIX: 'sha256_',

            // Ti·ªÅn t·ªë hash c≈© (ƒë·ªÉ ph√°t hi·ªán v√† y√™u c·∫ßu ƒë·ªïi password)
            OLD_HASH_PREFIX: 'fz_',

            // ƒê·ªô d√†i salt
            SALT_LENGTH: 32,

            // Key ƒë·ªÉ l∆∞u tr·∫°ng th√°i "c·∫ßn ƒë·ªïi m·∫≠t kh·∫©u"
            FORCE_CHANGE_PASSWORD_KEY: 'forceChangePassword'
        };

        // ===== 1.2 C·∫•u tr√∫c menu v·ªõi quy·ªÅn =====
        const MENU_STRUCTURE = [
            { id: 'dashboard', icon: 'üìä', text: 'T·ªïng quan', parent: null },
            { id: 'students-group', icon: 'üë•', text: 'Qu·∫£n l√Ω H·ªçc vi√™n', parent: null, isGroup: true },
            { id: 'students', icon: 'üë©‚Äçüéì', text: 'Danh s√°ch HV', parent: 'students-group' },
            { id: 'trial', icon: 'üéì', text: 'H·ªçc th·ª≠', parent: 'students-group' },
            { id: 'appointments', icon: 'üìÖ', text: 'L·ªãch h·∫πn', parent: 'students-group' },
            { id: 'finance-group', icon: 'üí∞', text: 'T√†i ch√≠nh', parent: null, isGroup: true },
            { id: 'registrations', icon: 'üìã', text: 'Phi·∫øu ƒëƒÉng k√Ω', parent: 'finance-group' },
            { id: 'receipts', icon: 'üßæ', text: 'Bi√™n lai', parent: 'finance-group' },
            { id: 'debts', icon: 'üí≥', text: 'C√¥ng n·ª£', parent: 'finance-group' },
            { id: 'training-group', icon: 'üè´', text: 'ƒê√†o t·∫°o', parent: null, isGroup: true },
            { id: 'teachers', icon: 'üë®‚Äçüè´', text: 'Gi√°o vi√™n', parent: 'training-group' },
            { id: 'classes', icon: 'üìö', text: 'L·ªõp h·ªçc', parent: 'training-group' },
            { id: 'makeup', icon: 'üìù', text: 'H·ªçc b√π', parent: 'training-group' },
            { id: 'attendance', icon: '‚úÖ', text: 'ƒêi·ªÉm danh', parent: 'training-group' },
            { id: 'category-group', icon: 'üìÅ', text: 'Danh m·ª•c', parent: null, isGroup: true },
            { id: 'subjects', icon: 'üìñ', text: 'M√¥n h·ªçc', parent: 'category-group' },
            { id: 'packages', icon: 'üì¶', text: 'G√≥i h·ªçc ph√≠', parent: 'category-group' },
            { id: 'promotions', icon: 'üéÅ', text: 'Khuy·∫øn m√£i', parent: 'category-group' },
            { id: 'rooms', icon: 'üè´', text: 'Ph√≤ng h·ªçc', parent: 'category-group' },
            { id: 'reports', icon: 'üìà', text: 'B√°o c√°o', parent: null },
            { id: 'system-group', icon: '‚öôÔ∏è', text: 'H·ªá th·ªëng', parent: null, isGroup: true },
            { id: 'export', icon: 'üì§', text: 'Xu·∫•t/Nh·∫≠p data', parent: 'system-group' },
            { id: 'users', icon: 'üîê', text: 'T√†i kho·∫£n', parent: 'system-group' },
            { id: 'settings', icon: '‚öôÔ∏è', text: 'C√†i ƒë·∫∑t', parent: 'system-group' }
        ];

        // ===== 1.3 Quy·ªÅn m·∫∑c ƒë·ªãnh cho t·ª´ng vai tr√≤ =====
        const DEFAULT_PERMISSIONS = {
            admin: {
                dashboard: { view: true, create: true, edit: true, delete: true },
                students: { view: true, create: true, edit: true, delete: true },
                trial: { view: true, create: true, edit: true, delete: true },
                appointments: { view: true, create: true, edit: true, delete: true },
                registrations: { view: true, create: true, edit: true, delete: true },
                receipts: { view: true, create: true, edit: true, delete: true },
                debts: { view: true, create: true, edit: true, delete: true },
                teachers: { view: true, create: true, edit: true, delete: true },
                classes: { view: true, create: true, edit: true, delete: true },
                attendance: { view: true, create: true, edit: true, delete: true },
                makeup: { view: true, create: true, edit: true, delete: true },
                subjects: { view: true, create: true, edit: true, delete: true },
                packages: { view: true, create: true, edit: true, delete: true },
                promotions: { view: true, create: true, edit: true, delete: true },
                rooms: { view: true, create: true, edit: true, delete: true },
                reports: { view: true, create: true, edit: true, delete: true },
                export: { view: true, create: true, edit: true, delete: true },
                users: { view: true, create: true, edit: true, delete: true },
                settings: { view: true, create: true, edit: true, delete: true }
            },
            manager: {
                dashboard: { view: true, create: false, edit: false, delete: false },
                students: { view: true, create: true, edit: true, delete: false },
                trial: { view: true, create: true, edit: true, delete: false },
                appointments: { view: true, create: true, edit: true, delete: true },
                registrations: { view: true, create: true, edit: true, delete: false },
                receipts: { view: true, create: true, edit: true, delete: false },
                debts: { view: true, create: false, edit: false, delete: false },
                teachers: { view: true, create: false, edit: false, delete: false },
                classes: { view: true, create: false, edit: false, delete: false },
                attendance: { view: true, create: true, edit: true, delete: false },
                makeup: { view: true, create: true, edit: true, delete: true },
                subjects: { view: true, create: false, edit: false, delete: false },
                packages: { view: true, create: false, edit: false, delete: false },
                promotions: { view: true, create: false, edit: false, delete: false },
                rooms: { view: true, create: false, edit: false, delete: false },
                reports: { view: true, create: false, edit: false, delete: false },
                export: { view: true, create: true, edit: false, delete: false },
                users: { view: false, create: false, edit: false, delete: false },
                settings: { view: false, create: false, edit: false, delete: false }
            },
            user: {
                dashboard: { view: true, create: false, edit: false, delete: false },
                students: { view: true, create: false, edit: false, delete: false },
                trial: { view: true, create: false, edit: false, delete: false },
                appointments: { view: true, create: false, edit: false, delete: false },
                registrations: { view: true, create: false, edit: false, delete: false },
                receipts: { view: true, create: false, edit: false, delete: false },
                debts: { view: true, create: false, edit: false, delete: false },
                teachers: { view: true, create: false, edit: false, delete: false },
                classes: { view: true, create: false, edit: false, delete: false },
                attendance: { view: true, create: false, edit: false, delete: false },
                makeup: { view: true, create: true, edit: true, delete: true },
                subjects: { view: true, create: false, edit: false, delete: false },
                packages: { view: true, create: false, edit: false, delete: false },
                promotions: { view: true, create: false, edit: false, delete: false },
                rooms: { view: true, create: false, edit: false, delete: false },
                reports: { view: true, create: false, edit: false, delete: false },
                export: { view: false, create: false, edit: false, delete: false },
                users: { view: false, create: false, edit: false, delete: false },
                settings: { view: false, create: false, edit: false, delete: false }
            }
        };

        // ===== 1.4 T√†i kho·∫£n m·∫∑c ƒë·ªãnh =====
        // ƒê√£ chuy·ªÉn sang kh·ªüi t·∫°o trong h√†m initializeDefaultUsers() v·ªõi m√£ h√≥a SHA-256
        // Xem PH·∫¶N 2: AUTHENTICATION
        // ===== 1.5 Kh·ªüi t·∫°o d·ªØ li·ªáu t·ª´ LocalStorage =====
        // Users s·∫Ω ƒë∆∞·ª£c load trong initializeDefaultUsers() v·ªõi m√£ h√≥a
        let users = []; // Kh·ªüi t·∫°o r·ªóng, s·∫Ω load sau

        let permissions = JSON.parse(localStorage.getItem('permissions')) || {};
        let currentUser = JSON.parse(localStorage.getItem('currentUser')) || null;
        let loginAttempts = JSON.parse(localStorage.getItem('loginAttempts')) || {};

        let students = JSON.parse(localStorage.getItem('students')) || [];
        let appointments = JSON.parse(localStorage.getItem('appointments')) || [];
        let receipts = JSON.parse(localStorage.getItem('receipts')) || [];
        let registrations = JSON.parse(localStorage.getItem('registrations')) || [];
        let subjects = JSON.parse(localStorage.getItem('subjects')) || [
            { id: '1', icon: '‚ôüÔ∏è', name: 'C·ªù Vua', defaultFee: 2000000 },
            { id: '2', icon: 'üé®', name: 'V·∫Ω Tranh', defaultFee: 1800000 },
            { id: '3', icon: 'üìö', name: 'Ti·ªÅn Ti·ªÉu H·ªçc', defaultFee: 1500000 },
            { id: '4', icon: '‚úçÔ∏è', name: 'R√®n Ch·ªØ', defaultFee: 1600000 }
        ];
        let packages = JSON.parse(localStorage.getItem('packages')) || [];
        let promotions = JSON.parse(localStorage.getItem('promotions')) || [];
        let centerInfo = JSON.parse(localStorage.getItem('centerInfo')) || {};
        let bankInfo = JSON.parse(localStorage.getItem('bankInfo')) || {};
        let backupHistory = JSON.parse(localStorage.getItem('backupHistory')) || [];
        let teachers = JSON.parse(localStorage.getItem('teachers')) || [];
        let classes = JSON.parse(localStorage.getItem('classes')) || [];
        let classSchedules = JSON.parse(localStorage.getItem('classSchedules')) || [];
        let classStudents = JSON.parse(localStorage.getItem('classStudents')) || [];
        let attendances = JSON.parse(localStorage.getItem('attendances')) || [];
        let makeupRequests = JSON.parse(localStorage.getItem('makeupRequests')) || [];
        let rooms = JSON.parse(localStorage.getItem('rooms')) || [];
        let warningSettings = JSON.parse(localStorage.getItem('warningSettings')) || {
            threshold1: 5,  // C·∫£nh b√°o nh·∫π
            threshold2: 3,  // C·∫£nh b√°o trung b√¨nh
            threshold3: 1,  // C·∫£nh b√°o cao
            showOnDashboard: true
        };

        let autoBackupEnabled = localStorage.getItem('autoBackupEnabled') === 'true';

        // ===== 1.6 State qu·∫£n l√Ω =====
        let paginationState = {
            students: { page: 1, pageSize: 10 },
            trial: { page: 1, pageSize: 10 },
            appointments: { page: 1, pageSize: 10 },
            registrations: { page: 1, pageSize: 10 },
            receipts: { page: 1, pageSize: 10 },
            teachers: { page: 1, pageSize: 10 },
            classes: { page: 1, pageSize: 10 },
            makeup: { page: 1, pageSize: 10 },
            attendanceHistory: { page: 1, pageSize: 10 },
            debts: { page: 1, pageSize: 10 }  // TH√äM M·ªöI
        };


        let currentFilter = 'all';
        let currentTrialFilter = 'all';
        let currentAppointmentFilter = 'all';

        /* ============================================================
        üîê PH·∫¶N 2: AUTHENTICATION (X√°c th·ª±c) - PHI√äN B·∫¢N B·∫¢O M·∫¨T
        ============================================================ */

        // ===== 2.1 T·∫°o Salt ng·∫´u nhi√™n =====
        function generateSalt(length = SECURITY_CONFIG.SALT_LENGTH) {
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*';
            let salt = '';
            for (let i = 0; i < length; i++) {
                salt += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            return salt;
        }

        // ===== 2.2 Hash password v·ªõi SHA-256 + Salt =====
        function hashPasswordSecure(password, salt) {
            // K·∫øt h·ª£p password + salt
            const combined = password + salt;
            // Hash b·∫±ng SHA-256
            const hash = CryptoJS.SHA256(combined).toString();
            // Tr·∫£ v·ªÅ v·ªõi prefix ƒë·ªÉ nh·∫≠n bi·∫øt
            return SECURITY_CONFIG.NEW_HASH_PREFIX + hash;
        }

        // ===== 2.3 Ki·ªÉm tra password (h·ªó tr·ª£ c·∫£ hash c≈© v√† m·ªõi) =====
        function verifyPassword(password, storedHash, salt = null) {
            // Ki·ªÉm tra hash m·ªõi (SHA-256)
            if (storedHash && storedHash.startsWith(SECURITY_CONFIG.NEW_HASH_PREFIX)) {
                if (!salt) return false;
                const newHash = hashPasswordSecure(password, salt);
                return newHash === storedHash;
            }

            // Ki·ªÉm tra hash c≈© (t∆∞∆°ng th√≠ch ng∆∞·ª£c)
            if (storedHash && storedHash.startsWith(SECURITY_CONFIG.OLD_HASH_PREFIX)) {
                const oldHash = hashPasswordOld(password);
                return oldHash === storedHash;
            }

            return false;
        }

        // ===== 2.3.1 Hash password c≈© (gi·ªØ l·∫°i ƒë·ªÉ t∆∞∆°ng th√≠ch) =====
        function hashPasswordOld(password) {
            let hash = 0;
            const str = password + 'fz_salt_2025';
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return 'fz_' + Math.abs(hash).toString(16);
        }

        // ===== 2.3.2 Ki·ªÉm tra password c√≥ ph·∫£i hash c≈© kh√¥ng =====
        function isOldPasswordHash(hash) {
            return hash && hash.startsWith(SECURITY_CONFIG.OLD_HASH_PREFIX);
        }

        // ===== 2.4 M√£ h√≥a d·ªØ li·ªáu (AES-256) =====
        function encryptData(data) {
            try {
                const jsonString = JSON.stringify(data);
                const encrypted = CryptoJS.AES.encrypt(jsonString, SECURITY_CONFIG.SECRET_KEY).toString();
                return encrypted;
            } catch (error) {
                console.error('L·ªói m√£ h√≥a d·ªØ li·ªáu:', error);
                return null;
            }
        }

        // ===== 2.5 Gi·∫£i m√£ d·ªØ li·ªáu (AES-256) =====
        function decryptData(encryptedData) {
            try {
                const bytes = CryptoJS.AES.decrypt(encryptedData, SECURITY_CONFIG.SECRET_KEY);
                const decryptedString = bytes.toString(CryptoJS.enc.Utf8);
                if (!decryptedString) {
                    return null;
                }
                return JSON.parse(decryptedString);
            } catch (error) {
                console.error('L·ªói gi·∫£i m√£ d·ªØ li·ªáu:', error);
                return null;
            }
        }

        // ===== 2.6 L∆∞u users v·ªõi m√£ h√≥a =====
        function saveUsersEncrypted(usersData) {
            const encrypted = encryptData(usersData);
            if (encrypted) {
                localStorage.setItem('users_encrypted', encrypted);
                // X√≥a d·ªØ li·ªáu users c≈© (plain text) n·∫øu c√≥
                localStorage.removeItem('users');
            }
        }

        // ===== 2.7 ƒê·ªçc users ƒë√£ m√£ h√≥a =====
        function loadUsersEncrypted() {
            // Th·ª≠ ƒë·ªçc d·ªØ li·ªáu m√£ h√≥a tr∆∞·ªõc
            const encrypted = localStorage.getItem('users_encrypted');
            if (encrypted) {
                const decrypted = decryptData(encrypted);
                if (decrypted) {
                    return decrypted;
                }
            }

            // Fallback: ƒë·ªçc d·ªØ li·ªáu c≈© (plain text) n·∫øu c√≥
            const oldData = localStorage.getItem('users');
            if (oldData) {
                try {
                    const users = JSON.parse(oldData);
                    // Migrate: l∆∞u l·∫°i d·∫°ng m√£ h√≥a
                    saveUsersEncrypted(users);
                    // X√≥a d·ªØ li·ªáu c≈©
                    localStorage.removeItem('users');
                    console.log('‚úÖ ƒê√£ migrate users t·ª´ plain text sang encrypted');
                    return users;
                } catch (e) {
                    console.error('L·ªói ƒë·ªçc users c≈©:', e);
                }
            }

            return [];
        }

        // ===== 2.8 Kh·ªüi t·∫°o users m·∫∑c ƒë·ªãnh (C·∫¨P NH·∫¨T) =====
        function initializeDefaultUsers() {
            // ƒê·ªçc users ƒë√£ m√£ h√≥a
            users = loadUsersEncrypted();

            if (users.length === 0) {
                // T·∫°o users m·∫∑c ƒë·ªãnh v·ªõi hash m·ªõi
                const defaultUsers = [
                    { username: 'admin', password: 'admin123', fullName: 'Qu·∫£n tr·ªã vi√™n', role: 'admin' },
                    { username: 'manager', password: 'manager123', fullName: 'Qu·∫£n l√Ω', role: 'manager' },
                    { username: 'user', password: 'user123', fullName: 'Nh√¢n vi√™n', role: 'user' }
                ];

                users = defaultUsers.map((u, index) => {
                    const salt = generateSalt();
                    return {
                        id: 'user_' + u.role,
                        username: u.username,
                        passwordHash: hashPasswordSecure(u.password, salt),
                        salt: salt, // L∆∞u salt ri√™ng cho m·ªói user
                        fullName: u.fullName,
                        role: u.role,
                        status: 'active',
                        createdAt: new Date().toISOString(),
                        lastLogin: null,
                        mustChangePassword: false // User m·ªõi kh√¥ng c·∫ßn ƒë·ªïi
                    };
                });

                saveUsersEncrypted(users);
                console.log('‚úÖ ƒê√£ t·∫°o users m·∫∑c ƒë·ªãnh v·ªõi m√£ h√≥a SHA-256');
            }

            // Kh·ªüi t·∫°o permissions n·∫øu ch∆∞a c√≥
            if (Object.keys(permissions).length === 0) {
                permissions = JSON.parse(JSON.stringify(DEFAULT_PERMISSIONS));
                saveData('permissions', permissions);
            }
        }


        // ===== 2.4 Ki·ªÉm tra kh√≥a t√†i kho·∫£n =====
        function isAccountLocked(username) {
            const attempts = loginAttempts[username];
            if (!attempts) return false;

            if (attempts.count >= CONFIG.MAX_LOGIN_ATTEMPTS) {
                const lockoutEnd = new Date(attempts.lastAttempt).getTime() + (CONFIG.LOCKOUT_DURATION * 60 * 1000);
                if (Date.now() < lockoutEnd) {
                    return true;
                } else {
                    // Reset sau khi h·∫øt th·ªùi gian kh√≥a
                    delete loginAttempts[username];
                    saveData('loginAttempts', loginAttempts);
                    return false;
                }
            }
            return false;
        }

        // ===== 2.5 Ghi nh·∫≠n l·∫ßn ƒëƒÉng nh·∫≠p sai =====
        function recordFailedLogin(username) {
            if (!loginAttempts[username]) {
                loginAttempts[username] = { count: 0, lastAttempt: null };
            }
            loginAttempts[username].count++;
            loginAttempts[username].lastAttempt = new Date().toISOString();
            saveData('loginAttempts', loginAttempts);
        }

        // ===== 2.6 Reset ƒë·∫øm ƒëƒÉng nh·∫≠p sai =====
        function resetLoginAttempts(username) {
            delete loginAttempts[username];
            saveData('loginAttempts', loginAttempts);
        }

        // ===== 2.9 X·ª≠ l√Ω ƒëƒÉng nh·∫≠p (C·∫¨P NH·∫¨T B·∫¢O M·∫¨T) =====
        function handleLogin(event) {
            event.preventDefault();

            const username = document.getElementById('loginUsername').value.trim().toLowerCase();
            const password = document.getElementById('loginPassword').value;
            const rememberMe = document.getElementById('rememberMe').checked;

            // Reset error
            hideLoginError();

            // Ki·ªÉm tra t√†i kho·∫£n b·ªã kh√≥a
            if (isAccountLocked(username)) {
                showLoginError(`T√†i kho·∫£n b·ªã kh√≥a t·∫°m th·ªùi. Vui l√≤ng th·ª≠ l·∫°i sau ${CONFIG.LOCKOUT_DURATION} ph√∫t.`);
                return;
            }

            // T√¨m user
            const user = users.find(u => u.username.toLowerCase() === username);

            if (!user) {
                recordFailedLogin(username);
                showLoginError('T√™n ƒëƒÉng nh·∫≠p kh√¥ng t·ªìn t·∫°i!');
                return;
            }

            // Ki·ªÉm tra tr·∫°ng th√°i
            if (user.status === 'locked') {
                showLoginError('T√†i kho·∫£n ƒë√£ b·ªã kh√≥a. Li√™n h·ªá Admin!');
                return;
            }

            // Ki·ªÉm tra password (h·ªó tr·ª£ c·∫£ hash c≈© v√† m·ªõi)
            const isValidPassword = verifyPassword(password, user.passwordHash, user.salt);

            if (!isValidPassword) {
                recordFailedLogin(username);
                const remaining = CONFIG.MAX_LOGIN_ATTEMPTS - (loginAttempts[username]?.count || 0);
                showLoginError(`Sai m·∫≠t kh·∫©u! C√≤n ${remaining} l·∫ßn th·ª≠.`);
                return;
            }

            // ƒêƒÉng nh·∫≠p th√†nh c√¥ng
            resetLoginAttempts(username);

            // Ki·ªÉm tra xem c√≥ ph·∫£i hash c≈© kh√¥ng ‚Üí y√™u c·∫ßu ƒë·ªïi m·∫≠t kh·∫©u
            const needChangePassword = isOldPasswordHash(user.passwordHash) || user.mustChangePassword;

            // C·∫≠p nh·∫≠t lastLogin
            user.lastLogin = new Date().toISOString();
            saveUsersEncrypted(users);

            // L∆∞u session
            currentUser = {
                id: user.id,
                username: user.username,
                fullName: user.fullName,
                role: user.role,
                loginTime: new Date().toISOString(),
                needChangePassword: needChangePassword // Flag ƒë·ªÉ ki·ªÉm tra sau
            };

            if (rememberMe) {
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
            } else {
                sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
            }

            // Chuy·ªÉn v√†o ·ª©ng d·ª•ng
            showApp();

            // N·∫øu c·∫ßn ƒë·ªïi m·∫≠t kh·∫©u, hi·ªán th√¥ng b√°o v√† m·ªü modal
            if (needChangePassword) {
                setTimeout(() => {
                    showNotification('‚ö†Ô∏è Vui l√≤ng ƒë·ªïi m·∫≠t kh·∫©u ƒë·ªÉ tƒÉng b·∫£o m·∫≠t!', 'warning');
                    openForceChangePasswordModal();
                }, 500);
            } else {
                showNotification(`Ch√†o m·ª´ng ${user.fullName}!`, 'success');
            }
        }


        // ===== 2.8 ƒêƒÉng xu·∫•t =====
        function handleLogout() {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?')) return;

            currentUser = null;
            localStorage.removeItem('currentUser');
            sessionStorage.removeItem('currentUser');

            hideApp();
            showNotification('ƒê√£ ƒëƒÉng xu·∫•t!', 'info');
        }

        // ===== 2.9 Ki·ªÉm tra session =====
        function checkAuth() {
            // Ki·ªÉm tra c·∫£ localStorage v√† sessionStorage
            const savedUser = localStorage.getItem('currentUser') || sessionStorage.getItem('currentUser');

            if (savedUser) {
                currentUser = JSON.parse(savedUser);

                // Ki·ªÉm tra session timeout
                const loginTime = new Date(currentUser.loginTime).getTime();
                const now = Date.now();
                const timeoutMs = CONFIG.SESSION_TIMEOUT * 60 * 1000;

                if (now - loginTime > timeoutMs) {
                    // Session h·∫øt h·∫°n
                    handleLogout();
                    showNotification('Phi√™n ƒëƒÉng nh·∫≠p h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i!', 'warning');
                    return false;
                }

                return true;
            }

            return false;
        }

        // ===== 2.10 Hi·ªán/·∫®n m√†n h√¨nh =====
        function showApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('appContainer').classList.add('show');

            // C·∫≠p nh·∫≠t UI theo user
            updateUserUI();

            // Render menu theo quy·ªÅn
            renderSidebarMenu();

            // Render n·ªôi dung
            renderAll();
        }

        function hideApp() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('appContainer').classList.remove('show');

            // Reset form login
            document.getElementById('loginForm').reset();
            hideLoginError();
        }

        // ===== 2.11 C·∫≠p nh·∫≠t UI user =====
        function updateUserUI() {
            if (!currentUser) return;

            const avatar = currentUser.fullName.charAt(0).toUpperCase();
            document.getElementById('userAvatar').textContent = avatar;
            document.getElementById('userName').textContent = currentUser.fullName;
            document.getElementById('userRoleBadge').textContent = getRoleLabel(currentUser.role);
            document.getElementById('userMenuName').textContent = currentUser.fullName;
            document.getElementById('userMenuRole').textContent = getRoleLabel(currentUser.role);
        }

        function getRoleLabel(role) {
            const labels = { admin: 'Admin', manager: 'Manager', user: 'User' };
            return labels[role] || role;
        }

        // ===== 2.12 Hi·ªán/·∫®n l·ªói ƒëƒÉng nh·∫≠p =====
        function showLoginError(message) {
            const errorDiv = document.getElementById('loginError');
            document.getElementById('loginErrorText').textContent = message;
            errorDiv.classList.add('show');
        }

        function hideLoginError() {
            document.getElementById('loginError').classList.remove('show');
        }

        // ===== 2.13 Toggle hi·ªán password =====
        function togglePasswordVisibility() {
            const input = document.getElementById('loginPassword');
            const btn = document.querySelector('.password-toggle');
            if (input.type === 'password') {
                input.type = 'text';
                btn.textContent = 'üôà';
            } else {
                input.type = 'password';
                btn.textContent = 'üëÅÔ∏è';
            }
        }

        // ===== 2.14 Toggle password cho b·∫•t k·ª≥ input n√†o =====
        function togglePasswordField(inputId, btn) {
            const input = document.getElementById(inputId);
            if (!input) return;

            if (input.type === 'password') {
                input.type = 'text';
                btn.textContent = 'üôà';
            } else {
                input.type = 'password';
                btn.textContent = 'üëÅÔ∏è';
            }
        }

        /* ============================================================
           üîë PH·∫¶N 3: PERMISSIONS (Ph√¢n quy·ªÅn)
           ============================================================ */

        // ===== 3.1 Ki·ªÉm tra quy·ªÅn =====
        function hasPermission(tabId, action = 'view') {
            if (!currentUser) return false;

            const role = currentUser.role;
            const rolePermissions = permissions[role];

            if (!rolePermissions || !rolePermissions[tabId]) {
                // Fallback to default
                return DEFAULT_PERMISSIONS[role]?.[tabId]?.[action] || false;
            }

            return rolePermissions[tabId][action] || false;
        }

        // ===== 3.2 Ki·ªÉm tra c√≥ th·ªÉ xem tab =====
        function canViewTab(tabId) {
            return hasPermission(tabId, 'view');
        }

        // ===== 3.3 Ki·ªÉm tra c√≥ th·ªÉ t·∫°o =====
        function canCreate(tabId) {
            return hasPermission(tabId, 'create');
        }

        // ===== 3.4 Ki·ªÉm tra c√≥ th·ªÉ s·ª≠a =====
        function canEdit(tabId) {
            return hasPermission(tabId, 'edit');
        }

        // ===== 3.5 Ki·ªÉm tra c√≥ th·ªÉ x√≥a =====
        function canDelete(tabId) {
            return hasPermission(tabId, 'delete');
        }

        // ===== 3.6 Render sidebar menu theo quy·ªÅn =====
        function renderSidebarMenu() {
            const nav = document.getElementById('sidebarNav');
            let html = '';

            // L·ªçc menu items c√≥ quy·ªÅn xem
            const visibleItems = MENU_STRUCTURE.filter(item => {
                if (item.isGroup) {
                    // Group hi·ªÉn th·ªã n·∫øu c√≥ √≠t nh·∫•t 1 child visible
                    const children = MENU_STRUCTURE.filter(m => m.parent === item.id);
                    return children.some(child => canViewTab(child.id));
                }
                if (item.parent) {
                    // Child item
                    return canViewTab(item.id);
                }
                // Top-level item (kh√¥ng ph·∫£i group)
                return canViewTab(item.id);
            });

            // Render menu
            visibleItems.forEach(item => {
                if (item.isGroup) {
                    // Render group v·ªõi children
                    const children = MENU_STRUCTURE.filter(m => m.parent === item.id && canViewTab(m.id));
                    if (children.length > 0) {
                        html += `
                    <div class="nav-item">
                        <a class="nav-link has-submenu" onclick="toggleSubmenu(this)">
                            <span class="nav-icon">${item.icon}</span>
                            <span class="nav-text">${item.text}</span>
                            <span class="nav-arrow">‚ñ∂</span>
                        </a>
                        <div class="nav-submenu">
                            ${children.map(child => `
                                <a class="nav-link" data-tab="${child.id}" onclick="switchTab('${child.id}')">
                                    <span class="nav-text">${child.text}</span>
                                </a>
                            `).join('')}
                        </div>
                    </div>
                `;
                    }
                } else if (!item.parent) {
                    // Top-level item (kh√¥ng c√≥ parent)
                    html += `
                <div class="nav-item">
                    <a class="nav-link ${item.id === 'dashboard' ? 'active' : ''}" data-tab="${item.id}" onclick="switchTab('${item.id}')">
                        <span class="nav-icon">${item.icon}</span>
                        <span class="nav-text">${item.text}</span>
                    </a>
                </div>
            `;
                }
            });

            nav.innerHTML = html;
        }

        // ===== 3.7 ·∫®n/Hi·ªán n√∫t thao t√°c theo quy·ªÅn =====
        function updateActionButtons() {
            // Students actions
            const studentsActions = document.getElementById('studentsActions');
            if (studentsActions) {
                const addBtn = studentsActions.querySelector('.btn-success');
                if (addBtn) addBtn.style.display = canCreate('students') ? '' : 'none';
            }

            // Appointments actions
            const appointmentsActions = document.getElementById('appointmentsActions');
            if (appointmentsActions) {
                const addBtn = appointmentsActions.querySelector('.btn-success');
                if (addBtn) addBtn.style.display = canCreate('appointments') ? '' : 'none';
            }

            // Registrations actions
            const registrationsActions = document.getElementById('registrationsActions');
            if (registrationsActions) {
                const addBtn = registrationsActions.querySelector('.btn-success');
                if (addBtn) addBtn.style.display = canCreate('registrations') ? '' : 'none';
            }

            // Receipts actions
            const receiptsActions = document.getElementById('receiptsActions');
            if (receiptsActions) {
                const addBtn = receiptsActions.querySelector('.btn-success');
                if (addBtn) addBtn.style.display = canCreate('receipts') ? '' : 'none';
            }

            // Subjects, Packages, Promotions actions
            ['subjects', 'packages', 'promotions'].forEach(tab => {
                const actions = document.getElementById(`${tab}Actions`);
                if (actions) {
                    const addBtn = actions.querySelector('.btn-success');
                    if (addBtn) addBtn.style.display = canCreate(tab) ? '' : 'none';
                }
            });
        }

        // ===== 3.8 Render ma tr·∫≠n ph√¢n quy·ªÅn =====
        function renderPermissionMatrix() {
            const role = document.getElementById('permissionRoleSelect').value;
            const rolePerms = permissions[role] || DEFAULT_PERMISSIONS[role];

            const tabs = [
                { id: 'dashboard', name: 'üìä T·ªïng quan' },
                { id: 'students', name: 'üë©‚Äçüéì H·ªçc vi√™n' },
                { id: 'trial', name: 'üéì H·ªçc th·ª≠' },
                { id: 'appointments', name: 'üìÖ L·ªãch h·∫πn' },
                { id: 'registrations', name: 'üìã Phi·∫øu ƒêK' },
                { id: 'receipts', name: 'üßæ Bi√™n lai' },
                { id: 'debts', name: 'üí≥ C√¥ng n·ª£' },
                { id: 'teachers', name: 'üë®‚Äçüè´ Gi√°o vi√™n' },
                { id: 'classes', name: 'üìö L·ªõp h·ªçc' },
                { id: 'attendance', name: '‚úÖ ƒêi·ªÉm danh' },
                { id: 'subjects', name: 'üìñ M√¥n h·ªçc' },
                { id: 'packages', name: 'üì¶ G√≥i h·ªçc ph√≠' },
                { id: 'promotions', name: 'üéÅ Khuy·∫øn m√£i' },
                { id: 'reports', name: 'üìà B√°o c√°o' },
                { id: 'export', name: 'üì§ Xu·∫•t/Nh·∫≠p' },
                { id: 'users', name: 'üîê T√†i kho·∫£n' },
                { id: 'settings', name: '‚öôÔ∏è C√†i ƒë·∫∑t' }
            ];

            const html = `
        <table>
            <thead>
                <tr>
                    <th style="text-align: left;">Tab/Ch·ª©c nƒÉng</th>
                    <th>Xem</th>
                    <th>Th√™m</th>
                    <th>S·ª≠a</th>
                    <th>X√≥a</th>
                </tr>
            </thead>
            <tbody>
                ${tabs.map(tab => {
                const perms = rolePerms[tab.id] || { view: false, create: false, edit: false, delete: false };
                return `
                        <tr>
                            <td><span class="tab-name">${tab.name}</span></td>
                            <td><input type="checkbox" class="permission-checkbox" data-tab="${tab.id}" data-action="view" ${perms.view ? 'checked' : ''}></td>
                            <td><input type="checkbox" class="permission-checkbox" data-tab="${tab.id}" data-action="create" ${perms.create ? 'checked' : ''}></td>
                            <td><input type="checkbox" class="permission-checkbox" data-tab="${tab.id}" data-action="edit" ${perms.edit ? 'checked' : ''}></td>
                            <td><input type="checkbox" class="permission-checkbox" data-tab="${tab.id}" data-action="delete" ${perms.delete ? 'checked' : ''}></td>
                        </tr>
                    `;
            }).join('')}
            </tbody>
        </table>
    `;

            document.getElementById('permissionMatrix').innerHTML = html;
        }

        function loadPermissionsForRole() {
            renderPermissionMatrix();
        }

        // ===== 3.9 L∆∞u ph√¢n quy·ªÅn =====
        function savePermissions() {
            const role = document.getElementById('permissionRoleSelect').value;

            if (!permissions[role]) {
                permissions[role] = {};
            }

            const checkboxes = document.querySelectorAll('.permission-checkbox');
            checkboxes.forEach(cb => {
                const tab = cb.dataset.tab;
                const action = cb.dataset.action;

                if (!permissions[role][tab]) {
                    permissions[role][tab] = { view: false, create: false, edit: false, delete: false };
                }

                permissions[role][tab][action] = cb.checked;
            });

            saveData('permissions', permissions);
            showNotification(`ƒê√£ l∆∞u ph√¢n quy·ªÅn cho ${getRoleLabel(role)}!`, 'success');

            // N·∫øu ƒëang s·ª≠a quy·ªÅn c·ªßa ch√≠nh m√¨nh, c·∫≠p nh·∫≠t l·∫°i UI
            if (currentUser && currentUser.role === role) {
                renderSidebarMenu();
                updateActionButtons();
            }
        }

        // ===== 3.10 Reset v·ªÅ m·∫∑c ƒë·ªãnh =====
        function resetPermissions() {
            const role = document.getElementById('permissionRoleSelect').value;

            if (!confirm(`Reset quy·ªÅn c·ªßa ${getRoleLabel(role)} v·ªÅ m·∫∑c ƒë·ªãnh?`)) return;

            permissions[role] = JSON.parse(JSON.stringify(DEFAULT_PERMISSIONS[role]));
            saveData('permissions', permissions);

            renderPermissionMatrix();
            showNotification('ƒê√£ reset v·ªÅ m·∫∑c ƒë·ªãnh!', 'success');

            if (currentUser && currentUser.role === role) {
                renderSidebarMenu();
                updateActionButtons();
            }
        }

        /* ============================================================
           üë§ PH·∫¶N 4: QU·∫¢N L√ù T√ÄI KHO·∫¢N
           ============================================================ */

        // ===== 4.1 Render b·∫£ng users =====
        function renderUsersTable() {
            const tbody = document.getElementById('usersTableBody');

            if (users.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6"><div class="empty-state"><div class="empty-state-icon">üë§</div><p>Ch∆∞a c√≥ t√†i kho·∫£n</p></div></td></tr>`;
                return;
            }

            tbody.innerHTML = users.map(user => `
        <tr>
            <td><strong>${user.username}</strong></td>
            <td>${user.fullName}</td>
            <td><span class="role-badge ${user.role}">${getRoleLabel(user.role)}</span></td>
            <td><span class="status-badge ${user.status === 'active' ? 'active' : 'locked'}">${user.status === 'active' ? '‚úÖ Ho·∫°t ƒë·ªông' : 'üîí ƒê√£ kh√≥a'}</span></td>
            <td>${user.lastLogin ? formatDateTime(user.lastLogin) : '<span class="text-muted">Ch∆∞a ƒëƒÉng nh·∫≠p</span>'}</td>
            <td>
                <div class="action-buttons">
                    ${user.id !== currentUser.id ? `
                        <button class="action-btn edit" onclick="editUser('${user.id}')" title="S·ª≠a">‚úèÔ∏è</button>
                        <button class="action-btn key" onclick="openResetPasswordModal('${user.id}')" title="Reset m·∫≠t kh·∫©u">üîë</button>
                        ${user.status === 'active'
                        ? `<button class="action-btn lock" onclick="toggleUserStatus('${user.id}')" title="Kh√≥a">üîí</button>`
                        : `<button class="action-btn unlock" onclick="toggleUserStatus('${user.id}')" title="M·ªü kh√≥a">üîì</button>`
                    }
                        ${user.role !== 'admin' || users.filter(u => u.role === 'admin').length > 1
                        ? `<button class="action-btn delete" onclick="deleteUser('${user.id}')" title="X√≥a">üóëÔ∏è</button>`
                        : ''
                    }
                    ` : '<span class="text-muted">T√†i kho·∫£n hi·ªán t·∫°i</span>'}
                </div>
            </td>
        </tr>
    `).join('');
        }

        // ===== 4.2 M·ªü modal th√™m user =====
        function openUserModal() {
            document.getElementById('editUserId').value = '';
            document.getElementById('userForm').reset();
            document.getElementById('userModalTitle').textContent = 'üë§ Th√™m T√†i Kho·∫£n';
            document.getElementById('userPassword').required = true;
            document.getElementById('passwordGroup').style.display = 'block';
            openModal('userModal');
        }

        // ===== 4.3 S·ª≠a user =====
        function editUser(id) {
            const user = users.find(u => u.id === id);
            if (!user) return;

            document.getElementById('editUserId').value = user.id;
            document.getElementById('userUsername').value = user.username;
            document.getElementById('userFullName').value = user.fullName;
            document.getElementById('userRole').value = user.role;
            document.getElementById('userPassword').value = '';
            document.getElementById('userPassword').required = false;
            document.getElementById('passwordGroup').style.display = 'none'; // ·∫®n khi s·ª≠a
            document.getElementById('userModalTitle').textContent = '‚úèÔ∏è S·ª≠a T√†i Kho·∫£n';

            openModal('userModal');
        }

        // ===== 4.4 L∆∞u user (C·∫¨P NH·∫¨T B·∫¢O M·∫¨T) =====
        function saveUser(event) {
            event.preventDefault();

            const editId = document.getElementById('editUserId').value;
            const username = document.getElementById('userUsername').value.trim().toLowerCase();
            const password = document.getElementById('userPassword').value;
            const fullName = document.getElementById('userFullName').value.trim();
            const role = document.getElementById('userRole').value;

            // Ki·ªÉm tra username tr√πng
            const existing = users.find(u => u.username.toLowerCase() === username && u.id !== editId);
            if (existing) {
                showNotification('T√™n ƒëƒÉng nh·∫≠p ƒë√£ t·ªìn t·∫°i!', 'error');
                return;
            }

            if (editId) {
                // C·∫≠p nh·∫≠t user hi·ªán c√≥
                const index = users.findIndex(u => u.id === editId);
                if (index !== -1) {
                    users[index].username = username;
                    users[index].fullName = fullName;
                    users[index].role = role;
                    users[index].updatedAt = new Date().toISOString();
                    showNotification('C·∫≠p nh·∫≠t th√†nh c√¥ng!', 'success');
                }
            } else {
                // Th√™m user m·ªõi
                if (!password || password.length < 6) {
                    showNotification('M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±!', 'error');
                    return;
                }

                // T·∫°o salt v√† hash password m·ªõi
                const salt = generateSalt();
                const passwordHash = hashPasswordSecure(password, salt);

                users.push({
                    id: generateId(),
                    username,
                    passwordHash,
                    salt, // L∆∞u salt ri√™ng
                    fullName,
                    role,
                    status: 'active',
                    mustChangePassword: false,
                    createdAt: new Date().toISOString(),
                    lastLogin: null
                });
                showNotification('Th√™m t√†i kho·∫£n th√†nh c√¥ng!', 'success');
            }

            // L∆∞u v·ªõi m√£ h√≥a
            saveUsersEncrypted(users);
            closeModal('userModal');
            renderUsersTable();
        }


        // ===== 4.5 Kh√≥a/M·ªü kh√≥a user =====
        function toggleUserStatus(id) {
            const user = users.find(u => u.id === id);
            if (!user) return;

            const action = user.status === 'active' ? 'kh√≥a' : 'm·ªü kh√≥a';
            if (!confirm(`${action.charAt(0).toUpperCase() + action.slice(1)} t√†i kho·∫£n "${user.username}"?`)) return;

            user.status = user.status === 'active' ? 'locked' : 'active';
            saveData('users', users);
            renderUsersTable();
            showNotification(`ƒê√£ ${action} t√†i kho·∫£n!`, 'success');
        }

        // ===== 4.6 X√≥a user =====
        function deleteUser(id) {
            const user = users.find(u => u.id === id);
            if (!user) return;

            if (!confirm(`X√≥a t√†i kho·∫£n "${user.username}"?`)) return;

            users = users.filter(u => u.id !== id);
            saveData('users', users);
            renderUsersTable();
            showNotification('ƒê√£ x√≥a t√†i kho·∫£n!', 'success');
        }

        // ===== 4.7 Reset password =====
        function openResetPasswordModal(id) {
            const user = users.find(u => u.id === id);
            if (!user) return;

            document.getElementById('resetPasswordUserId').value = user.id;
            document.getElementById('resetPasswordUsername').textContent = user.username;
            document.getElementById('resetNewPassword').value = '';
            openModal('resetPasswordModal');
        }

        // ===== 4.7.1 X·ª≠ l√Ω Reset Password (C·∫¨P NH·∫¨T B·∫¢O M·∫¨T) =====
        function handleResetPassword(event) {
            event.preventDefault();

            const userId = document.getElementById('resetPasswordUserId').value;
            const newPassword = document.getElementById('resetNewPassword').value;

            if (newPassword.length < 6) {
                showNotification('M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±!', 'error');
                return;
            }

            const user = users.find(u => u.id === userId);
            if (user) {
                // T·∫°o salt m·ªõi v√† hash password
                const newSalt = generateSalt();
                user.salt = newSalt;
                user.passwordHash = hashPasswordSecure(newPassword, newSalt);
                user.mustChangePassword = true; // B·∫Øt bu·ªôc ƒë·ªïi l·∫°i sau khi reset
                user.passwordResetAt = new Date().toISOString();

                // L∆∞u v·ªõi m√£ h√≥a
                saveUsersEncrypted(users);

                closeModal('resetPasswordModal');
                showNotification('ƒê√£ reset m·∫≠t kh·∫©u! User s·∫Ω c·∫ßn ƒë·ªïi m·∫≠t kh·∫©u khi ƒëƒÉng nh·∫≠p.', 'success');
            }
        }

        // ===== 4.8 ƒê·ªïi m·∫≠t kh·∫©u (user t·ª± ƒë·ªïi) =====
        function openChangePasswordModal() {
            document.getElementById('changePasswordForm').reset();
            closeUserMenu();
            openModal('changePasswordModal');
        }

        // ===== 4.8 ƒê·ªïi m·∫≠t kh·∫©u (C·∫¨P NH·∫¨T B·∫¢O M·∫¨T) =====
        function handleChangePassword(event) {
            event.preventDefault();

            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            // T√¨m user hi·ªán t·∫°i
            const user = users.find(u => u.id === currentUser.id);
            if (!user) {
                showNotification('Kh√¥ng t√¨m th·∫•y th√¥ng tin ng∆∞·ªùi d√πng!', 'error');
                return;
            }

            // Ki·ªÉm tra m·∫≠t kh·∫©u hi·ªán t·∫°i
            if (!verifyPassword(currentPassword, user.passwordHash, user.salt)) {
                showNotification('M·∫≠t kh·∫©u hi·ªán t·∫°i kh√¥ng ƒë√∫ng!', 'error');
                return;
            }

            // Ki·ªÉm tra m·∫≠t kh·∫©u m·ªõi
            if (newPassword.length < 6) {
                showNotification('M·∫≠t kh·∫©u m·ªõi ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±!', 'error');
                return;
            }

            if (newPassword !== confirmPassword) {
                showNotification('X√°c nh·∫≠n m·∫≠t kh·∫©u kh√¥ng kh·ªõp!', 'error');
                return;
            }

            // T·∫°o salt m·ªõi v√† hash password m·ªõi
            const newSalt = generateSalt();
            user.salt = newSalt;
            user.passwordHash = hashPasswordSecure(newPassword, newSalt);
            user.mustChangePassword = false;
            user.passwordChangedAt = new Date().toISOString();

            // L∆∞u v·ªõi m√£ h√≥a
            saveUsersEncrypted(users);

            closeModal('changePasswordModal');
            showNotification('ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng!', 'success');
        }


        // ===== 4.9 M·ªü modal b·∫Øt bu·ªôc ƒë·ªïi m·∫≠t kh·∫©u =====
        function openForceChangePasswordModal() {
            document.getElementById('forceChangePasswordForm').reset();
            document.getElementById('forcePasswordError').style.display = 'none';

            // M·ªü modal (kh√¥ng cho ƒë√≥ng b·∫±ng click outside ho·∫∑c ESC)
            const modal = document.getElementById('forceChangePasswordModal');
            modal.classList.add('active');

            // Disable click outside to close
            modal.onclick = function (e) {
                if (e.target === modal) {
                    showNotification('Vui l√≤ng ƒë·ªïi m·∫≠t kh·∫©u ƒë·ªÉ ti·∫øp t·ª•c!', 'warning');
                }
            };
        }

        // ===== 4.10 X·ª≠ l√Ω ƒë·ªïi m·∫≠t kh·∫©u b·∫Øt bu·ªôc =====
        function handleForceChangePassword(event) {
            event.preventDefault();

            const newPassword = document.getElementById('forceNewPassword').value;
            const confirmPassword = document.getElementById('forceConfirmPassword').value;
            const errorDiv = document.getElementById('forcePasswordError');

            // ·∫®n l·ªói c≈©
            errorDiv.style.display = 'none';

            // Ki·ªÉm tra ƒë·ªô d√†i
            if (newPassword.length < 6) {
                errorDiv.textContent = 'M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±!';
                errorDiv.style.display = 'block';
                return;
            }

            // Ki·ªÉm tra kh·ªõp
            if (newPassword !== confirmPassword) {
                errorDiv.textContent = 'X√°c nh·∫≠n m·∫≠t kh·∫©u kh√¥ng kh·ªõp!';
                errorDiv.style.display = 'block';
                return;
            }

            // T√¨m user hi·ªán t·∫°i
            const user = users.find(u => u.id === currentUser.id);
            if (!user) {
                errorDiv.textContent = 'Kh√¥ng t√¨m th·∫•y th√¥ng tin ng∆∞·ªùi d√πng!';
                errorDiv.style.display = 'block';
                return;
            }

            // T·∫°o salt m·ªõi v√† hash password m·ªõi
            const newSalt = generateSalt();
            user.salt = newSalt;
            user.passwordHash = hashPasswordSecure(newPassword, newSalt);
            user.mustChangePassword = false;
            user.passwordChangedAt = new Date().toISOString();

            // L∆∞u users ƒë√£ m√£ h√≥a
            saveUsersEncrypted(users);

            // C·∫≠p nh·∫≠t session
            currentUser.needChangePassword = false;
            if (localStorage.getItem('currentUser')) {
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
            } else {
                sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
            }

            // ƒê√≥ng modal
            document.getElementById('forceChangePasswordModal').classList.remove('active');

            showNotification('‚úÖ ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng! H·ªá th·ªëng ƒë√£ ƒë∆∞·ª£c b·∫£o m·∫≠t.', 'success');
        }

        function openProfileModal() {
            closeUserMenu();
            showNotification('T√≠nh nƒÉng ƒëang ph√°t tri·ªÉn', 'info');
        }

        /* ============================================================
           üß≠ PH·∫¶N 5: NAVIGATION & UI
           ============================================================ */

        // ===== 5.1 Toggle Sidebar =====
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('collapsed');
        }

        // ===== 5.2 Toggle Submenu =====
        function toggleSubmenu(element) {
            const navItem = element.parentElement;
            const submenu = navItem.querySelector('.nav-submenu');
            const isExpanded = submenu.classList.contains('open');

            // ƒê√≥ng t·∫•t c·∫£ submenu kh√°c
            document.querySelectorAll('.nav-submenu.open').forEach(menu => {
                menu.classList.remove('open');
                menu.previousElementSibling.classList.remove('expanded');
            });

            // Toggle submenu hi·ªán t·∫°i
            if (!isExpanded) {
                submenu.classList.add('open');
                element.classList.add('expanded');
            }
        }

        // ===== 5.3 Toggle User Menu =====
        function toggleUserMenu() {
            document.getElementById('userMenu').classList.toggle('show');
        }

        function closeUserMenu() {
            document.getElementById('userMenu').classList.remove('show');
        }

        // ===== 5.4 Chuy·ªÉn Tab =====
        function switchTab(tabName) {
            // Ki·ªÉm tra quy·ªÅn
            if (!canViewTab(tabName)) {
                showNotification('B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p!', 'error');
                return;
            }

            // ·∫®n t·∫•t c·∫£ tab content
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            // B·ªè active t·∫•t c·∫£ nav-link
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));

            // Hi·ªán tab ƒë∆∞·ª£c ch·ªçn
            const tabContent = document.getElementById(tabName);
            if (tabContent) {
                tabContent.classList.add('active');
            }

            // Active nav-link t∆∞∆°ng ·ª©ng
            const navLink = document.querySelector(`.nav-link[data-tab="${tabName}"]`);
            if (navLink) {
                navLink.classList.add('active');

                // M·ªü submenu cha n·∫øu c√≥
                const submenu = navLink.closest('.nav-submenu');
                if (submenu) {
                    submenu.classList.add('open');
                    const parentLink = submenu.previousElementSibling;
                    if (parentLink) parentLink.classList.add('expanded');
                }
            }

            // C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ
            updatePageTitle(tabName);

            // Render n·ªôi dung
            renderTabContent(tabName);

            // C·∫≠p nh·∫≠t n√∫t thao t√°c theo quy·ªÅn
            updateActionButtons();
        }

        function updatePageTitle(tabName) {
            const menuItem = MENU_STRUCTURE.find(m => m.id === tabName);
            document.getElementById('pageTitle').textContent = menuItem ? `${menuItem.icon} ${menuItem.text}` : tabName;
        }

        function renderTabContent(tabName) {
            switch (tabName) {
                case 'dashboard': renderDashboard(); break;
                case 'students': renderStudentsTable(); updateStudentCounts(); break;
                case 'teachers': renderTeachersTable(); break;
                case 'classes': renderClassesTable(); populateClassFilters(); break;
                case 'attendance': initAttendanceTab(); break;
                case 'makeup': checkExpiredMakeupRequests(); renderMakeupRequests(); break;
                case 'trial': renderTrialStudentsTable(); updateTrialCounts(); break;
                case 'appointments': renderAppointmentsTable(); break;
                case 'registrations': renderRegistrationsTable(); break;
                case 'receipts': initReceiptFilters(); renderReceiptsTable(); break;
                case 'subjects': renderSubjectsTable(); break;
                case 'packages': renderPackagesTable(); break;
                case 'promotions': renderPromotionsTable(); break;
                case 'rooms': renderRoomsTable(); break;
                case 'users': renderUsersTable(); renderPermissionMatrix(); break;
                case 'export': renderBackupHistory(); break;
                case 'debts': renderDebtsTable(); break;
                case 'reports': initReportsTab(); break;
                case 'settings': loadCenterInfo(); loadBankInfo(); loadWarningSettings(); break;

                // X·ª≠ l√Ω ph√¢n trang cho c√°c tab con
                case 'attendanceHistory': loadAttendanceHistory(); break;
            }
        }


        // ===== 5.5 Click outside to close =====
        document.addEventListener('click', function (e) {
            // Close user menu
            if (!e.target.closest('.user-dropdown')) {
                closeUserMenu();
            }
        });

        /* ============================================================
           üîî PH·∫¶N 6: NOTIFICATIONS & MODALS
           ============================================================ */

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const icons = { success: '‚úÖ', error: '‚ùå', warning: '‚ö†Ô∏è', info: '‚ÑπÔ∏è' };
            notification.className = `notification ${type} show`;
            notification.innerHTML = `<span>${icons[type]}</span><span>${message}</span>`;
            setTimeout(() => notification.classList.remove('show'), 3000);
        }

        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        /* ============================================================
           üíæ PH·∫¶N 7: DATA HELPERS
           ============================================================ */

        function saveData(key, data) {
            // X·ª≠ l√Ω ri√™ng cho users (l∆∞u m√£ h√≥a)
            if (key === 'users') {
                saveUsersEncrypted(data);
                return;
            }

            // C√°c d·ªØ li·ªáu kh√°c l∆∞u b√¨nh th∆∞·ªùng (plain text)
            localStorage.setItem(key, JSON.stringify(data));

            if (autoBackupEnabled && !['loginAttempts', 'currentUser'].includes(key)) {
                createAutoBackup();
            }
        }


        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
        }

        function generateRegCode() {
            const date = new Date();
            const y = date.getFullYear().toString().slice(2);
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            const rand = Math.random().toString(36).substr(2, 4).toUpperCase();
            return `DK${y}${m}${d}-${rand}`;
        }

        /* ============================================================
           üìä PH·∫¶N 8: DASHBOARD
           ============================================================ */

        function renderDashboard() {
            renderDashboardStats();
            renderRevenueChart();
            renderUpcomingAppointments();

            // Th√™m c·∫£nh b√°o c√¥ng n·ª£
            const warningsHTML = renderDashboardWarnings();

            // T√¨m v·ªã tr√≠ ƒë·ªÉ ch√®n c·∫£nh b√°o (sau l·ªãch h·∫πn s·∫Øp t·ªõi)
            const dashboardContent = document.getElementById('dashboard');
            let existingWarningCard = dashboardContent.querySelector('.card.mt-20:last-child');

            // X√≥a c·∫£nh b√°o c≈© n·∫øu c√≥
            const oldWarning = dashboardContent.querySelector('.dashboard-warning-card');
            if (oldWarning) oldWarning.remove();

            if (warningsHTML) {
                const warningDiv = document.createElement('div');
                warningDiv.className = 'dashboard-warning-card';
                warningDiv.innerHTML = warningsHTML;
                dashboardContent.appendChild(warningDiv);
            }
        }


        function renderDashboardStats() {
            const stats = {
                total: students.length,
                hocThu: students.filter(s => s.status === 'H·ªçc Th·ª≠').length,
                choDangKy: students.filter(s => s.status === 'Ch·ªù ƒêƒÉng K√Ω').length,
                daDangKy: students.filter(s => s.status === 'ƒê√£ ƒêƒÉng K√Ω').length,
                hoanThanh: students.filter(s => s.status === 'Ho√†n Th√†nh').length,
                totalRevenue: receipts.reduce((sum, r) => sum + (parseFloat(r.amount) || 0), 0)
            };

            document.getElementById('dashboardStats').innerHTML = `
        <div class="stat-card"><div class="stat-icon teal">üìã</div><div class="stat-info"><h3>${stats.total}</h3><p>T·ªïng h·ªçc vi√™n</p></div></div>
        <div class="stat-card"><div class="stat-icon blue">üÜï</div><div class="stat-info"><h3>${stats.hocThu}</h3><p>H·ªçc th·ª≠</p></div></div>
        <div class="stat-card"><div class="stat-icon orange">‚è≥</div><div class="stat-info"><h3>${stats.choDangKy}</h3><p>Ch·ªù ƒëƒÉng k√Ω</p></div></div>
        <div class="stat-card"><div class="stat-icon green">‚úÖ</div><div class="stat-info"><h3>${stats.daDangKy}</h3><p>ƒê√£ ƒëƒÉng k√Ω</p></div></div>
        <div class="stat-card"><div class="stat-icon purple">üéì</div><div class="stat-info"><h3>${stats.hoanThanh}</h3><p>Ho√†n th√†nh</p></div></div>
        <div class="stat-card"><div class="stat-icon teal">üí∞</div><div class="stat-info"><h3>${formatCurrencyShort(stats.totalRevenue)}</h3><p>Doanh thu</p></div></div>
    `;
        }

        function renderRevenueChart() {
            const months = [];
            const now = new Date();
            for (let i = 5; i >= 0; i--) {
                const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                months.push({ key: `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`, label: `T${d.getMonth() + 1}` });
            }

            const monthlyRevenue = {};
            months.forEach(m => monthlyRevenue[m.key] = 0);
            receipts.forEach(r => {
                const month = r.date?.substring(0, 7);
                if (monthlyRevenue[month] !== undefined) monthlyRevenue[month] += parseFloat(r.amount) || 0;
            });

            const maxRevenue = Math.max(...Object.values(monthlyRevenue), 1);
            document.getElementById('revenueChart').innerHTML = months.map(m => {
                const revenue = monthlyRevenue[m.key];
                const height = (revenue / maxRevenue) * 100;
                return `<div class="chart-bar-wrapper"><div class="chart-bar" style="height:${Math.max(height, 5)}%;"><span class="chart-bar-value">${formatCurrencyShort(revenue)}</span></div><span class="chart-bar-label">${m.label}</span></div>`;
            }).join('');
        }

        function renderUpcomingAppointments() {
            const now = new Date();
            const upcoming = appointments.filter(a => new Date(a.date + ' ' + a.time) >= now)
                .sort((a, b) => new Date(a.date + ' ' + a.time) - new Date(b.date + ' ' + b.time)).slice(0, 5);

            document.getElementById('upcomingAppointments').innerHTML = upcoming.length === 0
                ? '<div class="empty-state"><p class="text-muted">Ch∆∞a c√≥ l·ªãch h·∫πn s·∫Øp t·ªõi</p></div>'
                : upcoming.map(apt => {
                    const student = students.find(s => s.id === apt.studentId);
                    return `<div class="upcoming-item"><strong>${student?.name || 'N/A'}</strong> - ${apt.subject}<br>üìÖ ${formatDate(apt.date)} l√∫c ${apt.time}</div>`;
                }).join('');
        }

        /* ============================================================
           üë©‚Äçüéì PH·∫¶N 9: QU·∫¢N L√ù H·ªåC VI√äN
           ============================================================ */

        function renderSubjectCheckboxes() {
            document.getElementById('subjectCheckboxes').innerHTML = subjects.map(sub =>
                `<label class="checkbox-item"><input type="checkbox" name="studentSubjects" value="${sub.name}"> ${sub.icon} ${sub.name}</label>`
            ).join('');
        }

        function toggleStudentForm() {
            const form = document.getElementById('studentFormSection');
            form.classList.toggle('show');
            if (form.classList.contains('show')) {
                resetStudentForm();
            }
        }

        function resetStudentForm() {
            document.getElementById('studentForm').reset();
            document.getElementById('editStudentId').value = '';
            document.getElementById('studentStatus').value = 'H·ªçc Th·ª≠';
            document.getElementById('studentFormTitle').textContent = '‚ûï Th√™m H·ªçc Vi√™n M·ªõi';
            document.getElementById('saveStudentBtn').textContent = 'üíæ L∆∞u H·ªçc Vi√™n';
            document.querySelectorAll('input[name="studentSubjects"]').forEach(cb => cb.checked = false);
        }

        function saveStudent(event) {
            event.preventDefault();

            if (!canCreate('students') && !document.getElementById('editStudentId').value) {
                showNotification('B·∫°n kh√¥ng c√≥ quy·ªÅn th√™m h·ªçc vi√™n!', 'error');
                return;
            }

            const selectedSubjects = Array.from(document.querySelectorAll('input[name="studentSubjects"]:checked')).map(cb => cb.value);
            if (selectedSubjects.length === 0) { showNotification('Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 m√¥n h·ªçc!', 'error'); return; }

            const editId = document.getElementById('editStudentId').value;
            const studentData = {
                name: document.getElementById('studentName').value.trim(),
                age: parseInt(document.getElementById('studentAge').value),
                parentName: document.getElementById('parentName').value.trim(),
                parentPhone: document.getElementById('parentPhone').value.trim(),
                parentEmail: document.getElementById('parentEmail').value.trim(),
                status: document.getElementById('studentStatus').value,
                subjects: selectedSubjects,
                notes: document.getElementById('studentNotes').value.trim()
            };

            if (editId) {
                if (!canEdit('students')) {
                    showNotification('B·∫°n kh√¥ng c√≥ quy·ªÅn s·ª≠a!', 'error');
                    return;
                }
                const index = students.findIndex(s => s.id === editId);
                if (index !== -1) {
                    students[index] = { ...students[index], ...studentData, updatedAt: new Date().toISOString() };
                    showNotification('C·∫≠p nh·∫≠t th√†nh c√¥ng!');
                }
            } else {
                students.push({ id: generateId(), ...studentData, previousStatus: null, createdAt: new Date().toISOString(), updatedAt: new Date().toISOString() });
                showNotification('Th√™m h·ªçc vi√™n th√†nh c√¥ng!');
            }

            saveData('students', students);
            document.getElementById('studentFormSection').classList.remove('show');
            resetStudentForm();
            renderStudentsTable();
            updateStudentCounts();
        }

        function editStudent(id) {
            if (!canEdit('students')) {
                showNotification('B·∫°n kh√¥ng c√≥ quy·ªÅn s·ª≠a!', 'error');
                return;
            }

            const student = students.find(s => s.id === id);
            if (!student) return;

            document.getElementById('editStudentId').value = student.id;
            document.getElementById('studentName').value = student.name;
            document.getElementById('studentAge').value = student.age;
            document.getElementById('parentName').value = student.parentName;
            document.getElementById('parentPhone').value = student.parentPhone;
            document.getElementById('parentEmail').value = student.parentEmail || '';
            document.getElementById('studentStatus').value = student.status;
            document.getElementById('studentNotes').value = student.notes || '';
            document.querySelectorAll('input[name="studentSubjects"]').forEach(cb => cb.checked = student.subjects.includes(cb.value));

            document.getElementById('studentFormTitle').textContent = '‚úèÔ∏è S·ª≠a H·ªçc Vi√™n';
            document.getElementById('saveStudentBtn').textContent = 'üíæ C·∫≠p Nh·∫≠t';
            document.getElementById('studentFormSection').classList.add('show');
        }

        function deleteStudent(id) {
            if (!canDelete('students')) {
                showNotification('B·∫°n kh√¥ng c√≥ quy·ªÅn x√≥a!', 'error');
                return;
            }

            const student = students.find(s => s.id === id);
            if (!student || !confirm(`X√≥a "${student.name}"?`)) return;

            students = students.filter(s => s.id !== id);
            appointments = appointments.filter(a => a.studentId !== id);
            registrations = registrations.filter(r => r.studentId !== id);
            receipts = receipts.filter(r => r.studentId !== id);

            saveData('students', students);
            saveData('appointments', appointments);
            saveData('registrations', registrations);
            saveData('receipts', receipts);

            showNotification('ƒê√£ x√≥a!');
            renderAll();
        }

        function updateStudentCounts() {
            document.getElementById('countAll').textContent = students.length;
            document.getElementById('countHocThu').textContent = students.filter(s => s.status === 'H·ªçc Th·ª≠').length;
            document.getElementById('countChoDangKy').textContent = students.filter(s => s.status === 'Ch·ªù ƒêƒÉng K√Ω').length;
            document.getElementById('countDaDangKy').textContent = students.filter(s => s.status === 'ƒê√£ ƒêƒÉng K√Ω').length;
            document.getElementById('countHoanThanh').textContent = students.filter(s => s.status === 'Ho√†n Th√†nh').length;
            document.getElementById('countCancel').textContent = students.filter(s => s.status === 'Cancel').length;
        }

        function filterStudents(status) {
            currentFilter = status;
            paginationState.students.page = 1;
            document.querySelectorAll('#students .filter-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.filter === status));
            renderStudentsTable();
        }

        function searchStudents() {
            paginationState.students.page = 1;
            renderStudentsTable();
        }

        function getFilteredStudents() {
            const searchTerm = document.getElementById('searchStudent')?.value?.toLowerCase() || '';
            let filtered = students;
            if (currentFilter !== 'all') filtered = filtered.filter(s => s.status === currentFilter);
            if (searchTerm) filtered = filtered.filter(s => s.name.toLowerCase().includes(searchTerm) || s.parentName.toLowerCase().includes(searchTerm) || s.parentPhone.includes(searchTerm));
            return filtered;
        }

        function renderStudentsTable() {
            const filtered = getFilteredStudents();
            const { data, total, totalPages, currentPage } = getPaginatedData(filtered, 'students');
            const tbody = document.getElementById('studentsTableBody');

            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7"><div class="empty-state"><div class="empty-state-icon">üìã</div><p>Kh√¥ng c√≥ d·ªØ li·ªáu</p></div></td></tr>`;
                renderPagination('studentsPagination', 'students', 0, 0, 1);
                return;
            }

            tbody.innerHTML = data.map(s => `
        <tr>
            <td><strong>${s.name}</strong></td>
            <td>${s.age}</td>
            <td>${s.parentName}</td>
            <td>${s.parentPhone}</td>
            <td>${s.subjects.map(sub => `<span class="subject-tag">${sub}</span>`).join('')}</td>
            <td>${getStatusBadge(s.status)}</td>
            <td><div class="action-buttons">${getStudentActionButtons(s)}</div></td>
        </tr>
    `).join('');

            renderPagination('studentsPagination', 'students', total, totalPages, currentPage);
        }

        function getStatusBadge(status) {
            const badges = {
                'H·ªçc Th·ª≠': '<span class="status-badge hoc-thu">üÜï H·ªçc Th·ª≠</span>',
                'Ch·ªù ƒêƒÉng K√Ω': '<span class="status-badge cho-dk">‚è≥ Ch·ªù ƒêK</span>',
                'ƒê√£ ƒêƒÉng K√Ω': '<span class="status-badge da-dk">‚úÖ ƒê√£ ƒêK</span>',
                'Ho√†n Th√†nh': '<span class="status-badge hoan-thanh">üéì Ho√†n Th√†nh</span>',
                'Cancel': '<span class="status-badge cancel">‚ùå Cancel</span>'
            };
            return badges[status] || status;
        }

        function getStudentActionButtons(student) {
            const id = student.id;
            let btns = [`<button class="action-btn view" onclick="viewStudent('${id}')" title="Xem">üëÅÔ∏è</button>`];

            if (canEdit('students')) {
                btns.push(`<button class="action-btn edit" onclick="editStudent('${id}')" title="S·ª≠a">‚úèÔ∏è</button>`);
            }

            if (student.status === 'H·ªçc Th·ª≠' && canCreate('appointments')) {
                btns.push(`<button class="action-btn schedule" onclick="openAppointmentModalForStudent('${id}')" title="ƒê·∫∑t l·ªãch">üìÖ</button>`);
            }

            if (student.status === 'Ch·ªù ƒêƒÉng K√Ω' && canCreate('registrations')) {
                btns.push(`<button class="action-btn receipt" onclick="openRegistrationModalForStudent('${id}')" title="T·∫°o Phi·∫øu ƒêK">üìã</button>`);
            }

            if (student.status === 'ƒê√£ ƒêƒÉng K√Ω' && canCreate('receipts')) {
                btns.push(`<button class="action-btn receipt" onclick="openReceiptModalForStudent('${id}')" title="T·∫°o Bi√™n Lai">üßæ</button>`);
            }

            if (canDelete('students')) {
                btns.push(`<button class="action-btn delete" onclick="deleteStudent('${id}')" title="X√≥a">üóëÔ∏è</button>`);
            }

            return btns.join('');
        }

        function viewStudent(id) {
            const student = students.find(s => s.id === id);
            if (!student) return;

            const studentAppointments = appointments.filter(a => a.studentId === id);
            const studentRegistrations = registrations.filter(r => r.studentId === id);
            const studentReceipts = receipts.filter(r => r.studentId === id);

            document.getElementById('quickViewContent').innerHTML = `
        <div class="quick-view-section">
            <h4>üë§ Th√¥ng Tin H·ªçc Vi√™n</h4>
            <div class="quick-view-row"><span class="quick-view-label">T√™n:</span><span class="quick-view-value"><strong>${student.name}</strong></span></div>
            <div class="quick-view-row"><span class="quick-view-label">Tu·ªïi:</span><span class="quick-view-value">${student.age}</span></div>
            <div class="quick-view-row"><span class="quick-view-label">Ph·ª• huynh:</span><span class="quick-view-value">${student.parentName}</span></div>
            <div class="quick-view-row"><span class="quick-view-label">SƒêT:</span><span class="quick-view-value">${student.parentPhone}</span></div>
            <div class="quick-view-row"><span class="quick-view-label">M√¥n h·ªçc:</span><span class="quick-view-value">${student.subjects.map(s => `<span class="subject-tag">${s}</span>`).join('')}</span></div>
            <div class="quick-view-row"><span class="quick-view-label">Tr·∫°ng th√°i:</span><span class="quick-view-value">${getStatusBadge(student.status)}</span></div>
        </div>
        <div class="quick-view-section">
            <h4>üìÖ L·ªãch H·∫πn (${studentAppointments.length})</h4>
            ${studentAppointments.length === 0 ? '<p class="text-muted">Ch∆∞a c√≥</p>' : studentAppointments.map(a => `<div class="quick-view-row"><span class="quick-view-label">${formatDate(a.date)} ${a.time}</span><span class="quick-view-value">${a.subject}</span></div>`).join('')}
        </div>
        <div class="quick-view-section">
            <h4>üìã Phi·∫øu ƒêK (${studentRegistrations.length})</h4>
            ${studentRegistrations.length === 0 ? '<p class="text-muted">Ch∆∞a c√≥</p>' : studentRegistrations.map(r => `<div class="quick-view-row"><span class="quick-view-label">${r.regCode}</span><span class="quick-view-value">${formatCurrency(r.finalAmount)}</span></div>`).join('')}
        </div>
        <div class="quick-view-section">
            <h4>üßæ Bi√™n Lai (${studentReceipts.length})</h4>
            ${studentReceipts.length === 0 ? '<p class="text-muted">Ch∆∞a c√≥</p>' : studentReceipts.map(r => `<div class="quick-view-row"><span class="quick-view-label">${formatDate(r.date)}</span><span class="quick-view-value">${formatCurrency(r.amount)}</span></div>`).join('')}
        </div>
    `;
            openModal('quickViewModal');
        }

        function cancelStudent(id) {
            const student = students.find(s => s.id === id);
            if (!student || !confirm(`Cancel "${student.name}"?`)) return;
            student.previousStatus = student.status;
            student.status = 'Cancel';
            saveData('students', students);
            showNotification('ƒê√£ cancel!', 'warning');
            renderAll();
        }

        function restoreStudent(id) {
            const student = students.find(s => s.id === id);
            if (!student || !student.previousStatus) return;
            if (!confirm(`Kh√¥i ph·ª•c "${student.name}"?`)) return;
            student.status = student.previousStatus;
            student.previousStatus = null;
            saveData('students', students);
            showNotification('ƒê√£ kh√¥i ph·ª•c!');
            renderAll();
        }

        function confirmTrialCompleted(id) {
            const student = students.find(s => s.id === id);
            if (!student || student.status !== 'H·ªçc Th·ª≠') return;
            if (!confirm(`X√°c nh·∫≠n "${student.name}" ƒë√£ h·ªçc th·ª≠ xong?`)) return;
            student.status = 'Ch·ªù ƒêƒÉng K√Ω';
            saveData('students', students);
            showNotification('ƒê√£ chuy·ªÉn sang Ch·ªù ƒêƒÉng K√Ω!');
            renderAll();
        }

        /* ============================================================
           üéì PH·∫¶N 10: H·ªåC TH·ª¨
           ============================================================ */

        function updateTrialCounts() {
            const trial = students.filter(s => s.status === 'H·ªçc Th·ª≠' || s.status === 'Ch·ªù ƒêƒÉng K√Ω');
            document.getElementById('trialCountAll').textContent = trial.length;
            document.getElementById('trialCountHocThu').textContent = students.filter(s => s.status === 'H·ªçc Th·ª≠').length;
            document.getElementById('trialCountChoDangKy').textContent = students.filter(s => s.status === 'Ch·ªù ƒêƒÉng K√Ω').length;
        }

        function filterTrialStudents(status) {
            currentTrialFilter = status;
            paginationState.trial.page = 1;
            document.querySelectorAll('#trial .filter-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.filter === status));
            renderTrialStudentsTable();
        }

        function searchTrialStudents() {
            paginationState.trial.page = 1;
            renderTrialStudentsTable();
        }

        function getFilteredTrialStudents() {
            const searchTerm = document.getElementById('searchTrialStudent')?.value?.toLowerCase() || '';
            let filtered = students.filter(s => s.status === 'H·ªçc Th·ª≠' || s.status === 'Ch·ªù ƒêƒÉng K√Ω');
            if (currentTrialFilter !== 'all') filtered = filtered.filter(s => s.status === currentTrialFilter);
            if (searchTerm) filtered = filtered.filter(s => s.name.toLowerCase().includes(searchTerm) || s.parentPhone.includes(searchTerm));
            return filtered;
        }

        function renderTrialStudentsTable() {
            const filtered = getFilteredTrialStudents();
            const { data, total, totalPages, currentPage } = getPaginatedData(filtered, 'trial');
            const tbody = document.getElementById('trialStudentsTableBody');

            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8"><div class="empty-state"><div class="empty-state-icon">üéì</div><p>Kh√¥ng c√≥ d·ªØ li·ªáu</p></div></td></tr>`;
                renderPagination('trialPagination', 'trial', 0, 0, 1);
                return;
            }

            tbody.innerHTML = data.map(s => {
                const apt = appointments.find(a => a.studentId === s.id && new Date(a.date + ' ' + a.time) >= new Date());
                return `
            <tr>
                <td><strong>${s.name}</strong></td>
                <td>${s.age}</td>
                <td>${s.parentName}</td>
                <td>${s.parentPhone}</td>
                <td>${s.subjects.map(sub => `<span class="subject-tag">${sub}</span>`).join('')}</td>
                <td>${getStatusBadge(s.status)}</td>
                <td>${apt ? `<span class="text-success">${formatDate(apt.date)} ${apt.time}</span>` : '<span class="text-muted">-</span>'}</td>
                <td><div class="action-buttons">${getTrialActionButtons(s)}</div></td>
            </tr>
        `;
            }).join('');

            renderPagination('trialPagination', 'trial', total, totalPages, currentPage);
        }

        function getTrialActionButtons(student) {
            const id = student.id;
            let btns = [`<button class="action-btn view" onclick="viewStudent('${id}')" title="Xem">üëÅÔ∏è</button>`];

            if (student.status === 'H·ªçc Th·ª≠') {
                if (canCreate('appointments')) {
                    btns.push(`<button class="action-btn schedule" onclick="openAppointmentModalForStudent('${id}')" title="ƒê·∫∑t l·ªãch">üìÖ</button>`);
                }
                if (canEdit('trial')) {
                    btns.push(`<button class="action-btn edit" onclick="confirmTrialCompleted('${id}')" title="X√°c nh·∫≠n HT">‚úÖ</button>`);
                }
            } else if (student.status === 'Ch·ªù ƒêƒÉng K√Ω') {
                if (canCreate('registrations')) {
                    btns.push(`<button class="action-btn receipt" onclick="openRegistrationModalForStudent('${id}')" title="T·∫°o Phi·∫øu ƒêK">üìã</button>`);
                }
            }
            return btns.join('');
        }

        /* ============================================================
           üìÖ PH·∫¶N 11: L·ªäCH H·∫∏N (T√≥m t·∫Øt - gi·ªØ nguy√™n logic c≈©)
           ============================================================ */

        function openNewAppointmentModal() {
            document.getElementById('editAppointmentId').value = '';
            document.getElementById('appointmentStudentId').value = '';
            document.getElementById('appointmentForm').reset();
            document.getElementById('appointmentModalTitle').textContent = 'üìÖ Th√™m L·ªãch H·∫πn';
            document.getElementById('appointmentDate').min = new Date().toISOString().split('T')[0];
            populateAppointmentStudentDropdown();
            openModal('appointmentModal');
        }

        function openAppointmentModalForStudent(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;

            document.getElementById('editAppointmentId').value = '';
            document.getElementById('appointmentStudentId').value = studentId;
            document.getElementById('appointmentForm').reset();
            document.getElementById('appointmentModalTitle').textContent = 'üìÖ ƒê·∫∑t L·ªãch H·∫πn';
            document.getElementById('appointmentDate').min = new Date().toISOString().split('T')[0];

            populateAppointmentStudentDropdown();
            document.getElementById('appointmentStudentSelect').value = studentId;
            onAppointmentStudentChange();
            openModal('appointmentModal');
        }

        function populateAppointmentStudentDropdown() {
            const eligible = students.filter(s => s.status === 'H·ªçc Th·ª≠' || s.status === 'Ch·ªù ƒêƒÉng K√Ω');
            document.getElementById('appointmentStudentSelect').innerHTML = '<option value="">-- Ch·ªçn h·ªçc vi√™n --</option>' +
                eligible.map(s => `<option value="${s.id}">${s.name} - ${s.parentPhone}</option>`).join('');
        }

        /* ============================================================
        üìÖ TASK 2.4: S·ª¨A BUG C·∫¢NH B√ÅO TR√ôNG L·ªäCH H·∫∏N
        ============================================================ */

        // H√†m ki·ªÉm tra tr√πng l·ªãch h·∫πn
        function checkAppointmentConflict(studentId, date, time, excludeId = null) {
            if (!studentId || !date || !time) return null;

            // T√¨m c√°c l·ªãch h·∫πn c·ªßa h·ªçc vi√™n n√†y
            const studentAppointments = appointments.filter(a =>
                a.studentId === studentId &&
                a.id !== excludeId
            );

            // Ki·ªÉm tra tr√πng ng√†y
            const sameDateAppointments = studentAppointments.filter(a => a.date === date);

            if (sameDateAppointments.length > 0) {
                // Ki·ªÉm tra tr√πng gi·ªù (trong kho·∫£ng 2 ti·∫øng)
                const inputTime = time.split(':').map(Number);
                const inputMinutes = inputTime[0] * 60 + inputTime[1];

                for (const apt of sameDateAppointments) {
                    const aptTime = apt.time.split(':').map(Number);
                    const aptMinutes = aptTime[0] * 60 + aptTime[1];

                    // N·∫øu c√°ch nhau d∆∞·ªõi 2 ti·∫øng ‚Üí c·∫£nh b√°o
                    if (Math.abs(inputMinutes - aptMinutes) < 120) {
                        return {
                            type: 'same_day',
                            appointment: apt,
                            message: `‚ö†Ô∏è H·ªçc vi√™n n√†y ƒë√£ c√≥ l·ªãch h·∫πn v√†o ${formatDate(apt.date)} l√∫c ${apt.time} (${apt.subject})`
                        };
                    }
                }

                // C√πng ng√†y nh∆∞ng kh√°c gi·ªù xa
                return {
                    type: 'same_day_different_time',
                    appointment: sameDateAppointments[0],
                    message: `‚ÑπÔ∏è H·ªçc vi√™n n√†y ƒë√£ c√≥ l·ªãch h·∫πn kh√°c v√†o ng√†y ${formatDate(date)}`
                };
            }

            return null;
        }

        // H√†m hi·ªÉn th·ªã c·∫£nh b√°o tr√πng l·ªãch
        function showAppointmentConflictWarning() {
            const studentId = document.getElementById('appointmentStudentId').value ||
                document.getElementById('appointmentStudentSelect').value;
            const date = document.getElementById('appointmentDate').value;
            const time = document.getElementById('appointmentTime').value;
            const editId = document.getElementById('editAppointmentId').value;

            const warningDiv = document.getElementById('appointmentConflictWarning');

            const conflict = checkAppointmentConflict(studentId, date, time, editId);

            if (conflict) {
                warningDiv.innerHTML = `
                    <span style="font-size: 14px;">${conflict.message}</span>
                    <br><small class="text-muted">B·∫°n v·∫´n c√≥ th·ªÉ l∆∞u l·ªãch h·∫πn n√†y.</small>
                `;
                warningDiv.classList.remove('d-none');

                // ƒê·ªïi m√†u theo m·ª©c ƒë·ªô
                if (conflict.type === 'same_day') {
                    warningDiv.style.borderLeftColor = '#E74C3C';
                    warningDiv.style.background = '#FDEDEC';
                } else {
                    warningDiv.style.borderLeftColor = '#F39C12';
                    warningDiv.style.background = '#FEF5E7';
                }
            } else {
                warningDiv.classList.add('d-none');
            }
        }

        // C·∫≠p nh·∫≠t h√†m onAppointmentStudentChange
        function onAppointmentStudentChange() {
            const studentId = document.getElementById('appointmentStudentSelect').value;
            const student = students.find(s => s.id === studentId);
            document.getElementById('appointmentStudentId').value = studentId;

            if (student) {
                document.getElementById('appointmentSubject').innerHTML = '<option value="">-- Ch·ªçn m√¥n --</option>' +
                    student.subjects.map(s => `<option value="${s}">${s}</option>`).join('');
            }

            // Ki·ªÉm tra tr√πng l·ªãch
            showAppointmentConflictWarning();
        }

        // Th√™m event listeners cho date v√† time
        document.addEventListener('DOMContentLoaded', function () {
            const dateInput = document.getElementById('appointmentDate');
            const timeInput = document.getElementById('appointmentTime');

            if (dateInput) {
                dateInput.addEventListener('change', showAppointmentConflictWarning);
            }
            if (timeInput) {
                timeInput.addEventListener('change', showAppointmentConflictWarning);
            }
        });


        function saveAppointment(event) {
            event.preventDefault();

            const studentId = document.getElementById('appointmentStudentId').value;
            if (!studentId) { showNotification('Vui l√≤ng ch·ªçn h·ªçc vi√™n!', 'error'); return; }

            const editId = document.getElementById('editAppointmentId').value;
            const data = {
                studentId,
                subject: document.getElementById('appointmentSubject').value,
                date: document.getElementById('appointmentDate').value,
                time: document.getElementById('appointmentTime').value,
                notes: document.getElementById('appointmentNotes').value.trim()
            };

            if (editId) {
                const index = appointments.findIndex(a => a.id === editId);
                if (index !== -1) appointments[index] = { ...appointments[index], ...data };
                showNotification('C·∫≠p nh·∫≠t th√†nh c√¥ng!');
            } else {
                appointments.push({ id: generateId(), ...data, createdAt: new Date().toISOString() });
                showNotification('Th√™m l·ªãch h·∫πn th√†nh c√¥ng!');
            }

            saveData('appointments', appointments);
            closeModal('appointmentModal');
            renderAll();
        }

        function filterAppointments(filter) {
            currentAppointmentFilter = filter;
            paginationState.appointments.page = 1;
            document.querySelectorAll('#appointments .filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderAppointmentsTable();
        }

        function searchAppointments() {
            paginationState.appointments.page = 1;
            renderAppointmentsTable();
        }

        function getFilteredAppointments() {
            const searchTerm = document.getElementById('searchAppointment')?.value?.toLowerCase() || '';
            const now = new Date();
            let filtered = [...appointments];

            if (currentAppointmentFilter === 'upcoming') filtered = filtered.filter(a => new Date(a.date + ' ' + a.time) >= now);
            else if (currentAppointmentFilter === 'past') filtered = filtered.filter(a => new Date(a.date + ' ' + a.time) < now);

            if (searchTerm) {
                filtered = filtered.filter(a => {
                    const student = students.find(s => s.id === a.studentId);
                    return a.subject.toLowerCase().includes(searchTerm) || student?.name.toLowerCase().includes(searchTerm);
                });
            }
            return filtered.sort((a, b) => new Date(b.date + ' ' + b.time) - new Date(a.date + ' ' + a.time));
        }

        function renderAppointmentsTable() {
            const filtered = getFilteredAppointments();
            const { data, total, totalPages, currentPage } = getPaginatedData(filtered, 'appointments');
            const tbody = document.getElementById('appointmentsTableBody');
            const now = new Date();

            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8"><div class="empty-state"><div class="empty-state-icon">üìÖ</div><p>Kh√¥ng c√≥ l·ªãch h·∫πn</p></div></td></tr>`;
                renderPagination('appointmentsPagination', 'appointments', 0, 0, 1);
                return;
            }

            tbody.innerHTML = data.map(a => {
                const student = students.find(s => s.id === a.studentId);
                const isPast = new Date(a.date + ' ' + a.time) < now;
                return `
            <tr style="${isPast ? 'opacity: 0.6;' : ''}">
                <td><strong>${student?.name || 'N/A'}</strong></td>
                <td>${student?.parentName || ''}</td>
                <td>${student?.parentPhone || ''}</td>
                <td><span class="subject-tag">${a.subject}</span></td>
                <td>${formatDate(a.date)}</td>
                <td><strong>${a.time}</strong></td>
                <td>${isPast ? '<span class="text-muted">ƒê√£ qua</span>' : '<span class="text-success">S·∫Øp t·ªõi</span>'}</td>
                <td>
                    <div class="action-buttons">
                        ${canEdit('appointments') ? `<button class="action-btn edit" onclick="editAppointment('${a.id}')" title="S·ª≠a">‚úèÔ∏è</button>` : ''}
                        ${canDelete('appointments') ? `<button class="action-btn delete" onclick="deleteAppointment('${a.id}')" title="X√≥a">üóëÔ∏è</button>` : ''}
                    </div>
                </td>
            </tr>
        `;
            }).join('');

            renderPagination('appointmentsPagination', 'appointments', total, totalPages, currentPage);
        }

        function editAppointment(id) {
            const apt = appointments.find(a => a.id === id);
            if (!apt) return;
            const student = students.find(s => s.id === apt.studentId);

            document.getElementById('editAppointmentId').value = apt.id;
            document.getElementById('appointmentStudentId').value = apt.studentId;
            populateAppointmentStudentDropdown();
            document.getElementById('appointmentStudentSelect').value = apt.studentId;

            if (student) {
                document.getElementById('appointmentSubject').innerHTML = '<option value="">-- Ch·ªçn m√¥n --</option>' +
                    student.subjects.map(s => `<option value="${s}" ${s === apt.subject ? 'selected' : ''}>${s}</option>`).join('');
            }

            document.getElementById('appointmentDate').value = apt.date;
            document.getElementById('appointmentTime').value = apt.time;
            document.getElementById('appointmentNotes').value = apt.notes || '';
            document.getElementById('appointmentModalTitle').textContent = '‚úèÔ∏è S·ª≠a L·ªãch H·∫πn';
            openModal('appointmentModal');
        }

        function deleteAppointment(id) {
            if (!confirm('X√≥a l·ªãch h·∫πn n√†y?')) return;
            appointments = appointments.filter(a => a.id !== id);
            saveData('appointments', appointments);
            showNotification('ƒê√£ x√≥a!');
            renderAll();
        }

        /* ============================================================
        üìã TASK 2.6: S·ª¨A BUG EDIT REGISTRATION ID
        ============================================================ */

        // ===== M·ªû MODAL T·∫†O PHI·∫æU ƒêK M·ªöI =====
        function openNewRegistrationModal() {
            // Reset t·∫•t c·∫£
            document.getElementById('regStudentId').value = '';
            document.getElementById('editRegId').value = '';
            document.getElementById('registrationForm').reset();

            // Reset ti√™u ƒë·ªÅ
            const modalTitle = document.querySelector('#registrationModal .modal-header h2');
            if (modalTitle) modalTitle.textContent = 'üìã T·∫°o Phi·∫øu ƒêƒÉng K√Ω';

            // Populate dropdowns
            populateRegStudentDropdown();
            renderPromotionCheckboxes();

            // Set ng√†y ƒëƒÉng k√Ω m·∫∑c ƒë·ªãnh l√† h√¥m nay
            document.getElementById('regDate').value = new Date().toISOString().split('T')[0];

            // Reset c√°c tr∆∞·ªùng m·ªõi
            document.getElementById('regTotalSessions').value = '';
            document.getElementById('regStartDate').value = '';
            document.getElementById('regNotes').value = '';

            // Reset g√≥i h·ªçc ph√≠
            document.getElementById('regPackage').innerHTML = '<option value="">-- Ch·ªçn g√≥i --</option>';

            openModal('registrationModal');
        }



        // ===== M·ªû MODAL T·∫†O PHI·∫æU ƒêK CHO H·ªåC VI√äN C·ª§ TH·ªÇ =====
        function openRegistrationModalForStudent(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;

            // Reset form
            document.getElementById('editRegId').value = '';
            document.getElementById('registrationForm').reset();

            // Set h·ªçc vi√™n
            document.getElementById('regStudentId').value = studentId;
            populateRegStudentDropdown();
            document.getElementById('regStudentSelect').value = studentId;
            onRegStudentChange();

            // Populate khuy·∫øn m√£i
            renderPromotionCheckboxes();

            // Set ng√†y ƒëƒÉng k√Ω m·∫∑c ƒë·ªãnh
            document.getElementById('regDate').value = new Date().toISOString().split('T')[0];

            // Reset c√°c tr∆∞·ªùng m·ªõi
            document.getElementById('regTotalSessions').value = '';
            document.getElementById('regStartDate').value = '';
            document.getElementById('regNotes').value = '';

            // Reset ti√™u ƒë·ªÅ
            const modalTitle = document.querySelector('#registrationModal .modal-header h2');
            if (modalTitle) modalTitle.textContent = 'üìã T·∫°o Phi·∫øu ƒêƒÉng K√Ω';

            openModal('registrationModal');
        }


        function populateRegStudentDropdown() {
            const eligible = students.filter(s => s.status === 'Ch·ªù ƒêƒÉng K√Ω');
            document.getElementById('regStudentSelect').innerHTML = '<option value="">-- Ch·ªçn h·ªçc vi√™n --</option>' +
                eligible.map(s => `<option value="${s.id}">${s.name} - ${s.parentPhone}</option>`).join('');
        }

        function onRegStudentChange() {
            const studentId = document.getElementById('regStudentSelect').value;
            const student = students.find(s => s.id === studentId);
            document.getElementById('regStudentId').value = studentId;
            if (student) {
                document.getElementById('regSubject').innerHTML = '<option value="">-- Ch·ªçn m√¥n --</option>' +
                    student.subjects.map(s => `<option value="${s}">${s}</option>`).join('');
            }
        }

        // ===== LOAD G√ìI H·ªåC PH√ç THEO M√îN - C·∫¨P NH·∫¨T =====
        function loadPackagesForSubject() {
            const subject = document.getElementById('regSubject').value;
            const packageSelect = document.getElementById('regPackage');
            const sessionsInput = document.getElementById('regTotalSessions');
            const feeInput = document.getElementById('regTuitionFee');

            // L·ªçc g√≥i theo m√¥n
            const subjectPackages = packages.filter(p => p.subjectName === subject);

            // Populate dropdown g√≥i - B·∫ÆT BU·ªòC CH·ªåN G√ìI
            packageSelect.innerHTML = '<option value="">-- Ch·ªçn g√≥i --</option>' +
                subjectPackages.map(p => `<option value="${p.id}">${p.name} - ${p.sessions} bu·ªïi - ${formatCurrency(p.fee)}</option>`).join('');

            // N·∫øu kh√¥ng c√≥ g√≥i cho m√¥n n√†y, l·∫•y h·ªçc ph√≠ m·∫∑c ƒë·ªãnh t·ª´ m√¥n h·ªçc
            if (subjectPackages.length === 0) {
                const subjectInfo = subjects.find(s => s.name === subject);
                if (subjectInfo) {
                    feeInput.value = formatNumberInput(subjectInfo.defaultFee);
                    sessionsInput.value = 8; // M·∫∑c ƒë·ªãnh 8 bu·ªïi n·∫øu kh√¥ng c√≥ g√≥i
                }
                showNotification('M√¥n n√†y ch∆∞a c√≥ g√≥i h·ªçc ph√≠. Vui l√≤ng t·∫°o g√≥i trong Danh m·ª•c!', 'warning');
            } else {
                // Reset s·ªë bu·ªïi v√† h·ªçc ph√≠ khi ƒë·ªïi m√¥n
                sessionsInput.value = '';
                feeInput.value = '';
            }

            calculateFinalAmount();
        }


        // ===== √ÅP D·ª§NG G√ìI H·ªåC PH√ç - C·∫¨P NH·∫¨T =====
        function applyPackageFee() {
            const pkgId = document.getElementById('regPackage').value;
            const pkg = packages.find(p => p.id === pkgId);

            if (pkg) {
                // T·ª± ƒë·ªông ƒëi·ªÅn s·ªë bu·ªïi t·ª´ g√≥i
                document.getElementById('regTotalSessions').value = pkg.sessions;

                // T·ª± ƒë·ªông ƒëi·ªÅn h·ªçc ph√≠ t·ª´ g√≥i
                document.getElementById('regTuitionFee').value = formatNumberInput(pkg.fee);

                calculateFinalAmount();
            } else {
                // Reset n·∫øu kh√¥ng ch·ªçn g√≥i
                document.getElementById('regTotalSessions').value = '';
                document.getElementById('regTuitionFee').value = '';
                calculateFinalAmount();
            }
        }


        function renderPromotionCheckboxes() {
            const now = new Date();
            const active = promotions.filter(p => new Date(p.endDate) >= now);
            document.getElementById('regPromotionList').innerHTML = active.length === 0
                ? '<p class="text-muted">Kh√¥ng c√≥ KM</p>'
                : active.map(p => `<label class="checkbox-item"><input type="checkbox" name="regPromotions" value="${p.id}" onchange="calculateFinalAmount()"> ${p.name} (${p.type === 'percent' ? p.value + '%' : formatCurrency(p.value)})</label>`).join('');
        }

        function calculateFinalAmount() {
            const tuition = parseCurrencyInput(document.getElementById('regTuitionFee').value);
            const selectedPromos = Array.from(document.querySelectorAll('input[name="regPromotions"]:checked')).map(cb => promotions.find(p => p.id === cb.value)).filter(p => p);

            let discount = 0;
            selectedPromos.forEach(p => { discount += p.type === 'percent' ? tuition * p.value / 100 : p.value; });

            const final = Math.max(tuition - discount, 0);
            document.getElementById('regDiscountAmount').value = discount > 0 ? '-' + formatCurrency(discount) : '';
            document.getElementById('regFinalAmount').value = formatCurrency(final);
        }

        // ===== L∆ØU PHI·∫æU ƒêƒÇNG K√ù - C·∫¨P NH·∫¨T ƒê·∫¶Y ƒê·ª¶ =====
        function saveRegistration(event) {
            event.preventDefault();

            const editId = document.getElementById('editRegId')?.value;
            const studentId = document.getElementById('regStudentId').value;

            // Validation
            if (!studentId) {
                showNotification('Vui l√≤ng ch·ªçn h·ªçc vi√™n!', 'error');
                return;
            }

            const packageId = document.getElementById('regPackage').value;
            if (!packageId) {
                showNotification('Vui l√≤ng ch·ªçn g√≥i h·ªçc ph√≠!', 'error');
                return;
            }

            const totalSessions = parseInt(document.getElementById('regTotalSessions').value);
            if (!totalSessions || totalSessions < 1) {
                showNotification('Vui l√≤ng nh·∫≠p s·ªë bu·ªïi h·ªçc h·ª£p l·ªá!', 'error');
                return;
            }

            const student = students.find(s => s.id === studentId);
            const tuition = parseCurrencyInput(document.getElementById('regTuitionFee').value);

            if (tuition <= 0) {
                showNotification('H·ªçc ph√≠ ph·∫£i l·ªõn h∆°n 0!', 'error');
                return;
            }

            // T√≠nh gi·∫£m gi√° t·ª´ khuy·∫øn m√£i
            const selectedPromoIds = Array.from(document.querySelectorAll('input[name="regPromotions"]:checked')).map(cb => cb.value);
            let discount = 0;
            selectedPromoIds.forEach(promoId => {
                const promo = promotions.find(p => p.id === promoId);
                if (promo) {
                    discount += promo.type === 'percent' ? tuition * promo.value / 100 : promo.value;
                }
            });

            const finalAmount = Math.max(tuition - discount, 0);

            // L·∫•y c√°c tr∆∞·ªùng m·ªõi
            const startDate = document.getElementById('regStartDate').value || null;
            const regDate = document.getElementById('regDate').value || new Date().toISOString().split('T')[0];
            const notes = document.getElementById('regNotes').value.trim();

            // T·∫°o object d·ªØ li·ªáu
            const regData = {
                studentId,
                studentName: student ? student.name : '',
                parentName: student ? student.parentName : '',
                parentPhone: student ? student.parentPhone : '',
                subject: document.getElementById('regSubject').value,
                packageId: packageId,
                totalSessions: totalSessions,           // TR∆Ø·ªúNG M·ªöI
                startDate: startDate,                   // TR∆Ø·ªúNG M·ªöI
                tuitionFee: tuition,
                promotionIds: selectedPromoIds,
                discountAmount: discount,
                finalAmount,
                registrationDate: regDate,
                notes: notes                            // TR∆Ø·ªúNG M·ªöI
            };

            if (editId) {
                // C·∫¨P NH·∫¨T phi·∫øu ƒëƒÉng k√Ω
                const index = registrations.findIndex(r => r.id === editId);
                if (index !== -1) {
                    registrations[index] = {
                        ...registrations[index],
                        ...regData,
                        updatedAt: new Date().toISOString()
                    };
                    showNotification('C·∫≠p nh·∫≠t phi·∫øu ƒêK th√†nh c√¥ng!', 'success');
                }
                document.getElementById('editRegId').value = '';
            } else {
                // TH√äM M·ªöI phi·∫øu ƒëƒÉng k√Ω
                const regCode = generateRegCode();
                registrations.push({
                    id: generateId(),
                    regCode,
                    ...regData,
                    createdAt: new Date().toISOString()
                });

                // C·∫≠p nh·∫≠t tr·∫°ng th√°i h·ªçc vi√™n
                if (student && student.status === 'Ch·ªù ƒêƒÉng K√Ω') {
                    student.status = 'ƒê√£ ƒêƒÉng K√Ω';
                    saveData('students', students);
                }

                showNotification(`T·∫°o phi·∫øu ƒêK th√†nh c√¥ng! M√£: ${regCode}`, 'success');
            }

            saveData('registrations', registrations);
            closeModal('registrationModal');

            // Reset ti√™u ƒë·ªÅ modal
            const modalTitle = document.querySelector('#registrationModal .modal-header h2');
            if (modalTitle) modalTitle.textContent = 'üìã T·∫°o Phi·∫øu ƒêƒÉng K√Ω';

            renderAll();
        }


        function searchRegistrations() { paginationState.registrations.page = 1; renderRegistrationsTable(); }

        function getFilteredRegistrations() {
            const searchTerm = document.getElementById('searchRegistration')?.value?.toLowerCase() || '';
            let filtered = [...registrations];
            if (searchTerm) filtered = filtered.filter(r => r.regCode.toLowerCase().includes(searchTerm) || r.studentName?.toLowerCase().includes(searchTerm));
            return filtered.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        }

        // ===== RENDER B·∫¢NG PHI·∫æU ƒêK - C·∫¨P NH·∫¨T HI·ªÇN TH·ªä S·ªê BU·ªîI =====
        function renderRegistrationsTable() {
            const filtered = getFilteredRegistrations();
            const { data, total, totalPages, currentPage } = getPaginatedData(filtered, 'registrations');
            const tbody = document.getElementById('registrationsTableBody');

            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8"><div class="empty-state"><div class="empty-state-icon">üìã</div><p>Kh√¥ng c√≥ phi·∫øu ƒêK</p></div></td></tr>`;
                renderPagination('registrationsPagination', 'registrations', 0, 0, 1);
                return;
            }

            tbody.innerHTML = data.map(r => {
                const pkg = r.packageId ? packages.find(p => p.id === r.packageId) : null;
                const sessionsDisplay = r.totalSessions ? `${r.totalSessions} bu·ªïi` : (pkg ? `${pkg.sessions} bu·ªïi` : '-');

                return `
                    <tr>
                        <td><strong class="text-primary">${r.regCode}</strong></td>
                        <td>
                            <strong>${r.studentName || 'N/A'}</strong>
                            ${r.startDate ? `<br><small class="text-muted">B·∫Øt ƒë·∫ßu: ${formatDate(r.startDate)}</small>` : ''}
                        </td>
                        <td>
                            <span class="subject-tag">${r.subject}</span><br>
                            <small class="text-muted">${pkg ? pkg.name : 'G√≥i t√πy ch·ªânh'}</small>
                        </td>
                        <td><strong>${sessionsDisplay}</strong></td>
                        <td>
                            ${formatCurrency(r.tuitionFee)}
                            ${r.discountAmount > 0 ? `<br><small class="text-danger">-${formatCurrency(r.discountAmount)}</small>` : ''}
                        </td>
                        <td><strong class="text-success">${formatCurrency(r.finalAmount)}</strong></td>
                        <td>${formatDate(r.registrationDate)}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="action-btn view" onclick="viewRegistration('${r.id}')" title="Xem & In">üëÅÔ∏è</button>
                                ${canEdit('registrations') ? `<button class="action-btn edit" onclick="editRegistration('${r.id}')" title="S·ª≠a">‚úèÔ∏è</button>` : ''}
                                ${canDelete('registrations') ? `<button class="action-btn delete" onclick="deleteRegistration('${r.id}')" title="X√≥a">üóëÔ∏è</button>` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            renderPagination('registrationsPagination', 'registrations', total, totalPages, currentPage);
        }


        function viewRegistration(id) {
            const reg = registrations.find(r => r.id === id);
            if (!reg) return;
            document.getElementById('registrationPreviewContent').innerHTML = `<div style="text-align:center;padding:20px;"><h3>${reg.regCode}</h3><p>${reg.studentName} - ${reg.subject}</p><p><strong>${formatCurrency(reg.finalAmount)}</strong></p></div>`;
            openModal('viewRegistrationModal');
        }

        function deleteRegistration(id) {
            if (!confirm('X√≥a phi·∫øu ƒêK n√†y?')) return;
            registrations = registrations.filter(r => r.id !== id);
            saveData('registrations', registrations);
            showNotification('ƒê√£ x√≥a!');
            renderRegistrationsTable();
        }

        function printRegistration() { window.print(); }
        function downloadRegistrationPDF() { showNotification('ƒêang t·∫£i PDF...', 'info'); }

        // ===== RECEIPTS =====
        function openReceiptModal() {
            document.getElementById('editReceiptId').value = '';
            document.getElementById('receiptForm').reset();
            document.getElementById('receiptDate').value = new Date().toISOString().split('T')[0];
            populateReceiptStudentDropdown();
            openModal('receiptModal');
        }

        function openReceiptModalForStudent(studentId) {
            openReceiptModal();
            document.getElementById('receiptStudentId').value = studentId;
            fillReceiptStudentInfo();
        }

        function populateReceiptStudentDropdown() {
            const eligible = students.filter(s => s.status === 'ƒê√£ ƒêƒÉng K√Ω');
            document.getElementById('receiptStudentId').innerHTML = '<option value="">-- Ch·ªçn h·ªçc vi√™n --</option>' +
                eligible.map(s => `<option value="${s.id}">${s.name} - ${s.parentPhone}</option>`).join('');
        }

        function fillReceiptStudentInfo() {
            const studentId = document.getElementById('receiptStudentId').value;
            const student = students.find(s => s.id === studentId);
            document.getElementById('receiptParentName').value = student?.parentName || '';
            document.getElementById('receiptParentPhone').value = student?.parentPhone || '';

            if (studentId) {
                const studentRegs = registrations.filter(r => r.studentId === studentId);
                document.getElementById('receiptRegistrationSelect').innerHTML = '<option value="">-- Ch·ªçn phi·∫øu ƒêK --</option>' +
                    studentRegs.map(r => `<option value="${r.id}">${r.regCode} - ${formatCurrency(r.finalAmount)}</option>`).join('');
            }
        }

        function fillFromRegistration() {
            const regId = document.getElementById('receiptRegistrationSelect').value;
            const reg = registrations.find(r => r.id === regId);
            if (reg) {
                document.getElementById('receiptDescription').value = `H·ªçc ph√≠ ${reg.subject}`;
                document.getElementById('receiptAmount').value = formatNumberInput(reg.finalAmount);
            }
        }

        /* ============================================================
        üßæ TASK 2.5: S·ª¨A BUG T·∫†O M√É BI√äN LAI
        ============================================================ */

        function saveReceipt(event) {
            event.preventDefault();

            const studentId = document.getElementById('receiptStudentId').value;
            const student = students.find(s => s.id === studentId);
            const editId = document.getElementById('editReceiptId').value;

            const data = {
                studentId,
                type: document.getElementById('receiptType').value,
                parentName: student?.parentName || '',
                parentPhone: student?.parentPhone || '',
                registrationId: document.getElementById('receiptRegistrationSelect')?.value || null,
                description: document.getElementById('receiptDescription').value.trim(),
                amount: parseCurrencyInput(document.getElementById('receiptAmount').value),
                date: document.getElementById('receiptDate').value,
                notes: document.getElementById('receiptNotes').value.trim()
            };

            // Validation
            if (!studentId) {
                showNotification('Vui l√≤ng ch·ªçn h·ªçc vi√™n!', 'error');
                return;
            }

            if (!data.type) {
                showNotification('Vui l√≤ng ch·ªçn lo·∫°i bi√™n lai!', 'error');
                return;
            }

            if (data.amount <= 0) {
                showNotification('S·ªë ti·ªÅn ph·∫£i l·ªõn h∆°n 0!', 'error');
                return;
            }

            if (editId) {
                // C·∫¨P NH·∫¨T - Gi·ªØ nguy√™n receiptCode c≈©
                const index = receipts.findIndex(r => r.id === editId);
                if (index !== -1) {
                    receipts[index] = {
                        ...receipts[index],
                        ...data,
                        // QUAN TR·ªåNG: Gi·ªØ nguy√™n receiptCode c≈©
                        receiptCode: receipts[index].receiptCode,
                        updatedAt: new Date().toISOString()
                    };
                    showNotification('C·∫≠p nh·∫≠t bi√™n lai th√†nh c√¥ng!', 'success');
                }
            } else {
                // TH√äM M·ªöI - T·∫°o receiptCode m·ªõi
                const newReceipt = {
                    id: generateId(),
                    receiptCode: generateReceiptCode(), // T·∫°o m√£ m·ªõi
                    ...data,
                    createdBy: currentUser?.id || null,
                    createdAt: new Date().toISOString()
                };
                receipts.push(newReceipt);
                showNotification('T·∫°o bi√™n lai th√†nh c√¥ng!', 'success');
            }

            saveData('receipts', receipts);
            closeModal('receiptModal');

            // Reset form title
            const modalTitle = document.querySelector('#receiptModal .modal-header h2');
            if (modalTitle) modalTitle.textContent = 'üßæ T·∫°o Bi√™n Lai';

            renderAll();
        }



        function searchReceipts() { paginationState.receipts.page = 1; renderReceiptsTable(); }

        function getFilteredReceipts() {
            const searchTerm = document.getElementById('searchReceipt')?.value?.toLowerCase() || '';
            let filtered = [...receipts];
            if (searchTerm) {
                filtered = filtered.filter(r => {
                    const student = students.find(s => s.id === r.studentId);
                    return r.description.toLowerCase().includes(searchTerm) || student?.name.toLowerCase().includes(searchTerm);
                });
            }
            return filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
        }

        function renderReceiptsTable() {
            const filtered = getFilteredReceipts();
            const { data, total, totalPages, currentPage } = getPaginatedData(filtered, 'receipts');
            const tbody = document.getElementById('receiptsTableBody');

            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7"><div class="empty-state"><div class="empty-state-icon">üßæ</div><p>Kh√¥ng c√≥ bi√™n lai</p></div></td></tr>`;
                renderPagination('receiptsPagination', 'receipts', 0, 0, 1);
                return;
            }

            tbody.innerHTML = data.map((r, idx) => {
                const student = students.find(s => s.id === r.studentId);
                return `
            <tr>
                <td><strong>#${String(total - idx).padStart(4, '0')}</strong></td>
                <td><span class="subject-tag">${r.type}</span></td>
                <td>${student?.name || 'N/A'}</td>
                <td>${r.description}</td>
                <td><strong class="text-success">${formatCurrency(r.amount)}</strong></td>
                <td>${formatDate(r.date)}</td>
                <td><div class="action-buttons">
                    <button class="action-btn view" onclick="viewReceipt('${r.id}')" title="Xem">üëÅÔ∏è</button>
                    ${canDelete('receipts') ? `<button class="action-btn delete" onclick="deleteReceipt('${r.id}')" title="X√≥a">üóëÔ∏è</button>` : ''}
                </div></td>
            </tr>
        `;
            }).join('');

            renderPagination('receiptsPagination', 'receipts', total, totalPages, currentPage);
        }

        function viewReceipt(id) {
            const receipt = receipts.find(r => r.id === id);
            if (!receipt) return;
            document.getElementById('receiptPreviewContent').innerHTML = `<div style="text-align:center;padding:20px;"><h3>${receipt.type}</h3><p>${receipt.description}</p><p><strong>${formatCurrency(receipt.amount)}</strong></p></div>`;
            openModal('viewReceiptModal');
        }

        function deleteReceipt(id) {
            if (!confirm('X√≥a bi√™n lai n√†y?')) return;
            receipts = receipts.filter(r => r.id !== id);
            saveData('receipts', receipts);
            showNotification('ƒê√£ x√≥a!');
            renderReceiptsTable();
        }

        function printReceipt() { window.print(); }
        function downloadReceiptPDF() { showNotification('ƒêang t·∫£i PDF...', 'info'); }

        // ===== SUBJECTS, PACKAGES, PROMOTIONS =====
        function renderSubjectsTable() {
            const tbody = document.getElementById('subjectsTableBody');
            tbody.innerHTML = subjects.map(s => `
        <tr>
            <td style="font-size: 24px;">${s.icon}</td>
            <td><strong>${s.name}</strong></td>
            <td>${formatCurrency(s.defaultFee)}</td>
            <td><div class="action-buttons">
                ${canEdit('subjects') ? `<button class="action-btn edit" onclick="editSubject('${s.id}')" title="S·ª≠a">‚úèÔ∏è</button>` : ''}
                ${canDelete('subjects') ? `<button class="action-btn delete" onclick="deleteSubject('${s.id}')" title="X√≥a">üóëÔ∏è</button>` : ''}
            </div></td>
        </tr>
    `).join('');
        }

        function openSubjectModal() {
            document.getElementById('editSubjectId').value = '';
            document.getElementById('subjectForm').reset();
            document.getElementById('subjectModalTitle').textContent = 'üìñ Th√™m M√¥n H·ªçc';
            openModal('subjectModal');
        }

        function editSubject(id) {
            const s = subjects.find(s => s.id === id);
            if (!s) return;
            document.getElementById('editSubjectId').value = s.id;
            document.getElementById('subjectIcon').value = s.icon;
            document.getElementById('subjectName').value = s.name;
            document.getElementById('subjectDefaultFee').value = formatNumberInput(s.defaultFee);
            document.getElementById('subjectModalTitle').textContent = '‚úèÔ∏è S·ª≠a M√¥n H·ªçc';
            openModal('subjectModal');
        }

        function saveSubject(event) {
            event.preventDefault();
            const editId = document.getElementById('editSubjectId').value;
            const data = { icon: document.getElementById('subjectIcon').value.trim(), name: document.getElementById('subjectName').value.trim(), defaultFee: parseCurrencyInput(document.getElementById('subjectDefaultFee').value) };

            if (editId) {
                const idx = subjects.findIndex(s => s.id === editId);
                if (idx !== -1) subjects[idx] = { ...subjects[idx], ...data };
                showNotification('C·∫≠p nh·∫≠t th√†nh c√¥ng!');
            } else {
                subjects.push({ id: generateId(), ...data });
                showNotification('Th√™m th√†nh c√¥ng!');
            }
            saveData('subjects', subjects);
            closeModal('subjectModal');
            renderSubjectsTable();
            renderSubjectCheckboxes();
        }

        function deleteSubject(id) {
            if (!confirm('X√≥a m√¥n h·ªçc n√†y?')) return;
            subjects = subjects.filter(s => s.id !== id);
            saveData('subjects', subjects);
            showNotification('ƒê√£ x√≥a!');
            renderSubjectsTable();
        }

        function renderPackagesTable() {
            const tbody = document.getElementById('packagesTableBody');
            tbody.innerHTML = packages.length === 0 ? `<tr><td colspan="5"><div class="empty-state"><p>Ch∆∞a c√≥ g√≥i</p></div></td></tr>` : packages.map(p => `
        <tr>
            <td><strong>${p.name}</strong></td>
            <td>${p.subjectName}</td>
            <td>${p.sessions} bu·ªïi</td>
            <td>${formatCurrency(p.fee)}</td>
            <td><div class="action-buttons">
                ${canEdit('packages') ? `<button class="action-btn edit" onclick="editPackage('${p.id}')" title="S·ª≠a">‚úèÔ∏è</button>` : ''}
                ${canDelete('packages') ? `<button class="action-btn delete" onclick="deletePackage('${p.id}')" title="X√≥a">üóëÔ∏è</button>` : ''}
            </div></td>
        </tr>
    `).join('');
        }

        function openPackageModal() {
            document.getElementById('editPackageId').value = '';
            document.getElementById('packageForm').reset();
            document.getElementById('packageModalTitle').textContent = 'üì¶ Th√™m G√≥i';
            document.getElementById('packageSubject').innerHTML = '<option value="">-- Ch·ªçn m√¥n --</option>' + subjects.map(s => `<option value="${s.name}">${s.icon} ${s.name}</option>`).join('');
            openModal('packageModal');
        }

        function editPackage(id) {
            const p = packages.find(p => p.id === id);
            if (!p) return;
            document.getElementById('editPackageId').value = p.id;
            document.getElementById('packageName').value = p.name;
            document.getElementById('packageSubject').innerHTML = '<option value="">-- Ch·ªçn m√¥n --</option>' + subjects.map(s => `<option value="${s.name}" ${s.name === p.subjectName ? 'selected' : ''}>${s.icon} ${s.name}</option>`).join('');
            document.getElementById('packageSessions').value = p.sessions;
            document.getElementById('packageFee').value = formatNumberInput(p.fee);
            document.getElementById('packageModalTitle').textContent = '‚úèÔ∏è S·ª≠a G√≥i';
            openModal('packageModal');
        }

        function savePackage(event) {
            event.preventDefault();
            const editId = document.getElementById('editPackageId').value;
            const data = { name: document.getElementById('packageName').value.trim(), subjectName: document.getElementById('packageSubject').value, sessions: parseInt(document.getElementById('packageSessions').value), fee: parseCurrencyInput(document.getElementById('packageFee').value) };

            if (editId) {
                const idx = packages.findIndex(p => p.id === editId);
                if (idx !== -1) packages[idx] = { ...packages[idx], ...data };
            } else {
                packages.push({ id: generateId(), ...data });
            }
            saveData('packages', packages);
            closeModal('packageModal');
            showNotification('L∆∞u th√†nh c√¥ng!');
            renderPackagesTable();
        }

        function deletePackage(id) {
            if (!confirm('X√≥a g√≥i n√†y?')) return;
            packages = packages.filter(p => p.id !== id);
            saveData('packages', packages);
            showNotification('ƒê√£ x√≥a!');
            renderPackagesTable();
        }

        function renderPromotionsTable() {
            const now = new Date();
            const tbody = document.getElementById('promotionsTableBody');
            tbody.innerHTML = promotions.length === 0 ? `<tr><td colspan="6"><div class="empty-state"><p>Ch∆∞a c√≥ KM</p></div></td></tr>` : promotions.map(p => {
                const expired = new Date(p.endDate) < now;
                return `
            <tr style="${expired ? 'opacity: 0.5;' : ''}">
                <td><strong>${p.name}</strong></td>
                <td>${p.type === 'percent' ? 'Gi·∫£m %' : 'Gi·∫£m VNƒê'}</td>
                <td>${p.type === 'percent' ? p.value + '%' : formatCurrency(p.value)}</td>
                <td>${formatDate(p.startDate)} - ${formatDate(p.endDate)}</td>
                <td>${expired ? '<span class="text-danger">H·∫øt h·∫°n</span>' : '<span class="text-success">Ho·∫°t ƒë·ªông</span>'}</td>
                <td><div class="action-buttons">
                    ${canEdit('promotions') ? `<button class="action-btn edit" onclick="editPromotion('${p.id}')" title="S·ª≠a">‚úèÔ∏è</button>` : ''}
                    ${canDelete('promotions') ? `<button class="action-btn delete" onclick="deletePromotion('${p.id}')" title="X√≥a">üóëÔ∏è</button>` : ''}
                </div></td>
            </tr>
        `;
            }).join('');
        }

        function openPromotionModal() {
            document.getElementById('editPromotionId').value = '';
            document.getElementById('promotionForm').reset();
            document.getElementById('promotionModalTitle').textContent = 'üéÅ Th√™m KM';
            document.getElementById('promotionStartDate').value = new Date().toISOString().split('T')[0];
            openModal('promotionModal');
        }

        function editPromotion(id) {
            const p = promotions.find(p => p.id === id);
            if (!p) return;
            document.getElementById('editPromotionId').value = p.id;
            document.getElementById('promotionName').value = p.name;
            document.getElementById('promotionType').value = p.type;
            document.getElementById('promotionValue').value = p.value;
            document.getElementById('promotionStartDate').value = p.startDate;
            document.getElementById('promotionEndDate').value = p.endDate;
            document.getElementById('promotionModalTitle').textContent = '‚úèÔ∏è S·ª≠a KM';
            openModal('promotionModal');
        }

        function savePromotion(event) {
            event.preventDefault();
            const editId = document.getElementById('editPromotionId').value;
            const data = { name: document.getElementById('promotionName').value.trim(), type: document.getElementById('promotionType').value, value: parseFloat(document.getElementById('promotionValue').value), startDate: document.getElementById('promotionStartDate').value, endDate: document.getElementById('promotionEndDate').value };

            if (editId) {
                const idx = promotions.findIndex(p => p.id === editId);
                if (idx !== -1) promotions[idx] = { ...promotions[idx], ...data };
            } else {
                promotions.push({ id: generateId(), ...data });
            }
            saveData('promotions', promotions);
            closeModal('promotionModal');
            showNotification('L∆∞u th√†nh c√¥ng!');
            renderPromotionsTable();
        }

        function deletePromotion(id) {
            if (!confirm('X√≥a KM n√†y?')) return;
            promotions = promotions.filter(p => p.id !== id);
            saveData('promotions', promotions);
            showNotification('ƒê√£ x√≥a!');
            renderPromotionsTable();
        }

        /* ============================================================
           üì§ PH·∫¶N 17: EXPORT & BACKUP
           ============================================================ */

        /* ============================================================
        üì§ TASK 2.9: TH√äM TRY-CATCH CHO EXPORT
        ============================================================ */

        function exportAllToExcel() {
            try {
                if (typeof XLSX === 'undefined') {
                    throw new Error('Th∆∞ vi·ªán XLSX ch∆∞a ƒë∆∞·ª£c t·∫£i!');
                }

                const wb = XLSX.utils.book_new();

                // Sheet H·ªçc vi√™n
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(students.map(s => ({
                    'T√™n': s.name,
                    'Tu·ªïi': s.age,
                    'Ph·ª• huynh': s.parentName,
                    'SƒêT': s.parentPhone,
                    'Email': s.parentEmail || '',
                    'M√¥n h·ªçc': s.subjects.join(', '),
                    'Tr·∫°ng th√°i': s.status,
                    'Ng√†y t·∫°o': s.createdAt ? formatDate(s.createdAt.split('T')[0]) : ''
                }))), 'H·ªçc Vi√™n');

                // Sheet Phi·∫øu ƒêK
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(registrations.map(r => ({
                    'M√£ phi·∫øu': r.regCode,
                    'H·ªçc vi√™n': r.studentName,
                    'M√¥n': r.subject,
                    'S·ªë bu·ªïi': r.totalSessions || '-',
                    'H·ªçc ph√≠': r.tuitionFee,
                    'Gi·∫£m': r.discountAmount,
                    'Th√†nh ti·ªÅn': r.finalAmount,
                    'Ng√†y ƒêK': formatDate(r.registrationDate)
                }))), 'Phi·∫øu ƒêK');

                // Sheet Bi√™n lai
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(receipts.map(r => ({
                    'M√£ BL': r.receiptCode || '',
                    'Lo·∫°i': r.type,
                    'H·ªçc vi√™n': students.find(s => s.id === r.studentId)?.name || '',
                    'N·ªôi dung': r.description,
                    'S·ªë ti·ªÅn': r.amount,
                    'Ng√†y': formatDate(r.date)
                }))), 'Bi√™n Lai');

                // Sheet Gi√°o vi√™n
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(teachers.map(t => ({
                    'H·ªç t√™n': t.fullName,
                    'SƒêT': t.phone,
                    'Email': t.email || '',
                    'M√¥n d·∫°y': t.subjects.join(', '),
                    'Lo·∫°i l∆∞∆°ng': t.salaryType,
                    'Tr·∫°ng th√°i': t.status === 'active' ? 'ƒêang d·∫°y' : 'Ngh·ªâ'
                }))), 'Gi√°o Vi√™n');

                // Sheet L·ªõp h·ªçc
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(classes.map(c => {
                    const subject = subjects.find(s => s.id === c.subjectId);
                    const teacher = teachers.find(t => t.id === c.teacherId);
                    return {
                        'T√™n l·ªõp': c.className,
                        'M√¥n h·ªçc': subject ? subject.name : '',
                        'Gi√°o vi√™n': teacher ? teacher.fullName : '',
                        'Lo·∫°i': c.classType === 'group' ? 'Nh√≥m' : '1-1',
                        'Sƒ© s·ªë t·ªëi ƒëa': c.maxStudents,
                        'Tr·∫°ng th√°i': c.status
                    };
                })), 'L·ªõp H·ªçc');

                XLSX.writeFile(wb, `BaoCao_${formatDateFile()}.xlsx`);
                showNotification('‚úÖ Xu·∫•t Excel th√†nh c√¥ng!', 'success');

            } catch (error) {
                console.error('L·ªói export Excel:', error);
                showNotification('‚ùå L·ªói xu·∫•t Excel: ' + error.message, 'error');
            }
        }

        function exportStudentsToExcel() {
            try {
                if (typeof XLSX === 'undefined') {
                    throw new Error('Th∆∞ vi·ªán XLSX ch∆∞a ƒë∆∞·ª£c t·∫£i!');
                }

                if (students.length === 0) {
                    showNotification('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t!', 'warning');
                    return;
                }

                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(students.map(s => ({
                    'T√™n': s.name,
                    'Tu·ªïi': s.age,
                    'Ph·ª• huynh': s.parentName,
                    'SƒêT': s.parentPhone,
                    'Email': s.parentEmail || '',
                    'M√¥n h·ªçc': s.subjects.join(', '),
                    'Tr·∫°ng th√°i': s.status,
                    'Ghi ch√∫': s.notes || ''
                }))), 'H·ªçc Vi√™n');
                XLSX.writeFile(wb, `HocVien_${formatDateFile()}.xlsx`);
                showNotification('‚úÖ Xu·∫•t th√†nh c√¥ng!', 'success');

            } catch (error) {
                console.error('L·ªói export:', error);
                showNotification('‚ùå L·ªói: ' + error.message, 'error');
            }
        }

        function exportTrialStudentsToExcel() {
            try {
                if (typeof XLSX === 'undefined') {
                    throw new Error('Th∆∞ vi·ªán XLSX ch∆∞a ƒë∆∞·ª£c t·∫£i!');
                }

                const data = students.filter(s => s.status === 'H·ªçc Th·ª≠' || s.status === 'Ch·ªù ƒêƒÉng K√Ω');

                if (data.length === 0) {
                    showNotification('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t!', 'warning');
                    return;
                }

                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data.map(s => ({
                    'T√™n': s.name,
                    'Tu·ªïi': s.age,
                    'Ph·ª• huynh': s.parentName,
                    'SƒêT': s.parentPhone,
                    'M√¥n h·ªçc': s.subjects.join(', '),
                    'Tr·∫°ng th√°i': s.status
                }))), 'H·ªçc Th·ª≠');
                XLSX.writeFile(wb, `HocThu_${formatDateFile()}.xlsx`);
                showNotification('‚úÖ Xu·∫•t th√†nh c√¥ng!', 'success');

            } catch (error) {
                console.error('L·ªói export:', error);
                showNotification('‚ùå L·ªói: ' + error.message, 'error');
            }
        }

        function exportAppointmentsToExcel() {
            try {
                if (typeof XLSX === 'undefined') {
                    throw new Error('Th∆∞ vi·ªán XLSX ch∆∞a ƒë∆∞·ª£c t·∫£i!');
                }

                if (appointments.length === 0) {
                    showNotification('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t!', 'warning');
                    return;
                }

                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(appointments.map(a => {
                    const s = students.find(st => st.id === a.studentId);
                    return {
                        'H·ªçc vi√™n': s?.name || '',
                        'Ph·ª• huynh': s?.parentName || '',
                        'SƒêT': s?.parentPhone || '',
                        'M√¥n': a.subject,
                        'Ng√†y': formatDate(a.date),
                        'Gi·ªù': a.time,
                        'Ghi ch√∫': a.notes || ''
                    };
                })), 'L·ªãch H·∫πn');
                XLSX.writeFile(wb, `LichHen_${formatDateFile()}.xlsx`);
                showNotification('‚úÖ Xu·∫•t th√†nh c√¥ng!', 'success');

            } catch (error) {
                console.error('L·ªói export:', error);
                showNotification('‚ùå L·ªói: ' + error.message, 'error');
            }
        }

        function exportRegistrationsToExcel() {
            try {
                if (typeof XLSX === 'undefined') {
                    throw new Error('Th∆∞ vi·ªán XLSX ch∆∞a ƒë∆∞·ª£c t·∫£i!');
                }

                if (registrations.length === 0) {
                    showNotification('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t!', 'warning');
                    return;
                }

                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(registrations.map(r => ({
                    'M√£ phi·∫øu': r.regCode,
                    'H·ªçc vi√™n': r.studentName,
                    'M√¥n': r.subject,
                    'S·ªë bu·ªïi': r.totalSessions || '-',
                    'H·ªçc ph√≠': r.tuitionFee,
                    'Gi·∫£m': r.discountAmount,
                    'Th√†nh ti·ªÅn': r.finalAmount,
                    'Ng√†y ƒêK': formatDate(r.registrationDate),
                    'Ng√†y b·∫Øt ƒë·∫ßu': r.startDate ? formatDate(r.startDate) : '',
                    'Ghi ch√∫': r.notes || ''
                }))), 'Phi·∫øu ƒêK');
                XLSX.writeFile(wb, `PhieuDK_${formatDateFile()}.xlsx`);
                showNotification('‚úÖ Xu·∫•t th√†nh c√¥ng!', 'success');

            } catch (error) {
                console.error('L·ªói export:', error);
                showNotification('‚ùå L·ªói: ' + error.message, 'error');
            }
        }

        function exportReceiptsToExcel() {
            try {
                if (typeof XLSX === 'undefined') {
                    throw new Error('Th∆∞ vi·ªán XLSX ch∆∞a ƒë∆∞·ª£c t·∫£i!');
                }

                if (receipts.length === 0) {
                    showNotification('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t!', 'warning');
                    return;
                }

                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(receipts.map(r => {
                    const student = students.find(s => s.id === r.studentId);
                    return {
                        'M√£ BL': r.receiptCode || '',
                        'Lo·∫°i': r.type,
                        'H·ªçc vi√™n': student?.name || '',
                        'Ph·ª• huynh': r.parentName || '',
                        'SƒêT': r.parentPhone || '',
                        'N·ªôi dung': r.description,
                        'S·ªë ti·ªÅn': r.amount,
                        'Ng√†y': formatDate(r.date),
                        'Ghi ch√∫': r.notes || ''
                    };
                })), 'Bi√™n Lai');
                XLSX.writeFile(wb, `BienLai_${formatDateFile()}.xlsx`);
                showNotification('‚úÖ Xu·∫•t th√†nh c√¥ng!', 'success');

            } catch (error) {
                console.error('L·ªói export:', error);
                showNotification('‚ùå L·ªói: ' + error.message, 'error');
            }
        }

        function exportDebtsToExcel() {
            try {
                if (typeof XLSX === 'undefined') {
                    throw new Error('Th∆∞ vi·ªán XLSX ch∆∞a ƒë∆∞·ª£c t·∫£i!');
                }

                if (registrations.length === 0) {
                    showNotification('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t!', 'warning');
                    return;
                }

                const data = registrations.map(reg => {
                    const student = students.find(s => s.id === reg.studentId);
                    const debt = calculateDebtForRegistration(reg.id);
                    const cs = classStudents.find(c => c.registrationId === reg.id);

                    return {
                        'H·ªçc vi√™n': student ? student.name : '',
                        'SƒêT': student ? student.parentPhone : '',
                        'M√£ Phi·∫øu ƒêK': reg.regCode,
                        'M√¥n h·ªçc': reg.subject,
                        'T·ªïng ti·ªÅn': debt.totalAmount,
                        'ƒê√£ ƒë√≥ng': debt.paidAmount,
                        'C√≤n n·ª£': debt.debtAmount,
                        'C√≤n bu·ªïi': cs ? cs.remainingSessions : '',
                        'Tr·∫°ng th√°i': debt.debtAmount === 0 ? 'ƒê√£ ƒë√≥ng ƒë·ªß' : debt.paidAmount > 0 ? 'ƒê√≥ng 1 ph·∫ßn' : 'Ch∆∞a ƒë√≥ng'
                    };
                });

                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data), 'C√¥ng n·ª£');
                XLSX.writeFile(wb, `CongNo_${formatDateFile()}.xlsx`);
                showNotification('‚úÖ Xu·∫•t Excel th√†nh c√¥ng!', 'success');

            } catch (error) {
                console.error('L·ªói export:', error);
                showNotification('‚ùå L·ªói: ' + error.message, 'error');
            }
        }

        function exportBackupJSON() {
            try {
                const backup = {
                    version: '4.1',
                    exportDate: new Date().toISOString(),
                    data: {
                        users,
                        permissions,
                        students,
                        appointments,
                        registrations,
                        receipts,
                        subjects,
                        packages,
                        promotions,
                        teachers,
                        classes,
                        classSchedules,
                        classStudents,
                        attendances,
                        makeupRequests,
                        rooms,
                        centerInfo,
                        bankInfo,
                        warningSettings
                    }
                };

                const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `Backup_${formatDateFile()}.json`;
                a.click();

                showNotification('‚úÖ T·∫£i backup th√†nh c√¥ng!', 'success');

            } catch (error) {
                console.error('L·ªói backup:', error);
                showNotification('‚ùå L·ªói: ' + error.message, 'error');
            }
        }


        function exportStudentsToExcel() {
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(students.map(s => ({ T√™n: s.name, Tu·ªïi: s.age, 'Ph·ª• huynh': s.parentName, SƒêT: s.parentPhone, Email: s.parentEmail || '', 'M√¥n h·ªçc': s.subjects.join(', '), 'Tr·∫°ng th√°i': s.status }))), 'H·ªçc Vi√™n');
            XLSX.writeFile(wb, `HocVien_${formatDateFile()}.xlsx`);
            showNotification('Xu·∫•t th√†nh c√¥ng!');
        }

        function exportTrialStudentsToExcel() {
            const data = students.filter(s => s.status === 'H·ªçc Th·ª≠' || s.status === 'Ch·ªù ƒêƒÉng K√Ω');
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data.map(s => ({ T√™n: s.name, Tu·ªïi: s.age, 'Ph·ª• huynh': s.parentName, SƒêT: s.parentPhone, 'M√¥n h·ªçc': s.subjects.join(', '), 'Tr·∫°ng th√°i': s.status }))), 'H·ªçc Th·ª≠');
            XLSX.writeFile(wb, `HocThu_${formatDateFile()}.xlsx`);
            showNotification('Xu·∫•t th√†nh c√¥ng!');
        }

        function exportAppointmentsToExcel() {
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(appointments.map(a => { const s = students.find(st => st.id === a.studentId); return { 'H·ªçc vi√™n': s?.name || '', M√¥n: a.subject, Ng√†y: a.date, Gi·ªù: a.time }; })), 'L·ªãch H·∫πn');
            XLSX.writeFile(wb, `LichHen_${formatDateFile()}.xlsx`);
            showNotification('Xu·∫•t th√†nh c√¥ng!');
        }

        function exportRegistrationsToExcel() {
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(registrations.map(r => ({ 'M√£ phi·∫øu': r.regCode, 'H·ªçc vi√™n': r.studentName, M√¥n: r.subject, 'H·ªçc ph√≠': r.tuitionFee, 'Gi·∫£m': r.discountAmount, 'Th√†nh ti·ªÅn': r.finalAmount, Ng√†y: r.registrationDate }))), 'Phi·∫øu ƒêK');
            XLSX.writeFile(wb, `PhieuDK_${formatDateFile()}.xlsx`);
            showNotification('Xu·∫•t th√†nh c√¥ng!');
        }

        function exportReceiptsToExcel() {
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(receipts.map(r => ({ Lo·∫°i: r.type, 'N·ªôi dung': r.description, 'S·ªë ti·ªÅn': r.amount, Ng√†y: r.date }))), 'Bi√™n Lai');
            XLSX.writeFile(wb, `BienLai_${formatDateFile()}.xlsx`);
            showNotification('Xu·∫•t th√†nh c√¥ng!');
        }

        function exportBackupJSON() {
            const backup = { version: '4.0', exportDate: new Date().toISOString(), data: { users, permissions, students, appointments, registrations, receipts, subjects, packages, promotions, centerInfo, bankInfo } };
            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `Backup_${formatDateFile()}.json`; a.click();
            showNotification('T·∫£i backup th√†nh c√¥ng!');
        }

        function restoreFromJSON(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const backup = JSON.parse(e.target.result);
                    if (!backup.data) throw new Error('File kh√¥ng h·ª£p l·ªá!');
                    if (!confirm('Ghi ƒë√® to√†n b·ªô d·ªØ li·ªáu?')) return;

                    if (backup.data.users) { users = backup.data.users; saveData('users', users); }
                    if (backup.data.permissions) { permissions = backup.data.permissions; saveData('permissions', permissions); }
                    students = backup.data.students || [];
                    appointments = backup.data.appointments || [];
                    registrations = backup.data.registrations || [];
                    receipts = backup.data.receipts || [];
                    subjects = backup.data.subjects || subjects;
                    packages = backup.data.packages || [];
                    promotions = backup.data.promotions || [];
                    centerInfo = backup.data.centerInfo || {};
                    bankInfo = backup.data.bankInfo || {};

                    ['students', 'appointments', 'registrations', 'receipts', 'subjects', 'packages', 'promotions'].forEach(key => saveData(key, eval(key)));
                    saveData('centerInfo', centerInfo);
                    saveData('bankInfo', bankInfo);

                    renderAll();
                    showNotification('Kh√¥i ph·ª•c th√†nh c√¥ng!');
                } catch (err) { showNotification('L·ªói: ' + err.message, 'error'); }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function importFromExcel(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const wb = XLSX.read(e.target.result, { type: 'binary' });
                    const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                    if (!confirm(`Import ${data.length} d√≤ng?`)) return;

                    data.forEach(row => {
                        if (!students.find(s => s.parentPhone === row['SƒêT'])) {
                            students.push({
                                id: generateId(), name: row['T√™n'] || '', age: parseInt(row['Tu·ªïi']) || 0,
                                parentName: row['Ph·ª• huynh'] || '', parentPhone: row['SƒêT'] || '', parentEmail: row['Email'] || '',
                                subjects: (row['M√¥n h·ªçc'] || '').split(',').map(s => s.trim()).filter(s => s),
                                status: row['Tr·∫°ng th√°i'] || 'H·ªçc Th·ª≠', notes: '', previousStatus: null,
                                createdAt: new Date().toISOString(), updatedAt: new Date().toISOString()
                            });
                        }
                    });
                    saveData('students', students);
                    renderAll();
                    showNotification('Import th√†nh c√¥ng!');
                } catch (err) { showNotification('L·ªói: ' + err.message, 'error'); }
            };
            reader.readAsBinaryString(file);
            event.target.value = '';
        }

        function createAutoBackup() {
            const backup = { id: generateId(), date: new Date().toISOString(), type: 'auto', data: { students, appointments, registrations, receipts, subjects, packages, promotions } };
            backupHistory.unshift(backup);
            if (backupHistory.length > 10) backupHistory = backupHistory.slice(0, 10);
            localStorage.setItem('backupHistory', JSON.stringify(backupHistory));
        }

        function createManualBackup() {
            const backup = { id: generateId(), date: new Date().toISOString(), type: 'manual', data: { students, appointments, registrations, receipts, subjects, packages, promotions } };
            backupHistory.unshift(backup);
            if (backupHistory.length > 10) backupHistory = backupHistory.slice(0, 10);
            localStorage.setItem('backupHistory', JSON.stringify(backupHistory));
            renderBackupHistory();
            showNotification('Backup th√†nh c√¥ng!');
        }

        function toggleAutoBackup() {
            autoBackupEnabled = document.getElementById('autoBackupToggle').checked;
            localStorage.setItem('autoBackupEnabled', autoBackupEnabled);
            updateAutoBackupStatus();
        }

        function updateAutoBackupStatus() {
            document.getElementById('autoBackupStatus').innerHTML = autoBackupEnabled ? '<span class="text-success">‚úÖ ƒêang ho·∫°t ƒë·ªông</span>' : '<span class="text-danger">‚ùå ƒê√£ t·∫Øt</span>';
        }

        function renderBackupHistory() {
            const container = document.getElementById('backupHistoryList');
            container.innerHTML = backupHistory.length === 0 ? '<p class="text-muted">Ch∆∞a c√≥ backup</p>' : backupHistory.slice(0, 5).map(b => `
        <div style="background: var(--bg-light); padding: 12px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
            <div><strong>${b.type === 'auto' ? 'üîÑ T·ª± ƒë·ªông' : 'üíæ Th·ªß c√¥ng'}</strong><br><small class="text-muted">${new Date(b.date).toLocaleString('vi-VN')}</small></div>
            <button class="btn btn-sm btn-info" onclick="restoreFromBackupHistory('${b.id}')">Kh√¥i ph·ª•c</button>
        </div>
    `).join('');
        }

        function restoreFromBackupHistory(id) {
            const backup = backupHistory.find(b => b.id === id);
            if (!backup || !confirm('Kh√¥i ph·ª•c t·ª´ backup n√†y?')) return;

            students = backup.data.students || [];
            appointments = backup.data.appointments || [];
            registrations = backup.data.registrations || [];
            receipts = backup.data.receipts || [];
            subjects = backup.data.subjects || subjects;
            packages = backup.data.packages || [];
            promotions = backup.data.promotions || [];

            ['students', 'appointments', 'registrations', 'receipts', 'subjects', 'packages', 'promotions'].forEach(key => saveData(key, eval(key)));
            renderAll();
            showNotification('Kh√¥i ph·ª•c th√†nh c√¥ng!');
        }

        /* ============================================================
           ‚öôÔ∏è PH·∫¶N 18: SETTINGS
           ============================================================ */

        function saveCenterInfo(event) {
            event.preventDefault();
            centerInfo = { name: document.getElementById('centerName').value.trim(), phone: document.getElementById('centerPhone').value.trim(), address: document.getElementById('centerAddress').value.trim(), email: document.getElementById('centerEmail').value.trim(), website: document.getElementById('centerWebsite').value.trim(), logo: centerInfo.logo || '' };
            saveData('centerInfo', centerInfo);
            showNotification('L∆∞u th√†nh c√¥ng!');
        }

        function loadCenterInfo() {
            document.getElementById('centerName').value = centerInfo.name || '';
            document.getElementById('centerPhone').value = centerInfo.phone || '';
            document.getElementById('centerAddress').value = centerInfo.address || '';
            document.getElementById('centerEmail').value = centerInfo.email || '';
            document.getElementById('centerWebsite').value = centerInfo.website || '';
            if (centerInfo.logo) document.getElementById('logoPreview').innerHTML = `<img src="${centerInfo.logo}">`;
        }

        function previewLogo(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                centerInfo.logo = e.target.result;
                document.getElementById('logoPreview').innerHTML = `<img src="${e.target.result}">`;
            };
            reader.readAsDataURL(file);
        }

        function saveBankInfo(event) {
            event.preventDefault();
            bankInfo = { bankName: document.getElementById('bankName').value.trim(), accountNumber: document.getElementById('bankAccount').value.trim(), accountName: document.getElementById('bankAccountName').value.trim(), branch: document.getElementById('bankBranch').value.trim() };
            saveData('bankInfo', bankInfo);
            generateBankQR();
            showNotification('L∆∞u th√†nh c√¥ng!');
        }

        function loadBankInfo() {
            document.getElementById('bankName').value = bankInfo.bankName || '';
            document.getElementById('bankAccount').value = bankInfo.accountNumber || '';
            document.getElementById('bankAccountName').value = bankInfo.accountName || '';
            document.getElementById('bankBranch').value = bankInfo.branch || '';
            document.getElementById('autoBackupToggle').checked = autoBackupEnabled;
            updateAutoBackupStatus();
            generateBankQR();
        }

        function generateBankQR() {
            const container = document.getElementById('bankQRCode');
            if (!bankInfo.accountNumber || !bankInfo.bankName) {
                container.innerHTML = '<p class="text-muted">Nh·∫≠p th√¥ng tin ng√¢n h√†ng ƒë·ªÉ t·∫°o QR</p>';
                return;
            }

            // T·∫°o n·ªôi dung QR (VietQR format ƒë∆°n gi·∫£n)
            const qrContent = `${bankInfo.bankName}|${bankInfo.accountNumber}|${bankInfo.accountName || ''}`;

            container.innerHTML = '';
            try {
                new QRCode(container, {
                    text: qrContent,
                    width: 150,
                    height: 150,
                    colorDark: '#2C3E50',
                    colorLight: '#ffffff'
                });
            } catch (e) {
                container.innerHTML = '<p class="text-muted">Kh√¥ng th·ªÉ t·∫°o QR</p>';
            }
        }

        function clearAllData() {
            if (!confirm('‚ö†Ô∏è C·∫¢NH B√ÅO: X√≥a TO√ÄN B·ªò d·ªØ li·ªáu?\n\nH√†nh ƒë·ªông n√†y KH√îNG TH·ªÇ ho√†n t√°c!\n\nB·∫°n c√≥ ch·∫Øc ch·∫Øn?')) return;
            if (!confirm('X√°c nh·∫≠n l·∫ßn cu·ªëi: X√ìA T·∫§T C·∫¢?')) return;

            // X√≥a T·∫§T C·∫¢ d·ªØ li·ªáu (gi·ªØ l·∫°i users v√† permissions)
            students = [];
            appointments = [];
            registrations = [];
            receipts = [];
            packages = [];
            promotions = [];
            backupHistory = [];

            // X√≥a th√™m ph·∫ßn ƒê√†o t·∫°o
            teachers = [];
            classes = [];
            classSchedules = [];
            classStudents = [];
            attendances = [];
            makeupRequests = [];

            // L∆∞u v√†o localStorage
            const keysToReset = [
                'students', 'appointments', 'registrations', 'receipts',
                'packages', 'promotions', 'backupHistory',
                'teachers', 'classes', 'classSchedules', 'classStudents',
                'attendances', 'makeupRequests'
            ];

            keysToReset.forEach(key => {
                localStorage.setItem(key, JSON.stringify([]));
            });

            // Reset centerInfo v√† bankInfo
            centerInfo = {};
            bankInfo = {};
            localStorage.setItem('centerInfo', JSON.stringify({}));
            localStorage.setItem('bankInfo', JSON.stringify({}));

            showNotification('ƒê√£ x√≥a to√†n b·ªô d·ªØ li·ªáu!', 'warning');
            renderAll();
        }

        function clearDemoData() {
            if (!confirm('‚ö†Ô∏è X√≥a d·ªØ li·ªáu DEMO?\n\nS·∫Ω x√≥a: H·ªçc vi√™n, L·ªãch h·∫πn, Phi·∫øu ƒêK, Bi√™n lai, Gi√°o vi√™n, L·ªõp h·ªçc, ƒêi·ªÉm danh, H·ªçc b√π.\n\nGi·ªØ l·∫°i: T√†i kho·∫£n, Ph√¢n quy·ªÅn, M√¥n h·ªçc, C√†i ƒë·∫∑t.\n\nB·∫°n c√≥ ch·∫Øc ch·∫Øn?')) return;

            // X√≥a d·ªØ li·ªáu demo (gi·ªØ l·∫°i c·∫•u h√¨nh h·ªá th·ªëng)
            students = [];
            appointments = [];
            registrations = [];
            receipts = [];

            // X√≥a ph·∫ßn ƒê√†o t·∫°o
            teachers = [];
            classes = [];
            classSchedules = [];
            classStudents = [];
            attendances = [];
            makeupRequests = [];

            // L∆∞u v√†o localStorage
            const keysToReset = [
                'students', 'appointments', 'registrations', 'receipts',
                'teachers', 'classes', 'classSchedules', 'classStudents',
                'attendances', 'makeupRequests'
            ];

            keysToReset.forEach(key => {
                localStorage.setItem(key, JSON.stringify([]));
            });

            showNotification('ƒê√£ x√≥a d·ªØ li·ªáu demo! Gi·ªØ l·∫°i: T√†i kho·∫£n, M√¥n h·ªçc, G√≥i h·ªçc ph√≠, Khuy·∫øn m√£i, C√†i ƒë·∫∑t.', 'success');
            renderAll();
        }

        /* ============================================================
        üé≤ PH·∫¶N 31: T·∫†O D·ªÆ LI·ªÜU DEMO
        ============================================================ */

        function generateDemoData() {
            if (!confirm('üé≤ T·∫°o d·ªØ li·ªáu Demo?\n\nL∆∞u √Ω: D·ªØ li·ªáu hi·ªán t·∫°i s·∫Ω ƒë∆∞·ª£c GI·ªÆ NGUY√äN, d·ªØ li·ªáu demo s·∫Ω ƒë∆∞·ª£c TH√äM V√ÄO.\n\nB·∫°n c√≥ mu·ªën ti·∫øp t·ª•c?')) return;

            showNotification('ƒêang t·∫°o d·ªØ li·ªáu demo...', 'info');

            try {
                // ===== 1. T·∫†O H·ªåC VI√äN =====
                const demoStudents = [
                    { name: 'Nguy·ªÖn Minh Anh', age: 7, parentName: 'Nguy·ªÖn VƒÉn H√πng', parentPhone: '0901234001', parentEmail: 'hung.nv@gmail.com', subjects: ['C·ªù Vua', 'V·∫Ω Tranh'], status: 'ƒê√£ ƒêƒÉng K√Ω', notes: 'B√© h·ªçc nhanh, chƒÉm ch·ªâ' },
                    { name: 'Tr·∫ßn Gia B·∫£o', age: 8, parentName: 'Tr·∫ßn Th·ªã Mai', parentPhone: '0901234002', parentEmail: 'mai.tt@gmail.com', subjects: ['C·ªù Vua'], status: 'ƒê√£ ƒêƒÉng K√Ω', notes: '' },
                    { name: 'L√™ Th·ªã C·∫©m T√∫', age: 6, parentName: 'L√™ VƒÉn Nam', parentPhone: '0901234003', parentEmail: '', subjects: ['V·∫Ω Tranh', 'Ti·ªÅn Ti·ªÉu H·ªçc'], status: 'ƒê√£ ƒêƒÉng K√Ω', notes: 'B√© th√≠ch v·∫Ω' },
                    { name: 'Ph·∫°m ƒê·ª©c Duy', age: 9, parentName: 'Ph·∫°m Th·ªã Lan', parentPhone: '0901234004', parentEmail: 'lan.pt@gmail.com', subjects: ['C·ªù Vua'], status: 'ƒê√£ ƒêƒÉng K√Ω', notes: '' },
                    { name: 'Ho√†ng Th·ªã Mai', age: 5, parentName: 'Ho√†ng VƒÉn T√πng', parentPhone: '0901234005', parentEmail: '', subjects: ['Ti·ªÅn Ti·ªÉu H·ªçc'], status: 'ƒê√£ ƒêƒÉng K√Ω', notes: 'Chu·∫©n b·ªã v√†o l·ªõp 1' },
                    { name: 'V√µ Minh Kh√¥i', age: 7, parentName: 'V√µ Th·ªã H∆∞∆°ng', parentPhone: '0901234006', parentEmail: 'huong.vt@gmail.com', subjects: ['R√®n Ch·ªØ', 'Ti·ªÅn Ti·ªÉu H·ªçc'], status: 'ƒê√£ ƒêƒÉng K√Ω', notes: '' },
                    { name: 'ƒê·∫∑ng Th√πy Linh', age: 8, parentName: 'ƒê·∫∑ng VƒÉn Phong', parentPhone: '0901234007', parentEmail: '', subjects: ['V·∫Ω Tranh'], status: 'Ch·ªù ƒêƒÉng K√Ω', notes: 'ƒê√£ h·ªçc th·ª≠, ch·ªù ƒë√≥ng ph√≠' },
                    { name: 'B√πi Qu·ªëc Huy', age: 6, parentName: 'B√πi Th·ªã Nga', parentPhone: '0901234008', parentEmail: 'nga.bt@gmail.com', subjects: ['C·ªù Vua'], status: 'Ch·ªù ƒêƒÉng K√Ω', notes: '' },
                    { name: 'Ng√¥ Thanh T√¢m', age: 7, parentName: 'Ng√¥ VƒÉn ƒê·ª©c', parentPhone: '0901234009', parentEmail: '', subjects: ['Ti·ªÅn Ti·ªÉu H·ªçc', 'R√®n Ch·ªØ'], status: 'H·ªçc Th·ª≠', notes: 'H·∫πn h·ªçc th·ª≠ ng√†y mai' },
                    { name: 'ƒêinh H·ªìng Ng·ªçc', age: 5, parentName: 'ƒêinh Th·ªã Th·∫£o', parentPhone: '0901234010', parentEmail: 'thao.dt@gmail.com', subjects: ['V·∫Ω Tranh'], status: 'H·ªçc Th·ª≠', notes: '' },
                    { name: 'L√Ω Minh Ph√∫c', age: 8, parentName: 'L√Ω VƒÉn B√¨nh', parentPhone: '0901234011', parentEmail: '', subjects: ['C·ªù Vua'], status: 'H·ªçc Th·ª≠', notes: 'B·∫°n b√© Gia B·∫£o gi·ªõi thi·ªáu' },
                    { name: 'Tr∆∞∆°ng Th·ªã Qu·ª≥nh', age: 6, parentName: 'Tr∆∞∆°ng VƒÉn H·∫£i', parentPhone: '0901234012', parentEmail: 'hai.tv@gmail.com', subjects: ['Ti·ªÅn Ti·ªÉu H·ªçc'], status: 'Ho√†n Th√†nh', notes: 'ƒê√£ ho√†n th√†nh kh√≥a' },
                    { name: 'Phan ƒê√¨nh S∆°n', age: 9, parentName: 'Phan Th·ªã Hoa', parentPhone: '0901234013', parentEmail: '', subjects: ['C·ªù Vua', 'R√®n Ch·ªØ'], status: 'Ho√†n Th√†nh', notes: '' },
                    { name: 'Cao Th·ªã Uy√™n', age: 7, parentName: 'Cao VƒÉn Long', parentPhone: '0901234014', parentEmail: 'long.cv@gmail.com', subjects: ['V·∫Ω Tranh'], status: 'Cancel', notes: 'Chuy·ªÉn nh√†' },
                    { name: 'Mai Xu√¢n V≈©', age: 6, parentName: 'Mai Th·ªã Y·∫øn', parentPhone: '0901234015', parentEmail: '', subjects: ['Ti·ªÅn Ti·ªÉu H·ªçc'], status: 'ƒê√£ ƒêƒÉng K√Ω', notes: '' }
                ];

                const studentIds = [];
                const today = new Date();

                demoStudents.forEach((s, index) => {
                    const createdDate = new Date(today);
                    createdDate.setDate(createdDate.getDate() - Math.floor(Math.random() * 60)); // Random trong 60 ng√†y

                    const newStudent = {
                        id: 'demo_student_' + (index + 1),
                        ...s,
                        previousStatus: null,
                        createdAt: createdDate.toISOString(),
                        updatedAt: createdDate.toISOString()
                    };
                    students.push(newStudent);
                    studentIds.push(newStudent.id);
                });

                // ===== 2. T·∫†O GI√ÅO VI√äN =====
                const demoTeachers = [
                    { fullName: 'Nguy·ªÖn VƒÉn Minh', phone: '0911234001', email: 'minh.gv@gmail.com', subjects: ['C·ªù Vua'], salaryType: 'per_session', fixedSalary: 0, perSessionRate: 200000 },
                    { fullName: 'Tr·∫ßn Th·ªã H·ªìng', phone: '0911234002', email: 'hong.gv@gmail.com', subjects: ['V·∫Ω Tranh'], salaryType: 'both', fixedSalary: 3000000, perSessionRate: 150000 },
                    { fullName: 'L√™ VƒÉn Th√†nh', phone: '0911234003', email: 'thanh.gv@gmail.com', subjects: ['Ti·ªÅn Ti·ªÉu H·ªçc', 'R√®n Ch·ªØ'], salaryType: 'fixed', fixedSalary: 8000000, perSessionRate: 0 },
                    { fullName: 'Ph·∫°m Th·ªã Ng·ªçc', phone: '0911234004', email: 'ngoc.gv@gmail.com', subjects: ['C·ªù Vua', 'Ti·ªÅn Ti·ªÉu H·ªçc'], salaryType: 'per_session', fixedSalary: 0, perSessionRate: 180000 }
                ];

                const teacherIds = [];
                demoTeachers.forEach((t, index) => {
                    const newTeacher = {
                        id: 'demo_teacher_' + (index + 1),
                        ...t,
                        status: 'active',
                        notes: '',
                        createdAt: new Date().toISOString()
                    };
                    teachers.push(newTeacher);
                    teacherIds.push(newTeacher.id);
                });

                // ===== 3. T·∫†O L·ªöP H·ªåC =====
                const subjectMap = {};
                subjects.forEach(s => { subjectMap[s.name] = s.id; });

                const demoClasses = [
                    { className: 'C·ªù Vua - L·ªõp A1', subjectName: 'C·ªù Vua', teacherIndex: 0, classType: 'group', maxStudents: 10 },
                    { className: 'C·ªù Vua - L·ªõp A2', subjectName: 'C·ªù Vua', teacherIndex: 3, classType: 'group', maxStudents: 8 },
                    { className: 'V·∫Ω Tranh - L·ªõp B1', subjectName: 'V·∫Ω Tranh', teacherIndex: 1, classType: 'group', maxStudents: 12 },
                    { className: 'Ti·ªÅn Ti·ªÉu H·ªçc - L·ªõp C1', subjectName: 'Ti·ªÅn Ti·ªÉu H·ªçc', teacherIndex: 2, classType: 'group', maxStudents: 10 },
                    { className: 'R√®n Ch·ªØ - L·ªõp D1', subjectName: 'R√®n Ch·ªØ', teacherIndex: 2, classType: 'group', maxStudents: 8 },
                    { className: 'C·ªù Vua - 1 k√®m 1 (B√© Duy)', subjectName: 'C·ªù Vua', teacherIndex: 0, classType: '1on1', maxStudents: 1 }
                ];

                const classIds = [];
                demoClasses.forEach((c, index) => {
                    const newClass = {
                        id: 'demo_class_' + (index + 1),
                        className: c.className,
                        subjectId: subjectMap[c.subjectName] || '',
                        teacherId: teacherIds[c.teacherIndex],
                        classType: c.classType,
                        maxStudents: c.maxStudents,
                        status: 'active',
                        notes: '',
                        createdAt: new Date().toISOString()
                    };
                    classes.push(newClass);
                    classIds.push(newClass.id);
                });

                // ===== 4. T·∫†O CA H·ªåC =====
                const demoSchedules = [
                    // C·ªù Vua A1: T7, CN s√°ng
                    { classIndex: 0, dayOfWeek: 6, startTime: '08:30', endTime: '10:00', room: 'Ph√≤ng A1' },
                    { classIndex: 0, dayOfWeek: 7, startTime: '08:30', endTime: '10:00', room: 'Ph√≤ng A1' },
                    // C·ªù Vua A2: T7, CN chi·ªÅu
                    { classIndex: 1, dayOfWeek: 6, startTime: '15:00', endTime: '16:30', room: 'Ph√≤ng A1' },
                    { classIndex: 1, dayOfWeek: 7, startTime: '15:00', endTime: '16:30', room: 'Ph√≤ng A1' },
                    // V·∫Ω Tranh B1: T3, T5
                    { classIndex: 2, dayOfWeek: 2, startTime: '17:00', endTime: '18:30', room: 'Ph√≤ng B1' },
                    { classIndex: 2, dayOfWeek: 4, startTime: '17:00', endTime: '18:30', room: 'Ph√≤ng B1' },
                    // Ti·ªÅn Ti·ªÉu H·ªçc C1: T2, T4, T6
                    { classIndex: 3, dayOfWeek: 1, startTime: '09:00', endTime: '10:30', room: 'Ph√≤ng C1' },
                    { classIndex: 3, dayOfWeek: 3, startTime: '09:00', endTime: '10:30', room: 'Ph√≤ng C1' },
                    { classIndex: 3, dayOfWeek: 5, startTime: '09:00', endTime: '10:30', room: 'Ph√≤ng C1' },
                    // R√®n Ch·ªØ D1: T2, T4
                    { classIndex: 4, dayOfWeek: 1, startTime: '14:00', endTime: '15:30', room: 'Ph√≤ng D1' },
                    { classIndex: 4, dayOfWeek: 3, startTime: '14:00', endTime: '15:30', room: 'Ph√≤ng D1' },
                    // 1 k√®m 1: T3, T5
                    { classIndex: 5, dayOfWeek: 2, startTime: '10:00', endTime: '11:30', room: 'Ph√≤ng VIP' },
                    { classIndex: 5, dayOfWeek: 4, startTime: '10:00', endTime: '11:30', room: 'Ph√≤ng VIP' }
                ];

                const scheduleIds = [];
                demoSchedules.forEach((s, index) => {
                    const newSchedule = {
                        id: 'demo_schedule_' + (index + 1),
                        classId: classIds[s.classIndex],
                        dayOfWeek: s.dayOfWeek,
                        startTime: s.startTime,
                        endTime: s.endTime,
                        room: s.room,
                        isActive: true,
                        createdAt: new Date().toISOString()
                    };
                    classSchedules.push(newSchedule);
                    scheduleIds.push(newSchedule.id);
                });

                // ===== 5. T·∫†O PHI·∫æU ƒêƒÇNG K√ù =====
                const demoRegistrations = [
                    { studentIndex: 0, subject: 'C·ªù Vua', tuitionFee: 2000000, discountAmount: 200000, finalAmount: 1800000 },
                    { studentIndex: 0, subject: 'V·∫Ω Tranh', tuitionFee: 1800000, discountAmount: 0, finalAmount: 1800000 },
                    { studentIndex: 1, subject: 'C·ªù Vua', tuitionFee: 2000000, discountAmount: 0, finalAmount: 2000000 },
                    { studentIndex: 2, subject: 'V·∫Ω Tranh', tuitionFee: 1800000, discountAmount: 100000, finalAmount: 1700000 },
                    { studentIndex: 2, subject: 'Ti·ªÅn Ti·ªÉu H·ªçc', tuitionFee: 1500000, discountAmount: 0, finalAmount: 1500000 },
                    { studentIndex: 3, subject: 'C·ªù Vua', tuitionFee: 2000000, discountAmount: 0, finalAmount: 2000000 },
                    { studentIndex: 4, subject: 'Ti·ªÅn Ti·ªÉu H·ªçc', tuitionFee: 1500000, discountAmount: 150000, finalAmount: 1350000 },
                    { studentIndex: 5, subject: 'R√®n Ch·ªØ', tuitionFee: 1600000, discountAmount: 0, finalAmount: 1600000 },
                    { studentIndex: 5, subject: 'Ti·ªÅn Ti·ªÉu H·ªçc', tuitionFee: 1500000, discountAmount: 0, finalAmount: 1500000 },
                    { studentIndex: 11, subject: 'Ti·ªÅn Ti·ªÉu H·ªçc', tuitionFee: 1500000, discountAmount: 0, finalAmount: 1500000 },
                    { studentIndex: 12, subject: 'C·ªù Vua', tuitionFee: 2000000, discountAmount: 0, finalAmount: 2000000 },
                    { studentIndex: 14, subject: 'Ti·ªÅn Ti·ªÉu H·ªçc', tuitionFee: 1500000, discountAmount: 0, finalAmount: 1500000 }
                ];

                const regIds = [];
                demoRegistrations.forEach((r, index) => {
                    const student = students.find(s => s.id === studentIds[r.studentIndex]);
                    const regDate = new Date(today);
                    regDate.setDate(regDate.getDate() - Math.floor(Math.random() * 30));

                    const newReg = {
                        id: 'demo_reg_' + (index + 1),
                        regCode: 'DK' + (today.getFullYear() % 100) + String(today.getMonth() + 1).padStart(2, '0') + '-' + String(index + 1).padStart(3, '0'),
                        studentId: studentIds[r.studentIndex],
                        studentName: student ? student.name : '',
                        parentName: student ? student.parentName : '',
                        parentPhone: student ? student.parentPhone : '',
                        subject: r.subject,
                        packageId: null,
                        tuitionFee: r.tuitionFee,
                        promotionIds: [],
                        discountAmount: r.discountAmount,
                        finalAmount: r.finalAmount,
                        registrationDate: regDate.toISOString().split('T')[0],
                        createdAt: regDate.toISOString()
                    };
                    registrations.push(newReg);
                    regIds.push(newReg.id);
                });

                // ===== 6. G√ÅN H·ªåC VI√äN V√ÄO L·ªöP =====
                const classStudentData = [
                    { regIndex: 0, classIndex: 0, totalSessions: 16, completedSessions: 8, remainingSessions: 8 },
                    { regIndex: 1, classIndex: 2, totalSessions: 12, completedSessions: 4, remainingSessions: 8 },
                    { regIndex: 2, classIndex: 0, totalSessions: 16, completedSessions: 10, remainingSessions: 6 },
                    { regIndex: 3, classIndex: 2, totalSessions: 12, completedSessions: 6, remainingSessions: 6 },
                    { regIndex: 4, classIndex: 3, totalSessions: 20, completedSessions: 12, remainingSessions: 8 },
                    { regIndex: 5, classIndex: 5, totalSessions: 8, completedSessions: 5, remainingSessions: 3 },
                    { regIndex: 6, classIndex: 3, totalSessions: 20, completedSessions: 18, remainingSessions: 2 },
                    { regIndex: 7, classIndex: 4, totalSessions: 16, completedSessions: 14, remainingSessions: 2 },
                    { regIndex: 8, classIndex: 3, totalSessions: 20, completedSessions: 5, remainingSessions: 15 },
                    { regIndex: 9, classIndex: 3, totalSessions: 20, completedSessions: 20, remainingSessions: 0 },
                    { regIndex: 10, classIndex: 1, totalSessions: 16, completedSessions: 16, remainingSessions: 0 },
                    { regIndex: 11, classIndex: 3, totalSessions: 20, completedSessions: 3, remainingSessions: 17 }
                ];

                const classStudentIds = [];
                classStudentData.forEach((cs, index) => {
                    const reg = registrations.find(r => r.id === regIds[cs.regIndex]);
                    const newCS = {
                        id: 'demo_cs_' + (index + 1),
                        classId: classIds[cs.classIndex],
                        studentId: reg ? reg.studentId : '',
                        registrationId: regIds[cs.regIndex],
                        totalSessions: cs.totalSessions,
                        completedSessions: cs.completedSessions,
                        remainingSessions: cs.remainingSessions,
                        status: cs.remainingSessions === 0 ? 'completed' : 'active',
                        enrolledAt: new Date().toISOString()
                    };
                    classStudents.push(newCS);
                    classStudentIds.push(newCS.id);
                });

                // ===== 7. T·∫†O BI√äN LAI =====
                const demoReceipts = [
                    { regIndex: 0, amount: 1800000, type: 'Bi√™n Lai ƒêi·ªán T·ª≠', daysAgo: 25 }, // ƒê√≥ng ƒë·ªß
                    { regIndex: 1, amount: 1000000, type: 'Phi·∫øu Thu', daysAgo: 20 }, // ƒê√≥ng 1 ph·∫ßn
                    { regIndex: 2, amount: 2000000, type: 'Bi√™n Lai ƒêi·ªán T·ª≠', daysAgo: 28 }, // ƒê√≥ng ƒë·ªß
                    { regIndex: 3, amount: 1700000, type: 'Bi√™n Lai ƒêi·ªán T·ª≠', daysAgo: 22 }, // ƒê√≥ng ƒë·ªß
                    { regIndex: 4, amount: 1500000, type: 'Phi·∫øu Thu', daysAgo: 30 }, // ƒê√≥ng ƒë·ªß
                    { regIndex: 5, amount: 1000000, type: 'Bi√™n Lai ƒêi·ªán T·ª≠', daysAgo: 15 }, // ƒê√≥ng 1 ph·∫ßn
                    { regIndex: 6, amount: 1350000, type: 'Phi·∫øu Thu', daysAgo: 35 }, // ƒê√≥ng ƒë·ªß
                    { regIndex: 9, amount: 1500000, type: 'Bi√™n Lai ƒêi·ªán T·ª≠', daysAgo: 45 } // ƒê√≥ng ƒë·ªß
                ];

                demoReceipts.forEach((r, index) => {
                    const reg = registrations.find(reg => reg.id === regIds[r.regIndex]);
                    const receiptDate = new Date(today);
                    receiptDate.setDate(receiptDate.getDate() - r.daysAgo);

                    const newReceipt = {
                        id: 'demo_receipt_' + (index + 1),
                        studentId: reg ? reg.studentId : '',
                        registrationId: regIds[r.regIndex],
                        type: r.type,
                        description: `Thanh to√°n h·ªçc ph√≠ - ${reg ? reg.subject : ''} - ${reg ? reg.regCode : ''}`,
                        amount: r.amount,
                        date: receiptDate.toISOString().split('T')[0],
                        notes: '',
                        parentName: reg ? reg.parentName : '',
                        parentPhone: reg ? reg.parentPhone : '',
                        createdBy: currentUser ? currentUser.id : '',
                        createdAt: receiptDate.toISOString()
                    };
                    receipts.push(newReceipt);
                });

                // ===== 8. T·∫†O L·ªäCH H·∫∏N =====
                const demoAppointments = [
                    { studentIndex: 8, subject: 'Ti·ªÅn Ti·ªÉu H·ªçc', daysFromNow: 1 },
                    { studentIndex: 9, subject: 'V·∫Ω Tranh', daysFromNow: 2 },
                    { studentIndex: 10, subject: 'C·ªù Vua', daysFromNow: 3 },
                    { studentIndex: 7, subject: 'C·ªù Vua', daysFromNow: -2 },
                    { studentIndex: 6, subject: 'V·∫Ω Tranh', daysFromNow: -5 }
                ];

                demoAppointments.forEach((a, index) => {
                    const aptDate = new Date(today);
                    aptDate.setDate(aptDate.getDate() + a.daysFromNow);

                    const newApt = {
                        id: 'demo_apt_' + (index + 1),
                        studentId: studentIds[a.studentIndex],
                        subject: a.subject,
                        date: aptDate.toISOString().split('T')[0],
                        time: '09:00',
                        notes: a.daysFromNow < 0 ? 'ƒê√£ h·ªçc th·ª≠' : 'H·∫πn h·ªçc th·ª≠',
                        createdAt: new Date().toISOString()
                    };
                    appointments.push(newApt);
                });

                // ===== 9. T·∫†O ƒêI·ªÇM DANH =====
                const attendanceStatuses = ['present', 'present', 'present', 'present', 'late', 'absent', 'excused'];

                // ƒêi·ªÉm danh cho c√°c l·ªõp trong 2 tu·∫ßn g·∫ßn ƒë√¢y
                for (let daysAgo = 14; daysAgo >= 0; daysAgo--) {
                    const attDate = new Date(today);
                    attDate.setDate(attDate.getDate() - daysAgo);
                    const dayOfWeek = attDate.getDay() === 0 ? 7 : attDate.getDay();

                    // T√¨m c√°c ca h·ªçc v√†o ng√†y n√†y
                    classSchedules.forEach(schedule => {
                        if (schedule.dayOfWeek !== dayOfWeek) return;
                        if (!schedule.id.startsWith('demo_')) return;

                        // L·∫•y h·ªçc vi√™n trong l·ªõp n√†y
                        const csInClass = classStudents.filter(cs => cs.classId === schedule.classId && cs.id.startsWith('demo_'));

                        csInClass.forEach(cs => {
                            // Random tr·∫°ng th√°i
                            const status = attendanceStatuses[Math.floor(Math.random() * attendanceStatuses.length)];

                            const newAttendance = {
                                id: 'demo_att_' + generateId(),
                                classId: schedule.classId,
                                scheduleId: schedule.id,
                                studentId: cs.studentId,
                                classStudentId: cs.id,
                                attendanceDate: attDate.toISOString().split('T')[0],
                                status: status,
                                notes: status === 'late' ? 'Mu·ªôn 10 ph√∫t' : '',
                                isMakeupSession: false,
                                makeupRequestId: null,
                                createdBy: currentUser ? currentUser.id : '',
                                createdAt: attDate.toISOString()
                            };
                            attendances.push(newAttendance);
                        });
                    });
                }

                // ===== 10. T·∫†O Y√äU C·∫¶U H·ªåC B√ô =====
                const excusedAttendances = attendances.filter(a => a.status === 'excused' && a.id.startsWith('demo_att_')).slice(0, 3);

                excusedAttendances.forEach((att, index) => {
                    const expiryDate = new Date(att.attendanceDate);
                    expiryDate.setDate(expiryDate.getDate() + 30);

                    const statuses = ['pending', 'approved', 'completed'];
                    const status = statuses[index % 3];

                    const makeupDate = new Date(today);
                    makeupDate.setDate(makeupDate.getDate() + 3 + index);

                    const newMakeup = {
                        id: 'demo_makeup_' + (index + 1),
                        studentId: att.studentId,
                        classStudentId: att.classStudentId,
                        originalAttendanceId: att.id,
                        originalClassId: att.classId,
                        originalScheduleId: att.scheduleId,
                        originalDate: att.attendanceDate,
                        requestDate: att.attendanceDate,
                        expiryDate: expiryDate.toISOString().split('T')[0],
                        makeupClassId: status !== 'pending' ? att.classId : null,
                        makeupScheduleId: status !== 'pending' ? att.scheduleId : null,
                        makeupDate: status !== 'pending' ? makeupDate.toISOString().split('T')[0] : null,
                        status: status,
                        approvedBy: status !== 'pending' ? (currentUser ? currentUser.id : '') : null,
                        approvedAt: status !== 'pending' ? new Date().toISOString() : null,
                        completedAt: status === 'completed' ? new Date().toISOString() : null,
                        notes: '',
                        isPreCreated: false,
                        createdAt: att.attendanceDate
                    };
                    makeupRequests.push(newMakeup);
                });

                // ===== L∆ØU T·∫§T C·∫¢ =====
                saveData('students', students);
                saveData('teachers', teachers);
                saveData('classes', classes);
                saveData('classSchedules', classSchedules);
                saveData('classStudents', classStudents);
                saveData('registrations', registrations);
                saveData('receipts', receipts);
                saveData('appointments', appointments);
                saveData('attendances', attendances);
                saveData('makeupRequests', makeupRequests);

                // Render l·∫°i giao di·ªán
                renderAll();

                showNotification('üéâ ƒê√£ t·∫°o d·ªØ li·ªáu Demo th√†nh c√¥ng!', 'success');

                // Hi·ªÉn th·ªã th·ªëng k√™
                setTimeout(() => {
                    alert(`‚úÖ ƒê√É T·∫†O D·ªÆ LI·ªÜU DEMO:\n\n` +
                        `‚Ä¢ H·ªçc vi√™n: ${demoStudents.length}\n` +
                        `‚Ä¢ Gi√°o vi√™n: ${demoTeachers.length}\n` +
                        `‚Ä¢ L·ªõp h·ªçc: ${demoClasses.length}\n` +
                        `‚Ä¢ Ca h·ªçc: ${demoSchedules.length}\n` +
                        `‚Ä¢ Phi·∫øu ƒêK: ${demoRegistrations.length}\n` +
                        `‚Ä¢ Bi√™n lai: ${demoReceipts.length}\n` +
                        `‚Ä¢ L·ªãch h·∫πn: ${demoAppointments.length}\n` +
                        `‚Ä¢ ƒêi·ªÉm danh: ${attendances.filter(a => a.id.startsWith('demo_')).length}\n` +
                        `‚Ä¢ Y√™u c·∫ßu h·ªçc b√π: ${excusedAttendances.length}\n\n` +
                        `B·∫°n c√≥ th·ªÉ b·∫Øt ƒë·∫ßu test c√°c ch·ª©c nƒÉng!`);
                }, 500);

            } catch (error) {
                console.error('L·ªói t·∫°o d·ªØ li·ªáu demo:', error);
                showNotification('C√≥ l·ªói khi t·∫°o d·ªØ li·ªáu demo: ' + error.message, 'error');
            }
        }

        /* ============================================================
           üîß PH·∫¶N 19: UTILITY FUNCTIONS (H√†m ti·ªán √≠ch)
           ============================================================ */

        // ===== 19.1 Format ti·ªÅn t·ªá =====
        function formatCurrency(amount) {
            if (amount === null || amount === undefined || isNaN(amount)) return '0 ‚Ç´';
            return new Intl.NumberFormat('vi-VN').format(amount) + ' ‚Ç´';
        }

        function formatCurrencyShort(amount) {
            if (amount === null || amount === undefined || isNaN(amount)) return '0';
            if (amount >= 1000000000) return (amount / 1000000000).toFixed(1) + 't·ª∑';
            if (amount >= 1000000) return (amount / 1000000).toFixed(1) + 'tr';
            if (amount >= 1000) return (amount / 1000).toFixed(0) + 'k';
            return amount.toString();
        }

        function formatNumberInput(number) {
            if (!number && number !== 0) return '';
            return new Intl.NumberFormat('vi-VN').format(number);
        }

        function parseCurrencyInput(value) {
            if (!value) return 0;
            // Lo·∫°i b·ªè t·∫•t c·∫£ k√Ω t·ª± kh√¥ng ph·∫£i s·ªë
            const cleaned = value.toString().replace(/[^\d]/g, '');
            return parseInt(cleaned) || 0;
        }

        function formatCurrencyInput(input) {
            // L·∫•y v·ªã tr√≠ con tr·ªè
            const cursorPos = input.selectionStart;
            const oldLength = input.value.length;

            // Parse v√† format l·∫°i
            const value = parseCurrencyInput(input.value);
            input.value = value > 0 ? formatNumberInput(value) : '';

            // ƒêi·ªÅu ch·ªânh v·ªã tr√≠ con tr·ªè
            const newLength = input.value.length;
            const newPos = cursorPos + (newLength - oldLength);
            input.setSelectionRange(newPos, newPos);
        }

        // ===== 19.2 Format ng√†y th√°ng =====
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return dateString;
            return date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }

        function formatDateTime(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return dateString;
            return date.toLocaleString('vi-VN', {
                day: '2-digit', month: '2-digit', year: 'numeric',
                hour: '2-digit', minute: '2-digit'
            });
        }

        function formatDateFile() {
            const now = new Date();
            const y = now.getFullYear();
            const m = String(now.getMonth() + 1).padStart(2, '0');
            const d = String(now.getDate()).padStart(2, '0');
            const h = String(now.getHours()).padStart(2, '0');
            const min = String(now.getMinutes()).padStart(2, '0');
            return `${y}${m}${d}_${h}${min}`;
        }

        /* ============================================================
           üìÑ PH·∫¶N 20: PAGINATION (Ph√¢n trang)
           ============================================================ */

        function getPaginatedData(data, stateKey) {
            const state = paginationState[stateKey];
            if (!state) return { data: data, total: data.length, totalPages: 1, currentPage: 1 };

            const total = data.length;
            const totalPages = Math.ceil(total / state.pageSize) || 1;
            const currentPage = Math.min(state.page, totalPages);

            const startIndex = (currentPage - 1) * state.pageSize;
            const endIndex = startIndex + state.pageSize;
            const paginatedData = data.slice(startIndex, endIndex);

            return {
                data: paginatedData,
                total: total,
                totalPages: totalPages,
                currentPage: currentPage
            };
        }

        function renderPagination(containerId, stateKey, total, totalPages, currentPage) {
            const container = document.getElementById(containerId);
            if (!container) return;

            const state = paginationState[stateKey];
            if (!state) return;

            const startItem = total === 0 ? 0 : (currentPage - 1) * state.pageSize + 1;
            const endItem = Math.min(currentPage * state.pageSize, total);

            let paginationHTML = '';

            // N√∫t Previous
            paginationHTML += `<button ${currentPage <= 1 ? 'disabled' : ''} onclick="changePage('${stateKey}', ${currentPage - 1})">‚Äπ</button>`;

            // C√°c n√∫t s·ªë trang
            const maxButtons = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
            let endPage = Math.min(totalPages, startPage + maxButtons - 1);

            if (endPage - startPage + 1 < maxButtons) {
                startPage = Math.max(1, endPage - maxButtons + 1);
            }

            if (startPage > 1) {
                paginationHTML += `<button onclick="changePage('${stateKey}', 1)">1</button>`;
                if (startPage > 2) paginationHTML += `<button disabled>...</button>`;
            }

            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `<button class="${i === currentPage ? 'active' : ''}" onclick="changePage('${stateKey}', ${i})">${i}</button>`;
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) paginationHTML += `<button disabled>...</button>`;
                paginationHTML += `<button onclick="changePage('${stateKey}', ${totalPages})">${totalPages}</button>`;
            }

            // N√∫t Next
            paginationHTML += `<button ${currentPage >= totalPages ? 'disabled' : ''} onclick="changePage('${stateKey}', ${currentPage + 1})">‚Ä∫</button>`;

            container.innerHTML = `
        <div class="pagination-info">Hi·ªÉn th·ªã ${startItem}-${endItem} / ${total}</div>
        <div class="pagination">${paginationHTML}</div>
        <div class="page-size-select">
            Hi·ªÉn th·ªã: 
            <select onchange="changePageSize('${stateKey}', this.value)">
                ${CONFIG.PAGE_SIZE_OPTIONS.map(size =>
                `<option value="${size}" ${size === state.pageSize ? 'selected' : ''}>${size}</option>`
            ).join('')}
            </select>
        </div>
    `;
        }

        function changePage(stateKey, page) {
            if (paginationState[stateKey]) {
                paginationState[stateKey].page = page;

                // X·ª≠ l√Ω render theo t·ª´ng lo·∫°i b·∫£ng
                switch (stateKey) {
                    case 'students':
                        renderStudentsTable();
                        break;
                    case 'trial':
                        renderTrialStudentsTable();
                        break;
                    case 'appointments':
                        renderAppointmentsTable();
                        break;
                    case 'registrations':
                        renderRegistrationsTable();
                        break;
                    case 'receipts':
                        renderReceiptsTable();
                        break;
                    case 'teachers':
                        renderTeachersTable();
                        break;
                    case 'classes':
                        renderClassesTable();
                        break;
                    case 'makeup':
                        renderMakeupRequests();
                        break;
                    case 'attendanceHistory':
                        loadAttendanceHistory();
                        break;
                    case 'debts':
                        renderDebtsTable();
                        break;
                    default:
                        // Fallback cho c√°c tab kh√°c
                        renderTabContent(stateKey);
                }
            }
        }


        function changePageSize(stateKey, size) {
            if (paginationState[stateKey]) {
                paginationState[stateKey].pageSize = parseInt(size);
                paginationState[stateKey].page = 1; // Reset v·ªÅ trang 1

                // G·ªçi changePage ƒë·ªÉ render l·∫°i
                changePage(stateKey, 1);
            }
        }


        /* ============================================================
           üöÄ PH·∫¶N 21: RENDER ALL & INITIALIZATION
           ============================================================ */
        /* ============================================================
           üë®‚Äçüè´ PH·∫¶N 23: QU·∫¢N L√ù GI√ÅO VI√äN
           ============================================================ */

        // ===== 23.1 Render b·∫£ng gi√°o vi√™n =====
        function renderTeachersTable() {
            const tbody = document.getElementById('teachersTableBody');
            const searchTerm = document.getElementById('searchTeacher')?.value?.toLowerCase() || '';

            let filtered = teachers.filter(t =>
                t.fullName.toLowerCase().includes(searchTerm) ||
                t.phone.includes(searchTerm)
            );

            if (filtered.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6"><div class="empty-state"><div class="empty-state-icon">üë®‚Äçüè´</div><p>Ch∆∞a c√≥ gi√°o vi√™n n√†o</p></div></td></tr>`;
                return;
            }

            tbody.innerHTML = filtered.map(t => `
        <tr>
            <td><strong>${t.fullName}</strong></td>
            <td>${t.phone}</td>
            <td>${t.subjects.map(s => `<span class="subject-tag">${getSubjectIcon(s)} ${s}</span>`).join(' ')}</td>
            <td>${getSalaryTypeLabel(t.salaryType)}</td>
            <td><span class="status-badge ${t.status === 'active' ? 'active' : 'locked'}">${t.status === 'active' ? 'üü¢ ƒêang d·∫°y' : '‚ö´ Ngh·ªâ'}</span></td>
            <td>
                <div class="action-buttons">
                    <button class="action-btn view" onclick="viewTeacher('${t.id}')" title="Xem">üëÅÔ∏è</button>
                    ${canEdit('teachers') ? `<button class="action-btn edit" onclick="editTeacher('${t.id}')" title="S·ª≠a">‚úèÔ∏è</button>` : ''}
                    ${canDelete('teachers') ? `<button class="action-btn delete" onclick="deleteTeacher('${t.id}')" title="X√≥a">üóëÔ∏è</button>` : ''}
                </div>
            </td>
        </tr>
    `).join('');
        }

        function getSubjectIcon(subjectName) {
            const subject = subjects.find(s => s.name === subjectName);
            return subject ? subject.icon : 'üìñ';
        }

        function getSalaryTypeLabel(type) {
            const labels = {
                'fixed': 'üí∞ C·ªë ƒë·ªãnh',
                'per_session': 'üíµ Theo bu·ªïi',
                'both': 'üí≥ C·ªë ƒë·ªãnh + Bu·ªïi'
            };
            return labels[type] || type;
        }

        function searchTeachers() {
            renderTeachersTable();
        }

        // ===== 23.2 Modal Gi√°o vi√™n =====
        function openTeacherModal() {
            document.getElementById('editTeacherId').value = '';
            document.getElementById('teacherForm').reset();
            document.getElementById('teacherModalTitle').textContent = 'üë®‚Äçüè´ Th√™m Gi√°o Vi√™n';
            document.getElementById('teacherSalaryType').value = 'per_session';
            toggleSalaryFields();
            renderTeacherSubjectsCheckboxes();
            openModal('teacherModal');
        }

        function renderTeacherSubjectsCheckboxes() {
            document.getElementById('teacherSubjectsCheckboxes').innerHTML = subjects.map(s =>
                `<label class="checkbox-item"><input type="checkbox" name="teacherSubjects" value="${s.name}"> ${s.icon} ${s.name}</label>`
            ).join('');
        }

        function toggleSalaryFields() {
            const type = document.getElementById('teacherSalaryType').value;
            document.getElementById('fixedSalaryGroup').style.display = (type === 'fixed' || type === 'both') ? 'block' : 'none';
            document.getElementById('perSessionGroup').style.display = (type === 'per_session' || type === 'both') ? 'block' : 'none';
        }

        function editTeacher(id) {
            const teacher = teachers.find(t => t.id === id);
            if (!teacher) return;

            document.getElementById('editTeacherId').value = teacher.id;
            document.getElementById('teacherFullName').value = teacher.fullName;
            document.getElementById('teacherPhone').value = teacher.phone;
            document.getElementById('teacherEmail').value = teacher.email || '';
            document.getElementById('teacherSalaryType').value = teacher.salaryType;
            document.getElementById('teacherFixedSalary').value = teacher.fixedSalary ? formatNumberInput(teacher.fixedSalary) : '';
            document.getElementById('teacherPerSession').value = teacher.perSessionRate ? formatNumberInput(teacher.perSessionRate) : '';
            document.getElementById('teacherNotes').value = teacher.notes || '';

            renderTeacherSubjectsCheckboxes();
            document.querySelectorAll('input[name="teacherSubjects"]').forEach(cb => {
                cb.checked = teacher.subjects.includes(cb.value);
            });

            toggleSalaryFields();
            document.getElementById('teacherModalTitle').textContent = '‚úèÔ∏è S·ª≠a Gi√°o Vi√™n';
            openModal('teacherModal');
        }

        function saveTeacher(event) {
            event.preventDefault();

            const selectedSubjects = Array.from(document.querySelectorAll('input[name="teacherSubjects"]:checked')).map(cb => cb.value);
            if (selectedSubjects.length === 0) {
                showNotification('Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 m√¥n d·∫°y!', 'error');
                return;
            }

            const editId = document.getElementById('editTeacherId').value;
            const data = {
                fullName: document.getElementById('teacherFullName').value.trim(),
                phone: document.getElementById('teacherPhone').value.trim(),
                email: document.getElementById('teacherEmail').value.trim(),
                subjects: selectedSubjects,
                salaryType: document.getElementById('teacherSalaryType').value,
                fixedSalary: parseCurrencyInput(document.getElementById('teacherFixedSalary').value),
                perSessionRate: parseCurrencyInput(document.getElementById('teacherPerSession').value),
                notes: document.getElementById('teacherNotes').value.trim(),
                status: 'active'
            };

            if (editId) {
                const index = teachers.findIndex(t => t.id === editId);
                if (index !== -1) {
                    teachers[index] = { ...teachers[index], ...data, updatedAt: new Date().toISOString() };
                    showNotification('C·∫≠p nh·∫≠t gi√°o vi√™n th√†nh c√¥ng!', 'success');
                }
            } else {
                teachers.push({ id: generateId(), ...data, createdAt: new Date().toISOString() });
                showNotification('Th√™m gi√°o vi√™n th√†nh c√¥ng!', 'success');
            }

            saveData('teachers', teachers);
            closeModal('teacherModal');
            renderTeachersTable();
        }

        function deleteTeacher(id) {
            const teacher = teachers.find(t => t.id === id);
            if (!teacher) return;

            // Ki·ªÉm tra GV c√≥ ƒëang d·∫°y l·ªõp n√†o kh√¥ng
            const teachingClasses = classes.filter(c => c.teacherId === id && c.status === 'active');
            if (teachingClasses.length > 0) {
                showNotification(`Kh√¥ng th·ªÉ x√≥a! GV ƒëang d·∫°y ${teachingClasses.length} l·ªõp.`, 'error');
                return;
            }

            if (!confirm(`X√≥a gi√°o vi√™n "${teacher.fullName}"?`)) return;

            teachers = teachers.filter(t => t.id !== id);
            saveData('teachers', teachers);
            showNotification('ƒê√£ x√≥a gi√°o vi√™n!', 'success');
            renderTeachersTable();
        }

        function viewTeacher(id) {
            const teacher = teachers.find(t => t.id === id);
            if (!teacher) return;

            const teacherClasses = classes.filter(c => c.teacherId === id);

            let scheduleHTML = '';
            teacherClasses.forEach(cls => {
                const clsSchedules = classSchedules.filter(s => s.classId === cls.id);
                clsSchedules.forEach(sch => {
                    scheduleHTML += `<div class="quick-view-row"><span class="quick-view-label">${cls.className}</span><span class="quick-view-value">${getDayName(sch.dayOfWeek)} ${sch.startTime}-${sch.endTime}</span></div>`;
                });
            });

            document.getElementById('viewTeacherContent').innerHTML = `
        <div class="quick-view-section">
            <h4>üë§ Th√¥ng tin c√° nh√¢n</h4>
            <div class="quick-view-row"><span class="quick-view-label">H·ªç t√™n:</span><span class="quick-view-value"><strong>${teacher.fullName}</strong></span></div>
            <div class="quick-view-row"><span class="quick-view-label">ƒêi·ªán tho·∫°i:</span><span class="quick-view-value">${teacher.phone}</span></div>
            <div class="quick-view-row"><span class="quick-view-label">Email:</span><span class="quick-view-value">${teacher.email || '-'}</span></div>
            <div class="quick-view-row"><span class="quick-view-label">M√¥n d·∫°y:</span><span class="quick-view-value">${teacher.subjects.map(s => `<span class="subject-tag">${getSubjectIcon(s)} ${s}</span>`).join(' ')}</span></div>
        </div>
        <div class="quick-view-section">
            <h4>üí∞ Th√¥ng tin l∆∞∆°ng</h4>
            <div class="quick-view-row"><span class="quick-view-label">Lo·∫°i l∆∞∆°ng:</span><span class="quick-view-value">${getSalaryTypeLabel(teacher.salaryType)}</span></div>
            ${teacher.fixedSalary ? `<div class="quick-view-row"><span class="quick-view-label">L∆∞∆°ng c·ªë ƒë·ªãnh:</span><span class="quick-view-value">${formatCurrency(teacher.fixedSalary)}/th√°ng</span></div>` : ''}
            ${teacher.perSessionRate ? `<div class="quick-view-row"><span class="quick-view-label">Ti·ªÅn/bu·ªïi:</span><span class="quick-view-value">${formatCurrency(teacher.perSessionRate)}</span></div>` : ''}
        </div>
        <div class="quick-view-section">
            <h4>üìö L·ªõp ƒëang d·∫°y (${teacherClasses.length})</h4>
            ${teacherClasses.length === 0 ? '<p class="text-muted">Ch∆∞a c√≥ l·ªõp</p>' : teacherClasses.map(c => `
                <div class="quick-view-row">
                    <span class="quick-view-label">${c.className}</span>
                    <span class="quick-view-value">${getClassStatusBadge(c.status)}</span>
                </div>
            `).join('')}
        </div>
        <div class="quick-view-section">
            <h4>üìÖ L·ªãch d·∫°y trong tu·∫ßn</h4>
            ${scheduleHTML || '<p class="text-muted">Ch∆∞a c√≥ l·ªãch</p>'}
        </div>
    `;
            openModal('viewTeacherModal');
        }

        /* ============================================================
           üìö PH·∫¶N 24: QU·∫¢N L√ù L·ªöP H·ªåC
           ============================================================ */

        // ===== 24.1 Render b·∫£ng l·ªõp h·ªçc =====
        function renderClassesTable() {
            const tbody = document.getElementById('classesTableBody');
            const searchTerm = document.getElementById('searchClass')?.value?.toLowerCase() || '';
            const filterSubject = document.getElementById('filterClassSubject')?.value || '';
            const filterTeacher = document.getElementById('filterClassTeacher')?.value || '';
            const filterStatus = document.getElementById('filterClassStatus')?.value || '';

            let filtered = classes.filter(c => {
                if (searchTerm && !c.className.toLowerCase().includes(searchTerm)) return false;
                if (filterSubject && c.subjectId !== filterSubject) return false;
                if (filterTeacher && c.teacherId !== filterTeacher) return false;
                if (filterStatus && c.status !== filterStatus) return false;
                return true;
            });

            if (filtered.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8"><div class="empty-state"><div class="empty-state-icon">üìö</div><p>Ch∆∞a c√≥ l·ªõp h·ªçc n√†o</p></div></td></tr>`;
                return;
            }

            tbody.innerHTML = filtered.map(c => {
                const subject = subjects.find(s => s.id === c.subjectId);
                const teacher = teachers.find(t => t.id === c.teacherId);
                const clsSchedules = classSchedules.filter(s => s.classId === c.id && s.isActive);
                const studentCount = classStudents.filter(cs => cs.classId === c.id && cs.status === 'active').length;

                return `
            <tr>
                <td><strong>${c.className}</strong></td>
                <td>${subject ? `${subject.icon} ${subject.name}` : '-'}</td>
                <td>${teacher ? teacher.fullName : '<span class="text-muted">Ch∆∞a c√≥</span>'}</td>
                <td>${c.classType === 'group' ? 'üë• Nh√≥m' : 'üë§ 1-1'}</td>
                <td><strong>${studentCount}</strong>/${c.maxStudents}</td>
                <td>${formatSchedules(clsSchedules)}</td>
                <td>${getClassStatusBadge(c.status)}</td>
                <td>
                    <div class="action-buttons">
                        <button class="action-btn view" onclick="viewClass('${c.id}')" title="Xem">üëÅÔ∏è</button>
                        ${canEdit('classes') ? `<button class="action-btn edit" onclick="editClass('${c.id}')" title="S·ª≠a">‚úèÔ∏è</button>` : ''}
                        ${canDelete('classes') ? `<button class="action-btn delete" onclick="deleteClass('${c.id}')" title="X√≥a">üóëÔ∏è</button>` : ''}
                    </div>
                </td>
            </tr>
        `;
            }).join('');
        }

        function formatSchedules(schedules) {
            if (!schedules || schedules.length === 0) return '<span class="text-muted">Ch∆∞a c√≥ l·ªãch</span>';

            const grouped = {};
            schedules.forEach(s => {
                const time = `${s.startTime}-${s.endTime}`;
                if (!grouped[time]) grouped[time] = [];
                grouped[time].push(getDayShort(s.dayOfWeek));
            });

            return Object.entries(grouped).map(([time, days]) =>
                `<small>${days.join(',')} ${time}</small>`
            ).join('<br>');
        }

        function getDayName(dayOfWeek) {
            const days = ['', 'Th·ª© 2', 'Th·ª© 3', 'Th·ª© 4', 'Th·ª© 5', 'Th·ª© 6', 'Th·ª© 7', 'CN'];
            return days[dayOfWeek] || '';
        }

        function getDayShort(dayOfWeek) {
            const days = ['', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'CN'];
            return days[dayOfWeek] || '';
        }

        function getClassStatusBadge(status) {
            const badges = {
                'new': '<span class="status-badge hoc-thu">üÜï L·ªõp m·ªõi</span>',
                'active': '<span class="status-badge da-dk">üü¢ ƒêang h·ªçc</span>',
                'completed': '<span class="status-badge hoan-thanh">‚úÖ Ho√†n th√†nh</span>',
                'cancelled': '<span class="status-badge cancel">‚ùå ƒê√£ h·ªßy</span>'
            };
            return badges[status] || status;
        }

        function searchClasses() {
            renderClassesTable();
        }

        function filterClasses() {
            renderClassesTable();
        }

        // ===== 24.2 Populate filter dropdowns =====
        function populateClassFilters() {
            // Filter m√¥n h·ªçc
            const subjectFilter = document.getElementById('filterClassSubject');
            if (subjectFilter) {
                subjectFilter.innerHTML = '<option value="">üìñ T·∫•t c·∫£ m√¥n h·ªçc</option>' +
                    subjects.map(s => `<option value="${s.id}">${s.icon} ${s.name}</option>`).join('');
            }

            // Filter gi√°o vi√™n
            const teacherFilter = document.getElementById('filterClassTeacher');
            if (teacherFilter) {
                teacherFilter.innerHTML = '<option value="">üë®‚Äçüè´ T·∫•t c·∫£ gi√°o vi√™n</option>' +
                    teachers.filter(t => t.status === 'active').map(t => `<option value="${t.id}">${t.fullName}</option>`).join('');
            }
        }

        // ===== 24.3 Modal L·ªõp h·ªçc =====
        function openClassModal() {
            document.getElementById('editClassId').value = '';
            document.getElementById('classForm').reset();
            document.getElementById('classModalTitle').textContent = 'üìö Th√™m L·ªõp H·ªçc';
            document.getElementById('classType').value = 'group';
            document.getElementById('classMaxStudents').value = 10;
            document.getElementById('classStatus').value = 'new';
            toggleMaxStudents();
            populateClassSubjectDropdown();
            populateClassTeacherDropdown();
            openModal('classModal');
        }

        function populateClassSubjectDropdown() {
            document.getElementById('classSubject').innerHTML = '<option value="">-- Ch·ªçn m√¥n h·ªçc --</option>' +
                subjects.map(s => `<option value="${s.id}">${s.icon} ${s.name}</option>`).join('');
        }

        function populateClassTeacherDropdown(subjectId = null) {
            let filtered = teachers.filter(t => t.status === 'active');
            if (subjectId) {
                const subject = subjects.find(s => s.id === subjectId);
                if (subject) {
                    filtered = filtered.filter(t => t.subjects.includes(subject.name));
                }
            }

            document.getElementById('classTeacher').innerHTML = '<option value="">-- Ch·ªçn gi√°o vi√™n --</option>' +
                filtered.map(t => `<option value="${t.id}">${t.fullName}</option>`).join('');
        }

        function filterTeachersBySubject() {
            const subjectId = document.getElementById('classSubject').value;
            populateClassTeacherDropdown(subjectId);
        }

        function toggleMaxStudents() {
            const classType = document.getElementById('classType').value;
            const maxStudentsInput = document.getElementById('classMaxStudents');
            const maxStudentsGroup = document.getElementById('maxStudentsGroup');

            if (classType === '1on1') {
                maxStudentsInput.value = 1;
                maxStudentsInput.disabled = true;
                maxStudentsGroup.style.opacity = '0.5';
            } else {
                maxStudentsInput.value = 10;
                maxStudentsInput.disabled = false;
                maxStudentsGroup.style.opacity = '1';
            }
        }

        function editClass(id) {
            const cls = classes.find(c => c.id === id);
            if (!cls) return;

            document.getElementById('editClassId').value = cls.id;
            document.getElementById('className').value = cls.className;
            populateClassSubjectDropdown();
            document.getElementById('classSubject').value = cls.subjectId;
            populateClassTeacherDropdown(cls.subjectId);
            document.getElementById('classTeacher').value = cls.teacherId || '';
            document.getElementById('classType').value = cls.classType;
            document.getElementById('classMaxStudents').value = cls.maxStudents;
            document.getElementById('classStatus').value = cls.status;
            document.getElementById('classNotes').value = cls.notes || '';

            toggleMaxStudents();
            document.getElementById('classModalTitle').textContent = '‚úèÔ∏è S·ª≠a L·ªõp H·ªçc';
            openModal('classModal');
        }

        function saveClass(event) {
            event.preventDefault();

            const editId = document.getElementById('editClassId').value;
            const data = {
                className: document.getElementById('className').value.trim(),
                subjectId: document.getElementById('classSubject').value,
                teacherId: document.getElementById('classTeacher').value || null,
                classType: document.getElementById('classType').value,
                maxStudents: parseInt(document.getElementById('classMaxStudents').value),
                status: document.getElementById('classStatus').value,
                notes: document.getElementById('classNotes').value.trim()
            };

            if (editId) {
                const index = classes.findIndex(c => c.id === editId);
                if (index !== -1) {
                    classes[index] = { ...classes[index], ...data, updatedAt: new Date().toISOString() };
                    showNotification('C·∫≠p nh·∫≠t l·ªõp h·ªçc th√†nh c√¥ng!', 'success');
                }
            } else {
                classes.push({ id: generateId(), ...data, createdAt: new Date().toISOString() });
                showNotification('Th√™m l·ªõp h·ªçc th√†nh c√¥ng!', 'success');
            }

            saveData('classes', classes);
            closeModal('classModal');
            renderClassesTable();
            populateClassFilters();
        }

        function deleteClass(id) {
            const cls = classes.find(c => c.id === id);
            if (!cls) return;

            const studentCount = classStudents.filter(cs => cs.classId === id && cs.status === 'active').length;
            if (studentCount > 0) {
                showNotification(`Kh√¥ng th·ªÉ x√≥a! L·ªõp c√≤n ${studentCount} h·ªçc vi√™n.`, 'error');
                return;
            }

            if (!confirm(`X√≥a l·ªõp "${cls.className}"?`)) return;

            classes = classes.filter(c => c.id !== id);
            classSchedules = classSchedules.filter(s => s.classId !== id);

            saveData('classes', classes);
            saveData('classSchedules', classSchedules);
            showNotification('ƒê√£ x√≥a l·ªõp h·ªçc!', 'success');
            renderClassesTable();
        }

        // ===== 24.4 Xem chi ti·∫øt l·ªõp =====
        let currentViewingClassId = null;

        function viewClass(id) {
            const cls = classes.find(c => c.id === id);
            if (!cls) return;

            currentViewingClassId = id;

            const subject = subjects.find(s => s.id === cls.subjectId);
            const teacher = teachers.find(t => t.id === cls.teacherId);
            const clsSchedules = classSchedules.filter(s => s.classId === id && s.isActive);
            const clsStudents = classStudents.filter(cs => cs.classId === id && cs.status === 'active');

            document.getElementById('viewClassContent').innerHTML = `
        <div class="d-flex gap-20 flex-wrap">
            <div class="flex-1" style="min-width: 300px;">
                <div class="quick-view-section">
                    <h4>üìã Th√¥ng tin l·ªõp</h4>
                    <div class="quick-view-row"><span class="quick-view-label">T√™n l·ªõp:</span><span class="quick-view-value"><strong>${cls.className}</strong></span></div>
                    <div class="quick-view-row"><span class="quick-view-label">M√¥n h·ªçc:</span><span class="quick-view-value">${subject ? `${subject.icon} ${subject.name}` : '-'}</span></div>
                    <div class="quick-view-row"><span class="quick-view-label">Gi√°o vi√™n:</span><span class="quick-view-value">${teacher ? teacher.fullName : '<span class="text-muted">Ch∆∞a c√≥</span>'}</span></div>
                    <div class="quick-view-row"><span class="quick-view-label">Lo·∫°i l·ªõp:</span><span class="quick-view-value">${cls.classType === 'group' ? 'üë• L·ªõp nh√≥m' : 'üë§ 1 k√®m 1'}</span></div>
                    <div class="quick-view-row"><span class="quick-view-label">Sƒ© s·ªë:</span><span class="quick-view-value"><strong>${clsStudents.length}</strong> / ${cls.maxStudents}</span></div>
                    <div class="quick-view-row"><span class="quick-view-label">Tr·∫°ng th√°i:</span><span class="quick-view-value">${getClassStatusBadge(cls.status)}</span></div>
                </div>
                
                <div class="quick-view-section">
                    <h4>üìÖ L·ªãch h·ªçc</h4>
                    ${clsSchedules.length === 0 ? '<p class="text-muted">Ch∆∞a c√≥ ca h·ªçc. Nh·∫•n "Th√™m ca h·ªçc" ƒë·ªÉ th√™m.</p>' : `
                        <table style="width: 100%; font-size: 13px;">
                            <thead><tr><th>Th·ª©</th><th>Gi·ªù h·ªçc</th><th>Ph√≤ng</th><th></th></tr></thead>
                            <tbody>
                                ${clsSchedules.map(s => `
                                    <tr>
                                        <td>${getDayName(s.dayOfWeek)}</td>
                                        <td>${s.startTime} - ${s.endTime}</td>
                                        <td>${s.room || '-'}</td>
                                        <td>
                                            <button class="action-btn edit" onclick="editSchedule('${s.id}')" title="S·ª≠a">‚úèÔ∏è</button>
                                            <button class="action-btn delete" onclick="deleteSchedule('${s.id}')" title="X√≥a">üóëÔ∏è</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `}
                </div>
            </div>
            
            <div class="flex-1" style="min-width: 350px;">
                <div class="quick-view-section">
                    <h4>üë©‚Äçüéì Danh s√°ch h·ªçc vi√™n (${clsStudents.length})</h4>
                    ${clsStudents.length === 0 ? '<p class="text-muted">Ch∆∞a c√≥ h·ªçc vi√™n. Nh·∫•n "Th√™m h·ªçc vi√™n" ƒë·ªÉ th√™m.</p>' : `
                        <table style="width: 100%; font-size: 13px;">
                            <thead><tr><th>H·ªçc vi√™n</th><th>T·ªïng</th><th>ƒê√£ h·ªçc</th><th>C√≤n l·∫°i</th><th></th></tr></thead>
                            <tbody>
                                ${clsStudents.map(cs => {
                const student = students.find(s => s.id === cs.studentId);
                const remainingClass = getSessionWarningClass(cs.remainingSessions);
                return `
                                        <tr>
                                            <td><strong>${student ? student.name : 'N/A'}</strong></td>
                                            <td>${cs.totalSessions}</td>
                                            <td>${cs.completedSessions}</td>
                                            <td><span class="${remainingClass}">${cs.remainingSessions}</span></td>
                                            <td>
                                                <button class="action-btn delete" onclick="removeStudentFromClass('${cs.id}')" title="X√≥a kh·ªèi l·ªõp">üóëÔ∏è</button>
                                            </td>
                                        </tr>
                                    `;
            }).join('')}
                            </tbody>
                        </table>
                    `}
                </div>
            </div>
        </div>
    `;

            openModal('viewClassModal');
        }

        function getSessionWarningClass(remaining) {
            if (remaining <= 1) return 'text-danger fw-700';
            if (remaining <= 3) return 'text-warning fw-600';
            if (remaining <= 5) return 'text-primary';
            return 'text-success';
        }

        /* ============================================================
           üìÖ PH·∫¶N 25: QU·∫¢N L√ù CA H·ªåC (SCHEDULE)
           ============================================================ */

        function openScheduleModal() {
            if (!currentViewingClassId) {
                showNotification('Vui l√≤ng ch·ªçn l·ªõp tr∆∞·ªõc!', 'error');
                return;
            }

            document.getElementById('scheduleClassId').value = currentViewingClassId;
            document.getElementById('editScheduleId').value = '';
            document.getElementById('scheduleForm').reset();
            document.getElementById('scheduleStartTime').value = '08:30';
            document.getElementById('scheduleEndTime').value = '10:00';

            // Populate dropdown ph√≤ng h·ªçc
            populateRoomDropdown();

            openModal('scheduleModal');
        }

        function populateRoomDropdown() {
            const roomSelect = document.getElementById('scheduleRoom');
            if (!roomSelect) return;

            const activeRooms = getActiveRooms();

            // Ki·ªÉm tra n·∫øu ƒë√£ l√† dropdown th√¨ populate, n·∫øu l√† input th√¨ gi·ªØ nguy√™n
            if (roomSelect.tagName === 'SELECT') {
                roomSelect.innerHTML = '<option value="">-- Ch·ªçn ph√≤ng --</option>' +
                    activeRooms.map(r => `<option value="${r.id}">${r.name} (${r.capacity} ng∆∞·ªùi)</option>`).join('');
            }
        }


        function editSchedule(id) {
            const schedule = classSchedules.find(s => s.id === id);
            if (!schedule) return;

            document.getElementById('scheduleClassId').value = schedule.classId;
            document.getElementById('editScheduleId').value = schedule.id;
            document.getElementById('scheduleDayOfWeek').value = schedule.dayOfWeek;
            document.getElementById('scheduleStartTime').value = schedule.startTime;
            document.getElementById('scheduleEndTime').value = schedule.endTime;

            // Populate dropdown ph√≤ng v√† ch·ªçn ph√≤ng hi·ªán t·∫°i
            populateRoomDropdown();
            document.getElementById('scheduleRoom').value = schedule.roomId || '';

            openModal('scheduleModal');
        }


        function saveSchedule(event) {
            event.preventDefault();

            const classId = document.getElementById('scheduleClassId').value;
            const editId = document.getElementById('editScheduleId').value;
            const roomSelect = document.getElementById('scheduleRoom');
            const roomId = roomSelect.value;
            const roomName = roomId ? (rooms.find(r => r.id === roomId)?.name || '') : '';

            const data = {
                classId: classId,
                dayOfWeek: parseInt(document.getElementById('scheduleDayOfWeek').value),
                startTime: document.getElementById('scheduleStartTime').value,
                endTime: document.getElementById('scheduleEndTime').value,
                roomId: roomId || null,
                room: roomName,
                isActive: true
            };

            // Ki·ªÉm tra tr√πng ph√≤ng
            if (roomId) {
                const conflict = checkRoomConflict(roomId, data.dayOfWeek, data.startTime, data.endTime, editId);
                if (conflict) {
                    showNotification(`Ph√≤ng ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng b·ªüi l·ªõp "${conflict.className}" v√†o ${getDayName(data.dayOfWeek)} ${conflict.schedule.startTime}-${conflict.schedule.endTime}!`, 'error');
                    return;
                }
            }

            if (editId) {
                const index = classSchedules.findIndex(s => s.id === editId);
                if (index !== -1) {
                    classSchedules[index] = { ...classSchedules[index], ...data };
                    showNotification('C·∫≠p nh·∫≠t ca h·ªçc th√†nh c√¥ng!', 'success');
                }
            } else {
                classSchedules.push({ id: generateId(), ...data, createdAt: new Date().toISOString() });
                showNotification('Th√™m ca h·ªçc th√†nh c√¥ng!', 'success');
            }

            saveData('classSchedules', classSchedules);
            closeModal('scheduleModal');
            viewClass(classId); // Refresh chi ti·∫øt l·ªõp
            renderClassesTable();
        }

        function deleteSchedule(id) {
            if (!confirm('X√≥a ca h·ªçc n√†y?')) return;

            const schedule = classSchedules.find(s => s.id === id);
            classSchedules = classSchedules.filter(s => s.id !== id);
            saveData('classSchedules', classSchedules);
            showNotification('ƒê√£ x√≥a ca h·ªçc!', 'success');

            if (schedule) {
                viewClass(schedule.classId);
            }
            renderClassesTable();
        }

        /* ============================================================
           üë§ PH·∫¶N 26: G√ÅN H·ªåC VI√äN V√ÄO L·ªöP
           ============================================================ */

        function openAssignStudentModal() {
            if (!currentViewingClassId) {
                showNotification('Vui l√≤ng ch·ªçn l·ªõp tr∆∞·ªõc!', 'error');
                return;
            }

            const cls = classes.find(c => c.id === currentViewingClassId);
            if (!cls) return;

            // Ki·ªÉm tra c√≤n ch·ªó kh√¥ng
            const currentCount = classStudents.filter(cs => cs.classId === currentViewingClassId && cs.status === 'active').length;
            if (currentCount >= cls.maxStudents) {
                showNotification('L·ªõp ƒë√£ ƒë·∫ßy!', 'error');
                return;
            }

            document.getElementById('assignClassId').value = currentViewingClassId;
            document.getElementById('assignStudentForm').reset();
            document.getElementById('assignRegistrationInfo').style.display = 'none';

            // L·∫•y c√°c phi·∫øu ƒêK ch∆∞a g√°n l·ªõp, c√πng m√¥n h·ªçc
            const subject = subjects.find(s => s.id === cls.subjectId);
            const unassignedRegs = registrations.filter(r => {
                // Ki·ªÉm tra ch∆∞a g√°n l·ªõp
                const isAssigned = classStudents.some(cs => cs.registrationId === r.id && cs.status === 'active');
                if (isAssigned) return false;

                // Ki·ªÉm tra c√πng m√¥n h·ªçc
                if (subject && r.subject !== subject.name) return false;

                return true;
            });

            document.getElementById('assignRegistrationId').innerHTML = '<option value="">-- Ch·ªçn phi·∫øu ƒêK ch∆∞a g√°n l·ªõp --</option>' +
                unassignedRegs.map(r => {
                    const student = students.find(s => s.id === r.studentId);
                    return `<option value="${r.id}">${r.regCode} - ${student ? student.name : 'N/A'} - ${r.subject}</option>`;
                }).join('');

            if (unassignedRegs.length === 0) {
                showNotification('Kh√¥ng c√≥ phi·∫øu ƒêK n√†o ch∆∞a g√°n l·ªõp cho m√¥n n√†y!', 'warning');
            }

            openModal('assignStudentModal');
        }

        // ===== HI·ªÇN TH·ªä TH√îNG TIN PHI·∫æU ƒêK KHI G√ÅN L·ªöP =====
        function showRegistrationInfo() {
            const regId = document.getElementById('assignRegistrationId').value;
            const infoDiv = document.getElementById('assignRegistrationInfo');

            if (!regId) {
                infoDiv.style.display = 'none';
                return;
            }

            const reg = registrations.find(r => r.id === regId);
            if (!reg) return;

            const student = students.find(s => s.id === reg.studentId);

            // L·∫•y s·ªë bu·ªïi t·ª´ phi·∫øu ƒêK ho·∫∑c t·ª´ g√≥i
            let totalSessions = reg.totalSessions;
            if (!totalSessions && reg.packageId) {
                const pkg = packages.find(p => p.id === reg.packageId);
                if (pkg) totalSessions = pkg.sessions;
            }
            if (!totalSessions) totalSessions = 8;

            document.getElementById('assignStudentName').textContent = student ? student.name : 'N/A';
            document.getElementById('assignSubject').textContent = reg.subject;
            document.getElementById('assignTotalSessions').textContent = totalSessions + ' bu·ªïi';

            infoDiv.style.display = 'block';
        }


        // ===== G√ÅN H·ªåC VI√äN V√ÄO L·ªöP - S·ª¨ D·ª§NG S·ªê BU·ªîI T·ª™ PHI·∫æU ƒêK =====
        function assignStudentToClass(event) {
            event.preventDefault();

            const classId = document.getElementById('assignClassId').value;
            const regId = document.getElementById('assignRegistrationId').value;

            if (!regId) {
                showNotification('Vui l√≤ng ch·ªçn phi·∫øu ƒëƒÉng k√Ω!', 'error');
                return;
            }

            const reg = registrations.find(r => r.id === regId);
            if (!reg) return;

            // L·∫•y s·ªë bu·ªïi t·ª´ phi·∫øu ƒêK (∆∞u ti√™n), n·∫øu kh√¥ng c√≥ th√¨ l·∫•y t·ª´ g√≥i
            let totalSessions = reg.totalSessions;
            if (!totalSessions && reg.packageId) {
                const pkg = packages.find(p => p.id === reg.packageId);
                if (pkg) totalSessions = pkg.sessions;
            }
            if (!totalSessions) totalSessions = 8; // M·∫∑c ƒë·ªãnh 8 bu·ªïi

            // T·∫°o b·∫£n ghi classStudent
            classStudents.push({
                id: generateId(),
                classId: classId,
                studentId: reg.studentId,
                registrationId: regId,
                totalSessions: totalSessions,
                completedSessions: 0,
                remainingSessions: totalSessions,
                status: 'active',
                enrolledAt: new Date().toISOString()
            });

            saveData('classStudents', classStudents);
            closeModal('assignStudentModal');
            viewClass(classId);
            renderClassesTable();
            showNotification('ƒê√£ th√™m h·ªçc vi√™n v√†o l·ªõp!', 'success');
        }


        function removeStudentFromClass(classStudentId) {
            if (!confirm('X√≥a h·ªçc vi√™n kh·ªèi l·ªõp n√†y?')) return;

            const cs = classStudents.find(c => c.id === classStudentId);
            classStudents = classStudents.filter(c => c.id !== classStudentId);
            saveData('classStudents', classStudents);
            showNotification('ƒê√£ x√≥a h·ªçc vi√™n kh·ªèi l·ªõp!', 'success');

            if (cs) {
                viewClass(cs.classId);
            }
            renderClassesTable();
        }

        /* ============================================================
           ‚úÖ PH·∫¶N 27: ƒêI·ªÇM DANH
           ============================================================ */

        // ===== 27.1 Kh·ªüi t·∫°o tab ƒëi·ªÉm danh =====
        function initAttendanceTab() {
            // Set ng√†y m·∫∑c ƒë·ªãnh l√† h√¥m nay
            document.getElementById('attendanceDate').value = new Date().toISOString().split('T')[0];

            // Populate dropdown l·ªõp h·ªçc
            populateAttendanceClassDropdown();

            // Load l·ªãch h·ªçc h√¥m nay
            loadTodaySchedules();

            // Load l·ªãch s·ª≠ ƒëi·ªÉm danh
            loadAttendanceHistory();
        }

        function populateAttendanceClassDropdown() {
            const activeClasses = classes.filter(c => c.status === 'active' || c.status === 'new');
            document.getElementById('attendanceClassSelect').innerHTML = '<option value="">-- Ch·ªçn l·ªõp h·ªçc --</option>' +
                activeClasses.map(c => {
                    const subject = subjects.find(s => s.id === c.subjectId);
                    return `<option value="${c.id}">${c.className} - ${subject ? subject.icon + ' ' + subject.name : ''}</option>`;
                }).join('');
        }

        // ===== 27.2 L·ªãch h·ªçc h√¥m nay =====
        function loadTodaySchedules() {
            const today = new Date();
            const dayOfWeek = today.getDay() === 0 ? 7 : today.getDay(); // CN = 7
            const todayStr = today.toISOString().split('T')[0];

            // T√¨m c√°c ca h·ªçc h√¥m nay
            const todaySchedules = classSchedules.filter(s => s.dayOfWeek === dayOfWeek && s.isActive);

            const container = document.getElementById('todaySchedulesList');

            if (todaySchedules.length === 0) {
                container.innerHTML = '<p class="text-muted">Kh√¥ng c√≥ l·ªãch h·ªçc h√¥m nay</p>';
                return;
            }

            // S·∫Øp x·∫øp theo gi·ªù
            todaySchedules.sort((a, b) => a.startTime.localeCompare(b.startTime));

            container.innerHTML = `
        <div class="table-container" style="box-shadow: none; border: none;">
            <table>
                <thead>
                    <tr>
                        <th>Gi·ªù h·ªçc</th>
                        <th>L·ªõp</th>
                        <th>Gi√°o vi√™n</th>
                        <th>Sƒ© s·ªë</th>
                        <th>ƒê√£ ƒëi·ªÉm danh</th>
                        <th>Thao t√°c</th>
                    </tr>
                </thead>
                <tbody>
                    ${todaySchedules.map(s => {
                const cls = classes.find(c => c.id === s.classId);
                if (!cls) return '';

                const teacher = teachers.find(t => t.id === cls.teacherId);
                const studentCount = classStudents.filter(cs => cs.classId === s.classId && cs.status === 'active').length;

                // Ki·ªÉm tra ƒë√£ ƒëi·ªÉm danh ch∆∞a
                const attendedCount = attendances.filter(a =>
                    a.scheduleId === s.id &&
                    a.attendanceDate === todayStr
                ).length;

                const isCompleted = attendedCount >= studentCount && studentCount > 0;

                return `
                            <tr>
                                <td><strong>${s.startTime} - ${s.endTime}</strong></td>
                                <td>${cls.className}</td>
                                <td>${teacher ? teacher.fullName : '-'}</td>
                                <td>${studentCount}</td>
                                <td>${isCompleted ? '<span class="text-success">‚úÖ ƒê√£ xong</span>' : `<span class="text-warning">${attendedCount}/${studentCount}</span>`}</td>
                                <td>
                                    <button class="btn btn-sm btn-primary" onclick="quickAttendance('${s.classId}', '${s.id}', '${todayStr}')">
                                        ‚úÖ ƒêi·ªÉm danh
                                    </button>
                                </td>
                            </tr>
                        `;
            }).join('')}
                </tbody>
            </table>
        </div>
    `;
        }

        function refreshTodaySchedules() {
            loadTodaySchedules();
            showNotification('ƒê√£ l√†m m·ªõi!', 'success');
        }

        function quickAttendance(classId, scheduleId, date) {
            document.getElementById('attendanceClassSelect').value = classId;
            document.getElementById('attendanceDate').value = date;
            onAttendanceClassChange();

            setTimeout(() => {
                document.getElementById('attendanceScheduleSelect').value = scheduleId;
                loadAttendanceList();
            }, 100);
        }

        // ===== 27.3 X·ª≠ l√Ω ch·ªçn l·ªõp/ng√†y =====
        function onAttendanceClassChange() {
            const classId = document.getElementById('attendanceClassSelect').value;
            const dateStr = document.getElementById('attendanceDate').value;

            if (!classId) {
                document.getElementById('attendanceScheduleSelect').innerHTML = '<option value="">-- Ch·ªçn ca h·ªçc --</option>';
                return;
            }

            // L·∫•y ng√†y trong tu·∫ßn
            const date = new Date(dateStr);
            const dayOfWeek = date.getDay() === 0 ? 7 : date.getDay();

            // L·ªçc ca h·ªçc c·ªßa l·ªõp n√†y v√†o ng√†y ƒë√≥
            const schedules = classSchedules.filter(s => s.classId === classId && s.dayOfWeek === dayOfWeek && s.isActive);

            document.getElementById('attendanceScheduleSelect').innerHTML = '<option value="">-- Ch·ªçn ca h·ªçc --</option>' +
                schedules.map(s => `<option value="${s.id}">${s.startTime} - ${s.endTime}${s.room ? ' (' + s.room + ')' : ''}</option>`).join('');

            if (schedules.length === 0) {
                showNotification('L·ªõp n√†y kh√¥ng c√≥ l·ªãch h·ªçc v√†o ng√†y ƒë√£ ch·ªçn!', 'warning');
            }
        }

        function onAttendanceDateChange() {
            onAttendanceClassChange();
        }

        // ===== 27.4 Load danh s√°ch ƒëi·ªÉm danh =====
        function loadAttendanceList() {
            const classId = document.getElementById('attendanceClassSelect').value;
            const scheduleId = document.getElementById('attendanceScheduleSelect').value;
            const dateStr = document.getElementById('attendanceDate').value;

            if (!classId || !scheduleId || !dateStr) {
                document.getElementById('attendanceTableCard').style.display = 'none';
                return;
            }

            const cls = classes.find(c => c.id === classId);
            const schedule = classSchedules.find(s => s.id === scheduleId);

            // L·∫•y h·ªçc vi√™n trong l·ªõp
            const clsStudents = classStudents.filter(cs => cs.classId === classId && cs.status === 'active');

            if (clsStudents.length === 0) {
                showNotification('L·ªõp n√†y ch∆∞a c√≥ h·ªçc vi√™n!', 'warning');
                document.getElementById('attendanceTableCard').style.display = 'none';
                return;
            }

            // C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ
            document.getElementById('attendanceTableTitle').textContent =
                `üìã ƒêi·ªÉm danh: ${cls.className} - ${schedule.startTime}-${schedule.endTime} - ${formatDate(dateStr)}`;

            // L·∫•y ƒëi·ªÉm danh ƒë√£ c√≥ (n·∫øu c√≥)
            const existingAttendances = attendances.filter(a =>
                a.scheduleId === scheduleId &&
                a.attendanceDate === dateStr
            );

            const tbody = document.getElementById('attendanceTableBody');
            tbody.innerHTML = clsStudents.map(cs => {
                const student = students.find(s => s.id === cs.studentId);
                const existing = existingAttendances.find(a => a.classStudentId === cs.id);
                const remainingClass = getSessionWarningClass(cs.remainingSessions);

                return `
            <tr data-class-student-id="${cs.id}" data-student-id="${cs.studentId}">
                <td><strong>${student ? student.name : 'N/A'}</strong></td>
                <td>${cs.totalSessions}</td>
                <td>${cs.completedSessions}</td>
                <td><span class="${remainingClass}">${cs.remainingSessions}</span></td>
                <td>
                    <div class="attendance-status-buttons" style="display: flex; gap: 5px;">
                        <button type="button" class="btn btn-sm ${existing?.status === 'present' ? 'btn-success' : 'btn-outline'}" 
                                onclick="setAttendanceStatus(this, 'present')" title="C√≥ m·∫∑t">‚úÖ</button>
                        <button type="button" class="btn btn-sm ${existing?.status === 'late' ? 'btn-warning' : 'btn-outline'}" 
                                onclick="setAttendanceStatus(this, 'late')" title="Mu·ªôn">üü°</button>
                        <button type="button" class="btn btn-sm ${existing?.status === 'absent' ? 'btn-danger' : 'btn-outline'}" 
                                onclick="setAttendanceStatus(this, 'absent')" title="V·∫Øng kh√¥ng ph√©p">‚ùå</button>
                        <button type="button" class="btn btn-sm ${existing?.status === 'excused' ? 'btn-info' : 'btn-outline'}" 
                                onclick="setAttendanceStatus(this, 'excused')" title="C√≥ ph√©p (t·∫°o h·ªçc b√π)">üìù</button>
                    </div>
                    <input type="hidden" class="attendance-status-input" value="${existing?.status || ''}">
                </td>
                <td>
                    <input type="text" class="attendance-note-input" style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;" 
                           placeholder="Ghi ch√∫..." value="${existing?.notes || ''}">
                </td>
            </tr>
        `;
            }).join('');

            document.getElementById('attendanceTableCard').style.display = 'block';
        }

        function setAttendanceStatus(btn, status) {
            const row = btn.closest('tr');
            const buttons = row.querySelectorAll('.attendance-status-buttons button');
            const input = row.querySelector('.attendance-status-input');

            // Remove all active states
            buttons.forEach(b => {
                b.classList.remove('btn-success', 'btn-warning', 'btn-danger', 'btn-info');
                b.classList.add('btn-outline');
            });

            // Set active state
            const btnClasses = {
                'present': 'btn-success',
                'late': 'btn-warning',
                'absent': 'btn-danger',
                'excused': 'btn-info'
            };

            btn.classList.remove('btn-outline');
            btn.classList.add(btnClasses[status]);
            input.value = status;
        }

        function markAllPresent() {
            const rows = document.querySelectorAll('#attendanceTableBody tr');
            rows.forEach(row => {
                const presentBtn = row.querySelector('.attendance-status-buttons button:first-child');
                if (presentBtn) {
                    setAttendanceStatus(presentBtn, 'present');
                }
            });
            showNotification('ƒê√£ ƒë√°nh d·∫•u t·∫•t c·∫£ C√≥ m·∫∑t!', 'success');
        }

        // ===== 27.5 L∆∞u ƒëi·ªÉm danh =====
        function saveAttendance() {
            const classId = document.getElementById('attendanceClassSelect').value;
            const scheduleId = document.getElementById('attendanceScheduleSelect').value;
            const dateStr = document.getElementById('attendanceDate').value;

            if (!classId || !scheduleId || !dateStr) {
                showNotification('Vui l√≤ng ch·ªçn ƒë·∫ßy ƒë·ªß th√¥ng tin!', 'error');
                return;
            }

            const rows = document.querySelectorAll('#attendanceTableBody tr');
            let savedCount = 0;
            let makeupCount = 0;

            rows.forEach(row => {
                const classStudentId = row.dataset.classStudentId;
                const studentId = row.dataset.studentId;
                const status = row.querySelector('.attendance-status-input').value;
                const notes = row.querySelector('.attendance-note-input').value.trim();

                if (!status) return; // B·ªè qua n·∫øu ch∆∞a ch·ªçn tr·∫°ng th√°i

                // Ki·ªÉm tra ƒë√£ ƒëi·ªÉm danh ch∆∞a
                const existingIndex = attendances.findIndex(a =>
                    a.classStudentId === classStudentId &&
                    a.scheduleId === scheduleId &&
                    a.attendanceDate === dateStr
                );

                const attendanceData = {
                    classId,
                    scheduleId,
                    studentId,
                    classStudentId,
                    attendanceDate: dateStr,
                    status,
                    notes,
                    isMakeupSession: false,
                    makeupRequestId: null,
                    createdBy: currentUser.id,
                    updatedAt: new Date().toISOString()
                };

                if (existingIndex !== -1) {
                    // C·∫≠p nh·∫≠t
                    const oldStatus = attendances[existingIndex].status;
                    attendances[existingIndex] = { ...attendances[existingIndex], ...attendanceData };

                    // X·ª≠ l√Ω thay ƒë·ªïi tr·∫°ng th√°i
                    handleAttendanceStatusChange(classStudentId, oldStatus, status, attendances[existingIndex].id);
                } else {
                    // Th√™m m·ªõi
                    const newAttendance = {
                        id: generateId(),
                        ...attendanceData,
                        createdAt: new Date().toISOString()
                    };
                    attendances.push(newAttendance);

                    // X·ª≠ l√Ω tr·∫°ng th√°i m·ªõi
                    handleNewAttendance(classStudentId, status, newAttendance.id);
                }

                if (status === 'excused') makeupCount++;
                savedCount++;
            });

            if (savedCount === 0) {
                showNotification('Vui l√≤ng ch·ªçn tr·∫°ng th√°i ƒëi·ªÉm danh!', 'warning');
                return;
            }

            saveData('attendances', attendances);
            saveData('classStudents', classStudents);
            saveData('makeupRequests', makeupRequests);

            loadAttendanceList();
            loadTodaySchedules();
            loadAttendanceHistory();

            let msg = `ƒê√£ l∆∞u ƒëi·ªÉm danh cho ${savedCount} h·ªçc vi√™n!`;
            if (makeupCount > 0) {
                msg += ` ƒê√£ t·∫°o ${makeupCount} y√™u c·∫ßu h·ªçc b√π.`;
            }
            showNotification(msg, 'success');
        }

        /* ============================================================
        ‚úÖ TASK 2.7: REVIEW V√Ä S·ª¨A LOGIC ƒêI·ªÇM DANH
        
        LOGIC ƒêI·ªÇM DANH:
        ================
        
        TR·∫†NG TH√ÅI V√Ä H√ÄNH ƒê·ªòNG:
        - present (C√≥ m·∫∑t)  ‚Üí TR·ª™ 1 bu·ªïi
        - late (Mu·ªôn)       ‚Üí TR·ª™ 1 bu·ªïi  
        - absent (V·∫Øng KP)  ‚Üí TR·ª™ 1 bu·ªïi (v·∫Øng kh√¥ng ph√©p v·∫´n t√≠nh)
        - excused (C√≥ ph√©p) ‚Üí KH√îNG TR·ª™, t·∫°o y√™u c·∫ßu h·ªçc b√π
        
        KHI S·ª¨A TR·∫†NG TH√ÅI:
        - present/late/absent ‚Üí excused: C·ªòNG L·∫†I 1 bu·ªïi, t·∫°o h·ªçc b√π
        - excused ‚Üí present/late/absent: TR·ª™ 1 bu·ªïi, x√≥a h·ªçc b√π
        - present ‚Üî late ‚Üî absent: KH√îNG THAY ƒê·ªîI s·ªë bu·ªïi
        
        ============================================================ */

        function handleNewAttendance(classStudentId, status, attendanceId) {
            const cs = classStudents.find(c => c.id === classStudentId);
            if (!cs) {
                console.warn('Kh√¥ng t√¨m th·∫•y classStudent:', classStudentId);
                return;
            }

            console.log(`[ƒêi·ªÉm danh M·ªöI] HV: ${classStudentId}, Tr·∫°ng th√°i: ${status}`);

            if (status === 'present' || status === 'late' || status === 'absent') {
                // C√≥ m·∫∑t / Mu·ªôn / V·∫Øng kh√¥ng ph√©p ‚Üí TR·ª™ 1 bu·ªïi
                cs.completedSessions++;
                cs.remainingSessions = Math.max(0, cs.remainingSessions - 1);

                console.log(`  ‚Üí Tr·ª´ 1 bu·ªïi. C√≤n l·∫°i: ${cs.remainingSessions}`);

                // Ki·ªÉm tra ho√†n th√†nh kh√≥a h·ªçc
                if (cs.remainingSessions === 0) {
                    cs.status = 'completed';
                    console.log(`  ‚Üí ƒê√£ ho√†n th√†nh kh√≥a h·ªçc`);
                }
            } else if (status === 'excused') {
                // C√≥ ph√©p ‚Üí KH√îNG tr·ª´ bu·ªïi, t·∫°o y√™u c·∫ßu h·ªçc b√π
                console.log(`  ‚Üí C√≥ ph√©p, kh√¥ng tr·ª´ bu·ªïi. T·∫°o y√™u c·∫ßu h·ªçc b√π.`);
                createMakeupRequest(classStudentId, attendanceId);
            }
        }

        function handleAttendanceStatusChange(classStudentId, oldStatus, newStatus, attendanceId) {
            // Kh√¥ng thay ƒë·ªïi n·∫øu tr·∫°ng th√°i gi·ªëng nhau
            if (oldStatus === newStatus) {
                console.log(`[ƒêi·ªÉm danh S·ª¨A] Tr·∫°ng th√°i kh√¥ng ƒë·ªïi: ${oldStatus}`);
                return;
            }

            const cs = classStudents.find(c => c.id === classStudentId);
            if (!cs) {
                console.warn('Kh√¥ng t√¨m th·∫•y classStudent:', classStudentId);
                return;
            }

            console.log(`[ƒêi·ªÉm danh S·ª¨A] HV: ${classStudentId}, ${oldStatus} ‚Üí ${newStatus}`);

            // X√°c ƒë·ªãnh nh√≥m tr·∫°ng th√°i
            const deductGroup = ['present', 'late', 'absent']; // Nh√≥m tr·ª´ bu·ªïi
            const excusedGroup = ['excused']; // Nh√≥m kh√¥ng tr·ª´ bu·ªïi

            const wasDeducted = deductGroup.includes(oldStatus);
            const willDeduct = deductGroup.includes(newStatus);
            const wasExcused = excusedGroup.includes(oldStatus);
            const willExcuse = excusedGroup.includes(newStatus);

            // CASE 1: T·ª´ tr·ª´ bu·ªïi ‚Üí c√≥ ph√©p (c·ªông l·∫°i 1 bu·ªïi, t·∫°o h·ªçc b√π)
            if (wasDeducted && willExcuse) {
                cs.completedSessions = Math.max(0, cs.completedSessions - 1);
                cs.remainingSessions++;

                // N·∫øu ƒë√£ completed, ƒë·ªïi l·∫°i active
                if (cs.status === 'completed') {
                    cs.status = 'active';
                }

                console.log(`  ‚Üí C·ªông l·∫°i 1 bu·ªïi. C√≤n l·∫°i: ${cs.remainingSessions}`);

                // T·∫°o y√™u c·∫ßu h·ªçc b√π
                createMakeupRequest(classStudentId, attendanceId);
            }

            // CASE 2: T·ª´ c√≥ ph√©p ‚Üí tr·ª´ bu·ªïi (tr·ª´ 1 bu·ªïi, x√≥a h·ªçc b√π)
            else if (wasExcused && willDeduct) {
                cs.completedSessions++;
                cs.remainingSessions = Math.max(0, cs.remainingSessions - 1);

                console.log(`  ‚Üí Tr·ª´ 1 bu·ªïi. C√≤n l·∫°i: ${cs.remainingSessions}`);

                // Ki·ªÉm tra ho√†n th√†nh
                if (cs.remainingSessions === 0) {
                    cs.status = 'completed';
                    console.log(`  ‚Üí ƒê√£ ho√†n th√†nh kh√≥a h·ªçc`);
                }

                // X√≥a y√™u c·∫ßu h·ªçc b√π li√™n quan
                const makeupIndex = makeupRequests.findIndex(m => m.originalAttendanceId === attendanceId);
                if (makeupIndex !== -1) {
                    console.log(`  ‚Üí X√≥a y√™u c·∫ßu h·ªçc b√π: ${makeupRequests[makeupIndex].id}`);
                    makeupRequests.splice(makeupIndex, 1);
                }
            }

            // CASE 3: Chuy·ªÉn trong c√πng nh√≥m (present ‚Üî late ‚Üî absent)
            else if (wasDeducted && willDeduct) {
                console.log(`  ‚Üí Chuy·ªÉn trong nh√≥m tr·ª´ bu·ªïi, kh√¥ng thay ƒë·ªïi s·ªë bu·ªïi`);
                // Kh√¥ng l√†m g√¨, s·ªë bu·ªïi gi·ªØ nguy√™n
            }

            // CASE 4: C√°c tr∆∞·ªùng h·ª£p kh√°c (hi·∫øm)
            else {
                console.log(`  ‚Üí Tr∆∞·ªùng h·ª£p kh√¥ng x√°c ƒë·ªãnh: ${oldStatus} ‚Üí ${newStatus}`);
            }
        }

        // C·∫≠p nh·∫≠t h√†m saveAttendance ƒë·ªÉ s·ª≠ d·ª•ng ƒë√∫ng logic
        function saveAttendance() {
            const classId = document.getElementById('attendanceClassSelect').value;
            const scheduleId = document.getElementById('attendanceScheduleSelect').value;
            const dateStr = document.getElementById('attendanceDate').value;

            if (!classId || !scheduleId || !dateStr) {
                showNotification('Vui l√≤ng ch·ªçn ƒë·∫ßy ƒë·ªß th√¥ng tin!', 'error');
                return;
            }

            const rows = document.querySelectorAll('#attendanceTableBody tr');
            let savedCount = 0;
            let makeupCount = 0;
            let errors = [];

            rows.forEach(row => {
                const classStudentId = row.dataset.classStudentId;
                const studentId = row.dataset.studentId;
                const status = row.querySelector('.attendance-status-input').value;
                const notes = row.querySelector('.attendance-note-input').value.trim();

                if (!status) return; // B·ªè qua n·∫øu ch∆∞a ch·ªçn tr·∫°ng th√°i

                try {
                    // Ki·ªÉm tra ƒë√£ ƒëi·ªÉm danh ch∆∞a
                    const existingIndex = attendances.findIndex(a =>
                        a.classStudentId === classStudentId &&
                        a.scheduleId === scheduleId &&
                        a.attendanceDate === dateStr
                    );

                    const attendanceData = {
                        classId,
                        scheduleId,
                        studentId,
                        classStudentId,
                        attendanceDate: dateStr,
                        status,
                        notes,
                        isMakeupSession: false,
                        makeupRequestId: null,
                        createdBy: currentUser?.id || null,
                        updatedAt: new Date().toISOString()
                    };

                    if (existingIndex !== -1) {
                        // C·∫¨P NH·∫¨T ƒëi·ªÉm danh ƒë√£ c√≥
                        const oldStatus = attendances[existingIndex].status;
                        const oldAttendanceId = attendances[existingIndex].id;

                        attendances[existingIndex] = {
                            ...attendances[existingIndex],
                            ...attendanceData
                        };

                        // X·ª≠ l√Ω thay ƒë·ªïi tr·∫°ng th√°i
                        handleAttendanceStatusChange(classStudentId, oldStatus, status, oldAttendanceId);

                    } else {
                        // TH√äM M·ªöI ƒëi·ªÉm danh
                        const newAttendance = {
                            id: generateId(),
                            ...attendanceData,
                            createdAt: new Date().toISOString()
                        };
                        attendances.push(newAttendance);

                        // X·ª≠ l√Ω tr·∫°ng th√°i m·ªõi
                        handleNewAttendance(classStudentId, status, newAttendance.id);
                    }

                    if (status === 'excused') makeupCount++;
                    savedCount++;

                } catch (error) {
                    console.error('L·ªói khi l∆∞u ƒëi·ªÉm danh:', error);
                    errors.push(`L·ªói v·ªõi h·ªçc vi√™n ${studentId}`);
                }
            });

            if (savedCount === 0) {
                showNotification('Vui l√≤ng ch·ªçn tr·∫°ng th√°i ƒëi·ªÉm danh!', 'warning');
                return;
            }

            // L∆∞u t·∫•t c·∫£ d·ªØ li·ªáu
            saveData('attendances', attendances);
            saveData('classStudents', classStudents);
            saveData('makeupRequests', makeupRequests);

            // Refresh UI
            loadAttendanceList();
            loadTodaySchedules();
            loadAttendanceHistory();

            // Th√¥ng b√°o
            let msg = `‚úÖ ƒê√£ l∆∞u ƒëi·ªÉm danh cho ${savedCount} h·ªçc vi√™n!`;
            if (makeupCount > 0) {
                msg += ` ƒê√£ t·∫°o ${makeupCount} y√™u c·∫ßu h·ªçc b√π.`;
            }
            if (errors.length > 0) {
                msg += ` (${errors.length} l·ªói)`;
            }
            showNotification(msg, errors.length > 0 ? 'warning' : 'success');
        }


        function handleAttendanceStatusChange(classStudentId, oldStatus, newStatus, attendanceId) {
            if (oldStatus === newStatus) return;

            const cs = classStudents.find(c => c.id === classStudentId);
            if (!cs) return;

            // Ho√†n t√°c tr·∫°ng th√°i c≈©
            if (oldStatus === 'present' || oldStatus === 'late' || oldStatus === 'absent') {
                // Tr·∫°ng th√°i c≈© ƒë√£ tr·ª´ bu·ªïi ‚Üí C·ªông l·∫°i
                cs.completedSessions = Math.max(0, cs.completedSessions - 1);
                cs.remainingSessions++;
                if (cs.status === 'completed') cs.status = 'active';
            } else if (oldStatus === 'excused') {
                // Tr·∫°ng th√°i c≈© l√† C√≥ ph√©p ‚Üí X√≥a y√™u c·∫ßu h·ªçc b√π
                makeupRequests = makeupRequests.filter(m => m.originalAttendanceId !== attendanceId);
            }

            // √Åp d·ª•ng tr·∫°ng th√°i m·ªõi
            handleNewAttendance(classStudentId, newStatus, attendanceId);
        }


        // ===== 27.6 L·ªãch s·ª≠ ƒëi·ªÉm danh (C√ì PH√ÇN TRANG) =====
        function loadAttendanceHistory() {
            // Nh√≥m theo ng√†y + l·ªõp + ca
            const grouped = {};

            attendances.forEach(a => {
                const key = `${a.attendanceDate}_${a.classId}_${a.scheduleId}`;
                if (!grouped[key]) {
                    grouped[key] = {
                        date: a.attendanceDate,
                        classId: a.classId,
                        scheduleId: a.scheduleId,
                        records: []
                    };
                }
                grouped[key].records.push(a);
            });

            // S·∫Øp x·∫øp theo ng√†y m·ªõi nh·∫•t
            const sortedGroups = Object.values(grouped).sort((a, b) =>
                new Date(b.date) - new Date(a.date)
            );

            // PH√ÇN TRANG
            const { data, total, totalPages, currentPage } = getPaginatedData(sortedGroups, 'attendanceHistory');
            const tbody = document.getElementById('attendanceHistoryBody');

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Ch∆∞a c√≥ d·ªØ li·ªáu ƒëi·ªÉm danh</td></tr>';
                renderPagination('attendanceHistoryPagination', 'attendanceHistory', 0, 0, 1);
                return;
            }

            tbody.innerHTML = data.map(g => {
                const cls = classes.find(c => c.id === g.classId);
                const schedule = classSchedules.find(s => s.id === g.scheduleId);

                const totalStudents = g.records.length;
                const presentCount = g.records.filter(r => r.status === 'present' || r.status === 'late').length;
                const absentCount = g.records.filter(r => r.status === 'absent' || r.status === 'excused').length;

                return `
                    <tr>
                        <td><strong>${formatDate(g.date)}</strong></td>
                        <td>${cls ? cls.className : 'N/A'}</td>
                        <td>${schedule ? schedule.startTime + '-' + schedule.endTime : 'N/A'}</td>
                        <td>${totalStudents}</td>
                        <td><span class="text-success">${presentCount}</span></td>
                        <td><span class="text-danger">${absentCount}</span></td>
                        <td>
                            <button class="action-btn view" onclick="viewAttendanceDetail('${g.date}', '${g.classId}', '${g.scheduleId}')" title="Xem chi ti·∫øt">üëÅÔ∏è</button>
                        </td>
                    </tr>
                `;
            }).join('');

            // RENDER PH√ÇN TRANG
            renderPagination('attendanceHistoryPagination', 'attendanceHistory', total, totalPages, currentPage);
        }


        function viewAttendanceDetail(date, classId, scheduleId) {
            const cls = classes.find(c => c.id === classId);
            const schedule = classSchedules.find(s => s.id === scheduleId);
            const records = attendances.filter(a =>
                a.attendanceDate === date &&
                a.classId === classId &&
                a.scheduleId === scheduleId
            );

            const content = `
        <div class="quick-view-section">
            <h4>üìã Th√¥ng tin bu·ªïi h·ªçc</h4>
            <div class="quick-view-row"><span class="quick-view-label">L·ªõp:</span><span class="quick-view-value">${cls ? cls.className : 'N/A'}</span></div>
            <div class="quick-view-row"><span class="quick-view-label">Ng√†y:</span><span class="quick-view-value">${formatDate(date)}</span></div>
            <div class="quick-view-row"><span class="quick-view-label">Ca h·ªçc:</span><span class="quick-view-value">${schedule ? schedule.startTime + ' - ' + schedule.endTime : 'N/A'}</span></div>
        </div>
        <div class="quick-view-section">
            <h4>üìä Chi ti·∫øt ƒëi·ªÉm danh</h4>
            <table style="width: 100%; font-size: 13px;">
                <thead>
                    <tr><th>H·ªçc vi√™n</th><th>Tr·∫°ng th√°i</th><th>Ghi ch√∫</th></tr>
                </thead>
                <tbody>
                    ${records.map(r => {
                const student = students.find(s => s.id === r.studentId);
                return `
                            <tr>
                                <td>${student ? student.name : 'N/A'}</td>
                                <td>${getAttendanceStatusBadge(r.status)}</td>
                                <td>${r.notes || '-'}</td>
                            </tr>
                        `;
            }).join('')}
                </tbody>
            </table>
        </div>
    `;

            document.getElementById('viewAttendanceContent').innerHTML = content;
            openModal('viewAttendanceModal');
        }

        function getAttendanceStatusBadge(status) {
            const badges = {
                'present': '<span class="status-badge da-dk">‚úÖ C√≥ m·∫∑t</span>',
                'late': '<span class="status-badge cho-dk">üü° Mu·ªôn</span>',
                'absent': '<span class="status-badge cancel">‚ùå V·∫Øng</span>',
                'excused': '<span class="status-badge hoc-thu">üìù C√≥ ph√©p</span>'
            };
            return badges[status] || status;
        }

        function exportAttendanceToExcel() {
            if (attendances.length === 0) {
                showNotification('Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t!', 'warning');
                return;
            }

            const data = attendances.map(a => {
                const student = students.find(s => s.id === a.studentId);
                const cls = classes.find(c => c.id === a.classId);
                const schedule = classSchedules.find(s => s.id === a.scheduleId);

                return {
                    'Ng√†y': formatDate(a.attendanceDate),
                    'L·ªõp': cls ? cls.className : '',
                    'Ca h·ªçc': schedule ? schedule.startTime + '-' + schedule.endTime : '',
                    'H·ªçc vi√™n': student ? student.name : '',
                    'Tr·∫°ng th√°i': a.status === 'present' ? 'C√≥ m·∫∑t' : a.status === 'late' ? 'Mu·ªôn' : a.status === 'absent' ? 'V·∫Øng' : 'C√≥ ph√©p',
                    'Ghi ch√∫': a.notes || ''
                };
            });

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data), 'ƒêi·ªÉm danh');
            XLSX.writeFile(wb, `DiemDanh_${formatDateFile()}.xlsx`);
            showNotification('Xu·∫•t Excel th√†nh c√¥ng!', 'success');
        }

        /* ============================================================
        üìù TASK 2.8: S·ª¨A LOGIC H·ªåC B√ô PRE-CREATED
        
        Khi ƒëi·ªÉm danh "C√≥ ph√©p":
        1. Ki·ªÉm tra c√≥ y√™u c·∫ßu pre-created ch∆∞a
        2. N·∫øu c√≥ ‚Üí c·∫≠p nh·∫≠t v·ªõi attendanceId
        3. N·∫øu kh√¥ng ‚Üí t·∫°o m·ªõi
        ============================================================ */

        function createMakeupRequest(classStudentId, attendanceId) {
            const cs = classStudents.find(c => c.id === classStudentId);
            const attendance = attendances.find(a => a.id === attendanceId);

            if (!cs || !attendance) {
                console.warn('Kh√¥ng t√¨m th·∫•y classStudent ho·∫∑c attendance');
                return;
            }

            console.log(`[H·ªçc b√π] Ki·ªÉm tra y√™u c·∫ßu cho HV: ${classStudentId}, Ng√†y: ${attendance.attendanceDate}`);

            // B∆Ø·ªöC 1: Ki·ªÉm tra ƒë√£ c√≥ y√™u c·∫ßu pre-created ch∆∞a
            const preCreatedIndex = makeupRequests.findIndex(m =>
                m.classStudentId === classStudentId &&
                m.originalDate === attendance.attendanceDate &&
                m.isPreCreated === true &&
                (m.status === 'pending' || m.status === 'approved')
            );

            if (preCreatedIndex !== -1) {
                // C·∫¨P NH·∫¨T y√™u c·∫ßu ƒë√£ t·∫°o tr∆∞·ªõc
                console.log(`  ‚Üí T√¨m th·∫•y y√™u c·∫ßu pre-created: ${makeupRequests[preCreatedIndex].id}`);

                makeupRequests[preCreatedIndex].originalAttendanceId = attendanceId;
                makeupRequests[preCreatedIndex].originalScheduleId = attendance.scheduleId;
                makeupRequests[preCreatedIndex].isPreCreated = false; // ƒê√°nh d·∫•u ƒë√£ li√™n k·∫øt
                makeupRequests[preCreatedIndex].updatedAt = new Date().toISOString();

                console.log(`  ‚Üí ƒê√£ c·∫≠p nh·∫≠t v·ªõi attendanceId: ${attendanceId}`);
                return;
            }

            // B∆Ø·ªöC 2: Ki·ªÉm tra ƒë√£ c√≥ y√™u c·∫ßu (kh√¥ng ph·∫£i pre-created) ch∆∞a
            const existingRequest = makeupRequests.find(m =>
                m.originalAttendanceId === attendanceId
            );

            if (existingRequest) {
                console.log(`  ‚Üí ƒê√£ c√≥ y√™u c·∫ßu h·ªçc b√π cho attendance n√†y: ${existingRequest.id}`);
                return; // Kh√¥ng t·∫°o duplicate
            }

            // B∆Ø·ªöC 3: T·∫°o y√™u c·∫ßu h·ªçc b√π M·ªöI
            console.log(`  ‚Üí T·∫°o y√™u c·∫ßu h·ªçc b√π m·ªõi`);

            // T√≠nh ng√†y h·∫øt h·∫°n (30 ng√†y t·ª´ ng√†y ngh·ªâ)
            const expiryDate = new Date(attendance.attendanceDate);
            expiryDate.setDate(expiryDate.getDate() + 30);

            const newMakeupRequest = {
                id: generateId(),
                studentId: cs.studentId,
                classStudentId: classStudentId,
                originalAttendanceId: attendanceId,
                originalClassId: attendance.classId,
                originalScheduleId: attendance.scheduleId,
                originalDate: attendance.attendanceDate,
                requestDate: new Date().toISOString().split('T')[0],
                expiryDate: expiryDate.toISOString().split('T')[0],
                makeupClassId: null,
                makeupScheduleId: null,
                makeupDate: null,
                status: 'pending',
                approvedBy: null,
                approvedAt: null,
                completedAt: null,
                notes: null,
                isPreCreated: false,
                createdAt: new Date().toISOString()
            };

            makeupRequests.push(newMakeupRequest);
            console.log(`  ‚Üí ƒê√£ t·∫°o y√™u c·∫ßu: ${newMakeupRequest.id}, H·∫°n: ${newMakeupRequest.expiryDate}`);
        }

        // C·∫≠p nh·∫≠t h√†m saveNewMakeupRequest (t·∫°o y√™u c·∫ßu th·ªß c√¥ng)
        function saveNewMakeupRequest(event) {
            event.preventDefault();

            const classId = document.getElementById('newMakeupClassSelect').value;
            const classStudentId = document.getElementById('newMakeupStudentSelect').value;
            const absentDate = document.getElementById('newMakeupAbsentDate').value;
            const reason = document.getElementById('newMakeupReason').value.trim();

            if (!classId || !classStudentId || !absentDate) {
                showNotification('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!', 'error');
                return;
            }

            const cs = classStudents.find(c => c.id === classStudentId);
            if (!cs) {
                showNotification('Kh√¥ng t√¨m th·∫•y th√¥ng tin h·ªçc vi√™n!', 'error');
                return;
            }

            // Ki·ªÉm tra ƒë√£ c√≥ y√™u c·∫ßu cho ng√†y n√†y ch∆∞a
            const existing = makeupRequests.find(m =>
                m.classStudentId === classStudentId &&
                m.originalDate === absentDate &&
                m.status !== 'completed' &&
                m.status !== 'expired' &&
                m.status !== 'cancelled'
            );

            if (existing) {
                showNotification('ƒê√£ c√≥ y√™u c·∫ßu h·ªçc b√π cho ng√†y n√†y!', 'error');
                return;
            }

            // T√≠nh ng√†y h·∫øt h·∫°n (30 ng√†y t·ª´ ng√†y ngh·ªâ)
            const expiryDate = new Date(absentDate);
            expiryDate.setDate(expiryDate.getDate() + 30);

            // T·∫°o y√™u c·∫ßu h·ªçc b√π (PRE-CREATED)
            const newRequest = {
                id: generateId(),
                studentId: cs.studentId,
                classStudentId: classStudentId,
                originalAttendanceId: null, // Ch∆∞a c√≥, s·∫Ω c·∫≠p nh·∫≠t khi ƒëi·ªÉm danh
                originalClassId: classId,
                originalScheduleId: null,
                originalDate: absentDate,
                requestDate: new Date().toISOString().split('T')[0],
                expiryDate: expiryDate.toISOString().split('T')[0],
                makeupClassId: null,
                makeupScheduleId: null,
                makeupDate: null,
                status: 'pending',
                approvedBy: null,
                approvedAt: null,
                completedAt: null,
                notes: reason ? `L√Ω do ngh·ªâ: ${reason}` : null,
                isPreCreated: true, // QUAN TR·ªåNG: ƒê√°nh d·∫•u l√† t·∫°o tr∆∞·ªõc
                createdAt: new Date().toISOString()
            };

            makeupRequests.push(newRequest);
            saveData('makeupRequests', makeupRequests);

            closeModal('createMakeupModal');
            renderMakeupRequests();
            showNotification('‚úÖ ƒê√£ t·∫°o y√™u c·∫ßu h·ªçc b√π! Nh·ªõ ƒëi·ªÉm danh "C√≥ ph√©p" v√†o ng√†y ngh·ªâ.', 'success');
        }

        // ===== 28.2 Render danh s√°ch y√™u c·∫ßu h·ªçc b√π =====
        let currentMakeupFilter = 'all';

        function renderMakeupRequests() {
            updateMakeupStats();

            const tbody = document.getElementById('makeupRequestsBody');
            const today = new Date().toISOString().split('T')[0];

            let filtered = [...makeupRequests];

            // √Åp d·ª•ng filter
            if (currentMakeupFilter === 'pending') {
                filtered = filtered.filter(m => m.status === 'pending');
            } else if (currentMakeupFilter === 'approved') {
                filtered = filtered.filter(m => m.status === 'approved');
            } else if (currentMakeupFilter === 'expiring') {
                const in7Days = new Date();
                in7Days.setDate(in7Days.getDate() + 7);
                filtered = filtered.filter(m =>
                    (m.status === 'pending' || m.status === 'approved') &&
                    new Date(m.expiryDate) <= in7Days
                );
            } else if (currentMakeupFilter === 'completed') {
                filtered = filtered.filter(m => m.status === 'completed');
            } else if (currentMakeupFilter === 'expired') {
                filtered = filtered.filter(m => m.status === 'expired');
            }

            // S·∫Øp x·∫øp theo h·∫°n g·∫ßn nh·∫•t
            filtered.sort((a, b) => new Date(a.expiryDate) - new Date(b.expiryDate));

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">Kh√¥ng c√≥ y√™u c·∫ßu h·ªçc b√π</td></tr>';
                return;
            }

            tbody.innerHTML = filtered.map(m => {
                const student = students.find(s => s.id === m.studentId);
                const originalClass = classes.find(c => c.id === m.originalClassId);
                const makeupClass = m.makeupClassId ? classes.find(c => c.id === m.makeupClassId) : null;

                // T√≠nh s·ªë ng√†y c√≤n l·∫°i
                const daysLeft = Math.ceil((new Date(m.expiryDate) - new Date(today)) / (1000 * 60 * 60 * 24));
                const expiryClass = daysLeft <= 3 ? 'text-danger fw-700' : daysLeft <= 7 ? 'text-warning fw-600' : '';

                return `
            <tr>
                <td><strong>${student ? student.name : 'N/A'}</strong></td>
                <td>${originalClass ? originalClass.className : 'N/A'}</td>
                <td>${formatDate(m.originalDate)}</td>
                <td><span class="${expiryClass}">${formatDate(m.expiryDate)} ${daysLeft > 0 ? `(${daysLeft} ng√†y)` : ''}</span></td>
                <td>${makeupClass ? makeupClass.className : '<span class="text-muted">Ch∆∞a x·∫øp</span>'}</td>
                <td>${m.makeupDate ? formatDate(m.makeupDate) : '-'}</td>
                <td>${getMakeupStatusBadge(m.status)}</td>
                <td>
                    <div class="action-buttons">
                        ${m.status === 'pending' ? `<button class="action-btn schedule" onclick="openScheduleMakeupModal('${m.id}')" title="X·∫øp l·ªãch">üìÖ</button>` : ''}
                        ${m.status === 'approved' ? `<button class="action-btn edit" onclick="openConfirmMakeupModal('${m.id}')" title="X√°c nh·∫≠n ho√†n th√†nh">‚úÖ</button>` : ''}
                        ${(m.status === 'pending' || m.status === 'approved') ? `<button class="action-btn delete" onclick="cancelMakeupRequest('${m.id}')" title="H·ªßy">üóëÔ∏è</button>` : ''}
                    </div>
                </td>
            </tr>
        `;
            }).join('');
        }

        function getMakeupStatusBadge(status) {
            const badges = {
                'pending': '<span class="status-badge cho-dk">‚è≥ Ch·ªù x·∫øp l·ªãch</span>',
                'approved': '<span class="status-badge hoc-thu">üìÖ ƒê√£ x·∫øp l·ªãch</span>',
                'completed': '<span class="status-badge da-dk">‚úÖ Ho√†n th√†nh</span>',
                'expired': '<span class="status-badge cancel">‚ùå H·∫øt h·∫°n</span>'
            };
            return badges[status] || status;
        }

        function updateMakeupStats() {
            const today = new Date().toISOString().split('T')[0];
            const in7Days = new Date();
            in7Days.setDate(in7Days.getDate() + 7);

            document.getElementById('makeupPendingCount').textContent = makeupRequests.filter(m => m.status === 'pending').length;
            document.getElementById('makeupApprovedCount').textContent = makeupRequests.filter(m => m.status === 'approved').length;
            document.getElementById('makeupExpiringCount').textContent = makeupRequests.filter(m =>
                (m.status === 'pending' || m.status === 'approved') &&
                new Date(m.expiryDate) <= in7Days
            ).length;
            document.getElementById('makeupCompletedCount').textContent = makeupRequests.filter(m => m.status === 'completed').length;
        }

        function filterMakeupRequests(filter) {
            currentMakeupFilter = filter;
            document.querySelectorAll('#makeup .filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
            });
            renderMakeupRequests();
        }

        // ===== 28.3 X·∫øp l·ªãch h·ªçc b√π =====
        function openScheduleMakeupModal(requestId) {
            const request = makeupRequests.find(m => m.id === requestId);
            if (!request) return;

            const student = students.find(s => s.id === request.studentId);
            const originalClass = classes.find(c => c.id === request.originalClassId);

            document.getElementById('makeupRequestId').value = requestId;
            document.getElementById('makeupStudentName').textContent = student ? student.name : 'N/A';
            document.getElementById('makeupOriginalClass').textContent = originalClass ? originalClass.className : 'N/A';
            document.getElementById('makeupOriginalDate').textContent = formatDate(request.originalDate);
            document.getElementById('makeupExpiryDate').textContent = formatDate(request.expiryDate);

            // Set min/max date
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('makeupDate').min = today;
            document.getElementById('makeupDate').max = request.expiryDate;
            document.getElementById('makeupDate').value = '';

            // Populate t·∫•t c·∫£ l·ªõp ƒëang ho·∫°t ƒë·ªông
            const activeClasses = classes.filter(c => c.status === 'active' || c.status === 'new');
            document.getElementById('makeupClassSelect').innerHTML = '<option value="">-- Ch·ªçn l·ªõp --</option>' +
                activeClasses.map(c => {
                    const subject = subjects.find(s => s.id === c.subjectId);
                    const isOriginal = c.id === request.originalClassId;
                    return `<option value="${c.id}" ${isOriginal ? 'selected' : ''}>${c.className}${isOriginal ? ' (L·ªõp g·ªëc)' : ''} - ${subject ? subject.name : ''}</option>`;
                }).join('');

            document.getElementById('makeupScheduleSelect').innerHTML = '<option value="">-- Ch·ªçn ca h·ªçc --</option>';
            document.getElementById('makeupNotes').value = '';

            openModal('scheduleMakeupModal');
        }

        function loadMakeupSchedules() {
            const classId = document.getElementById('makeupClassSelect').value;
            const dateStr = document.getElementById('makeupDate').value;

            if (!classId || !dateStr) {
                document.getElementById('makeupScheduleSelect').innerHTML = '<option value="">-- Ch·ªçn ca h·ªçc --</option>';
                return;
            }

            const date = new Date(dateStr);
            const dayOfWeek = date.getDay() === 0 ? 7 : date.getDay();

            const schedules = classSchedules.filter(s => s.classId === classId && s.dayOfWeek === dayOfWeek && s.isActive);

            if (schedules.length === 0) {
                document.getElementById('makeupScheduleSelect').innerHTML = '<option value="">Kh√¥ng c√≥ ca h·ªçc v√†o ng√†y n√†y</option>';
                showNotification('L·ªõp n√†y kh√¥ng c√≥ l·ªãch h·ªçc v√†o ng√†y ƒë√£ ch·ªçn!', 'warning');
                return;
            }

            document.getElementById('makeupScheduleSelect').innerHTML = '<option value="">-- Ch·ªçn ca h·ªçc --</option>' +
                schedules.map(s => `<option value="${s.id}">${s.startTime} - ${s.endTime}${s.room ? ' (' + s.room + ')' : ''}</option>`).join('');
        }

        function saveMakeupSchedule(event) {
            event.preventDefault();

            const requestId = document.getElementById('makeupRequestId').value;
            const classId = document.getElementById('makeupClassSelect').value;
            const dateStr = document.getElementById('makeupDate').value;
            const scheduleId = document.getElementById('makeupScheduleSelect').value;
            const notes = document.getElementById('makeupNotes').value.trim();

            if (!classId || !dateStr || !scheduleId) {
                showNotification('Vui l√≤ng ch·ªçn ƒë·∫ßy ƒë·ªß th√¥ng tin!', 'error');
                return;
            }

            const request = makeupRequests.find(m => m.id === requestId);
            if (!request) return;

            // Ki·ªÉm tra h·∫°n
            if (dateStr > request.expiryDate) {
                showNotification('Ng√†y h·ªçc b√π v∆∞·ª£t qu√° h·∫°n cho ph√©p!', 'error');
                return;
            }

            // C·∫≠p nh·∫≠t
            request.makeupClassId = classId;
            request.makeupScheduleId = scheduleId;
            request.makeupDate = dateStr;
            request.status = 'approved';
            request.approvedBy = currentUser.id;
            request.approvedAt = new Date().toISOString();
            request.notes = notes;

            saveData('makeupRequests', makeupRequests);
            closeModal('scheduleMakeupModal');
            renderMakeupRequests();
            showNotification('ƒê√£ x·∫øp l·ªãch h·ªçc b√π th√†nh c√¥ng!', 'success');
        }

        // ===== 28.4 X√°c nh·∫≠n ho√†n th√†nh h·ªçc b√π =====
        function openConfirmMakeupModal(requestId) {
            const request = makeupRequests.find(m => m.id === requestId);
            if (!request) return;

            const student = students.find(s => s.id === request.studentId);
            const makeupClass = classes.find(c => c.id === request.makeupClassId);

            document.getElementById('confirmMakeupId').value = requestId;
            document.getElementById('confirmMakeupStudent').textContent = student ? student.name : 'N/A';
            document.getElementById('confirmMakeupClass').textContent = makeupClass ? makeupClass.className : 'N/A';
            document.getElementById('confirmMakeupDate').textContent = formatDate(request.makeupDate);

            openModal('confirmMakeupModal');
        }

        function completeMakeupRequest() {
            const requestId = document.getElementById('confirmMakeupId').value;
            const request = makeupRequests.find(m => m.id === requestId);
            if (!request) return;

            // T·∫°o b·∫£n ghi ƒëi·ªÉm danh cho bu·ªïi h·ªçc b√π
            attendances.push({
                id: generateId(),
                classId: request.makeupClassId,
                scheduleId: request.makeupScheduleId,
                studentId: request.studentId,
                classStudentId: request.classStudentId,
                attendanceDate: request.makeupDate,
                status: 'present',
                notes: 'Bu·ªïi h·ªçc b√π',
                isMakeupSession: true,
                makeupRequestId: requestId,
                createdBy: currentUser.id,
                createdAt: new Date().toISOString()
            });

            // C·∫≠p nh·∫≠t tr·∫°ng th√°i y√™u c·∫ßu
            request.status = 'completed';
            request.completedAt = new Date().toISOString();

            // TR·ª™ 1 BU·ªîI (ho√†n th√†nh bu·ªïi h·ªçc b√π)
            const cs = classStudents.find(c => c.id === request.classStudentId);
            if (cs) {
                cs.completedSessions++;
                cs.remainingSessions = Math.max(0, cs.remainingSessions - 1);

                // Ki·ªÉm tra ho√†n th√†nh kh√≥a h·ªçc
                if (cs.remainingSessions === 0) {
                    cs.status = 'completed';
                }
                saveData('classStudents', classStudents);
            }

            saveData('attendances', attendances);
            saveData('makeupRequests', makeupRequests);

            closeModal('confirmMakeupModal');
            renderMakeupRequests();
            loadAttendanceHistory();
            showNotification('ƒê√£ x√°c nh·∫≠n ho√†n th√†nh h·ªçc b√π! ƒê√£ tr·ª´ 1 bu·ªïi.', 'success');
        }


        function cancelMakeupRequest(requestId) {
            if (!confirm('H·ªßy y√™u c·∫ßu h·ªçc b√π n√†y?\n\n‚ö†Ô∏è Bu·ªïi h·ªçc s·∫Ω b·ªã tr·ª´ ngay.')) return;

            const request = makeupRequests.find(m => m.id === requestId);
            if (!request) return;

            // TR·ª™ 1 BU·ªîI (h·ªßy y√™u c·∫ßu)
            const cs = classStudents.find(c => c.id === request.classStudentId);
            if (cs) {
                cs.completedSessions++;
                cs.remainingSessions = Math.max(0, cs.remainingSessions - 1);

                if (cs.remainingSessions === 0) {
                    cs.status = 'completed';
                }
                saveData('classStudents', classStudents);
            }

            // ƒê·ªïi tr·∫°ng th√°i
            request.status = 'expired';
            request.notes = (request.notes || '') + ' | H·ªßy th·ªß c√¥ng';

            saveData('makeupRequests', makeupRequests);
            renderMakeupRequests();
            showNotification('ƒê√£ h·ªßy y√™u c·∫ßu h·ªçc b√π v√† tr·ª´ 1 bu·ªïi!', 'warning');
        }


        // ===== 28.5 Ki·ªÉm tra h·∫øt h·∫°n h·ªçc b√π (ch·∫°y khi load trang) =====
        function checkExpiredMakeupRequests() {
            const today = new Date().toISOString().split('T')[0];
            let expiredCount = 0;

            makeupRequests.forEach(m => {
                if ((m.status === 'pending' || m.status === 'approved') && m.expiryDate < today) {
                    m.status = 'expired';

                    // TR·ª™ 1 BU·ªîI (h·∫øt h·∫°n kh√¥ng h·ªçc b√π)
                    const cs = classStudents.find(c => c.id === m.classStudentId);
                    if (cs) {
                        cs.completedSessions++;
                        cs.remainingSessions = Math.max(0, cs.remainingSessions - 1);

                        if (cs.remainingSessions === 0) {
                            cs.status = 'completed';
                        }
                    }

                    expiredCount++;
                }
            });

            if (expiredCount > 0) {
                saveData('makeupRequests', makeupRequests);
                saveData('classStudents', classStudents);
                showNotification(`‚ö†Ô∏è ${expiredCount} y√™u c·∫ßu h·ªçc b√π ƒë√£ h·∫øt h·∫°n v√† b·ªã tr·ª´ bu·ªïi!`, 'warning');
            }
        }

        // ===== 28.6 T·∫°o m·ªõi y√™u c·∫ßu h·ªçc b√π (linh ho·∫°t) =====
        function openCreateMakeupModal() {
            document.getElementById('createMakeupForm').reset();

            // Set ng√†y m·∫∑c ƒë·ªãnh l√† ng√†y mai
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('newMakeupAbsentDate').value = tomorrow.toISOString().split('T')[0];
            document.getElementById('newMakeupAbsentDate').min = new Date().toISOString().split('T')[0];

            // Populate l·ªõp h·ªçc
            const activeClasses = classes.filter(c => c.status === 'active' || c.status === 'new');
            document.getElementById('newMakeupClassSelect').innerHTML = '<option value="">-- Ch·ªçn l·ªõp h·ªçc --</option>' +
                activeClasses.map(c => {
                    const subject = subjects.find(s => s.id === c.subjectId);
                    return `<option value="${c.id}">${c.className} - ${subject ? subject.icon + ' ' + subject.name : ''}</option>`;
                }).join('');

            document.getElementById('newMakeupStudentSelect').innerHTML = '<option value="">-- Ch·ªçn h·ªçc vi√™n --</option>';

            openModal('createMakeupModal');
        }

        function loadStudentsForMakeup() {
            const classId = document.getElementById('newMakeupClassSelect').value;

            if (!classId) {
                document.getElementById('newMakeupStudentSelect').innerHTML = '<option value="">-- Ch·ªçn h·ªçc vi√™n --</option>';
                return;
            }

            // L·∫•y h·ªçc vi√™n trong l·ªõp c√≤n bu·ªïi h·ªçc
            const clsStudents = classStudents.filter(cs => cs.classId === classId && cs.status === 'active' && cs.remainingSessions > 0);

            document.getElementById('newMakeupStudentSelect').innerHTML = '<option value="">-- Ch·ªçn h·ªçc vi√™n --</option>' +
                clsStudents.map(cs => {
                    const student = students.find(s => s.id === cs.studentId);
                    return `<option value="${cs.id}">${student ? student.name : 'N/A'} (C√≤n ${cs.remainingSessions} bu·ªïi)</option>`;
                }).join('');
        }

        function saveNewMakeupRequest(event) {
            event.preventDefault();

            const classId = document.getElementById('newMakeupClassSelect').value;
            const classStudentId = document.getElementById('newMakeupStudentSelect').value;
            const absentDate = document.getElementById('newMakeupAbsentDate').value;
            const reason = document.getElementById('newMakeupReason').value.trim();

            if (!classId || !classStudentId || !absentDate) {
                showNotification('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!', 'error');
                return;
            }

            const cs = classStudents.find(c => c.id === classStudentId);
            if (!cs) return;

            // Ki·ªÉm tra ƒë√£ c√≥ y√™u c·∫ßu cho ng√†y n√†y ch∆∞a
            const existing = makeupRequests.find(m =>
                m.classStudentId === classStudentId &&
                m.originalDate === absentDate &&
                m.status !== 'completed' && m.status !== 'expired'
            );

            if (existing) {
                showNotification('ƒê√£ c√≥ y√™u c·∫ßu h·ªçc b√π cho ng√†y n√†y!', 'error');
                return;
            }

            // T√≠nh ng√†y h·∫øt h·∫°n (30 ng√†y t·ª´ ng√†y ngh·ªâ)
            const expiryDate = new Date(absentDate);
            expiryDate.setDate(expiryDate.getDate() + 30);

            // T·∫°o y√™u c·∫ßu h·ªçc b√π (ch∆∞a c√≥ attendanceId v√¨ ch∆∞a ƒëi·ªÉm danh)
            makeupRequests.push({
                id: generateId(),
                studentId: cs.studentId,
                classStudentId: classStudentId,
                originalAttendanceId: null, // S·∫Ω c·∫≠p nh·∫≠t khi ƒëi·ªÉm danh
                originalClassId: classId,
                originalScheduleId: null,
                originalDate: absentDate,
                requestDate: new Date().toISOString().split('T')[0],
                expiryDate: expiryDate.toISOString().split('T')[0],
                makeupClassId: null,
                makeupScheduleId: null,
                makeupDate: null,
                status: 'pending',
                approvedBy: null,
                approvedAt: null,
                completedAt: null,
                notes: reason ? `L√Ω do ngh·ªâ: ${reason}` : null,
                isPreCreated: true, // ƒê√°nh d·∫•u l√† t·∫°o tr∆∞·ªõc
                createdAt: new Date().toISOString()
            });

            saveData('makeupRequests', makeupRequests);
            closeModal('createMakeupModal');
            renderMakeupRequests();
            showNotification('ƒê√£ t·∫°o y√™u c·∫ßu h·ªçc b√π! Nh·ªõ ƒëi·ªÉm danh "C√≥ ph√©p" v√†o ng√†y ngh·ªâ.', 'success');
        }

        /* ============================================================
        üìà PH·∫¶N 30: B√ÅO C√ÅO TH·ªêNG K√ä
        ============================================================ */

        // ===== 30.1 Bi·∫øn l∆∞u tr·ªØ Chart instances =====
        let chartInstances = {
            revenueTime: null,
            revenueSubject: null,
            studentTime: null,
            studentStatus: null,
            attendanceTime: null,
            attendanceRate: null,
            debtTime: null,
            debtStatus: null
        };

        let currentReportTab = 'revenue';
        let reportData = {
            fromDate: null,
            toDate: null
        };

        // ===== 30.2 Kh·ªüi t·∫°o tab B√°o c√°o =====
        function initReportsTab() {
            // ƒê·∫∑t m·∫∑c ƒë·ªãnh l√† th√°ng hi·ªán t·∫°i
            const now = new Date();
            const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
            const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);

            document.getElementById('reportFromDate').value = firstDay.toISOString().split('T')[0];
            document.getElementById('reportToDate').value = lastDay.toISOString().split('T')[0];
            document.getElementById('reportPeriodType').value = 'thisMonth';

            onReportPeriodChange();
            loadReportData();
        }

        function onReportPeriodChange() {
            const periodType = document.getElementById('reportPeriodType').value;
            const now = new Date();
            let fromDate, toDate;

            switch (periodType) {
                case 'thisMonth':
                    fromDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    toDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    break;
                case 'lastMonth':
                    fromDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    toDate = new Date(now.getFullYear(), now.getMonth(), 0);
                    break;
                case 'thisQuarter':
                    const quarter = Math.floor(now.getMonth() / 3);
                    fromDate = new Date(now.getFullYear(), quarter * 3, 1);
                    toDate = new Date(now.getFullYear(), quarter * 3 + 3, 0);
                    break;
                case 'thisYear':
                    fromDate = new Date(now.getFullYear(), 0, 1);
                    toDate = new Date(now.getFullYear(), 11, 31);
                    break;
                case 'custom':
                    // Gi·ªØ nguy√™n gi√° tr·ªã hi·ªán t·∫°i
                    return;
            }

            document.getElementById('reportFromDate').value = fromDate.toISOString().split('T')[0];
            document.getElementById('reportToDate').value = toDate.toISOString().split('T')[0];

            loadReportData();
        }

        function switchReportTab(tab) {
            currentReportTab = tab;

            // Update tab buttons
            document.querySelectorAll('.report-tab').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tab);
            });

            // Show/hide content
            document.querySelectorAll('.report-content').forEach(content => {
                content.style.display = 'none';
            });

            const tabMap = {
                'revenue': 'reportRevenue',
                'students': 'reportStudents',
                'attendance': 'reportAttendance',
                'debt': 'reportDebt'
            };

            document.getElementById(tabMap[tab]).style.display = 'block';

            // Load data for this tab
            loadReportData();
        }

        // ===== 30.3 Load d·ªØ li·ªáu b√°o c√°o =====
        function loadReportData() {
            const fromDate = document.getElementById('reportFromDate').value;
            const toDate = document.getElementById('reportToDate').value;

            if (!fromDate || !toDate) return;

            reportData.fromDate = fromDate;
            reportData.toDate = toDate;

            switch (currentReportTab) {
                case 'revenue':
                    loadRevenueReport();
                    break;
                case 'students':
                    loadStudentsReport();
                    break;
                case 'attendance':
                    loadAttendanceReport();
                    break;
                case 'debt':
                    loadDebtReport();
                    break;
            }
        }

        function refreshReports() {
            loadReportData();
            showNotification('ƒê√£ l√†m m·ªõi b√°o c√°o!', 'success');
        }

        // ===== 30.4 B√°o c√°o Doanh thu =====
        function loadRevenueReport() {
            const { fromDate, toDate } = reportData;

            // L·ªçc bi√™n lai trong k·ª≥
            const filteredReceipts = receipts.filter(r => r.date >= fromDate && r.date <= toDate);

            // Th·ªëng k√™ t·ªïng quan
            const totalAmount = filteredReceipts.reduce((sum, r) => sum + (parseFloat(r.amount) || 0), 0);
            const receiptCount = filteredReceipts.length;
            const avgAmount = receiptCount > 0 ? totalAmount / receiptCount : 0;

            // Phi·∫øu ƒêK m·ªõi trong k·ª≥
            const newRegs = registrations.filter(r => r.registrationDate >= fromDate && r.registrationDate <= toDate);

            document.getElementById('revenueTotalAmount').textContent = formatCurrencyShort(totalAmount);
            document.getElementById('revenueReceiptCount').textContent = receiptCount;
            document.getElementById('revenueAvgAmount').textContent = formatCurrencyShort(avgAmount);
            document.getElementById('revenueRegCount').textContent = newRegs.length;

            // Bi·ªÉu ƒë·ªì doanh thu theo th·ªùi gian
            renderRevenueTimeChart(filteredReceipts);

            // Bi·ªÉu ƒë·ªì doanh thu theo m√¥n h·ªçc
            renderRevenueSubjectChart(filteredReceipts);
        }

        function renderRevenueTimeChart(data) {
            const loading = document.getElementById('revenueChartLoading');
            const canvas = document.getElementById('revenueTimeChart');
            const table = document.getElementById('revenueTimeTable');

            // Nh√≥m theo ng√†y
            const grouped = {};
            data.forEach(r => {
                const date = r.date;
                if (!grouped[date]) grouped[date] = 0;
                grouped[date] += parseFloat(r.amount) || 0;
            });

            const labels = Object.keys(grouped).sort();
            const values = labels.map(l => grouped[l]);

            // Fallback table
            table.innerHTML = `
                <table style="width: 100%; font-size: 12px;">
                    <thead><tr><th>Ng√†y</th><th>Doanh thu</th></tr></thead>
                    <tbody>${labels.map((l, i) => `<tr><td>${formatDate(l)}</td><td class="text-success">${formatCurrency(values[i])}</td></tr>`).join('')}</tbody>
                </table>
            `;

            // Render chart
            try {
                if (typeof Chart === 'undefined') throw new Error('Chart.js not loaded');

                loading.style.display = 'none';
                canvas.style.display = 'block';
                table.style.display = 'none';

                // Destroy old chart
                if (chartInstances.revenueTime) {
                    chartInstances.revenueTime.destroy();
                }

                chartInstances.revenueTime = new Chart(canvas, {
                    type: 'bar',
                    data: {
                        labels: labels.map(l => formatDate(l)),
                        datasets: [{
                            label: 'Doanh thu',
                            data: values,
                            backgroundColor: 'rgba(74, 144, 164, 0.7)',
                            borderColor: 'rgba(74, 144, 164, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        return formatCurrency(context.raw);
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function (value) {
                                        return formatCurrencyShort(value);
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (e) {
                console.warn('Chart error:', e);
                loading.style.display = 'none';
                canvas.style.display = 'none';
                table.style.display = 'block';
            }
        }

        function renderRevenueSubjectChart(data) {
            const loading = document.getElementById('revenueSubjectLoading');
            const canvas = document.getElementById('revenueSubjectChart');
            const table = document.getElementById('revenueSubjectTable');

            // Nh√≥m theo m√¥n h·ªçc
            const grouped = {};
            data.forEach(r => {
                const reg = registrations.find(reg => reg.id === r.registrationId);
                const subject = reg ? reg.subject : 'Kh√°c';
                if (!grouped[subject]) grouped[subject] = 0;
                grouped[subject] += parseFloat(r.amount) || 0;
            });

            const labels = Object.keys(grouped);
            const values = labels.map(l => grouped[l]);
            const colors = ['#3498DB', '#27AE60', '#F39C12', '#9B59B6', '#E74C3C', '#1ABC9C', '#34495E'];

            // Fallback table
            table.innerHTML = `
                <table style="width: 100%; font-size: 12px;">
                    <thead><tr><th>M√¥n h·ªçc</th><th>Doanh thu</th></tr></thead>
                    <tbody>${labels.map((l, i) => `<tr><td>${l}</td><td class="text-success">${formatCurrency(values[i])}</td></tr>`).join('')}</tbody>
                </table>
            `;

            try {
                if (typeof Chart === 'undefined') throw new Error('Chart.js not loaded');

                loading.style.display = 'none';
                canvas.style.display = 'block';
                table.style.display = 'none';

                if (chartInstances.revenueSubject) {
                    chartInstances.revenueSubject.destroy();
                }

                chartInstances.revenueSubject = new Chart(canvas, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: values,
                            backgroundColor: colors.slice(0, labels.length),
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'bottom' },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        return context.label + ': ' + formatCurrency(context.raw);
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (e) {
                loading.style.display = 'none';
                canvas.style.display = 'none';
                table.style.display = 'block';
            }
        }

        // ===== 30.5 B√°o c√°o H·ªçc vi√™n =====
        function loadStudentsReport() {
            const { fromDate, toDate } = reportData;

            // T·ªïng h·ªçc vi√™n
            const totalStudents = students.length;

            // HV m·ªõi trong k·ª≥
            const newStudents = students.filter(s => s.createdAt && s.createdAt.split('T')[0] >= fromDate && s.createdAt.split('T')[0] <= toDate);

            // Theo tr·∫°ng th√°i
            const activeStudents = students.filter(s => s.status === 'ƒê√£ ƒêƒÉng K√Ω').length;
            const completedStudents = students.filter(s => s.status === 'Ho√†n Th√†nh').length;

            document.getElementById('studentTotalCount').textContent = totalStudents;
            document.getElementById('studentNewCount').textContent = newStudents.length;
            document.getElementById('studentActiveCount').textContent = activeStudents;
            document.getElementById('studentCompletedCount').textContent = completedStudents;

            renderStudentTimeChart();
            renderStudentStatusChart();
        }

        function renderStudentTimeChart() {
            const loading = document.getElementById('studentChartLoading');
            const canvas = document.getElementById('studentTimeChart');
            const table = document.getElementById('studentTimeTable');

            // Nh√≥m theo th√°ng
            const grouped = {};
            students.forEach(s => {
                if (!s.createdAt) return;
                const month = s.createdAt.substring(0, 7); // YYYY-MM
                if (!grouped[month]) grouped[month] = 0;
                grouped[month]++;
            });

            const labels = Object.keys(grouped).sort().slice(-6); // 6 th√°ng g·∫ßn nh·∫•t
            const values = labels.map(l => grouped[l]);

            table.innerHTML = `
                <table style="width: 100%; font-size: 12px;">
                    <thead><tr><th>Th√°ng</th><th>HV m·ªõi</th></tr></thead>
                    <tbody>${labels.map((l, i) => `<tr><td>${l}</td><td>${values[i]}</td></tr>`).join('')}</tbody>
                </table>
            `;

            try {
                if (typeof Chart === 'undefined') throw new Error('Chart.js not loaded');

                loading.style.display = 'none';
                canvas.style.display = 'block';
                table.style.display = 'none';

                if (chartInstances.studentTime) {
                    chartInstances.studentTime.destroy();
                }

                chartInstances.studentTime = new Chart(canvas, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'H·ªçc vi√™n m·ªõi',
                            data: values,
                            borderColor: '#3498DB',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            fill: true,
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: true } }
                    }
                });
            } catch (e) {
                loading.style.display = 'none';
                canvas.style.display = 'none';
                table.style.display = 'block';
            }
        }

        function renderStudentStatusChart() {
            const loading = document.getElementById('studentStatusLoading');
            const canvas = document.getElementById('studentStatusChart');
            const table = document.getElementById('studentStatusTable');

            const statusCounts = {
                'H·ªçc Th·ª≠': students.filter(s => s.status === 'H·ªçc Th·ª≠').length,
                'Ch·ªù ƒêƒÉng K√Ω': students.filter(s => s.status === 'Ch·ªù ƒêƒÉng K√Ω').length,
                'ƒê√£ ƒêƒÉng K√Ω': students.filter(s => s.status === 'ƒê√£ ƒêƒÉng K√Ω').length,
                'Ho√†n Th√†nh': students.filter(s => s.status === 'Ho√†n Th√†nh').length,
                'Cancel': students.filter(s => s.status === 'Cancel').length
            };

            const labels = Object.keys(statusCounts);
            const values = Object.values(statusCounts);
            const colors = ['#3498DB', '#F39C12', '#27AE60', '#9B59B6', '#E74C3C'];

            table.innerHTML = `
                <table style="width: 100%; font-size: 12px;">
                    <thead><tr><th>Tr·∫°ng th√°i</th><th>S·ªë l∆∞·ª£ng</th></tr></thead>
                    <tbody>${labels.map((l, i) => `<tr><td>${l}</td><td>${values[i]}</td></tr>`).join('')}</tbody>
                </table>
            `;

            try {
                if (typeof Chart === 'undefined') throw new Error('Chart.js not loaded');

                loading.style.display = 'none';
                canvas.style.display = 'block';
                table.style.display = 'none';

                if (chartInstances.studentStatus) {
                    chartInstances.studentStatus.destroy();
                }

                chartInstances.studentStatus = new Chart(canvas, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: values,
                            backgroundColor: colors,
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { position: 'bottom' } }
                    }
                });
            } catch (e) {
                loading.style.display = 'none';
                canvas.style.display = 'none';
                table.style.display = 'block';
            }
        }

        // ===== 30.6 B√°o c√°o ƒêi·ªÉm danh =====
        function loadAttendanceReport() {
            const { fromDate, toDate } = reportData;

            const filteredAttendances = attendances.filter(a => a.attendanceDate >= fromDate && a.attendanceDate <= toDate);

            const totalCount = filteredAttendances.length;
            const presentCount = filteredAttendances.filter(a => a.status === 'present' || a.status === 'late').length;
            const absentCount = filteredAttendances.filter(a => a.status === 'absent').length;
            const makeupCount = filteredAttendances.filter(a => a.isMakeupSession).length;

            const presentRate = totalCount > 0 ? Math.round((presentCount / totalCount) * 100) : 0;

            document.getElementById('attendanceTotalCount').textContent = totalCount;
            document.getElementById('attendancePresentRate').textContent = presentRate + '%';
            document.getElementById('attendanceAbsentCount').textContent = absentCount;
            document.getElementById('attendanceMakeupCount').textContent = makeupCount;

            renderAttendanceTimeChart(filteredAttendances);
            renderAttendanceRateChart(filteredAttendances);
        }

        function renderAttendanceTimeChart(data) {
            const loading = document.getElementById('attendanceChartLoading');
            const canvas = document.getElementById('attendanceTimeChart');
            const table = document.getElementById('attendanceTimeTable');

            const grouped = {};
            data.forEach(a => {
                const date = a.attendanceDate;
                if (!grouped[date]) grouped[date] = { present: 0, absent: 0 };
                if (a.status === 'present' || a.status === 'late') grouped[date].present++;
                else grouped[date].absent++;
            });

            const labels = Object.keys(grouped).sort().slice(-14); // 14 ng√†y g·∫ßn nh·∫•t
            const presentValues = labels.map(l => grouped[l]?.present || 0);
            const absentValues = labels.map(l => grouped[l]?.absent || 0);

            table.innerHTML = `
                <table style="width: 100%; font-size: 12px;">
                    <thead><tr><th>Ng√†y</th><th>C√≥ m·∫∑t</th><th>V·∫Øng</th></tr></thead>
                    <tbody>${labels.map((l, i) => `<tr><td>${formatDate(l)}</td><td class="text-success">${presentValues[i]}</td><td class="text-danger">${absentValues[i]}</td></tr>`).join('')}</tbody>
                </table>
            `;

            try {
                if (typeof Chart === 'undefined') throw new Error('Chart.js not loaded');

                loading.style.display = 'none';
                canvas.style.display = 'block';
                table.style.display = 'none';

                if (chartInstances.attendanceTime) {
                    chartInstances.attendanceTime.destroy();
                }

                chartInstances.attendanceTime = new Chart(canvas, {
                    type: 'bar',
                    data: {
                        labels: labels.map(l => formatDate(l)),
                        datasets: [
                            {
                                label: 'C√≥ m·∫∑t',
                                data: presentValues,
                                backgroundColor: 'rgba(39, 174, 96, 0.7)'
                            },
                            {
                                label: 'V·∫Øng',
                                data: absentValues,
                                backgroundColor: 'rgba(231, 76, 60, 0.7)'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { position: 'top' } },
                        scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } }
                    }
                });
            } catch (e) {
                loading.style.display = 'none';
                canvas.style.display = 'none';
                table.style.display = 'block';
            }
        }

        function renderAttendanceRateChart(data) {
            const loading = document.getElementById('attendanceRateLoading');
            const canvas = document.getElementById('attendanceRateChart');
            const table = document.getElementById('attendanceRateTable');

            const counts = {
                'C√≥ m·∫∑t': data.filter(a => a.status === 'present').length,
                'Mu·ªôn': data.filter(a => a.status === 'late').length,
                'V·∫Øng': data.filter(a => a.status === 'absent').length,
                'C√≥ ph√©p': data.filter(a => a.status === 'excused').length
            };

            const labels = Object.keys(counts);
            const values = Object.values(counts);
            const colors = ['#27AE60', '#F39C12', '#E74C3C', '#3498DB'];

            table.innerHTML = `
                <table style="width: 100%; font-size: 12px;">
                    <thead><tr><th>Tr·∫°ng th√°i</th><th>S·ªë l∆∞·ª£t</th></tr></thead>
                    <tbody>${labels.map((l, i) => `<tr><td>${l}</td><td>${values[i]}</td></tr>`).join('')}</tbody>
                </table>
            `;

            try {
                if (typeof Chart === 'undefined') throw new Error('Chart.js not loaded');

                loading.style.display = 'none';
                canvas.style.display = 'block';
                table.style.display = 'none';

                if (chartInstances.attendanceRate) {
                    chartInstances.attendanceRate.destroy();
                }

                chartInstances.attendanceRate = new Chart(canvas, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: values,
                            backgroundColor: colors,
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { position: 'bottom' } }
                    }
                });
            } catch (e) {
                loading.style.display = 'none';
                canvas.style.display = 'none';
                table.style.display = 'block';
            }
        }

        // ===== 30.7 B√°o c√°o C√¥ng n·ª£ =====
        function loadDebtReport() {
            const { fromDate, toDate } = reportData;

            // T·ªïng ph·∫£i thu
            let totalDebt = 0;
            let totalPaid = 0;
            let remainingDebt = 0;

            registrations.forEach(reg => {
                const debt = calculateDebtForRegistration(reg.id);
                totalDebt += debt.totalAmount;
                remainingDebt += debt.debtAmount;
            });

            // ƒê√£ thu trong k·ª≥
            const paidInPeriod = receipts
                .filter(r => r.date >= fromDate && r.date <= toDate)
                .reduce((sum, r) => sum + (parseFloat(r.amount) || 0), 0);

            const paidRate = totalDebt > 0 ? Math.round(((totalDebt - remainingDebt) / totalDebt) * 100) : 0;

            document.getElementById('debtReportTotal').textContent = formatCurrencyShort(totalDebt);
            document.getElementById('debtReportPaid').textContent = formatCurrencyShort(paidInPeriod);
            document.getElementById('debtReportRemaining').textContent = formatCurrencyShort(remainingDebt);
            document.getElementById('debtReportRate').textContent = paidRate + '%';

            renderDebtTimeChart();
            renderDebtStatusChart();
        }

        function renderDebtTimeChart() {
            const loading = document.getElementById('debtChartLoading');
            const canvas = document.getElementById('debtTimeChart');
            const table = document.getElementById('debtTimeTable');

            // Nh√≥m theo th√°ng
            const grouped = {};
            receipts.forEach(r => {
                const month = r.date.substring(0, 7);
                if (!grouped[month]) grouped[month] = 0;
                grouped[month] += parseFloat(r.amount) || 0;
            });

            const labels = Object.keys(grouped).sort().slice(-6);
            const values = labels.map(l => grouped[l]);

            table.innerHTML = `
                <table style="width: 100%; font-size: 12px;">
                    <thead><tr><th>Th√°ng</th><th>ƒê√£ thu</th></tr></thead>
                    <tbody>${labels.map((l, i) => `<tr><td>${l}</td><td class="text-success">${formatCurrency(values[i])}</td></tr>`).join('')}</tbody>
                </table>
            `;

            try {
                if (typeof Chart === 'undefined') throw new Error('Chart.js not loaded');

                loading.style.display = 'none';
                canvas.style.display = 'block';
                table.style.display = 'none';

                if (chartInstances.debtTime) {
                    chartInstances.debtTime.destroy();
                }

                chartInstances.debtTime = new Chart(canvas, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'ƒê√£ thu',
                            data: values,
                            backgroundColor: 'rgba(39, 174, 96, 0.7)',
                            borderColor: 'rgba(39, 174, 96, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { callback: value => formatCurrencyShort(value) }
                            }
                        }
                    }
                });
            } catch (e) {
                loading.style.display = 'none';
                canvas.style.display = 'none';
                table.style.display = 'block';
            }
        }

        function renderDebtStatusChart() {
            const loading = document.getElementById('debtStatusLoading');
            const canvas = document.getElementById('debtStatusChart');
            const table = document.getElementById('debtStatusTable');

            let paidCount = 0, partialCount = 0, unpaidCount = 0;

            registrations.forEach(reg => {
                const debt = calculateDebtForRegistration(reg.id);
                const status = getDebtStatus(debt.debtAmount, debt.paidAmount);
                if (status === 'paid') paidCount++;
                else if (status === 'partial') partialCount++;
                else unpaidCount++;
            });

            const labels = ['ƒê√£ ƒë√≥ng ƒë·ªß', 'ƒê√≥ng 1 ph·∫ßn', 'Ch∆∞a ƒë√≥ng'];
            const values = [paidCount, partialCount, unpaidCount];
            const colors = ['#27AE60', '#F39C12', '#E74C3C'];

            table.innerHTML = `
                <table style="width: 100%; font-size: 12px;">
                    <thead><tr><th>Tr·∫°ng th√°i</th><th>S·ªë phi·∫øu</th></tr></thead>
                    <tbody>${labels.map((l, i) => `<tr><td>${l}</td><td>${values[i]}</td></tr>`).join('')}</tbody>
                </table>
            `;

            try {
                if (typeof Chart === 'undefined') throw new Error('Chart.js not loaded');

                loading.style.display = 'none';
                canvas.style.display = 'block';
                table.style.display = 'none';

                if (chartInstances.debtStatus) {
                    chartInstances.debtStatus.destroy();
                }

                chartInstances.debtStatus = new Chart(canvas, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: values,
                            backgroundColor: colors,
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { position: 'bottom' } }
                    }
                });
            } catch (e) {
                loading.style.display = 'none';
                canvas.style.display = 'none';
                table.style.display = 'block';
            }
        }

        // ===== 30.8 Export b√°o c√°o =====
        function exportReportToExcel() {
            const { fromDate, toDate } = reportData;
            const wb = XLSX.utils.book_new();

            // Sheet 1: Doanh thu
            const revenueData = receipts
                .filter(r => r.date >= fromDate && r.date <= toDate)
                .map(r => {
                    const student = students.find(s => s.id === r.studentId);
                    return {
                        'Ng√†y': formatDate(r.date),
                        'H·ªçc vi√™n': student ? student.name : '',
                        'Lo·∫°i': r.type,
                        'N·ªôi dung': r.description,
                        'S·ªë ti·ªÅn': r.amount
                    };
                });
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(revenueData), 'Doanh thu');

            // Sheet 2: H·ªçc vi√™n
            const studentData = students.map(s => ({
                'T√™n': s.name,
                'Tu·ªïi': s.age,
                'Ph·ª• huynh': s.parentName,
                'SƒêT': s.parentPhone,
                'Tr·∫°ng th√°i': s.status,
                'Ng√†y t·∫°o': s.createdAt ? formatDate(s.createdAt.split('T')[0]) : ''
            }));
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(studentData), 'H·ªçc vi√™n');

            // Sheet 3: ƒêi·ªÉm danh
            const attendanceData = attendances
                .filter(a => a.attendanceDate >= fromDate && a.attendanceDate <= toDate)
                .map(a => {
                    const student = students.find(s => s.id === a.studentId);
                    const cls = classes.find(c => c.id === a.classId);
                    return {
                        'Ng√†y': formatDate(a.attendanceDate),
                        'L·ªõp': cls ? cls.className : '',
                        'H·ªçc vi√™n': student ? student.name : '',
                        'Tr·∫°ng th√°i': a.status === 'present' ? 'C√≥ m·∫∑t' : a.status === 'late' ? 'Mu·ªôn' : a.status === 'absent' ? 'V·∫Øng' : 'C√≥ ph√©p',
                        'H·ªçc b√π': a.isMakeupSession ? 'C√≥' : ''
                    };
                });
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(attendanceData), 'ƒêi·ªÉm danh');

            // Sheet 4: C√¥ng n·ª£
            const debtData = registrations.map(reg => {
                const student = students.find(s => s.id === reg.studentId);
                const debt = calculateDebtForRegistration(reg.id);
                return {
                    'H·ªçc vi√™n': student ? student.name : '',
                    'M√£ phi·∫øu': reg.regCode,
                    'M√¥n h·ªçc': reg.subject,
                    'T·ªïng ti·ªÅn': debt.totalAmount,
                    'ƒê√£ ƒë√≥ng': debt.paidAmount,
                    'C√≤n n·ª£': debt.debtAmount
                };
            });
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(debtData), 'C√¥ng n·ª£');

            XLSX.writeFile(wb, `BaoCao_${fromDate}_${toDate}.xlsx`);
            showNotification('Xu·∫•t b√°o c√°o Excel th√†nh c√¥ng!', 'success');
        }


        function renderAll() {
            // Dashboard
            renderDashboard();

            // Students
            renderSubjectCheckboxes();
            renderStudentsTable();
            updateStudentCounts();

            // Trial
            renderTrialStudentsTable();
            updateTrialCounts();

            // Appointments
            renderAppointmentsTable();

            // Registrations
            renderRegistrationsTable();

            // Receipts
            renderReceiptsTable();

            // Categories
            renderSubjectsTable();
            renderPackagesTable();
            renderPromotionsTable();

            // Teachers
            if (canViewTab('teachers')) {
                renderTeachersTable();
            }

            // Classes
            if (canViewTab('classes')) {
                renderClassesTable();
                populateClassFilters();
            }

            // Users
            if (canViewTab('users')) {
                renderUsersTable();
                renderPermissionMatrix();
            }

            // Export
            if (canViewTab('export')) {
                renderBackupHistory();
            }

            // Attendance
            if (canViewTab('attendance')) {
                initAttendanceTab();
            }

            // Makeup
            if (canViewTab('makeup')) {
                checkExpiredMakeupRequests();
                renderMakeupRequests();
            }
            // Rooms
            if (canViewTab('rooms')) {
                renderRoomsTable();
            }

            // Debts
            if (canViewTab('debts')) {
                renderDebtsTable();
            }
            // Reports
            if (canViewTab('reports')) {
                initReportsTab();
            }

            // Update action buttons based on permissions
            updateActionButtons();
        }

        /* ============================================================
        üí≥ PH·∫¶N 29: QU·∫¢N L√ù C√îNG N·ª¢
        ============================================================ */

        // ===== 29.1 T√≠nh to√°n c√¥ng n·ª£ =====
        function calculateDebtForRegistration(regId) {
            const reg = registrations.find(r => r.id === regId);
            if (!reg) return { totalAmount: 0, paidAmount: 0, debtAmount: 0 };

            // T·ªïng ti·ªÅn = finalAmount (ho·∫∑c adjustedAmount n·∫øu ƒë√£ ƒëi·ªÅu ch·ªânh)
            const totalAmount = reg.adjustedAmount !== undefined ? reg.adjustedAmount : reg.finalAmount;

            // ƒê√£ ƒë√≥ng = T·ªïng c√°c bi√™n lai li√™n k·∫øt
            const relatedReceipts = receipts.filter(r => r.registrationId === regId);
            const paidAmount = relatedReceipts.reduce((sum, r) => sum + (parseFloat(r.amount) || 0), 0);

            // C√≤n n·ª£
            const debtAmount = Math.max(0, totalAmount - paidAmount);

            return { totalAmount, paidAmount, debtAmount };
        }

        function getDebtStatus(debtAmount, paidAmount) {
            if (debtAmount === 0 && paidAmount > 0) return 'paid';      // ƒê√£ ƒë√≥ng ƒë·ªß
            if (debtAmount > 0 && paidAmount > 0) return 'partial';     // ƒê√≥ng 1 ph·∫ßn
            if (paidAmount === 0) return 'unpaid';                       // Ch∆∞a ƒë√≥ng
            return 'unknown';
        }

        function getDebtStatusBadge(status) {
            const badges = {
                'paid': '<span class="status-badge da-dk">üü¢ ƒê√£ ƒë√≥ng ƒë·ªß</span>',
                'partial': '<span class="status-badge cho-dk">üü° ƒê√≥ng 1 ph·∫ßn</span>',
                'unpaid': '<span class="status-badge cancel">üî¥ Ch∆∞a ƒë√≥ng</span>'
            };
            return badges[status] || '';
        }

        // ===== 29.2 Render b·∫£ng c√¥ng n·ª£ (C√ì PH√ÇN TRANG) =====
        let currentDebtFilter = 'all';

        function renderDebtsTable() {
            updateDebtStats();
            loadDebtWarnings();

            const tbody = document.getElementById('debtsTableBody');
            const searchTerm = document.getElementById('searchDebt')?.value?.toLowerCase() || '';

            // L·∫•y t·∫•t c·∫£ phi·∫øu ƒêK
            let debtList = registrations.map(reg => {
                const student = students.find(s => s.id === reg.studentId);
                const debt = calculateDebtForRegistration(reg.id);
                const status = getDebtStatus(debt.debtAmount, debt.paidAmount);

                // L·∫•y th√¥ng tin bu·ªïi c√≤n l·∫°i t·ª´ classStudents
                const cs = classStudents.find(c => c.registrationId === reg.id);
                const remainingSessions = cs ? cs.remainingSessions : null;

                // Ki·ªÉm tra c·∫ßn c·∫£nh b√°o kh√¥ng
                const needWarning = (debt.debtAmount > 0 && remainingSessions !== null && remainingSessions <= warningSettings.threshold1);

                return {
                    ...reg,
                    studentName: student ? student.name : 'N/A',
                    ...debt,
                    status,
                    remainingSessions,
                    needWarning
                };
            });

            // √Åp d·ª•ng filter
            if (currentDebtFilter === 'unpaid') {
                debtList = debtList.filter(d => d.status === 'unpaid');
            } else if (currentDebtFilter === 'partial') {
                debtList = debtList.filter(d => d.status === 'partial');
            } else if (currentDebtFilter === 'paid') {
                debtList = debtList.filter(d => d.status === 'paid');
            } else if (currentDebtFilter === 'warning') {
                debtList = debtList.filter(d => d.needWarning);
            }

            // T√¨m ki·∫øm
            if (searchTerm) {
                debtList = debtList.filter(d =>
                    d.studentName.toLowerCase().includes(searchTerm) ||
                    d.regCode.toLowerCase().includes(searchTerm) ||
                    d.subject.toLowerCase().includes(searchTerm)
                );
            }

            // S·∫Øp x·∫øp: C·∫ßn c·∫£nh b√°o l√™n tr∆∞·ªõc, sau ƒë√≥ theo n·ª£ gi·∫£m d·∫ßn
            debtList.sort((a, b) => {
                if (a.needWarning && !b.needWarning) return -1;
                if (!a.needWarning && b.needWarning) return 1;
                return b.debtAmount - a.debtAmount;
            });

            // PH√ÇN TRANG
            const { data, total, totalPages, currentPage } = getPaginatedData(debtList, 'debts');

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">Kh√¥ng c√≥ d·ªØ li·ªáu c√¥ng n·ª£</td></tr>';
                renderPagination('debtsPagination', 'debts', 0, 0, 1);
                return;
            }

            tbody.innerHTML = data.map(d => {
                const sessionWarningClass = getSessionWarningClass(d.remainingSessions);
                const rowClass = d.needWarning ? 'style="background: #FEF9E7;"' : '';

                return `
                <tr ${rowClass}>
                    <td><strong>${d.studentName}</strong></td>
                    <td><span class="text-primary">${d.regCode}</span></td>
                    <td><span class="subject-tag">${d.subject}</span></td>
                    <td>${formatCurrency(d.totalAmount)}</td>
                    <td><span class="text-success">${formatCurrency(d.paidAmount)}</span></td>
                    <td><strong class="${d.debtAmount > 0 ? 'text-danger' : 'text-success'}">${formatCurrency(d.debtAmount)}</strong></td>
                    <td><span class="${sessionWarningClass}">${d.remainingSessions !== null ? d.remainingSessions + ' bu·ªïi' : '-'}</span></td>
                    <td>${getDebtStatusBadge(d.status)}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn view" onclick="viewDebtDetail('${d.id}')" title="Xem chi ti·∫øt">üëÅÔ∏è</button>
                            ${d.debtAmount > 0 ? `<button class="action-btn receipt" onclick="openDebtPaymentModal('${d.id}')" title="Thanh to√°n">üí∞</button>` : ''}
                            ${canEdit('debts') ? `<button class="action-btn edit" onclick="openAdjustDebtModal('${d.id}')" title="ƒêi·ªÅu ch·ªânh">‚úèÔ∏è</button>` : ''}
                        </div>
                    </td>
                </tr>
            `;
            }).join('');

            // RENDER PH√ÇN TRANG
            renderPagination('debtsPagination', 'debts', total, totalPages, currentPage);
        }

        // C·∫≠p nh·∫≠t h√†m filter ƒë·ªÉ reset page
        function filterDebts(filter) {
            currentDebtFilter = filter;
            paginationState.debts.page = 1; // Reset v·ªÅ trang 1
            document.querySelectorAll('#debts .filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
            });
            renderDebtsTable();
        }

        // C·∫≠p nh·∫≠t h√†m search ƒë·ªÉ reset page
        function searchDebts() {
            paginationState.debts.page = 1; // Reset v·ªÅ trang 1
            renderDebtsTable();
        }

        function filterDebts(filter) {
            currentDebtFilter = filter;
            document.querySelectorAll('#debts .filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
            });
            renderDebtsTable();
        }

        function searchDebts() {
            renderDebtsTable();
        }

        // ===== 29.3 Th·ªëng k√™ c√¥ng n·ª£ =====
        function updateDebtStats() {
            let totalAmount = 0;
            let paidAmount = 0;
            let debtAmount = 0;
            let debtStudentCount = 0;

            const studentWithDebt = new Set();

            registrations.forEach(reg => {
                const debt = calculateDebtForRegistration(reg.id);
                totalAmount += debt.totalAmount;
                paidAmount += debt.paidAmount;
                debtAmount += debt.debtAmount;

                if (debt.debtAmount > 0) {
                    studentWithDebt.add(reg.studentId);
                }
            });

            debtStudentCount = studentWithDebt.size;

            document.getElementById('debtTotalAmount').textContent = formatCurrencyShort(totalAmount);
            document.getElementById('debtPaidAmount').textContent = formatCurrencyShort(paidAmount);
            document.getElementById('debtRemainingAmount').textContent = formatCurrencyShort(debtAmount);
            document.getElementById('debtStudentCount').textContent = debtStudentCount;
        }

        // ===== 29.4 C·∫£nh b√°o c√¥ng n·ª£ =====
        function loadDebtWarnings() {
            const warnings = [];

            registrations.forEach(reg => {
                const student = students.find(s => s.id === reg.studentId);
                const debt = calculateDebtForRegistration(reg.id);
                const cs = classStudents.find(c => c.registrationId === reg.id);

                if (!cs || !student) return;

                const remaining = cs.remainingSessions;

                // C·∫£nh b√°o c√≤n n·ª£ + √≠t bu·ªïi
                if (debt.debtAmount > 0) {
                    let level = null;
                    let message = '';

                    if (remaining === 0) {
                        level = 'critical';
                        message = `üî¥ <strong>${student.name}</strong> - H·∫æT BU·ªîI + C√≤n n·ª£ <strong>${formatCurrency(debt.debtAmount)}</strong>`;
                    } else if (remaining <= warningSettings.threshold3) {
                        level = 'high';
                        message = `üü† <strong>${student.name}</strong> - C√≤n ${remaining} bu·ªïi + N·ª£ <strong>${formatCurrency(debt.debtAmount)}</strong>`;
                    } else if (remaining <= warningSettings.threshold2) {
                        level = 'medium';
                        message = `üü° <strong>${student.name}</strong> - C√≤n ${remaining} bu·ªïi + N·ª£ <strong>${formatCurrency(debt.debtAmount)}</strong>`;
                    } else if (remaining <= warningSettings.threshold1) {
                        level = 'low';
                        message = `‚ö™ <strong>${student.name}</strong> - C√≤n ${remaining} bu·ªïi + N·ª£ <strong>${formatCurrency(debt.debtAmount)}</strong>`;
                    }

                    if (level) {
                        warnings.push({ level, message, regId: reg.id, studentName: student.name, remaining, debtAmount: debt.debtAmount });
                    }
                }

                // C·∫£nh b√°o √≠t bu·ªïi (kh√¥ng n·ª£)
                if (debt.debtAmount === 0 && remaining <= warningSettings.threshold2 && remaining > 0) {
                    warnings.push({
                        level: 'info',
                        message: `‚ÑπÔ∏è <strong>${student.name}</strong> - C√≤n ${remaining} bu·ªïi (ƒê√£ ƒë√≥ng ƒë·ªß h·ªçc ph√≠)`,
                        regId: reg.id,
                        studentName: student.name,
                        remaining,
                        debtAmount: 0
                    });
                }
            });

            // S·∫Øp x·∫øp theo m·ª©c ƒë·ªô
            const levelOrder = { critical: 0, high: 1, medium: 2, low: 3, info: 4 };
            warnings.sort((a, b) => levelOrder[a.level] - levelOrder[b.level]);

            const container = document.getElementById('debtWarningsList');

            if (warnings.length === 0) {
                container.innerHTML = '<p class="text-success">‚úÖ Kh√¥ng c√≥ c·∫£nh b√°o n√†o</p>';
                return;
            }

            container.innerHTML = warnings.slice(0, 10).map(w => {
                const bgColor = {
                    critical: '#FDEDEC',
                    high: '#FEF5E7',
                    medium: '#FEF9E7',
                    low: '#F8F9FA',
                    info: '#EBF5FB'
                }[w.level];

                return `
                    <div style="background: ${bgColor}; padding: 10px 15px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-size: 13px;">${w.message}</span>
                        <button class="btn btn-sm btn-primary" onclick="openDebtPaymentModal('${w.regId}')">üí∞ Thu</button>
                    </div>
                `;
            }).join('');

            if (warnings.length > 10) {
                container.innerHTML += `<p class="text-muted text-center">... v√† ${warnings.length - 10} c·∫£nh b√°o kh√°c</p>`;
            }
        }

        function refreshDebtWarnings() {
            loadDebtWarnings();
            showNotification('ƒê√£ l√†m m·ªõi danh s√°ch c·∫£nh b√°o!', 'success');
        }

        // ===== 29.5 Modal thanh to√°n =====
        let currentPaymentRegId = null;

        function openDebtPaymentModal(regId) {
            const reg = registrations.find(r => r.id === regId);
            if (!reg) return;

            currentPaymentRegId = regId;

            const student = students.find(s => s.id === reg.studentId);
            const debt = calculateDebtForRegistration(regId);

            document.getElementById('paymentRegistrationId').value = regId;
            document.getElementById('paymentStudentName').textContent = student ? student.name : 'N/A';
            document.getElementById('paymentRegCode').textContent = reg.regCode;
            document.getElementById('paymentTotalAmount').textContent = formatCurrency(debt.totalAmount);
            document.getElementById('paymentPaidAmount').textContent = formatCurrency(debt.paidAmount);
            document.getElementById('paymentDebtAmount').textContent = formatCurrency(debt.debtAmount);

            document.getElementById('paymentAmount').value = formatNumberInput(debt.debtAmount);
            document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('paymentNotes').value = '';

            calculateRemainingDebt();

            openModal('debtPaymentModal');
        }

        function calculateRemainingDebt() {
            const regId = document.getElementById('paymentRegistrationId').value;
            const debt = calculateDebtForRegistration(regId);
            const paymentAmount = parseCurrencyInput(document.getElementById('paymentAmount').value);

            const remaining = Math.max(0, debt.debtAmount - paymentAmount);
            document.getElementById('paymentRemainingPreview').textContent = formatCurrency(remaining);

            if (remaining === 0) {
                document.getElementById('paymentPreview').style.background = '#E8F8F0';
                document.getElementById('paymentRemainingPreview').className = 'text-success';
            } else {
                document.getElementById('paymentPreview').style.background = '#FEF9E7';
                document.getElementById('paymentRemainingPreview').className = 'text-warning';
            }
        }

        function saveDebtPayment(event) {
            event.preventDefault();

            const regId = document.getElementById('paymentRegistrationId').value;
            const amount = parseCurrencyInput(document.getElementById('paymentAmount').value);
            const receiptType = document.getElementById('paymentReceiptType').value;
            const date = document.getElementById('paymentDate').value;
            const notes = document.getElementById('paymentNotes').value.trim();

            if (amount <= 0) {
                showNotification('S·ªë ti·ªÅn thanh to√°n ph·∫£i l·ªõn h∆°n 0!', 'error');
                return;
            }

            const reg = registrations.find(r => r.id === regId);
            const student = students.find(s => s.id === reg.studentId);

            // T·∫°o bi√™n lai
            receipts.push({
                id: generateId(),
                studentId: reg.studentId,
                registrationId: regId,
                type: receiptType,
                description: `Thanh to√°n h·ªçc ph√≠ - ${reg.subject} - ${reg.regCode}`,
                amount: amount,
                date: date,
                notes: notes,
                parentName: student ? student.parentName : '',
                parentPhone: student ? student.parentPhone : '',
                createdBy: currentUser.id,
                createdAt: new Date().toISOString()
            });

            saveData('receipts', receipts);

            closeModal('debtPaymentModal');
            renderDebtsTable();
            renderReceiptsTable();

            const newDebt = calculateDebtForRegistration(regId);
            if (newDebt.debtAmount === 0) {
                showNotification('Thanh to√°n th√†nh c√¥ng! H·ªçc vi√™n ƒë√£ ƒë√≥ng ƒë·ªß h·ªçc ph√≠.', 'success');
            } else {
                showNotification(`Thanh to√°n th√†nh c√¥ng! C√≤n n·ª£: ${formatCurrency(newDebt.debtAmount)}`, 'success');
            }
        }

        // ===== 29.6 Xem chi ti·∫øt c√¥ng n·ª£ =====
        function viewDebtDetail(regId) {
            const reg = registrations.find(r => r.id === regId);
            if (!reg) return;

            currentPaymentRegId = regId;

            const student = students.find(s => s.id === reg.studentId);
            const debt = calculateDebtForRegistration(regId);
            const relatedReceipts = receipts.filter(r => r.registrationId === regId);
            const cs = classStudents.find(c => c.registrationId === regId);
            const cls = cs ? classes.find(c => c.id === cs.classId) : null;

            document.getElementById('debtDetailContent').innerHTML = `
                <div class="d-flex gap-20 flex-wrap">
                    <div class="flex-1" style="min-width: 280px;">
                        <div class="quick-view-section">
                            <h4>üë§ Th√¥ng tin h·ªçc vi√™n</h4>
                            <div class="quick-view-row"><span class="quick-view-label">H·ªç t√™n:</span><span class="quick-view-value"><strong>${student ? student.name : 'N/A'}</strong></span></div>
                            <div class="quick-view-row"><span class="quick-view-label">Ph·ª• huynh:</span><span class="quick-view-value">${student ? student.parentName : ''}</span></div>
                            <div class="quick-view-row"><span class="quick-view-label">SƒêT:</span><span class="quick-view-value">${student ? student.parentPhone : ''}</span></div>
                        </div>
                        
                        <div class="quick-view-section">
                            <h4>üìã Th√¥ng tin ƒëƒÉng k√Ω</h4>
                            <div class="quick-view-row"><span class="quick-view-label">M√£ phi·∫øu:</span><span class="quick-view-value"><strong>${reg.regCode}</strong></span></div>
                            <div class="quick-view-row"><span class="quick-view-label">M√¥n h·ªçc:</span><span class="quick-view-value">${reg.subject}</span></div>
                            <div class="quick-view-row"><span class="quick-view-label">L·ªõp:</span><span class="quick-view-value">${cls ? cls.className : 'Ch∆∞a g√°n'}</span></div>
                            <div class="quick-view-row"><span class="quick-view-label">Ng√†y ƒêK:</span><span class="quick-view-value">${formatDate(reg.registrationDate)}</span></div>
                        </div>
                    </div>
                    
                    <div class="flex-1" style="min-width: 280px;">
                        <div class="quick-view-section">
                            <h4>üí∞ Th√¥ng tin c√¥ng n·ª£</h4>
                            <div class="quick-view-row"><span class="quick-view-label">H·ªçc ph√≠ g·ªëc:</span><span class="quick-view-value">${formatCurrency(reg.tuitionFee)}</span></div>
                            <div class="quick-view-row"><span class="quick-view-label">Gi·∫£m gi√°:</span><span class="quick-view-value text-danger">-${formatCurrency(reg.discountAmount || 0)}</span></div>
                            <div class="quick-view-row"><span class="quick-view-label">Th√†nh ti·ªÅn:</span><span class="quick-view-value"><strong>${formatCurrency(debt.totalAmount)}</strong></span></div>
                            <div class="quick-view-row"><span class="quick-view-label">ƒê√£ ƒë√≥ng:</span><span class="quick-view-value text-success">${formatCurrency(debt.paidAmount)}</span></div>
                            <div class="quick-view-row"><span class="quick-view-label">C√≤n n·ª£:</span><span class="quick-view-value text-danger fw-700">${formatCurrency(debt.debtAmount)}</span></div>
                        </div>
                        
                        <div class="quick-view-section">
                            <h4>üìö Ti·∫øn ƒë·ªô h·ªçc</h4>
                            <div class="quick-view-row"><span class="quick-view-label">T·ªïng bu·ªïi:</span><span class="quick-view-value">${cs ? cs.totalSessions : '-'}</span></div>
                            <div class="quick-view-row"><span class="quick-view-label">ƒê√£ h·ªçc:</span><span class="quick-view-value">${cs ? cs.completedSessions : '-'}</span></div>
                            <div class="quick-view-row"><span class="quick-view-label">C√≤n l·∫°i:</span><span class="quick-view-value ${cs ? getSessionWarningClass(cs.remainingSessions) : ''}">${cs ? cs.remainingSessions + ' bu·ªïi' : '-'}</span></div>
                        </div>
                    </div>
                </div>
                
                <div class="quick-view-section mt-15">
                    <h4>üßæ L·ªãch s·ª≠ thanh to√°n (${relatedReceipts.length})</h4>
                    ${relatedReceipts.length === 0 ? '<p class="text-muted">Ch∆∞a c√≥ thanh to√°n n√†o</p>' : `
                        <table style="width: 100%; font-size: 13px;">
                            <thead><tr><th>Ng√†y</th><th>Lo·∫°i</th><th>S·ªë ti·ªÅn</th><th>Ghi ch√∫</th></tr></thead>
                            <tbody>
                                ${relatedReceipts.map(r => `
                                    <tr>
                                        <td>${formatDate(r.date)}</td>
                                        <td>${r.type}</td>
                                        <td class="text-success"><strong>${formatCurrency(r.amount)}</strong></td>
                                        <td>${r.notes || '-'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `}
                </div>
            `;

            // ·∫®n/hi·ªán n√∫t thanh to√°n
            document.getElementById('debtDetailPayBtn').style.display = debt.debtAmount > 0 ? '' : 'none';

            openModal('debtDetailModal');
        }

        function openPaymentFromDetail() {
            closeModal('debtDetailModal');
            openDebtPaymentModal(currentPaymentRegId);
        }

        // ===== 29.7 ƒêi·ªÅu ch·ªânh c√¥ng n·ª£ =====
        function openAdjustDebtModal(regId) {
            const reg = registrations.find(r => r.id === regId);
            if (!reg) return;

            const student = students.find(s => s.id === reg.studentId);
            const debt = calculateDebtForRegistration(regId);

            document.getElementById('adjustRegistrationId').value = regId;
            document.getElementById('adjustStudentName').textContent = student ? student.name : 'N/A';
            document.getElementById('adjustOriginalAmount').textContent = formatCurrency(debt.totalAmount);
            document.getElementById('adjustNewAmount').value = formatNumberInput(debt.totalAmount);
            document.getElementById('adjustReason').value = '';

            openModal('adjustDebtModal');
        }

        function saveAdjustedDebt(event) {
            event.preventDefault();

            const regId = document.getElementById('adjustRegistrationId').value;
            const newAmount = parseCurrencyInput(document.getElementById('adjustNewAmount').value);
            const reason = document.getElementById('adjustReason').value.trim();

            if (newAmount < 0) {
                showNotification('S·ªë ti·ªÅn kh√¥ng h·ª£p l·ªá!', 'error');
                return;
            }

            const reg = registrations.find(r => r.id === regId);
            if (!reg) return;

            // L∆∞u l·ªãch s·ª≠ ƒëi·ªÅu ch·ªânh
            if (!reg.adjustmentHistory) reg.adjustmentHistory = [];
            reg.adjustmentHistory.push({
                oldAmount: reg.adjustedAmount !== undefined ? reg.adjustedAmount : reg.finalAmount,
                newAmount: newAmount,
                reason: reason,
                adjustedBy: currentUser.id,
                adjustedAt: new Date().toISOString()
            });

            // C·∫≠p nh·∫≠t s·ªë ti·ªÅn
            reg.adjustedAmount = newAmount;

            saveData('registrations', registrations);
            closeModal('adjustDebtModal');
            renderDebtsTable();
            showNotification('ƒê√£ ƒëi·ªÅu ch·ªânh c√¥ng n·ª£ th√†nh c√¥ng!', 'success');
        }

        // ===== 29.8 Export Excel =====
        function exportDebtsToExcel() {
            const data = registrations.map(reg => {
                const student = students.find(s => s.id === reg.studentId);
                const debt = calculateDebtForRegistration(reg.id);
                const cs = classStudents.find(c => c.registrationId === reg.id);

                return {
                    'H·ªçc vi√™n': student ? student.name : '',
                    'M√£ Phi·∫øu ƒêK': reg.regCode,
                    'M√¥n h·ªçc': reg.subject,
                    'T·ªïng ti·ªÅn': debt.totalAmount,
                    'ƒê√£ ƒë√≥ng': debt.paidAmount,
                    'C√≤n n·ª£': debt.debtAmount,
                    'C√≤n bu·ªïi': cs ? cs.remainingSessions : '',
                    'Tr·∫°ng th√°i': debt.debtAmount === 0 ? 'ƒê√£ ƒë√≥ng ƒë·ªß' : debt.paidAmount > 0 ? 'ƒê√≥ng 1 ph·∫ßn' : 'Ch∆∞a ƒë√≥ng'
                };
            });

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data), 'C√¥ng n·ª£');
            XLSX.writeFile(wb, `CongNo_${formatDateFile()}.xlsx`);
            showNotification('Xu·∫•t Excel th√†nh c√¥ng!', 'success');
        }

        // ===== 29.9 C√†i ƒë·∫∑t c·∫£nh b√°o =====
        function loadWarningSettings() {
            document.getElementById('warningThreshold1').value = warningSettings.threshold1;
            document.getElementById('warningThreshold2').value = warningSettings.threshold2;
            document.getElementById('warningThreshold3').value = warningSettings.threshold3;
            document.getElementById('showWarningOnDashboard').value = warningSettings.showOnDashboard ? 'true' : 'false';
        }

        function saveWarningSettings(event) {
            event.preventDefault();

            warningSettings.threshold1 = parseInt(document.getElementById('warningThreshold1').value) || 5;
            warningSettings.threshold2 = parseInt(document.getElementById('warningThreshold2').value) || 3;
            warningSettings.threshold3 = parseInt(document.getElementById('warningThreshold3').value) || 1;
            warningSettings.showOnDashboard = document.getElementById('showWarningOnDashboard').value === 'true';

            localStorage.setItem('warningSettings', JSON.stringify(warningSettings));
            showNotification('ƒê√£ l∆∞u c√†i ƒë·∫∑t c·∫£nh b√°o!', 'success');

            // Refresh c·∫£nh b√°o
            if (document.getElementById('debts').classList.contains('active')) {
                renderDebtsTable();
            }
            renderDashboard();
        }

        // ===== 29.10 C·∫£nh b√°o tr√™n Dashboard =====
        function renderDashboardWarnings() {
            if (!warningSettings.showOnDashboard) return '';

            const warnings = [];

            registrations.forEach(reg => {
                const student = students.find(s => s.id === reg.studentId);
                const debt = calculateDebtForRegistration(reg.id);
                const cs = classStudents.find(c => c.registrationId === reg.id);

                if (!cs || !student) return;

                const remaining = cs.remainingSessions;

                if (debt.debtAmount > 0 && remaining <= warningSettings.threshold2) {
                    warnings.push({
                        studentName: student.name,
                        remaining,
                        debtAmount: debt.debtAmount,
                        regId: reg.id
                    });
                }
            });

            if (warnings.length === 0) return '';

            return `
                <div class="card mt-20">
                    <div class="card-header">
                        <h3>‚ö†Ô∏è C·∫£nh b√°o c√¥ng n·ª£ (${warnings.length})</h3>
                        <a href="#" onclick="switchTab('debts'); return false;" class="text-primary" style="font-size: 13px;">Xem t·∫•t c·∫£ ‚Üí</a>
                    </div>
                    <div class="card-body">
                        ${warnings.slice(0, 5).map(w => `
                            <div style="background: #FEF9E7; padding: 10px 15px; border-radius: 8px; margin-bottom: 8px; font-size: 13px;">
                                <strong>${w.studentName}</strong> - C√≤n ${w.remaining} bu·ªïi, n·ª£ <strong class="text-danger">${formatCurrency(w.debtAmount)}</strong>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        /* ============================================================
           üé¨ PH·∫¶N 22: APP INITIALIZATION (Kh·ªüi ch·∫°y ·ª©ng d·ª•ng)
           ============================================================ */

        function initApp() {
            console.log('üöÄ Kh·ªüi ch·∫°y ·ª©ng d·ª•ng Profile 001 - V4.0');

            // 1. Kh·ªüi t·∫°o users m·∫∑c ƒë·ªãnh n·∫øu ch∆∞a c√≥
            initializeDefaultUsers();

            // 2. L∆∞u subjects m·∫∑c ƒë·ªãnh n·∫øu ch∆∞a c√≥
            if (!localStorage.getItem('subjects')) {
                saveData('subjects', subjects);
            }

            // 3. Ki·ªÉm tra ƒëƒÉng nh·∫≠p
            if (checkAuth()) {
                // ƒê√£ ƒëƒÉng nh·∫≠p
                showApp();
                console.log('‚úÖ ƒê√£ ƒëƒÉng nh·∫≠p:', currentUser.username);
            } else {
                // Ch∆∞a ƒëƒÉng nh·∫≠p
                hideApp();
                console.log('üîí Ch∆∞a ƒëƒÉng nh·∫≠p, hi·ªán m√†n h√¨nh Login');
            }
        }

        // ===== Ch·∫°y khi trang load xong =====
        document.addEventListener('DOMContentLoaded', function () {
            initApp();
        });

        // ===== X·ª≠ l√Ω khi nh·∫•n Enter trong form login =====
        document.getElementById('loginForm').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                handleLogin(e);
            }
        });

        // ===== ƒê√≥ng modal khi click b√™n ngo√†i =====
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function (e) {
                if (e.target === this) {
                    this.classList.remove('active');
                }
            });
        });

        // ===== Keyboard shortcuts =====
        document.addEventListener('keydown', function (e) {
            // ESC ƒë·ªÉ ƒë√≥ng modal
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal.active').forEach(modal => {
                    modal.classList.remove('active');
                });
            }
        });



        /* ============================================================
        üñ®Ô∏è PH·∫¶N 32: IN PHI·∫æU ƒêƒÇNG K√ù & BI√äN LAI (V2 - FIX)
        ============================================================ */

        // ===== 32.1 Chuy·ªÉn s·ªë th√†nh ch·ªØ ti·∫øng Vi·ªát =====
        function convertNumberToWords(number) {
            if (number === 0) return 'Kh√¥ng ƒë·ªìng';
            if (!number || isNaN(number)) return '';

            const ones = ['', 'm·ªôt', 'hai', 'ba', 'b·ªën', 'nƒÉm', 's√°u', 'b·∫£y', 't√°m', 'ch√≠n'];
            const tens = ['', 'm∆∞·ªùi', 'hai m∆∞∆°i', 'ba m∆∞∆°i', 'b·ªën m∆∞∆°i', 'nƒÉm m∆∞∆°i', 's√°u m∆∞∆°i', 'b·∫£y m∆∞∆°i', 't√°m m∆∞∆°i', 'ch√≠n m∆∞∆°i'];

            function readThreeDigits(n) {
                let str = '';
                const hundred = Math.floor(n / 100);
                const ten = Math.floor((n % 100) / 10);
                const one = n % 10;

                if (hundred > 0) {
                    str += ones[hundred] + ' trƒÉm ';
                    if (ten === 0 && one > 0) str += 'l·∫ª ';
                }

                if (ten > 1) {
                    str += tens[ten] + ' ';
                    if (one === 1) str += 'm·ªët ';
                    else if (one === 5) str += 'lƒÉm ';
                    else if (one > 0) str += ones[one] + ' ';
                } else if (ten === 1) {
                    str += 'm∆∞·ªùi ';
                    if (one === 5) str += 'lƒÉm ';
                    else if (one > 0) str += ones[one] + ' ';
                } else if (one > 0) {
                    str += ones[one] + ' ';
                }

                return str.trim();
            }

            let num = Math.abs(Math.floor(number));
            let result = '';

            if (num >= 1000000000) {
                result += readThreeDigits(Math.floor(num / 1000000000)) + ' t·ª∑ ';
                num %= 1000000000;
            }

            if (num >= 1000000) {
                result += readThreeDigits(Math.floor(num / 1000000)) + ' tri·ªáu ';
                num %= 1000000;
            }

            if (num >= 1000) {
                result += readThreeDigits(Math.floor(num / 1000)) + ' ngh√¨n ';
                num %= 1000;
            }

            if (num > 0) {
                result += readThreeDigits(num);
            }

            result = result.trim();
            return result.charAt(0).toUpperCase() + result.slice(1) + ' ƒë·ªìng';
        }

        // ===== 32.2 T·∫°o m√£ bi√™n lai c√≥ ng√†y =====
        function generateReceiptCode() {
            const date = new Date();
            const y = date.getFullYear().toString().slice(2);
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            const todayStr = `${y}${m}${d}`;

            const todayReceipts = receipts.filter(r => {
                const code = r.receiptCode || '';
                return code.includes(todayStr);
            });
            const seq = String(todayReceipts.length + 1).padStart(4, '0');

            return `BL${todayStr}-${seq}`;
        }

        // ===== 32.3 Generate QR Code =====
        function generateQRCodeImage(data, size = 50) {
            // T·∫°o QR code base64 URL ƒë∆°n gi·∫£n
            // S·ª≠ d·ª•ng API mi·ªÖn ph√≠
            const encodedData = encodeURIComponent(data);
            return `https://api.qrserver.com/v1/create-qr-code/?size=${size}x${size}&data=${encodedData}&color=1e40af`;
        }

        // ===== 32.4 Generate HTML cho Phi·∫øu ƒêƒÉng K√Ω =====
        // ===== GENERATE HTML CHO PHI·∫æU ƒêƒÇNG K√ù - C·∫¨P NH·∫¨T =====
        function generateRegistrationHTML(regId) {
            const reg = registrations.find(r => r.id === regId);
            if (!reg) return '';

            const student = students.find(s => s.id === reg.studentId);
            const pkg = reg.packageId ? packages.find(p => p.id === reg.packageId) : null;

            // L·∫•y s·ªë bu·ªïi t·ª´ phi·∫øu ƒêK ho·∫∑c t·ª´ g√≥i
            const totalSessions = reg.totalSessions || (pkg ? pkg.sessions : 8);

            const qrData = `DK:${reg.regCode}|${student?.name || ''}|${reg.finalAmount}`;
            const qrImageUrl = generateQRCodeImage(qrData, 50);

            return `
                <div class="print-document">
                    <!-- Header -->
                    <div class="print-header">
                        <div class="print-header-left">
                            <div class="print-logo">
                                ${centerInfo.logo ? `<img src="${centerInfo.logo}" alt="Logo">` : 'üìö'}
                            </div>
                            <div class="print-company-info">
                                <h2>${centerInfo.name || 'TRUNG T√ÇM D·∫†Y H·ªåC'}</h2>
                                <p>üìç ${centerInfo.address || 'ƒê·ªãa ch·ªâ trung t√¢m'}</p>
                                <p>üìû ${centerInfo.phone || '0909.xxx.xxx'}${centerInfo.email ? ' | ' + centerInfo.email : ''}</p>
                            </div>
                        </div>
                        <div class="print-qr-code">
                            <img src="${qrImageUrl}" alt="QR Code">
                        </div>
                    </div>
                    
                    <!-- Title -->
                    <div class="print-title">
                        <h1>üìã PHI·∫æU ƒêƒÇNG K√ù H·ªåC</h1>
                        <div class="doc-number">S·ªë: <strong>${reg.regCode}</strong></div>
                    </div>
                    
                    <!-- Th√¥ng tin h·ªçc vi√™n -->
                    <div class="print-section">
                        <div class="print-section-title">Th√¥ng tin h·ªçc vi√™n</div>
                        <div class="print-row">
                            <span class="print-label">H·ªç t√™n HV:</span>
                            <span class="print-value highlight">${student?.name || 'N/A'}</span>
                        </div>
                        ${student?.age ? `
                        <div class="print-row">
                            <span class="print-label">Tu·ªïi:</span>
                            <span class="print-value">${student.age}</span>
                        </div>
                        ` : ''}
                        <div class="print-row">
                            <span class="print-label">Ph·ª• huynh:</span>
                            <span class="print-value">${reg.parentName || student?.parentName || ''}</span>
                        </div>
                        <div class="print-row">
                            <span class="print-label">ƒêi·ªán tho·∫°i:</span>
                            <span class="print-value">${reg.parentPhone || student?.parentPhone || ''}</span>
                        </div>
                        ${student?.parentEmail ? `
                        <div class="print-row">
                            <span class="print-label">Email:</span>
                            <span class="print-value">${student.parentEmail}</span>
                        </div>
                        ` : ''}
                    </div>
                    
                    <!-- Th√¥ng tin kh√≥a h·ªçc -->
                    <div class="print-section">
                        <div class="print-section-title">Th√¥ng tin kh√≥a h·ªçc</div>
                        <div class="print-row">
                            <span class="print-label">M√¥n h·ªçc:</span>
                            <span class="print-value highlight">${reg.subject}</span>
                        </div>
                        ${pkg ? `
                        <div class="print-row">
                            <span class="print-label">G√≥i h·ªçc:</span>
                            <span class="print-value">${pkg.name}</span>
                        </div>
                        ` : ''}
                        <div class="print-row">
                            <span class="print-label">S·ªë bu·ªïi:</span>
                            <span class="print-value highlight">${totalSessions} bu·ªïi</span>
                        </div>
                        ${reg.startDate ? `
                        <div class="print-row">
                            <span class="print-label">Ng√†y b·∫Øt ƒë·∫ßu:</span>
                            <span class="print-value">${formatDate(reg.startDate)}</span>
                        </div>
                        ` : ''}
                    </div>
                    
                    <!-- Chi ti·∫øt h·ªçc ph√≠ -->
                    <div class="print-section">
                        <div class="print-section-title">Chi ti·∫øt h·ªçc ph√≠</div>
                        <div class="print-amount-row">
                            <span class="print-amount-label">H·ªçc ph√≠ g·ªëc:</span>
                            <span class="print-amount-value">${formatCurrency(reg.tuitionFee)}</span>
                        </div>
                        ${reg.discountAmount > 0 ? `
                        <div class="print-amount-row">
                            <span class="print-amount-label">Khuy·∫øn m√£i/Gi·∫£m gi√°:</span>
                            <span class="print-amount-value negative">-${formatCurrency(reg.discountAmount)}</span>
                        </div>
                        ` : ''}
                    </div>
                    
                    <!-- Th√†nh ti·ªÅn -->
                    <div class="print-total">
                        <div class="print-total-row">
                            <span class="print-total-label">‚ñ∂ TH√ÄNH TI·ªÄN:</span>
                            <span class="print-total-value">${formatCurrency(reg.finalAmount)}</span>
                        </div>
                        <div class="print-total-words">(${convertNumberToWords(reg.finalAmount)})</div>
                    </div>
                    
                    <!-- Th√¥ng tin th√™m -->
                    <div class="print-info-grid">
                        <div class="print-info-item">
                            <span class="print-label">Ng√†y ƒëƒÉng k√Ω:</span>
                            <span class="print-value">${formatDate(reg.registrationDate)}</span>
                        </div>
                    </div>
                    
                    ${reg.notes ? `
                    <div class="print-notes">
                        <span class="print-notes-label">Ghi ch√∫: </span>
                        <span class="print-notes-content">${reg.notes}</span>
                    </div>
                    ` : ''}
                    
                    <!-- Ch·ªØ k√Ω -->
                    <div class="print-footer">
                        <div class="print-signatures">
                            <div class="print-signature-block">
                                <div class="print-signature-title">Ch·ªØ k√Ω Ph·ª• huynh</div>
                                <div class="print-signature-line">(K√Ω v√† ghi r√µ h·ªç t√™n)</div>
                            </div>
                            <div class="print-signature-block">
                                <div class="print-signature-title">Nh√¢n vi√™n ti·∫øp nh·∫≠n</div>
                                <div class="print-signature-line">(K√Ω, ƒë√≥ng d·∫•u)</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }


        // ===== 32.5 Generate HTML cho Bi√™n Lai =====
        function generateReceiptHTML(receiptId, options = {}) {
            const receipt = receipts.find(r => r.id === receiptId);
            if (!receipt) return '';

            const student = students.find(s => s.id === receipt.studentId);
            const reg = receipt.registrationId ? registrations.find(r => r.id === receipt.registrationId) : null;
            const cs = reg ? classStudents.find(c => c.registrationId === reg.id) : null;

            const showDebtInfo = options.showDebtInfo || false;
            const showBankInfo = options.showBankInfo || false;
            const showSessions = options.showSessions || false;

            let debtInfo = null;
            if (reg && showDebtInfo) {
                debtInfo = calculateDebtForRegistration(reg.id);
            }

            const receiptCode = receipt.receiptCode || `BL-${String(receipts.indexOf(receipt) + 1).padStart(4, '0')}`;
            const isTransfer = receipt.type === 'Bi√™n Lai ƒêi·ªán T·ª≠';
            const isCash = receipt.type === 'Phi·∫øu Thu';

            const qrData = `BL:${receiptCode}|${student?.name || ''}|${receipt.amount}`;
            const qrImageUrl = generateQRCodeImage(qrData, 50);

            return `
                <div class="print-document">
                    <!-- Header -->
                    <div class="print-header">
                        <div class="print-header-left">
                            <div class="print-logo">
                                ${centerInfo.logo ? `<img src="${centerInfo.logo}" alt="Logo">` : 'üìö'}
                            </div>
                            <div class="print-company-info">
                                <h2>${centerInfo.name || 'TRUNG T√ÇM D·∫†Y H·ªåC'}</h2>
                                <p>üìç ${centerInfo.address || 'ƒê·ªãa ch·ªâ trung t√¢m'}</p>
                                <p>üìû ${centerInfo.phone || '0909.xxx.xxx'}${centerInfo.email ? ' | ' + centerInfo.email : ''}</p>
                            </div>
                        </div>
                        <div class="print-qr-code">
                            <img src="${qrImageUrl}" alt="QR Code">
                        </div>
                    </div>
                    
                    <!-- Title -->
                    <div class="print-title">
                        <h1>üßæ BI√äN LAI THU H·ªåC PH√ç</h1>
                        <div class="doc-number">S·ªë: <strong>${receiptCode}</strong></div>
                    </div>
                    
                    <!-- Th√¥ng tin ng∆∞·ªùi n·ªôp -->
                    <div class="print-section">
                        <div class="print-section-title">Th√¥ng tin ng∆∞·ªùi n·ªôp</div>
                        <div class="print-row">
                            <span class="print-label">Ng∆∞·ªùi n·ªôp:</span>
                            <span class="print-value">${receipt.parentName || student?.parentName || ''}</span>
                        </div>
                        <div class="print-row">
                            <span class="print-label">ƒêi·ªán tho·∫°i:</span>
                            <span class="print-value">${receipt.parentPhone || student?.parentPhone || ''}</span>
                        </div>
                        <div class="print-row">
                            <span class="print-label">N·ªôp cho HV:</span>
                            <span class="print-value highlight">${student?.name || 'N/A'}</span>
                        </div>
                    </div>
                    
                    <!-- N·ªôi dung thu -->
                    <div class="print-section">
                        <div class="print-section-title">N·ªôi dung thu</div>
                        <div class="print-row">
                            <span class="print-label">N·ªôi dung:</span>
                            <span class="print-value">${receipt.description}</span>
                        </div>
                        ${reg ? `
                        <div class="print-row">
                            <span class="print-label">M√£ phi·∫øu ƒêK:</span>
                            <span class="print-value">${reg.regCode}</span>
                        </div>
                        ` : ''}
                        ${showSessions && cs ? `
                        <div class="print-row">
                            <span class="print-label">S·ªë bu·ªïi:</span>
                            <span class="print-value">${cs.totalSessions} bu·ªïi</span>
                        </div>
                        ` : ''}
                    </div>
                    
                    <!-- Thanh to√°n -->
                    ${showDebtInfo && debtInfo ? `
                    <div class="print-section">
                        <div class="print-section-title">Chi ti·∫øt thanh to√°n</div>
                        <div class="print-amount-row">
                            <span class="print-amount-label">T·ªïng h·ªçc ph√≠:</span>
                            <span class="print-amount-value">${formatCurrency(debtInfo.totalAmount)}</span>
                        </div>
                        <div class="print-amount-row">
                            <span class="print-amount-label">ƒê√£ TT tr∆∞·ªõc:</span>
                            <span class="print-amount-value">${formatCurrency(Math.max(0, debtInfo.paidAmount - receipt.amount))}</span>
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- S·ªë ti·ªÅn thu -->
                    <div class="print-total">
                        <div class="print-total-row">
                            <span class="print-total-label">‚ñ∂ S·ªê TI·ªÄN${showDebtInfo ? ' THU L·∫¶N N√ÄY' : ''}:</span>
                            <span class="print-total-value">${formatCurrency(receipt.amount)}</span>
                        </div>
                        <div class="print-total-words">(${convertNumberToWords(receipt.amount)})</div>
                    </div>
                    
                    ${showDebtInfo && debtInfo ? `
                    <div class="print-debt-row ${debtInfo.debtAmount === 0 ? 'paid' : ''}">
                        <div class="print-total-row">
                            <span class="print-total-label">‚ñ∂ C√íN N·ª¢:</span>
                            <span class="print-total-value">${formatCurrency(debtInfo.debtAmount)}</span>
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- H√¨nh th·ª©c & Ng√†y -->
                    <div class="print-info-grid">
                        <div class="print-info-item">
                            <span class="print-label">H√¨nh th·ª©c:</span>
                            <span class="print-value">
                                <span class="print-checkbox">
                                    <span class="print-checkbox-box ${isTransfer ? 'checked' : ''}">${isTransfer ? '‚úì' : ''}</span> CK
                                </span>
                                &nbsp;
                                <span class="print-checkbox">
                                    <span class="print-checkbox-box ${isCash ? 'checked' : ''}">${isCash ? '‚úì' : ''}</span> TM
                                </span>
                            </span>
                        </div>
                        <div class="print-info-item">
                            <span class="print-label">Ng√†y thu:</span>
                            <span class="print-value">${formatDate(receipt.date)}</span>
                        </div>
                    </div>
                    
                    ${showBankInfo && bankInfo.accountNumber ? `
                    <div class="print-bank-info">
                        <div class="print-bank-info-title">Th√¥ng tin chuy·ªÉn kho·∫£n:</div>
                        <div class="print-bank-info-content">
                            <strong>${bankInfo.bankName || ''}</strong> | STK: <strong>${bankInfo.accountNumber}</strong> | ${bankInfo.accountName || ''}
                        </div>
                    </div>
                    ` : ''}
                    
                    ${receipt.notes ? `
                    <div class="print-notes">
                        <span class="print-notes-label">Ghi ch√∫: </span>
                        <span class="print-notes-content">${receipt.notes}</span>
                    </div>
                    ` : ''}
                    
                    <!-- Ch·ªØ k√Ω -->
                    <div class="print-footer">
                        <div class="print-signatures">
                            <div class="print-signature-block">
                                <div class="print-signature-title">Ng∆∞·ªùi n·ªôp ti·ªÅn</div>
                                <div class="print-signature-line">(K√Ω v√† ghi r√µ h·ªç t√™n)</div>
                            </div>
                            <div class="print-signature-block">
                                <div class="print-signature-title">Ng∆∞·ªùi thu ti·ªÅn</div>
                                <div class="print-signature-line">(K√Ω, ƒë√≥ng d·∫•u)</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // ===== 32.6 Xem Phi·∫øu ƒêƒÉng K√Ω =====
        function viewRegistration(id) {
            const reg = registrations.find(r => r.id === id);
            if (!reg) return;

            const previewHTML = generateRegistrationHTML(id);

            document.getElementById('registrationPreviewContent').innerHTML = `
                <div class="print-preview-wrapper">
                    ${previewHTML}
                </div>
            `;

            openModal('viewRegistrationModal');
        }

        // ===== 32.7 Xem Bi√™n Lai =====
        let currentViewReceiptId = null;

        function viewReceipt(id) {
            currentViewReceiptId = id;
            const receipt = receipts.find(r => r.id === id);
            if (!receipt) return;

            const previewHTML = generateReceiptHTML(id, {
                showDebtInfo: false,
                showBankInfo: false,
                showSessions: false
            });

            document.getElementById('receiptPreviewContent').innerHTML = `
                <!-- Options ·ªü cu·ªëi, tr∆∞·ªõc n√∫t In -->
                <div class="print-preview-wrapper" id="receiptPreviewArea">
                    ${previewHTML}
                </div>
                
                <div class="print-options" style="margin-top: 15px; margin-bottom: 0;">
                    <div class="print-options-title">üìã T√πy ch·ªçn hi·ªÉn th·ªã khi in:</div>
                    <div class="print-options-grid">
                        <label class="print-option-item">
                            <input type="checkbox" id="optShowDebtInfo" onchange="updateReceiptPreview()">
                            Hi·ªán th√¥ng tin c√¥ng n·ª£
                        </label>
                        <label class="print-option-item">
                            <input type="checkbox" id="optShowBankInfo" onchange="updateReceiptPreview()">
                            Hi·ªán th√¥ng tin ng√¢n h√†ng
                        </label>
                        <label class="print-option-item">
                            <input type="checkbox" id="optShowSessions" onchange="updateReceiptPreview()">
                            Hi·ªán s·ªë bu·ªïi h·ªçc
                        </label>
                    </div>
                </div>
            `;

            openModal('viewReceiptModal');
        }

        function updateReceiptPreview() {
            if (!currentViewReceiptId) return;

            const options = {
                showDebtInfo: document.getElementById('optShowDebtInfo')?.checked || false,
                showBankInfo: document.getElementById('optShowBankInfo')?.checked || false,
                showSessions: document.getElementById('optShowSessions')?.checked || false
            };

            const previewHTML = generateReceiptHTML(currentViewReceiptId, options);
            document.getElementById('receiptPreviewArea').innerHTML = previewHTML;
        }

        // ===== 32.8 In Phi·∫øu ƒêƒÉng K√Ω =====
        function printRegistration() {
            const modal = document.getElementById('viewRegistrationModal');
            const printDoc = modal.querySelector('.print-document');
            if (!printDoc) return;

            openPrintWindow(printDoc.outerHTML, 'Phi·∫øu ƒêƒÉng K√Ω');
        }

        // ===== 32.9 In Bi√™n Lai =====
        function printReceipt() {
            if (!currentViewReceiptId) return;

            const options = {
                showDebtInfo: document.getElementById('optShowDebtInfo')?.checked || false,
                showBankInfo: document.getElementById('optShowBankInfo')?.checked || false,
                showSessions: document.getElementById('optShowSessions')?.checked || false
            };

            const printContent = generateReceiptHTML(currentViewReceiptId, options);
            openPrintWindow(printContent, 'Bi√™n Lai');
        }


        // ===== 32.10 M·ªü c·ª≠a s·ªï in (ƒê√É S·ª¨A CƒÇN GI·ªÆA PDF) =====
        function openPrintWindow(content, title) {
            const printWindow = window.open('', '_blank', 'width=900,height=700');

            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${title}</title>
                    <meta charset="UTF-8">
                    <style>
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        
                        html, body {
                            width: 100%;
                            height: 100%;
                        }
                        
                        body { 
                            font-family: 'Times New Roman', Times, serif; 
                            font-size: 14px; 
                            color: #1a1a1a; 
                            line-height: 1.6; 
                            background: #f0f0f0;
                            padding: 20px;
                            display: flex;
                            justify-content: center;
                            align-items: flex-start;
                            min-height: 100vh;
                        }
                        
                        .print-document {
                            width: 210mm;
                            min-height: 297mm;
                            padding: 15mm 20mm;
                            margin: 0 auto;
                            background: white;
                            box-shadow: 0 0 10px rgba(0,0,0,0.1);
                        }
                        
                        .print-header { display: flex; justify-content: space-between; align-items: flex-start; padding-bottom: 15px; border-bottom: 2px solid #1e40af; margin-bottom: 20px; }
                        .print-header-left { display: flex; align-items: center; gap: 15px; flex: 1; }
                        .print-logo { width: 60px; height: 60px; background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 32px; color: white; flex-shrink: 0; }
                        .print-logo img { max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 10px; }
                        .print-company-info h2 { color: #1e40af; font-size: 18px; font-weight: 700; margin-bottom: 4px; text-transform: uppercase; }
                        .print-company-info p { font-size: 12px; color: #475569; margin: 2px 0; }
                        .print-qr-code { width: 70px; height: 70px; border: 1px solid #e2e8f0; border-radius: 8px; padding: 5px; flex-shrink: 0; }
                        .print-qr-code img { width: 100%; height: 100%; }
                        .print-title { text-align: center; margin: 25px 0; }
                        .print-title h1 { color: #1e40af; font-size: 22px; font-weight: 700; text-transform: uppercase; margin-bottom: 8px; }
                        .print-title .doc-number { font-size: 15px; color: #475569; }
                        .print-section { margin-bottom: 20px; }
                        .print-section-title { font-size: 13px; font-weight: 700; color: #1e40af; text-transform: uppercase; padding-bottom: 8px; border-bottom: 1px solid #e2e8f0; margin-bottom: 12px; }
                        .print-row { display: flex; padding: 6px 0; border-bottom: 1px dotted #e5e7eb; }
                        .print-row:last-child { border-bottom: none; }
                        .print-label { width: 140px; font-weight: 500; color: #64748b; flex-shrink: 0; }
                        .print-value { flex: 1; color: #1a1a1a; }
                        .print-value.highlight { font-weight: 700; color: #1e40af; }
                        .print-amount-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dotted #e5e7eb; }
                        .print-amount-row:last-child { border-bottom: none; }
                        .print-amount-label { color: #64748b; }
                        .print-amount-value { font-weight: 500; min-width: 150px; text-align: right; }
                        .print-amount-value.negative { color: #dc2626; }
                        .print-total { background: #eff6ff; border: 2px solid #1e40af; border-radius: 8px; padding: 15px 20px; margin: 15px 0; }
                        .print-total-row { display: flex; justify-content: space-between; align-items: center; }
                        .print-total-label { font-size: 15px; font-weight: 700; color: #1e40af; }
                        .print-total-value { font-size: 18px; font-weight: 700; color: #1e40af; }
                        .print-total-words { font-size: 13px; color: #64748b; font-style: italic; margin-top: 5px; text-align: right; }
                        .print-debt-row { background: #fef2f2; border: 1px solid #fecaca; border-radius: 6px; padding: 10px 15px; margin-top: 10px; }
                        .print-debt-row.paid { background: #f0fdf4; border-color: #bbf7d0; }
                        .print-debt-row .print-total-label, .print-debt-row .print-total-value { color: #dc2626; font-size: 14px; }
                        .print-debt-row.paid .print-total-label, .print-debt-row.paid .print-total-value { color: #16a34a; }
                        .print-info-grid { display: flex; flex-wrap: wrap; gap: 20px; margin: 15px 0; }
                        .print-info-item { display: flex; gap: 10px; }
                        .print-checkbox { display: inline-flex; align-items: center; gap: 5px; font-size: 13px; }
                        .print-checkbox-box { width: 14px; height: 14px; border: 1.5px solid #64748b; border-radius: 3px; display: inline-flex; align-items: center; justify-content: center; font-size: 10px; }
                        .print-checkbox-box.checked { background: #1e40af; border-color: #1e40af; color: white; }
                        .print-bank-info { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px 15px; margin: 15px 0; font-size: 13px; }
                        .print-bank-info-title { font-weight: 600; color: #475569; margin-bottom: 5px; }
                        .print-notes { background: #fffbeb; border: 1px solid #fde68a; border-radius: 6px; padding: 10px 15px; margin: 15px 0; font-size: 13px; }
                        .print-notes-label { font-weight: 600; color: #92400e; }
                        .print-notes-content { color: #78350f; }
                        .print-footer { margin-top: 40px; padding-top: 20px; }
                        .print-signatures { display: flex; justify-content: space-between; text-align: center; }
                        .print-signature-block { width: 45%; }
                        .print-signature-title { font-weight: 600; color: #475569; margin-bottom: 60px; }
                        .print-signature-line { border-top: 1px solid #1a1a1a; padding-top: 5px; font-size: 12px; color: #64748b; }
                        
                        @media print {
                            @page {
                                size: A4;
                                margin: 0;
                            }
                            
                            html, body { 
                                background: white !important; 
                                padding: 0 !important;
                                margin: 0 !important;
                                display: block !important;
                                width: 210mm !important;
                                height: 297mm !important;
                            }
                            
                            body {
                                display: flex !important;
                                justify-content: center !important;
                                align-items: flex-start !important;
                                padding-top: 0 !important;
                            }
                            
                            .print-document { 
                                box-shadow: none !important; 
                                margin: 0 auto !important;
                                width: 100% !important;
                                max-width: 210mm !important;
                                min-height: auto !important;
                                padding: 10mm 15mm !important;
                            }
                        }
                    </style>
                </head>
                <body>
                    ${content}
                    <script>
                        window.onload = function() {
                            setTimeout(function() { window.print(); }, 300);
                        }
                    <\/script>
                </body>
                </html>
            `);

            printWindow.document.close();
        }


        // ===== 32.11 T·∫£i PDF Phi·∫øu ƒêƒÉng K√Ω =====
        function downloadRegistrationPDF() {
            const modal = document.getElementById('viewRegistrationModal');
            const printDoc = modal.querySelector('.print-document');
            if (!printDoc) {
                showNotification('Kh√¥ng t√¨m th·∫•y n·ªôi dung!', 'error');
                return;
            }

            // T√¨m m√£ phi·∫øu
            const regCodeMatch = printDoc.innerHTML.match(/DK\d{6}-[A-Z0-9]+/);
            const filename = regCodeMatch ? `PhieuDK_${regCodeMatch[0]}.pdf` : 'PhieuDangKy.pdf';

            downloadPDF(printDoc, filename);
        }

        // ===== 32.12 T·∫£i PDF Bi√™n Lai =====
        function downloadReceiptPDF() {
            if (!currentViewReceiptId) return;

            const options = {
                showDebtInfo: document.getElementById('optShowDebtInfo')?.checked || false,
                showBankInfo: document.getElementById('optShowBankInfo')?.checked || false,
                showSessions: document.getElementById('optShowSessions')?.checked || false
            };

            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = generateReceiptHTML(currentViewReceiptId, options);
            tempDiv.style.position = 'absolute';
            tempDiv.style.left = '-9999px';
            document.body.appendChild(tempDiv);

            const receipt = receipts.find(r => r.id === currentViewReceiptId);
            const filename = receipt?.receiptCode ? `BienLai_${receipt.receiptCode}.pdf` : 'BienLai.pdf';

            downloadPDF(tempDiv.querySelector('.print-document'), filename, () => {
                document.body.removeChild(tempDiv);
            });
        }

        // ===== 32.13 Download PDF Helper =====
        function downloadPDF(element, filename, callback) {
            if (typeof html2pdf === 'undefined') {
                showNotification('Th∆∞ vi·ªán html2pdf ch∆∞a ƒë∆∞·ª£c t·∫£i!', 'error');
                if (callback) callback();
                return;
            }

            showNotification('ƒêang t·∫°o PDF...', 'info');

            const opt = {
                margin: [10, 10, 10, 10],
                filename: filename,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true, logging: false },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(element).save().then(() => {
                showNotification('ƒê√£ t·∫£i PDF th√†nh c√¥ng!', 'success');
                if (callback) callback();
            }).catch(err => {
                console.error('PDF Error:', err);
                showNotification('C√≥ l·ªói khi t·∫°o PDF!', 'error');
                if (callback) callback();
            });
        }

        console.log('üìÑ Module In Phi·∫øu ƒêK & Bi√™n Lai V2 ƒë√£ ƒë∆∞·ª£c t·∫£i!');


        /* ============================================================
           üè´ PH·∫¶N 34: QU·∫¢N L√ù PH√íNG H·ªåC
           ============================================================ */

        // ===== 34.1 Render b·∫£ng ph√≤ng h·ªçc =====
        function renderRoomsTable() {
            updateRoomStats();
            loadRoomScheduleToday();

            const tbody = document.getElementById('roomsTableBody');

            if (rooms.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6"><div class="empty-state"><div class="empty-state-icon">üè´</div><p>Ch∆∞a c√≥ ph√≤ng h·ªçc n√†o</p></div></td></tr>`;
                return;
            }

            tbody.innerHTML = rooms.map(room => `
                <tr>
                    <td><strong>${room.name}</strong></td>
                    <td>${room.capacity} ng∆∞·ªùi</td>
                    <td>${room.equipment || '<span class="text-muted">-</span>'}</td>
                    <td>${getRoomStatusBadge(room.status)}</td>
                    <td>${room.notes || '<span class="text-muted">-</span>'}</td>
                    <td>
                        <div class="action-buttons">
                            ${canEdit('rooms') ? `<button class="action-btn edit" onclick="editRoom('${room.id}')" title="S·ª≠a">‚úèÔ∏è</button>` : ''}
                            ${canDelete('rooms') ? `<button class="action-btn delete" onclick="deleteRoom('${room.id}')" title="X√≥a">üóëÔ∏è</button>` : ''}
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function getRoomStatusBadge(status) {
            const badges = {
                'active': '<span class="status-badge da-dk">üü¢ Ho·∫°t ƒë·ªông</span>',
                'maintenance': '<span class="status-badge cho-dk">üü† B·∫£o tr√¨</span>',
                'inactive': '<span class="status-badge cancel">‚ö´ Ng∆∞ng</span>'
            };
            return badges[status] || status;
        }

        // ===== 34.2 Th·ªëng k√™ ph√≤ng h·ªçc =====
        function updateRoomStats() {
            const total = rooms.length;
            const active = rooms.filter(r => r.status === 'active').length;
            const maintenance = rooms.filter(r => r.status === 'maintenance').length;
            const totalCapacity = rooms.filter(r => r.status === 'active').reduce((sum, r) => sum + (r.capacity || 0), 0);

            document.getElementById('roomTotalCount').textContent = total;
            document.getElementById('roomActiveCount').textContent = active;
            document.getElementById('roomMaintenanceCount').textContent = maintenance;
            document.getElementById('roomTotalCapacity').textContent = totalCapacity;
        }

        // ===== 34.3 L·ªãch s·ª≠ d·ª•ng ph√≤ng h√¥m nay =====
        function loadRoomScheduleToday() {
            const today = new Date();
            const dayOfWeek = today.getDay() === 0 ? 7 : today.getDay();
            const container = document.getElementById('roomScheduleToday');

            // L·∫•y c√°c ca h·ªçc h√¥m nay
            const todaySchedules = classSchedules.filter(s => s.dayOfWeek === dayOfWeek && s.isActive);

            if (todaySchedules.length === 0) {
                container.innerHTML = '<p class="text-muted">Kh√¥ng c√≥ l·ªãch h·ªçc h√¥m nay</p>';
                return;
            }

            // Nh√≥m theo ph√≤ng
            const byRoom = {};
            todaySchedules.forEach(s => {
                const roomName = s.roomId ? (rooms.find(r => r.id === s.roomId)?.name || s.room || 'Ch∆∞a g√°n') : (s.room || 'Ch∆∞a g√°n');
                if (!byRoom[roomName]) byRoom[roomName] = [];

                const cls = classes.find(c => c.id === s.classId);
                byRoom[roomName].push({
                    time: `${s.startTime} - ${s.endTime}`,
                    className: cls ? cls.className : 'N/A'
                });
            });

            // S·∫Øp x·∫øp theo gi·ªù
            Object.keys(byRoom).forEach(room => {
                byRoom[room].sort((a, b) => a.time.localeCompare(b.time));
            });

            container.innerHTML = `
                <div class="table-container" style="box-shadow: none; border: none;">
                    <table>
                        <thead>
                            <tr>
                                <th>Ph√≤ng</th>
                                <th>Gi·ªù h·ªçc</th>
                                <th>L·ªõp</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.entries(byRoom).map(([roomName, schedules]) =>
                schedules.map((s, idx) => `
                                    <tr>
                                        ${idx === 0 ? `<td rowspan="${schedules.length}"><strong>${roomName}</strong></td>` : ''}
                                        <td>${s.time}</td>
                                        <td>${s.className}</td>
                                    </tr>
                                `).join('')
            ).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function refreshRoomScheduleToday() {
            loadRoomScheduleToday();
            showNotification('ƒê√£ l√†m m·ªõi l·ªãch s·ª≠ d·ª•ng ph√≤ng!', 'success');
        }

        // ===== 34.4 Modal Th√™m/S·ª≠a ph√≤ng =====
        function openRoomModal() {
            document.getElementById('editRoomId').value = '';
            document.getElementById('roomForm').reset();
            document.getElementById('roomStatus').value = 'active';
            document.getElementById('roomModalTitle').textContent = 'üè´ Th√™m Ph√≤ng H·ªçc';
            openModal('roomModal');
        }

        function editRoom(id) {
            const room = rooms.find(r => r.id === id);
            if (!room) return;

            document.getElementById('editRoomId').value = room.id;
            document.getElementById('roomName').value = room.name;
            document.getElementById('roomCapacity').value = room.capacity;
            document.getElementById('roomEquipment').value = room.equipment || '';
            document.getElementById('roomStatus').value = room.status;
            document.getElementById('roomNotes').value = room.notes || '';
            document.getElementById('roomModalTitle').textContent = '‚úèÔ∏è S·ª≠a Ph√≤ng H·ªçc';
            openModal('roomModal');
        }

        function saveRoom(event) {
            event.preventDefault();

            const editId = document.getElementById('editRoomId').value;
            const roomData = {
                name: document.getElementById('roomName').value.trim(),
                capacity: parseInt(document.getElementById('roomCapacity').value),
                equipment: document.getElementById('roomEquipment').value.trim(),
                status: document.getElementById('roomStatus').value,
                notes: document.getElementById('roomNotes').value.trim()
            };

            // Ki·ªÉm tra tr√πng t√™n
            const existingRoom = rooms.find(r => r.name.toLowerCase() === roomData.name.toLowerCase() && r.id !== editId);
            if (existingRoom) {
                showNotification('T√™n ph√≤ng ƒë√£ t·ªìn t·∫°i!', 'error');
                return;
            }

            if (editId) {
                // C·∫≠p nh·∫≠t
                const index = rooms.findIndex(r => r.id === editId);
                if (index !== -1) {
                    rooms[index] = { ...rooms[index], ...roomData, updatedAt: new Date().toISOString() };
                    showNotification('C·∫≠p nh·∫≠t ph√≤ng h·ªçc th√†nh c√¥ng!', 'success');
                }
            } else {
                // Th√™m m·ªõi
                rooms.push({
                    id: generateId(),
                    ...roomData,
                    createdAt: new Date().toISOString()
                });
                showNotification('Th√™m ph√≤ng h·ªçc th√†nh c√¥ng!', 'success');
            }

            saveData('rooms', rooms);
            closeModal('roomModal');
            renderRoomsTable();
        }

        function deleteRoom(id) {
            const room = rooms.find(r => r.id === id);
            if (!room) return;

            // Ki·ªÉm tra ph√≤ng c√≥ ƒëang ƒë∆∞·ª£c s·ª≠ d·ª•ng kh√¥ng
            const usingSchedules = classSchedules.filter(s => s.roomId === id || s.room === room.name);
            if (usingSchedules.length > 0) {
                showNotification(`Kh√¥ng th·ªÉ x√≥a! Ph√≤ng ƒëang ƒë∆∞·ª£c s·ª≠ d·ª•ng trong ${usingSchedules.length} ca h·ªçc.`, 'error');
                return;
            }

            if (!confirm(`X√≥a ph√≤ng "${room.name}"?`)) return;

            rooms = rooms.filter(r => r.id !== id);
            saveData('rooms', rooms);
            showNotification('ƒê√£ x√≥a ph√≤ng h·ªçc!', 'success');
            renderRoomsTable();
        }

        // ===== 34.5 L·∫•y danh s√°ch ph√≤ng cho dropdown =====
        function getActiveRooms() {
            return rooms.filter(r => r.status === 'active');
        }

        // ===== 34.6 Ki·ªÉm tra tr√πng l·ªãch ph√≤ng =====
        function checkRoomConflict(roomId, dayOfWeek, startTime, endTime, excludeScheduleId = null) {
            if (!roomId) return null;

            const conflictSchedule = classSchedules.find(s => {
                if (s.id === excludeScheduleId) return false;
                if (s.roomId !== roomId) return false;
                if (s.dayOfWeek !== dayOfWeek) return false;
                if (!s.isActive) return false;

                // Ki·ªÉm tra tr√πng gi·ªù
                const sStart = s.startTime;
                const sEnd = s.endTime;

                // Tr√πng n·∫øu: (start1 < end2) && (end1 > start2)
                if (startTime < sEnd && endTime > sStart) {
                    return true;
                }
                return false;
            });

            if (conflictSchedule) {
                const cls = classes.find(c => c.id === conflictSchedule.classId);
                return {
                    schedule: conflictSchedule,
                    className: cls ? cls.className : 'N/A'
                };
            }

            return null;
        }

        console.log('üè´ Module Qu·∫£n l√Ω Ph√≤ng h·ªçc ƒë√£ ƒë∆∞·ª£c t·∫£i!');


        /* ============================================================
        üìã PH·∫¶N 33: S·ª¨A PHI·∫æU ƒêƒÇNG K√ù & BI√äN LAI + PH√ÇN TRANG ƒê√ÄO T·∫†O
        ============================================================ */

        // ===== C·∫≠p nh·∫≠t paginationState - Th√™m c√°c tab m·ªõi =====
        paginationState.teachers = { page: 1, pageSize: 10 };
        paginationState.classes = { page: 1, pageSize: 10 };
        paginationState.makeup = { page: 1, pageSize: 10 };
        paginationState.attendanceHistory = { page: 1, pageSize: 10 };


        // ===== S·ª¨A PHI·∫æU ƒêƒÇNG K√ù - C·∫¨P NH·∫¨T =====
        function editRegistration(id) {
            const reg = registrations.find(r => r.id === id);
            if (!reg) return;

            const student = students.find(s => s.id === reg.studentId);

            // ƒêi·ªÅn ID ƒëang s·ª≠a
            document.getElementById('editRegId').value = id;
            document.getElementById('regStudentId').value = reg.studentId;

            // Populate dropdown h·ªçc vi√™n
            const allStudents = students.filter(s =>
                s.status === 'Ch·ªù ƒêƒÉng K√Ω' ||
                s.status === 'ƒê√£ ƒêƒÉng K√Ω' ||
                s.id === reg.studentId
            );
            document.getElementById('regStudentSelect').innerHTML = '<option value="">-- Ch·ªçn h·ªçc vi√™n --</option>' +
                allStudents.map(s => `<option value="${s.id}" ${s.id === reg.studentId ? 'selected' : ''}>${s.name} - ${s.parentPhone}</option>`).join('');

            // Populate dropdown m√¥n h·ªçc
            if (student) {
                document.getElementById('regSubject').innerHTML = '<option value="">-- Ch·ªçn m√¥n --</option>' +
                    student.subjects.map(s => `<option value="${s}" ${s === reg.subject ? 'selected' : ''}>${s}</option>`).join('');
            }

            // Populate v√† ch·ªçn g√≥i h·ªçc ph√≠
            const subjectPackages = packages.filter(p => p.subjectName === reg.subject);
            document.getElementById('regPackage').innerHTML = '<option value="">-- Ch·ªçn g√≥i --</option>' +
                subjectPackages.map(p => `<option value="${p.id}" ${p.id === reg.packageId ? 'selected' : ''}>${p.name} - ${p.sessions} bu·ªïi - ${formatCurrency(p.fee)}</option>`).join('');

            // ƒêi·ªÅn s·ªë bu·ªïi
            document.getElementById('regTotalSessions').value = reg.totalSessions || '';

            // ƒêi·ªÅn ng√†y b·∫Øt ƒë·∫ßu
            document.getElementById('regStartDate').value = reg.startDate || '';

            // ƒêi·ªÅn h·ªçc ph√≠
            document.getElementById('regTuitionFee').value = formatNumberInput(reg.tuitionFee);

            // ƒêi·ªÅn ng√†y ƒëƒÉng k√Ω
            document.getElementById('regDate').value = reg.registrationDate || '';

            // ƒêi·ªÅn ghi ch√∫
            document.getElementById('regNotes').value = reg.notes || '';

            // Render khuy·∫øn m√£i v√† tick c√°c khuy·∫øn m√£i ƒë√£ ch·ªçn
            renderPromotionCheckboxes();
            setTimeout(() => {
                if (reg.promotionIds && reg.promotionIds.length > 0) {
                    reg.promotionIds.forEach(promoId => {
                        const cb = document.querySelector(`input[name="regPromotions"][value="${promoId}"]`);
                        if (cb) cb.checked = true;
                    });
                }
                calculateFinalAmount();
            }, 100);

            // ƒê·ªïi ti√™u ƒë·ªÅ modal
            const modalTitle = document.querySelector('#registrationModal .modal-header h2');
            if (modalTitle) modalTitle.textContent = '‚úèÔ∏è S·ª≠a Phi·∫øu ƒêƒÉng K√Ω';

            openModal('registrationModal');
        }


        // ===== S·ª¨A BI√äN LAI =====
        function editReceipt(id) {
            const receipt = receipts.find(r => r.id === id);
            if (!receipt) return;

            const student = students.find(s => s.id === receipt.studentId);

            // ƒêi·ªÅn ID ƒëang s·ª≠a
            document.getElementById('editReceiptId').value = receipt.id;

            // ƒêi·ªÅn lo·∫°i
            document.getElementById('receiptType').value = receipt.type;

            // Populate dropdown h·ªçc vi√™n (bao g·ªìm c·∫£ HV ƒë√£ ƒëƒÉng k√Ω)
            const eligibleStudents = students.filter(s => s.status === 'ƒê√£ ƒêƒÉng K√Ω' || s.id === receipt.studentId);
            document.getElementById('receiptStudentId').innerHTML = '<option value="">-- Ch·ªçn h·ªçc vi√™n --</option>' +
                eligibleStudents.map(s => `<option value="${s.id}" ${s.id === receipt.studentId ? 'selected' : ''}>${s.name} - ${s.parentPhone}</option>`).join('');

            // ƒêi·ªÅn th√¥ng tin ph·ª• huynh
            document.getElementById('receiptParentName').value = receipt.parentName || student?.parentName || '';
            document.getElementById('receiptParentPhone').value = receipt.parentPhone || student?.parentPhone || '';

            // Populate dropdown phi·∫øu ƒêK
            if (receipt.studentId) {
                const studentRegs = registrations.filter(r => r.studentId === receipt.studentId);
                document.getElementById('receiptRegistrationSelect').innerHTML = '<option value="">-- Ch·ªçn phi·∫øu ƒêK --</option>' +
                    studentRegs.map(r => `<option value="${r.id}" ${r.id === receipt.registrationId ? 'selected' : ''}>${r.regCode} - ${formatCurrency(r.finalAmount)}</option>`).join('');
            }

            // ƒêi·ªÅn c√°c tr∆∞·ªùng kh√°c
            document.getElementById('receiptDescription').value = receipt.description;
            document.getElementById('receiptAmount').value = formatNumberInput(receipt.amount);
            document.getElementById('receiptDate').value = receipt.date;
            document.getElementById('receiptNotes').value = receipt.notes || '';

            // ƒê·ªïi ti√™u ƒë·ªÅ modal
            const modalTitle = document.querySelector('#receiptModal .modal-header h2');
            if (modalTitle) modalTitle.textContent = '‚úèÔ∏è S·ª≠a Bi√™n Lai';

            openModal('receiptModal');
        }

        // ===== C·∫¨P NH·∫¨T H√ÄM SAVE REGISTRATION (h·ªó tr·ª£ S·ª≠a) =====
        const originalSaveRegistration = saveRegistration;
        saveRegistration = function (event) {
            event.preventDefault();

            const editId = document.getElementById('editRegId')?.value;
            const studentId = document.getElementById('regStudentId').value;

            if (!studentId) {
                showNotification('Vui l√≤ng ch·ªçn h·ªçc vi√™n!', 'error');
                return;
            }

            const student = students.find(s => s.id === studentId);
            const tuition = parseCurrencyInput(document.getElementById('regTuitionFee').value);
            const selectedPromoIds = Array.from(document.querySelectorAll('input[name="regPromotions"]:checked')).map(cb => cb.value);

            let discount = 0;
            selectedPromoIds.forEach(promoId => {
                const promo = promotions.find(p => p.id === promoId);
                if (promo) discount += promo.type === 'percent' ? tuition * promo.value / 100 : promo.value;
            });

            const finalAmount = Math.max(tuition - discount, 0);

            const regData = {
                studentId,
                studentName: student ? student.name : '',
                parentName: student ? student.parentName : '',
                parentPhone: student ? student.parentPhone : '',
                subject: document.getElementById('regSubject').value,
                packageId: document.getElementById('regPackage').value || null,
                tuitionFee: tuition,
                promotionIds: selectedPromoIds,
                discountAmount: discount,
                finalAmount
            };

            if (editId) {
                // C·∫¨P NH·∫¨T
                const index = registrations.findIndex(r => r.id === editId);
                if (index !== -1) {
                    registrations[index] = {
                        ...registrations[index],
                        ...regData,
                        updatedAt: new Date().toISOString()
                    };
                    showNotification('C·∫≠p nh·∫≠t phi·∫øu ƒêK th√†nh c√¥ng!', 'success');
                }
                // X√≥a editId
                document.getElementById('editRegId').value = '';
            } else {
                // TH√äM M·ªöI
                const regCode = generateRegCode();
                registrations.push({
                    id: generateId(),
                    regCode,
                    ...regData,
                    registrationDate: new Date().toISOString().split('T')[0],
                    createdAt: new Date().toISOString()
                });

                // C·∫≠p nh·∫≠t tr·∫°ng th√°i h·ªçc vi√™n
                if (student && student.status === 'Ch·ªù ƒêƒÉng K√Ω') {
                    student.status = 'ƒê√£ ƒêƒÉng K√Ω';
                    saveData('students', students);
                }

                showNotification(`T·∫°o phi·∫øu ƒêK th√†nh c√¥ng! M√£: ${regCode}`, 'success');
            }

            saveData('registrations', registrations);
            closeModal('registrationModal');

            // Reset ti√™u ƒë·ªÅ
            const modalTitle = document.querySelector('#registrationModal .modal-header h2');
            if (modalTitle) modalTitle.textContent = 'üìã T·∫°o Phi·∫øu ƒêƒÉng K√Ω';

            renderAll();
        };

        // ===== C·∫¨P NH·∫¨T H√ÄM RENDER B·∫¢NG PHI·∫æU ƒêK (th√™m n√∫t S·ª≠a) =====
        renderRegistrationsTable = function () {
            const filtered = getFilteredRegistrations();
            const { data, total, totalPages, currentPage } = getPaginatedData(filtered, 'registrations');
            const tbody = document.getElementById('registrationsTableBody');

            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7"><div class="empty-state"><div class="empty-state-icon">üìã</div><p>Kh√¥ng c√≥ phi·∫øu ƒêK</p></div></td></tr>`;
                renderPagination('registrationsPagination', 'registrations', 0, 0, 1);
                return;
            }

            tbody.innerHTML = data.map(r => `
                <tr>
                    <td><strong class="text-primary">${r.regCode}</strong></td>
                    <td>${r.studentName || 'N/A'}</td>
                    <td><span class="subject-tag">${r.subject}</span><br><small class="text-muted">${formatCurrency(r.tuitionFee)}</small></td>
                    <td class="text-danger">${r.discountAmount > 0 ? '-' + formatCurrency(r.discountAmount) : '-'}</td>
                    <td><strong class="text-success">${formatCurrency(r.finalAmount)}</strong></td>
                    <td>${formatDate(r.registrationDate)}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn view" onclick="viewRegistration('${r.id}')" title="Xem">üëÅÔ∏è</button>
                            ${canEdit('registrations') ? `<button class="action-btn edit" onclick="editRegistration('${r.id}')" title="S·ª≠a">‚úèÔ∏è</button>` : ''}
                            ${canDelete('registrations') ? `<button class="action-btn delete" onclick="deleteRegistration('${r.id}')" title="X√≥a">üóëÔ∏è</button>` : ''}
                        </div>
                    </td>
                </tr>
            `).join('');

            renderPagination('registrationsPagination', 'registrations', total, totalPages, currentPage);
        };

        // ===== C·∫¨P NH·∫¨T H√ÄM RENDER B·∫¢NG BI√äN LAI (th√™m n√∫t S·ª≠a) =====
        renderReceiptsTable = function () {
            const filtered = getFilteredReceipts();
            const { data, total, totalPages, currentPage } = getPaginatedData(filtered, 'receipts');
            const tbody = document.getElementById('receiptsTableBody');

            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7"><div class="empty-state"><div class="empty-state-icon">üßæ</div><p>Kh√¥ng c√≥ bi√™n lai</p></div></td></tr>`;
                renderPagination('receiptsPagination', 'receipts', 0, 0, 1);
                return;
            }

            tbody.innerHTML = data.map((r, idx) => {
                const student = students.find(s => s.id === r.studentId);
                const displayCode = r.receiptCode || `#${String(total - (currentPage - 1) * paginationState.receipts.pageSize - idx).padStart(4, '0')}`;

                return `
                    <tr>
                        <td><strong>${displayCode}</strong></td>
                        <td><span class="subject-tag">${r.type}</span></td>
                        <td>${student?.name || 'N/A'}</td>
                        <td>${r.description}</td>
                        <td><strong class="text-success">${formatCurrency(r.amount)}</strong></td>
                        <td>${formatDate(r.date)}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="action-btn view" onclick="viewReceipt('${r.id}')" title="Xem">üëÅÔ∏è</button>
                                ${canEdit('receipts') ? `<button class="action-btn edit" onclick="editReceipt('${r.id}')" title="S·ª≠a">‚úèÔ∏è</button>` : ''}
                                ${canDelete('receipts') ? `<button class="action-btn delete" onclick="deleteReceipt('${r.id}')" title="X√≥a">üóëÔ∏è</button>` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            renderPagination('receiptsPagination', 'receipts', total, totalPages, currentPage);
        };

        // ===== C·∫¨P NH·∫¨T H√ÄM RENDER B·∫¢NG GI√ÅO VI√äN (c√≥ ph√¢n trang) =====
        renderTeachersTable = function () {
            const searchTerm = document.getElementById('searchTeacher')?.value?.toLowerCase() || '';

            let filtered = teachers.filter(t =>
                t.fullName.toLowerCase().includes(searchTerm) ||
                t.phone.includes(searchTerm)
            );

            const { data, total, totalPages, currentPage } = getPaginatedData(filtered, 'teachers');
            const tbody = document.getElementById('teachersTableBody');

            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6"><div class="empty-state"><div class="empty-state-icon">üë®‚Äçüè´</div><p>Ch∆∞a c√≥ gi√°o vi√™n n√†o</p></div></td></tr>`;
                renderPagination('teachersPagination', 'teachers', 0, 0, 1);
                return;
            }

            tbody.innerHTML = data.map(t => `
                <tr>
                    <td><strong>${t.fullName}</strong></td>
                    <td>${t.phone}</td>
                    <td>${t.subjects.map(s => `<span class="subject-tag">${getSubjectIcon(s)} ${s}</span>`).join(' ')}</td>
                    <td>${getSalaryTypeLabel(t.salaryType)}</td>
                    <td><span class="status-badge ${t.status === 'active' ? 'active' : 'locked'}">${t.status === 'active' ? 'üü¢ ƒêang d·∫°y' : '‚ö´ Ngh·ªâ'}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn view" onclick="viewTeacher('${t.id}')" title="Xem">üëÅÔ∏è</button>
                            ${canEdit('teachers') ? `<button class="action-btn edit" onclick="editTeacher('${t.id}')" title="S·ª≠a">‚úèÔ∏è</button>` : ''}
                            ${canDelete('teachers') ? `<button class="action-btn delete" onclick="deleteTeacher('${t.id}')" title="X√≥a">üóëÔ∏è</button>` : ''}
                        </div>
                    </td>
                </tr>
            `).join('');

            renderPagination('teachersPagination', 'teachers', total, totalPages, currentPage);
        };

        // ===== C·∫¨P NH·∫¨T H√ÄM SEARCH GI√ÅO VI√äN =====
        searchTeachers = function () {
            paginationState.teachers.page = 1;
            renderTeachersTable();
        };

        // ===== C·∫¨P NH·∫¨T H√ÄM RENDER B·∫¢NG L·ªöP H·ªåC (c√≥ ph√¢n trang) =====
        renderClassesTable = function () {
            const searchTerm = document.getElementById('searchClass')?.value?.toLowerCase() || '';
            const filterSubject = document.getElementById('filterClassSubject')?.value || '';
            const filterTeacher = document.getElementById('filterClassTeacher')?.value || '';
            const filterStatus = document.getElementById('filterClassStatus')?.value || '';

            let filtered = classes.filter(c => {
                if (searchTerm && !c.className.toLowerCase().includes(searchTerm)) return false;
                if (filterSubject && c.subjectId !== filterSubject) return false;
                if (filterTeacher && c.teacherId !== filterTeacher) return false;
                if (filterStatus && c.status !== filterStatus) return false;
                return true;
            });

            const { data, total, totalPages, currentPage } = getPaginatedData(filtered, 'classes');
            const tbody = document.getElementById('classesTableBody');

            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8"><div class="empty-state"><div class="empty-state-icon">üìö</div><p>Ch∆∞a c√≥ l·ªõp h·ªçc n√†o</p></div></td></tr>`;
                renderPagination('classesPagination', 'classes', 0, 0, 1);
                return;
            }

            tbody.innerHTML = data.map(c => {
                const subject = subjects.find(s => s.id === c.subjectId);
                const teacher = teachers.find(t => t.id === c.teacherId);
                const clsSchedules = classSchedules.filter(s => s.classId === c.id && s.isActive);
                const studentCount = classStudents.filter(cs => cs.classId === c.id && cs.status === 'active').length;

                return `
                    <tr>
                        <td><strong>${c.className}</strong></td>
                        <td>${subject ? `${subject.icon} ${subject.name}` : '-'}</td>
                        <td>${teacher ? teacher.fullName : '<span class="text-muted">Ch∆∞a c√≥</span>'}</td>
                        <td>${c.classType === 'group' ? 'üë• Nh√≥m' : 'üë§ 1-1'}</td>
                        <td><strong>${studentCount}</strong>/${c.maxStudents}</td>
                        <td>${formatSchedules(clsSchedules)}</td>
                        <td>${getClassStatusBadge(c.status)}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="action-btn view" onclick="viewClass('${c.id}')" title="Xem">üëÅÔ∏è</button>
                                ${canEdit('classes') ? `<button class="action-btn edit" onclick="editClass('${c.id}')" title="S·ª≠a">‚úèÔ∏è</button>` : ''}
                                ${canDelete('classes') ? `<button class="action-btn delete" onclick="deleteClass('${c.id}')" title="X√≥a">üóëÔ∏è</button>` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            renderPagination('classesPagination', 'classes', total, totalPages, currentPage);
        };

        // ===== C·∫¨P NH·∫¨T H√ÄM SEARCH/FILTER L·ªöP H·ªåC =====
        searchClasses = function () {
            paginationState.classes.page = 1;
            renderClassesTable();
        };

        filterClasses = function () {
            paginationState.classes.page = 1;
            renderClassesTable();
        };

        // ===== C·∫¨P NH·∫¨T H√ÄM RENDER B·∫¢NG H·ªåC B√ô (c√≥ ph√¢n trang) =====
        renderMakeupRequests = function () {
            updateMakeupStats();

            const today = new Date().toISOString().split('T')[0];

            let filtered = [...makeupRequests];

            // √Åp d·ª•ng filter
            if (currentMakeupFilter === 'pending') {
                filtered = filtered.filter(m => m.status === 'pending');
            } else if (currentMakeupFilter === 'approved') {
                filtered = filtered.filter(m => m.status === 'approved');
            } else if (currentMakeupFilter === 'expiring') {
                const in7Days = new Date();
                in7Days.setDate(in7Days.getDate() + 7);
                filtered = filtered.filter(m =>
                    (m.status === 'pending' || m.status === 'approved') &&
                    new Date(m.expiryDate) <= in7Days
                );
            } else if (currentMakeupFilter === 'completed') {
                filtered = filtered.filter(m => m.status === 'completed');
            } else if (currentMakeupFilter === 'expired') {
                filtered = filtered.filter(m => m.status === 'expired');
            }

            // S·∫Øp x·∫øp theo h·∫°n g·∫ßn nh·∫•t
            filtered.sort((a, b) => new Date(a.expiryDate) - new Date(b.expiryDate));

            const { data, total, totalPages, currentPage } = getPaginatedData(filtered, 'makeup');
            const tbody = document.getElementById('makeupRequestsBody');

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">Kh√¥ng c√≥ y√™u c·∫ßu h·ªçc b√π</td></tr>';
                renderPagination('makeupPagination', 'makeup', 0, 0, 1);
                return;
            }

            tbody.innerHTML = data.map(m => {
                const student = students.find(s => s.id === m.studentId);
                const originalClass = classes.find(c => c.id === m.originalClassId);
                const makeupClass = m.makeupClassId ? classes.find(c => c.id === m.makeupClassId) : null;

                const daysLeft = Math.ceil((new Date(m.expiryDate) - new Date(today)) / (1000 * 60 * 60 * 24));
                const expiryClass = daysLeft <= 3 ? 'text-danger fw-700' : daysLeft <= 7 ? 'text-warning fw-600' : '';

                return `
                    <tr>
                        <td><strong>${student ? student.name : 'N/A'}</strong></td>
                        <td>${originalClass ? originalClass.className : 'N/A'}</td>
                        <td>${formatDate(m.originalDate)}</td>
                        <td><span class="${expiryClass}">${formatDate(m.expiryDate)} ${daysLeft > 0 ? `(${daysLeft} ng√†y)` : ''}</span></td>
                        <td>${makeupClass ? makeupClass.className : '<span class="text-muted">Ch∆∞a x·∫øp</span>'}</td>
                        <td>${m.makeupDate ? formatDate(m.makeupDate) : '-'}</td>
                        <td>${getMakeupStatusBadge(m.status)}</td>
                        <td>
                            <div class="action-buttons">
                                ${m.status === 'pending' ? `<button class="action-btn schedule" onclick="openScheduleMakeupModal('${m.id}')" title="X·∫øp l·ªãch">üìÖ</button>` : ''}
                                ${m.status === 'approved' ? `<button class="action-btn edit" onclick="openConfirmMakeupModal('${m.id}')" title="X√°c nh·∫≠n ho√†n th√†nh">‚úÖ</button>` : ''}
                                ${(m.status === 'pending' || m.status === 'approved') ? `<button class="action-btn delete" onclick="cancelMakeupRequest('${m.id}')" title="H·ªßy">üóëÔ∏è</button>` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            renderPagination('makeupPagination', 'makeup', total, totalPages, currentPage);
        };

        // ===== C·∫¨P NH·∫¨T H√ÄM FILTER H·ªåC B√ô =====
        filterMakeupRequests = function (filter) {
            currentMakeupFilter = filter;
            paginationState.makeup.page = 1;
            document.querySelectorAll('#makeup .filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
            });
            renderMakeupRequests();
        };

        // ===== C·∫¨P NH·∫¨T H√ÄM LOAD L·ªäCH S·ª¨ ƒêI·ªÇM DANH (c√≥ ph√¢n trang) =====
        loadAttendanceHistory = function () {
            // Nh√≥m theo ng√†y + l·ªõp + ca
            const grouped = {};

            attendances.forEach(a => {
                const key = `${a.attendanceDate}_${a.classId}_${a.scheduleId}`;
                if (!grouped[key]) {
                    grouped[key] = {
                        date: a.attendanceDate,
                        classId: a.classId,
                        scheduleId: a.scheduleId,
                        records: []
                    };
                }
                grouped[key].records.push(a);
            });

            // S·∫Øp x·∫øp theo ng√†y m·ªõi nh·∫•t
            const sortedGroups = Object.values(grouped).sort((a, b) =>
                new Date(b.date) - new Date(a.date)
            );

            const { data, total, totalPages, currentPage } = getPaginatedData(sortedGroups, 'attendanceHistory');
            const tbody = document.getElementById('attendanceHistoryBody');

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Ch∆∞a c√≥ d·ªØ li·ªáu ƒëi·ªÉm danh</td></tr>';
                renderPagination('attendanceHistoryPagination', 'attendanceHistory', 0, 0, 1);
                return;
            }

            tbody.innerHTML = data.map(g => {
                const cls = classes.find(c => c.id === g.classId);
                const schedule = classSchedules.find(s => s.id === g.scheduleId);

                const totalStudents = g.records.length;
                const presentCount = g.records.filter(r => r.status === 'present' || r.status === 'late').length;
                const absentCount = g.records.filter(r => r.status === 'absent' || r.status === 'excused').length;

                return `
                    <tr>
                        <td><strong>${formatDate(g.date)}</strong></td>
                        <td>${cls ? cls.className : 'N/A'}</td>
                        <td>${schedule ? schedule.startTime + '-' + schedule.endTime : 'N/A'}</td>
                        <td>${totalStudents}</td>
                        <td><span class="text-success">${presentCount}</span></td>
                        <td><span class="text-danger">${absentCount}</span></td>
                        <td>
                            <button class="action-btn view" onclick="viewAttendanceDetail('${g.date}', '${g.classId}', '${g.scheduleId}')" title="Xem chi ti·∫øt">üëÅÔ∏è</button>
                        </td>
                    </tr>
                `;
            }).join('');

            renderPagination('attendanceHistoryPagination', 'attendanceHistory', total, totalPages, currentPage);
        };

        // ===== RESET TI√äU ƒê·ªÄ KHI M·ªû MODAL T·∫†O M·ªöI =====
        const originalOpenNewRegistrationModal = openNewRegistrationModal;
        openNewRegistrationModal = function () {
            // Reset editId n·∫øu c√≥
            if (document.getElementById('editRegId')) {
                document.getElementById('editRegId').value = '';
            }

            // Reset ti√™u ƒë·ªÅ
            const modalTitle = document.querySelector('#registrationModal .modal-header h2');
            if (modalTitle) modalTitle.textContent = 'üìã T·∫°o Phi·∫øu ƒêƒÉng K√Ω';

            // G·ªçi h√†m g·ªëc
            document.getElementById('regStudentId').value = '';
            document.getElementById('registrationForm').reset();
            populateRegStudentDropdown();
            renderPromotionCheckboxes();
            openModal('registrationModal');
        };

        const originalOpenReceiptModal = openReceiptModal;
        openReceiptModal = function () {
            // Reset editId
            document.getElementById('editReceiptId').value = '';

            // Reset ti√™u ƒë·ªÅ
            const modalTitle = document.querySelector('#receiptModal .modal-header h2');
            if (modalTitle) modalTitle.textContent = 'üßæ T·∫°o Bi√™n Lai';

            // Reset form
            document.getElementById('receiptForm').reset();
            document.getElementById('receiptDate').value = new Date().toISOString().split('T')[0];
            populateReceiptStudentDropdown();
            openModal('receiptModal');
        };

        console.log('üìã Module S·ª≠a Phi·∫øu ƒêK/Bi√™n Lai + Ph√¢n trang ƒê√†o t·∫°o ƒë√£ ƒë∆∞·ª£c t·∫£i!');

        /* ============================================================
        üßæ MODULE 2: BI√äN LAI - C·∫¨P NH·∫¨T LOGIC
        ============================================================ */

        // ===== 2.1 Bi·∫øn l∆∞u tr·ªØ filter bi√™n lai =====
        let receiptFilterState = {
            fromDate: null,
            toDate: null,
            type: 'all',
            period: 'thisMonth'
        };

        // ===== 2.2 X·ª≠ l√Ω khi ƒë·ªïi lo·∫°i bi√™n lai =====
        function onReceiptTypeChange() {
            const type = document.getElementById('receiptType').value;
            const descriptionInput = document.getElementById('receiptDescription');
            const registrationGroup = document.getElementById('receiptRegistrationSelect')?.parentElement;

            if (type === 'Phi·∫øu Chi') {
                // Bi√™n lai chi - Thay ƒë·ªïi placeholder v√† label
                descriptionInput.placeholder = 'Nh·∫≠p l√Ω do ho√†n ti·ªÅn (b·∫Øt bu·ªôc)';
                descriptionInput.setAttribute('required', 'required');

                // C√≥ th·ªÉ ·∫©n dropdown phi·∫øu ƒêK n·∫øu mu·ªën (t√πy ch·ªçn)
                // if (registrationGroup) registrationGroup.style.display = 'none';
            } else {
                descriptionInput.placeholder = 'VD: H·ªçc ph√≠ th√°ng 1';

                // if (registrationGroup) registrationGroup.style.display = 'block';
            }
        }

        // ===== 2.3 Populate dropdown Phi·∫øu ƒêK - CH·ªà HI·ªÜN PHI·∫æU CH∆ØA THU ƒê·ª¶ =====
        function fillReceiptStudentInfo() {
            const studentId = document.getElementById('receiptStudentId').value;
            const student = students.find(s => s.id === studentId);

            document.getElementById('receiptParentName').value = student?.parentName || '';
            document.getElementById('receiptParentPhone').value = student?.parentPhone || '';

            if (studentId) {
                // L·∫•y c√°c phi·∫øu ƒêK c·ªßa h·ªçc vi√™n
                const studentRegs = registrations.filter(r => r.studentId === studentId);

                // L·ªçc ch·ªâ hi·ªán phi·∫øu ch∆∞a thu ƒë·ªß
                const unpaidRegs = studentRegs.filter(reg => {
                    const debt = calculateDebtForRegistration(reg.id);
                    // Ch·ªâ hi·ªán n·∫øu c√≤n n·ª£ > 0
                    return debt.debtAmount > 0;
                });

                // Render dropdown v·ªõi th√¥ng tin chi ti·∫øt
                document.getElementById('receiptRegistrationSelect').innerHTML =
                    '<option value="">-- Ch·ªçn phi·∫øu ƒêK (ch·ªâ hi·ªán phi·∫øu ch∆∞a thu ƒë·ªß) --</option>' +
                    unpaidRegs.map(r => {
                        const debt = calculateDebtForRegistration(r.id);
                        const statusText = debt.paidAmount > 0
                            ? `ƒê√£ thu: ${formatCurrencyShort(debt.paidAmount)}, C√≤n: ${formatCurrencyShort(debt.debtAmount)}`
                            : `Ch∆∞a thu - T·ªïng: ${formatCurrencyShort(debt.totalAmount)}`;
                        return `<option value="${r.id}">${r.regCode} - ${r.subject} | ${statusText}</option>`;
                    }).join('');

                // Th√¥ng b√°o n·∫øu kh√¥ng c√≥ phi·∫øu n√†o c·∫ßn thu
                if (unpaidRegs.length === 0 && studentRegs.length > 0) {
                    document.getElementById('receiptRegistrationSelect').innerHTML =
                        '<option value="">‚úÖ T·∫•t c·∫£ phi·∫øu ƒêK ƒë√£ thu ƒë·ªß ti·ªÅn</option>';
                }
            } else {
                document.getElementById('receiptRegistrationSelect').innerHTML =
                    '<option value="">-- Ch·ªçn phi·∫øu ƒêK --</option>';
            }
        }

        // ===== 2.4 Khi ch·ªçn Phi·∫øu ƒêK - T·ª± ƒë·ªông ƒëi·ªÅn s·ªë ti·ªÅn c√≤n n·ª£ =====
        function fillFromRegistration() {
            const regId = document.getElementById('receiptRegistrationSelect').value;
            const reg = registrations.find(r => r.id === regId);
            const receiptType = document.getElementById('receiptType').value;

            if (reg && receiptType !== 'Phi·∫øu Chi') {
                const debt = calculateDebtForRegistration(regId);

                // T·ª± ƒë·ªông ƒëi·ªÅn n·ªôi dung
                document.getElementById('receiptDescription').value = `Thanh to√°n h·ªçc ph√≠ - ${reg.subject} - ${reg.regCode}`;

                // T·ª± ƒë·ªông ƒëi·ªÅn s·ªë ti·ªÅn C√íN N·ª¢ (kh√¥ng ph·∫£i t·ªïng ti·ªÅn)
                document.getElementById('receiptAmount').value = formatNumberInput(debt.debtAmount);

                // L∆∞u registrationId ·∫©n
                document.getElementById('receiptRegistrationId').value = regId;
            }
        }

        // ===== 2.5 L∆∞u bi√™n lai - C·∫≠p nh·∫≠t x·ª≠ l√Ω bi√™n lai chi =====
        function saveReceipt(event) {
            event.preventDefault();

            const studentId = document.getElementById('receiptStudentId').value;
            const student = students.find(s => s.id === studentId);
            const editId = document.getElementById('editReceiptId').value;
            const receiptType = document.getElementById('receiptType').value;
            const description = document.getElementById('receiptDescription').value.trim();
            const amount = parseCurrencyInput(document.getElementById('receiptAmount').value);

            // Validation
            if (!studentId) {
                showNotification('Vui l√≤ng ch·ªçn h·ªçc vi√™n!', 'error');
                return;
            }

            if (!receiptType) {
                showNotification('Vui l√≤ng ch·ªçn lo·∫°i bi√™n lai!', 'error');
                return;
            }

            if (amount <= 0) {
                showNotification('S·ªë ti·ªÅn ph·∫£i l·ªõn h∆°n 0!', 'error');
                return;
            }

            // Validation ri√™ng cho Phi·∫øu Chi
            if (receiptType === 'Phi·∫øu Chi' && !description) {
                showNotification('Vui l√≤ng nh·∫≠p l√Ω do ho√†n ti·ªÅn!', 'error');
                return;
            }

            const data = {
                studentId,
                type: receiptType,
                isRefund: receiptType === 'Phi·∫øu Chi', // Flag ƒë·ªÉ ph√¢n bi·ªát thu/chi
                parentName: student?.parentName || '',
                parentPhone: student?.parentPhone || '',
                registrationId: document.getElementById('receiptRegistrationSelect')?.value || null,
                description: description,
                amount: amount,
                date: document.getElementById('receiptDate').value,
                notes: document.getElementById('receiptNotes').value.trim()
            };

            if (editId) {
                // C·∫¨P NH·∫¨T - Gi·ªØ nguy√™n receiptCode c≈©
                const index = receipts.findIndex(r => r.id === editId);
                if (index !== -1) {
                    receipts[index] = {
                        ...receipts[index],
                        ...data,
                        receiptCode: receipts[index].receiptCode,
                        updatedAt: new Date().toISOString()
                    };
                    showNotification('C·∫≠p nh·∫≠t bi√™n lai th√†nh c√¥ng!', 'success');
                }
            } else {
                // TH√äM M·ªöI
                const prefix = receiptType === 'Phi·∫øu Chi' ? 'PC' : 'BL';
                const newReceipt = {
                    id: generateId(),
                    receiptCode: generateReceiptCodeWithPrefix(prefix),
                    ...data,
                    createdBy: currentUser?.id || null,
                    createdAt: new Date().toISOString()
                };
                receipts.push(newReceipt);

                const typeLabel = receiptType === 'Phi·∫øu Chi' ? 'Phi·∫øu chi' : 'Bi√™n lai';
                showNotification(`T·∫°o ${typeLabel} th√†nh c√¥ng!`, 'success');
            }

            saveData('receipts', receipts);
            closeModal('receiptModal');

            // Reset form title
            const modalTitle = document.querySelector('#receiptModal .modal-header h2');
            if (modalTitle) modalTitle.textContent = 'üßæ T·∫°o Bi√™n Lai';

            renderReceiptsTable();

            // C·∫≠p nh·∫≠t c√¥ng n·ª£ n·∫øu ƒëang ·ªü tab ƒë√≥
            if (document.getElementById('debts').classList.contains('active')) {
                renderDebtsTable();
            }
        }

        // ===== 2.6 T·∫°o m√£ bi√™n lai v·ªõi prefix =====
        function generateReceiptCodeWithPrefix(prefix = 'BL') {
            const date = new Date();
            const y = date.getFullYear().toString().slice(2);
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            const todayStr = `${y}${m}${d}`;

            // ƒê·∫øm s·ªë bi√™n lai c√πng prefix trong ng√†y
            const todayReceipts = receipts.filter(r => {
                const code = r.receiptCode || '';
                return code.startsWith(prefix) && code.includes(todayStr);
            });
            const seq = String(todayReceipts.length + 1).padStart(4, '0');

            return `${prefix}${todayStr}-${seq}`;
        }

        // ===== 2.7 C·∫≠p nh·∫≠t t√≠nh c√¥ng n·ª£ - Tr·ª´ bi√™n lai chi =====
        function calculateDebtForRegistration(regId) {
            const reg = registrations.find(r => r.id === regId);
            if (!reg) return { totalAmount: 0, paidAmount: 0, debtAmount: 0 };

            // T·ªïng ti·ªÅn = finalAmount (ho·∫∑c adjustedAmount n·∫øu ƒë√£ ƒëi·ªÅu ch·ªânh)
            const totalAmount = reg.adjustedAmount !== undefined ? reg.adjustedAmount : reg.finalAmount;

            // L·∫•y t·∫•t c·∫£ bi√™n lai li√™n k·∫øt v·ªõi phi·∫øu ƒêK n√†y
            const relatedReceipts = receipts.filter(r => r.registrationId === regId);

            // T√≠nh t·ªïng thu v√† t·ªïng chi
            let totalIncome = 0;  // Bi√™n lai thu
            let totalRefund = 0;  // Bi√™n lai chi (ho√†n ti·ªÅn)

            relatedReceipts.forEach(r => {
                const amount = parseFloat(r.amount) || 0;
                if (r.isRefund || r.type === 'Phi·∫øu Chi') {
                    totalRefund += amount;
                } else {
                    totalIncome += amount;
                }
            });

            // ƒê√£ ƒë√≥ng = Thu - Chi
            const paidAmount = Math.max(0, totalIncome - totalRefund);

            // C√≤n n·ª£
            const debtAmount = Math.max(0, totalAmount - paidAmount);

            return {
                totalAmount,
                paidAmount,
                debtAmount,
                totalIncome,
                totalRefund
            };
        }

        // ===== 2.8 X·ª≠ l√Ω filter theo th·ªùi gian =====
        function onReceiptPeriodChange() {
            const period = document.getElementById('receiptPeriodFilter').value;
            const now = new Date();
            let fromDate, toDate;

            switch (period) {
                case 'all':
                    fromDate = null;
                    toDate = null;
                    break;
                case 'thisMonth':
                    fromDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    toDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    break;
                case 'lastMonth':
                    fromDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    toDate = new Date(now.getFullYear(), now.getMonth(), 0);
                    break;
                case 'thisQuarter':
                    const quarter = Math.floor(now.getMonth() / 3);
                    fromDate = new Date(now.getFullYear(), quarter * 3, 1);
                    toDate = new Date(now.getFullYear(), quarter * 3 + 3, 0);
                    break;
                case 'thisYear':
                    fromDate = new Date(now.getFullYear(), 0, 1);
                    toDate = new Date(now.getFullYear(), 11, 31);
                    break;
                case 'custom':
                    // Gi·ªØ nguy√™n gi√° tr·ªã hi·ªán t·∫°i, cho user t·ª± ch·ªçn
                    return;
            }

            if (fromDate) {
                document.getElementById('receiptFilterFromDate').value = fromDate.toISOString().split('T')[0];
            } else {
                document.getElementById('receiptFilterFromDate').value = '';
            }

            if (toDate) {
                document.getElementById('receiptFilterToDate').value = toDate.toISOString().split('T')[0];
            } else {
                document.getElementById('receiptFilterToDate').value = '';
            }

            receiptFilterState.period = period;
            filterReceiptsByDate();
        }

        function filterReceiptsByDate() {
            receiptFilterState.fromDate = document.getElementById('receiptFilterFromDate').value || null;
            receiptFilterState.toDate = document.getElementById('receiptFilterToDate').value || null;
            receiptFilterState.type = document.getElementById('receiptTypeFilter').value || 'all';

            paginationState.receipts.page = 1;
            renderReceiptsTable();
        }

        // ===== 2.9 L·ªçc bi√™n lai theo ƒëi·ªÅu ki·ªán =====
        function getFilteredReceipts() {
            const searchTerm = document.getElementById('searchReceipt')?.value?.toLowerCase() || '';
            let filtered = [...receipts];

            // L·ªçc theo th·ªùi gian
            if (receiptFilterState.fromDate) {
                filtered = filtered.filter(r => r.date >= receiptFilterState.fromDate);
            }
            if (receiptFilterState.toDate) {
                filtered = filtered.filter(r => r.date <= receiptFilterState.toDate);
            }

            // L·ªçc theo lo·∫°i (thu/chi)
            if (receiptFilterState.type === 'thu') {
                filtered = filtered.filter(r => !r.isRefund && r.type !== 'Phi·∫øu Chi');
            } else if (receiptFilterState.type === 'chi') {
                filtered = filtered.filter(r => r.isRefund || r.type === 'Phi·∫øu Chi');
            }

            // L·ªçc theo t·ª´ kh√≥a
            if (searchTerm) {
                filtered = filtered.filter(r => {
                    const student = students.find(s => s.id === r.studentId);
                    return r.description.toLowerCase().includes(searchTerm) ||
                        student?.name.toLowerCase().includes(searchTerm) ||
                        (r.receiptCode || '').toLowerCase().includes(searchTerm);
                });
            }

            return filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
        }

        // ===== 2.10 Render t·ªïng h·ª£p bi√™n lai =====
        function renderReceiptSummary(filteredReceipts) {
            let totalIncome = 0;
            let totalExpense = 0;

            filteredReceipts.forEach(r => {
                const amount = parseFloat(r.amount) || 0;
                if (r.isRefund || r.type === 'Phi·∫øu Chi') {
                    totalExpense += amount;
                } else {
                    totalIncome += amount;
                }
            });

            const balance = totalIncome - totalExpense;

            document.getElementById('receiptTotalIncome').textContent = formatCurrencyShort(totalIncome);
            document.getElementById('receiptTotalExpense').textContent = formatCurrencyShort(totalExpense);
            document.getElementById('receiptBalance').textContent = formatCurrencyShort(balance);
            document.getElementById('receiptTotalCount').textContent = filteredReceipts.length;

            // ƒê·ªïi m√†u s·ªë d∆∞
            const balanceEl = document.getElementById('receiptBalance');
            balanceEl.style.color = balance >= 0 ? 'var(--btn-success)' : 'var(--btn-danger)';
        }

        // ===== 2.11 C·∫≠p nh·∫≠t render b·∫£ng bi√™n lai =====
        function renderReceiptsTable() {
            const filtered = getFilteredReceipts();

            // Render t·ªïng h·ª£p
            renderReceiptSummary(filtered);

            const { data, total, totalPages, currentPage } = getPaginatedData(filtered, 'receipts');
            const tbody = document.getElementById('receiptsTableBody');

            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7"><div class="empty-state"><div class="empty-state-icon">üßæ</div><p>Kh√¥ng c√≥ bi√™n lai</p></div></td></tr>`;
                renderPagination('receiptsPagination', 'receipts', 0, 0, 1);
                return;
            }

            tbody.innerHTML = data.map((r, idx) => {
                const student = students.find(s => s.id === r.studentId);
                const displayCode = r.receiptCode || `#${String(total - (currentPage - 1) * paginationState.receipts.pageSize - idx).padStart(4, '0')}`;
                const isRefund = r.isRefund || r.type === 'Phi·∫øu Chi';

                // Style kh√°c bi·ªát cho bi√™n lai chi
                const rowStyle = isRefund ? 'background: #FEF2F2;' : '';
                const amountClass = isRefund ? 'text-danger' : 'text-success';
                const amountPrefix = isRefund ? '-' : '+';

                // Badge lo·∫°i
                const typeBadge = isRefund
                    ? '<span class="status-badge cancel">üî¥ Phi·∫øu Chi</span>'
                    : r.type === 'Bi√™n Lai ƒêi·ªán T·ª≠'
                        ? '<span class="status-badge da-dk">üí≥ CK</span>'
                        : '<span class="status-badge hoc-thu">üíµ TM</span>';

                return `
                    <tr style="${rowStyle}">
                        <td><strong>${displayCode}</strong></td>
                        <td>${typeBadge}</td>
                        <td>${student?.name || 'N/A'}</td>
                        <td>${r.description}</td>
                        <td><strong class="${amountClass}">${amountPrefix}${formatCurrency(r.amount)}</strong></td>
                        <td>${formatDate(r.date)}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="action-btn view" onclick="viewReceipt('${r.id}')" title="Xem">üëÅÔ∏è</button>
                                ${canEdit('receipts') ? `<button class="action-btn edit" onclick="editReceipt('${r.id}')" title="S·ª≠a">‚úèÔ∏è</button>` : ''}
                                ${canDelete('receipts') ? `<button class="action-btn delete" onclick="deleteReceipt('${r.id}')" title="X√≥a">üóëÔ∏è</button>` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            renderPagination('receiptsPagination', 'receipts', total, totalPages, currentPage);
        }

        // ===== 2.12 Kh·ªüi t·∫°o filter m·∫∑c ƒë·ªãnh khi v√†o tab =====
        function initReceiptFilters() {
            // Set m·∫∑c ƒë·ªãnh l√† th√°ng n√†y
            const now = new Date();
            const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
            const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);

            document.getElementById('receiptFilterFromDate').value = firstDay.toISOString().split('T')[0];
            document.getElementById('receiptFilterToDate').value = lastDay.toISOString().split('T')[0];
            document.getElementById('receiptPeriodFilter').value = 'thisMonth';
            document.getElementById('receiptTypeFilter').value = 'all';

            receiptFilterState = {
                fromDate: firstDay.toISOString().split('T')[0],
                toDate: lastDay.toISOString().split('T')[0],
                type: 'all',
                period: 'thisMonth'
            };
        }

        console.log('üßæ Module Bi√™n lai (Thu/Chi + T·ªïng h·ª£p) ƒë√£ ƒë∆∞·ª£c t·∫£i!');
        /* ============================================================
        ‚úÖ MODULE 3: ƒêI·ªÇM DANH - S·ª¨A & TH·ªêNG K√ä
        ============================================================ */

        // ===== 3.1 Bi·∫øn l∆∞u tr·ªØ tr·∫°ng th√°i s·ª≠a ƒëi·ªÉm danh =====
        let editAttendanceMode = false;
        let editAttendanceData = {
            date: null,
            classId: null,
            scheduleId: null,
            originalRecords: [],
            changedRecords: []
        };

        let attendanceStatsState = {
            page: 1,
            pageSize: 10,
            classFilter: '',
            periodFilter: 'thisMonth',
            fromDate: null,
            toDate: null
        };

        // ===== 3.2 Xem chi ti·∫øt ƒëi·ªÉm danh - C·∫¨P NH·∫¨T c√≥ n√∫t s·ª≠a =====
        function viewAttendanceDetail(date, classId, scheduleId) {
            const cls = classes.find(c => c.id === classId);
            const schedule = classSchedules.find(s => s.id === scheduleId);
            const records = attendances.filter(a =>
                a.attendanceDate === date &&
                a.classId === classId &&
                a.scheduleId === scheduleId
            );

            // L∆∞u th√¥ng tin ƒë·ªÉ s·ª≠a
            editAttendanceData = {
                date,
                classId,
                scheduleId,
                originalRecords: JSON.parse(JSON.stringify(records)),
                changedRecords: []
            };
            editAttendanceMode = false;

            const content = `
                <div class="quick-view-section">
                    <h4>üìã Th√¥ng tin bu·ªïi h·ªçc</h4>
                    <div class="quick-view-row"><span class="quick-view-label">L·ªõp:</span><span class="quick-view-value"><strong>${cls ? cls.className : 'N/A'}</strong></span></div>
                    <div class="quick-view-row"><span class="quick-view-label">Ng√†y:</span><span class="quick-view-value">${formatDate(date)}</span></div>
                    <div class="quick-view-row"><span class="quick-view-label">Ca h·ªçc:</span><span class="quick-view-value">${schedule ? schedule.startTime + ' - ' + schedule.endTime : 'N/A'}</span></div>
                    <div class="quick-view-row"><span class="quick-view-label">Sƒ© s·ªë:</span><span class="quick-view-value">${records.length} h·ªçc vi√™n</span></div>
                </div>
                <div class="quick-view-section">
                    <h4>üìä Chi ti·∫øt ƒëi·ªÉm danh</h4>
                    <table style="width: 100%; font-size: 13px;" id="attendanceDetailTable">
                        <thead>
                            <tr>
                                <th style="width: 30%;">H·ªçc vi√™n</th>
                                <th style="width: 35%;">Tr·∫°ng th√°i</th>
                                <th style="width: 35%;">Ghi ch√∫</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${records.map(r => {
                const student = students.find(s => s.id === r.studentId);
                return `
                                    <tr data-attendance-id="${r.id}">
                                        <td><strong>${student ? student.name : 'N/A'}</strong></td>
                                        <td>
                                            <span class="attendance-status-display">${getAttendanceStatusBadge(r.status)}</span>
                                            <div class="attendance-status-edit d-none">
                                                <select class="edit-attendance-status" data-original="${r.status}" onchange="onAttendanceStatusSelectChange(this, '${r.id}')">
                                                    <option value="present" ${r.status === 'present' ? 'selected' : ''}>‚úÖ C√≥ m·∫∑t</option>
                                                    <option value="late" ${r.status === 'late' ? 'selected' : ''}>üü° Mu·ªôn</option>
                                                    <option value="absent" ${r.status === 'absent' ? 'selected' : ''}>‚ùå V·∫Øng KP</option>
                                                    <option value="excused" ${r.status === 'excused' ? 'selected' : ''}>üìù C√≥ ph√©p</option>
                                                </select>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="attendance-note-display">${r.notes || '<span class="text-muted">-</span>'}</span>
                                            <input type="text" class="attendance-note-edit d-none" value="${r.notes || ''}" placeholder="Ghi ch√∫..." style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
                                        </td>
                                    </tr>
                                `;
            }).join('')}
                        </tbody>
                    </table>
                </div>
                <div id="attendanceChangeWarning" class="d-none" style="background: #FEF5E7; padding: 12px; border-radius: 8px; margin-top: 15px; border-left: 4px solid #F39C12;">
                    <p style="margin: 0; font-size: 13px; color: #9A7B0A;">
                        <strong>‚ö†Ô∏è L∆∞u √Ω:</strong> Thay ƒë·ªïi tr·∫°ng th√°i ƒëi·ªÉm danh c√≥ th·ªÉ ·∫£nh h∆∞·ªüng ƒë·∫øn s·ªë bu·ªïi h·ªçc v√† y√™u c·∫ßu h·ªçc b√π.
                    </p>
                </div>
            `;

            document.getElementById('viewAttendanceContent').innerHTML = content;

            // Reset buttons
            document.getElementById('btnEditAttendanceBatch').classList.remove('d-none');
            document.getElementById('btnSaveAttendanceBatch').classList.add('d-none');
            document.getElementById('btnCancelEditAttendance').classList.add('d-none');
            document.getElementById('btnCloseAttendanceDetail').classList.remove('d-none');

            openModal('viewAttendanceModal');
        }

        // ===== 3.3 B·∫≠t ch·∫ø ƒë·ªô s·ª≠a ƒëi·ªÉm danh =====
        function enableEditAttendanceMode() {
            editAttendanceMode = true;
            editAttendanceData.changedRecords = [];

            // Hi·ªán c√°c input s·ª≠a, ·∫©n display
            document.querySelectorAll('.attendance-status-display').forEach(el => el.classList.add('d-none'));
            document.querySelectorAll('.attendance-status-edit').forEach(el => el.classList.remove('d-none'));
            document.querySelectorAll('.attendance-note-display').forEach(el => el.classList.add('d-none'));
            document.querySelectorAll('.attendance-note-edit').forEach(el => el.classList.remove('d-none'));

            // Hi·ªán c·∫£nh b√°o
            document.getElementById('attendanceChangeWarning').classList.remove('d-none');

            // ƒê·ªïi buttons
            document.getElementById('btnEditAttendanceBatch').classList.add('d-none');
            document.getElementById('btnSaveAttendanceBatch').classList.remove('d-none');
            document.getElementById('btnCancelEditAttendance').classList.remove('d-none');
            document.getElementById('btnCloseAttendanceDetail').classList.add('d-none');

            showNotification('ƒê√£ b·∫≠t ch·∫ø ƒë·ªô s·ª≠a. Ch·ªçn tr·∫°ng th√°i m·ªõi v√† nh·∫•n "L∆∞u thay ƒë·ªïi".', 'info');
        }

        // ===== 3.4 H·ªßy s·ª≠a ƒëi·ªÉm danh =====
        function cancelEditAttendance() {
            editAttendanceMode = false;
            editAttendanceData.changedRecords = [];

            // Load l·∫°i modal
            viewAttendanceDetail(
                editAttendanceData.date,
                editAttendanceData.classId,
                editAttendanceData.scheduleId
            );

            showNotification('ƒê√£ h·ªßy thay ƒë·ªïi.', 'info');
        }

        // ===== 3.5 X·ª≠ l√Ω khi thay ƒë·ªïi dropdown tr·∫°ng th√°i =====
        function onAttendanceStatusSelectChange(selectEl, attendanceId) {
            const newStatus = selectEl.value;
            const originalStatus = selectEl.dataset.original;

            // T√¨m xem ƒë√£ c√≥ trong changedRecords ch∆∞a
            const existingIndex = editAttendanceData.changedRecords.findIndex(r => r.id === attendanceId);

            if (newStatus === originalStatus) {
                // N·∫øu quay l·∫°i tr·∫°ng th√°i g·ªëc, x√≥a kh·ªèi changedRecords
                if (existingIndex !== -1) {
                    editAttendanceData.changedRecords.splice(existingIndex, 1);
                }
                selectEl.style.background = '';
            } else {
                // Th√™m ho·∫∑c c·∫≠p nh·∫≠t changedRecords
                const row = selectEl.closest('tr');
                const noteInput = row.querySelector('.attendance-note-edit');

                const changeRecord = {
                    id: attendanceId,
                    oldStatus: originalStatus,
                    newStatus: newStatus,
                    newNotes: noteInput ? noteInput.value : ''
                };

                if (existingIndex !== -1) {
                    editAttendanceData.changedRecords[existingIndex] = changeRecord;
                } else {
                    editAttendanceData.changedRecords.push(changeRecord);
                }

                // Highlight d√≤ng ƒë√£ thay ƒë·ªïi
                selectEl.style.background = '#FEF9E7';
            }
        }

        // ===== 3.6 L∆∞u thay ƒë·ªïi ƒëi·ªÉm danh =====
        function saveEditedAttendance() {
            // C·∫≠p nh·∫≠t notes cho t·∫•t c·∫£ c√°c d√≤ng (k·ªÉ c·∫£ kh√¥ng ƒë·ªïi status)
            const rows = document.querySelectorAll('#attendanceDetailTable tbody tr');
            rows.forEach(row => {
                const attendanceId = row.dataset.attendanceId;
                const noteInput = row.querySelector('.attendance-note-edit');
                const statusSelect = row.querySelector('.edit-attendance-status');

                if (!attendanceId) return;

                const newNotes = noteInput ? noteInput.value.trim() : '';
                const newStatus = statusSelect ? statusSelect.value : null;
                const originalStatus = statusSelect ? statusSelect.dataset.original : null;

                // C·∫≠p nh·∫≠t notes v√†o changedRecords n·∫øu ch∆∞a c√≥
                const existingIndex = editAttendanceData.changedRecords.findIndex(r => r.id === attendanceId);
                if (existingIndex !== -1) {
                    editAttendanceData.changedRecords[existingIndex].newNotes = newNotes;
                }
            });

            // N·∫øu kh√¥ng c√≥ thay ƒë·ªïi status n√†o
            if (editAttendanceData.changedRecords.length === 0) {
                // V·∫´n l∆∞u notes
                rows.forEach(row => {
                    const attendanceId = row.dataset.attendanceId;
                    const noteInput = row.querySelector('.attendance-note-edit');
                    if (attendanceId && noteInput) {
                        const att = attendances.find(a => a.id === attendanceId);
                        if (att) {
                            att.notes = noteInput.value.trim();
                        }
                    }
                });

                saveData('attendances', attendances);
                closeModal('viewAttendanceModal');
                loadAttendanceHistory();
                showNotification('ƒê√£ l∆∞u ghi ch√∫!', 'success');
                return;
            }

            // Ki·ªÉm tra c√≥ thay ƒë·ªïi ƒë·∫∑c bi·ªát kh√¥ng (c·∫ßn confirm)
            const specialChanges = editAttendanceData.changedRecords.filter(r => {
                const toExcused = r.newStatus === 'excused' && r.oldStatus !== 'excused';
                const fromExcused = r.oldStatus === 'excused' && r.newStatus !== 'excused';
                return toExcused || fromExcused;
            });

            if (specialChanges.length > 0) {
                // X·ª≠ l√Ω t·ª´ng thay ƒë·ªïi ƒë·∫∑c bi·ªát
                processSpecialAttendanceChanges(specialChanges, 0);
            } else {
                // Kh√¥ng c√≥ thay ƒë·ªïi ƒë·∫∑c bi·ªát, l∆∞u tr·ª±c ti·∫øp
                applyAttendanceChanges(editAttendanceData.changedRecords);
            }
        }

        // ===== 3.7 X·ª≠ l√Ω t·ª´ng thay ƒë·ªïi ƒë·∫∑c bi·ªát (c·∫ßn confirm) =====
        function processSpecialAttendanceChanges(changes, index) {
            if (index >= changes.length) {
                // ƒê√£ x·ª≠ l√Ω h·∫øt, l∆∞u t·∫•t c·∫£ thay ƒë·ªïi
                applyAttendanceChanges(editAttendanceData.changedRecords);
                return;
            }

            const change = changes[index];
            const attendance = attendances.find(a => a.id === change.id);
            const student = attendance ? students.find(s => s.id === attendance.studentId) : null;
            const studentName = student ? student.name : 'H·ªçc vi√™n';

            let title, content, btnText;

            if (change.newStatus === 'excused' && change.oldStatus !== 'excused') {
                // Chuy·ªÉn sang C√≥ ph√©p ‚Üí T·∫°o y√™u c·∫ßu h·ªçc b√π
                title = 'üìù T·∫°o y√™u c·∫ßu h·ªçc b√π?';
                content = `
                    <p>B·∫°n ƒëang chuy·ªÉn tr·∫°ng th√°i c·ªßa <strong>${studentName}</strong> t·ª´ <strong>${getStatusLabel(change.oldStatus)}</strong> sang <strong>C√≥ ph√©p</strong>.</p>
                    <div style="background: #E8F4FD; padding: 12px; border-radius: 8px; margin: 15px 0;">
                        <p style="margin: 0; font-size: 13px; color: #1A5276;">
                            ‚úÖ H·ªá th·ªëng s·∫Ω:<br>
                            ‚Ä¢ C·ªông l·∫°i 1 bu·ªïi h·ªçc (n·∫øu tr∆∞·ªõc ƒë√≥ ƒë√£ tr·ª´)<br>
                            ‚Ä¢ T·∫°o y√™u c·∫ßu h·ªçc b√π cho h·ªçc vi√™n
                        </p>
                    </div>
                    <p><strong>B·∫°n c√≥ mu·ªën ti·∫øp t·ª•c?</strong></p>
                `;
                btnText = '‚úÖ X√°c nh·∫≠n & T·∫°o h·ªçc b√π';
            } else if (change.oldStatus === 'excused' && change.newStatus !== 'excused') {
                // T·ª´ C√≥ ph√©p ‚Üí Tr·∫°ng th√°i kh√°c ‚Üí X√≥a y√™u c·∫ßu h·ªçc b√π
                title = '‚ö†Ô∏è X√≥a y√™u c·∫ßu h·ªçc b√π?';
                content = `
                    <p>B·∫°n ƒëang chuy·ªÉn tr·∫°ng th√°i c·ªßa <strong>${studentName}</strong> t·ª´ <strong>C√≥ ph√©p</strong> sang <strong>${getStatusLabel(change.newStatus)}</strong>.</p>
                    <div style="background: #FDEDEC; padding: 12px; border-radius: 8px; margin: 15px 0;">
                        <p style="margin: 0; font-size: 13px; color: #922B21;">
                            ‚ö†Ô∏è H·ªá th·ªëng s·∫Ω:<br>
                            ‚Ä¢ Tr·ª´ 1 bu·ªïi h·ªçc<br>
                            ‚Ä¢ <strong>X√ìA</strong> y√™u c·∫ßu h·ªçc b√π ƒë√£ t·∫°o (n·∫øu c√≥)
                        </p>
                    </div>
                    <p><strong>B·∫°n c√≥ mu·ªën ti·∫øp t·ª•c?</strong></p>
                `;
                btnText = '‚ö†Ô∏è X√°c nh·∫≠n & X√≥a h·ªçc b√π';
            }

            // L∆∞u th√¥ng tin ƒë·ªÉ x·ª≠ l√Ω sau khi confirm
            document.getElementById('confirmAttendanceId').value = change.id;
            document.getElementById('confirmAttendanceOldStatus').value = change.oldStatus;
            document.getElementById('confirmAttendanceNewStatus').value = change.newStatus;

            document.getElementById('confirmAttendanceChangeTitle').textContent = title;
            document.getElementById('confirmAttendanceChangeContent').innerHTML = content;
            document.getElementById('btnConfirmAttendanceChange').textContent = btnText;

            // L∆∞u index ƒë·ªÉ ti·∫øp t·ª•c x·ª≠ l√Ω
            document.getElementById('btnConfirmAttendanceChange').onclick = function () {
                closeModal('confirmAttendanceChangeModal');
                // ƒê√°nh d·∫•u change n√†y ƒë√£ ƒë∆∞·ª£c confirm
                change.confirmed = true;
                // X·ª≠ l√Ω ti·∫øp
                processSpecialAttendanceChanges(changes, index + 1);
            };

            openModal('confirmAttendanceChangeModal');
        }

        // ===== 3.8 Helper: L·∫•y label tr·∫°ng th√°i =====
        function getStatusLabel(status) {
            const labels = {
                'present': 'C√≥ m·∫∑t',
                'late': 'Mu·ªôn',
                'absent': 'V·∫Øng kh√¥ng ph√©p',
                'excused': 'C√≥ ph√©p'
            };
            return labels[status] || status;
        }

        // ===== 3.9 √Åp d·ª•ng t·∫•t c·∫£ thay ƒë·ªïi ƒëi·ªÉm danh =====
        function applyAttendanceChanges(changes) {
            let makeupCreated = 0;
            let makeupDeleted = 0;

            changes.forEach(change => {
                const attendance = attendances.find(a => a.id === change.id);
                if (!attendance) return;

                const oldStatus = change.oldStatus;
                const newStatus = change.newStatus;

                // C·∫≠p nh·∫≠t tr·∫°ng th√°i v√† ghi ch√∫
                attendance.status = newStatus;
                attendance.notes = change.newNotes || attendance.notes;
                attendance.updatedAt = new Date().toISOString();
                attendance.updatedBy = currentUser?.id || null;

                // X·ª≠ l√Ω logic s·ªë bu·ªïi v√† h·ªçc b√π
                const cs = classStudents.find(c => c.id === attendance.classStudentId);

                if (cs) {
                    // X√°c ƒë·ªãnh nh√≥m tr·∫°ng th√°i
                    const deductGroup = ['present', 'late', 'absent'];
                    const wasDeducted = deductGroup.includes(oldStatus);
                    const willDeduct = deductGroup.includes(newStatus);
                    const wasExcused = oldStatus === 'excused';
                    const willExcuse = newStatus === 'excused';

                    // CASE 1: T·ª´ tr·ª´ bu·ªïi ‚Üí C√≥ ph√©p (c·ªông l·∫°i 1 bu·ªïi, t·∫°o h·ªçc b√π)
                    if (wasDeducted && willExcuse) {
                        cs.completedSessions = Math.max(0, cs.completedSessions - 1);
                        cs.remainingSessions++;
                        if (cs.status === 'completed') cs.status = 'active';

                        // T·∫°o y√™u c·∫ßu h·ªçc b√π
                        createMakeupRequestForAttendance(attendance);
                        makeupCreated++;
                    }

                    // CASE 2: T·ª´ C√≥ ph√©p ‚Üí Tr·ª´ bu·ªïi (tr·ª´ 1 bu·ªïi, x√≥a h·ªçc b√π)
                    else if (wasExcused && willDeduct) {
                        cs.completedSessions++;
                        cs.remainingSessions = Math.max(0, cs.remainingSessions - 1);
                        if (cs.remainingSessions === 0) cs.status = 'completed';

                        // X√≥a y√™u c·∫ßu h·ªçc b√π li√™n quan
                        const deleted = deleteMakeupRequestForAttendance(attendance.id);
                        if (deleted) makeupDeleted++;
                    }

                    // CASE 3: Chuy·ªÉn trong c√πng nh√≥m (kh√¥ng thay ƒë·ªïi s·ªë bu·ªïi)
                    // Kh√¥ng c·∫ßn x·ª≠ l√Ω g√¨ th√™m
                }
            });

            // L∆∞u t·∫•t c·∫£
            saveData('attendances', attendances);
            saveData('classStudents', classStudents);
            saveData('makeupRequests', makeupRequests);

            // ƒê√≥ng modal v√† refresh
            closeModal('viewAttendanceModal');
            loadAttendanceHistory();
            loadTodaySchedules();

            // Th√¥ng b√°o k·∫øt qu·∫£
            let msg = `‚úÖ ƒê√£ l∆∞u ${changes.length} thay ƒë·ªïi ƒëi·ªÉm danh!`;
            if (makeupCreated > 0) msg += ` T·∫°o ${makeupCreated} y√™u c·∫ßu h·ªçc b√π.`;
            if (makeupDeleted > 0) msg += ` X√≥a ${makeupDeleted} y√™u c·∫ßu h·ªçc b√π.`;
            showNotification(msg, 'success');

            // Refresh tab h·ªçc b√π n·∫øu c·∫ßn
            if (makeupCreated > 0 || makeupDeleted > 0) {
                if (typeof renderMakeupRequests === 'function') {
                    renderMakeupRequests();
                }
            }
        }

        // ===== 3.10 T·∫°o y√™u c·∫ßu h·ªçc b√π t·ª´ ƒëi·ªÉm danh =====
        function createMakeupRequestForAttendance(attendance) {
            // Ki·ªÉm tra ƒë√£ c√≥ y√™u c·∫ßu ch∆∞a
            const existing = makeupRequests.find(m => m.originalAttendanceId === attendance.id);
            if (existing) {
                console.log('Y√™u c·∫ßu h·ªçc b√π ƒë√£ t·ªìn t·∫°i:', existing.id);
                return existing;
            }

            const cs = classStudents.find(c => c.id === attendance.classStudentId);
            if (!cs) return null;

            // T√≠nh ng√†y h·∫øt h·∫°n (30 ng√†y t·ª´ ng√†y ngh·ªâ)
            const expiryDate = new Date(attendance.attendanceDate);
            expiryDate.setDate(expiryDate.getDate() + 30);

            const newRequest = {
                id: generateId(),
                studentId: cs.studentId,
                classStudentId: attendance.classStudentId,
                originalAttendanceId: attendance.id,
                originalClassId: attendance.classId,
                originalScheduleId: attendance.scheduleId,
                originalDate: attendance.attendanceDate,
                requestDate: new Date().toISOString().split('T')[0],
                expiryDate: expiryDate.toISOString().split('T')[0],
                makeupClassId: null,
                makeupScheduleId: null,
                makeupDate: null,
                status: 'pending',
                approvedBy: null,
                approvedAt: null,
                completedAt: null,
                notes: 'T·∫°o t·ª´ s·ª≠a ƒëi·ªÉm danh',
                isPreCreated: false,
                createdAt: new Date().toISOString()
            };

            makeupRequests.push(newRequest);
            console.log('ƒê√£ t·∫°o y√™u c·∫ßu h·ªçc b√π:', newRequest.id);
            return newRequest;
        }

        // ===== 3.11 X√≥a y√™u c·∫ßu h·ªçc b√π theo attendanceId =====
        function deleteMakeupRequestForAttendance(attendanceId) {
            const index = makeupRequests.findIndex(m => m.originalAttendanceId === attendanceId);
            if (index !== -1) {
                const deleted = makeupRequests[index];
                makeupRequests.splice(index, 1);
                console.log('ƒê√£ x√≥a y√™u c·∫ßu h·ªçc b√π:', deleted.id);
                return true;
            }
            return false;
        }

        // ===== 3.12 Th·ªëng k√™ ƒëi·ªÉm danh theo h·ªçc vi√™n =====
        function loadAttendanceStatsByStudent() {
            const classFilter = document.getElementById('attendanceStatClassFilter')?.value || '';
            const tbody = document.getElementById('attendanceStatsByStudentBody');

            // T√≠nh to√°n kho·∫£ng th·ªùi gian
            const { fromDate, toDate } = getAttendanceStatDateRange();

            // L·ªçc ƒëi·ªÉm danh theo th·ªùi gian
            let filteredAttendances = attendances.filter(a => {
                if (fromDate && a.attendanceDate < fromDate) return false;
                if (toDate && a.attendanceDate > toDate) return false;
                return true;
            });

            // L·ªçc theo l·ªõp n·∫øu c√≥
            if (classFilter) {
                filteredAttendances = filteredAttendances.filter(a => a.classId === classFilter);
            }

            // Nh√≥m theo h·ªçc vi√™n + l·ªõp
            const statsMap = {};

            filteredAttendances.forEach(a => {
                const key = `${a.studentId}_${a.classId}`;
                if (!statsMap[key]) {
                    statsMap[key] = {
                        studentId: a.studentId,
                        classId: a.classId,
                        total: 0,
                        present: 0,
                        late: 0,
                        absent: 0,
                        excused: 0
                    };
                }

                statsMap[key].total++;
                if (a.status === 'present') statsMap[key].present++;
                else if (a.status === 'late') statsMap[key].late++;
                else if (a.status === 'absent') statsMap[key].absent++;
                else if (a.status === 'excused') statsMap[key].excused++;
            });

            const statsList = Object.values(statsMap);

            if (statsList.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">Kh√¥ng c√≥ d·ªØ li·ªáu ƒëi·ªÉm danh trong kho·∫£ng th·ªùi gian n√†y</td></tr>';
                document.getElementById('attendanceStatsPagination').innerHTML = '';
                return;
            }

            // S·∫Øp x·∫øp theo t√™n h·ªçc vi√™n
            statsList.sort((a, b) => {
                const studentA = students.find(s => s.id === a.studentId);
                const studentB = students.find(s => s.id === b.studentId);
                return (studentA?.name || '').localeCompare(studentB?.name || '');
            });

            // Ph√¢n trang
            const pageSize = attendanceStatsState.pageSize;
            const currentPage = attendanceStatsState.page;
            const total = statsList.length;
            const totalPages = Math.ceil(total / pageSize);
            const startIndex = (currentPage - 1) * pageSize;
            const pageData = statsList.slice(startIndex, startIndex + pageSize);

            tbody.innerHTML = pageData.map(stat => {
                const student = students.find(s => s.id === stat.studentId);
                const cls = classes.find(c => c.id === stat.classId);
                const attendanceRate = stat.total > 0
                    ? Math.round(((stat.present + stat.late) / stat.total) * 100)
                    : 0;

                const rateClass = attendanceRate >= 80 ? 'text-success' : attendanceRate >= 60 ? 'text-warning' : 'text-danger';

                return `
                    <tr>
                        <td><strong>${student ? student.name : 'N/A'}</strong></td>
                        <td>${cls ? cls.className : 'N/A'}</td>
                        <td>${stat.total}</td>
                        <td class="text-success">${stat.present}</td>
                        <td class="text-warning">${stat.late}</td>
                        <td class="text-danger">${stat.absent}</td>
                        <td class="text-primary">${stat.excused}</td>
                        <td><strong class="${rateClass}">${attendanceRate}%</strong></td>
                        <td>
                            <button class="action-btn view" onclick="viewStudentAttendanceDetail('${stat.studentId}', '${stat.classId}')" title="Xem chi ti·∫øt">üëÅÔ∏è</button>
                        </td>
                    </tr>
                `;
            }).join('');

            // Render ph√¢n trang
            renderAttendanceStatsPagination(total, totalPages, currentPage);
        }

        // ===== 3.13 L·∫•y kho·∫£ng th·ªùi gian th·ªëng k√™ =====
        function getAttendanceStatDateRange() {
            const period = document.getElementById('attendanceStatPeriodFilter')?.value || 'thisMonth';
            const now = new Date();
            let fromDate, toDate;

            switch (period) {
                case 'thisMonth':
                    fromDate = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
                    toDate = new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString().split('T')[0];
                    break;
                case 'lastMonth':
                    fromDate = new Date(now.getFullYear(), now.getMonth() - 1, 1).toISOString().split('T')[0];
                    toDate = new Date(now.getFullYear(), now.getMonth(), 0).toISOString().split('T')[0];
                    break;
                case 'thisQuarter':
                    const quarter = Math.floor(now.getMonth() / 3);
                    fromDate = new Date(now.getFullYear(), quarter * 3, 1).toISOString().split('T')[0];
                    toDate = new Date(now.getFullYear(), quarter * 3 + 3, 0).toISOString().split('T')[0];
                    break;
                case 'all':
                    fromDate = null;
                    toDate = null;
                    break;
            }

            return { fromDate, toDate };
        }

        function onAttendanceStatPeriodChange() {
            attendanceStatsState.page = 1;
            loadAttendanceStatsByStudent();
        }

        // ===== 3.14 Ph√¢n trang th·ªëng k√™ =====
        function renderAttendanceStatsPagination(total, totalPages, currentPage) {
            const container = document.getElementById('attendanceStatsPagination');
            if (!container) return;

            const pageSize = attendanceStatsState.pageSize;
            const startItem = total === 0 ? 0 : (currentPage - 1) * pageSize + 1;
            const endItem = Math.min(currentPage * pageSize, total);

            let html = `<button ${currentPage <= 1 ? 'disabled' : ''} onclick="changeAttendanceStatsPage(${currentPage - 1})">‚Äπ</button>`;

            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                    html += `<button class="${i === currentPage ? 'active' : ''}" onclick="changeAttendanceStatsPage(${i})">${i}</button>`;
                } else if (i === currentPage - 2 || i === currentPage + 2) {
                    html += `<button disabled>...</button>`;
                }
            }

            html += `<button ${currentPage >= totalPages ? 'disabled' : ''} onclick="changeAttendanceStatsPage(${currentPage + 1})">‚Ä∫</button>`;

            container.innerHTML = `
                <div class="pagination-info">Hi·ªÉn th·ªã ${startItem}-${endItem} / ${total}</div>
                <div class="pagination">${html}</div>
            `;
        }

        function changeAttendanceStatsPage(page) {
            attendanceStatsState.page = page;
            loadAttendanceStatsByStudent();
        }

        // ===== 3.15 Xem chi ti·∫øt ƒëi·ªÉm danh c·ªßa 1 h·ªçc vi√™n trong 1 l·ªõp =====
        function viewStudentAttendanceDetail(studentId, classId) {
            const student = students.find(s => s.id === studentId);
            const cls = classes.find(c => c.id === classId);
            const { fromDate, toDate } = getAttendanceStatDateRange();

            // L·ªçc ƒëi·ªÉm danh c·ªßa h·ªçc vi√™n n√†y trong l·ªõp n√†y
            let studentAttendances = attendances.filter(a =>
                a.studentId === studentId &&
                a.classId === classId
            );

            if (fromDate) {
                studentAttendances = studentAttendances.filter(a => a.attendanceDate >= fromDate);
            }
            if (toDate) {
                studentAttendances = studentAttendances.filter(a => a.attendanceDate <= toDate);
            }

            // S·∫Øp x·∫øp theo ng√†y m·ªõi nh·∫•t
            studentAttendances.sort((a, b) => new Date(b.attendanceDate) - new Date(a.attendanceDate));

            const content = `
                <div class="quick-view-section">
                    <h4>üë§ Th√¥ng tin</h4>
                    <div class="quick-view-row"><span class="quick-view-label">H·ªçc vi√™n:</span><span class="quick-view-value"><strong>${student ? student.name : 'N/A'}</strong></span></div>
                    <div class="quick-view-row"><span class="quick-view-label">L·ªõp:</span><span class="quick-view-value">${cls ? cls.className : 'N/A'}</span></div>
                    <div class="quick-view-row"><span class="quick-view-label">Kho·∫£ng th·ªùi gian:</span><span class="quick-view-value">${fromDate ? formatDate(fromDate) : 'ƒê·∫ßu'} - ${toDate ? formatDate(toDate) : 'Nay'}</span></div>
                </div>
                <div class="quick-view-section">
                    <h4>üìã Chi ti·∫øt ${studentAttendances.length} bu·ªïi</h4>
                    <div style="max-height: 400px; overflow-y: auto;">
                        <table style="width: 100%; font-size: 13px;">
                            <thead>
                                <tr><th>Ng√†y</th><th>Ca h·ªçc</th><th>Tr·∫°ng th√°i</th><th>Ghi ch√∫</th></tr>
                            </thead>
                            <tbody>
                                ${studentAttendances.map(a => {
                const schedule = classSchedules.find(s => s.id === a.scheduleId);
                return `
                                        <tr>
                                            <td>${formatDate(a.attendanceDate)}</td>
                                            <td>${schedule ? schedule.startTime + '-' + schedule.endTime : '-'}</td>
                                            <td>${getAttendanceStatusBadge(a.status)}</td>
                                            <td>${a.notes || '-'}</td>
                                        </tr>
                                    `;
            }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            document.getElementById('viewAttendanceContent').innerHTML = content;

            // ·∫®n c√°c n√∫t s·ª≠a
            document.getElementById('btnEditAttendanceBatch').classList.add('d-none');
            document.getElementById('btnSaveAttendanceBatch').classList.add('d-none');
            document.getElementById('btnCancelEditAttendance').classList.add('d-none');
            document.getElementById('btnCloseAttendanceDetail').classList.remove('d-none');

            openModal('viewAttendanceModal');
        }

        // ===== 3.16 Populate dropdown l·ªõp cho filter th·ªëng k√™ =====
        function populateAttendanceStatClassFilter() {
            const select = document.getElementById('attendanceStatClassFilter');
            if (!select) return;

            const activeClasses = classes.filter(c => c.status === 'active' || c.status === 'new');
            select.innerHTML = '<option value="">T·∫•t c·∫£ l·ªõp</option>' +
                activeClasses.map(c => {
                    const subject = subjects.find(s => s.id === c.subjectId);
                    return `<option value="${c.id}">${c.className}${subject ? ' - ' + subject.name : ''}</option>`;
                }).join('');
        }

        // ===== 3.17 Export th·ªëng k√™ ƒëi·ªÉm danh theo h·ªçc vi√™n =====
        function exportAttendanceStatsByStudent() {
            const classFilter = document.getElementById('attendanceStatClassFilter')?.value || '';
            const { fromDate, toDate } = getAttendanceStatDateRange();

            let filteredAttendances = attendances.filter(a => {
                if (fromDate && a.attendanceDate < fromDate) return false;
                if (toDate && a.attendanceDate > toDate) return false;
                if (classFilter && a.classId !== classFilter) return false;
                return true;
            });

            // Nh√≥m theo h·ªçc vi√™n + l·ªõp
            const statsMap = {};
            filteredAttendances.forEach(a => {
                const key = `${a.studentId}_${a.classId}`;
                if (!statsMap[key]) {
                    statsMap[key] = {
                        studentId: a.studentId,
                        classId: a.classId,
                        total: 0,
                        present: 0,
                        late: 0,
                        absent: 0,
                        excused: 0
                    };
                }
                statsMap[key].total++;
                if (a.status === 'present') statsMap[key].present++;
                else if (a.status === 'late') statsMap[key].late++;
                else if (a.status === 'absent') statsMap[key].absent++;
                else if (a.status === 'excused') statsMap[key].excused++;
            });

            const data = Object.values(statsMap).map(stat => {
                const student = students.find(s => s.id === stat.studentId);
                const cls = classes.find(c => c.id === stat.classId);
                const rate = stat.total > 0 ? Math.round(((stat.present + stat.late) / stat.total) * 100) : 0;

                return {
                    'H·ªçc vi√™n': student ? student.name : '',
                    'L·ªõp': cls ? cls.className : '',
                    'T·ªïng bu·ªïi': stat.total,
                    'C√≥ m·∫∑t': stat.present,
                    'Mu·ªôn': stat.late,
                    'V·∫Øng KP': stat.absent,
                    'C√≥ ph√©p': stat.excused,
                    'T·ª∑ l·ªá CM (%)': rate
                };
            });

            if (data.length === 0) {
                showNotification('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t!', 'warning');
                return;
            }

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data), 'Th·ªëng k√™ ƒëi·ªÉm danh');
            XLSX.writeFile(wb, `ThongKeDiemDanh_${formatDateFile()}.xlsx`);
            showNotification('Xu·∫•t Excel th√†nh c√¥ng!', 'success');
        }

        // ===== 3.18 C·∫≠p nh·∫≠t initAttendanceTab ƒë·ªÉ load th·ªëng k√™ =====
        const originalInitAttendanceTab = typeof initAttendanceTab === 'function' ? initAttendanceTab : null;

        function initAttendanceTab() {
            // Set ng√†y m·∫∑c ƒë·ªãnh l√† h√¥m nay
            document.getElementById('attendanceDate').value = new Date().toISOString().split('T')[0];

            // Populate dropdown l·ªõp h·ªçc
            populateAttendanceClassDropdown();

            // Load l·ªãch h·ªçc h√¥m nay
            loadTodaySchedules();

            // Load l·ªãch s·ª≠ ƒëi·ªÉm danh
            loadAttendanceHistory();

            // Populate filter cho th·ªëng k√™
            populateAttendanceStatClassFilter();

            // Load th·ªëng k√™ theo h·ªçc vi√™n
            loadAttendanceStatsByStudent();
        }

        console.log('‚úÖ Module ƒêi·ªÉm danh (S·ª≠a & Th·ªëng k√™) ƒë√£ ƒë∆∞·ª£c t·∫£i!');

        console.log('üì¶ Profile 001 - Code loaded successfully!');
    </script>
</body>

</html>
