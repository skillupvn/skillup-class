/**
 * Application JavaScript
 * Generated by HTML Splitter Pro v3.0
 * Note: Original code structure preserved for compatibility
 */

/* ============================================================
           ğŸ“Š PHáº¦N 1: DATA & CONFIG
           ============================================================ */

        // ===== 1.1 Cáº¥u hÃ¬nh há»‡ thá»‘ng =====
        const CONFIG = {
            APP_NAME: 'Quáº£n LÃ½ Trung TÃ¢m',
            VERSION: '4.0',
            SESSION_TIMEOUT: 480, // phÃºt (8 giá»)
            MAX_LOGIN_ATTEMPTS: 5,
            LOCKOUT_DURATION: 15, // phÃºt
            PAGE_SIZE_OPTIONS: [10, 20, 50, 100],
            DEFAULT_PAGE_SIZE: 10
        };

        // ===== 1.1.1 Cáº¥u hÃ¬nh báº£o máº­t =====
        const SECURITY_CONFIG = {
            // Secret key Ä‘á»ƒ mÃ£ hÃ³a dá»¯ liá»‡u users (AES-256)
            // LÆ°u Ã½: Trong mÃ´i trÆ°á»ng production thá»±c táº¿, key nÃ y nÃªn Ä‘Æ°á»£c báº£o vá»‡ tá»‘t hÆ¡n
            SECRET_KEY: 'FZ_PROFILE001_SECRET_2025_!@#$%^&*()',

            // Tiá»n tá»‘ Ä‘á»ƒ nháº­n biáº¿t hash má»›i (SHA-256)
            NEW_HASH_PREFIX: 'sha256_',

            // Tiá»n tá»‘ hash cÅ© (Ä‘á»ƒ phÃ¡t hiá»‡n vÃ  yÃªu cáº§u Ä‘á»•i password)
            OLD_HASH_PREFIX: 'fz_',

            // Äá»™ dÃ i salt
            SALT_LENGTH: 32,

            // Key Ä‘á»ƒ lÆ°u tráº¡ng thÃ¡i "cáº§n Ä‘á»•i máº­t kháº©u"
            FORCE_CHANGE_PASSWORD_KEY: 'forceChangePassword'
        };

        // ===== 1.2 Cáº¥u trÃºc menu vá»›i quyá»n =====
        const MENU_STRUCTURE = [
            { id: 'dashboard', icon: 'ğŸ“Š', text: 'Tá»•ng quan', parent: null },
            { id: 'students-group', icon: 'ğŸ‘¥', text: 'Quáº£n lÃ½ Há»c viÃªn', parent: null, isGroup: true },
            { id: 'students', icon: 'ğŸ‘©â€ğŸ“', text: 'Danh sÃ¡ch HV', parent: 'students-group' },
            { id: 'trial', icon: 'ğŸ“', text: 'Há»c thá»­', parent: 'students-group' },
            { id: 'appointments', icon: 'ğŸ“…', text: 'Lá»‹ch háº¹n', parent: 'students-group' },
            { id: 'finance-group', icon: 'ğŸ’°', text: 'TÃ i chÃ­nh', parent: null, isGroup: true },
            { id: 'registrations', icon: 'ğŸ“‹', text: 'Phiáº¿u Ä‘Äƒng kÃ½', parent: 'finance-group' },
            { id: 'receipts', icon: 'ğŸ§¾', text: 'BiÃªn lai', parent: 'finance-group' },
            { id: 'debts', icon: 'ğŸ’³', text: 'CÃ´ng ná»£', parent: 'finance-group' },
            { id: 'training-group', icon: 'ğŸ«', text: 'ÄÃ o táº¡o', parent: null, isGroup: true },
            { id: 'teachers', icon: 'ğŸ‘¨â€ğŸ«', text: 'GiÃ¡o viÃªn', parent: 'training-group' },
            { id: 'classes', icon: 'ğŸ“š', text: 'Lá»›p há»c', parent: 'training-group' },
            { id: 'makeup', icon: 'ğŸ“', text: 'Há»c bÃ¹', parent: 'training-group' },
            { id: 'attendance', icon: 'âœ…', text: 'Äiá»ƒm danh', parent: 'training-group' },
            { id: 'category-group', icon: 'ğŸ“', text: 'Danh má»¥c', parent: null, isGroup: true },
            { id: 'subjects', icon: 'ğŸ“–', text: 'MÃ´n há»c', parent: 'category-group' },
            { id: 'packages', icon: 'ğŸ“¦', text: 'GÃ³i há»c phÃ­', parent: 'category-group' },
            { id: 'promotions', icon: 'ğŸ', text: 'Khuyáº¿n mÃ£i', parent: 'category-group' },
            { id: 'rooms', icon: 'ğŸ«', text: 'PhÃ²ng há»c', parent: 'category-group' },
            { id: 'reports', icon: 'ğŸ“ˆ', text: 'BÃ¡o cÃ¡o', parent: null },
            { id: 'system-group', icon: 'âš™ï¸', text: 'Há»‡ thá»‘ng', parent: null, isGroup: true },
            { id: 'export', icon: 'ğŸ“¤', text: 'Xuáº¥t/Nháº­p data', parent: 'system-group' },
            { id: 'users', icon: 'ğŸ”', text: 'TÃ i khoáº£n', parent: 'system-group' },
            { id: 'settings', icon: 'âš™ï¸', text: 'CÃ i Ä‘áº·t', parent: 'system-group' }
        ];

        // ===== 1.3 Quyá»n máº·c Ä‘á»‹nh cho tá»«ng vai trÃ² =====
        const DEFAULT_PERMISSIONS = {
            admin: {
                dashboard: { view: true, create: true, edit: true, delete: true },
                students: { view: true, create: true, edit: true, delete: true },
                trial: { view: true, create: true, edit: true, delete: true },
                appointments: { view: true, create: true, edit: true, delete: true },
                registrations: { view: true, create: true, edit: true, delete: true },
                receipts: { view: true, create: true, edit: true, delete: true },
                debts: { view: true, create: true, edit: true, delete: true },
                teachers: { view: true, create: true, edit: true, delete: true },
                classes: { view: true, create: true, edit: true, delete: true },
                attendance: { view: true, create: true, edit: true, delete: true },
                makeup: { view: true, create: true, edit: true, delete: true },
                subjects: { view: true, create: true, edit: true, delete: true },
                packages: { view: true, create: true, edit: true, delete: true },
                promotions: { view: true, create: true, edit: true, delete: true },
                rooms: { view: true, create: true, edit: true, delete: true },
                reports: { view: true, create: true, edit: true, delete: true },
                export: { view: true, create: true, edit: true, delete: true },
                users: { view: true, create: true, edit: true, delete: true },
                settings: { view: true, create: true, edit: true, delete: true }
            },
            manager: {
                dashboard: { view: true, create: false, edit: false, delete: false },
                students: { view: true, create: true, edit: true, delete: false },
                trial: { view: true, create: true, edit: true, delete: false },
                appointments: { view: true, create: true, edit: true, delete: true },
                registrations: { view: true, create: true, edit: true, delete: false },
                receipts: { view: true, create: true, edit: true, delete: false },
                debts: { view: true, create: false, edit: false, delete: false },
                teachers: { view: true, create: false, edit: false, delete: false },
                classes: { view: true, create: false, edit: false, delete: false },
                attendance: { view: true, create: true, edit: true, delete: false },
                makeup: { view: true, create: true, edit: true, delete: true },
                subjects: { view: true, create: false, edit: false, delete: false },
                packages: { view: true, create: false, edit: false, delete: false },
                promotions: { view: true, create: false, edit: false, delete: false },
                rooms: { view: true, create: false, edit: false, delete: false },
                reports: { view: true, create: false, edit: false, delete: false },
                export: { view: true, create: true, edit: false, delete: false },
                users: { view: false, create: false, edit: false, delete: false },
                settings: { view: false, create: false, edit: false, delete: false }
            },
            user: {
                dashboard: { view: true, create: false, edit: false, delete: false },
                students: { view: true, create: false, edit: false, delete: false },
                trial: { view: true, create: false, edit: false, delete: false },
                appointments: { view: true, create: false, edit: false, delete: false },
                registrations: { view: true, create: false, edit: false, delete: false },
                receipts: { view: true, create: false, edit: false, delete: false },
                debts: { view: true, create: false, edit: false, delete: false },
                teachers: { view: true, create: false, edit: false, delete: false },
                classes: { view: true, create: false, edit: false, delete: false },
                attendance: { view: true, create: false, edit: false, delete: false },
                makeup: { view: true, create: true, edit: true, delete: true },
                subjects: { view: true, create: false, edit: false, delete: false },
                packages: { view: true, create: false, edit: false, delete: false },
                promotions: { view: true, create: false, edit: false, delete: false },
                rooms: { view: true, create: false, edit: false, delete: false },
                reports: { view: true, create: false, edit: false, delete: false },
                export: { view: false, create: false, edit: false, delete: false },
                users: { view: false, create: false, edit: false, delete: false },
                settings: { view: false, create: false, edit: false, delete: false }
            }
        };

        // ===== 1.4 TÃ i khoáº£n máº·c Ä‘á»‹nh =====
        // ÄÃ£ chuyá»ƒn sang khá»Ÿi táº¡o trong hÃ m initializeDefaultUsers() vá»›i mÃ£ hÃ³a SHA-256
        // Xem PHáº¦N 2: AUTHENTICATION
        // ===== 1.5 Khá»Ÿi táº¡o dá»¯ liá»‡u tá»« LocalStorage =====
        // Users sáº½ Ä‘Æ°á»£c load trong initializeDefaultUsers() vá»›i mÃ£ hÃ³a
        let users = []; // Khá»Ÿi táº¡o rá»—ng, sáº½ load sau

        let permissions = JSON.parse(localStorage.getItem('permissions')) || {};
        let currentUser = JSON.parse(localStorage.getItem('currentUser')) || null;
        let loginAttempts = JSON.parse(localStorage.getItem('loginAttempts')) || {};

        let students = JSON.parse(localStorage.getItem('students')) || [];
        let appointments = JSON.parse(localStorage.getItem('appointments')) || [];
        let receipts = JSON.parse(localStorage.getItem('receipts')) || [];
        let registrations = JSON.parse(localStorage.getItem('registrations')) || [];
        let subjects = JSON.parse(localStorage.getItem('subjects')) || [
            { id: '1', icon: 'â™Ÿï¸', name: 'Cá» Vua', defaultFee: 2000000 },
            { id: '2', icon: 'ğŸ¨', name: 'Váº½ Tranh', defaultFee: 1800000 },
            { id: '3', icon: 'ğŸ“š', name: 'Tiá»n Tiá»ƒu Há»c', defaultFee: 1500000 },
            { id: '4', icon: 'âœï¸', name: 'RÃ¨n Chá»¯', defaultFee: 1600000 }
        ];
        let packages = JSON.parse(localStorage.getItem('packages')) || [];
        let promotions = JSON.parse(localStorage.getItem('promotions')) || [];
        let centerInfo = JSON.parse(localStorage.getItem('centerInfo')) || {};
        let bankInfo = JSON.parse(localStorage.getItem('bankInfo')) || {};
        let backupHistory = JSON.parse(localStorage.getItem('backupHistory')) || [];
        let teachers = JSON.parse(localStorage.getItem('teachers')) || [];
        let classes = JSON.parse(localStorage.getItem('classes')) || [];
        let classSchedules = JSON.parse(localStorage.getItem('classSchedules')) || [];
        let classStudents = JSON.parse(localStorage.getItem('classStudents')) || [];
        let attendances = JSON.parse(localStorage.getItem('attendances')) || [];
        let makeupRequests = JSON.parse(localStorage.getItem('makeupRequests')) || [];
        let rooms = JSON.parse(localStorage.getItem('rooms')) || [];
        let warningSettings = JSON.parse(localStorage.getItem('warningSettings')) || {
            threshold1: 5,  // Cáº£nh bÃ¡o nháº¹
            threshold2: 3,  // Cáº£nh bÃ¡o trung bÃ¬nh
            threshold3: 1,  // Cáº£nh bÃ¡o cao
            showOnDashboard: true
        };

        let autoBackupEnabled = localStorage.getItem('autoBackupEnabled') === 'true';

        // ===== 1.6 State quáº£n lÃ½ =====
        let paginationState = {
            students: { page: 1, pageSize: 10 },
            trial: { page: 1, pageSize: 10 },
            appointments: { page: 1, pageSize: 10 },
            registrations: { page: 1, pageSize: 10 },
            receipts: { page: 1, pageSize: 10 },
            teachers: { page: 1, pageSize: 10 },
            classes: { page: 1, pageSize: 10 },
            makeup: { page: 1, pageSize: 10 },
            attendanceHistory: { page: 1, pageSize: 10 },
            debts: { page: 1, pageSize: 10 }  // THÃŠM Má»šI
        };


        let currentFilter = 'all';
        let currentTrialFilter = 'all';
        let currentAppointmentFilter = 'all';

        /* ============================================================
        ğŸ” PHáº¦N 2: AUTHENTICATION (XÃ¡c thá»±c) - PHIÃŠN Báº¢N Báº¢O Máº¬T
        ============================================================ */

        // ===== 2.1 Táº¡o Salt ngáº«u nhiÃªn =====
        function generateSalt(length = SECURITY_CONFIG.SALT_LENGTH) {
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*';
            let salt = '';
            for (let i = 0; i < length; i++) {
                salt += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            return salt;
        }

        // ===== 2.2 Hash password vá»›i SHA-256 + Salt =====
        function hashPasswordSecure(password, salt) {
            // Káº¿t há»£p password + salt
            const combined = password + salt;
            // Hash báº±ng SHA-256
            const hash = CryptoJS.SHA256(combined).toString();
            // Tráº£ vá» vá»›i prefix Ä‘á»ƒ nháº­n biáº¿t
            return SECURITY_CONFIG.NEW_HASH_PREFIX + hash;
        }

        // ===== 2.3 Kiá»ƒm tra password (há»— trá»£ cáº£ hash cÅ© vÃ  má»›i) =====
        function verifyPassword(password, storedHash, salt = null) {
            // Kiá»ƒm tra hash má»›i (SHA-256)
            if (storedHash && storedHash.startsWith(SECURITY_CONFIG.NEW_HASH_PREFIX)) {
                if (!salt) return false;
                const newHash = hashPasswordSecure(password, salt);
                return newHash === storedHash;
            }

            // Kiá»ƒm tra hash cÅ© (tÆ°Æ¡ng thÃ­ch ngÆ°á»£c)
            if (storedHash && storedHash.startsWith(SECURITY_CONFIG.OLD_HASH_PREFIX)) {
                const oldHash = hashPasswordOld(password);
                return oldHash === storedHash;
            }

            return false;
        }

        // ===== 2.3.1 Hash password cÅ© (giá»¯ láº¡i Ä‘á»ƒ tÆ°Æ¡ng thÃ­ch) =====
        function hashPasswordOld(password) {
            let hash = 0;
            const str = password + 'fz_salt_2025';
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return 'fz_' + Math.abs(hash).toString(16);
        }

        // ===== 2.3.2 Kiá»ƒm tra password cÃ³ pháº£i hash cÅ© khÃ´ng =====
        function isOldPasswordHash(hash) {
            return hash && hash.startsWith(SECURITY_CONFIG.OLD_HASH_PREFIX);
        }

        // ===== 2.4 MÃ£ hÃ³a dá»¯ liá»‡u (AES-256) =====
        function encryptData(data) {
            try {
                const jsonString = JSON.stringify(data);
                const encrypted = CryptoJS.AES.encrypt(jsonString, SECURITY_CONFIG.SECRET_KEY).toString();
                return encrypted;
            } catch (error) {
                console.error('Lá»—i mÃ£ hÃ³a dá»¯ liá»‡u:', error);
                return null;
            }
        }

        // ===== 2.5 Giáº£i mÃ£ dá»¯ liá»‡u (AES-256) =====
        function decryptData(encryptedData) {
            try {
                const bytes = CryptoJS.AES.decrypt(encryptedData, SECURITY_CONFIG.SECRET_KEY);
                const decryptedString = bytes.toString(CryptoJS.enc.Utf8);
                if (!decryptedString) {
                    return null;
                }
                return JSON.parse(decryptedString);
            } catch (error) {
                console.error('Lá»—i giáº£i mÃ£ dá»¯ liá»‡u:', error);
                return null;
            }
        }

        // ===== 2.6 LÆ°u users vá»›i mÃ£ hÃ³a =====
        function saveUsersEncrypted(usersData) {
            const encrypted = encryptData(usersData);
            if (encrypted) {
                localStorage.setItem('users_encrypted', encrypted);
                // XÃ³a dá»¯ liá»‡u users cÅ© (plain text) náº¿u cÃ³
                localStorage.removeItem('users');
            }
        }

        // ===== 2.7 Äá»c users Ä‘Ã£ mÃ£ hÃ³a =====
        function loadUsersEncrypted() {
            // Thá»­ Ä‘á»c dá»¯ liá»‡u mÃ£ hÃ³a trÆ°á»›c
            const encrypted = localStorage.getItem('users_encrypted');
            if (encrypted) {
                const decrypted = decryptData(encrypted);
                if (decrypted) {
                    return decrypted;
                }
            }

            // Fallback: Ä‘á»c dá»¯ liá»‡u cÅ© (plain text) náº¿u cÃ³
            const oldData = localStorage.getItem('users');
            if (oldData) {
                try {
                    const users = JSON.parse(oldData);
                    // Migrate: lÆ°u láº¡i dáº¡ng mÃ£ hÃ³a
                    saveUsersEncrypted(users);
                    // XÃ³a dá»¯ liá»‡u cÅ©
                    localStorage.removeItem('users');
                    console.log('âœ… ÄÃ£ migrate users tá»« plain text sang encrypted');
                    return users;
                } catch (e) {
                    console.error('Lá»—i Ä‘á»c users cÅ©:', e);
                }
            }

            return [];
        }

        // ===== 2.8 Khá»Ÿi táº¡o users máº·c Ä‘á»‹nh (Cáº¬P NHáº¬T) =====
        function initializeDefaultUsers() {
            // Äá»c users Ä‘Ã£ mÃ£ hÃ³a
            users = loadUsersEncrypted();

            if (users.length === 0) {
                // Táº¡o users máº·c Ä‘á»‹nh vá»›i hash má»›i
                const defaultUsers = [
                    { username: 'admin', password: 'admin123', fullName: 'Quáº£n trá»‹ viÃªn', role: 'admin' },
                    { username: 'manager', password: 'manager123', fullName: 'Quáº£n lÃ½', role: 'manager' },
                    { username: 'user', password: 'user123', fullName: 'NhÃ¢n viÃªn', role: 'user' }
                ];

                users = defaultUsers.map((u, index) => {
                    const salt = generateSalt();
                    return {
                        id: 'user_' + u.role,
                        username: u.username,
                        passwordHash: hashPasswordSecure(u.password, salt),
                        salt: salt, // LÆ°u salt riÃªng cho má»—i user
                        fullName: u.fullName,
                        role: u.role,
                        status: 'active',
                        createdAt: new Date().toISOString(),
                        lastLogin: null,
                        mustChangePassword: false // User má»›i khÃ´ng cáº§n Ä‘á»•i
                    };
                });

                saveUsersEncrypted(users);
                console.log('âœ… ÄÃ£ táº¡o users máº·c Ä‘á»‹nh vá»›i mÃ£ hÃ³a SHA-256');
            }

            // Khá»Ÿi táº¡o permissions náº¿u chÆ°a cÃ³
            if (Object.keys(permissions).length === 0) {
                permissions = JSON.parse(JSON.stringify(DEFAULT_PERMISSIONS));
                saveData('permissions', permissions);
            }
        }


        // ===== 2.4 Kiá»ƒm tra khÃ³a tÃ i khoáº£n =====
        function isAccountLocked(username) {
            const attempts = loginAttempts[username];
            if (!attempts) return false;

            if (attempts.count >= CONFIG.MAX_LOGIN_ATTEMPTS) {
                const lockoutEnd = new Date(attempts.lastAttempt).getTime() + (CONFIG.LOCKOUT_DURATION * 60 * 1000);
                if (Date.now() < lockoutEnd) {
                    return true;
                } else {
                    // Reset sau khi háº¿t thá»i gian khÃ³a
                    delete loginAttempts[username];
                    saveData('loginAttempts', loginAttempts);
                    return false;
                }
            }
            return false;
        }

        // ===== 2.5 Ghi nháº­n láº§n Ä‘Äƒng nháº­p sai =====
        function recordFailedLogin(username) {
            if (!loginAttempts[username]) {
                loginAttempts[username] = { count: 0, lastAttempt: null };
            }
            loginAttempts[username].count++;
            loginAttempts[username].lastAttempt = new Date().toISOString();
            saveData('loginAttempts', loginAttempts);
        }

        // ===== 2.6 Reset Ä‘áº¿m Ä‘Äƒng nháº­p sai =====
        function resetLoginAttempts(username) {
            delete loginAttempts[username];
            saveData('loginAttempts', loginAttempts);
        }

        // ===== 2.9 Xá»­ lÃ½ Ä‘Äƒng nháº­p (Cáº¬P NHáº¬T Báº¢O Máº¬T) =====
        function handleLogin(event) {
            event.preventDefault();

            const username = document.getElementById('loginUsername').value.trim().toLowerCase();
            const password = document.getElementById('loginPassword').value;
            const rememberMe = document.getElementById('rememberMe').checked;

            // Reset error
            hideLoginError();

            // Kiá»ƒm tra tÃ i khoáº£n bá»‹ khÃ³a
            if (isAccountLocked(username)) {
                showLoginError(`TÃ i khoáº£n bá»‹ khÃ³a táº¡m thá»i. Vui lÃ²ng thá»­ láº¡i sau ${CONFIG.LOCKOUT_DURATION} phÃºt.`);
                return;
            }

            // TÃ¬m user
            const user = users.find(u => u.username.toLowerCase() === username);

            if (!user) {
                recordFailedLogin(username);
                showLoginError('TÃªn Ä‘Äƒng nháº­p khÃ´ng tá»“n táº¡i!');
                return;
            }

            // Kiá»ƒm tra tráº¡ng thÃ¡i
            if (user.status === 'locked') {
                showLoginError('TÃ i khoáº£n Ä‘Ã£ bá»‹ khÃ³a. LiÃªn há»‡ Admin!');
                return;
            }

            // Kiá»ƒm tra password (há»— trá»£ cáº£ hash cÅ© vÃ  má»›i)
            const isValidPassword = verifyPassword(password, user.passwordHash, user.salt);

            if (!isValidPassword) {
                recordFailedLogin(username);
                const remaining = CONFIG.MAX_LOGIN_ATTEMPTS - (loginAttempts[username]?.count || 0);
                showLoginError(`Sai máº­t kháº©u! CÃ²n ${remaining} láº§n thá»­.`);
                return;
            }

            // ÄÄƒng nháº­p thÃ nh cÃ´ng
            resetLoginAttempts(username);

            // Kiá»ƒm tra xem cÃ³ pháº£i hash cÅ© khÃ´ng â†’ yÃªu cáº§u Ä‘á»•i máº­t kháº©u
            const needChangePassword = isOldPasswordHash(user.passwordHash) || user.mustChangePassword;

            // Cáº­p nháº­t lastLogin
            user.lastLogin = new Date().toISOString();
            saveUsersEncrypted(users);

            // LÆ°u session
            currentUser = {
                id: user.id,
                username: user.username,
                fullName: user.fullName,
                role: user.role,
                loginTime: new Date().toISOString(),
                needChangePassword: needChangePassword // Flag Ä‘á»ƒ kiá»ƒm tra sau
            };

            if (rememberMe) {
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
            } else {
                sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
            }

            // Chuyá»ƒn vÃ o á»©ng dá»¥ng
            showApp();

            // Náº¿u cáº§n Ä‘á»•i máº­t kháº©u, hiá»‡n thÃ´ng bÃ¡o vÃ  má»Ÿ modal
            if (needChangePassword) {
                setTimeout(() => {
                    showNotification('âš ï¸ Vui lÃ²ng Ä‘á»•i máº­t kháº©u Ä‘á»ƒ tÄƒng báº£o máº­t!', 'warning');
                    openForceChangePasswordModal();
                }, 500);
            } else {
                showNotification(`ChÃ o má»«ng ${user.fullName}!`, 'success');
            }
        }


        // ===== 2.8 ÄÄƒng xuáº¥t =====
        function handleLogout() {
            if (!confirm('Báº¡n cÃ³ cháº¯c muá»‘n Ä‘Äƒng xuáº¥t?')) return;

            currentUser = null;
            localStorage.removeItem('currentUser');
            sessionStorage.removeItem('currentUser');

            hideApp();
            showNotification('ÄÃ£ Ä‘Äƒng xuáº¥t!', 'info');
        }

        // ===== 2.9 Kiá»ƒm tra session =====
        function checkAuth() {
            // Kiá»ƒm tra cáº£ localStorage vÃ  sessionStorage
            const savedUser = localStorage.getItem('currentUser') || sessionStorage.getItem('currentUser');

            if (savedUser) {
                currentUser = JSON.parse(savedUser);

                // Kiá»ƒm tra session timeout
                const loginTime = new Date(currentUser.loginTime).getTime();
                const now = Date.now();
                const timeoutMs = CONFIG.SESSION_TIMEOUT * 60 * 1000;

                if (now - loginTime > timeoutMs) {
                    // Session háº¿t háº¡n
                    handleLogout();
                    showNotification('PhiÃªn Ä‘Äƒng nháº­p háº¿t háº¡n. Vui lÃ²ng Ä‘Äƒng nháº­p láº¡i!', 'warning');
                    return false;
                }

                return true;
            }

            return false;
        }

        // ===== 2.10 Hiá»‡n/áº¨n mÃ n hÃ¬nh =====
        function showApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('appContainer').classList.add('show');

            // Cáº­p nháº­t UI theo user
            updateUserUI();

            // Render menu theo quyá»n
            renderSidebarMenu();

            // Render ná»™i dung
            renderAll();
        }

        function hideApp() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('appContainer').classList.remove('show');

            // Reset form login
            document.getElementById('loginForm').reset();
            hideLoginError();
        }

        // ===== 2.11 Cáº­p nháº­t UI user =====
        function updateUserUI() {
            if (!currentUser) return;

            const avatar = currentUser.fullName.charAt(0).toUpperCase();
            document.getElementById('userAvatar').textContent = avatar;
            document.getElementById('userName').textContent = currentUser.fullName;
            document.getElementById('userRoleBadge').textContent = getRoleLabel(currentUser.role);
            document.getElementById('userMenuName').textContent = currentUser.fullName;
            document.getElementById('userMenuRole').textContent = getRoleLabel(currentUser.role);
        }

        function getRoleLabel(role) {
            const labels = { admin: 'Admin', manager: 'Manager', user: 'User' };
            return labels[role] || role;
        }

        // ===== 2.12 Hiá»‡n/áº¨n lá»—i Ä‘Äƒng nháº­p =====
        function showLoginError(message) {
            const errorDiv = document.getElementById('loginError');
            document.getElementById('loginErrorText').textContent = message;
            errorDiv.classList.add('show');
        }

        function hideLoginError() {
            document.getElementById('loginError').classList.remove('show');
        }

        // ===== 2.13 Toggle hiá»‡n password =====
        function togglePasswordVisibility() {
            const input = document.getElementById('loginPassword');
            const btn = document.querySelector('.password-toggle');
            if (input.type === 'password') {
                input.type = 'text';
                btn.textContent = 'ğŸ™ˆ';
            } else {
                input.type = 'password';
                btn.textContent = 'ğŸ‘ï¸';
            }
        }

        // ===== 2.14 Toggle password cho báº¥t ká»³ input nÃ o =====
        function togglePasswordField(inputId, btn) {
            const input = document.getElementById(inputId);
            if (!input) return;

            if (input.type === 'password') {
                input.type = 'text';
                btn.textContent = 'ğŸ™ˆ';
            } else {
                input.type = 'password';
                btn.textContent = 'ğŸ‘ï¸';
            }
        }

        /* ============================================================
           ğŸ”‘ PHáº¦N 3: PERMISSIONS (PhÃ¢n quyá»n)
           ============================================================ */

        // ===== 3.1 Kiá»ƒm tra quyá»n =====
        function hasPermission(tabId, action = 'view') {
            if (!currentUser) return false;

            const role = currentUser.role;
            const rolePermissions = permissions[role];

            if (!rolePermissions || !rolePermissions[tabId]) {
                // Fallback to default
                return DEFAULT_PERMISSIONS[role]?.[tabId]?.[action] || false;
            }

            return rolePermissions[tabId][action] || false;
        }

        // ===== 3.2 Kiá»ƒm tra cÃ³ thá»ƒ xem tab =====
        function canViewTab(tabId) {
            return hasPermission(tabId, 'view');
        }

        // ===== 3.3 Kiá»ƒm tra cÃ³ thá»ƒ táº¡o =====
        function canCreate(tabId) {
            return hasPermission(tabId, 'create');
        }

        // ===== 3.4 Kiá»ƒm tra cÃ³ thá»ƒ sá»­a =====
        function canEdit(tabId) {
            return hasPermission(tabId, 'edit');
        }

        // ===== 3.5 Kiá»ƒm tra cÃ³ thá»ƒ xÃ³a =====
        function canDelete(tabId) {
            return hasPermission(tabId, 'delete');
        }

        // ===== 3.6 Render sidebar menu theo quyá»n =====
        function renderSidebarMenu() {
            const nav = document.getElementById('sidebarNav');
            let html = '';

            // Lá»c menu items cÃ³ quyá»n xem
            const visibleItems = MENU_STRUCTURE.filter(item => {
                if (item.isGroup) {
                    // Group hiá»ƒn thá»‹ náº¿u cÃ³ Ã­t nháº¥t 1 child visible
                    const children = MENU_STRUCTURE.filter(m => m.parent === item.id);
                    return children.some(child => canViewTab(child.id));
                }
                if (item.parent) {
                    // Child item
                    return canViewTab(item.id);
                }
                // Top-level item (khÃ´ng pháº£i group)
                return canViewTab(item.id);
            });

            // Render menu
            visibleItems.forEach(item => {
                if (item.isGroup) {
                    // Render group vá»›i children
                    const children = MENU_STRUCTURE.filter(m => m.parent === item.id && canViewTab(m.id));
                    if (children.length > 0) {
                        html += `
                    <div class="nav-item">
                        <a class="nav-link has-submenu" onclick="toggleSubmenu(this)">
                            <span class="nav-icon">${item.icon}</span>
                            <span class="nav-text">${item.text}</span>
                            <span class="nav-arrow">â–¶</span>
                        </a>
                        <div class="nav-submenu">
                            ${children.map(child => `
                                <a class="nav-link" data-tab="${child.id}" onclick="switchTab('${child.id}')">
                                    <span class="nav-text">${child.text}</span>
                                </a>
                            `).join('')}
                        </div>
                    </div>
                `;
                    }
                } else if (!item.parent) {
                    // Top-level item (khÃ´ng cÃ³ parent)
                    html += `
                <div class="nav-item">
                    <a class="nav-link ${item.id === 'dashboard' ? 'active' : ''}" data-tab="${item.id}" onclick="switchTab('${item.id}')">
                        <span class="nav-icon">${item.icon}</span>
                        <span class="nav-text">${item.text}</span>
                    </a>
                </div>
            `;
                }
            });

            nav.innerHTML = html;
        }

        // ===== 3.7 áº¨n/Hiá»‡n nÃºt thao tÃ¡c theo quyá»n =====
        function updateActionButtons() {
            // Students actions
            const studentsActions = document.getElementById('studentsActions');
            if (studentsActions) {
                const addBtn = studentsActions.querySelector('.btn-success');
                if (addBtn) addBtn.style.display = canCreate('students') ? '' : 'none';
            }

            // Appointments actions
            const appointmentsActions = document.getElementById('appointmentsActions');
            if (appointmentsActions) {
                const addBtn = appointmentsActions.querySelector('.btn-success');
                if (addBtn) addBtn.style.display = canCreate('appointments') ? '' : 'none';
            }

            // Registrations actions
            const registrationsActions = document.getElementById('registrationsActions');
            if (registrationsActions) {
                const addBtn = registrationsActions.querySelector('.btn-success');
                if (addBtn) addBtn.style.display = canCreate('registrations') ? '' : 'none';
            }

            // Receipts actions
            const receiptsActions = document.getElementById('receiptsActions');
            if (receiptsActions) {
                const addBtn = receiptsActions.querySelector('.btn-success');
                if (addBtn) addBtn.style.display = canCreate('receipts') ? '' : 'none';
            }

            // Subjects, Packages, Promotions actions
            ['subjects', 'packages', 'promotions'].forEach(tab => {
                const actions = document.getElementById(`${tab}Actions`);
                if (actions) {
                    const addBtn = actions.querySelector('.btn-success');
                    if (addBtn) addBtn.style.display = canCreate(tab) ? '' : 'none';
                }
            });
        }

        // ===== 3.8 Render ma tráº­n phÃ¢n quyá»n =====
        function renderPermissionMatrix() {
            const role = document.getElementById('permissionRoleSelect').value;
            const rolePerms = permissions[role] || DEFAULT_PERMISSIONS[role];

            const tabs = [
                { id: 'dashboard', name: 'ğŸ“Š Tá»•ng quan' },
                { id: 'students', name: 'ğŸ‘©â€ğŸ“ Há»c viÃªn' },
                { id: 'trial', name: 'ğŸ“ Há»c thá»­' },
                { id: 'appointments', name: 'ğŸ“… Lá»‹ch háº¹n' },
                { id: 'registrations', name: 'ğŸ“‹ Phiáº¿u ÄK' },
                { id: 'receipts', name: 'ğŸ§¾ BiÃªn lai' },
                { id: 'debts', name: 'ğŸ’³ CÃ´ng ná»£' },
                { id: 'teachers', name: 'ğŸ‘¨â€ğŸ« GiÃ¡o viÃªn' },
                { id: 'classes', name: 'ğŸ“š Lá»›p há»c' },
                { id: 'attendance', name: 'âœ… Äiá»ƒm danh' },
                { id: 'subjects', name: 'ğŸ“– MÃ´n há»c' },
                { id: 'packages', name: 'ğŸ“¦ GÃ³i há»c phÃ­' },
                { id: 'promotions', name: 'ğŸ Khuyáº¿n mÃ£i' },
                { id: 'reports', name: 'ğŸ“ˆ BÃ¡o cÃ¡o' },
                { id: 'export', name: 'ğŸ“¤ Xuáº¥t/Nháº­p' },
                { id: 'users', name: 'ğŸ” TÃ i khoáº£n' },
                { id: 'settings', name: 'âš™ï¸ CÃ i Ä‘áº·t' }
            ];

            const html = `
        <table>
            <thead>
                <tr>
                    <th style="text-align: left;">Tab/Chá»©c nÄƒng</th>
                    <th>Xem</th>
                    <th>ThÃªm</th>
                    <th>Sá»­a</th>
                    <th>XÃ³a</th>
                </tr>
            </thead>
            <tbody>
                ${tabs.map(tab => {
                const perms = rolePerms[tab.id] || { view: false, create: false, edit: false, delete: false };
                return `
                        <tr>
                            <td><span class="tab-name">${tab.name}</span></td>
                            <td><input type="checkbox" class="permission-checkbox" data-tab="${tab.id}" data-action="view" ${perms.view ? 'checked' : ''}></td>
                            <td><input type="checkbox" class="permission-checkbox" data-tab="${tab.id}" data-action="create" ${perms.create ? 'checked' : ''}></td>
                            <td><input type="checkbox" class="permission-checkbox" data-tab="${tab.id}" data-action="edit" ${perms.edit ? 'checked' : ''}></td>
                            <td><input type="checkbox" class="permission-checkbox" data-tab="${tab.id}" data-action="delete" ${perms.delete ? 'checked' : ''}></td>
                        </tr>
                    `;
            }).join('')}
            </tbody>
        </table>
    `;

            document.getElementById('permissionMatrix').innerHTML = html;
        }

        function loadPermissionsForRole() {
            renderPermissionMatrix();
        }

        // ===== 3.9 LÆ°u phÃ¢n quyá»n =====
        function savePermissions() {
            const role = document.getElementById('permissionRoleSelect').value;

            if (!permissions[role]) {
                permissions[role] = {};
            }

            const checkboxes = document.querySelectorAll('.permission-checkbox');
            checkboxes.forEach(cb => {
                const tab = cb.dataset.tab;
                const action = cb.dataset.action;

                if (!permissions[role][tab]) {
                    permissions[role][tab] = { view: false, create: false, edit: false, delete: false };
                }

                permissions[role][tab][action] = cb.checked;
            });

            saveData('permissions', permissions);
            showNotification(`ÄÃ£ lÆ°u phÃ¢n quyá»n cho ${getRoleLabel(role)}!`, 'success');

            // Náº¿u Ä‘ang sá»­a quyá»n cá»§a chÃ­nh mÃ¬nh, cáº­p nháº­t láº¡i UI
            if (currentUser && currentUser.role === role) {
                renderSidebarMenu();
                updateActionButtons();
            }
        }

        // ===== 3.10 Reset vá» máº·c Ä‘á»‹nh =====
        function resetPermissions() {
            const role = document.getElementById('permissionRoleSelect').value;

            if (!confirm(`Reset quyá»n cá»§a ${getRoleLabel(role)} vá» máº·c Ä‘á»‹nh?`)) return;

            permissions[role] = JSON.parse(JSON.stringify(DEFAULT_PERMISSIONS[role]));
            saveData('permissions', permissions);

            renderPermissionMatrix();
            showNotification('ÄÃ£ reset vá» máº·c Ä‘á»‹nh!', 'success');

            if (currentUser && currentUser.role === role) {
                renderSidebarMenu();
                updateActionButtons();
            }
        }

        /* ============================================================
           ğŸ‘¤ PHáº¦N 4: QUáº¢N LÃ TÃ€I KHOáº¢N
           ============================================================ */

        // ===== 4.1 Render báº£ng users =====
        function renderUsersTable() {
            const tbody = document.getElementById('usersTableBody');

            if (users.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6"><div class="empty-state"><div class="empty-state-icon">ğŸ‘¤</div><p>ChÆ°a cÃ³ tÃ i khoáº£n</p></div></td></tr>`;
                return;
            }

            tbody.innerHTML = users.map(user => `
        <tr>
            <td><strong>${user.username}</strong></td>
            <td>${user.fullName}</td>
            <td><span class="role-badge ${user.role}">${getRoleLabel(user.role)}</span></td>
            <td><span class="status-badge ${user.status === 'active' ? 'active' : 'locked'}">${user.status === 'active' ? 'âœ… Hoáº¡t Ä‘á»™ng' : 'ğŸ”’ ÄÃ£ khÃ³a'}</span></td>
            <td>${user.lastLogin ? formatDateTime(user.lastLogin) : '<span class="text-muted">ChÆ°a Ä‘Äƒng nháº­p</span>'}</td>
            <td>
                <div class="action-buttons">
                    ${user.id !== currentUser.id ? `
                        <button class="action-btn edit" onclick="editUser('${user.id}')" title="Sá»­a">âœï¸</button>
                        <button class="action-btn key" onclick="openResetPasswordModal('${user.id}')" title="Reset máº­t kháº©u">ğŸ”‘</button>
                        ${user.status === 'active'
                        ? `<button class="action-btn lock" onclick="toggleUserStatus('${user.id}')" title="KhÃ³a">ğŸ”’</button>`
                        : `<button class="action-btn unlock" onclick="toggleUserStatus('${user.id}')" title="Má»Ÿ khÃ³a">ğŸ”“</button>`
                    }
                        ${user.role !== 'admin' || users.filter(u => u.role === 'admin').length > 1
                        ? `<button class="action-btn delete" onclick="deleteUser('${user.id}')" title="XÃ³a">ğŸ—‘ï¸</button>`
                        : ''
                    }
                    ` : '<span class="text-muted">TÃ i khoáº£n hiá»‡n táº¡i</span>'}
                </div>
            </td>
        </tr>
    `).join('');
        }

        // ===== 4.2 Má»Ÿ modal thÃªm user =====
        function openUserModal() {
            document.getElementById('editUserId').value = '';
            document.getElementById('userForm').reset();
            document.getElementById('userModalTitle').textContent = 'ğŸ‘¤ ThÃªm TÃ i Khoáº£n';
            document.getElementById('userPassword').required = true;
            document.getElementById('passwordGroup').style.display = 'block';
            openModal('userModal');
        }

        // ===== 4.3 Sá»­a user =====
        function editUser(id) {
            const user = users.find(u => u.id === id);
            if (!user) return;

            document.getElementById('editUserId').value = user.id;
            document.getElementById('userUsername').value = user.username;
            document.getElementById('userFullName').value = user.fullName;
            document.getElementById('userRole').value = user.role;
            document.getElementById('userPassword').value = '';
            document.getElementById('userPassword').required = false;
            document.getElementById('passwordGroup').style.display = 'none'; // áº¨n khi sá»­a
            document.getElementById('userModalTitle').textContent = 'âœï¸ Sá»­a TÃ i Khoáº£n';

            openModal('userModal');
        }

        // ===== 4.4 LÆ°u user (Cáº¬P NHáº¬T Báº¢O Máº¬T) =====
        function saveUser(event) {
            event.preventDefault();

            const editId = document.getElementById('editUserId').value;
            const username = document.getElementById('userUsername').value.trim().toLowerCase();
            const password = document.getElementById('userPassword').value;
            const fullName = document.getElementById('userFullName').value.trim();
            const role = document.getElementById('userRole').value;

            // Kiá»ƒm tra username trÃ¹ng
            const existing = users.find(u => u.username.toLowerCase() === username && u.id !== editId);
            if (existing) {
                showNotification('TÃªn Ä‘Äƒng nháº­p Ä‘Ã£ tá»“n táº¡i!', 'error');
                return;
            }

            if (editId) {
                // Cáº­p nháº­t user hiá»‡n cÃ³
                const index = users.findIndex(u => u.id === editId);
                if (index !== -1) {
                    users[index].username = username;
                    users[index].fullName = fullName;
                    users[index].role = role;
                    users[index].updatedAt = new Date().toISOString();
                    showNotification('Cáº­p nháº­t thÃ nh cÃ´ng!', 'success');
                }
            } else {
                // ThÃªm user má»›i
                if (!password || password.length < 6) {
                    showNotification('Máº­t kháº©u pháº£i cÃ³ Ã­t nháº¥t 6 kÃ½ tá»±!', 'error');
                    return;
                }

                // Táº¡o salt vÃ  hash password má»›i
                const salt = generateSalt();
                const passwordHash = hashPasswordSecure(password, salt);

                users.push({
                    id: generateId(),
                    username,
                    passwordHash,
                    salt, // LÆ°u salt riÃªng
                    fullName,
                    role,
                    status: 'active',
                    mustChangePassword: false,
                    createdAt: new Date().toISOString(),
                    lastLogin: null
                });
                showNotification('ThÃªm tÃ i khoáº£n thÃ nh cÃ´ng!', 'success');
            }

            // LÆ°u vá»›i mÃ£ hÃ³a
            saveUsersEncrypted(users);
            closeModal('userModal');
            renderUsersTable();
        }


        // ===== 4.5 KhÃ³a/Má»Ÿ khÃ³a user =====
        function toggleUserStatus(id) {
            const user = users.find(u => u.id === id);
            if (!user) return;

            const action = user.status === 'active' ? 'khÃ³a' : 'má»Ÿ khÃ³a';
            if (!confirm(`${action.charAt(0).toUpperCase() + action.slice(1)} tÃ i khoáº£n "${user.username}"?`)) return;

            user.status = user.status === 'active' ? 'locked' : 'active';
            saveData('users', users);
            renderUsersTable();
            showNotification(`ÄÃ£ ${action} tÃ i khoáº£n!`, 'success');
        }

        // ===== 4.6 XÃ³a user =====
        function deleteUser(id) {
            const user = users.find(u => u.id === id);
            if (!user) return;

            if (!confirm(`XÃ³a tÃ i khoáº£n "${user.username}"?`)) return;

            users = users.filter(u => u.id !== id);
            saveData('users', users);
            renderUsersTable();
            showNotification('ÄÃ£ xÃ³a tÃ i khoáº£n!', 'success');
        }

        // ===== 4.7 Reset password =====
        function openResetPasswordModal(id) {
            const user = users.find(u => u.id === id);
            if (!user) return;

            document.getElementById('resetPasswordUserId').value = user.id;
            document.getElementById('resetPasswordUsername').textContent = user.username;
            document.getElementById('resetNewPassword').value = '';
            openModal('resetPasswordModal');
        }

        // ===== 4.7.1 Xá»­ lÃ½ Reset Password (Cáº¬P NHáº¬T Báº¢O Máº¬T) =====
        function handleResetPassword(event) {
            event.preventDefault();

            const userId = document.getElementById('resetPasswordUserId').value;
            const newPassword = document.getElementById('resetNewPassword').value;

            if (newPassword.length < 6) {
                showNotification('Máº­t kháº©u pháº£i cÃ³ Ã­t nháº¥t 6 kÃ½ tá»±!', 'error');
                return;
            }

            const user = users.find(u => u.id === userId);
            if (user) {
                // Táº¡o salt má»›i vÃ  hash password
                const newSalt = generateSalt();
                user.salt = newSalt;
                user.passwordHash = hashPasswordSecure(newPassword, newSalt);
                user.mustChangePassword = true; // Báº¯t buá»™c Ä‘á»•i láº¡i sau khi reset
                user.passwordResetAt = new Date().toISOString();

                // LÆ°u vá»›i mÃ£ hÃ³a
                saveUsersEncrypted(users);

                closeModal('resetPasswordModal');
                showNotification('ÄÃ£ reset máº­t kháº©u! User sáº½ cáº§n Ä‘á»•i máº­t kháº©u khi Ä‘Äƒng nháº­p.', 'success');
            }
        }

        // ===== 4.8 Äá»•i máº­t kháº©u (user tá»± Ä‘á»•i) =====
        function openChangePasswordModal() {
            document.getElementById('changePasswordForm').reset();
            closeUserMenu();
            openModal('changePasswordModal');
        }

        // ===== 4.8 Äá»•i máº­t kháº©u (Cáº¬P NHáº¬T Báº¢O Máº¬T) =====
        function handleChangePassword(event) {
            event.preventDefault();

            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            // TÃ¬m user hiá»‡n táº¡i
            const user = users.find(u => u.id === currentUser.id);
            if (!user) {
                showNotification('KhÃ´ng tÃ¬m tháº¥y thÃ´ng tin ngÆ°á»i dÃ¹ng!', 'error');
                return;
            }

            // Kiá»ƒm tra máº­t kháº©u hiá»‡n táº¡i
            if (!verifyPassword(currentPassword, user.passwordHash, user.salt)) {
                showNotification('Máº­t kháº©u hiá»‡n táº¡i khÃ´ng Ä‘Ãºng!', 'error');
                return;
            }

            // Kiá»ƒm tra máº­t kháº©u má»›i
            if (newPassword.length < 6) {
                showNotification('Máº­t kháº©u má»›i pháº£i cÃ³ Ã­t nháº¥t 6 kÃ½ tá»±!', 'error');
                return;
            }

            if (newPassword !== confirmPassword) {
                showNotification('XÃ¡c nháº­n máº­t kháº©u khÃ´ng khá»›p!', 'error');
                return;
            }

            // Táº¡o salt má»›i vÃ  hash password má»›i
            const newSalt = generateSalt();
            user.salt = newSalt;
            user.passwordHash = hashPasswordSecure(newPassword, newSalt);
            user.mustChangePassword = false;
            user.passwordChangedAt = new Date().toISOString();

            // LÆ°u vá»›i mÃ£ hÃ³a
            saveUsersEncrypted(users);

            closeModal('changePasswordModal');
            showNotification('Äá»•i máº­t kháº©u thÃ nh cÃ´ng!', 'success');
        }


        // ===== 4.9 Má»Ÿ modal báº¯t buá»™c Ä‘á»•i máº­t kháº©u =====
        function openForceChangePasswordModal() {
            document.getElementById('forceChangePasswordForm').reset();
            document.getElementById('forcePasswordError').style.display = 'none';

            // Má»Ÿ modal (khÃ´ng cho Ä‘Ã³ng báº±ng click outside hoáº·c ESC)
            const modal = document.getElementById('forceChangePasswordModal');
            modal.classList.add('active');

            // Disable click outside to close
            modal.onclick = function (e) {
                if (e.target === modal) {
                    showNotification('Vui lÃ²ng Ä‘á»•i máº­t kháº©u Ä‘á»ƒ tiáº¿p tá»¥c!', 'warning');
                }
            };
        }

        // ===== 4.10 Xá»­ lÃ½ Ä‘á»•i máº­t kháº©u báº¯t buá»™c =====
        function handleForceChangePassword(event) {
            event.preventDefault();

            const newPassword = document.getElementById('forceNewPassword').value;
            const confirmPassword = document.getElementById('forceConfirmPassword').value;
            const errorDiv = document.getElementById('forcePasswordError');

            // áº¨n lá»—i cÅ©
            errorDiv.style.display = 'none';

            // Kiá»ƒm tra Ä‘á»™ dÃ i
            if (newPassword.length < 6) {
                errorDiv.textContent = 'Máº­t kháº©u pháº£i cÃ³ Ã­t nháº¥t 6 kÃ½ tá»±!';
                errorDiv.style.display = 'block';
                return;
            }

            // Kiá»ƒm tra khá»›p
            if (newPassword !== confirmPassword) {
                errorDiv.textContent = 'XÃ¡c nháº­n máº­t kháº©u khÃ´ng khá»›p!';
                errorDiv.style.display = 'block';
                return;
            }

            // TÃ¬m user hiá»‡n táº¡i
            const user = users.find(u => u.id === currentUser.id);
            if (!user) {
                errorDiv.textContent = 'KhÃ´ng tÃ¬m tháº¥y thÃ´ng tin ngÆ°á»i dÃ¹ng!';
                errorDiv.style.display = 'block';
                return;
            }

            // Táº¡o salt má»›i vÃ  hash password má»›i
            const newSalt = generateSalt();
            user.salt = newSalt;
            user.passwordHash = hashPasswordSecure(newPassword, newSalt);
            user.mustChangePassword = false;
            user.passwordChangedAt = new Date().toISOString();

            // LÆ°u users Ä‘Ã£ mÃ£ hÃ³a
            saveUsersEncrypted(users);

            // Cáº­p nháº­t session
            currentUser.needChangePassword = false;
            if (localStorage.getItem('currentUser')) {
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
            } else {
                sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
            }

            // ÄÃ³ng modal
            document.getElementById('forceChangePasswordModal').classList.remove('active');

            showNotification('âœ… Äá»•i máº­t kháº©u thÃ nh cÃ´ng! Há»‡ thá»‘ng Ä‘Ã£ Ä‘Æ°á»£c báº£o máº­t.', 'success');
        }

        function openProfileModal() {
            closeUserMenu();
            showNotification('TÃ­nh nÄƒng Ä‘ang phÃ¡t triá»ƒn', 'info');
        }

        /* ============================================================
           ğŸ§­ PHáº¦N 5: NAVIGATION & UI
           ============================================================ */

        // ===== 5.1 Toggle Sidebar =====
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('collapsed');
        }

        // ===== 5.2 Toggle Submenu =====
        function toggleSubmenu(element) {
            const navItem = element.parentElement;
            const submenu = navItem.querySelector('.nav-submenu');
            const isExpanded = submenu.classList.contains('open');

            // ÄÃ³ng táº¥t cáº£ submenu khÃ¡c
            document.querySelectorAll('.nav-submenu.open').forEach(menu => {
                menu.classList.remove('open');
                menu.previousElementSibling.classList.remove('expanded');
            });

            // Toggle submenu hiá»‡n táº¡i
            if (!isExpanded) {
                submenu.classList.add('open');
                element.classList.add('expanded');
            }
        }

        // ===== 5.3 Toggle User Menu =====
        function toggleUserMenu() {
            document.getElementById('userMenu').classList.toggle('show');
        }

        function closeUserMenu() {
            document.getElementById('userMenu').classList.remove('show');
        }

        // ===== 5.4 Chuyá»ƒn Tab =====
        function switchTab(tabName) {
            // Kiá»ƒm tra quyá»n
            if (!canViewTab(tabName)) {
                showNotification('Báº¡n khÃ´ng cÃ³ quyá»n truy cáº­p!', 'error');
                return;
            }

            // áº¨n táº¥t cáº£ tab content
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            // Bá» active táº¥t cáº£ nav-link
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));

            // Hiá»‡n tab Ä‘Æ°á»£c chá»n
            const tabContent = document.getElementById(tabName);
            if (tabContent) {
                tabContent.classList.add('active');
            }

            // Active nav-link tÆ°Æ¡ng á»©ng
            const navLink = document.querySelector(`.nav-link[data-tab="${tabName}"]`);
            if (navLink) {
                navLink.classList.add('active');

                // Má»Ÿ submenu cha náº¿u cÃ³
                const submenu = navLink.closest('.nav-submenu');
                if (submenu) {
                    submenu.classList.add('open');
                    const parentLink = submenu.previousElementSibling;
                    if (parentLink) parentLink.classList.add('expanded');
                }
            }

            // Cáº­p nháº­t tiÃªu Ä‘á»
            updatePageTitle(tabName);

            // Render ná»™i dung
            renderTabContent(tabName);

            // Cáº­p nháº­t nÃºt thao tÃ¡c theo quyá»n
            updateActionButtons();
        }

        function updatePageTitle(tabName) {
            const menuItem = MENU_STRUCTURE.find(m => m.id === tabName);
            document.getElementById('pageTitle').textContent = menuItem ? `${menuItem.icon} ${menuItem.text}` : tabName;
        }

        function renderTabContent(tabName) {
            switch (tabName) {
                case 'dashboard': renderDashboard(); break;
                case 'students': renderStudentsTable(); updateStudentCounts(); break;
                case 'teachers': renderTeachersTable(); break;
                case 'classes': renderClassesTable(); populateClassFilters(); break;
                case 'attendance': initAttendanceTab(); break;
                case 'makeup': checkExpiredMakeupRequests(); renderMakeupRequests(); break;
                case 'trial': renderTrialStudentsTable(); updateTrialCounts(); break;
                case 'appointments': renderAppointmentsTable(); break;
                case 'registrations': renderRegistrationsTable(); break;
                case 'receipts': initReceiptFilters(); renderReceiptsTable(); break;
                case 'subjects': renderSubjectsTable(); break;
                case 'packages': renderPackagesTable(); break;
                case 'promotions': renderPromotionsTable(); break;
                case 'rooms': renderRoomsTable(); break;
                case 'users': renderUsersTable(); renderPermissionMatrix(); break;
                case 'export': renderBackupHistory(); break;
                case 'debts': renderDebtsTable(); break;
                case 'reports': initReportsTab(); break;
                case 'settings': loadCenterInfo(); loadBankInfo(); loadWarningSettings(); break;

                // Xá»­ lÃ½ phÃ¢n trang cho cÃ¡c tab con
                case 'attendanceHistory': loadAttendanceHistory(); break;
            }
        }


        // ===== 5.5 Click outside to close =====
        document.addEventListener('click', function (e) {
            // Close user menu
            if (!e.target.closest('.user-dropdown')) {
                closeUserMenu();
            }
        });

        /* ============================================================
           ğŸ”” PHáº¦N 6: NOTIFICATIONS & MODALS
           ============================================================ */

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const icons = { success: 'âœ…', error: 'âŒ', warning: 'âš ï¸', info: 'â„¹ï¸' };
            notification.className = `notification ${type} show`;
            notification.innerHTML = `<span>${icons[type]}</span><span>${message}</span>`;
            setTimeout(() => notification.classList.remove('show'), 3000);
        }

        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        /* ============================================================
           ğŸ’¾ PHáº¦N 7: DATA HELPERS
           ============================================================ */

        function saveData(key, data) {
            // Xá»­ lÃ½ riÃªng cho users (lÆ°u mÃ£ hÃ³a)
            if (key === 'users') {
                saveUsersEncrypted(data);
                return;
            }

            // CÃ¡c dá»¯ liá»‡u khÃ¡c lÆ°u bÃ¬nh thÆ°á»ng (plain text)
            localStorage.setItem(key, JSON.stringify(data));

            if (autoBackupEnabled && !['loginAttempts', 'currentUser'].includes(key)) {
                createAutoBackup();
            }
        }


        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
        }

        function generateRegCode() {
            const date = new Date();
            const y = date.getFullYear().toString().slice(2);
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            const rand = Math.random().toString(36).substr(2, 4).toUpperCase();
            return `DK${y}${m}${d}-${rand}`;
        }

        /* ============================================================
           ğŸ“Š PHáº¦N 8: DASHBOARD
           ============================================================ */

        function renderDashboard() {
            renderDashboardStats();
            renderRevenueChart();
            renderUpcomingAppointments();

            // ThÃªm cáº£nh bÃ¡o cÃ´ng ná»£
            const warningsHTML = renderDashboardWarnings();

            // TÃ¬m vá»‹ trÃ­ Ä‘á»ƒ chÃ¨n cáº£nh bÃ¡o (sau lá»‹ch háº¹n sáº¯p tá»›i)
            const dashboardContent = document.getElementById('dashboard');
            let existingWarningCard = dashboardContent.querySelector('.card.mt-20:last-child');

            // XÃ³a cáº£nh bÃ¡o cÅ© náº¿u cÃ³
            const oldWarning = dashboardContent.querySelector('.dashboard-warning-card');
            if (oldWarning) oldWarning.remove();

            if (warningsHTML) {
                const warningDiv = document.createElement('div');
                warningDiv.className = 'dashboard-warning-card';
                warningDiv.innerHTML = warningsHTML;
                dashboardContent.appendChild(warningDiv);
            }
        }


        function renderDashboardStats() {
            const stats = {
                total: students.length,
                hocThu: students.filter(s => s.status === 'Há»c Thá»­').length,
                choDangKy: students.filter(s => s.status === 'Chá» ÄÄƒng KÃ½').length,
                daDangKy: students.filter(s => s.status === 'ÄÃ£ ÄÄƒng KÃ½').length,
                hoanThanh: students.filter(s => s.status === 'HoÃ n ThÃ nh').length,
                totalRevenue: receipts.reduce((sum, r) => sum + (parseFloat(r.amount) || 0), 0)
            };

            document.getElementById('dashboardStats').innerHTML = `
        <div class="stat-card"><div class="stat-icon teal">ğŸ“‹</div><div class="stat-info"><h3>${stats.total}</h3><p>Tá»•ng há»c viÃªn</p></div></div>
        <div class="stat-card"><div class="stat-icon blue">ğŸ†•</div><div class="stat-info"><h3>${stats.hocThu}</h3><p>Há»c thá»­</p></div></div>
        <div class="stat-card"><div class="stat-icon orange">â³</div><div class="stat-info"><h3>${stats.choDangKy}</h3><p>Chá» Ä‘Äƒng kÃ½</p></div></div>
        <div class="stat-card"><div class="stat-icon green">âœ…</div><div class="stat-info"><h3>${stats.daDangKy}</h3><p>ÄÃ£ Ä‘Äƒng kÃ½</p></div></div>
        <div class="stat-card"><div class="stat-icon purple">ğŸ“</div><div class="stat-info"><h3>${stats.hoanThanh}</h3><p>HoÃ n thÃ nh</p></div></div>
        <div class="stat-card"><div class="stat-icon teal">ğŸ’°</div><div class="stat-info"><h3>${formatCurrencyShort(stats.totalRevenue)}</h3><p>Doanh thu</p></div></div>
    `;
        }

        function renderRevenueChart() {
            const months = [];
            const now = new Date();
            for (let i = 5; i >= 0; i--) {
                const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                months.push({ key: `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`, label: `T${d.getMonth() + 1}` });
            }

            const monthlyRevenue = {};
            months.forEach(m => monthlyRevenue[m.key] = 0);
            receipts.forEach(r => {
                const month = r.date?.substring(0, 7);
                if (monthlyRevenue[month] !== undefined) monthlyRevenue[month] += parseFloat(r.amount) || 0;
            });

            const maxRevenue = Math.max(...Object.values(monthlyRevenue), 1);
            document.getElementById('revenueChart').innerHTML = months.map(m => {
                const revenue = monthlyRevenue[m.key];
                const height = (revenue / maxRevenue) * 100;
                return `<div class="chart-bar-wrapper"><div class="chart-bar" style="height:${Math.max(height, 5)}%;"><span class="chart-bar-value">${formatCurrencyShort(revenue)}</span></div><span class="chart-bar-label">${m.label}</span></div>`;
            }).join('');
        }

        function renderUpcomingAppointments() {
            const now = new Date();
            const upcoming = appointments.filter(a => new Date(a.date + ' ' + a.time) >= now)
                .sort((a, b) => new Date(a.date + ' ' + a.time) - new Date(b.date + ' ' + b.time)).slice(0, 5);

            document.getElementById('upcomingAppointments').innerHTML = upcoming.length === 0
                ? '<div class="empty-state"><p class="text-muted">ChÆ°a cÃ³ lá»‹ch háº¹n sáº¯p tá»›i</p></div>'
                : upcoming.map(apt => {
                    const student = students.find(s => s.id === apt.studentId);
                    return `<div class="upcoming-item"><strong>${student?.name || 'N/A'}</strong> - ${apt.subject}<br>ğŸ“… ${formatDate(apt.date)} lÃºc ${apt.time}</div>`;
                }).join('');
        }

        /* ============================================================
           ğŸ‘©â€ğŸ“ PHáº¦N 9: QUáº¢N LÃ Há»ŒC VIÃŠN
           ============================================================ */

        function renderSubjectCheckboxes() {
            document.getElementById('subjectCheckboxes').innerHTML = subjects.map(sub =>
                `<label class="checkbox-item"><input type="checkbox" name="studentSubjects" value="${sub.name}"> ${sub.icon} ${sub.name}</label>`
            ).join('');
        }

        function toggleStudentForm() {
            const form = document.getElementById('studentFormSection');
            form.classList.toggle('show');
            if (form.classList.contains('show')) {
                resetStudentForm();
            }
        }

        function resetStudentForm() {
            document.getElementById('studentForm').reset();
            document.getElementById('editStudentId').value = '';
            document.getElementById('studentStatus').value = 'Há»c Thá»­';
            document.getElementById('studentFormTitle').textContent = 'â• ThÃªm Há»c ViÃªn Má»›i';
            document.getElementById('saveStudentBtn').textContent = 'ğŸ’¾ LÆ°u Há»c ViÃªn';
            document.querySelectorAll('input[name="studentSubjects"]').forEach(cb => cb.checked = false);
        }

        function saveStudent(event) {
            event.preventDefault();

            if (!canCreate('students') && !document.getElementById('editStudentId').value) {
                showNotification('Báº¡n khÃ´ng cÃ³ quyá»n thÃªm há»c viÃªn!', 'error');
                return;
            }

            const selectedSubjects = Array.from(document.querySelectorAll('input[name="studentSubjects"]:checked')).map(cb => cb.value);
            if (selectedSubjects.length === 0) { showNotification('Vui lÃ²ng chá»n Ã­t nháº¥t 1 mÃ´n há»c!', 'error'); return; }

            const editId = document.getElementById('editStudentId').value;
            const studentData = {
                name: document.getElementById('studentName').value.trim(),
                age: parseInt(document.getElementById('studentAge').value),
                parentName: document.getElementById('parentName').value.trim(),
                parentPhone: document.getElementById('parentPhone').value.trim(),
                parentEmail: document.getElementById('parentEmail').value.trim(),
                status: document.getElementById('studentStatus').value,
                subjects: selectedSubjects,
                notes: document.getElementById('studentNotes').value.trim()
            };

            if (editId) {
                if (!canEdit('students')) {
                    showNotification('Báº¡n khÃ´ng cÃ³ quyá»n sá»­a!', 'error');
                    return;
                }
                const index = students.findIndex(s => s.id === editId);
                if (index !== -1) {
                    students[index] = { ...students[index], ...studentData, updatedAt: new Date().toISOString() };
                    showNotification('Cáº­p nháº­t thÃ nh cÃ´ng!');
                }
            } else {
                students.push({ id: generateId(), ...studentData, previousStatus: null, createdAt: new Date().toISOString(), updatedAt: new Date().toISOString() });
                showNotification('ThÃªm há»c viÃªn thÃ nh cÃ´ng!');
            }

            saveData('students', students);
            document.getElementById('studentFormSection').classList.remove('show');
            resetStudentForm();
            renderStudentsTable();
            updateStudentCounts();
        }

        function editStudent(id) {
            if (!canEdit('students')) {
                showNotification('Báº¡n khÃ´ng cÃ³ quyá»n sá»­a!', 'error');
                return;
            }

            const student = students.find(s => s.id === id);
            if (!student) return;

            document.getElementById('editStudentId').value = student.id;
            document.getElementById('studentName').value = student.name;
            document.getElementById('studentAge').value = student.age;
            document.getElementById('parentName').value = student.parentName;
            document.getElementById('parentPhone').value = student.parentPhone;
            document.getElementById('parentEmail').value = student.parentEmail || '';
            document.getElementById('studentStatus').value = student.status;
            document.getElementById('studentNotes').value = student.notes || '';
            document.querySelectorAll('input[name="studentSubjects"]').forEach(cb => cb.checked = student.subjects.includes(cb.value));

            document.getElementById('studentFormTitle').textContent = 'âœï¸ Sá»­a Há»c ViÃªn';
            document.getElementById('saveStudentBtn').textContent = 'ğŸ’¾ Cáº­p Nháº­t';
            document.getElementById('studentFormSection').classList.add('show');
        }

        function deleteStudent(id) {
            if (!canDelete('students')) {
                showNotification('Báº¡n khÃ´ng cÃ³ quyá»n xÃ³a!', 'error');
                return;
            }

            const student = students.find(s => s.id === id);
            if (!student || !confirm(`XÃ³a "${student.name}"?`)) return;

            students = students.filter(s => s.id !== id);
            appointments = appointments.filter(a => a.studentId !== id);
            registrations = registrations.filter(r => r.studentId !== id);
            receipts = receipts.filter(r => r.studentId !== id);

            saveData('students', students);
            saveData('appointments', appointments);
            saveData('registrations', registrations);
            saveData('receipts', receipts);

            showNotification('ÄÃ£ xÃ³a!');
            renderAll();
        }

        function updateStudentCounts() {
            document.getElementById('countAll').textContent = students.length;
            document.getElementById('countHocThu').textContent = students.filter(s => s.status === 'Há»c Thá»­').length;
            document.getElementById('countChoDangKy').textContent = students.filter(s => s.status === 'Chá» ÄÄƒng KÃ½').length;
            document.getElementById('countDaDangKy').textContent = students.filter(s => s.status === 'ÄÃ£ ÄÄƒng KÃ½').length;
            document.getElementById('countHoanThanh').textContent = students.filter(s => s.status === 'HoÃ n ThÃ nh').length;
            document.getElementById('countCancel').textContent = students.filter(s => s.status === 'Cancel').length;
        }

        function filterStudents(status) {
            currentFilter = status;
            paginationState.students.page = 1;
            document.querySelectorAll('#students .filter-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.filter === status));
            renderStudentsTable();
        }

        function searchStudents() {
            paginationState.students.page = 1;
            renderStudentsTable();
        }

        function getFilteredStudents() {
            const searchTerm = document.getElementById('searchStudent')?.value?.toLowerCase() || '';
            let filtered = students;
            if (currentFilter !== 'all') filtered = filtered.filter(s => s.status === currentFilter);
            if (searchTerm) filtered = filtered.filter(s => s.name.toLowerCase().includes(searchTerm) || s.parentName.toLowerCase().includes(searchTerm) || s.parentPhone.includes(searchTerm));
            return filtered;
        }

        function renderStudentsTable() {
            const filtered = getFilteredStudents();
            const { data, total, totalPages, currentPage } = getPaginatedData(filtered, 'students');
            const tbody = document.getElementById('studentsTableBody');

            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7"><div class="empty-state"><div class="empty-state-icon">ğŸ“‹</div><p>KhÃ´ng cÃ³ dá»¯ liá»‡u</p></div></td></tr>`;
                renderPagination('studentsPagination', 'students', 0, 0, 1);
                return;
            }

            tbody.innerHTML = data.map(s => `
        <tr>
            <td><strong>${s.name}</strong></td>
            <td>${s.age}</td>
            <td>${s.parentName}</td>
            <td>${s.parentPhone}</td>
            <td>${s.subjects.map(sub => `<span class="subject-tag">${sub}</span>`).join('')}</td>
            <td>${getStatusBadge(s.status)}</td>
            <td><div class="action-buttons">${getStudentActionButtons(s)}</div></td>
        </tr>
    `).join('');

            renderPagination('studentsPagination', 'students', total, totalPages, currentPage);
        }

        function getStatusBadge(status) {
            const badges = {
                'Há»c Thá»­': '<span class="status-badge hoc-thu">ğŸ†• Há»c Thá»­</span>',
                'Chá» ÄÄƒng KÃ½': '<span class="status-badge cho-dk">â³ Chá» ÄK</span>',
                'ÄÃ£ ÄÄƒng KÃ½': '<span class="status-badge da-dk">âœ… ÄÃ£ ÄK</span>',
                'HoÃ n ThÃ nh': '<span class="status-badge hoan-thanh">ğŸ“ HoÃ n ThÃ nh</span>',
                'Cancel': '<span class="status-badge cancel">âŒ Cancel</span>'
            };
            return badges[status] || status;
        }

        function getStudentActionButtons(student) {
            const id = student.id;
            let btns = [`<button class="action-btn view" onclick="viewStudent('${id}')" title="Xem">ğŸ‘ï¸</button>`];

            if (canEdit('students')) {
                btns.push(`<button class="action-btn edit" onclick="editStudent('${id}')" title="Sá»­a">âœï¸</button>`);
            }

            if (student.status === 'Há»c Thá»­' && canCreate('appointments')) {
                btns.push(`<button class="action-btn schedule" onclick="openAppointmentModalForStudent('${id}')" title="Äáº·t lá»‹ch">ğŸ“…</button>`);
            }

            if (student.status === 'Chá» ÄÄƒng KÃ½' && canCreate('registrations')) {
                btns.push(`<button class="action-btn receipt" onclick="openRegistrationModalForStudent('${id}')" title="Táº¡o Phiáº¿u ÄK">ğŸ“‹</button>`);
            }

            if (student.status === 'ÄÃ£ ÄÄƒng KÃ½' && canCreate('receipts')) {
                btns.push(`<button class="action-btn receipt" onclick="openReceiptModalForStudent('${id}')" title="Táº¡o BiÃªn Lai">ğŸ§¾</button>`);
            }

            if (canDelete('students')) {
                btns.push(`<button class="action-btn delete" onclick="deleteStudent('${id}')" title="XÃ³a">ğŸ—‘ï¸</button>`);
            }

            return btns.join('');
        }

        function viewStudent(id) {
            const student = students.find(s => s.id === id);
            if (!student) return;

            const studentAppointments = appointments.filter(a => a.studentId === id);
            const studentRegistrations = registrations.filter(r => r.studentId === id);
            const studentReceipts = receipts.filter(r => r.studentId === id);

            document.getElementById('quickViewContent').innerHTML = `
        <div class="quick-view-section">
            <h4>ğŸ‘¤ ThÃ´ng Tin Há»c ViÃªn</h4>
            <div class="quick-view-row"><span class="quick-view-label">TÃªn:</span><span class="quick-view-value"><strong>${student.name}</strong></span></div>
            <div class="quick-view-row"><span class="quick-view-label">Tuá»•i:</span><span class="quick-view-value">${student.age}</span></div>
            <div class="quick-view-row"><span class="quick-view-label">Phá»¥ huynh:</span><span class="quick-view-value">${student.parentName}</span></div>
            <div class="quick-view-row"><span class="quick-view-label">SÄT:</span><span class="quick-view-value">${student.parentPhone}</span></div>
            <div class="quick-view-row"><span class="quick-view-label">MÃ´n há»c:</span><span class="quick-view-value">${student.subjects.map(s => `<span class="subject-tag">${s}</span>`).join('')}</span></div>
            <div class="quick-view-row"><span class="quick-view-label">Tráº¡ng thÃ¡i:</span><span class="quick-view-value">${getStatusBadge(student.status)}</span></div>
        </div>
        <div class="quick-view-section">
            <h4>ğŸ“… Lá»‹ch Háº¹n (${studentAppointments.length})</h4>
            ${studentAppointments.length === 0 ? '<p class="text-muted">ChÆ°a cÃ³</p>' : studentAppointments.map(a => `<div class="quick-view-row"><span class="quick-view-label">${formatDate(a.date)} ${a.time}</span><span class="quick-view-value">${a.subject}</span></div>`).join('')}
        </div>
        <div class="quick-view-section">
            <h4>ğŸ“‹ Phiáº¿u ÄK (${studentRegistrations.length})</h4>
            ${studentRegistrations.length === 0 ? '<p class="text-muted">ChÆ°a cÃ³</p>' : studentRegistrations.map(r => `<div class="quick-view-row"><span class="quick-view-label">${r.regCode}</span><span class="quick-view-value">${formatCurrency(r.finalAmount)}</span></div>`).join('')}
        </div>
        <div class="quick-view-section">
            <h4>ğŸ§¾ BiÃªn Lai (${studentReceipts.length})</h4>
            ${studentReceipts.length === 0 ? '<p class="text-muted">ChÆ°a cÃ³</p>' : studentReceipts.map(r => `<div class="quick-view-row"><span class="quick-view-label">${formatDate(r.date)}</span><span class="quick-view-value">${formatCurrency(r.amount)}</span></div>`).join('')}
        </div>
    `;
            openModal('quickViewModal');
        }

        function cancelStudent(id) {
            const student = students.find(s => s.id === id);
            if (!student || !confirm(`Cancel "${student.name}"?`)) return;
            student.previousStatus = student.status;
            student.status = 'Cancel';
            saveData('students', students);
            showNotification('ÄÃ£ cancel!', 'warning');
            renderAll();
        }

        function restoreStudent(id) {
            const student = students.find(s => s.id === id);
            if (!student || !student.previousStatus) return;
            if (!confirm(`KhÃ´i phá»¥c "${student.name}"?`)) return;
            student.status = student.previousStatus;
            student.previousStatus = null;
            saveData('students', students);
            showNotification('ÄÃ£ khÃ´i phá»¥c!');
            renderAll();
        }

        function confirmTrialCompleted(id) {
            const student = students.find(s => s.id === id);
            if (!student || student.status !== 'Há»c Thá»­') return;
            if (!confirm(`XÃ¡c nháº­n "${student.name}" Ä‘Ã£ há»c thá»­ xong?`)) return;
            student.status = 'Chá» ÄÄƒng KÃ½';
            saveData('students', students);
            showNotification('ÄÃ£ chuyá»ƒn sang Chá» ÄÄƒng KÃ½!');
            renderAll();
        }

        /* ============================================================
           ğŸ“ PHáº¦N 10: Há»ŒC THá»¬
           ============================================================ */

        function updateTrialCounts() {
            const trial = students.filter(s => s.status === 'Há»c Thá»­' || s.status === 'Chá» ÄÄƒng KÃ½');
            document.getElementById('trialCountAll').textContent = trial.length;
            document.getElementById('trialCountHocThu').textContent = students.filter(s => s.status === 'Há»c Thá»­').length;
            document.getElementById('trialCountChoDangKy').textContent = students.filter(s => s.status === 'Chá» ÄÄƒng KÃ½').length;
        }

        function filterTrialStudents(status) {
            currentTrialFilter = status;
            paginationState.trial.page = 1;
            document.querySelectorAll('#trial .filter-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.filter === status));
            renderTrialStudentsTable();
        }

        function searchTrialStudents() {
            paginationState.trial.page = 1;
            renderTrialStudentsTable();
        }

        function getFilteredTrialStudents() {
            const searchTerm = document.getElementById('searchTrialStudent')?.value?.toLowerCase() || '';
            let filtered = students.filter(s => s.status === 'Há»c Thá»­' || s.status === 'Chá» ÄÄƒng KÃ½');
            if (currentTrialFilter !== 'all') filtered = filtered.filter(s => s.status === currentTrialFilter);
            if (searchTerm) filtered = filtered.filter(s => s.name.toLowerCase().includes(searchTerm) || s.parentPhone.includes(searchTerm));
            return filtered;
        }

        function renderTrialStudentsTable() {
            const filtered = getFilteredTrialStudents();
            const { data, total, totalPages, currentPage } = getPaginatedData(filtered, 'trial');
            const tbody = document.getElementById('trialStudentsTableBody');

            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8"><div class="empty-state"><div class="empty-state-icon">ğŸ“</div><p>KhÃ´ng cÃ³ dá»¯ liá»‡u</p></div></td></tr>`;
                renderPagination('trialPagination', 'trial', 0, 0, 1);
                return;
            }

            tbody.innerHTML = data.map(s => {
                const apt = appointments.find(a => a.studentId === s.id && new Date(a.date + ' ' + a.time) >= new Date());
                return `
            <tr>
                <td><strong>${s.name}</strong></td>
                <td>${s.age}</td>
                <td>${s.parentName}</td>
                <td>${s.parentPhone}</td>
                <td>${s.subjects.map(sub => `<span class="subject-tag">${sub}</span>`).join('')}</td>
                <td>${getStatusBadge(s.status)}</td>
                <td>${apt ? `<span class="text-success">${formatDate(apt.date)} ${apt.time}</span>` : '<span class="text-muted">-</span>'}</td>
                <td><div class="action-buttons">${getTrialActionButtons(s)}</div></td>
            </tr>
        `;
            }).join('');

            renderPagination('trialPagination', 'trial', total, totalPages, currentPage);
        }

        function getTrialActionButtons(student) {
            const id = student.id;
            let btns = [`<button class="action-btn view" onclick="viewStudent('${id}')" title="Xem">ğŸ‘ï¸</button>`];

            if (student.status === 'Há»c Thá»­') {
                if (canCreate('appointments')) {
                    btns.push(`<button class="action-btn schedule" onclick="openAppointmentModalForStudent('${id}')" title="Äáº·t lá»‹ch">ğŸ“…</button>`);
                }
                if (canEdit('trial')) {
                    btns.push(`<button class="action-btn edit" onclick="confirmTrialCompleted('${id}')" title="XÃ¡c nháº­n HT">âœ…</button>`);
                }
            } else if (student.status === 'Chá» ÄÄƒng KÃ½') {
                if (canCreate('registrations')) {
                    btns.push(`<button class="action-btn receipt" onclick="openRegistrationModalForStudent('${id}')" title="Táº¡o Phiáº¿u ÄK">ğŸ“‹</button>`);
                }
            }
            return btns.join('');
        }

        /* ============================================================
           ğŸ“… PHáº¦N 11: Lá»ŠCH Háº¸N (TÃ³m táº¯t - giá»¯ nguyÃªn logic cÅ©)
           ============================================================ */

        function openNewAppointmentModal() {
            document.getElementById('editAppointmentId').value = '';
            document.getElementById('appointmentStudentId').value = '';
            document.getElementById('appointmentForm').reset();
            document.getElementById('appointmentModalTitle').textContent = 'ğŸ“… ThÃªm Lá»‹ch Háº¹n';
            document.getElementById('appointmentDate').min = new Date().toISOString().split('T')[0];
            populateAppointmentStudentDropdown();
            openModal('appointmentModal');
        }

        function openAppointmentModalForStudent(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;

            document.getElementById('editAppointmentId').value = '';
            document.getElementById('appointmentStudentId').value = studentId;
            document.getElementById('appointmentForm').reset();
            document.getElementById('appointmentModalTitle').textContent = 'ğŸ“… Äáº·t Lá»‹ch Háº¹n';
            document.getElementById('appointmentDate').min = new Date().toISOString().split('T')[0];

            populateAppointmentStudentDropdown();
            document.getElementById('appointmentStudentSelect').value = studentId;
            onAppointmentStudentChange();
            openModal('appointmentModal');
        }

        function populateAppointmentStudentDropdown() {
            const eligible = students.filter(s => s.status === 'Há»c Thá»­' || s.status === 'Chá» ÄÄƒng KÃ½');
            document.getElementById('appointmentStudentSelect').innerHTML = '<option value="">-- Chá»n há»c viÃªn --</option>' +
                eligible.map(s => `<option value="${s.id}">${s.name} - ${s.parentPhone}</option>`).join('');
        }

        /* ============================================================
        ğŸ“… TASK 2.4: Sá»¬A BUG Cáº¢NH BÃO TRÃ™NG Lá»ŠCH Háº¸N
        ============================================================ */

        // HÃ m kiá»ƒm tra trÃ¹ng lá»‹ch háº¹n
        function checkAppointmentConflict(studentId, date, time, excludeId = null) {
            if (!studentId || !date || !time) return null;

            // TÃ¬m cÃ¡c lá»‹ch háº¹n cá»§a há»c viÃªn nÃ y
            const studentAppointments = appointments.filter(a =>
                a.studentId === studentId &&
                a.id !== excludeId
            );

            // Kiá»ƒm tra trÃ¹ng ngÃ y
            const sameDateAppointments = studentAppointments.filter(a => a.date === date);

            if (sameDateAppointments.length > 0) {
                // Kiá»ƒm tra trÃ¹ng giá» (trong khoáº£ng 2 tiáº¿ng)
                const inputTime = time.split(':').map(Number);
                const inputMinutes = inputTime[0] * 60 + inputTime[1];

                for (const apt of sameDateAppointments) {
                    const aptTime = apt.time.split(':').map(Number);
                    const aptMinutes = aptTime[0] * 60 + aptTime[1];

                    // Náº¿u cÃ¡ch nhau dÆ°á»›i 2 tiáº¿ng â†’ cáº£nh bÃ¡o
                    if (Math.abs(inputMinutes - aptMinutes) < 120) {
                        return {
                            type: 'same_day',
                            appointment: apt,
                            message: `âš ï¸ Há»c viÃªn nÃ y Ä‘Ã£ cÃ³ lá»‹ch háº¹n vÃ o ${formatDate(apt.date)} lÃºc ${apt.time} (${apt.subject})`
                        };
                    }
                }

                // CÃ¹ng ngÃ y nhÆ°ng khÃ¡c giá» xa
                return {
                    type: 'same_day_different_time',
                    appointment: sameDateAppointments[0],
                    message: `â„¹ï¸ Há»c viÃªn nÃ y Ä‘Ã£ cÃ³ lá»‹ch háº¹n khÃ¡c vÃ o ngÃ y ${formatDate(date)}`
                };
            }

            return null;
        }

        // HÃ m hiá»ƒn thá»‹ cáº£nh bÃ¡o trÃ¹ng lá»‹ch
        function showAppointmentConflictWarning() {
            const studentId = document.getElementById('appointmentStudentId').value ||
                document.getElementById('appointmentStudentSelect').value;
            const date = document.getElementById('appointmentDate').value;
            const time = document.getElementById('appointmentTime').value;
            const editId = document.getElementById('editAppointmentId').value;

            const warningDiv = document.getElementById('appointmentConflictWarning');

            const conflict = checkAppointmentConflict(studentId, date, time, editId);

            if (conflict) {
                warningDiv.innerHTML = `
                    <span style="font-size: 14px;">${conflict.message}</span>
                    <br><small class="text-muted">Báº¡n váº«n cÃ³ thá»ƒ lÆ°u lá»‹ch háº¹n nÃ y.</small>
                `;
                warningDiv.classList.remove('d-none');

                // Äá»•i mÃ u theo má»©c Ä‘á»™
                if (conflict.type === 'same_day') {
                    warningDiv.style.borderLeftColor = '#E74C3C';
                    warningDiv.style.background = '#FDEDEC';
                } else {
                    warningDiv.style.borderLeftColor = '#F39C12';
                    warningDiv.style.background = '#FEF5E7';
                }
            } else {
                warningDiv.classList.add('d-none');
            }
        }

        // Cáº­p nháº­t hÃ m onAppointmentStudentChange
        function onAppointmentStudentChange() {
            const studentId = document.getElementById('appointmentStudentSelect').value;
            const student = students.find(s => s.id === studentId);
            document.getElementById('appointmentStudentId').value = studentId;

            if (student) {
                document.getElementById('appointmentSubject').innerHTML = '<option value="">-- Chá»n mÃ´n --</option>' +
                    student.subjects.map(s => `<option value="${s}">${s}</option>`).join('');
            }

            // Kiá»ƒm tra trÃ¹ng lá»‹ch
            showAppointmentConflictWarning();
        }

        // ThÃªm event listeners cho date vÃ  time
        document.addEventListener('DOMContentLoaded', function () {
            const dateInput = document.getElementById('appointmentDate');
            const timeInput = document.getElementById('appointmentTime');

            if (dateInput) {
                dateInput.addEventListener('change', showAppointmentConflictWarning);
            }
            if (timeInput) {
                timeInput.addEventListener('change', showAppointmentConflictWarning);
            }
        });


        function saveAppointment(event) {
            event.preventDefault();

            const studentId = document.getElementById('appointmentStudentId').value;
            if (!studentId) { showNotification('Vui lÃ²ng chá»n há»c viÃªn!', 'error'); return; }

            const editId = document.getElementById('editAppointmentId').value;
            const data = {
                studentId,
                subject: document.getElementById('appointmentSubject').value,
                date: document.getElementById('appointmentDate').value,
                time: document.getElementById('appointmentTime').value,
                notes: document.getElementById('appointmentNotes').value.trim()
            };

            if (editId) {
                const index = appointments.findIndex(a => a.id === editId);
                if (index !== -1) appointments[index] = { ...appointments[index], ...data };
                showNotification('Cáº­p nháº­t thÃ nh cÃ´ng!');
            } else {
                appointments.push({ id: generateId(), ...data, createdAt: new Date().toISOString() });
                showNotification('ThÃªm lá»‹ch háº¹n thÃ nh cÃ´ng!');
            }

            saveData('appointments', appointments);
            closeModal('appointmentModal');
            renderAll();
        }

        function filterAppointments(filter) {
            currentAppointmentFilter = filter;
            paginationState.appointments.page = 1;
            document.querySelectorAll('#appointments .filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderAppointmentsTable();
        }

        function searchAppointments() {
            paginationState.appointments.page = 1;
            renderAppointmentsTable();
        }

        function getFilteredAppointments() {
            const searchTerm = document.getElementById('searchAppointment')?.value?.toLowerCase() || '';
            const now = new Date();
            let filtered = [...appointments];

            if (currentAppointmentFilter === 'upcoming') filtered = filtered.filter(a => new Date(a.date + ' ' + a.time) >= now);
            else if (currentAppointmentFilter === 'past') filtered = filtered.filter(a => new Date(a.date + ' ' + a.time) < now);

            if (searchTerm) {
                filtered = filtered.filter(a => {
                    const student = students.find(s => s.id === a.studentId);
                    return a.subject.toLowerCase().includes(searchTerm) || student?.name.toLowerCase().includes(searchTerm);
                });
            }
            return filtered.sort((a, b) => new Date(b.date + ' ' + b.time) - new Date(a.date + ' ' + a.time));
        }

        function renderAppointmentsTable() {
            const filtered = getFilteredAppointments();
            const { data, total, totalPages, currentPage } = getPaginatedData(filtered, 'appointments');
            const tbody = document.getElementById('appointmentsTableBody');
            const now = new Date();

            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8"><div class="empty-state"><div class="empty-state-icon">ğŸ“…</div><p>KhÃ´ng cÃ³ lá»‹ch háº¹n</p></div></td></tr>`;
                renderPagination('appointmentsPagination', 'appointments', 0, 0, 1);
                return;
            }

            tbody.innerHTML = data.map(a => {
                const student = students.find(s => s.id === a.studentId);
                const isPast = new Date(a.date + ' ' + a.time) < now;
                return `
            <tr style="${isPast ? 'opacity: 0.6;' : ''}">
                <td><strong>${student?.name || 'N/A'}</strong></td>
                <td>${student?.parentName || ''}</td>
                <td>${student?.parentPhone || ''}</td>
                <td><span class="subject-tag">${a.subject}</span></td>
                <td>${formatDate(a.date)}</td>
                <td><strong>${a.time}</strong></td>
                <td>${isPast ? '<span class="text-muted">ÄÃ£ qua</span>' : '<span class="text-success">Sáº¯p tá»›i</span>'}</td>
                <td>
                    <div class="action-buttons">
                        ${canEdit('appointments') ? `<button class="action-btn edit" onclick="editAppointment('${a.id}')" title="Sá»­a">âœï¸</button>` : ''}
                        ${canDelete('appointments') ? `<button class="action-btn delete" onclick="deleteAppointment('${a.id}')" title="XÃ³a">ğŸ—‘ï¸</button>` : ''}
                    </div>
                </td>
            </tr>
        `;
            }).join('');

            renderPagination('appointmentsPagination', 'appointments', total, totalPages, currentPage);
        }

        function editAppointment(id) {
            const apt = appointments.find(a => a.id === id);
            if (!apt) return;
            const student = students.find(s => s.id === apt.studentId);

            document.getElementById('editAppointmentId').value = apt.id;
            document.getElementById('appointmentStudentId').value = apt.studentId;
            populateAppointmentStudentDropdown();
            document.getElementById('appointmentStudentSelect').value = apt.studentId;

            if (student) {
                document.getElementById('appointmentSubject').innerHTML = '<option value="">-- Chá»n mÃ´n --</option>' +
                    student.subjects.map(s => `<option value="${s}" ${s === apt.subject ? 'selected' : ''}>${s}</option>`).join('');
            }

            document.getElementById('appointmentDate').value = apt.date;
            document.getElementById('appointmentTime').value = apt.time;
            document.getElementById('appointmentNotes').value = apt.notes || '';
            document.getElementById('appointmentModalTitle').textContent = 'âœï¸ Sá»­a Lá»‹ch Háº¹n';
            openModal('appointmentModal');
        }

        function deleteAppointment(id) {
            if (!confirm('XÃ³a lá»‹ch háº¹n nÃ y?')) return;
            appointments = appointments.filter(a => a.id !== id);
            saveData('appointments', appointments);
            showNotification('ÄÃ£ xÃ³a!');
            renderAll();
        }

        /* ============================================================
        ğŸ“‹ TASK 2.6: Sá»¬A BUG EDIT REGISTRATION ID
        ============================================================ */

        // ===== Má» MODAL Táº O PHIáº¾U ÄK Má»šI =====
        function openNewRegistrationModal() {
            // Reset táº¥t cáº£
            document.getElementById('regStudentId').value = '';
            document.getElementById('editRegId').value = '';
            document.getElementById('registrationForm').reset();

            // Reset tiÃªu Ä‘á»
            const modalTitle = document.querySelector('#registrationModal .modal-header h2');
            if (modalTitle) modalTitle.textContent = 'ğŸ“‹ Táº¡o Phiáº¿u ÄÄƒng KÃ½';

            // Populate dropdowns
            populateRegStudentDropdown();
            renderPromotionCheckboxes();

            // Set ngÃ y Ä‘Äƒng kÃ½ máº·c Ä‘á»‹nh lÃ  hÃ´m nay
            document.getElementById('regDate').value = new Date().toISOString().split('T')[0];

            // Reset cÃ¡c trÆ°á»ng má»›i
            document.getElementById('regTotalSessions').value = '';
            document.getElementById('regStartDate').value = '';
            document.getElementById('regNotes').value = '';

            // Reset gÃ³i há»c phÃ­
            document.getElementById('regPackage').innerHTML = '<option value="">-- Chá»n gÃ³i --</option>';

            openModal('registrationModal');
        }



        // ===== Má» MODAL Táº O PHIáº¾U ÄK CHO Há»ŒC VIÃŠN Cá»¤ THá»‚ =====
        function openRegistrationModalForStudent(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;

            // Reset form
            document.getElementById('editRegId').value = '';
            document.getElementById('registrationForm').reset();

            // Set há»c viÃªn
            document.getElementById('regStudentId').value = studentId;
            populateRegStudentDropdown();
            document.getElementById('regStudentSelect').value = studentId;
            onRegStudentChange();

            // Populate khuyáº¿n mÃ£i
            renderPromotionCheckboxes();

            // Set ngÃ y Ä‘Äƒng kÃ½ máº·c Ä‘á»‹nh
            document.getElementById('regDate').value = new Date().toISOString().split('T')[0];

            // Reset cÃ¡c trÆ°á»ng má»›i
            document.getElementById('regTotalSessions').value = '';
            document.getElementById('regStartDate').value = '';
            document.getElementById('regNotes').value = '';

            // Reset tiÃªu Ä‘á»
            const modalTitle = document.querySelector('#registrationModal .modal-header h2');
            if (modalTitle) modalTitle.textContent = 'ğŸ“‹ Táº¡o Phiáº¿u ÄÄƒng KÃ½';

            openModal('registrationModal');
        }


        function populateRegStudentDropdown() {
            const eligible = students.filter(s => s.status === 'Chá» ÄÄƒng KÃ½');
            document.getElementById('regStudentSelect').innerHTML = '<option value="">-- Chá»n há»c viÃªn --</option>' +
                eligible.map(s => `<option value="${s.id}">${s.name} - ${s.parentPhone}</option>`).join('');
        }

        function onRegStudentChange() {
            const studentId = document.getElementById('regStudentSelect').value;
            const student = students.find(s => s.id === studentId);
            document.getElementById('regStudentId').value = studentId;
            if (student) {
                document.getElementById('regSubject').innerHTML = '<option value="">-- Chá»n mÃ´n --</option>' +
                    student.subjects.map(s => `<option value="${s}">${s}</option>`).join('');
            }
        }

        // ===== LOAD GÃ“I Há»ŒC PHÃ THEO MÃ”N - Cáº¬P NHáº¬T =====
        function loadPackagesForSubject() {
            const subject = document.getElementById('regSubject').value;
            const packageSelect = document.getElementById('regPackage');
            const sessionsInput = document.getElementById('regTotalSessions');
            const feeInput = document.getElementById('regTuitionFee');

            // Lá»c gÃ³i theo mÃ´n
            const subjectPackages = packages.filter(p => p.subjectName === subject);

            // Populate dropdown gÃ³i - Báº®T BUá»˜C CHá»ŒN GÃ“I
            packageSelect.innerHTML = '<option value="">-- Chá»n gÃ³i --</option>' +
                subjectPackages.map(p => `<option value="${p.id}">${p.name} - ${p.sessions} buá»•i - ${formatCurrency(p.fee)}</option>`).join('');

            // Náº¿u khÃ´ng cÃ³ gÃ³i cho mÃ´n nÃ y, láº¥y há»c phÃ­ máº·c Ä‘á»‹nh tá»« mÃ´n há»c
            if (subjectPackages.length === 0) {
                const subjectInfo = subjects.find(s => s.name === subject);
                if (subjectInfo) {
                    feeInput.value = formatNumberInput(subjectInfo.defaultFee);
                    sessionsInput.value = 8; // Máº·c Ä‘á»‹nh 8 buá»•i náº¿u khÃ´ng cÃ³ gÃ³i
                }
                showNotification('MÃ´n nÃ y chÆ°a cÃ³ gÃ³i há»c phÃ­. Vui lÃ²ng táº¡o gÃ³i trong Danh má»¥c!', 'warning');
            } else {
                // Reset sá»‘ buá»•i vÃ  há»c phÃ­ khi Ä‘á»•i mÃ´n
                sessionsInput.value = '';
                feeInput.value = '';
            }

            calculateFinalAmount();
        }


        // ===== ÃP Dá»¤NG GÃ“I Há»ŒC PHÃ - Cáº¬P NHáº¬T =====
        function applyPackageFee() {
            const pkgId = document.getElementById('regPackage').value;
            const pkg = packages.find(p => p.id === pkgId);

            if (pkg) {
                // Tá»± Ä‘á»™ng Ä‘iá»n sá»‘ buá»•i tá»« gÃ³i
                document.getElementById('regTotalSessions').value = pkg.sessions;

                // Tá»± Ä‘á»™ng Ä‘iá»n há»c phÃ­ tá»« gÃ³i
                document.getElementById('regTuitionFee').value = formatNumberInput(pkg.fee);

                calculateFinalAmount();
            } else {
                // Reset náº¿u khÃ´ng chá»n gÃ³i
                document.getElementById('regTotalSessions').value = '';
                document.getElementById('regTuitionFee').value = '';
                calculateFinalAmount();
            }
        }


        function renderPromotionCheckboxes() {
            const now = new Date();
            const active = promotions.filter(p => new Date(p.endDate) >= now);
            document.getElementById('regPromotionList').innerHTML = active.length === 0
                ? '<p class="text-muted">KhÃ´ng cÃ³ KM</p>'
                : active.map(p => `<label class="checkbox-item"><input type="checkbox" name="regPromotions" value="${p.id}" onchange="calculateFinalAmount()"> ${p.name} (${p.type === 'percent' ? p.value + '%' : formatCurrency(p.value)})</label>`).join('');
        }

        function calculateFinalAmount() {
            const tuition = parseCurrencyInput(document.getElementById('regTuitionFee').value);
            const selectedPromos = Array.from(document.querySelectorAll('input[name="regPromotions"]:checked')).map(cb => promotions.find(p => p.id === cb.value)).filter(p => p);

            let discount = 0;
            selectedPromos.forEach(p => { discount += p.type === 'percent' ? tuition * p.value / 100 : p.value; });

            const final = Math.max(tuition - discount, 0);
            document.getElementById('regDiscountAmount').value = discount > 0 ? '-' + formatCurrency(discount) : '';
            document.getElementById('regFinalAmount').value = formatCurrency(final);
        }

        // ===== LÆ¯U PHIáº¾U ÄÄ‚NG KÃ - Cáº¬P NHáº¬T Äáº¦Y Äá»¦ =====
        function saveRegistration(event) {
            event.preventDefault();

            const editId = document.getElementById('editRegId')?.value;
            const studentId = document.getElementById('regStudentId').value;

            // Validation
            if (!studentId) {
                showNotification('Vui lÃ²ng chá»n há»c viÃªn!', 'error');
                return;
            }

            const packageId = document.getElementById('regPackage').value;
            if (!packageId) {
                showNotification('Vui lÃ²ng chá»n gÃ³i há»c phÃ­!', 'error');
                return;
            }

            const totalSessions = parseInt(document.getElementById('regTotalSessions').value);
            if (!totalSessions || totalSessions < 1) {
                showNotification('Vui lÃ²ng nháº­p sá»‘ buá»•i há»c há»£p lá»‡!', 'error');
                return;
            }

            const student = students.find(s => s.id === studentId);
            const tuition = parseCurrencyInput(document.getElementById('regTuitionFee').value);

            if (tuition <= 0) {
                showNotification('Há»c phÃ­ pháº£i lá»›n hÆ¡n 0!', 'error');
                return;
            }

            // TÃ­nh giáº£m giÃ¡ tá»« khuyáº¿n mÃ£i
            const selectedPromoIds = Array.from(document.querySelectorAll('input[name="regPromotions"]:checked')).map(cb => cb.value);
            let discount = 0;
            selectedPromoIds.forEach(promoId => {
                const promo = promotions.find(p => p.id === promoId);
                if (promo) {
                    discount += promo.type === 'percent' ? tuition * promo.value / 100 : promo.value;
                }
            });

            const finalAmount = Math.max(tuition - discount, 0);

            // Láº¥y cÃ¡c trÆ°á»ng má»›i
            const startDate = document.getElementById('regStartDate').value || null;
            const regDate = document.getElementById('regDate').value || new Date().toISOString().split('T')[0];
            const notes = document.getElementById('regNotes').value.trim();

            // Táº¡o object dá»¯ liá»‡u
            const regData = {
                studentId,
                studentName: student ? student.name : '',
                parentName: student ? student.parentName : '',
                parentPhone: student ? student.parentPhone : '',
                subject: document.getElementById('regSubject').value,
                packageId: packageId,
                totalSessions: totalSessions,           // TRÆ¯á»œNG Má»šI
                startDate: startDate,                   // TRÆ¯á»œNG Má»šI
                tuitionFee: tuition,
                promotionIds: selectedPromoIds,
                discountAmount: discount,
                finalAmount,
                registrationDate: regDate,
                notes: notes                            // TRÆ¯á»œNG Má»šI
            };

            if (editId) {
                // Cáº¬P NHáº¬T phiáº¿u Ä‘Äƒng kÃ½
                const index = registrations.findIndex(r => r.id === editId);
                if (index !== -1) {
                    registrations[index] = {
                        ...registrations[index],
                        ...regData,
                        updatedAt: new Date().toISOString()
                    };
                    showNotification('Cáº­p nháº­t phiáº¿u ÄK thÃ nh cÃ´ng!', 'success');
                }
                document.getElementById('editRegId').value = '';
            } else {
                // THÃŠM Má»šI phiáº¿u Ä‘Äƒng kÃ½
                const regCode = generateRegCode();
                registrations.push({
                    id: generateId(),
                    regCode,
                    ...regData,
                    createdAt: new Date().toISOString()
                });

                // Cáº­p nháº­t tráº¡ng thÃ¡i há»c viÃªn
                if (student && student.status === 'Chá» ÄÄƒng KÃ½') {
                    student.status = 'ÄÃ£ ÄÄƒng KÃ½';
                    saveData('students', students);
                }

                showNotification(`Táº¡o phiáº¿u ÄK thÃ nh cÃ´ng! MÃ£: ${regCode}`, 'success');
            }

            saveData('registrations', registrations);
            closeModal('registrationModal');

            // Reset tiÃªu Ä‘á» modal
            const modalTitle = document.querySelector('#registrationModal .modal-header h2');
            if (modalTitle) modalTitle.textContent = 'ğŸ“‹ Táº¡o Phiáº¿u ÄÄƒng KÃ½';

            renderAll();
        }


        function searchRegistrations() { paginationState.registrations.page = 1; renderRegistrationsTable(); }

        function getFilteredRegistrations() {
            const searchTerm = document.getElementById('searchRegistration')?.value?.toLowerCase() || '';
            let filtered = [...registrations];
            if (searchTerm) filtered = filtered.filter(r => r.regCode.toLowerCase().includes(searchTerm) || r.studentName?.toLowerCase().includes(searchTerm));
            return filtered.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        }

        // ===== RENDER Báº¢NG PHIáº¾U ÄK - Cáº¬P NHáº¬T HIá»‚N THá»Š Sá» BUá»”I =====
        function renderRegistrationsTable() {
            const filtered = getFilteredRegistrations();
            const { data, total, totalPages, currentPage } = getPaginatedData(filtered, 'registrations');
            const tbody = document.getElementById('registrationsTableBody');

            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8"><div class="empty-state"><div class="empty-state-icon">ğŸ“‹</div><p>KhÃ´ng cÃ³ phiáº¿u ÄK</p></div></td></tr>`;
                renderPagination('registrationsPagination', 'registrations', 0, 0, 1);
                return;
            }

            tbody.innerHTML = data.map(r => {
                const pkg = r.packageId ? packages.find(p => p.id === r.packageId) : null;
                const sessionsDisplay = r.totalSessions ? `${r.totalSessions} buá»•i` : (pkg ? `${pkg.sessions} buá»•i` : '-');

                return `
                    <tr>
                        <td><strong class="text-primary">${r.regCode}</strong></td>
                        <td>
                            <strong>${r.studentName || 'N/A'}</strong>
                            ${r.startDate ? `<br><small class="text-muted">Báº¯t Ä‘áº§u: ${formatDate(r.startDate)}</small>` : ''}
                        </td>
                        <td>
                            <span class="subject-tag">${r.subject}</span><br>
                            <small class="text-muted">${pkg ? pkg.name : 'GÃ³i tÃ¹y chá»‰nh'}</small>
                        </td>
                        <td><strong>${sessionsDisplay}</strong></td>
                        <td>
                            ${formatCurrency(r.tuitionFee)}
                            ${r.discountAmount > 0 ? `<br><small class="text-danger">-${formatCurrency(r.discountAmount)}</small>` : ''}
                        </td>
                        <td><strong class="text-success">${formatCurrency(r.finalAmount)}</strong></td>
                        <td>${formatDate(r.registrationDate)}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="action-btn view" onclick="viewRegistration('${r.id}')" title="Xem & In">ğŸ‘ï¸</button>
                                ${canEdit('registrations') ? `<button class="action-btn edit" onclick="editRegistration('${r.id}')" title="Sá»­a">âœï¸</button>` : ''}
                                ${canDelete('registrations') ? `<button class="action-btn delete" onclick="deleteRegistration('${r.id}')" title="XÃ³a">ğŸ—‘ï¸</button>` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            renderPagination('registrationsPagination', 'registrations', total, totalPages, currentPage);
        }


        function viewRegistration(id) {
            const reg = registrations.find(r => r.id === id);
            if (!reg) return;
            document.getElementById('registrationPreviewContent').innerHTML = `<div style="text-align:center;padding:20px;"><h3>${reg.regCode}</h3><p>${reg.studentName} - ${reg.subject}</p><p><strong>${formatCurrency(reg.finalAmount)}</strong></p></div>`;
            openModal('viewRegistrationModal');
        }

        function deleteRegistration(id) {
            if (!confirm('XÃ³a phiáº¿u ÄK nÃ y?')) return;
            registrations = registrations.filter(r => r.id !== id);
            saveData('registrations', registrations);
            showNotification('ÄÃ£ xÃ³a!');
            renderRegistrationsTable();
        }

        function printRegistration() { window.print(); }
        function downloadRegistrationPDF() { showNotification('Äang táº£i PDF...', 'info'); }

        // ===== RECEIPTS =====
        function openReceiptModal() {
            document.getElementById('editReceiptId').value = '';
            document.getElementById('receiptForm').reset();
            document.getElementById('receiptDate').value = new Date().toISOString().split('T')[0];
            populateReceiptStudentDropdown();
            openModal('receiptModal');
        }

        function openReceiptModalForStudent(studentId) {
            openReceiptModal();
            document.getElementById('receiptStudentId').value = studentId;
            fillReceiptStudentInfo();
        }

        function populateReceiptStudentDropdown() {
            const eligible = students.filter(s => s.status === 'ÄÃ£ ÄÄƒng KÃ½');
            document.getElementById('receiptStudentId').innerHTML = '<option value="">-- Chá»n há»c viÃªn --</option>' +
                eligible.map(s => `<option value="${s.id}">${s.name} - ${s.parentPhone}</option>`).join('');
        }

        function fillReceiptStudentInfo() {
            const studentId = document.getElementById('receiptStudentId').value;
            const student = students.find(s => s.id === studentId);
            document.getElementById('receiptParentName').value = student?.parentName || '';
            document.getElementById('receiptParentPhone').value = student?.parentPhone || '';

            if (studentId) {
                const studentRegs = registrations.filter(r => r.studentId === studentId);
                document.getElementById('receiptRegistrationSelect').innerHTML = '<option value="">-- Chá»n phiáº¿u ÄK --</option>' +
                    studentRegs.map(r => `<option value="${r.id}">${r.regCode} - ${formatCurrency(r.finalAmount)}</option>`).join('');
            }
        }

        function fillFromRegistration() {
            const regId = document.getElementById('receiptRegistrationSelect').value;
            const reg = registrations.find(r => r.id === regId);
            if (reg) {
                document.getElementById('receiptDescription').value = `Há»c phÃ­ ${reg.subject}`;
                document.getElementById('receiptAmount').value = formatNumberInput(reg.finalAmount);
            }
        }

        /* ============================================================
        ğŸ§¾ TASK 2.5: Sá»¬A BUG Táº O MÃƒ BIÃŠN LAI
        ============================================================ */

        function saveReceipt(event) {
            event.preventDefault();

            const studentId = document.getElementById('receiptStudentId').value;
            const student = students.find(s => s.id === studentId);
            const editId = document.getElementById('editReceiptId').value;

            const data = {
                studentId,
                type: document.getElementById('receiptType').value,
                parentName: student?.parentName || '',
                parentPhone: student?.parentPhone || '',
                registrationId: document.getElementById('receiptRegistrationSelect')?.value || null,
                description: document.getElementById('receiptDescription').value.trim(),
                amount: parseCurrencyInput(document.getElementById('receiptAmount').value),
                date: document.getElementById('receiptDate').value,
                notes: document.getElementById('receiptNotes').value.trim()
            };

            // Validation
            if (!studentId) {
                showNotification('Vui lÃ²ng chá»n há»c viÃªn!', 'error');
                return;
            }

            if (!data.type) {
                showNotification('Vui lÃ²ng chá»n loáº¡i biÃªn lai!', 'error');
                return;
            }

            if (data.amount <= 0) {
                showNotification('Sá»‘ tiá»n pháº£i lá»›n hÆ¡n 0!', 'error');
                return;
            }

            if (editId) {
                // Cáº¬P NHáº¬T - Giá»¯ nguyÃªn receiptCode cÅ©
                const index = receipts.findIndex(r => r.id === editId);
                if (index !== -1) {
                    receipts[index] = {
                        ...receipts[index],
                        ...data,
                        // QUAN TRá»ŒNG: Giá»¯ nguyÃªn receiptCode cÅ©
                        receiptCode: receipts[index].receiptCode,
                        updatedAt: new Date().toISOString()
                    };
                    showNotification('Cáº­p nháº­t biÃªn lai thÃ nh cÃ´ng!', 'success');
                }
            } else {
                // THÃŠM Má»šI - Táº¡o receiptCode má»›i
                const newReceipt = {
                    id: generateId(),
                    receiptCode: generateReceiptCode(), // Táº¡o mÃ£ má»›i
                    ...data,
                    createdBy: currentUser?.id || null,
                    createdAt: new Date().toISOString()
                };
                receipts.push(newReceipt);
                showNotification('Táº¡o biÃªn lai thÃ nh cÃ´ng!', 'success');
            }

            saveData('receipts', receipts);
            closeModal('receiptModal');

            // Reset form title
            const modalTitle = document.querySelector('#receiptModal .modal-header h2');
            if (modalTitle) modalTitle.textContent = 'ğŸ§¾ Táº¡o BiÃªn Lai';

            renderAll();
        }



        function searchReceipts() { paginationState.receipts.page = 1; renderReceiptsTable(); }

        function getFilteredReceipts() {
            const searchTerm = document.getElementById('searchReceipt')?.value?.toLowerCase() || '';
            let filtered = [...receipts];
            if (searchTerm) {
                filtered = filtered.filter(r => {
                    const student = students.find(s => s.id === r.studentId);
                    return r.description.toLowerCase().includes(searchTerm) || student?.name.toLowerCase().includes(searchTerm);
                });
            }
            return filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
        }

        function renderReceiptsTable() {
            const filtered = getFilteredReceipts();
            const { data, total, totalPages, currentPage } = getPaginatedData(filtered, 'receipts');
            const tbody = document.getElementById('receiptsTableBody');

            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7"><div class="empty-state"><div class="empty-state-icon">ğŸ§¾</div><p>KhÃ´ng cÃ³ biÃªn lai</p></div></td></tr>`;
                renderPagination('receiptsPagination', 'receipts', 0, 0, 1);
                return;
            }

            tbody.innerHTML = data.map((r, idx) => {
                const student = students.find(s => s.id === r.studentId);
                return `
            <tr>
                <td><strong>#${String(total - idx).padStart(4, '0')}</strong></td>
                <td><span class="subject-tag">${r.type}</span></td>
                <td>${student?.name || 'N/A'}</td>
                <td>${r.description}</td>
                <td><strong class="text-success">${formatCurrency(r.amount)}</strong></td>
                <td>${formatDate(r.date)}</td>
                <td><div class="action-buttons">
                    <button class="action-btn view" onclick="viewReceipt('${r.id}')" title="Xem">ğŸ‘ï¸</button>
                    ${canDelete('receipts') ? `<button class="action-btn delete" onclick="deleteReceipt('${r.id}')" title="XÃ³a">ğŸ—‘ï¸</button>` : ''}
                </div></td>
            </tr>
        `;
            }).join('');

            renderPagination('receiptsPagination', 'receipts', total, totalPages, currentPage);
        }

        function viewReceipt(id) {
            const receipt = receipts.find(r => r.id === id);
            if (!receipt) return;
            document.getElementById('receiptPreviewContent').innerHTML = `<div style="text-align:center;padding:20px;"><h3>${receipt.type}</h3><p>${receipt.description}</p><p><strong>${formatCurrency(receipt.amount)}</strong></p></div>`;
            openModal('viewReceiptModal');
        }

        function deleteReceipt(id) {
            if (!confirm('XÃ³a biÃªn lai nÃ y?')) return;
            receipts = receipts.filter(r => r.id !== id);
            saveData('receipts', receipts);
            showNotification('ÄÃ£ xÃ³a!');
            renderReceiptsTable();
        }

        function printReceipt() { window.print(); }
        function downloadReceiptPDF() { showNotification('Äang táº£i PDF...', 'info'); }

        // ===== SUBJECTS, PACKAGES, PROMOTIONS =====
        function renderSubjectsTable() {
            const tbody = document.getElementById('subjectsTableBody');
            tbody.innerHTML = subjects.map(s => `
        <tr>
            <td style="font-size: 24px;">${s.icon}</td>
            <td><strong>${s.name}</strong></td>
            <td>${formatCurrency(s.defaultFee)}</td>
            <td><div class="action-buttons">
                ${canEdit('subjects') ? `<button class="action-btn edit" onclick="editSubject('${s.id}')" title="Sá»­a">âœï¸</button>` : ''}
                ${canDelete('subjects') ? `<button class="action-btn delete" onclick="deleteSubject('${s.id}')" title="XÃ³a">ğŸ—‘ï¸</button>` : ''}
            </div></td>
        </tr>
    `).join('');
        }

        function openSubjectModal() {
            document.getElementById('editSubjectId').value = '';
            document.getElementById('subjectForm').reset();
            document.getElementById('subjectModalTitle').textContent = 'ğŸ“– ThÃªm MÃ´n Há»c';
            openModal('subjectModal');
        }

        function editSubject(id) {
            const s = subjects.find(s => s.id === id);
            if (!s) return;
            document.getElementById('editSubjectId').value = s.id;
            document.getElementById('subjectIcon').value = s.icon;
            document.getElementById('subjectName').value = s.name;
            document.getElementById('subjectDefaultFee').value = formatNumberInput(s.defaultFee);
            document.getElementById('subjectModalTitle').textContent = 'âœï¸ Sá»­a MÃ´n Há»c';
            openModal('subjectModal');
        }

        function saveSubject(event) {
            event.preventDefault();
            const editId = document.getElementById('editSubjectId').value;
            const data = { icon: document.getElementById('subjectIcon').value.trim(), name: document.getElementById('subjectName').value.trim(), defaultFee: parseCurrencyInput(document.getElementById('subjectDefaultFee').value) };

            if (editId) {
                const idx = subjects.findIndex(s => s.id === editId);
                if (idx !== -1) subjects[idx] = { ...subjects[idx], ...data };
                showNotification('Cáº­p nháº­t thÃ nh cÃ´ng!');
            } else {
                subjects.push({ id: generateId(), ...data });
                showNotification('ThÃªm thÃ nh cÃ´ng!');
            }
            saveData('subjects', subjects);
            closeModal('subjectModal');
            renderSubjectsTable();
            renderSubjectCheckboxes();
        }

        function deleteSubject(id) {
            if (!confirm('XÃ³a mÃ´n há»c nÃ y?')) return;
            subjects = subjects.filter(s => s.id !== id);
            saveData('subjects', subjects);
            showNotification('ÄÃ£ xÃ³a!');
            renderSubjectsTable();
        }

        function renderPackagesTable() {
            const tbody = document.getElementById('packagesTableBody');
            tbody.innerHTML = packages.length === 0 ? `<tr><td colspan="5"><div class="empty-state"><p>ChÆ°a cÃ³ gÃ³i</p></div></td></tr>` : packages.map(p => `
        <tr>
            <td><strong>${p.name}</strong></td>
            <td>${p.subjectName}</td>
            <td>${p.sessions} buá»•i</td>
            <td>${formatCurrency(p.fee)}</td>
            <td><div class="action-buttons">
                ${canEdit('packages') ? `<button class="action-btn edit" onclick="editPackage('${p.id}')" title="Sá»­a">âœï¸</button>` : ''}
                ${canDelete('packages') ? `<button class="action-btn delete" onclick="deletePackage('${p.id}')" title="XÃ³a">ğŸ—‘ï¸</button>` : ''}
            </div></td>
        </tr>
    `).join('');
        }

        function openPackageModal() {
            document.getElementById('editPackageId').value = '';
            document.getElementById('packageForm').reset();
            document.getElementById('packageModalTitle').textContent = 'ğŸ“¦ ThÃªm GÃ³i';
            document.getElementById('packageSubject').innerHTML = '<option value="">-- Chá»n mÃ´n --</option>' + subjects.map(s => `<option value="${s.name}">${s.icon} ${s.name}</option>`).join('');
            openModal('packageModal');
        }

        function editPackage(id) {
            const p = packages.find(p => p.id === id);
            if (!p) return;
            document.getElementById('editPackageId').value = p.id;
            document.getElementById('packageName').value = p.name;
            document.getElementById('packageSubject').innerHTML = '<option value="">-- Chá»n mÃ´n --</option>' + subjects.map(s => `<option value="${s.name}" ${s.name === p.subjectName ? 'selected' : ''}>${s.icon} ${s.name}</option>`).join('');
            document.getElementById('packageSessions').value = p.sessions;
            document.getElementById('packageFee').value = formatNumberInput(p.fee);
            document.getElementById('packageModalTitle').textContent = 'âœï¸ Sá»­a GÃ³i';
            openModal('packageModal');
        }

        function savePackage(event) {
            event.preventDefault();
            const editId = document.getElementById('editPackageId').value;
            const data = { name: document.getElementById('packageName').value.trim(), subjectName: document.getElementById('packageSubject').value, sessions: parseInt(document.getElementById('packageSessions').value), fee: parseCurrencyInput(document.getElementById('packageFee').value) };

            if (editId) {
                const idx = packages.findIndex(p => p.id === editId);
                if (idx !== -1) packages[idx] = { ...packages[idx], ...data };
            } else {
                packages.push({ id: generateId(), ...data });
            }
            saveData('packages', packages);
            closeModal('packageModal');
            showNotification('LÆ°u thÃ nh cÃ´ng!');
            renderPackagesTable();
        }

        function deletePackage(id) {
            if (!confirm('XÃ³a gÃ³i nÃ y?')) return;
            packages = packages.filter(p => p.id !== id);
            saveData('packages', packages);
            showNotification('ÄÃ£ xÃ³a!');
            renderPackagesTable();
        }

        function renderPromotionsTable() {
            const now = new Date();
            const tbody = document.getElementById('promotionsTableBody');
            tbody.innerHTML = promotions.length === 0 ? `<tr><td colspan="6"><div class="empty-state"><p>ChÆ°a cÃ³ KM</p></div></td></tr>` : promotions.map(p => {
                const expired = new Date(p.endDate) < now;
                return `
            <tr style="${expired ? 'opacity: 0.5;' : ''}">
                <td><strong>${p.name}</strong></td>
                <td>${p.type === 'percent' ? 'Giáº£m %' : 'Giáº£m VNÄ'}</td>
                <td>${p.type === 'percent' ? p.value + '%' : formatCurrency(p.value)}</td>
                <td>${formatDate(p.startDate)} - ${formatDate(p.endDate)}</td>
                <td>${expired ? '<span class="text-danger">Háº¿t háº¡n</span>' : '<span class="text-success">Hoáº¡t Ä‘á»™ng</span>'}</td>
                <td><div class="action-buttons">
                    ${canEdit('promotions') ? `<button class="action-btn edit" onclick="editPromotion('${p.id}')" title="Sá»­a">âœï¸</button>` : ''}
                    ${canDelete('promotions') ? `<button class="action-btn delete" onclick="deletePromotion('${p.id}')" title="XÃ³a">ğŸ—‘ï¸</button>` : ''}
                </div></td>
            </tr>
        `;
            }).join('');
        }

        function openPromotionModal() {
            document.getElementById('editPromotionId').value = '';
            document.getElementById('promotionForm').reset();
            document.getElementById('promotionModalTitle').textContent = 'ğŸ ThÃªm KM';
            document.getElementById('promotionStartDate').value = new Date().toISOString().split('T')[0];
            openModal('promotionModal');
        }

        function editPromotion(id) {
            const p = promotions.find(p => p.id === id);
            if (!p) return;
            document.getElementById('editPromotionId').value = p.id;
            document.getElementById('promotionName').value = p.name;
            document.getElementById('promotionType').value = p.type;
            document.getElementById('promotionValue').value = p.value;
            document.getElementById('promotionStartDate').value = p.startDate;
            document.getElementById('promotionEndDate').value = p.endDate;
            document.getElementById('promotionModalTitle').textContent = 'âœï¸ Sá»­a KM';
            openModal('promotionModal');
        }

        function savePromotion(event) {
            event.preventDefault();
            const editId = document.getElementById('editPromotionId').value;
            const data = { name: document.getElementById('promotionName').value.trim(), type: document.getElementById('promotionType').value, value: parseFloat(document.getElementById('promotionValue').value), startDate: document.getElementById('promotionStartDate').value, endDate: document.getElementById('promotionEndDate').value };

            if (editId) {
                const idx = promotions.findIndex(p => p.id === editId);
                if (idx !== -1) promotions[idx] = { ...promotions[idx], ...data };
            } else {
                promotions.push({ id: generateId(), ...data });
            }
            saveData('promotions', promotions);
            closeModal('promotionModal');
            showNotification('LÆ°u thÃ nh cÃ´ng!');
            renderPromotionsTable();
        }

        function deletePromotion(id) {
            if (!confirm('XÃ³a KM nÃ y?')) return;
            promotions = promotions.filter(p => p.id !== id);
            saveData('promotions', promotions);
            showNotification('ÄÃ£ xÃ³a!');
            renderPromotionsTable();
        }

        /* ============================================================
           ğŸ“¤ PHáº¦N 17: EXPORT & BACKUP
           ============================================================ */

        /* ============================================================
        ğŸ“¤ TASK 2.9: THÃŠM TRY-CATCH CHO EXPORT
        ============================================================ */

        function exportAllToExcel() {
            try {
                if (typeof XLSX === 'undefined') {
                    throw new Error('ThÆ° viá»‡n XLSX chÆ°a Ä‘Æ°á»£c táº£i!');
                }

                const wb = XLSX.utils.book_new();

                // Sheet Há»c viÃªn
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(students.map(s => ({
                    'TÃªn': s.name,
                    'Tuá»•i': s.age,
                    'Phá»¥ huynh': s.parentName,
                    'SÄT': s.parentPhone,
                    'Email': s.parentEmail || '',
                    'MÃ´n há»c': s.subjects.join(', '),
                    'Tráº¡ng thÃ¡i': s.status,
                    'NgÃ y táº¡o': s.createdAt ? formatDate(s.createdAt.split('T')[0]) : ''
                }))), 'Há»c ViÃªn');

                // Sheet Phiáº¿u ÄK
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(registrations.map(r => ({
                    'MÃ£ phiáº¿u': r.regCode,
                    'Há»c viÃªn': r.studentName,
                    'MÃ´n': r.subject,
                    'Sá»‘ buá»•i': r.totalSessions || '-',
                    'Há»c phÃ­': r.tuitionFee,
                    'Giáº£m': r.discountAmount,
                    'ThÃ nh tiá»n': r.finalAmount,
                    'NgÃ y ÄK': formatDate(r.registrationDate)
                }))), 'Phiáº¿u ÄK');

                // Sheet BiÃªn lai
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(receipts.map(r => ({
                    'MÃ£ BL': r.receiptCode || '',
                    'Loáº¡i': r.type,
                    'Há»c viÃªn': students.find(s => s.id === r.studentId)?.name || '',
                    'Ná»™i dung': r.description,
                    'Sá»‘ tiá»n': r.amount,
                    'NgÃ y': formatDate(r.date)
                }))), 'BiÃªn Lai');

                // Sheet GiÃ¡o viÃªn
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(teachers.map(t => ({
                    'Há» tÃªn': t.fullName,
                    'SÄT': t.phone,
                    'Email': t.email || '',
                    'MÃ´n dáº¡y': t.subjects.join(', '),
                    'Loáº¡i lÆ°Æ¡ng': t.salaryType,
                    'Tráº¡ng thÃ¡i': t.status === 'active' ? 'Äang dáº¡y' : 'Nghá»‰'
                }))), 'GiÃ¡o ViÃªn');

                // Sheet Lá»›p há»c
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(classes.map(c => {
                    const subject = subjects.find(s => s.id === c.subjectId);
                    const teacher = teachers.find(t => t.id === c.teacherId);
                    return {
                        'TÃªn lá»›p': c.className,
                        'MÃ´n há»c': subject ? subject.name : '',
                        'GiÃ¡o viÃªn': teacher ? teacher.fullName : '',
                        'Loáº¡i': c.classType === 'group' ? 'NhÃ³m' : '1-1',
                        'SÄ© sá»‘ tá»‘i Ä‘a': c.maxStudents,
                        'Tráº¡ng thÃ¡i': c.status
                    };
                })), 'Lá»›p Há»c');

                XLSX.writeFile(wb, `BaoCao_${formatDateFile()}.xlsx`);
                showNotification('âœ… Xuáº¥t Excel thÃ nh cÃ´ng!', 'success');

            } catch (error) {
                console.error('Lá»—i export Excel:', error);
                showNotification('âŒ Lá»—i xuáº¥t Excel: ' + error.message, 'error');
            }
        }

        function exportStudentsToExcel() {
            try {
                if (typeof XLSX === 'undefined') {
                    throw new Error('ThÆ° viá»‡n XLSX chÆ°a Ä‘Æ°á»£c táº£i!');
                }

                if (students.length === 0) {
                    showNotification('KhÃ´ng cÃ³ dá»¯ liá»‡u Ä‘á»ƒ xuáº¥t!', 'warning');
                    return;
                }

                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(students.map(s => ({
                    'TÃªn': s.name,
                    'Tuá»•i': s.age,
                    'Phá»¥ huynh': s.parentName,
                    'SÄT': s.parentPhone,
                    'Email': s.parentEmail || '',
                    'MÃ´n há»c': s.subjects.join(', '),
                    'Tráº¡ng thÃ¡i': s.status,
                    'Ghi chÃº': s.notes || ''
                }))), 'Há»c ViÃªn');
                XLSX.writeFile(wb, `HocVien_${formatDateFile()}.xlsx`);
                showNotification('âœ… Xuáº¥t thÃ nh cÃ´ng!', 'success');

            } catch (error) {
                console.error('Lá»—i export:', error);
                showNotification('âŒ Lá»—i: ' + error.message, 'error');
            }
        }

        function exportTrialStudentsToExcel() {
            try {
                if (typeof XLSX === 'undefined') {
                    throw new Error('ThÆ° viá»‡n XLSX chÆ°a Ä‘Æ°á»£c táº£i!');
                }

                const data = students.filter(s => s.status === 'Há»c Thá»­' || s.status === 'Chá» ÄÄƒng KÃ½');

                if (data.length === 0) {
                    showNotification('KhÃ´ng cÃ³ dá»¯ liá»‡u Ä‘á»ƒ xuáº¥t!', 'warning');
                    return;
                }

                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data.map(s => ({
                    'TÃªn': s.name,
                    'Tuá»•i': s.age,
                    'Phá»¥ huynh': s.parentName,
                    'SÄT': s.parentPhone,
                    'MÃ´n há»c': s.subjects.join(', '),
                    'Tráº¡ng thÃ¡i': s.status
                }))), 'Há»c Thá»­');
                XLSX.writeFile(wb, `HocThu_${formatDateFile()}.xlsx`);
                showNotification('âœ… Xuáº¥t thÃ nh cÃ´ng!', 'success');

            } catch (error) {
                console.error('Lá»—i export:', error);
                showNotification('âŒ Lá»—i: ' + error.message, 'error');
            }
        }

        function exportAppointmentsToExcel() {
            try {
                if (typeof XLSX === 'undefined') {
                    throw new Error('ThÆ° viá»‡n XLSX chÆ°a Ä‘Æ°á»£c táº£i!');
                }

                if (appointments.length === 0) {
                    showNotification('KhÃ´ng cÃ³ dá»¯ liá»‡u Ä‘á»ƒ xuáº¥t!', 'warning');
                    return;
                }

                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(appointments.map(a => {
                    const s = students.find(st => st.id === a.studentId);
                    return {
                        'Há»c viÃªn': s?.name || '',
                        'Phá»¥ huynh': s?.parentName || '',
                        'SÄT': s?.parentPhone || '',
                        'MÃ´n': a.subject,
                        'NgÃ y': formatDate(a.date),
                        'Giá»': a.time,
                        'Ghi chÃº': a.notes || ''
                    };
                })), 'Lá»‹ch Háº¹n');
                XLSX.writeFile(wb, `LichHen_${formatDateFile()}.xlsx`);
                showNotification('âœ… Xuáº¥t thÃ nh cÃ´ng!', 'success');

            } catch (error) {
                console.error('Lá»—i export:', error);
                showNotification('âŒ Lá»—i: ' + error.message, 'error');
            }
        }

        function exportRegistrationsToExcel() {
            try {
                if (typeof XLSX === 'undefined') {
                    throw new Error('ThÆ° viá»‡n XLSX chÆ°a Ä‘Æ°á»£c táº£i!');
                }

                if (registrations.length === 0) {
                    showNotification('KhÃ´ng cÃ³ dá»¯ liá»‡u Ä‘á»ƒ xuáº¥t!', 'warning');
                    return;
                }

                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(registrations.map(r => ({
                    'MÃ£ phiáº¿u': r.regCode,
                    'Há»c viÃªn': r.studentName,
                    'MÃ´n': r.subject,
                    'Sá»‘ buá»•i': r.totalSessions || '-',
                    'Há»c phÃ­': r.tuitionFee,
                    'Giáº£m': r.discountAmount,
                    'ThÃ nh tiá»n': r.finalAmount,
                    'NgÃ y ÄK': formatDate(r.registrationDate),
                    'NgÃ y báº¯t Ä‘áº§u': r.startDate ? formatDate(r.startDate) : '',
                    'Ghi chÃº': r.notes || ''
                }))), 'Phiáº¿u ÄK');
                XLSX.writeFile(wb, `PhieuDK_${formatDateFile()}.xlsx`);
                showNotification('âœ… Xuáº¥t thÃ nh cÃ´ng!', 'success');

            } catch (error) {
                console.error('Lá»—i export:', error);
                showNotification('âŒ Lá»—i: ' + error.message, 'error');
            }
        }

        function exportReceiptsToExcel() {
            try {
                if (typeof XLSX === 'undefined') {
                    throw new Error('ThÆ° viá»‡n XLSX chÆ°a Ä‘Æ°á»£c táº£i!');
                }

                if (receipts.length === 0) {
                    showNotification('KhÃ´ng cÃ³ dá»¯ liá»‡u Ä‘á»ƒ xuáº¥t!', 'warning');
                    return;
                }

                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(receipts.map(r => {
                    const student = students.find(s => s.id === r.studentId);
                    return {
                        'MÃ£ BL': r.receiptCode || '',
                        'Loáº¡i': r.type,
                        'Há»c viÃªn': student?.name || '',
                        'Phá»¥ huynh': r.parentName || '',
                        'SÄT': r.parentPhone || '',
                        'Ná»™i dung': r.description,
                        'Sá»‘ tiá»n': r.amount,
                        'NgÃ y': formatDate(r.date),
                        'Ghi chÃº': r.notes || ''
                    };
                })), 'BiÃªn Lai');
                XLSX.writeFile(wb, `BienLai_${formatDateFile()}.xlsx`);
                showNotification('âœ… Xuáº¥t thÃ nh cÃ´ng!', 'success');

            } catch (error) {
                console.error('Lá»—i export:', error);
                showNotification('âŒ Lá»—i: ' + error.message, 'error');
            }
        }

        function exportDebtsToExcel() {
            try {
                if (typeof XLSX === 'undefined') {
                    throw new Error('ThÆ° viá»‡n XLSX chÆ°a Ä‘Æ°á»£c táº£i!');
                }

                if (registrations.length === 0) {
                    showNotification('KhÃ´ng cÃ³ dá»¯ liá»‡u Ä‘á»ƒ xuáº¥t!', 'warning');
                    return;
                }

                const data = registrations.map(reg => {
                    const student = students.find(s => s.id === reg.studentId);
                    const debt = calculateDebtForRegistration(reg.id);
                    const cs = classStudents.find(c => c.registrationId === reg.id);

                    return {
                        'Há»c viÃªn': student ? student.name : '',
                        'SÄT': student ? student.parentPhone : '',
                        'MÃ£ Phiáº¿u ÄK': reg.regCode,
                        'MÃ´n há»c': reg.subject,
                        'Tá»•ng tiá»n': debt.totalAmount,
                        'ÄÃ£ Ä‘Ã³ng': debt.paidAmount,
                        'CÃ²n ná»£': debt.debtAmount,
                        'CÃ²n buá»•i': cs ? cs.remainingSessions : '',
                        'Tráº¡ng thÃ¡i': debt.debtAmount === 0 ? 'ÄÃ£ Ä‘Ã³ng Ä‘á»§' : debt.paidAmount > 0 ? 'ÄÃ³ng 1 pháº§n' : 'ChÆ°a Ä‘Ã³ng'
                    };
                });

                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data), 'CÃ´ng ná»£');
                XLSX.writeFile(wb, `CongNo_${formatDateFile()}.xlsx`);
                showNotification('âœ… Xuáº¥t Excel thÃ nh cÃ´ng!', 'success');

            } catch (error) {
                console.error('Lá»—i export:', error);
                showNotification('âŒ Lá»—i: ' + error.message, 'error');
            }
        }

        function exportBackupJSON() {
            try {
                const backup = {
                    version: '4.1',
                    exportDate: new Date().toISOString(),
                    data: {
                        users,
                        permissions,
                        students,
                        appointments,
                        registrations,
                        receipts,
                        subjects,
                        packages,
                        promotions,
                        teachers,
                        classes,
                        classSchedules,
                        classStudents,
                        attendances,
                        makeupRequests,
                        rooms,
                        centerInfo,
                        bankInfo,
                        warningSettings
                    }
                };

                const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `Backup_${formatDateFile()}.json`;
                a.click();

                showNotification('âœ… Táº£i backup thÃ nh cÃ´ng!', 'success');

            } catch (error) {
                console.error('Lá»—i backup:', error);
                showNotification('âŒ Lá»—i: ' + error.message, 'error');
            }
        }


        function exportStudentsToExcel() {
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(students.map(s => ({ TÃªn: s.name, Tuá»•i: s.age, 'Phá»¥ huynh': s.parentName, SÄT: s.parentPhone, Email: s.parentEmail || '', 'MÃ´n há»c': s.subjects.join(', '), 'Tráº¡ng thÃ¡i': s.status }))), 'Há»c ViÃªn');
            XLSX.writeFile(wb, `HocVien_${formatDateFile()}.xlsx`);
            showNotification('Xuáº¥t thÃ nh cÃ´ng!');
        }

        function exportTrialStudentsToExcel() {
            const data = students.filter(s => s.status === 'Há»c Thá»­' || s.status === 'Chá» ÄÄƒng KÃ½');
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data.map(s => ({ TÃªn: s.name, Tuá»•i: s.age, 'Phá»¥ huynh': s.parentName, SÄT: s.parentPhone, 'MÃ´n há»c': s.subjects.join(', '), 'Tráº¡ng thÃ¡i': s.status }))), 'Há»c Thá»­');
            XLSX.writeFile(wb, `HocThu_${formatDateFile()}.xlsx`);
            showNotification('Xuáº¥t thÃ nh cÃ´ng!');
        }

        function exportAppointmentsToExcel() {
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(appointments.map(a => { const s = students.find(st => st.id === a.studentId); return { 'Há»c viÃªn': s?.name || '', MÃ´n: a.subject, NgÃ y: a.date, Giá»: a.time }; })), 'Lá»‹ch Háº¹n');
            XLSX.writeFile(wb, `LichHen_${formatDateFile()}.xlsx`);
            showNotification('Xuáº¥t thÃ nh cÃ´ng!');
        }

        function exportRegistrationsToExcel() {
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(registrations.map(r => ({ 'MÃ£ phiáº¿u': r.regCode, 'Há»c viÃªn': r.studentName, MÃ´n: r.subject, 'Há»c phÃ­': r.tuitionFee, 'Giáº£m': r.discountAmount, 'ThÃ nh tiá»n': r.finalAmount, NgÃ y: r.registrationDate }))), 'Phiáº¿u ÄK');
            XLSX.writeFile(wb, `PhieuDK_${formatDateFile()}.xlsx`);
            showNotification('Xuáº¥t thÃ nh cÃ´ng!');
        }

        function exportReceiptsToExcel() {
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(receipts.map(r => ({ Loáº¡i: r.type, 'Ná»™i dung': r.description, 'Sá»‘ tiá»n': r.amount, NgÃ y: r.date }))), 'BiÃªn Lai');
            XLSX.writeFile(wb, `BienLai_${formatDateFile()}.xlsx`);
            showNotification('Xuáº¥t thÃ nh cÃ´ng!');
        }

        function exportBackupJSON() {
            const backup = { version: '4.0', exportDate: new Date().toISOString(), data: { users, permissions, students, appointments, registrations, receipts, subjects, packages, promotions, centerInfo, bankInfo } };
            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `Backup_${formatDateFile()}.json`; a.click();
            showNotification('Táº£i backup thÃ nh cÃ´ng!');
        }

        function restoreFromJSON(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const backup = JSON.parse(e.target.result);
                    if (!backup.data) throw new Error('File khÃ´ng há»£p lá»‡!');
                    if (!confirm('Ghi Ä‘Ã¨ toÃ n bá»™ dá»¯ liá»‡u?')) return;

                    if (backup.data.users) { users = backup.data.users; saveData('users', users); }
                    if (backup.data.permissions) { permissions = backup.data.permissions; saveData('permissions', permissions); }
                    students = backup.data.students || [];
                    appointments = backup.data.appointments || [];
                    registrations = backup.data.registrations || [];
                    receipts = backup.data.receipts || [];
                    subjects = backup.data.subjects || subjects;
                    packages = backup.data.packages || [];
                    promotions = backup.data.promotions || [];
                    centerInfo = backup.data.centerInfo || {};
                    bankInfo = backup.data.bankInfo || {};

                    ['students', 'appointments', 'registrations', 'receipts', 'subjects', 'packages', 'promotions'].forEach(key => saveData(key, eval(key)));
                    saveData('centerInfo', centerInfo);
                    saveData('bankInfo', bankInfo);

                    renderAll();
                    showNotification('KhÃ´i phá»¥c thÃ nh cÃ´ng!');
                } catch (err) { showNotification('Lá»—i: ' + err.message, 'error'); }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function importFromExcel(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const wb = XLSX.read(e.target.result, { type: 'binary' });
                    const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                    if (!confirm(`Import ${data.length} dÃ²ng?`)) return;

                    data.forEach(row => {
                        if (!students.find(s => s.parentPhone === row['SÄT'])) {
                            students.push({
                                id: generateId(), name: row['TÃªn'] || '', age: parseInt(row['Tuá»•i']) || 0,
                                parentName: row['Phá»¥ huynh'] || '', parentPhone: row['SÄT'] || '', parentEmail: row['Email'] || '',
                                subjects: (row['MÃ´n há»c'] || '').split(',').map(s => s.trim()).filter(s => s),
                                status: row['Tráº¡ng thÃ¡i'] || 'Há»c Thá»­', notes: '', previousStatus: null,
                                createdAt: new Date().toISOString(), updatedAt: new Date().toISOString()
                            });
                        }
                    });
                    saveData('students', students);
                    renderAll();
                    showNotification('Import thÃ nh cÃ´ng!');
                } catch (err) { showNotification('Lá»—i: ' + err.message, 'error'); }
            };
            reader.readAsBinaryString(file);
            event.target.value = '';
        }

        function createAutoBackup() {
            const backup = { id: generateId(), date: new Date().toISOString(), type: 'auto', data: { students, appointments, registrations, receipts, subjects, packages, promotions } };
            backupHistory.unshift(backup);
            if (backupHistory.length > 10) backupHistory = backupHistory.slice(0, 10);
            localStorage.setItem('backupHistory', JSON.stringify(backupHistory));
        }

        function createManualBackup() {
            const backup = { id: generateId(), date: new Date().toISOString(), type: 'manual', data: { students, appointments, registrations, receipts, subjects, packages, promotions } };
            backupHistory.unshift(backup);
            if (backupHistory.length > 10) backupHistory = backupHistory.slice(0, 10);
            localStorage.setItem('backupHistory', JSON.stringify(backupHistory));
            renderBackupHistory();
            showNotification('Backup thÃ nh cÃ´ng!');
        }

        function toggleAutoBackup() {
            autoBackupEnabled = document.getElementById('autoBackupToggle').checked;
            localStorage.setItem('autoBackupEnabled', autoBackupEnabled);
            updateAutoBackupStatus();
        }

        function updateAutoBackupStatus() {
            document.getElementById('autoBackupStatus').innerHTML = autoBackupEnabled ? '<span class="text-success">âœ… Äang hoáº¡t Ä‘á»™ng</span>' : '<span class="text-danger">âŒ ÄÃ£ táº¯t</span>';
        }

        function renderBackupHistory() {
            const container = document.getElementById('backupHistoryList');
            container.innerHTML = backupHistory.length === 0 ? '<p class="text-muted">ChÆ°a cÃ³ backup</p>' : backupHistory.slice(0, 5).map(b => `
        <div style="background: var(--bg-light); padding: 12px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
            <div><strong>${b.type === 'auto' ? 'ğŸ”„ Tá»± Ä‘á»™ng' : 'ğŸ’¾ Thá»§ cÃ´ng'}</strong><br><small class="text-muted">${new Date(b.date).toLocaleString('vi-VN')}</small></div>
            <button class="btn btn-sm btn-info" onclick="restoreFromBackupHistory('${b.id}')">KhÃ´i phá»¥c</button>
        </div>
    `).join('');
        }

        function restoreFromBackupHistory(id) {
            const backup = backupHistory.find(b => b.id === id);
            if (!backup || !confirm('KhÃ´i phá»¥c tá»« backup nÃ y?')) return;

            students = backup.data.students || [];
            appointments = backup.data.appointments || [];
            registrations = backup.data.registrations || [];
            receipts = backup.data.receipts || [];
            subjects = backup.data.subjects || subjects;
            packages = backup.data.packages || [];
            promotions = backup.data.promotions || [];

            ['students', 'appointments', 'registrations', 'receipts', 'subjects', 'packages', 'promotions'].forEach(key => saveData(key, eval(key)));
            renderAll();
            showNotification('KhÃ´i phá»¥c thÃ nh cÃ´ng!');
        }

        /* ============================================================
           âš™ï¸ PHáº¦N 18: SETTINGS
           ============================================================ */

        function saveCenterInfo(event) {
            event.preventDefault();
            centerInfo = { name: document.getElementById('centerName').value.trim(), phone: document.getElementById('centerPhone').value.trim(), address: document.getElementById('centerAddress').value.trim(), email: document.getElementById('centerEmail').value.trim(), website: document.getElementById('centerWebsite').value.trim(), logo: centerInfo.logo || '' };
            saveData('centerInfo', centerInfo);
            showNotification('LÆ°u thÃ nh cÃ´ng!');
        }

        function loadCenterInfo() {
            document.getElementById('centerName').value = centerInfo.name || '';
            document.getElementById('centerPhone').value = centerInfo.phone || '';
            document.getElementById('centerAddress').value = centerInfo.address || '';
            document.getElementById('centerEmail').value = centerInfo.email || '';
            document.getElementById('centerWebsite').value = centerInfo.website || '';
            if (centerInfo.logo) document.getElementById('logoPreview').innerHTML = `<img src="${centerInfo.logo}">`;
        }

        function previewLogo(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                centerInfo.logo = e.target.result;
                document.getElementById('logoPreview').innerHTML = `<img src="${e.target.result}">`;
            };
            reader.readAsDataURL(file);
        }

        function saveBankInfo(event) {
            event.preventDefault();
            bankInfo = { bankName: document.getElementById('bankName').value.trim(), accountNumber: document.getElementById('bankAccount').value.trim(), accountName: document.getElementById('bankAccountName').value.trim(), branch: document.getElementById('bankBranch').value.trim() };
            saveData('bankInfo', bankInfo);
            generateBankQR();
            showNotification('LÆ°u thÃ nh cÃ´ng!');
        }

        function loadBankInfo() {
            document.getElementById('bankName').value = bankInfo.bankName || '';
            document.getElementById('bankAccount').value = bankInfo.accountNumber || '';
            document.getElementById('bankAccountName').value = bankInfo.accountName || '';
            document.getElementById('bankBranch').value = bankInfo.branch || '';
            document.getElementById('autoBackupToggle').checked = autoBackupEnabled;
            updateAutoBackupStatus();
            generateBankQR();
        }

        function generateBankQR() {
            const container = document.getElementById('bankQRCode');
            if (!bankInfo.accountNumber || !bankInfo.bankName) {
                container.innerHTML = '<p class="text-muted">Nháº­p thÃ´ng tin ngÃ¢n hÃ ng Ä‘á»ƒ táº¡o QR</p>';
                return;
            }

            // Táº¡o ná»™i dung QR (VietQR format Ä‘Æ¡n giáº£n)
            const qrContent = `${bankInfo.bankName}|${bankInfo.accountNumber}|${bankInfo.accountName || ''}`;

            container.innerHTML = '';
            try {
                new QRCode(container, {
                    text: qrContent,
                    width: 150,
                    height: 150,
                    colorDark: '#2C3E50',
                    colorLight: '#ffffff'
                });
            } catch (e) {
                container.innerHTML = '<p class="text-muted">KhÃ´ng thá»ƒ táº¡o QR</p>';
            }
        }

        function clearAllData() {
            if (!confirm('âš ï¸ Cáº¢NH BÃO: XÃ³a TOÃ€N Bá»˜ dá»¯ liá»‡u?\n\nHÃ nh Ä‘á»™ng nÃ y KHÃ”NG THá»‚ hoÃ n tÃ¡c!\n\nBáº¡n cÃ³ cháº¯c cháº¯n?')) return;
            if (!confirm('XÃ¡c nháº­n láº§n cuá»‘i: XÃ“A Táº¤T Cáº¢?')) return;

            // XÃ³a Táº¤T Cáº¢ dá»¯ liá»‡u (giá»¯ láº¡i users vÃ  permissions)
            students = [];
            appointments = [];
            registrations = [];
            receipts = [];
            packages = [];
            promotions = [];
            backupHistory = [];

            // XÃ³a thÃªm pháº§n ÄÃ o táº¡o
            teachers = [];
            classes = [];
            classSchedules = [];
            classStudents = [];
            attendances = [];
            makeupRequests = [];

            // LÆ°u vÃ o localStorage
            const keysToReset = [
                'students', 'appointments', 'registrations', 'receipts',
                'packages', 'promotions', 'backupHistory',
                'teachers', 'classes', 'classSchedules', 'classStudents',
                'attendances', 'makeupRequests'
            ];

            keysToReset.forEach(key => {
                localStorage.setItem(key, JSON.stringify([]));
            });

            // Reset centerInfo vÃ  bankInfo
            centerInfo = {};
            bankInfo = {};
            localStorage.setItem('centerInfo', JSON.stringify({}));
            localStorage.setItem('bankInfo', JSON.stringify({}));

            showNotification('ÄÃ£ xÃ³a toÃ n bá»™ dá»¯ liá»‡u!', 'warning');
            renderAll();
        }

        function clearDemoData() {
            if (!confirm('âš ï¸ XÃ³a dá»¯ liá»‡u DEMO?\n\nSáº½ xÃ³a: Há»c viÃªn, Lá»‹ch háº¹n, Phiáº¿u ÄK, BiÃªn lai, GiÃ¡o viÃªn, Lá»›p há»c, Äiá»ƒm danh, Há»c bÃ¹.\n\nGiá»¯ láº¡i: TÃ i khoáº£n, PhÃ¢n quyá»n, MÃ´n há»c, CÃ i Ä‘áº·t.\n\nBáº¡n cÃ³ cháº¯c cháº¯n?')) return;

            // XÃ³a dá»¯ liá»‡u demo (giá»¯ láº¡i cáº¥u hÃ¬nh há»‡ thá»‘ng)
            students = [];
            appointments = [];
            registrations = [];
            receipts = [];

            // XÃ³a pháº§n ÄÃ o táº¡o
            teachers = [];
            classes = [];
            classSchedules = [];
            classStudents = [];
            attendances = [];
            makeupRequests = [];

            // LÆ°u vÃ o localStorage
            const keysToReset = [
                'students', 'appointments', 'registrations', 'receipts',
                'teachers', 'classes', 'classSchedules', 'classStudents',
                'attendances', 'makeupRequests'
            ];

            keysToReset.forEach(key => {
                localStorage.setItem(key, JSON.stringify([]));
            });

            showNotification('ÄÃ£ xÃ³a dá»¯ liá»‡u demo! Giá»¯ láº¡i: TÃ i khoáº£n, MÃ´n há»c, GÃ³i há»c phÃ­, Khuyáº¿n mÃ£i, CÃ i Ä‘áº·t.', 'success');
            renderAll();
        }

        /* ============================================================
        ğŸ² PHáº¦N 31: Táº O Dá»® LIá»†U DEMO
        ============================================================ */

        function generateDemoData() {
            if (!confirm('ğŸ² Táº¡o dá»¯ liá»‡u Demo?\n\nLÆ°u Ã½: Dá»¯ liá»‡u hiá»‡n táº¡i sáº½ Ä‘Æ°á»£c GIá»® NGUYÃŠN, dá»¯ liá»‡u demo sáº½ Ä‘Æ°á»£c THÃŠM VÃ€O.\n\nBáº¡n cÃ³ muá»‘n tiáº¿p tá»¥c?')) return;

            showNotification('Äang táº¡o dá»¯ liá»‡u demo...', 'info');

            try {
                // ===== 1. Táº O Há»ŒC VIÃŠN =====
                const demoStudents = [
                    { name: 'Nguyá»…n Minh Anh', age: 7, parentName: 'Nguyá»…n VÄƒn HÃ¹ng', parentPhone: '0901234001', parentEmail: 'hung.nv@gmail.com', subjects: ['Cá» Vua', 'Váº½ Tranh'], status: 'ÄÃ£ ÄÄƒng KÃ½', notes: 'BÃ© há»c nhanh, chÄƒm chá»‰' },
                    { name: 'Tráº§n Gia Báº£o', age: 8, parentName: 'Tráº§n Thá»‹ Mai', parentPhone: '0901234002', parentEmail: 'mai.tt@gmail.com', subjects: ['Cá» Vua'], status: 'ÄÃ£ ÄÄƒng KÃ½', notes: '' },
                    { name: 'LÃª Thá»‹ Cáº©m TÃº', age: 6, parentName: 'LÃª VÄƒn Nam', parentPhone: '0901234003', parentEmail: '', subjects: ['Váº½ Tranh', 'Tiá»n Tiá»ƒu Há»c'], status: 'ÄÃ£ ÄÄƒng KÃ½', notes: 'BÃ© thÃ­ch váº½' },
                    { name: 'Pháº¡m Äá»©c Duy', age: 9, parentName: 'Pháº¡m Thá»‹ Lan', parentPhone: '0901234004', parentEmail: 'lan.pt@gmail.com', subjects: ['Cá» Vua'], status: 'ÄÃ£ ÄÄƒng KÃ½', notes: '' },
                    { name: 'HoÃ ng Thá»‹ Mai', age: 5, parentName: 'HoÃ ng VÄƒn TÃ¹ng', parentPhone: '0901234005', parentEmail: '', subjects: ['Tiá»n Tiá»ƒu Há»c'], status: 'ÄÃ£ ÄÄƒng KÃ½', notes: 'Chuáº©n bá»‹ vÃ o lá»›p 1' },
                    { name: 'VÃµ Minh KhÃ´i', age: 7, parentName: 'VÃµ Thá»‹ HÆ°Æ¡ng', parentPhone: '0901234006', parentEmail: 'huong.vt@gmail.com', subjects: ['RÃ¨n Chá»¯', 'Tiá»n Tiá»ƒu Há»c'], status: 'ÄÃ£ ÄÄƒng KÃ½', notes: '' },
                    { name: 'Äáº·ng ThÃ¹y Linh', age: 8, parentName: 'Äáº·ng VÄƒn Phong', parentPhone: '0901234007', parentEmail: '', subjects: ['Váº½ Tranh'], status: 'Chá» ÄÄƒng KÃ½', notes: 'ÄÃ£ há»c thá»­, chá» Ä‘Ã³ng phÃ­' },
                    { name: 'BÃ¹i Quá»‘c Huy', age: 6, parentName: 'BÃ¹i Thá»‹ Nga', parentPhone: '0901234008', parentEmail: 'nga.bt@gmail.com', subjects: ['Cá» Vua'], status: 'Chá» ÄÄƒng KÃ½', notes: '' },
                    { name: 'NgÃ´ Thanh TÃ¢m', age: 7, parentName: 'NgÃ´ VÄƒn Äá»©c', parentPhone: '0901234009', parentEmail: '', subjects: ['Tiá»n Tiá»ƒu Há»c', 'RÃ¨n Chá»¯'], status: 'Há»c Thá»­', notes: 'Háº¹n há»c thá»­ ngÃ y mai' },
                    { name: 'Äinh Há»“ng Ngá»c', age: 5, parentName: 'Äinh Thá»‹ Tháº£o', parentPhone: '0901234010', parentEmail: 'thao.dt@gmail.com', subjects: ['Váº½ Tranh'], status: 'Há»c Thá»­', notes: '' },
                    { name: 'LÃ½ Minh PhÃºc', age: 8, parentName: 'LÃ½ VÄƒn BÃ¬nh', parentPhone: '0901234011', parentEmail: '', subjects: ['Cá» Vua'], status: 'Há»c Thá»­', notes: 'Báº¡n bÃ© Gia Báº£o giá»›i thiá»‡u' },
                    { name: 'TrÆ°Æ¡ng Thá»‹ Quá»³nh', age: 6, parentName: 'TrÆ°Æ¡ng VÄƒn Háº£i', parentPhone: '0901234012', parentEmail: 'hai.tv@gmail.com', subjects: ['Tiá»n Tiá»ƒu Há»c'], status: 'HoÃ n ThÃ nh', notes: 'ÄÃ£ hoÃ n thÃ nh khÃ³a' },
                    { name: 'Phan ÄÃ¬nh SÆ¡n', age: 9, parentName: 'Phan Thá»‹ Hoa', parentPhone: '0901234013', parentEmail: '', subjects: ['Cá» Vua', 'RÃ¨n Chá»¯'], status: 'HoÃ n ThÃ nh', notes: '' },
                    { name: 'Cao Thá»‹ UyÃªn', age: 7, parentName: 'Cao VÄƒn Long', parentPhone: '0901234014', parentEmail: 'long.cv@gmail.com', subjects: ['Váº½ Tranh'], status: 'Cancel', notes: 'Chuyá»ƒn nhÃ ' },
                    { name: 'Mai XuÃ¢n VÅ©', age: 6, parentName: 'Mai Thá»‹ Yáº¿n', parentPhone: '0901234015', parentEmail: '', subjects: ['Tiá»n Tiá»ƒu Há»c'], status: 'ÄÃ£ ÄÄƒng KÃ½', notes: '' }
                ];

                const studentIds = [];
                const today = new Date();

                demoStudents.forEach((s, index) => {
                    const createdDate = new Date(today);
                    createdDate.setDate(createdDate.getDate() - Math.floor(Math.random() * 60)); // Random trong 60 ngÃ y

                    const newStudent = {
                        id: 'demo_student_' + (index + 1),
                        ...s,
                        previousStatus: null,
                        createdAt: createdDate.toISOString(),
                        updatedAt: createdDate.toISOString()
                    };
                    students.push(newStudent);
                    studentIds.push(newStudent.id);
                });

                // ===== 2. Táº O GIÃO VIÃŠN =====
                const demoTeachers = [
                    { fullName: 'Nguyá»…n VÄƒn Minh', phone: '0911234001', email: 'minh.gv@gmail.com', subjects: ['Cá» Vua'], salaryType: 'per_session', fixedSalary: 0, perSessionRate: 200000 },
                    { fullName: 'Tráº§n Thá»‹ Há»“ng', phone: '0911234002', email: 'hong.gv@gmail.com', subjects: ['Váº½ Tranh'], salaryType: 'both', fixedSalary: 3000000, perSessionRate: 150000 },
                    { fullName: 'LÃª VÄƒn ThÃ nh', phone: '0911234003', email: 'thanh.gv@gmail.com', subjects: ['Tiá»n Tiá»ƒu Há»c', 'RÃ¨n Chá»¯'], salaryType: 'fixed', fixedSalary: 8000000, perSessionRate: 0 },
                    { fullName: 'Pháº¡m Thá»‹ Ngá»c', phone: '0911234004', email: 'ngoc.gv@gmail.com', subjects: ['Cá» Vua', 'Tiá»n Tiá»ƒu Há»c'], salaryType: 'per_session', fixedSalary: 0, perSessionRate: 180000 }
                ];

                const teacherIds = [];
                demoTeachers.forEach((t, index) => {
                    const newTeacher = {
                        id: 'demo_teacher_' + (index + 1),
                        ...t,
                        status: 'active',
                        notes: '',
                        createdAt: new Date().toISOString()
                    };
                    teachers.push(newTeacher);
                    teacherIds.push(newTeacher.id);
                });

                // ===== 3. Táº O Lá»šP Há»ŒC =====
                const subjectMap = {};
                subjects.forEach(s => { subjectMap[s.name] = s.id; });

                const demoClasses = [
                    { className: 'Cá» Vua - Lá»›p A1', subjectName: 'Cá» Vua', teacherIndex: 0, classType: 'group', maxStudents: 10 },
                    { className: 'Cá» Vua - Lá»›p A2', subjectName: 'Cá» Vua', teacherIndex: 3, classType: 'group', maxStudents: 8 },
                    { className: 'Váº½ Tranh - Lá»›p B1', subjectName: 'Váº½ Tranh', teacherIndex: 1, classType: 'group', maxStudents: 12 },
                    { className: 'Tiá»n Tiá»ƒu Há»c - Lá»›p C1', subjectName: 'Tiá»n Tiá»ƒu Há»c', teacherIndex: 2, classType: 'group', maxStudents: 10 },
                    { className: 'RÃ¨n Chá»¯ - Lá»›p D1', subjectName: 'RÃ¨n Chá»¯', teacherIndex: 2, classType: 'group', maxStudents: 8 },
                    { className: 'Cá» Vua - 1 kÃ¨m 1 (BÃ© Duy)', subjectName: 'Cá» Vua', teacherIndex: 0, classType: '1on1', maxStudents: 1 }
                ];

                const classIds = [];
                demoClasses.forEach((c, index) => {
                    const newClass = {
                        id: 'demo_class_' + (index + 1),
                        className: c.className,
                        subjectId: subjectMap[c.subjectName] || '',
                        teacherId: teacherIds[c.teacherIndex],
                        classType: c.classType,
                        maxStudents: c.maxStudents,
                        status: 'active',
                        notes: '',
                        createdAt: new Date().toISOString()
                    };
                    classes.push(newClass);
                    classIds.push(newClass.id);
                });

                // ===== 4. Táº O CA Há»ŒC =====
                const demoSchedules = [
                    // Cá» Vua A1: T7, CN sÃ¡ng
                    { classIndex: 0, dayOfWeek: 6, startTime: '08:30', endTime: '10:00', room: 'PhÃ²ng A1' },
                    { classIndex: 0, dayOfWeek: 7, startTime: '08:30', endTime: '10:00', room: 'PhÃ²ng A1' },
                    // Cá» Vua A2: T7, CN chiá»u
                    { classIndex: 1, dayOfWeek: 6, startTime: '15:00', endTime: '16:30', room: 'PhÃ²ng A1' },
                    { classIndex: 1, dayOfWeek: 7, startTime: '15:00', endTime: '16:30', room: 'PhÃ²ng A1' },
                    // Váº½ Tranh B1: T3, T5
                    { classIndex: 2, dayOfWeek: 2, startTime: '17:00', endTime: '18:30', room: 'PhÃ²ng B1' },
                    { classIndex: 2, dayOfWeek: 4, startTime: '17:00', endTime: '18:30', room: 'PhÃ²ng B1' },
                    // Tiá»n Tiá»ƒu Há»c C1: T2, T4, T6
                    { classIndex: 3, dayOfWeek: 1, startTime: '09:00', endTime: '10:30', room: 'PhÃ²ng C1' },
                    { classIndex: 3, dayOfWeek: 3, startTime: '09:00', endTime: '10:30', room: 'PhÃ²ng C1' },
                    { classIndex: 3, dayOfWeek: 5, startTime: '09:00', endTime: '10:30', room: 'PhÃ²ng C1' },
                    // RÃ¨n Chá»¯ D1: T2, T4
                    { classIndex: 4, dayOfWeek: 1, startTime: '14:00', endTime: '15:30', room: 'PhÃ²ng D1' },
                    { classIndex: 4, dayOfWeek: 3, startTime: '14:00', endTime: '15:30', room: 'PhÃ²ng D1' },
                    // 1 kÃ¨m 1: T3, T5
                    { classIndex: 5, dayOfWeek: 2, startTime: '10:00', endTime: '11:30', room: 'PhÃ²ng VIP' },
                    { classIndex: 5, dayOfWeek: 4, startTime: '10:00', endTime: '11:30', room: 'PhÃ²ng VIP' }
                ];

                const scheduleIds = [];
                demoSchedules.forEach((s, index) => {
                    const newSchedule = {
                        id: 'demo_schedule_' + (index + 1),
                        classId: classIds[s.classIndex],
                        dayOfWeek: s.dayOfWeek,
                        startTime: s.startTime,
                        endTime: s.endTime,
                        room: s.room,
                        isActive: true,
                        createdAt: new Date().toISOString()
                    };
                    classSchedules.push(newSchedule);
                    scheduleIds.push(newSchedule.id);
                });

                // ===== 5. Táº O PHIáº¾U ÄÄ‚NG KÃ =====
                const demoRegistrations = [
                    { studentIndex: 0, subject: 'Cá» Vua', tuitionFee: 2000000, discountAmount: 200000, finalAmount: 1800000 },
                    { studentIndex: 0, subject: 'Váº½ Tranh', tuitionFee: 1800000, discountAmount: 0, finalAmount: 1800000 },
                    { studentIndex: 1, subject: 'Cá» Vua', tuitionFee: 2000000, discountAmount: 0, finalAmount: 2000000 },
                    { studentIndex: 2, subject: 'Váº½ Tranh', tuitionFee: 1800000, discountAmount: 100000, finalAmount: 1700000 },
                    { studentIndex: 2, subject: 'Tiá»n Tiá»ƒu Há»c', tuitionFee: 1500000, discountAmount: 0, finalAmount: 1500000 },
                    { studentIndex: 3, subject: 'Cá» Vua', tuitionFee: 2000000, discountAmount: 0, finalAmount: 2000000 },
                    { studentIndex: 4, subject: 'Tiá»n Tiá»ƒu Há»c', tuitionFee: 1500000, discountAmount: 150000, finalAmount: 1350000 },
                    { studentIndex: 5, subject: 'RÃ¨n Chá»¯', tuitionFee: 1600000, discountAmount: 0, finalAmount: 1600000 },
                    { studentIndex: 5, subject: 'Tiá»n Tiá»ƒu Há»c', tuitionFee: 1500000, discountAmount: 0, finalAmount: 1500000 },
                    { studentIndex: 11, subject: 'Tiá»n Tiá»ƒu Há»c', tuitionFee: 1500000, discountAmount: 0, finalAmount: 1500000 },
                    { studentIndex: 12, subject: 'Cá» Vua', tuitionFee: 2000000, discountAmount: 0, finalAmount: 2000000 },
                    { studentIndex: 14, subject: 'Tiá»n Tiá»ƒu Há»c', tuitionFee: 1500000, discountAmount: 0, finalAmount: 1500000 }
                ];

                const regIds = [];
                demoRegistrations.forEach((r, index) => {
                    const student = students.find(s => s.id === studentIds[r.studentIndex]);
                    const regDate = new Date(today);
                    regDate.setDate(regDate.getDate() - Math.floor(Math.random() * 30));

                    const newReg = {
                        id: 'demo_reg_' + (index + 1),
                        regCode: 'DK' + (today.getFullYear() % 100) + String(today.getMonth() + 1).padStart(2, '0') + '-' + String(index + 1).padStart(3, '0'),
                        studentId: studentIds[r.studentIndex],
                        studentName: student ? student.name : '',
                        parentName: student ? student.parentName : '',
                        parentPhone: student ? student.parentPhone : '',
                        subject: r.subject,
                        packageId: null,
                        tuitionFee: r.tuitionFee,
                        promotionIds: [],
                        discountAmount: r.discountAmount,
                        finalAmount: r.finalAmount,
                        registrationDate: regDate.toISOString().split('T')[0],
                        createdAt: regDate.toISOString()
                    };
                    registrations.push(newReg);
                    regIds.push(newReg.id);
                });

                // ===== 6. GÃN Há»ŒC VIÃŠN VÃ€O Lá»šP =====
                const classStudentData = [
                    { regIndex: 0, classIndex: 0, totalSessions: 16, completedSessions: 8, remainingSessions: 8 },
                    { regIndex: 1, classIndex: 2, totalSessions: 12, completedSessions: 4, remainingSessions: 8 },
                    { regIndex: 2, classIndex: 0, totalSessions: 16, completedSessions: 10, remainingSessions: 6 },
                    { regIndex: 3, classIndex: 2, totalSessions: 12, completedSessions: 6, remainingSessions: 6 },
                    { regIndex: 4, classIndex: 3, totalSessions: 20, completedSessions: 12, remainingSessions: 8 },
                    { regIndex: 5, classIndex: 5, totalSessions: 8, completedSessions: 5, remainingSessions: 3 },
                    { regIndex: 6, classIndex: 3, totalSessions: 20, completedSessions: 18, remainingSessions: 2 },
                    { regIndex: 7, classIndex: 4, totalSessions: 16, completedSessions: 14, remainingSessions: 2 },
                    { regIndex: 8, classIndex: 3, totalSessions: 20, completedSessions: 5, remainingSessions: 15 },
                    { regIndex: 9, classIndex: 3, totalSessions: 20, completedSessions: 20, remainingSessions: 0 },
                    { regIndex: 10, classIndex: 1, totalSessions: 16, completedSessions: 16, remainingSessions: 0 },
                    { regIndex: 11, classIndex: 3, totalSessions: 20, completedSessions: 3, remainingSessions: 17 }
                ];

                const classStudentIds = [];
                classStudentData.forEach((cs, index) => {
                    const reg = registrations.find(r => r.id === regIds[cs.regIndex]);
                    const newCS = {
                        id: 'demo_cs_' + (index + 1),
                        classId: classIds[cs.classIndex],
                        studentId: reg ? reg.studentId : '',
                        registrationId: regIds[cs.regIndex],
                        totalSessions: cs.totalSessions,
                        completedSessions: cs.completedSessions,
                        remainingSessions: cs.remainingSessions,
                        status: cs.remainingSessions === 0 ? 'completed' : 'active',
                        enrolledAt: new Date().toISOString()
                    };
                    classStudents.push(newCS);
                    classStudentIds.push(newCS.id);
                });

                // ===== 7. Táº O BIÃŠN LAI =====
                const demoReceipts = [
                    { regIndex: 0, amount: 1800000, type: 'BiÃªn Lai Äiá»‡n Tá»­', daysAgo: 25 }, // ÄÃ³ng Ä‘á»§
                    { regIndex: 1, amount: 1000000, type: 'Phiáº¿u Thu', daysAgo: 20 }, // ÄÃ³ng 1 pháº§n
                    { regIndex: 2, amount: 2000000, type: 'BiÃªn Lai Äiá»‡n Tá»­', daysAgo: 28 }, // ÄÃ³ng Ä‘á»§
                    { regIndex: 3, amount: 1700000, type: 'BiÃªn Lai Äiá»‡n Tá»­', daysAgo: 22 }, // ÄÃ³ng Ä‘á»§
                    { regIndex: 4, amount: 1500000, type: 'Phiáº¿u Thu', daysAgo: 30 }, // ÄÃ³ng Ä‘á»§
                    { regIndex: 5, amount: 1000000, type: 'BiÃªn Lai Äiá»‡n Tá»­', daysAgo: 15 }, // ÄÃ³ng 1 pháº§n
                    { regIndex: 6, amount: 1350000, type: 'Phiáº¿u Thu', daysAgo: 35 }, // ÄÃ³ng Ä‘á»§
                    { regIndex: 9, amount: 1500000, type: 'BiÃªn Lai Äiá»‡n Tá»­', daysAgo: 45 } // ÄÃ³ng Ä‘á»§
                ];

                demoReceipts.forEach((r, index) => {
                    const reg = registrations.find(reg => reg.id === regIds[r.regIndex]);
                    const receiptDate = new Date(today);
                    receiptDate.setDate(receiptDate.getDate() - r.daysAgo);

                    const newReceipt = {
                        id: 'demo_receipt_' + (index + 1),
                        studentId: reg ? reg.studentId : '',
                        registrationId: regIds[r.regIndex],
                        type: r.type,
                        description: `Thanh toÃ¡n há»c phÃ­ - ${reg ? reg.subject : ''} - ${reg ? reg.regCode : ''}`,
                        amount: r.amount,
                        date: receiptDate.toISOString().split('T')[0],
                        notes: '',
                        parentName: reg ? reg.parentName : '',
                        parentPhone: reg ? reg.parentPhone : '',
                        createdBy: currentUser ? currentUser.id : '',
                        createdAt: receiptDate.toISOString()
                    };
                    receipts.push(newReceipt);
                });

                // ===== 8. Táº O Lá»ŠCH Háº¸N =====
                const demoAppointments = [
                    { studentIndex: 8, subject: 'Tiá»n Tiá»ƒu Há»c', daysFromNow: 1 },
                    { studentIndex: 9, subject: 'Váº½ Tranh', daysFromNow: 2 },
                    { studentIndex: 10, subject: 'Cá» Vua', daysFromNow: 3 },
                    { studentIndex: 7, subject: 'Cá» Vua', daysFromNow: -2 },
                    { studentIndex: 6, subject: 'Váº½ Tranh', daysFromNow: -5 }
                ];

                demoAppointments.forEach((a, index) => {
                    const aptDate = new Date(today);
                    aptDate.setDate(aptDate.getDate() + a.daysFromNow);

                    const newApt = {
                        id: 'demo_apt_' + (index + 1),
                        studentId: studentIds[a.studentIndex],
                        subject: a.subject,
                        date: aptDate.toISOString().split('T')[0],
                        time: '09:00',
                        notes: a.daysFromNow < 0 ? 'ÄÃ£ há»c thá»­' : 'Háº¹n há»c thá»­',
                        createdAt: new Date().toISOString()
                    };
                    appointments.push(newApt);
                });

                // ===== 9. Táº O ÄIá»‚M DANH =====
                const attendanceStatuses = ['present', 'present', 'present', 'present', 'late', 'absent', 'excused'];

                // Äiá»ƒm danh cho cÃ¡c lá»›p trong 2 tuáº§n gáº§n Ä‘Ã¢y
                for (let daysAgo = 14; daysAgo >= 0; daysAgo--) {
                    const attDate = new Date(today);
                    attDate.setDate(attDate.getDate() - daysAgo);
                    const dayOfWeek = attDate.getDay() === 0 ? 7 : attDate.getDay();

                    // TÃ¬m cÃ¡c ca há»c vÃ o ngÃ y nÃ y
                    classSchedules.forEach(schedule => {
                        if (schedule.dayOfWeek !== dayOfWeek) return;
                        if (!schedule.id.startsWith('demo_')) return;

                        // Láº¥y há»c viÃªn trong lá»›p nÃ y
                        const csInClass = classStudents.filter(cs => cs.classId === schedule.classId && cs.id.startsWith('demo_'));

                        csInClass.forEach(cs => {
                            // Random tráº¡ng thÃ¡i
                            const status = attendanceStatuses[Math.floor(Math.random() * attendanceStatuses.length)];

                            const newAttendance = {
                                id: 'demo_att_' + generateId(),
                                classId: schedule.classId,
                                scheduleId: schedule.id,
                                studentId: cs.studentId,
                                classStudentId: cs.id,
                                attendanceDate: attDate.toISOString().split('T')[0],
                                status: status,
                                notes: status === 'late' ? 'Muá»™n 10 phÃºt' : '',
                                isMakeupSession: false,
                                makeupRequestId: null,
                                createdBy: currentUser ? currentUser.id : '',
                                createdAt: attDate.toISOString()
                            };
                            attendances.push(newAttendance);
                        });
                    });
                }

                // ===== 10. Táº O YÃŠU Cáº¦U Há»ŒC BÃ™ =====
                const excusedAttendances = attendances.filter(a => a.status === 'excused' && a.id.startsWith('demo_att_')).slice(0, 3);

                excusedAttendances.forEach((att, index) => {
                    const expiryDate = new Date(att.attendanceDate);
                    expiryDate.setDate(expiryDate.getDate() + 30);

                    const statuses = ['pending', 'approved', 'completed'];
                    const status = statuses[index % 3];

                    const makeupDate = new Date(today);
                    makeupDate.setDate(makeupDate.getDate() + 3 + index);

                    const newMakeup = {
                        id: 'demo_makeup_' + (index + 1),
                        studentId: att.studentId,
                        classStudentId: att.classStudentId,
                        originalAttendanceId: att.id,
                        originalClassId: att.classId,
                        originalScheduleId: att.scheduleId,
                        originalDate: att.attendanceDate,
                        requestDate: att.attendanceDate,
                        expiryDate: expiryDate.toISOString().split('T')[0],
                        makeupClassId: status !== 'pending' ? att.classId : null,
                        makeupScheduleId: status !== 'pending' ? att.scheduleId : null,
                        makeupDate: status !== 'pending' ? makeupDate.toISOString().split('T')[0] : null,
                        status: status,
                        approvedBy: status !== 'pending' ? (currentUser ? currentUser.id : '') : null,
                        approvedAt: status !== 'pending' ? new Date().toISOString() : null,
                        completedAt: status === 'completed' ? new Date().toISOString() : null,
                        notes: '',
                        isPreCreated: false,
                        createdAt: att.attendanceDate
                    };
                    makeupRequests.push(newMakeup);
                });

                // ===== LÆ¯U Táº¤T Cáº¢ =====
                saveData('students', students);
                saveData('teachers', teachers);
                saveData('classes', classes);
                saveData('classSchedules', classSchedules);
                saveData('classStudents', classStudents);
                saveData('registrations', registrations);
                saveData('receipts', receipts);
                saveData('appointments', appointments);
                saveData('attendances', attendances);
                saveData('makeupRequests', makeupRequests);

                // Render láº¡i giao diá»‡n
                renderAll();

                showNotification('ğŸ‰ ÄÃ£ táº¡o dá»¯ liá»‡u Demo thÃ nh cÃ´ng!', 'success');

                // Hiá»ƒn thá»‹ thá»‘ng kÃª
                setTimeout(() => {
                    alert(`âœ… ÄÃƒ Táº O Dá»® LIá»†U DEMO:\n\n` +
                        `â€¢ Há»c viÃªn: ${demoStudents.length}\n` +
                        `â€¢ GiÃ¡o viÃªn: ${demoTeachers.length}\n` +
                        `â€¢ Lá»›p há»c: ${demoClasses.length}\n` +
                        `â€¢ Ca há»c: ${demoSchedules.length}\n` +
                        `â€¢ Phiáº¿u ÄK: ${demoRegistrations.length}\n` +
                        `â€¢ BiÃªn lai: ${demoReceipts.length}\n` +
                        `â€¢ Lá»‹ch háº¹n: ${demoAppointments.length}\n` +
                        `â€¢ Äiá»ƒm danh: ${attendances.filter(a => a.id.startsWith('demo_')).length}\n` +
                        `â€¢ YÃªu cáº§u há»c bÃ¹: ${excusedAttendances.length}\n\n` +
                        `Báº¡n cÃ³ thá»ƒ báº¯t Ä‘áº§u test cÃ¡c chá»©c nÄƒng!`);
                }, 500);

            } catch (error) {
                console.error('Lá»—i táº¡o dá»¯ liá»‡u demo:', error);
                showNotification('CÃ³ lá»—i khi táº¡o dá»¯ liá»‡u demo: ' + error.message, 'error');
            }
        }

        /* ============================================================
           ğŸ”§ PHáº¦N 19: UTILITY FUNCTIONS (HÃ m tiá»‡n Ã­ch)
           ============================================================ */

        // ===== 19.1 Format tiá»n tá»‡ =====
        function formatCurrency(amount) {
            if (amount === null || amount === undefined || isNaN(amount)) return '0 â‚«';
            return new Intl.NumberFormat('vi-VN').format(amount) + ' â‚«';
        }

        function formatCurrencyShort(amount) {
            if (amount === null || amount === undefined || isNaN(amount)) return '0';
            if (amount >= 1000000000) return (amount / 1000000000).toFixed(1) + 'tá»·';
            if (amount >= 1000000) return (amount / 1000000).toFixed(1) + 'tr';
            if (amount >= 1000) return (amount / 1000).toFixed(0) + 'k';
            return amount.toString();
        }

        function formatNumberInput(number) {
            if (!number && number !== 0) return '';
            return new Intl.NumberFormat('vi-VN').format(number);
        }

        function parseCurrencyInput(value) {
            if (!value) return 0;
            // Loáº¡i bá» táº¥t cáº£ kÃ½ tá»± khÃ´ng pháº£i sá»‘
            const cleaned = value.toString().replace(/[^\d]/g, '');
            return parseInt(cleaned) || 0;
        }

        function formatCurrencyInput(input) {
            // Láº¥y vá»‹ trÃ­ con trá»
            const cursorPos = input.selectionStart;
            const oldLength = input.value.length;

            // Parse vÃ  format láº¡i
            const value = parseCurrencyInput(input.value);
            input.value = value > 0 ? formatNumberInput(value) : '';

            // Äiá»u chá»‰nh vá»‹ trÃ­ con trá»
            const newLength = input.value.length;
            const newPos = cursorPos + (newLength - oldLength);
            input.setSelectionRange(newPos, newPos);
        }

        // ===== 19.2 Format ngÃ y thÃ¡ng =====
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return dateString;
            return date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }

        function formatDateTime(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return dateString;
            return date.toLocaleString('vi-VN', {
                day: '2-digit', month: '2-digit', year: 'numeric',
                hour: '2-digit', minute: '2-digit'
            });
        }

        function formatDateFile() {
            const now = new Date();
            const y = now.getFullYear();
            const m = String(now.getMonth() + 1).padStart(2, '0');
            const d = String(now.getDate()).padStart(2, '0');
            const h = String(now.getHours()).padStart(2, '0');
            const min = String(now.getMinutes()).padStart(2, '0');
            return `${y}${m}${d}_${h}${min}`;
        }

        /* ============================================================
           ğŸ“„ PHáº¦N 20: PAGINATION (PhÃ¢n trang)
           ============================================================ */

        function getPaginatedData(data, stateKey) {
            const state = paginationState[stateKey];
            if (!state) return { data: data, total: data.length, totalPages: 1, currentPage: 1 };

            const total = data.length;
            const totalPages = Math.ceil(total / state.pageSize) || 1;
            const currentPage = Math.min(state.page, totalPages);

            const startIndex = (currentPage - 1) * state.pageSize;
            const endIndex = startIndex + state.pageSize;
            const paginatedData = data.slice(startIndex, endIndex);

            return {
                data: paginatedData,
                total: total,
                totalPages: totalPages,
                currentPage: currentPage
            };
        }

        function renderPagination(containerId, stateKey, total, totalPages, currentPage) {
            const container = document.getElementById(containerId);
            if (!container) return;

            const state = paginationState[stateKey];
            if (!state) return;

            const startItem = total === 0 ? 0 : (currentPage - 1) * state.pageSize + 1;
            const endItem = Math.min(currentPage * state.pageSize, total);

            let paginationHTML = '';

            // NÃºt Previous
            paginationHTML += `<button ${currentPage <= 1 ? 'disabled' : ''} onclick="changePage('${stateKey}', ${currentPage - 1})">â€¹</button>`;

            // CÃ¡c nÃºt sá»‘ trang
            const maxButtons = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
            let endPage = Math.min(totalPages, startPage + maxButtons - 1);

            if (endPage - startPage + 1 < maxButtons) {
                startPage = Math.max(1, endPage - maxButtons + 1);
            }

            if (startPage > 1) {
                paginationHTML += `<button onclick="changePage('${stateKey}', 1)">1</button>`;
                if (startPage > 2) paginationHTML += `<button disabled>...</button>`;
            }

            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `<button class="${i === currentPage ? 'active' : ''}" onclick="changePage('${stateKey}', ${i})">${i}</button>`;
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) paginationHTML += `<button disabled>...</button>`;
                paginationHTML += `<button onclick="changePage('${stateKey}', ${totalPages})">${totalPages}</button>`;
            }

            // NÃºt Next
            paginationHTML += `<button ${currentPage >= totalPages ? 'disabled' : ''} onclick="changePage('${stateKey}', ${currentPage + 1})">â€º</button>`;

            container.innerHTML = `
        <div class="pagination-info">Hiá»ƒn thá»‹ ${startItem}-${endItem} / ${total}</div>
        <div class="pagination">${paginationHTML}</div>
        <div class="page-size-select">
            Hiá»ƒn thá»‹: 
            <select onchange="changePageSize('${stateKey}', this.value)">
                ${CONFIG.PAGE_SIZE_OPTIONS.map(size =>
                `<option value="${size}" ${size === state.pageSize ? 'selected' : ''}>${size}</option>`
            ).join('')}
            </select>
        </div>
        `;
        }

        function changePage(stateKey, page) {
            if (paginationState[stateKey]) {
                paginationState[stateKey].page = page;

                // Xá»­ lÃ½ render theo tá»«ng loáº¡i báº£ng
                switch (stateKey) {
                    case 'students':
                        renderStudentsTable();
                        break;
                    case 'trial':
                        renderTrialStudentsTable();
                        break;
                    case 'appointments':
                        renderAppointmentsTable();
                        break;
                    case 'registrations':
                        renderRegistrationsTable();
                        break;
                    case 'receipts':
                        renderReceiptsTable();
                        break;
                    case 'teachers':
                        renderTeachersTable();
                        break;
                    case 'classes':
                        renderClassesTable();
                        break;
                    case 'makeup':
                        renderMakeupRequests();
                        break;
                    case 'attendanceHistory':
                        loadAttendanceHistory();
                        break;
                    case 'debts':
                        renderDebtsTable();
                        break;
                    default:
                        // Fallback cho cÃ¡c tab khÃ¡c
                        renderTabContent(stateKey);
                }
            }
        }


        function changePageSize(stateKey, size) {
            if (paginationState[stateKey]) {
                paginationState[stateKey].pageSize = parseInt(size);
                paginationState[stateKey].page = 1; // Reset vá» trang 1

                // Gá»i changePage Ä‘á»ƒ render láº¡i
                changePage(stateKey, 1);
            }
        }


        /* ============================================================
           ğŸš€ PHáº¦N 21: RENDER ALL & INITIALIZATION
           ============================================================ */
        /* ============================================================
           ğŸ‘¨â€ğŸ« PHáº¦N 23: QUáº¢N LÃ GIÃO VIÃŠN
           ============================================================ */

        // ===== 23.1 Render báº£ng giÃ¡o viÃªn =====
        function renderTeachersTable() {
            const tbody = document.getElementById('teachersTableBody');
            const searchTerm = document.getElementById('searchTeacher')?.value?.toLowerCase() || '';

            let filtered = teachers.filter(t =>
                t.fullName.toLowerCase().includes(searchTerm) ||
                t.phone.includes(searchTerm)
            );

            if (filtered.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6"><div class="empty-state"><div class="empty-state-icon">ğŸ‘¨â€ğŸ«</div><p>ChÆ°a cÃ³ giÃ¡o viÃªn nÃ o</p></div></td></tr>`;
                return;
            }

            tbody.innerHTML = filtered.map(t => `
        <tr>
            <td><strong>${t.fullName}</strong></td>
            <td>${t.phone}</td>
            <td>${t.subjects.map(s => `<span class="subject-tag">${getSubjectIcon(s)} ${s}</span>`).join(' ')}</td>
            <td>${getSalaryTypeLabel(t.salaryType)}</td>
            <td><span class="status-badge ${t.status === 'active' ? 'active' : 'locked'}">${t.status === 'active' ? 'ğŸŸ¢ Äang dáº¡y' : 'âš« Nghá»‰'}</span></td>
            <td>
                <div class="action-buttons">
                    <button class="action-btn view" onclick="viewTeacher('${t.id}')" title="Xem">ğŸ‘ï¸</button>
                    ${canEdit('teachers') ? `<button class="action-btn edit" onclick="editTeacher('${t.id}')" title="Sá»­a">âœï¸</button>` : ''}
                    ${canDelete('teachers') ? `<button class="action-btn delete" onclick="deleteTeacher('${t.id}')" title="XÃ³a">ğŸ—‘ï¸</button>` : ''}
                </div>
            </td>
        </tr>
    `).join('');
        }

        function getSubjectIcon(subjectName) {
            const subject = subjects.find(s => s.name === subjectName);
            return subject ? subject.icon : 'ğŸ“–';
        }

        function getSalaryTypeLabel(type) {
            const labels = {
                'fixed': 'ğŸ’° Cá»‘ Ä‘á»‹nh',
                'per_session': 'ğŸ’µ Theo buá»•i',
                'both': 'ğŸ’³ Cá»‘ Ä‘á»‹nh + Buá»•i'
            };
            return labels[type] || type;
        }

        function searchTeachers() {
            renderTeachersTable();
        }

        // ===== 23.2 Modal GiÃ¡o viÃªn =====
        function openTeacherModal() {
            document.getElementById('editTeacherId').value = '';
            document.getElementById('teacherForm').reset();
            document.getElementById('teacherModalTitle').textContent = 'ğŸ‘¨â€ğŸ« ThÃªm GiÃ¡o ViÃªn';
            document.getElementById('teacherSalaryType').value = 'per_session';
            toggleSalaryFields();
            renderTeacherSubjectsCheckboxes();
            openModal('teacherModal');
        }

        function renderTeacherSubjectsCheckboxes() {
            document.getElementById('teacherSubjectsCheckboxes').innerHTML = subjects.map(s =>
                `<label class="checkbox-item"><input type="checkbox" name="teacherSubjects" value="${s.name}"> ${s.icon} ${s.name}</label>`
            ).join('');
        }

        function toggleSalaryFields() {
            const type = document.getElementById('teacherSalaryType').value;
            document.getElementById('fixedSalaryGroup').style.display = (type === 'fixed' || type === 'both') ? 'block' : 'none';
            document.getElementById('perSessionGroup').style.display = (type === 'per_session' || type === 'both') ? 'block' : 'none';
        }

        function editTeacher(id) {
            const teacher = teachers.find(t => t.id === id);
            if (!teacher) return;

            document.getElementById('editTeacherId').value = teacher.id;
            document.getElementById('teacherFullName').value = teacher.fullName;
            document.getElementById('teacherPhone').value = teacher.phone;
            document.getElementById('teacherEmail').value = teacher.email || '';
            document.getElementById('teacherSalaryType').value = teacher.salaryType;
            document.getElementById('teacherFixedSalary').value = teacher.fixedSalary ? formatNumberInput(teacher.fixedSalary) : '';
            document.getElementById('teacherPerSession').value = teacher.perSessionRate ? formatNumberInput(teacher.perSessionRate) : '';
            document.getElementById('teacherNotes').value = teacher.notes || '';

            renderTeacherSubjectsCheckboxes();
            document.querySelectorAll('input[name="teacherSubjects"]').forEach(cb => {
                cb.checked = teacher.subjects.includes(cb.value);
            });

            toggleSalaryFields();
            document.getElementById('teacherModalTitle').textContent = 'âœï¸ Sá»­a GiÃ¡o ViÃªn';
            openModal('teacherModal');
        }

        function saveTeacher(event) {
            event.preventDefault();

            const selectedSubjects = Array.from(document.querySelectorAll('input[name="teacherSubjects"]:checked')).map(cb => cb.value);
            if (selectedSubjects.length === 0) {
                showNotification('Vui lÃ²ng chá»n Ã­t nháº¥t 1 mÃ´n dáº¡y!', 'error');
                return;
            }

            const editId = document.getElementById('editTeacherId').value;
            const data = {
                fullName: document.getElementById('teacherFullName').value.trim(),
                phone: document.getElementById('teacherPhone').value.trim(),
                email: document.getElementById('teacherEmail').value.trim(),
                subjects: selectedSubjects,
                salaryType: document.getElementById('teacherSalaryType').value,
                fixedSalary: parseCurrencyInput(document.getElementById('teacherFixedSalary').value),
                perSessionRate: parseCurrencyInput(document.getElementById('teacherPerSession').value),
                notes: document.getElementById('teacherNotes').value.trim(),
                status: 'active'
            };

            if (editId) {
                const index = teachers.findIndex(t => t.id === editId);
                if (index !== -1) {
                    teachers[index] = { ...teachers[index], ...data, updatedAt: new Date().toISOString() };
                    showNotification('Cáº­p nháº­t giÃ¡o viÃªn thÃ nh cÃ´ng!', 'success');
                }
            } else {
                teachers.push({ id: generateId(), ...data, createdAt: new Date().toISOString() });
                showNotification('ThÃªm giÃ¡o viÃªn thÃ nh cÃ´ng!', 'success');
            }

            saveData('teachers', teachers);
            closeModal('teacherModal');
            renderTeachersTable();
        }

        function deleteTeacher(id) {
            const teacher = teachers.find(t => t.id === id);
            if (!teacher) return;

            // Kiá»ƒm tra GV cÃ³ Ä‘ang dáº¡y lá»›p nÃ o khÃ´ng
            const teachingClasses = classes.filter(c => c.teacherId === id && c.status === 'active');
            if (teachingClasses.length > 0) {
                showNotification(`KhÃ´ng thá»ƒ xÃ³a! GV Ä‘ang dáº¡y ${teachingClasses.length} lá»›p.`, 'error');
                return;
            }

            if (!confirm(`XÃ³a giÃ¡o viÃªn "${teacher.fullName}"?`)) return;

            teachers = teachers.filter(t => t.id !== id);
            saveData('teachers', teachers);
            showNotification('ÄÃ£ xÃ³a giÃ¡o viÃªn!', 'success');
            renderTeachersTable();
        }

        function viewTeacher(id) {
            const teacher = teachers.find(t => t.id === id);
            if (!teacher) return;

            const teacherClasses = classes.filter(c => c.teacherId === id);

            let scheduleHTML = '';
            teacherClasses.forEach(cls => {
                const clsSchedules = classSchedules.filter(s => s.classId === cls.id);
                clsSchedules.forEach(sch => {
                    scheduleHTML += `<div class="quick-view-row"><span class="quick-view-label">${cls.className}</span><span class="quick-view-value">${getDayName(sch.dayOfWeek)} ${sch.startTime}-${sch.endTime}</span></div>`;
                });
            });

            document.getElementById('viewTeacherContent').innerHTML = `
        <div class="quick-view-section">
            <h4>ğŸ‘¤ ThÃ´ng tin cÃ¡ nhÃ¢n</h4>
            <div class="quick-view-row"><span class="quick-view-label">Há» tÃªn:</span><span class="quick-view-value"><strong>${teacher.fullName}</strong></span></div>
            <div class="quick-view-row"><span class="quick-view-label">Äiá»‡n thoáº¡i:</span><span class="quick-view-value">${teacher.phone}</span></div>
            <div class="quick-view-row"><span class="quick-view-label">Email:</span><span class="quick-view-value">${teacher.email || '-'}</span></div>
            <div class="quick-view-row"><span class="quick-view-label">MÃ´n dáº¡y:</span><span class="quick-view-value">${teacher.subjects.map(s => `<span class="subject-tag">${getSubjectIcon(s)} ${s}</span>`).join(' ')}</span></div>
        </div>
        <div class="quick-view-section">
            <h4>ğŸ’° ThÃ´ng tin lÆ°Æ¡ng</h4>
            <div class="quick-view-row"><span class="quick-view-label">Loáº¡i lÆ°Æ¡ng:</span><span class="quick-view-value">${getSalaryTypeLabel(teacher.salaryType)}</span></div>
            ${teacher.fixedSalary ? `<div class="quick-view-row"><span class="quick-view-label">LÆ°Æ¡ng cá»‘ Ä‘á»‹nh:</span><span class="quick-view-value">${formatCurrency(teacher.fixedSalary)}/thÃ¡ng</span></div>` : ''}
            ${teacher.perSessionRate ? `<div class="quick-view-row"><span class="quick-view-label">Tiá»n/buá»•i:</span><span class="quick-view-value">${formatCurrency(teacher.perSessionRate)}</span></div>` : ''}
        </div>
        <div class="quick-view-section">
            <h4>ğŸ“š Lá»›p Ä‘ang dáº¡y (${teacherClasses.length})</h4>
            ${teacherClasses.length === 0 ? '<p class="text-muted">ChÆ°a cÃ³ lá»›p</p>' : teacherClasses.map(c => `
                <div class="quick-view-row">
                    <span class="quick-view-label">${c.className}</span>
                    <span class="quick-view-value">${getClassStatusBadge(c.status)}</span>
                </div>
            `).join('')}
        </div>
        <div class="quick-view-section">
            <h4>ğŸ“… Lá»‹ch dáº¡y trong tuáº§n</h4>
            ${scheduleHTML || '<p class="text-muted">ChÆ°a cÃ³ lá»‹ch</p>'}
        </div>
    `;
            openModal('viewTeacherModal');
        }

        /* ============================================================
           ğŸ“š PHáº¦N 24: QUáº¢N LÃ Lá»šP Há»ŒC
           ============================================================ */

        // ===== 24.1 Render báº£ng lá»›p há»c =====
        function renderClassesTable() {
            const tbody = document.getElementById('classesTableBody');
            const searchTerm = document.getElementById('searchClass')?.value?.toLowerCase() || '';
            const filterSubject = document.getElementById('filterClassSubject')?.value || '';
            const filterTeacher = document.getElementById('filterClassTeacher')?.value || '';
            const filterStatus = document.getElementById('filterClassStatus')?.value || '';

            let filtered = classes.filter(c => {
                if (searchTerm && !c.className.toLowerCase().includes(searchTerm)) return false;
                if (filterSubject && c.subjectId !== filterSubject) return false;
                if (filterTeacher && c.teacherId !== filterTeacher) return false;
                if (filterStatus && c.status !== filterStatus) return false;
                return true;
            });

            if (filtered.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8"><div class="empty-state"><div class="empty-state-icon">ğŸ“š</div><p>ChÆ°a cÃ³ lá»›p há»c nÃ o</p></div></td></tr>`;
                return;
            }

            tbody.innerHTML = filtered.map(c => {
                const subject = subjects.find(s => s.id === c.subjectId);
                const teacher = teachers.find(t => t.id === c.teacherId);
                const clsSchedules = classSchedules.filter(s => s.classId === c.id && s.isActive);
                const studentCount = classStudents.filter(cs => cs.classId === c.id && cs.status === 'active').length;

                return `
            <tr>
                <td><strong>${c.className}</strong></td>
                <td>${subject ? `${subject.icon} ${subject.name}` : '-'}</td>
                <td>${teacher ? teacher.fullName : '<span class="text-muted">ChÆ°a cÃ³</span>'}</td>
                <td>${c.classType === 'group' ? 'ğŸ‘¥ NhÃ³m' : 'ğŸ‘¤ 1-1'}</td>
                <td><strong>${studentCount}</strong>/${c.maxStudents}</td>
                <td>${formatSchedules(clsSchedules)}</td>
                <td>${getClassStatusBadge(c.status)}</td>
                <td>
                    <div class="action-buttons">
                        <button class="action-btn view" onclick="viewClass('${c.id}')" title="Xem">ğŸ‘ï¸</button>
                        ${canEdit('classes') ? `<button class="action-btn edit" onclick="editClass('${c.id}')" title="Sá»­a">âœï¸</button>` : ''}
                        ${canDelete('classes') ? `<button class="action-btn delete" onclick="deleteClass('${c.id}')" title="XÃ³a">ğŸ—‘ï¸</button>` : ''}
                    </div>
                </td>
            </tr>
        `;
            }).join('');
        }

        function formatSchedules(schedules) {
            if (!schedules || schedules.length === 0) return '<span class="text-muted">ChÆ°a cÃ³ lá»‹ch</span>';

            const grouped = {};
            schedules.forEach(s => {
                const time = `${s.startTime}-${s.endTime}`;
                if (!grouped[time]) grouped[time] = [];
                grouped[time].push(getDayShort(s.dayOfWeek));
            });

            return Object.entries(grouped).map(([time, days]) =>
                `<small>${days.join(',')} ${time}</small>`
            ).join('<br>');
        }

        function getDayName(dayOfWeek) {
            const days = ['', 'Thá»© 2', 'Thá»© 3', 'Thá»© 4', 'Thá»© 5', 'Thá»© 6', 'Thá»© 7', 'CN'];
            return days[dayOfWeek] || '';
        }

        function getDayShort(dayOfWeek) {
            const days = ['', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'CN'];
            return days[dayOfWeek] || '';
        }

        function getClassStatusBadge(status) {
            const badges = {
                'new': '<span class="status-badge hoc-thu">ğŸ†• Lá»›p má»›i</span>',
                'active': '<span class="status-badge da-dk">ğŸŸ¢ Äang há»c</span>',
                'completed': '<span class="status-badge hoan-thanh">âœ… HoÃ n thÃ nh</span>',
                'cancelled': '<span class="status-badge cancel">âŒ ÄÃ£ há»§y</span>'
            };
            return badges[status] || status;
        }

        function searchClasses() {
            renderClassesTable();
        }

        function filterClasses() {
            renderClassesTable();
        }

        // ===== 24.2 Populate filter dropdowns =====
        function populateClassFilters() {
            // Filter mÃ´n há»c
            const subjectFilter = document.getElementById('filterClassSubject');
            if (subjectFilter) {
                subjectFilter.innerHTML = '<option value="">ğŸ“– Táº¥t cáº£ mÃ´n há»c</option>' +
                    subjects.map(s => `<option value="${s.id}">${s.icon} ${s.name}</option>`).join('');
            }

            // Filter giÃ¡o viÃªn
            const teacherFilter = document.getElementById('filterClassTeacher');
            if (teacherFilter) {
                teacherFilter.innerHTML = '<option value="">ğŸ‘¨â€ğŸ« Táº¥t cáº£ giÃ¡o viÃªn</option>' +
                    teachers.filter(t => t.status === 'active').map(t => `<option value="${t.id}">${t.fullName}</option>`).join('');
            }
        }

        // ===== 24.3 Modal Lá»›p há»c =====
        function openClassModal() {
            document.getElementById('editClassId').value = '';
            document.getElementById('classForm').reset();
            document.getElementById('classModalTitle').textContent = 'ğŸ“š ThÃªm Lá»›p Há»c';
            document.getElementById('classType').value = 'group';
            document.getElementById('classMaxStudents').value = 10;
            document.getElementById('classStatus').value = 'new';
            toggleMaxStudents();
            populateClassSubjectDropdown();
            populateClassTeacherDropdown();
            openModal('classModal');
        }

        function populateClassSubjectDropdown() {
            document.getElementById('classSubject').innerHTML = '<option value="">-- Chá»n mÃ´n há»c --</option>' +
                subjects.map(s => `<option value="${s.id}">${s.icon} ${s.name}</option>`).join('');
        }

        function populateClassTeacherDropdown(subjectId = null) {
            let filtered = teachers.filter(t => t.status === 'active');
            if (subjectId) {
                const subject = subjects.find(s => s.id === subjectId);
                if (subject) {
                    filtered = filtered.filter(t => t.subjects.includes(subject.name));
                }
            }

            document.getElementById('classTeacher').innerHTML = '<option value="">-- Chá»n giÃ¡o viÃªn --</option>' +
                filtered.map(t => `<option value="${t.id}">${t.fullName}</option>`).join('');
        }

        function filterTeachersBySubject() {
            const subjectId = document.getElementById('classSubject').value;
            populateClassTeacherDropdown(subjectId);
        }

        function toggleMaxStudents() {
            const classType = document.getElementById('classType').value;
            const maxStudentsInput = document.getElementById('classMaxStudents');
            const maxStudentsGroup = document.getElementById('maxStudentsGroup');

            if (classType === '1on1') {
                maxStudentsInput.value = 1;
                maxStudentsInput.disabled = true;
                maxStudentsGroup.style.opacity = '0.5';
            } else {
                maxStudentsInput.value = 10;
                maxStudentsInput.disabled = false;
                maxStudentsGroup.style.opacity = '1';
            }
        }

        function editClass(id) {
            const cls = classes.find(c => c.id === id);
            if (!cls) return;

            document.getElementById('editClassId').value = cls.id;
            document.getElementById('className').value = cls.className;
            populateClassSubjectDropdown();
            document.getElementById('classSubject').value = cls.subjectId;
            populateClassTeacherDropdown(cls.subjectId);
            document.getElementById('classTeacher').value = cls.teacherId || '';
            document.getElementById('classType').value = cls.classType;
            document.getElementById('classMaxStudents').value = cls.maxStudents;
            document.getElementById('classStatus').value = cls.status;
            document.getElementById('classNotes').value = cls.notes || '';

            toggleMaxStudents();
            document.getElementById('classModalTitle').textContent = 'âœï¸ Sá»­a Lá»›p Há»c';
            openModal('classModal');
        }

        function saveClass(event) {
            event.preventDefault();

            const editId = document.getElementById('editClassId').value;
            const data = {
                className: document.getElementById('className').value.trim(),
                subjectId: document.getElementById('classSubject').value,
                teacherId: document.getElementById('classTeacher').value || null,
                classType: document.getElementById('classType').value,
                maxStudents: parseInt(document.getElementById('classMaxStudents').value),
                status: document.getElementById('classStatus').value,
                notes: document.getElementById('classNotes').value.trim()
            };

            if (editId) {
                const index = classes.findIndex(c => c.id === editId);
                if (index !== -1) {
                    classes[index] = { ...classes[index], ...data, updatedAt: new Date().toISOString() };
                    showNotification('Cáº­p nháº­t lá»›p há»c thÃ nh cÃ´ng!', 'success');
                }
            } else {
                classes.push({ id: generateId(), ...data, createdAt: new Date().toISOString() });
                showNotification('ThÃªm lá»›p há»c thÃ nh cÃ´ng!', 'success');
            }

            saveData('classes', classes);
            closeModal('classModal');
            renderClassesTable();
            populateClassFilters();
        }

        function deleteClass(id) {
            const cls = classes.find(c => c.id === id);
            if (!cls) return;

            const studentCount = classStudents.filter(cs => cs.classId === id && cs.status === 'active').length;
            if (studentCount > 0) {
                showNotification(`KhÃ´ng thá»ƒ xÃ³a! Lá»›p cÃ²n ${studentCount} há»c viÃªn.`, 'error');
                return;
            }

            if (!confirm(`XÃ³a lá»›p "${cls.className}"?`)) return;

            classes = classes.filter(c => c.id !== id);
            classSchedules = classSchedules.filter(s => s.classId !== id);

            saveData('classes', classes);
            saveData('classSchedules', classSchedules);
            showNotification('ÄÃ£ xÃ³a lá»›p há»c!', 'success');
            renderClassesTable();
        }

        // ===== 24.4 Xem chi tiáº¿t lá»›p =====
        let currentViewingClassId = null;

        function viewClass(id) {
            const cls = classes.find(c => c.id === id);
            if (!cls) return;

            currentViewingClassId = id;

            const subject = subjects.find(s => s.id === cls.subjectId);
            const teacher = teachers.find(t => t.id === cls.teacherId);
            const clsSchedules = classSchedules.filter(s => s.classId === id && s.isActive);
            const clsStudents = classStudents.filter(cs => cs.classId === id && cs.status === 'active');

            document.getElementById('viewClassContent').innerHTML = `
        <div class="d-flex gap-20 flex-wrap">
            <div class="flex-1" style="min-width: 300px;">
                <div class="quick-view-section">
                    <h4>ğŸ“‹ ThÃ´ng tin lá»›p</h4>
                    <div class="quick-view-row"><span class="quick-view-label">TÃªn lá»›p:</span><span class="quick-view-value"><strong>${cls.className}</strong></span></div>
                    <div class="quick-view-row"><span class="quick-view-label">MÃ´n há»c:</span><span class="quick-view-value">${subject ? `${subject.icon} ${subject.name}` : '-'}</span></div>
                    <div class="quick-view-row"><span class="quick-view-label">GiÃ¡o viÃªn:</span><span class="quick-view-value">${teacher ? teacher.fullName : '<span class="text-muted">ChÆ°a cÃ³</span>'}</span></div>
                    <div class="quick-view-row"><span class="quick-view-label">Loáº¡i lá»›p:</span><span class="quick-view-value">${cls.classType === 'group' ? 'ğŸ‘¥ Lá»›p nhÃ³m' : 'ğŸ‘¤ 1 kÃ¨m 1'}</span></div>
                    <div class="quick-view-row"><span class="quick-view-label">SÄ© sá»‘:</span><span class="quick-view-value"><strong>${clsStudents.length}</strong> / ${cls.maxStudents}</span></div>
                    <div class="quick-view-row"><span class="quick-view-label">Tráº¡ng thÃ¡i:</span><span class="quick-view-value">${getClassStatusBadge(cls.status)}</span></div>
                </div>
                
                <div class="quick-view-section">
                    <h4>ğŸ“… Lá»‹ch há»c</h4>
                    ${clsSchedules.length === 0 ? '<p class="text-muted">ChÆ°a cÃ³ ca há»c. Nháº¥n "ThÃªm ca há»c" Ä‘á»ƒ thÃªm.</p>' : `
                        <table style="width: 100%; font-size: 13px;">
                            <thead><tr><th>Thá»©</th><th>Giá» há»c</th><th>PhÃ²ng</th><th></th></tr></thead>
                            <tbody>
                                ${clsSchedules.map(s => `
                                    <tr>
                                        <td>${getDayName(s.dayOfWeek)}</td>
                                        <td>${s.startTime} - ${s.endTime}</td>
                                        <td>${s.room || '-'}</td>
                                        <td>
                                            <button class="action-btn edit" onclick="editSchedule('${s.id}')" title="Sá»­a">âœï¸</button>
                                            <button class="action-btn delete" onclick="deleteSchedule('${s.id}')" title="XÃ³a">ğŸ—‘ï¸</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `}
                </div>
            </div>
            
            <div class="flex-1" style="min-width: 350px;">
                <div class="quick-view-section">
                    <h4>ğŸ‘©â€ğŸ“ Danh sÃ¡ch há»c viÃªn (${clsStudents.length})</h4>
                    ${clsStudents.length === 0 ? '<p class="text-muted">ChÆ°a cÃ³ há»c viÃªn. Nháº¥n "ThÃªm há»c viÃªn" Ä‘á»ƒ thÃªm.</p>' : `
                        <table style="width: 100%; font-size: 13px;">
                            <thead><tr><th>Há»c viÃªn</th><th>Tá»•ng</th><th>ÄÃ£ há»c</th><th>CÃ²n láº¡i</th><th></th></tr></thead>
                            <tbody>
                                ${clsStudents.map(cs => {
                const student = students.find(s => s.id === cs.studentId);
                const remainingClass = getSessionWarningClass(cs.remainingSessions);
                return `
                                        <tr>
                                            <td><strong>${student ? student.name : 'N/A'}</strong></td>
                                            <td>${cs.totalSessions}</td>
                                            <td>${cs.completedSessions}</td>
                                            <td><span class="${remainingClass}">${cs.remainingSessions}</span></td>
                                            <td>
                                                <button class="action-btn delete" onclick="removeStudentFromClass('${cs.id}')" title="XÃ³a khá»i lá»›p">ğŸ—‘ï¸</button>
                                            </td>
                                        </tr>
                                    `;
            }).join('')}
                            </tbody>
                        </table>
                    `}
                </div>
            </div>
        </div>
    `;

            openModal('viewClassModal');
        }

        function getSessionWarningClass(remaining) {
            if (remaining <= 1) return 'text-danger fw-700';
            if (remaining <= 3) return 'text-warning fw-600';
            if (remaining <= 5) return 'text-primary';
            return 'text-success';
        }

        /* ============================================================
           ğŸ“… PHáº¦N 25: QUáº¢N LÃ CA Há»ŒC (SCHEDULE)
           ============================================================ */

        function openScheduleModal() {
            if (!currentViewingClassId) {
                showNotification('Vui lÃ²ng chá»n lá»›p trÆ°á»›c!', 'error');
                return;
            }

            document.getElementById('scheduleClassId').value = currentViewingClassId;
            document.getElementById('editScheduleId').value = '';
            document.getElementById('scheduleForm').reset();
            document.getElementById('scheduleStartTime').value = '08:30';
            document.getElementById('scheduleEndTime').value = '10:00';

            // Populate dropdown phÃ²ng há»c
            populateRoomDropdown();

            openModal('scheduleModal');
        }

        function populateRoomDropdown() {
            const roomSelect = document.getElementById('scheduleRoom');
            if (!roomSelect) return;

            const activeRooms = getActiveRooms();

            // Kiá»ƒm tra náº¿u Ä‘Ã£ lÃ  dropdown thÃ¬ populate, náº¿u lÃ  input thÃ¬ giá»¯ nguyÃªn
            if (roomSelect.tagName === 'SELECT') {
                roomSelect.innerHTML = '<option value="">-- Chá»n phÃ²ng --</option>' +
                    activeRooms.map(r => `<option value="${r.id}">${r.name} (${r.capacity} ngÆ°á»i)</option>`).join('');
            }
        }


        function editSchedule(id) {
            const schedule = classSchedules.find(s => s.id === id);
            if (!schedule) return;

            document.getElementById('scheduleClassId').value = schedule.classId;
            document.getElementById('editScheduleId').value = schedule.id;
            document.getElementById('scheduleDayOfWeek').value = schedule.dayOfWeek;
            document.getElementById('scheduleStartTime').value = schedule.startTime;
            document.getElementById('scheduleEndTime').value = schedule.endTime;

            // Populate dropdown phÃ²ng vÃ  chá»n phÃ²ng hiá»‡n táº¡i
            populateRoomDropdown();
            document.getElementById('scheduleRoom').value = schedule.roomId || '';

            openModal('scheduleModal');
        }


        function saveSchedule(event) {
            event.preventDefault();

            const classId = document.getElementById('scheduleClassId').value;
            const editId = document.getElementById('editScheduleId').value;
            const roomSelect = document.getElementById('scheduleRoom');
            const roomId = roomSelect.value;
            const roomName = roomId ? (rooms.find(r => r.id === roomId)?.name || '') : '';

            const data = {
                classId: classId,
                dayOfWeek: parseInt(document.getElementById('scheduleDayOfWeek').value),
                startTime: document.getElementById('scheduleStartTime').value,
                endTime: document.getElementById('scheduleEndTime').value,
                roomId: roomId || null,
                room: roomName,
                isActive: true
            };

            // Kiá»ƒm tra trÃ¹ng phÃ²ng
            if (roomId) {
                const conflict = checkRoomConflict(roomId, data.dayOfWeek, data.startTime, data.endTime, editId);
                if (conflict) {
                    showNotification(`PhÃ²ng Ä‘Ã£ Ä‘Æ°á»£c sá»­ dá»¥ng bá»Ÿi lá»›p "${conflict.className}" vÃ o ${getDayName(data.dayOfWeek)} ${conflict.schedule.startTime}-${conflict.schedule.endTime}!`, 'error');
                    return;
                }
            }

            if (editId) {
                const index = classSchedules.findIndex(s => s.id === editId);
                if (index !== -1) {
                    classSchedules[index] = { ...classSchedules[index], ...data };
                    showNotification('Cáº­p nháº­t ca há»c thÃ nh cÃ´ng!', 'success');
                }
            } else {
                classSchedules.push({ id: generateId(), ...data, createdAt: new Date().toISOString() });
                showNotification('ThÃªm ca há»c thÃ nh cÃ´ng!', 'success');
            }

            saveData('classSchedules', classSchedules);
            closeModal('scheduleModal');
            viewClass(classId); // Refresh chi tiáº¿t lá»›p
            renderClassesTable();
        }

        function deleteSchedule(id) {
            if (!confirm('XÃ³a ca há»c nÃ y?')) return;

            const schedule = classSchedules.find(s => s.id === id);
            classSchedules = classSchedules.filter(s => s.id !== id);
            saveData('classSchedules', classSchedules);
            showNotification('ÄÃ£ xÃ³a ca há»c!', 'success');

            if (schedule) {
                viewClass(schedule.classId);
            }
            renderClassesTable();
        }

        /* ============================================================
           ğŸ‘¤ PHáº¦N 26: GÃN Há»ŒC VIÃŠN VÃ€O Lá»šP
           ============================================================ */

        function openAssignStudentModal() {
            if (!currentViewingClassId) {
                showNotification('Vui lÃ²ng chá»n lá»›p trÆ°á»›c!', 'error');
                return;
            }

            const cls = classes.find(c => c.id === currentViewingClassId);
            if (!cls) return;

            // Kiá»ƒm tra cÃ²n chá»— khÃ´ng
            const currentCount = classStudents.filter(cs => cs.classId === currentViewingClassId && cs.status === 'active').length;
            if (currentCount >= cls.maxStudents) {
                showNotification('Lá»›p Ä‘Ã£ Ä‘áº§y!', 'error');
                return;
            }

            document.getElementById('assignClassId').value = currentViewingClassId;
            document.getElementById('assignStudentForm').reset();
            document.getElementById('assignRegistrationInfo').style.display = 'none';

            // Láº¥y cÃ¡c phiáº¿u ÄK chÆ°a gÃ¡n lá»›p, cÃ¹ng mÃ´n há»c
            const subject = subjects.find(s => s.id === cls.subjectId);
            const unassignedRegs = registrations.filter(r => {
                // Kiá»ƒm tra chÆ°a gÃ¡n lá»›p
                const isAssigned = classStudents.some(cs => cs.registrationId === r.id && cs.status === 'active');
                if (isAssigned) return false;

                // Kiá»ƒm tra cÃ¹ng mÃ´n há»c
                if (subject && r.subject !== subject.name) return false;

                return true;
            });

            document.getElementById('assignRegistrationId').innerHTML = '<option value="">-- Chá»n phiáº¿u ÄK chÆ°a gÃ¡n lá»›p --</option>' +
                unassignedRegs.map(r => {
                    const student = students.find(s => s.id === r.studentId);
                    return `<option value="${r.id}">${r.regCode} - ${student ? student.name : 'N/A'} - ${r.subject}</option>`;
                }).join('');

            if (unassignedRegs.length === 0) {
                showNotification('KhÃ´ng cÃ³ phiáº¿u ÄK nÃ o chÆ°a gÃ¡n lá»›p cho mÃ´n nÃ y!', 'warning');
            }

            openModal('assignStudentModal');
        }

        // ===== HIá»‚N THá»Š THÃ”NG TIN PHIáº¾U ÄK KHI GÃN Lá»šP =====
        function showRegistrationInfo() {
            const regId = document.getElementById('assignRegistrationId').value;
            const infoDiv = document.getElementById('assignRegistrationInfo');

            if (!regId) {
                infoDiv.style.display = 'none';
                return;
            }

            const reg = registrations.find(r => r.id === regId);
            if (!reg) return;

            const student = students.find(s => s.id === reg.studentId);

            // Láº¥y sá»‘ buá»•i tá»« phiáº¿u ÄK hoáº·c tá»« gÃ³i
            let totalSessions = reg.totalSessions;
            if (!totalSessions && reg.packageId) {
                const pkg = packages.find(p => p.id === reg.packageId);
                if (pkg) totalSessions = pkg.sessions;
            }
            if (!totalSessions) totalSessions = 8;

            document.getElementById('assignStudentName').textContent = student ? student.name : 'N/A';
            document.getElementById('assignSubject').textContent = reg.subject;
            document.getElementById('assignTotalSessions').textContent = totalSessions + ' buá»•i';

            infoDiv.style.display = 'block';
        }


        // ===== GÃN Há»ŒC VIÃŠN VÃ€O Lá»šP - Sá»¬ Dá»¤NG Sá» BUá»”I Tá»ª PHIáº¾U ÄK =====
        function assignStudentToClass(event) {
            event.preventDefault();

            const classId = document.getElementById('assignClassId').value;
            const regId = document.getElementById('assignRegistrationId').value;

            if (!regId) {
                showNotification('Vui lÃ²ng chá»n phiáº¿u Ä‘Äƒng kÃ½!', 'error');
                return;
            }

            const reg = registrations.find(r => r.id === regId);
            if (!reg) return;

            // Láº¥y sá»‘ buá»•i tá»« phiáº¿u ÄK (Æ°u tiÃªn), náº¿u khÃ´ng cÃ³ thÃ¬ láº¥y tá»« gÃ³i
            let totalSessions = reg.totalSessions;
            if (!totalSessions && reg.packageId) {
                const pkg = packages.find(p => p.id === reg.packageId);
                if (pkg) totalSessions = pkg.sessions;
            }
            if (!totalSessions) totalSessions = 8; // Máº·c Ä‘á»‹nh 8 buá»•i

            // Táº¡o báº£n ghi classStudent
            classStudents.push({
                id: generateId(),
                classId: classId,
                studentId: reg.studentId,
                registrationId: regId,
                totalSessions: totalSessions,
                completedSessions: 0,
                remainingSessions: totalSessions,
                status: 'active',
                enrolledAt: new Date().toISOString()
            });

            saveData('classStudents', classStudents);
            closeModal('assignStudentModal');
            viewClass(classId);
            renderClassesTable();
            showNotification('ÄÃ£ thÃªm há»c viÃªn vÃ o lá»›p!', 'success');
        }


        function removeStudentFromClass(classStudentId) {
            if (!confirm('XÃ³a há»c viÃªn khá»i lá»›p nÃ y?')) return;

            const cs = classStudents.find(c => c.id === classStudentId);
            classStudents = classStudents.filter(c => c.id !== classStudentId);
            saveData('classStudents', classStudents);
            showNotification('ÄÃ£ xÃ³a há»c viÃªn khá»i lá»›p!', 'success');

            if (cs) {
                viewClass(cs.classId);
            }
            renderClassesTable();
        }

        /* ============================================================
           âœ… PHáº¦N 27: ÄIá»‚M DANH
           ============================================================ */

        // ===== 27.1 Khá»Ÿi táº¡o tab Ä‘iá»ƒm danh =====
        function initAttendanceTab() {
            // Set ngÃ y máº·c Ä‘á»‹nh lÃ  hÃ´m nay
            document.getElementById('attendanceDate').value = new Date().toISOString().split('T')[0];

            // Populate dropdown lá»›p há»c
            populateAttendanceClassDropdown();

            // Load lá»‹ch há»c hÃ´m nay
            loadTodaySchedules();

            // Load lá»‹ch sá»­ Ä‘iá»ƒm danh
            loadAttendanceHistory();
        }

        function populateAttendanceClassDropdown() {
            const activeClasses = classes.filter(c => c.status === 'active' || c.status === 'new');
            document.getElementById('attendanceClassSelect').innerHTML = '<option value="">-- Chá»n lá»›p há»c --</option>' +
                activeClasses.map(c => {
                    const subject = subjects.find(s => s.id === c.subjectId);
                    return `<option value="${c.id}">${c.className} - ${subject ? subject.icon + ' ' + subject.name : ''}</option>`;
                }).join('');
        }

        // ===== 27.2 Lá»‹ch há»c hÃ´m nay =====
        function loadTodaySchedules() {
            const today = new Date();
            const dayOfWeek = today.getDay() === 0 ? 7 : today.getDay(); // CN = 7
            const todayStr = today.toISOString().split('T')[0];

            // TÃ¬m cÃ¡c ca há»c hÃ´m nay
            const todaySchedules = classSchedules.filter(s => s.dayOfWeek === dayOfWeek && s.isActive);

            const container = document.getElementById('todaySchedulesList');

            if (todaySchedules.length === 0) {
                container.innerHTML = '<p class="text-muted">KhÃ´ng cÃ³ lá»‹ch há»c hÃ´m nay</p>';
                return;
            }

            // Sáº¯p xáº¿p theo giá»
            todaySchedules.sort((a, b) => a.startTime.localeCompare(b.startTime));

            container.innerHTML = `
        <div class="table-container" style="box-shadow: none; border: none;">
            <table>
                <thead>
                    <tr>
                        <th>Giá» há»c</th>
                        <th>Lá»›p</th>
                        <th>GiÃ¡o viÃªn</th>
                        <th>SÄ© sá»‘</th>
                        <th>ÄÃ£ Ä‘iá»ƒm danh</th>
                        <th>Thao tÃ¡c</th>
                    </tr>
                </thead>
                <tbody>
                    ${todaySchedules.map(s => {
                const cls = classes.find(c => c.id === s.classId);
                if (!cls) return '';

                const teacher = teachers.find(t => t.id === cls.teacherId);
                const studentCount = classStudents.filter(cs => cs.classId === s.classId && cs.status === 'active').length;

                // Kiá»ƒm tra Ä‘Ã£ Ä‘iá»ƒm danh chÆ°a
                const attendedCount = attendances.filter(a =>
                    a.scheduleId === s.id &&
                    a.attendanceDate === todayStr
                ).length;

                const isCompleted = attendedCount >= studentCount && studentCount > 0;

                return `
                            <tr>
                                <td><strong>${s.startTime} - ${s.endTime}</strong></td>
                                <td>${cls.className}</td>
                                <td>${teacher ? teacher.fullName : '-'}</td>
                                <td>${studentCount}</td>
                                <td>${isCompleted ? '<span class="text-success">âœ… ÄÃ£ xong</span>' : `<span class="text-warning">${attendedCount}/${studentCount}</span>`}</td>
                                <td>
                                    <button class="btn btn-sm btn-primary" onclick="quickAttendance('${s.classId}', '${s.id}', '${todayStr}')">
                                        âœ… Äiá»ƒm danh
                                    </button>
                                </td>
                            </tr>
                        `;
            }).join('')}
                </tbody>
            </table>
        </div>
        `;
        }

        function refreshTodaySchedules() {
            loadTodaySchedules();
            showNotification('ÄÃ£ lÃ m má»›i!', 'success');
        }

        function quickAttendance(classId, scheduleId, date) {
            document.getElementById('attendanceClassSelect').value = classId;
            document.getElementById('attendanceDate').value = date;
            onAttendanceClassChange();

            setTimeout(() => {
                document.getElementById('attendanceScheduleSelect').value = scheduleId;
                loadAttendanceList();
            }, 100);
        }

        // ===== 27.3 Xá»­ lÃ½ chá»n lá»›p/ngÃ y =====
        function onAttendanceClassChange() {
            const classId = document.getElementById('attendanceClassSelect').value;
            const dateStr = document.getElementById('attendanceDate').value;

            if (!classId) {
                document.getElementById('attendanceScheduleSelect').innerHTML = '<option value="">-- Chá»n ca há»c --</option>';
                return;
            }

            // Láº¥y ngÃ y trong tuáº§n
            const date = new Date(dateStr);
            const dayOfWeek = date.getDay() === 0 ? 7 : date.getDay();

            // Lá»c ca há»c cá»§a lá»›p nÃ y vÃ o ngÃ y Ä‘Ã³
            const schedules = classSchedules.filter(s => s.classId === classId && s.dayOfWeek === dayOfWeek && s.isActive);

            document.getElementById('attendanceScheduleSelect').innerHTML = '<option value="">-- Chá»n ca há»c --</option>' +
                schedules.map(s => `<option value="${s.id}">${s.startTime} - ${s.endTime}${s.room ? ' (' + s.room + ')' : ''}</option>`).join('');

            if (schedules.length === 0) {
                showNotification('Lá»›p nÃ y khÃ´ng cÃ³ lá»‹ch há»c vÃ o ngÃ y Ä‘Ã£ chá»n!', 'warning');
            }
        }

        function onAttendanceDateChange() {
            onAttendanceClassChange();
        }

        // ===== 27.4 Load danh sÃ¡ch Ä‘iá»ƒm danh =====
        function loadAttendanceList() {
            const classId = document.getElementById('attendanceClassSelect').value;
            const scheduleId = document.getElementById('attendanceScheduleSelect').value;
            const dateStr = document.getElementById('attendanceDate').value;

            if (!classId || !scheduleId || !dateStr) {
                document.getElementById('attendanceTableCard').style.display = 'none';
                return;
            }

            const cls = classes.find(c => c.id === classId);
            const schedule = classSchedules.find(s => s.id === scheduleId);

            // Láº¥y há»c viÃªn trong lá»›p
            const clsStudents = classStudents.filter(cs => cs.classId === classId && cs.status === 'active');

            if (clsStudents.length === 0) {
                showNotification('Lá»›p nÃ y chÆ°a cÃ³ há»c viÃªn!', 'warning');
                document.getElementById('attendanceTableCard').style.display = 'none';
                return;
            }

            // Cáº­p nháº­t tiÃªu Ä‘á»
            document.getElementById('attendanceTableTitle').textContent =
                `ğŸ“‹ Äiá»ƒm danh: ${cls.className} - ${schedule.startTime}-${schedule.endTime} - ${formatDate(dateStr)}`;

            // Láº¥y Ä‘iá»ƒm danh Ä‘Ã£ cÃ³ (náº¿u cÃ³)
            const existingAttendances = attendances.filter(a =>
                a.scheduleId === scheduleId &&
                a.attendanceDate === dateStr
            );

            const tbody = document.getElementById('attendanceTableBody');
            tbody.innerHTML = clsStudents.map(cs => {
                const student = students.find(s => s.id === cs.studentId);
                const existing = existingAttendances.find(a => a.classStudentId === cs.id);
                const remainingClass = getSessionWarningClass(cs.remainingSessions);

                return `
            <tr data-class-student-id="${cs.id}" data-student-id="${cs.studentId}">
                <td><strong>${student ? student.name : 'N/A'}</strong></td>
                <td>${cs.totalSessions}</td>
                <td>${cs.completedSessions}</td>
                <td><span class="${remainingClass}">${cs.remainingSessions}</span></td>
                <td>
                    <div class="attendance-status-buttons" style="display: flex; gap: 5px;">
                        <button type="button" class="btn btn-sm ${existing?.status === 'present' ? 'btn-success' : 'btn-outline'}" 
                                onclick="setAttendanceStatus(this, 'present')" title="CÃ³ máº·t">âœ…</button>
                        <button type="button" class="btn btn-sm ${existing?.status === 'late' ? 'btn-warning' : 'btn-outline'}" 
                                onclick="setAttendanceStatus(this, 'late')" title="Muá»™n">ğŸŸ¡</button>
                        <button type="button" class="btn btn-sm ${existing?.status === 'absent' ? 'btn-danger' : 'btn-outline'}" 
                                onclick="setAttendanceStatus(this, 'absent')" title="Váº¯ng khÃ´ng phÃ©p">âŒ</button>
                        <button type="button" class="btn btn-sm ${existing?.status === 'excused' ? 'btn-info' : 'btn-outline'}" 
                                onclick="setAttendanceStatus(this, 'excused')" title="CÃ³ phÃ©p (táº¡o há»c bÃ¹)">ğŸ“</button>
                    </div>
                    <input type="hidden" class="attendance-status-input" value="${existing?.status || ''}">
                </td>
                <td>
                    <input type="text" class="attendance-note-input" style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;" 
                           placeholder="Ghi chÃº..." value="${existing?.notes || ''}">
                </td>
            </tr>
        `;
            }).join('');

            document.getElementById('attendanceTableCard').style.display = 'block';
        }

        function setAttendanceStatus(btn, status) {
            const row = btn.closest('tr');
            const buttons = row.querySelectorAll('.attendance-status-buttons button');
            const input = row.querySelector('.attendance-status-input');

            // Remove all active states
            buttons.forEach(b => {
                b.classList.remove('btn-success', 'btn-warning', 'btn-danger', 'btn-info');
                b.classList.add('btn-outline');
            });

            // Set active state
            const btnClasses = {
                'present': 'btn-success',
                'late': 'btn-warning',
                'absent': 'btn-danger',
                'excused': 'btn-info'
            };

            btn.classList.remove('btn-outline');
            btn.classList.add(btnClasses[status]);
            input.value = status;
        }

        function markAllPresent() {
            const rows = document.querySelectorAll('#attendanceTableBody tr');
            rows.forEach(row => {
                const presentBtn = row.querySelector('.attendance-status-buttons button:first-child');
                if (presentBtn) {
                    setAttendanceStatus(presentBtn, 'present');
                }
            });
            showNotification('ÄÃ£ Ä‘Ã¡nh dáº¥u táº¥t cáº£ CÃ³ máº·t!', 'success');
        }

        // ===== 27.5 LÆ°u Ä‘iá»ƒm danh =====
        function saveAttendance() {
            const classId = document.getElementById('attendanceClassSelect').value;
            const scheduleId = document.getElementById('attendanceScheduleSelect').value;
            const dateStr = document.getElementById('attendanceDate').value;

            if (!classId || !scheduleId || !dateStr) {
                showNotification('Vui lÃ²ng chá»n Ä‘áº§y Ä‘á»§ thÃ´ng tin!', 'error');
                return;
            }

            const rows = document.querySelectorAll('#attendanceTableBody tr');
            let savedCount = 0;
            let makeupCount = 0;

            rows.forEach(row => {
                const classStudentId = row.dataset.classStudentId;
                const studentId = row.dataset.studentId;
                const status = row.querySelector('.attendance-status-input').value;
                const notes = row.querySelector('.attendance-note-input').value.trim();

                if (!status) return; // Bá» qua náº¿u chÆ°a chá»n tráº¡ng thÃ¡i

                // Kiá»ƒm tra Ä‘Ã£ Ä‘iá»ƒm danh chÆ°a
                const existingIndex = attendances.findIndex(a =>
                    a.classStudentId === classStudentId &&
                    a.scheduleId === scheduleId &&
                    a.attendanceDate === dateStr
                );

                const attendanceData = {
                    classId,
                    scheduleId,
                    studentId,
                    classStudentId,
                    attendanceDate: dateStr,
                    status,
                    notes,
                    isMakeupSession: false,
                    makeupRequestId: null,
                    createdBy: currentUser.id,
                    updatedAt: new Date().toISOString()
                };

                if (existingIndex !== -1) {
                    // Cáº­p nháº­t
                    const oldStatus = attendances[existingIndex].status;
                    attendances[existingIndex] = { ...attendances[existingIndex], ...attendanceData };

                    // Xá»­ lÃ½ thay Ä‘á»•i tráº¡ng thÃ¡i
                    handleAttendanceStatusChange(classStudentId, oldStatus, status, attendances[existingIndex].id);
                } else {
                    // ThÃªm má»›i
                    const newAttendance = {
                        id: generateId(),
                        ...attendanceData,
                        createdAt: new Date().toISOString()
                    };
                    attendances.push(newAttendance);

                    // Xá»­ lÃ½ tráº¡ng thÃ¡i má»›i
                    handleNewAttendance(classStudentId, status, newAttendance.id);
                }

                if (status === 'excused') makeupCount++;
                savedCount++;
            });

            if (savedCount === 0) {
                showNotification('Vui lÃ²ng chá»n tráº¡ng thÃ¡i Ä‘iá»ƒm danh!', 'warning');
                return;
            }

            saveData('attendances', attendances);
            saveData('classStudents', classStudents);
            saveData('makeupRequests', makeupRequests);

            loadAttendanceList();
            loadTodaySchedules();
            loadAttendanceHistory();

            let msg = `ÄÃ£ lÆ°u Ä‘iá»ƒm danh cho ${savedCount} há»c viÃªn!`;
            if (makeupCount > 0) {
                msg += ` ÄÃ£ táº¡o ${makeupCount} yÃªu cáº§u há»c bÃ¹.`;
            }
            showNotification(msg, 'success');
        }

        /* ============================================================
        âœ… TASK 2.7: REVIEW VÃ€ Sá»¬A LOGIC ÄIá»‚M DANH
        
        LOGIC ÄIá»‚M DANH:
        ================
        
        TRáº NG THÃI VÃ€ HÃ€NH Äá»˜NG:
        - present (CÃ³ máº·t)  â†’ TRá»ª 1 buá»•i
        - late (Muá»™n)       â†’ TRá»ª 1 buá»•i  
        - absent (Váº¯ng KP)  â†’ TRá»ª 1 buá»•i (váº¯ng khÃ´ng phÃ©p váº«n tÃ­nh)
        - excused (CÃ³ phÃ©p) â†’ KHÃ”NG TRá»ª, táº¡o yÃªu cáº§u há»c bÃ¹
        
        KHI Sá»¬A TRáº NG THÃI:
        - present/late/absent â†’ excused: Cá»˜NG Láº I 1 buá»•i, táº¡o há»c bÃ¹
        - excused â†’ present/late/absent: TRá»ª 1 buá»•i, xÃ³a há»c bÃ¹
        - present â†” late â†” absent: KHÃ”NG THAY Äá»”I sá»‘ buá»•i
        
        ============================================================ */

        function handleNewAttendance(classStudentId, status, attendanceId) {
            const cs = classStudents.find(c => c.id === classStudentId);
            if (!cs) {
                console.warn('KhÃ´ng tÃ¬m tháº¥y classStudent:', classStudentId);
                return;
            }

            console.log(`[Äiá»ƒm danh Má»šI] HV: ${classStudentId}, Tráº¡ng thÃ¡i: ${status}`);

            if (status === 'present' || status === 'late' || status === 'absent') {
                // CÃ³ máº·t / Muá»™n / Váº¯ng khÃ´ng phÃ©p â†’ TRá»ª 1 buá»•i
                cs.completedSessions++;
                cs.remainingSessions = Math.max(0, cs.remainingSessions - 1);

                console.log(`  â†’ Trá»« 1 buá»•i. CÃ²n láº¡i: ${cs.remainingSessions}`);

                // Kiá»ƒm tra hoÃ n thÃ nh khÃ³a há»c
                if (cs.remainingSessions === 0) {
                    cs.status = 'completed';
                    console.log(`  â†’ ÄÃ£ hoÃ n thÃ nh khÃ³a há»c`);
                }
            } else if (status === 'excused') {
                // CÃ³ phÃ©p â†’ KHÃ”NG trá»« buá»•i, táº¡o yÃªu cáº§u há»c bÃ¹
                console.log(`  â†’ CÃ³ phÃ©p, khÃ´ng trá»« buá»•i. Táº¡o yÃªu cáº§u há»c bÃ¹.`);
                createMakeupRequest(classStudentId, attendanceId);
            }
        }

        function handleAttendanceStatusChange(classStudentId, oldStatus, newStatus, attendanceId) {
            // KhÃ´ng thay Ä‘á»•i náº¿u tráº¡ng thÃ¡i giá»‘ng nhau
            if (oldStatus === newStatus) {
                console.log(`[Äiá»ƒm danh Sá»¬A] Tráº¡ng thÃ¡i khÃ´ng Ä‘á»•i: ${oldStatus}`);
                return;
            }

            const cs = classStudents.find(c => c.id === classStudentId);
            if (!cs) {
                console.warn('KhÃ´ng tÃ¬m tháº¥y classStudent:', classStudentId);
                return;
            }

            console.log(`[Äiá»ƒm danh Sá»¬A] HV: ${classStudentId}, ${oldStatus} â†’ ${newStatus}`);

            // XÃ¡c Ä‘á»‹nh nhÃ³m tráº¡ng thÃ¡i
            const deductGroup = ['present', 'late', 'absent']; // NhÃ³m trá»« buá»•i
            const excusedGroup = ['excused']; // NhÃ³m khÃ´ng trá»« buá»•i

            const wasDeducted = deductGroup.includes(oldStatus);
            const willDeduct = deductGroup.includes(newStatus);
            const wasExcused = excusedGroup.includes(oldStatus);
            const willExcuse = excusedGroup.includes(newStatus);

            // CASE 1: Tá»« trá»« buá»•i â†’ cÃ³ phÃ©p (cá»™ng láº¡i 1 buá»•i, táº¡o há»c bÃ¹)
            if (wasDeducted && willExcuse) {
                cs.completedSessions = Math.max(0, cs.completedSessions - 1);
                cs.remainingSessions++;

                // Náº¿u Ä‘Ã£ completed, Ä‘á»•i láº¡i active
                if (cs.status === 'completed') {
                    cs.status = 'active';
                }

                console.log(`  â†’ Cá»™ng láº¡i 1 buá»•i. CÃ²n láº¡i: ${cs.remainingSessions}`);

                // Táº¡o yÃªu cáº§u há»c bÃ¹
                createMakeupRequest(classStudentId, attendanceId);
            }

            // CASE 2: Tá»« cÃ³ phÃ©p â†’ trá»« buá»•i (trá»« 1 buá»•i, xÃ³a há»c bÃ¹)
            else if (wasExcused && willDeduct) {
                cs.completedSessions++;
                cs.remainingSessions = Math.max(0, cs.remainingSessions - 1);

                console.log(`  â†’ Trá»« 1 buá»•i. CÃ²n láº¡i: ${cs.remainingSessions}`);

                // Kiá»ƒm tra hoÃ n thÃ nh
                if (cs.remainingSessions === 0) {
                    cs.status = 'completed';
                    console.log(`  â†’ ÄÃ£ hoÃ n thÃ nh khÃ³a há»c`);
                }

                // XÃ³a yÃªu cáº§u há»c bÃ¹ liÃªn quan
                const makeupIndex = makeupRequests.findIndex(m => m.originalAttendanceId === attendanceId);
                if (makeupIndex !== -1) {
                    console.log(`  â†’ XÃ³a yÃªu cáº§u há»c bÃ¹: ${makeupRequests[makeupIndex].id}`);
                    makeupRequests.splice(makeupIndex, 1);
                }
            }

            // CASE 3: Chuyá»ƒn trong cÃ¹ng nhÃ³m (present â†” late â†” absent)
            else if (wasDeducted && willDeduct) {
                console.log(`  â†’ Chuyá»ƒn trong nhÃ³m trá»« buá»•i, khÃ´ng thay Ä‘á»•i sá»‘ buá»•i`);
                // KhÃ´ng lÃ m gÃ¬, sá»‘ buá»•i giá»¯ nguyÃªn
            }

            // CASE 4: CÃ¡c trÆ°á»ng há»£p khÃ¡c (hiáº¿m)
            else {
                console.log(`  â†’ TrÆ°á»ng há»£p khÃ´ng xÃ¡c Ä‘á»‹nh: ${oldStatus} â†’ ${newStatus}`);
            }
        }

        // Cáº­p nháº­t hÃ m saveAttendance Ä‘á»ƒ sá»­ dá»¥ng Ä‘Ãºng logic
        function saveAttendance() {
            const classId = document.getElementById('attendanceClassSelect').value;
            const scheduleId = document.getElementById('attendanceScheduleSelect').value;
            const dateStr = document.getElementById('attendanceDate').value;

            if (!classId || !scheduleId || !dateStr) {
                showNotification('Vui lÃ²ng chá»n Ä‘áº§y Ä‘á»§ thÃ´ng tin!', 'error');
                return;
            }

            const rows = document.querySelectorAll('#attendanceTableBody tr');
            let savedCount = 0;
            let makeupCount = 0;
            let errors = [];

            rows.forEach(row => {
                const classStudentId = row.dataset.classStudentId;
                const studentId = row.dataset.studentId;
                const status = row.querySelector('.attendance-status-input').value;
                const notes = row.querySelector('.attendance-note-input').value.trim();

                if (!status) return; // Bá» qua náº¿u chÆ°a chá»n tráº¡ng thÃ¡i

                try {
                    // Kiá»ƒm tra Ä‘Ã£ Ä‘iá»ƒm danh chÆ°a
                    const existingIndex = attendances.findIndex(a =>
                        a.classStudentId === classStudentId &&
                        a.scheduleId === scheduleId &&
                        a.attendanceDate === dateStr
                    );

                    const attendanceData = {
                        classId,
                        scheduleId,
                        studentId,
                        classStudentId,
                        attendanceDate: dateStr,
                        status,
                        notes,
                        isMakeupSession: false,
                        makeupRequestId: null,
                        createdBy: currentUser?.id || null,
                        updatedAt: new Date().toISOString()
                    };

                    if (existingIndex !== -1) {
                        // Cáº¬P NHáº¬T Ä‘iá»ƒm danh Ä‘Ã£ cÃ³
                        const oldStatus = attendances[existingIndex].status;
                        const oldAttendanceId = attendances[existingIndex].id;

                        attendances[existingIndex] = {
                            ...attendances[existingIndex],
                            ...attendanceData
                        };

                        // Xá»­ lÃ½ thay Ä‘á»•i tráº¡ng thÃ¡i
                        handleAttendanceStatusChange(classStudentId, oldStatus, status, oldAttendanceId);

                    } else {
                        // THÃŠM Má»šI Ä‘iá»ƒm danh
                        const newAttendance = {
                            id: generateId(),
                            ...attendanceData,
                            createdAt: new Date().toISOString()
                        };
                        attendances.push(newAttendance);

                        // Xá»­ lÃ½ tráº¡ng thÃ¡i má»›i
                        handleNewAttendance(classStudentId, status, newAttendance.id);
                    }

                    if (status === 'excused') makeupCount++;
                    savedCount++;

                } catch (error) {
                    console.error('Lá»—i khi lÆ°u Ä‘iá»ƒm danh:', error);
                    errors.push(`Lá»—i vá»›i há»c viÃªn ${studentId}`);
                }
            });

            if (savedCount === 0) {
                showNotification('Vui lÃ²ng chá»n tráº¡ng thÃ¡i Ä‘iá»ƒm danh!', 'warning');
                return;
            }

            // LÆ°u táº¥t cáº£ dá»¯ liá»‡u
            saveData('attendances', attendances);
            saveData('classStudents', classStudents);
            saveData('makeupRequests', makeupRequests);

            // Refresh UI
            loadAttendanceList();
            loadTodaySchedules();
            loadAttendanceHistory();

            // ThÃ´ng bÃ¡o
            let msg = `âœ… ÄÃ£ lÆ°u Ä‘iá»ƒm danh cho ${savedCount} há»c viÃªn!`;
            if (makeupCount > 0) {
                msg += ` ÄÃ£ táº¡o ${makeupCount} yÃªu cáº§u há»c bÃ¹.`;
            }
            if (errors.length > 0) {
                msg += ` (${errors.length} lá»—i)`;
            }
            showNotification(msg, errors.length > 0 ? 'warning' : 'success');
        }


        function handleAttendanceStatusChange(classStudentId, oldStatus, newStatus, attendanceId) {
            if (oldStatus === newStatus) return;

            const cs = classStudents.find(c => c.id === classStudentId);
            if (!cs) return;

            // HoÃ n tÃ¡c tráº¡ng thÃ¡i cÅ©
            if (oldStatus === 'present' || oldStatus === 'late' || oldStatus === 'absent') {
                // Tráº¡ng thÃ¡i cÅ© Ä‘Ã£ trá»« buá»•i â†’ Cá»™ng láº¡i
                cs.completedSessions = Math.max(0, cs.completedSessions - 1);
                cs.remainingSessions++;
                if (cs.status === 'completed') cs.status = 'active';
            } else if (oldStatus === 'excused') {
                // Tráº¡ng thÃ¡i cÅ© lÃ  CÃ³ phÃ©p â†’ XÃ³a yÃªu cáº§u há»c bÃ¹
                makeupRequests = makeupRequests.filter(m => m.originalAttendanceId !== attendanceId);
            }

            // Ãp dá»¥ng tráº¡ng thÃ¡i má»›i
            handleNewAttendance(classStudentId, newStatus, attendanceId);
        }


        // ===== 27.6 Lá»‹ch sá»­ Ä‘iá»ƒm danh (CÃ“ PHÃ‚N TRANG) =====
        function loadAttendanceHistory() {
            // NhÃ³m theo ngÃ y + lá»›p + ca
            const grouped = {};

            attendances.forEach(a => {
                const key = `${a.attendanceDate}_${a.classId}_${a.scheduleId}`;
                if (!grouped[key]) {
                    grouped[key] = {
                        date: a.attendanceDate,
                        classId: a.classId,
                        scheduleId: a.scheduleId,
                        records: []
                    };
                }
                grouped[key].records.push(a);
            });

            // Sáº¯p xáº¿p theo ngÃ y má»›i nháº¥t
            const sortedGroups = Object.values(grouped).sort((a, b) =>
                new Date(b.date) - new Date(a.date)
            );

            // PHÃ‚N TRANG
            const { data, total, totalPages, currentPage } = getPaginatedData(sortedGroups, 'attendanceHistory');
            const tbody = document.getElementById('attendanceHistoryBody');

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">ChÆ°a cÃ³ dá»¯ liá»‡u Ä‘iá»ƒm danh</td></tr>';
                renderPagination('attendanceHistoryPagination', 'attendanceHistory', 0, 0, 1);
                return;
            }

            tbody.innerHTML = data.map(g => {
                const cls = classes.find(c => c.id === g.classId);
                const schedule = classSchedules.find(s => s.id === g.scheduleId);

                const totalStudents = g.records.length;
                const presentCount = g.records.filter(r => r.status === 'present' || r.status === 'late').length;
                const absentCount = g.records.filter(r => r.status === 'absent' || r.status === 'excused').length;

                return `
                    <tr>
                        <td><strong>${formatDate(g.date)}</strong></td>
                        <td>${cls ? cls.className : 'N/A'}</td>
                        <td>${schedule ? schedule.startTime + '-' + schedule.endTime : 'N/A'}</td>
                        <td>${totalStudents}</td>
                        <td><span class="text-success">${presentCount}</span></td>
                        <td><span class="text-danger">${absentCount}</span></td>
                        <td>
                            <button class="action-btn view" onclick="viewAttendanceDetail('${g.date}', '${g.classId}', '${g.scheduleId}')" title="Xem chi tiáº¿t">ğŸ‘ï¸</button>
                        </td>
                    </tr>
                `;
            }).join('');

            // RENDER PHÃ‚N TRANG
            renderPagination('attendanceHistoryPagination', 'attendanceHistory', total, totalPages, currentPage);
        }


        function viewAttendanceDetail(date, classId, scheduleId) {
            const cls = classes.find(c => c.id === classId);
            const schedule = classSchedules.find(s => s.id === scheduleId);
            const records = attendances.filter(a =>
                a.attendanceDate === date &&
                a.classId === classId &&
                a.scheduleId === scheduleId
            );

            const content = `
        <div class="quick-view-section">
            <h4>ğŸ“‹ ThÃ´ng tin buá»•i há»c</h4>
            <div class="quick-view-row"><span class="quick-view-label">Lá»›p:</span><span class="quick-view-value">${cls ? cls.className : 'N/A'}</span></div>
            <div class="quick-view-row"><span class="quick-view-label">NgÃ y:</span><span class="quick-view-value">${formatDate(date)}</span></div>
            <div class="quick-view-row"><span class="quick-view-label">Ca há»c:</span><span class="quick-view-value">${schedule ? schedule.startTime + ' - ' + schedule.endTime : 'N/A'}</span></div>
        </div>
        <div class="quick-view-section">
            <h4>ğŸ“Š Chi tiáº¿t Ä‘iá»ƒm danh</h4>
            <table style="width: 100%; font-size: 13px;">
                <thead>
                    <tr><th>Há»c viÃªn</th><th>Tráº¡ng thÃ¡i</th><th>Ghi chÃº</th></tr>
                </thead>
                <tbody>
                    ${records.map(r => {
                const student = students.find(s => s.id === r.studentId);
                return `
                            <tr>
                                <td>${student ? student.name : 'N/A'}</td>
                                <td>${getAttendanceStatusBadge(r.status)}</td>
                                <td>${r.notes || '-'}</td>
                            </tr>
                        `;
            }).join('')}
                </tbody>
            </table>
        </div>
        `;

            document.getElementById('viewAttendanceContent').innerHTML = content;
            openModal('viewAttendanceModal');
        }

        function getAttendanceStatusBadge(status) {
            const badges = {
                'present': '<span class="status-badge da-dk">âœ… CÃ³ máº·t</span>',
                'late': '<span class="status-badge cho-dk">ğŸŸ¡ Muá»™n</span>',
                'absent': '<span class="status-badge cancel">âŒ Váº¯ng</span>',
                'excused': '<span class="status-badge hoc-thu">ğŸ“ CÃ³ phÃ©p</span>'
            };
            return badges[status] || status;
        }

        function exportAttendanceToExcel() {
            if (attendances.length === 0) {
                showNotification('ChÆ°a cÃ³ dá»¯ liá»‡u Ä‘á»ƒ xuáº¥t!', 'warning');
                return;
            }

            const data = attendances.map(a => {
                const student = students.find(s => s.id === a.studentId);
                const cls = classes.find(c => c.id === a.classId);
                const schedule = classSchedules.find(s => s.id === a.scheduleId);

                return {
                    'NgÃ y': formatDate(a.attendanceDate),
                    'Lá»›p': cls ? cls.className : '',
                    'Ca há»c': schedule ? schedule.startTime + '-' + schedule.endTime : '',
                    'Há»c viÃªn': student ? student.name : '',
                    'Tráº¡ng thÃ¡i': a.status === 'present' ? 'CÃ³ máº·t' : a.status === 'late' ? 'Muá»™n' : a.status === 'absent' ? 'Váº¯ng' : 'CÃ³ phÃ©p',
                    'Ghi chÃº': a.notes || ''
                };
            });

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data), 'Äiá»ƒm danh');
            XLSX.writeFile(wb, `DiemDanh_${formatDateFile()}.xlsx`);
            showNotification('Xuáº¥t Excel thÃ nh cÃ´ng!', 'success');
        }

        /* ============================================================
        ğŸ“ TASK 2.8: Sá»¬A LOGIC Há»ŒC BÃ™ PRE-CREATED
        
        Khi Ä‘iá»ƒm danh "CÃ³ phÃ©p":
        1. Kiá»ƒm tra cÃ³ yÃªu cáº§u pre-created chÆ°a
        2. Náº¿u cÃ³ â†’ cáº­p nháº­t vá»›i attendanceId
        3. Náº¿u khÃ´ng â†’ táº¡o má»›i
        ============================================================ */

        function createMakeupRequest(classStudentId, attendanceId) {
            const cs = classStudents.find(c => c.id === classStudentId);
            const attendance = attendances.find(a => a.id === attendanceId);

            if (!cs || !attendance) {
                console.warn('KhÃ´ng tÃ¬m tháº¥y classStudent hoáº·c attendance');
                return;
            }

            console.log(`[Há»c bÃ¹] Kiá»ƒm tra yÃªu cáº§u cho HV: ${classStudentId}, NgÃ y: ${attendance.attendanceDate}`);

            // BÆ¯á»šC 1: Kiá»ƒm tra Ä‘Ã£ cÃ³ yÃªu cáº§u pre-created chÆ°a
            const preCreatedIndex = makeupRequests.findIndex(m =>
                m.classStudentId === classStudentId &&
                m.originalDate === attendance.attendanceDate &&
                m.isPreCreated === true &&
                (m.status === 'pending' || m.status === 'approved')
            );

            if (preCreatedIndex !== -1) {
                // Cáº¬P NHáº¬T yÃªu cáº§u Ä‘Ã£ táº¡o trÆ°á»›c
                console.log(`  â†’ TÃ¬m tháº¥y yÃªu cáº§u pre-created: ${makeupRequests[preCreatedIndex].id}`);

                makeupRequests[preCreatedIndex].originalAttendanceId = attendanceId;
                makeupRequests[preCreatedIndex].originalScheduleId = attendance.scheduleId;
                makeupRequests[preCreatedIndex].isPreCreated = false; // ÄÃ¡nh dáº¥u Ä‘Ã£ liÃªn káº¿t
                makeupRequests[preCreatedIndex].updatedAt = new Date().toISOString();

                console.log(`  â†’ ÄÃ£ cáº­p nháº­t vá»›i attendanceId: ${attendanceId}`);
                return;
            }

            // BÆ¯á»šC 2: Kiá»ƒm tra Ä‘Ã£ cÃ³ yÃªu cáº§u (khÃ´ng pháº£i pre-created) chÆ°a
            const existingRequest = makeupRequests.find(m =>
                m.originalAttendanceId === attendanceId
            );

            if (existingRequest) {
                console.log(`  â†’ ÄÃ£ cÃ³ yÃªu cáº§u há»c bÃ¹ cho attendance nÃ y: ${existingRequest.id}`);
                return; // KhÃ´ng táº¡o duplicate
            }

            // BÆ¯á»šC 3: Táº¡o yÃªu cáº§u há»c bÃ¹ Má»šI
            console.log(`  â†’ Táº¡o yÃªu cáº§u há»c bÃ¹ má»›i`);

            // TÃ­nh ngÃ y háº¿t háº¡n (30 ngÃ y tá»« ngÃ y nghá»‰)
            const expiryDate = new Date(attendance.attendanceDate);
            expiryDate.setDate(expiryDate.getDate() + 30);

            const newMakeupRequest = {
                id: generateId(),
                studentId: cs.studentId,
                classStudentId: classStudentId,
                originalAttendanceId: attendanceId,
                originalClassId: attendance.classId,
                originalScheduleId: attendance.scheduleId,
                originalDate: attendance.attendanceDate,
                requestDate: new Date().toISOString().split('T')[0],
                expiryDate: expiryDate.toISOString().split('T')[0],
                makeupClassId: null,
                makeupScheduleId: null,
                makeupDate: null,
                status: 'pending',
                approvedBy: null,
                approvedAt: null,
                completedAt: null,
                notes: null,
                isPreCreated: false,
                createdAt: new Date().toISOString()
            };

            makeupRequests.push(newMakeupRequest);
            console.log(`  â†’ ÄÃ£ táº¡o yÃªu cáº§u: ${newMakeupRequest.id}, Háº¡n: ${newMakeupRequest.expiryDate}`);
        }

        // Cáº­p nháº­t hÃ m saveNewMakeupRequest (táº¡o yÃªu cáº§u thá»§ cÃ´ng)
        function saveNewMakeupRequest(event) {
            event.preventDefault();

            const classId = document.getElementById('newMakeupClassSelect').value;
            const classStudentId = document.getElementById('newMakeupStudentSelect').value;
            const absentDate = document.getElementById('newMakeupAbsentDate').value;
            const reason = document.getElementById('newMakeupReason').value.trim();

            if (!classId || !classStudentId || !absentDate) {
                showNotification('Vui lÃ²ng Ä‘iá»n Ä‘áº§y Ä‘á»§ thÃ´ng tin!', 'error');
                return;
            }

            const cs = classStudents.find(c => c.id === classStudentId);
            if (!cs) {
                showNotification('KhÃ´ng tÃ¬m tháº¥y thÃ´ng tin há»c viÃªn!', 'error');
                return;
            }

            // Kiá»ƒm tra Ä‘Ã£ cÃ³ yÃªu cáº§u cho ngÃ y nÃ y chÆ°a
            const existing = makeupRequests.find(m =>
                m.classStudentId === classStudentId &&
                m.originalDate === absentDate &&
                m.status !== 'completed' &&
                m.status !== 'expired' &&
                m.status !== 'cancelled'
            );

            if (existing) {
                showNotification('ÄÃ£ cÃ³ yÃªu cáº§u há»c bÃ¹ cho ngÃ y nÃ y!', 'error');
                return;
            }

            // TÃ­nh ngÃ y háº¿t háº¡n (30 ngÃ y tá»« ngÃ y nghá»‰)
            const expiryDate = new Date(absentDate);
            expiryDate.setDate(expiryDate.getDate() + 30);

            // Táº¡o yÃªu cáº§u há»c bÃ¹ (PRE-CREATED)
            const newRequest = {
                id: generateId(),
                studentId: cs.studentId,
                classStudentId: classStudentId,
                originalAttendanceId: null, // ChÆ°a cÃ³, sáº½ cáº­p nháº­t khi Ä‘iá»ƒm danh
                originalClassId: classId,
                originalScheduleId: null,
                originalDate: absentDate,
                requestDate: new Date().toISOString().split('T')[0],
                expiryDate: expiryDate.toISOString().split('T')[0],
                makeupClassId: null,
                makeupScheduleId: null,
                makeupDate: null,
                status: 'pending',
                approvedBy: null,
                approvedAt: null,
                completedAt: null,
                notes: reason ? `LÃ½ do nghá»‰: ${reason}` : null,
                isPreCreated: true, // QUAN TRá»ŒNG: ÄÃ¡nh dáº¥u lÃ  táº¡o trÆ°á»›c
                createdAt: new Date().toISOString()
            };

            makeupRequests.push(newRequest);
            saveData('makeupRequests', makeupRequests);

            closeModal('createMakeupModal');
            renderMakeupRequests();
            showNotification('âœ… ÄÃ£ táº¡o yÃªu cáº§u há»c bÃ¹! Nhá»› Ä‘iá»ƒm danh "CÃ³ phÃ©p" vÃ o ngÃ y nghá»‰.', 'success');
        }

        // ===== 28.2 Render danh sÃ¡ch yÃªu cáº§u há»c bÃ¹ =====
        let currentMakeupFilter = 'all';

        function renderMakeupRequests() {
            updateMakeupStats();

            const tbody = document.getElementById('makeupRequestsBody');
            const today = new Date().toISOString().split('T')[0];

            let filtered = [...makeupRequests];

            // Ãp dá»¥ng filter
            if (currentMakeupFilter === 'pending') {
                filtered = filtered.filter(m => m.status === 'pending');
            } else if (currentMakeupFilter === 'approved') {
                filtered = filtered.filter(m => m.status === 'approved');
            } else if (currentMakeupFilter === 'expiring') {
                const in7Days = new Date();
                in7Days.setDate(in7Days.getDate() + 7);
                filtered = filtered.filter(m =>
                    (m.status === 'pending' || m.status === 'approved') &&
                    new Date(m.expiryDate) <= in7Days
                );
            } else if (currentMakeupFilter === 'completed') {
                filtered = filtered.filter(m => m.status === 'completed');
            } else if (currentMakeupFilter === 'expired') {
                filtered = filtered.filter(m => m.status === 'expired');
            }

            // Sáº¯p xáº¿p theo háº¡n gáº§n nháº¥t
            filtered.sort((a, b) => new Date(a.expiryDate) - new Date(b.expiryDate));

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">KhÃ´ng cÃ³ yÃªu cáº§u há»c bÃ¹</td></tr>';
                return;
            }

            tbody.innerHTML = filtered.map(m => {
                const student = students.find(s => s.id === m.studentId);
                const originalClass = classes.find(c => c.id === m.originalClassId);
                const makeupClass = m.makeupClassId ? classes.find(c => c.id === m.makeupClassId) : null;

                // TÃ­nh sá»‘ ngÃ y cÃ²n láº¡i
                const daysLeft = Math.ceil((new Date(m.expiryDate) - new Date(today)) / (1000 * 60 * 60 * 24));
                const expiryClass = daysLeft <= 3 ? 'text-danger fw-700' : daysLeft <= 7 ? 'text-warning fw-600' : '';

                return `
            <tr>
                <td><strong>${student ? student.name : 'N/A'}</strong></td>
                <td>${originalClass ? originalClass.className : 'N/A'}</td>
                <td>${formatDate(m.originalDate)}</td>
                <td><span class="${expiryClass}">${formatDate(m.expiryDate)} ${daysLeft > 0 ? `(${daysLeft} ngÃ y)` : ''}</span></td>
                <td>${makeupClass ? makeupClass.className : '<span class="text-muted">ChÆ°a xáº¿p</span>'}</td>
                <td>${m.makeupDate ? formatDate(m.makeupDate) : '-'}</td>
                <td>${getMakeupStatusBadge(m.status)}</td>
                <td>
                    <div class="action-buttons">
                        ${m.status === 'pending' ? `<button class="action-btn schedule" onclick="openScheduleMakeupModal('${m.id}')" title="Xáº¿p lá»‹ch">ğŸ“…</button>` : ''}
                        ${m.status === 'approved' ? `<button class="action-btn edit" onclick="openConfirmMakeupModal('${m.id}')" title="XÃ¡c nháº­n hoÃ n thÃ nh">âœ…</button>` : ''}
                        ${(m.status === 'pending' || m.status === 'approved') ? `<button class="action-btn delete" onclick="cancelMakeupRequest('${m.id}')" title="Há»§y">ğŸ—‘ï¸</button>` : ''}
                    </div>
                </td>
            </tr>
        `;
            }).join('');
        }

        function getMakeupStatusBadge(status) {
            const badges = {
                'pending': '<span class="status-badge cho-dk">â³ Chá» xáº¿p lá»‹ch</span>',
                'approved': '<span class="status-badge hoc-thu">ğŸ“… ÄÃ£ xáº¿p lá»‹ch</span>',
                'completed': '<span class="status-badge da-dk">âœ… HoÃ n thÃ nh</span>',
                'expired': '<span class="status-badge cancel">âŒ Háº¿t háº¡n</span>'
            };
            return badges[status] || status;
        }

        function updateMakeupStats() {
            const today = new Date().toISOString().split('T')[0];
            const in7Days = new Date();
            in7Days.setDate(in7Days.getDate() + 7);

            document.getElementById('makeupPendingCount').textContent = makeupRequests.filter(m => m.status === 'pending').length;
            document.getElementById('makeupApprovedCount').textContent = makeupRequests.filter(m => m.status === 'approved').length;
            document.getElementById('makeupExpiringCount').textContent = makeupRequests.filter(m =>
                (m.status === 'pending' || m.status === 'approved') &&
                new Date(m.expiryDate) <= in7Days
            ).length;
            document.getElementById('makeupCompletedCount').textContent = makeupRequests.filter(m => m.status === 'completed').length;
        }

        function filterMakeupRequests(filter) {
            currentMakeupFilter = filter;
            document.querySelectorAll('#makeup .filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
            });
            renderMakeupRequests();
        }

        // ===== 28.3 Xáº¿p lá»‹ch há»c bÃ¹ =====
        function openScheduleMakeupModal(requestId) {
            const request = makeupRequests.find(m => m.id === requestId);
            if (!request) return;

            const student = students.find(s => s.id === request.studentId);
            const originalClass = classes.find(c => c.id === request.originalClassId);

            document.getElementById('makeupRequestId').value = requestId;
            document.getElementById('makeupStudentName').textContent = student ? student.name : 'N/A';
            document.getElementById('makeupOriginalClass').textContent = originalClass ? originalClass.className : 'N/A';
            document.getElementById('makeupOriginalDate').textContent = formatDate(request.originalDate);
            document.getElementById('makeupExpiryDate').textContent = formatDate(request.expiryDate);

            // Set min/max date
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('makeupDate').min = today;
            document.getElementById('makeupDate').max = request.expiryDate;
            document.getElementById('makeupDate').value = '';

            // Populate táº¥t cáº£ lá»›p Ä‘ang hoáº¡t Ä‘á»™ng
            const activeClasses = classes.filter(c => c.status === 'active' || c.status === 'new');
            document.getElementById('makeupClassSelect').innerHTML = '<option value="">-- Chá»n lá»›p --</option>' +
                activeClasses.map(c => {
                    const subject = subjects.find(s => s.id === c.subjectId);
                    const isOriginal = c.id === request.originalClassId;
                    return `<option value="${c.id}" ${isOriginal ? 'selected' : ''}>${c.className}${isOriginal ? ' (Lá»›p gá»‘c)' : ''} - ${subject ? subject.name : ''}</option>`;
                }).join('');

            document.getElementById('makeupScheduleSelect').innerHTML = '<option value="">-- Chá»n ca há»c --</option>';
            document.getElementById('makeupNotes').value = '';

            openModal('scheduleMakeupModal');
        }

        function loadMakeupSchedules() {
            const classId = document.getElementById('makeupClassSelect').value;
            const dateStr = document.getElementById('makeupDate').value;

            if (!classId || !dateStr) {
                document.getElementById('makeupScheduleSelect').innerHTML = '<option value="">-- Chá»n ca há»c --</option>';
                return;
            }

            const date = new Date(dateStr);
            const dayOfWeek = date.getDay() === 0 ? 7 : date.getDay();

            const schedules = classSchedules.filter(s => s.classId === classId && s.dayOfWeek === dayOfWeek && s.isActive);

            if (schedules.length === 0) {
                document.getElementById('makeupScheduleSelect').innerHTML = '<option value="">KhÃ´ng cÃ³ ca há»c vÃ o ngÃ y nÃ y</option>';
                showNotification('Lá»›p nÃ y khÃ´ng cÃ³ lá»‹ch há»c vÃ o ngÃ y Ä‘Ã£ chá»n!', 'warning');
                return;
            }

            document.getElementById('makeupScheduleSelect').innerHTML = '<option value="">-- Chá»n ca há»c --</option>' +
                schedules.map(s => `<option value="${s.id}">${s.startTime} - ${s.endTime}${s.room ? ' (' + s.room + ')' : ''}</option>`).join('');
        }

        function saveMakeupSchedule(event) {
            event.preventDefault();

            const requestId = document.getElementById('makeupRequestId').value;
            const classId = document.getElementById('makeupClassSelect').value;
            const dateStr = document.getElementById('makeupDate').value;
            const scheduleId = document.getElementById('makeupScheduleSelect').value;
            const notes = document.getElementById('makeupNotes').value.trim();

            if (!classId || !dateStr || !scheduleId) {
                showNotification('Vui lÃ²ng chá»n Ä‘áº§y Ä‘á»§ thÃ´ng tin!', 'error');
                return;
            }

            const request = makeupRequests.find(m => m.id === requestId);
            if (!request) return;

            // Kiá»ƒm tra háº¡n
            if (dateStr > request.expiryDate) {
                showNotification('NgÃ y há»c bÃ¹ vÆ°á»£t quÃ¡ háº¡n cho phÃ©p!', 'error');
                return;
            }

            // Cáº­p nháº­t
            request.makeupClassId = classId;
            request.makeupScheduleId = scheduleId;
            request.makeupDate = dateStr;
            request.status = 'approved';
            request.approvedBy = currentUser.id;
            request.approvedAt = new Date().toISOString();
            request.notes = notes;

            saveData('makeupRequests', makeupRequests);
            closeModal('scheduleMakeupModal');
            renderMakeupRequests();
            showNotification('ÄÃ£ xáº¿p lá»‹ch há»c bÃ¹ thÃ nh cÃ´ng!', 'success');
        }

        // ===== 28.4 XÃ¡c nháº­n hoÃ n thÃ nh há»c bÃ¹ =====
        function openConfirmMakeupModal(requestId) {
            const request = makeupRequests.find(m => m.id === requestId);
            if (!request) return;

            const student = students.find(s => s.id === request.studentId);
            const makeupClass = classes.find(c => c.id === request.makeupClassId);

            document.getElementById('confirmMakeupId').value = requestId;
            document.getElementById('confirmMakeupStudent').textContent = student ? student.name : 'N/A';
            document.getElementById('confirmMakeupClass').textContent = makeupClass ? makeupClass.className : 'N/A';
            document.getElementById('confirmMakeupDate').textContent = formatDate(request.makeupDate);

            openModal('confirmMakeupModal');
        }

        function completeMakeupRequest() {
            const requestId = document.getElementById('confirmMakeupId').value;
            const request = makeupRequests.find(m => m.id === requestId);
            if (!request) return;

            // Táº¡o báº£n ghi Ä‘iá»ƒm danh cho buá»•i há»c bÃ¹
            attendances.push({
                id: generateId(),
                classId: request.makeupClassId,
                scheduleId: request.makeupScheduleId,
                studentId: request.studentId,
                classStudentId: request.classStudentId,
                attendanceDate: request.makeupDate,
                status: 'present',
                notes: 'Buá»•i há»c bÃ¹',
                isMakeupSession: true,
                makeupRequestId: requestId,
                createdBy: currentUser.id,
                createdAt: new Date().toISOString()
            });

            // Cáº­p nháº­t tráº¡ng thÃ¡i yÃªu cáº§u
            request.status = 'completed';
            request.completedAt = new Date().toISOString();

            // TRá»ª 1 BUá»”I (hoÃ n thÃ nh buá»•i há»c bÃ¹)
            const cs = classStudents.find(c => c.id === request.classStudentId);
            if (cs) {
                cs.completedSessions++;
                cs.remainingSessions = Math.max(0, cs.remainingSessions - 1);

                // Kiá»ƒm tra hoÃ n thÃ nh khÃ³a há»c
                if (cs.remainingSessions === 0) {
                    cs.status = 'completed';
                }
                saveData('classStudents', classStudents);
            }

            saveData('attendances', attendances);
            saveData('makeupRequests', makeupRequests);

            closeModal('confirmMakeupModal');
            renderMakeupRequests();
            loadAttendanceHistory();
            showNotification('ÄÃ£ xÃ¡c nháº­n hoÃ n thÃ nh há»c bÃ¹! ÄÃ£ trá»« 1 buá»•i.', 'success');
        }


        function cancelMakeupRequest(requestId) {
            if (!confirm('Há»§y yÃªu cáº§u há»c bÃ¹ nÃ y?\n\nâš ï¸ Buá»•i há»c sáº½ bá»‹ trá»« ngay.')) return;

            const request = makeupRequests.find(m => m.id === requestId);
            if (!request) return;

            // TRá»ª 1 BUá»”I (há»§y yÃªu cáº§u)
            const cs = classStudents.find(c => c.id === request.classStudentId);
            if (cs) {
                cs.completedSessions++;
                cs.remainingSessions = Math.max(0, cs.remainingSessions - 1);

                if (cs.remainingSessions === 0) {
                    cs.status = 'completed';
                }
                saveData('classStudents', classStudents);
            }

            // Äá»•i tráº¡ng thÃ¡i
            request.status = 'expired';
            request.notes = (request.notes || '') + ' | Há»§y thá»§ cÃ´ng';

            saveData('makeupRequests', makeupRequests);
            renderMakeupRequests();
            showNotification('ÄÃ£ há»§y yÃªu cáº§u há»c bÃ¹ vÃ  trá»« 1 buá»•i!', 'warning');
        }


        // ===== 28.5 Kiá»ƒm tra háº¿t háº¡n há»c bÃ¹ (cháº¡y khi load trang) =====
        function checkExpiredMakeupRequests() {
            const today = new Date().toISOString().split('T')[0];
            let expiredCount = 0;

            makeupRequests.forEach(m => {
                if ((m.status === 'pending' || m.status === 'approved') && m.expiryDate < today) {
                    m.status = 'expired';

                    // TRá»ª 1 BUá»”I (háº¿t háº¡n khÃ´ng há»c bÃ¹)
                    const cs = classStudents.find(c => c.id === m.classStudentId);
                    if (cs) {
                        cs.completedSessions++;
                        cs.remainingSessions = Math.max(0, cs.remainingSessions - 1);

                        if (cs.remainingSessions === 0) {
                            cs.status = 'completed';
                        }
                    }

                    expiredCount++;
                }
            });

            if (expiredCount > 0) {
                saveData('makeupRequests', makeupRequests);
                saveData('classStudents', classStudents);
                showNotification(`âš ï¸ ${expiredCount} yÃªu cáº§u há»c bÃ¹ Ä‘Ã£ háº¿t háº¡n vÃ  bá»‹ trá»« buá»•i!`, 'warning');
            }
        }

        // ===== 28.6 Táº¡o má»›i yÃªu cáº§u há»c bÃ¹ (linh hoáº¡t) =====
        function openCreateMakeupModal() {
            document.getElementById('createMakeupForm').reset();

            // Set ngÃ y máº·c Ä‘á»‹nh lÃ  ngÃ y mai
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('newMakeupAbsentDate').value = tomorrow.toISOString().split('T')[0];
            document.getElementById('newMakeupAbsentDate').min = new Date().toISOString().split('T')[0];

            // Populate lá»›p há»c
            const activeClasses = classes.filter(c => c.status === 'active' || c.status === 'new');
            document.getElementById('newMakeupClassSelect').innerHTML = '<option value="">-- Chá»n lá»›p há»c --</option>' +
                activeClasses.map(c => {
                    const subject = subjects.find(s => s.id === c.subjectId);
                    return `<option value="${c.id}">${c.className} - ${subject ? subject.icon + ' ' + subject.name : ''}</option>`;
                }).join('');

            document.getElementById('newMakeupStudentSelect').innerHTML = '<option value="">-- Chá»n há»c viÃªn --</option>';

            openModal('createMakeupModal');
        }

        function loadStudentsForMakeup() {
            const classId = document.getElementById('newMakeupClassSelect').value;

            if (!classId) {
                document.getElementById('newMakeupStudentSelect').innerHTML = '<option value="">-- Chá»n há»c viÃªn --</option>';
                return;
            }

            // Láº¥y há»c viÃªn trong lá»›p cÃ²n buá»•i há»c
            const clsStudents = classStudents.filter(cs => cs.classId === classId && cs.status === 'active' && cs.remainingSessions > 0);

            document.getElementById('newMakeupStudentSelect').innerHTML = '<option value="">-- Chá»n há»c viÃªn --</option>' +
                clsStudents.map(cs => {
                    const student = students.find(s => s.id === cs.studentId);
                    return `<option value="${cs.id}">${student ? student.name : 'N/A'} (CÃ²n ${cs.remainingSessions} buá»•i)</option>`;
                }).join('');
        }

        function saveNewMakeupRequest(event) {
            event.preventDefault();

            const classId = document.getElementById('newMakeupClassSelect').value;
            const classStudentId = document.getElementById('newMakeupStudentSelect').value;
            const absentDate = document.getElementById('newMakeupAbsentDate').value;
            const reason = document.getElementById('newMakeupReason').value.trim();

            if (!classId || !classStudentId || !absentDate) {
                showNotification('Vui lÃ²ng Ä‘iá»n Ä‘áº§y Ä‘á»§ thÃ´ng tin!', 'error');
                return;
            }

            const cs = classStudents.find(c => c.id === classStudentId);
            if (!cs) return;

            // Kiá»ƒm tra Ä‘Ã£ cÃ³ yÃªu cáº§u cho ngÃ y nÃ y chÆ°a
            const existing = makeupRequests.find(m =>
                m.classStudentId === classStudentId &&
                m.originalDate === absentDate &&
                m.status !== 'completed' && m.status !== 'expired'
            );

            if (existing) {
                showNotification('ÄÃ£ cÃ³ yÃªu cáº§u há»c bÃ¹ cho ngÃ y nÃ y!', 'error');
                return;
            }

            // TÃ­nh ngÃ y háº¿t háº¡n (30 ngÃ y tá»« ngÃ y nghá»‰)
            const expiryDate = new Date(absentDate);
            expiryDate.setDate(expiryDate.getDate() + 30);

            // Táº¡o yÃªu cáº§u há»c bÃ¹ (chÆ°a cÃ³ attendanceId vÃ¬ chÆ°a Ä‘iá»ƒm danh)
            makeupRequests.push({
                id: generateId(),
                studentId: cs.studentId,
                classStudentId: classStudentId,
                originalAttendanceId: null, // Sáº½ cáº­p nháº­t khi Ä‘iá»ƒm danh
                originalClassId: classId,
                originalScheduleId: null,
                originalDate: absentDate,
                requestDate: new Date().toISOString().split('T')[0],
                expiryDate: expiryDate.toISOString().split('T')[0],
                makeupClassId: null,
                makeupScheduleId: null,
                makeupDate: null,
                status: 'pending',
                approvedBy: null,
                approvedAt: null,
                completedAt: null,
                notes: reason ? `LÃ½ do nghá»‰: ${reason}` : null,
                isPreCreated: true, // ÄÃ¡nh dáº¥u lÃ  táº¡o trÆ°á»›c
                createdAt: new Date().toISOString()
            });

            saveData('makeupRequests', makeupRequests);
            closeModal('createMakeupModal');
            renderMakeupRequests();
            showNotification('ÄÃ£ táº¡o yÃªu cáº§u há»c bÃ¹! Nhá»› Ä‘iá»ƒm danh "CÃ³ phÃ©p" vÃ o ngÃ y nghá»‰.', 'success');
        }

        /* ============================================================
        ğŸ“ˆ PHáº¦N 30: BÃO CÃO THá»NG KÃŠ
        ============================================================ */

        // ===== 30.1 Biáº¿n lÆ°u trá»¯ Chart instances =====
        let chartInstances = {
            revenueTime: null,
            revenueSubject: null,
            studentTime: null,
            studentStatus: null,
            attendanceTime: null,
            attendanceRate: null,
            debtTime: null,
            debtStatus: null
        };

        let currentReportTab = 'revenue';
        let reportData = {
            fromDate: null,
            toDate: null
        };

        // ===== 30.2 Khá»Ÿi táº¡o tab BÃ¡o cÃ¡o =====
        function initReportsTab() {
            // Äáº·t máº·c Ä‘á»‹nh lÃ  thÃ¡ng hiá»‡n táº¡i
            const now = new Date();
            const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
            const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);

            document.getElementById('reportFromDate').value = firstDay.toISOString().split('T')[0];
            document.getElementById('reportToDate').value = lastDay.toISOString().split('T')[0];
            document.getElementById('reportPeriodType').value = 'thisMonth';

            onReportPeriodChange();
            loadReportData();
        }

        function onReportPeriodChange() {
            const periodType = document.getElementById('reportPeriodType').value;
            const now = new Date();
            let fromDate, toDate;

            switch (periodType) {
                case 'thisMonth':
                    fromDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    toDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    break;
                case 'lastMonth':
                    fromDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    toDate = new Date(now.getFullYear(), now.getMonth(), 0);
                    break;
                case 'thisQuarter':
                    const quarter = Math.floor(now.getMonth() / 3);
                    fromDate = new Date(now.getFullYear(), quarter * 3, 1);
                    toDate = new Date(now.getFullYear(), quarter * 3 + 3, 0);
                    break;
                case 'thisYear':
                    fromDate = new Date(now.getFullYear(), 0, 1);
                    toDate = new Date(now.getFullYear(), 11, 31);
                    break;
                case 'custom':
                    // Giá»¯ nguyÃªn giÃ¡ trá»‹ hiá»‡n táº¡i
                    return;
            }

            document.getElementById('reportFromDate').value = fromDate.toISOString().split('T')[0];
            document.getElementById('reportToDate').value = toDate.toISOString().split('T')[0];

            loadReportData();
        }

        function switchReportTab(tab) {
            currentReportTab = tab;

            // Update tab buttons
            document.querySelectorAll('.report-tab').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tab);
            });

            // Show/hide content
            document.querySelectorAll('.report-content').forEach(content => {
                content.style.display = 'none';
            });

            const tabMap = {
                'revenue': 'reportRevenue',
                'students': 'reportStudents',
                'attendance': 'reportAttendance',
                'debt': 'reportDebt'
            };

            document.getElementById(tabMap[tab]).style.display = 'block';

            // Load data for this tab
            loadReportData();
        }

        // ===== 30.3 Load dá»¯ liá»‡u bÃ¡o cÃ¡o =====
        function loadReportData() {
            const fromDate = document.getElementById('reportFromDate').value;
            const toDate = document.getElementById('reportToDate').value;

            if (!fromDate || !toDate) return;

            reportData.fromDate = fromDate;
            reportData.toDate = toDate;

            switch (currentReportTab) {
                case 'revenue':
                    loadRevenueReport();
                    break;
                case 'students':
                    loadStudentsReport();
                    break;
                case 'attendance':
                    loadAttendanceReport();
                    break;
                case 'debt':
                    loadDebtReport();
                    break;
            }
        }

        function refreshReports() {
            loadReportData();
            showNotification('ÄÃ£ lÃ m má»›i bÃ¡o cÃ¡o!', 'success');
        }

        // ===== 30.4 BÃ¡o cÃ¡o Doanh thu =====
        function loadRevenueReport() {
            const { fromDate, toDate } = reportData;

            // Lá»c biÃªn lai trong ká»³
            const filteredReceipts = receipts.filter(r => r.date >= fromDate && r.date <= toDate);

            // Thá»‘ng kÃª tá»•ng quan
            const totalAmount = filteredReceipts.reduce((sum, r) => sum + (parseFloat(r.amount) || 0), 0);
            const receiptCount = filteredReceipts.length;
            const avgAmount = receiptCount > 0 ? totalAmount / receiptCount : 0;

            // Phiáº¿u ÄK má»›i trong ká»³
            const newRegs = registrations.filter(r => r.registrationDate >= fromDate && r.registrationDate <= toDate);

            document.getElementById('revenueTotalAmount').textContent = formatCurrencyShort(totalAmount);
            document.getElementById('revenueReceiptCount').textContent = receiptCount;
            document.getElementById('revenueAvgAmount').textContent = formatCurrencyShort(avgAmount);
            document.getElementById('revenueRegCount').textContent = newRegs.length;

            // Biá»ƒu Ä‘á»“ doanh thu theo thá»i gian
            renderRevenueTimeChart(filteredReceipts);

            // Biá»ƒu Ä‘á»“ doanh thu theo mÃ´n há»c
            renderRevenueSubjectChart(filteredReceipts);
        }

        function renderRevenueTimeChart(data) {
            const loading = document.getElementById('revenueChartLoading');
            const canvas = document.getElementById('revenueTimeChart');
            const table = document.getElementById('revenueTimeTable');

            // NhÃ³m theo ngÃ y
            const grouped = {};
            data.forEach(r => {
                const date = r.date;
                if (!grouped[date]) grouped[date] = 0;
                grouped[date] += parseFloat(r.amount) || 0;
            });

            const labels = Object.keys(grouped).sort();
            const values = labels.map(l => grouped[l]);

            // Fallback table
            table.innerHTML = `
                <table style="width: 100%; font-size: 12px;">
                    <thead><tr><th>NgÃ y</th><th>Doanh thu</th></tr></thead>
                    <tbody>${labels.map((l, i) => `<tr><td>${formatDate(l)}</td><td class="text-success">${formatCurrency(values[i])}</td></tr>`).join('')}</tbody>
                </table>
            `;

            // Render chart
            try {
                if (typeof Chart === 'undefined') throw new Error('Chart.js not loaded');

                loading.style.display = 'none';
                canvas.style.display = 'block';
                table.style.display = 'none';

                // Destroy old chart
                if (chartInstances.revenueTime) {
                    chartInstances.revenueTime.destroy();
                }

                chartInstances.revenueTime = new Chart(canvas, {
                    type: 'bar',
                    data: {
                        labels: labels.map(l => formatDate(l)),
                        datasets: [{
                            label: 'Doanh thu',
                            data: values,
                            backgroundColor: 'rgba(74, 144, 164, 0.7)',
                            borderColor: 'rgba(74, 144, 164, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        return formatCurrency(context.raw);
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function (value) {
                                        return formatCurrencyShort(value);
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (e) {
                console.warn('Chart error:', e);
                loading.style.display = 'none';
                canvas.style.display = 'none';
                table.style.display = 'block';
            }
        }

        function renderRevenueSubjectChart(data) {
            const loading = document.getElementById('revenueSubjectLoading');
            const canvas = document.getElementById('revenueSubjectChart');
            const table = document.getElementById('revenueSubjectTable');

            // NhÃ³m theo mÃ´n há»c
            const grouped = {};
            data.forEach(r => {
                const reg = registrations.find(reg => reg.id === r.registrationId);
                const subject = reg ? reg.subject : 'KhÃ¡c';
                if (!grouped[subject]) grouped[subject] = 0;
                grouped[subject] += parseFloat(r.amount) || 0;
            });

            const labels = Object.keys(grouped);
            const values = labels.map(l => grouped[l]);
            const colors = ['#3498DB', '#27AE60', '#F39C12', '#9B59B6', '#E74C3C', '#1ABC9C', '#34495E'];

            // Fallback table
            table.innerHTML = `
                <table style="width: 100%; font-size: 12px;">
                    <thead><tr><th>MÃ´n há»c</th><th>Doanh thu</th></tr></thead>
                    <tbody>${labels.map((l, i) => `<tr><td>${l}</td><td class="text-success">${formatCurrency(values[i])}</td></tr>`).join('')}</tbody>
                </table>
            `;

            try {
                if (typeof Chart === 'undefined') throw new Error('Chart.js not loaded');

                loading.style.display = 'none';
                canvas.style.display = 'block';
                table.style.display = 'none';

                if (chartInstances.revenueSubject) {
                    chartInstances.revenueSubject.destroy();
                }

                chartInstances.revenueSubject = new Chart(canvas, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: values,
                            backgroundColor: colors.slice(0, labels.length),
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'bottom' },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        return context.label + ': ' + formatCurrency(context.raw);
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (e) {
                loading.style.display = 'none';
                canvas.style.display = 'none';
                table.style.display = 'block';
            }
        }

        // ===== 30.5 BÃ¡o cÃ¡o Há»c viÃªn =====
        function loadStudentsReport() {
            const { fromDate, toDate } = reportData;

            // Tá»•ng há»c viÃªn
            const totalStudents = students.length;

            // HV má»›i trong ká»³
            const newStudents = students.filter(s => s.createdAt && s.createdAt.split('T')[0] >= fromDate && s.createdAt.split('T')[0] <= toDate);

            // Theo tráº¡ng thÃ¡i
            const activeStudents = students.filter(s => s.status === 'ÄÃ£ ÄÄƒng KÃ½').length;
            const completedStudents = students.filter(s => s.status === 'HoÃ n ThÃ nh').length;

            document.getElementById('studentTotalCount').textContent = totalStudents;
            document.getElementById('studentNewCount').textContent = newStudents.length;
            document.getElementById('studentActiveCount').textContent = activeStudents;
            document.getElementById('studentCompletedCount').textContent = completedStudents;

            renderStudentTimeChart();
            renderStudentStatusChart();
        }

        function renderStudentTimeChart() {
            const loading = document.getElementById('studentChartLoading');
            const canvas = document.getElementById('studentTimeChart');
            const table = document.getElementById('studentTimeTable');

            // NhÃ³m theo thÃ¡ng
            const grouped = {};
            students.forEach(s => {
                if (!s.createdAt) return;
                const month = s.createdAt.substring(0, 7); // YYYY-MM
                if (!grouped[month]) grouped[month] = 0;
                grouped[month]++;
            });

            const labels = Object.keys(grouped).sort().slice(-6); // 6 thÃ¡ng gáº§n nháº¥t
            const values = labels.map(l => grouped[l]);

            table.innerHTML = `
                <table style="width: 100%; font-size: 12px;">
                    <thead><tr><th>ThÃ¡ng</th><th>HV má»›i</th></tr></thead>
                    <tbody>${labels.map((l, i) => `<tr><td>${l}</td><td>${values[i]}</td></tr>`).join('')}</tbody>
                </table>
            `;

            try {
                if (typeof Chart === 'undefined') throw new Error('Chart.js not loaded');

                loading.style.display = 'none';
                canvas.style.display = 'block';
                table.style.display = 'none';

                if (chartInstances.studentTime) {
                    chartInstances.studentTime.destroy();
                }

                chartInstances.studentTime = new Chart(canvas, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Há»c viÃªn má»›i',
                            data: values,
                            borderColor: '#3498DB',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            fill: true,
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: true } }
                    }
                });
            } catch (e) {
                loading.style.display = 'none';
                canvas.style.display = 'none';
                table.style.display = 'block';
            }
        }

        function renderStudentStatusChart() {
            const loading = document.getElementById('studentStatusLoading');
            const canvas = document.getElementById('studentStatusChart');
            const table = document.getElementById('studentStatusTable');

            const statusCounts = {
                'Há»c Thá»­': students.filter(s => s.status === 'Há»c Thá»­').length,
                'Chá» ÄÄƒng KÃ½': students.filter(s => s.status === 'Chá» ÄÄƒng KÃ½').length,
                'ÄÃ£ ÄÄƒng KÃ½': students.filter(s => s.status === 'ÄÃ£ ÄÄƒng KÃ½').length,
                'HoÃ n ThÃ nh': students.filter(s => s.status === 'HoÃ n ThÃ nh').length,
                'Cancel': students.filter(s => s.status === 'Cancel').length
            };

            const labels = Object.keys(statusCounts);
            const values = Object.values(statusCounts);
            const colors = ['#3498DB', '#F39C12', '#27AE60', '#9B59B6', '#E74C3C'];

            table.innerHTML = `
                <table style="width: 100%; font-size: 12px;">
                    <thead><tr><th>Tráº¡ng thÃ¡i</th><th>Sá»‘ lÆ°á»£ng</th></tr></thead>
                    <tbody>${labels.map((l, i) => `<tr><td>${l}</td><td>${values[i]}</td></tr>`).join('')}</tbody>
                </table>
            `;

            try {
                if (typeof Chart === 'undefined') throw new Error('Chart.js not loaded');

                loading.style.display = 'none';
                canvas.style.display = 'block';
                table.style.display = 'none';

                if (chartInstances.studentStatus) {
                    chartInstances.studentStatus.destroy();
                }

                chartInstances.studentStatus = new Chart(canvas, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: values,
                            backgroundColor: colors,
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { position: 'bottom' } }
                    }
                });
            } catch (e) {
                loading.style.display = 'none';
                canvas.style.display = 'none';
                table.style.display = 'block';
            }
        }

        // ===== 30.6 BÃ¡o cÃ¡o Äiá»ƒm danh =====
        function loadAttendanceReport() {
            const { fromDate, toDate } = reportData;

            const filteredAttendances = attendances.filter(a => a.attendanceDate >= fromDate && a.attendanceDate <= toDate);

            const totalCount = filteredAttendances.length;
            const presentCount = filteredAttendances.filter(a => a.status === 'present' || a.status === 'late').length;
            const absentCount = filteredAttendances.filter(a => a.status === 'absent').length;
            const makeupCount = filteredAttendances.filter(a => a.isMakeupSession).length;

            const presentRate = totalCount > 0 ? Math.round((presentCount / totalCount) * 100) : 0;

            document.getElementById('attendanceTotalCount').textContent = totalCount;
            document.getElementById('attendancePresentRate').textContent = presentRate + '%';
            document.getElementById('attendanceAbsentCount').textContent = absentCount;
            document.getElementById('attendanceMakeupCount').textContent = makeupCount;

            renderAttendanceTimeChart(filteredAttendances);
            renderAttendanceRateChart(filteredAttendances);
        }

        function renderAttendanceTimeChart(data) {
            const loading = document.getElementById('attendanceChartLoading');
            const canvas = document.getElementById('attendanceTimeChart');
            const table = document.getElementById('attendanceTimeTable');

            const grouped = {};
            data.forEach(a => {
                const date = a.attendanceDate;
                if (!grouped[date]) grouped[date] = { present: 0, absent: 0 };
                if (a.status === 'present' || a.status === 'late') grouped[date].present++;
                else grouped[date].absent++;
            });

            const labels = Object.keys(grouped).sort().slice(-14); // 14 ngÃ y gáº§n nháº¥t
            const presentValues = labels.map(l => grouped[l]?.present || 0);
            const absentValues = labels.map(l => grouped[l]?.absent || 0);

            table.innerHTML = `
                <table style="width: 100%; font-size: 12px;">
                    <thead><tr><th>NgÃ y</th><th>CÃ³ máº·t</th><th>Váº¯ng</th></tr></thead>
                    <tbody>${labels.map((l, i) => `<tr><td>${formatDate(l)}</td><td class="text-success">${presentValues[i]}</td><td class="text-danger">${absentValues[i]}</td></tr>`).join('')}</tbody>
                </table>
            `;

            try {
                if (typeof Chart === 'undefined') throw new Error('Chart.js not loaded');

                loading.style.display = 'none';
                canvas.style.display = 'block';
                table.style.display = 'none';

                if (chartInstances.attendanceTime) {
                    chartInstances.attendanceTime.destroy();
                }

                chartInstances.attendanceTime = new Chart(canvas, {
                    type: 'bar',
                    data: {
                        labels: labels.map(l => formatDate(l)),
                        datasets: [
                            {
                                label: 'CÃ³ máº·t',
                                data: presentValues,
                                backgroundColor: 'rgba(39, 174, 96, 0.7)'
                            },
                            {
                                label: 'Váº¯ng',
                                data: absentValues,
                                backgroundColor: 'rgba(231, 76, 60, 0.7)'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { position: 'top' } },
                        scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } }
                    }
                });
            } catch (e) {
                loading.style.display = 'none';
                canvas.style.display = 'none';
                table.style.display = 'block';
            }
        }

        function renderAttendanceRateChart(data) {
            const loading = document.getElementById('attendanceRateLoading');
            const canvas = document.getElementById('attendanceRateChart');
            const table = document.getElementById('attendanceRateTable');

            const counts = {
                'CÃ³ máº·t': data.filter(a => a.status === 'present').length,
                'Muá»™n': data.filter(a => a.status === 'late').length,
                'Váº¯ng': data.filter(a => a.status === 'absent').length,
                'CÃ³ phÃ©p': data.filter(a => a.status === 'excused').length
            };

            const labels = Object.keys(counts);
            const values = Object.values(counts);
            const colors = ['#27AE60', '#F39C12', '#E74C3C', '#3498DB'];

            table.innerHTML = `
                <table style="width: 100%; font-size: 12px;">
                    <thead><tr><th>Tráº¡ng thÃ¡i</th><th>Sá»‘ lÆ°á»£t</th></tr></thead>
                    <tbody>${labels.map((l, i) => `<tr><td>${l}</td><td>${values[i]}</td></tr>`).join('')}</tbody>
                </table>
            `;

            try {
                if (typeof Chart === 'undefined') throw new Error('Chart.js not loaded');

                loading.style.display = 'none';
                canvas.style.display = 'block';
                table.style.display = 'none';

                if (chartInstances.attendanceRate) {
                    chartInstances.attendanceRate.destroy();
                }

                chartInstances.attendanceRate = new Chart(canvas, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: values,
                            backgroundColor: colors,
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { position: 'bottom' } }
                    }
                });
            } catch (e) {
                loading.style.display = 'none';
                canvas.style.display = 'none';
                table.style.display = 'block';
            }
        }

        // ===== 30.7 BÃ¡o cÃ¡o CÃ´ng ná»£ =====
        function loadDebtReport() {
            const { fromDate, toDate } = reportData;

            // Tá»•ng pháº£i thu
            let totalDebt = 0;
            let totalPaid = 0;
            let remainingDebt = 0;

            registrations.forEach(reg => {
                const debt = calculateDebtForRegistration(reg.id);
                totalDebt += debt.totalAmount;
                remainingDebt += debt.debtAmount;
            });

            // ÄÃ£ thu trong ká»³
            const paidInPeriod = receipts
                .filter(r => r.date >= fromDate && r.date <= toDate)
                .reduce((sum, r) => sum + (parseFloat(r.amount) || 0), 0);

            const paidRate = totalDebt > 0 ? Math.round(((totalDebt - remainingDebt) / totalDebt) * 100) : 0;

            document.getElementById('debtReportTotal').textContent = formatCurrencyShort(totalDebt);
            document.getElementById('debtReportPaid').textContent = formatCurrencyShort(paidInPeriod);
            document.getElementById('debtReportRemaining').textContent = formatCurrencyShort(remainingDebt);
            document.getElementById('debtReportRate').textContent = paidRate + '%';

            renderDebtTimeChart();
            renderDebtStatusChart();
        }

        function renderDebtTimeChart() {
            const loading = document.getElementById('debtChartLoading');
            const canvas = document.getElementById('debtTimeChart');
            const table = document.getElementById('debtTimeTable');

            // NhÃ³m theo thÃ¡ng
            const grouped = {};
            receipts.forEach(r => {
                const month = r.date.substring(0, 7);
                if (!grouped[month]) grouped[month] = 0;
                grouped[month] += parseFloat(r.amount) || 0;
            });

            const labels = Object.keys(grouped).sort().slice(-6);
            const values = labels.map(l => grouped[l]);

            table.innerHTML = `
                <table style="width: 100%; font-size: 12px;">
                    <thead><tr><th>ThÃ¡ng</th><th>ÄÃ£ thu</th></tr></thead>
                    <tbody>${labels.map((l, i) => `<tr><td>${l}</td><td class="text-success">${formatCurrency(values[i])}</td></tr>`).join('')}</tbody>
                </table>
            `;

            try {
                if (typeof Chart === 'undefined') throw new Error('Chart.js not loaded');

                loading.style.display = 'none';
                canvas.style.display = 'block';
                table.style.display = 'none';

                if (chartInstances.debtTime) {
                    chartInstances.debtTime.destroy();
                }

                chartInstances.debtTime = new Chart(canvas, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'ÄÃ£ thu',
                            data: values,
                            backgroundColor: 'rgba(39, 174, 96, 0.7)',
                            borderColor: 'rgba(39, 174, 96, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { callback: value => formatCurrencyShort(value) }
                            }
                        }
                    }
                });
            } catch (e) {
                loading.style.display = 'none';
                canvas.style.display = 'none';
                table.style.display = 'block';
            }
        }

        function renderDebtStatusChart() {
            const loading = document.getElementById('debtStatusLoading');
            const canvas = document.getElementById('debtStatusChart');
            const table = document.getElementById('debtStatusTable');

            let paidCount = 0, partialCount = 0, unpaidCount = 0;

            registrations.forEach(reg => {
                const debt = calculateDebtForRegistration(reg.id);
                const status = getDebtStatus(debt.debtAmount, debt.paidAmount);
                if (status === 'paid') paidCount++;
                else if (status === 'partial') partialCount++;
                else unpaidCount++;
            });

            const labels = ['ÄÃ£ Ä‘Ã³ng Ä‘á»§', 'ÄÃ³ng 1 pháº§n', 'ChÆ°a Ä‘Ã³ng'];
            const values = [paidCount, partialCount, unpaidCount];
            const colors = ['#27AE60', '#F39C12', '#E74C3C'];

            table.innerHTML = `
                <table style="width: 100%; font-size: 12px;">
                    <thead><tr><th>Tráº¡ng thÃ¡i</th><th>Sá»‘ phiáº¿u</th></tr></thead>
                    <tbody>${labels.map((l, i) => `<tr><td>${l}</td><td>${values[i]}</td></tr>`).join('')}</tbody>
                </table>
            `;

            try {
                if (typeof Chart === 'undefined') throw new Error('Chart.js not loaded');

                loading.style.display = 'none';
                canvas.style.display = 'block';
                table.style.display = 'none';

                if (chartInstances.debtStatus) {
                    chartInstances.debtStatus.destroy();
                }

                chartInstances.debtStatus = new Chart(canvas, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: values,
                            backgroundColor: colors,
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { position: 'bottom' } }
                    }
                });
            } catch (e) {
                loading.style.display = 'none';
                canvas.style.display = 'none';
                table.style.display = 'block';
            }
        }

        // ===== 30.8 Export bÃ¡o cÃ¡o =====
        function exportReportToExcel() {
            const { fromDate, toDate } = reportData;
            const wb = XLSX.utils.book_new();

            // Sheet 1: Doanh thu
            const revenueData = receipts
                .filter(r => r.date >= fromDate && r.date <= toDate)
                .map(r => {
                    const student = students.find(s => s.id === r.studentId);
                    return {
                        'NgÃ y': formatDate(r.date),
                        'Há»c viÃªn': student ? student.name : '',
                        'Loáº¡i': r.type,
                        'Ná»™i dung': r.description,
                        'Sá»‘ tiá»n': r.amount
                    };
                });
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(revenueData), 'Doanh thu');

            // Sheet 2: Há»c viÃªn
            const studentData = students.map(s => ({
                'TÃªn': s.name,
                'Tuá»•i': s.age,
                'Phá»¥ huynh': s.parentName,
                'SÄT': s.parentPhone,
                'Tráº¡ng thÃ¡i': s.status,
                'NgÃ y táº¡o': s.createdAt ? formatDate(s.createdAt.split('T')[0]) : ''
            }));
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(studentData), 'Há»c viÃªn');

            // Sheet 3: Äiá»ƒm danh
            const attendanceData = attendances
                .filter(a => a.attendanceDate >= fromDate && a.attendanceDate <= toDate)
                .map(a => {
                    const student = students.find(s => s.id === a.studentId);
                    const cls = classes.find(c => c.id === a.classId);
                    return {
                        'NgÃ y': formatDate(a.attendanceDate),
                        'Lá»›p': cls ? cls.className : '',
                        'Há»c viÃªn': student ? student.name : '',
                        'Tráº¡ng thÃ¡i': a.status === 'present' ? 'CÃ³ máº·t' : a.status === 'late' ? 'Muá»™n' : a.status === 'absent' ? 'Váº¯ng' : 'CÃ³ phÃ©p',
                        'Há»c bÃ¹': a.isMakeupSession ? 'CÃ³' : ''
                    };
                });
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(attendanceData), 'Äiá»ƒm danh');

            // Sheet 4: CÃ´ng ná»£
            const debtData = registrations.map(reg => {
                const student = students.find(s => s.id === reg.studentId);
                const debt = calculateDebtForRegistration(reg.id);
                return {
                    'Há»c viÃªn': student ? student.name : '',
                    'MÃ£ phiáº¿u': reg.regCode,
                    'MÃ´n há»c': reg.subject,
                    'Tá»•ng tiá»n': debt.totalAmount,
                    'ÄÃ£ Ä‘Ã³ng': debt.paidAmount,
                    'CÃ²n ná»£': debt.debtAmount
                };
            });
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(debtData), 'CÃ´ng ná»£');

            XLSX.writeFile(wb, `BaoCao_${fromDate}_${toDate}.xlsx`);
            showNotification('Xuáº¥t bÃ¡o cÃ¡o Excel thÃ nh cÃ´ng!', 'success');
        }


        function renderAll() {
            // Dashboard
            renderDashboard();

            // Students
            renderSubjectCheckboxes();
            renderStudentsTable();
            updateStudentCounts();

            // Trial
            renderTrialStudentsTable();
            updateTrialCounts();

            // Appointments
            renderAppointmentsTable();

            // Registrations
            renderRegistrationsTable();

            // Receipts
            renderReceiptsTable();

            // Categories
            renderSubjectsTable();
            renderPackagesTable();
            renderPromotionsTable();

            // Teachers
            if (canViewTab('teachers')) {
                renderTeachersTable();
            }

            // Classes
            if (canViewTab('classes')) {
                renderClassesTable();
                populateClassFilters();
            }

            // Users
            if (canViewTab('users')) {
                renderUsersTable();
                renderPermissionMatrix();
            }

            // Export
            if (canViewTab('export')) {
                renderBackupHistory();
            }

            // Attendance
            if (canViewTab('attendance')) {
                initAttendanceTab();
            }

            // Makeup
            if (canViewTab('makeup')) {
                checkExpiredMakeupRequests();
                renderMakeupRequests();
            }
            // Rooms
            if (canViewTab('rooms')) {
                renderRoomsTable();
            }

            // Debts
            if (canViewTab('debts')) {
                renderDebtsTable();
            }
            // Reports
            if (canViewTab('reports')) {
                initReportsTab();
            }

            // Update action buttons based on permissions
            updateActionButtons();
        }

        /* ============================================================
        ğŸ’³ PHáº¦N 29: QUáº¢N LÃ CÃ”NG Ná»¢
        ============================================================ */

        // ===== 29.1 TÃ­nh toÃ¡n cÃ´ng ná»£ =====
        function calculateDebtForRegistration(regId) {
            const reg = registrations.find(r => r.id === regId);
            if (!reg) return { totalAmount: 0, paidAmount: 0, debtAmount: 0 };

            // Tá»•ng tiá»n = finalAmount (hoáº·c adjustedAmount náº¿u Ä‘Ã£ Ä‘iá»u chá»‰nh)
            const totalAmount = reg.adjustedAmount !== undefined ? reg.adjustedAmount : reg.finalAmount;

            // ÄÃ£ Ä‘Ã³ng = Tá»•ng cÃ¡c biÃªn lai liÃªn káº¿t
            const relatedReceipts = receipts.filter(r => r.registrationId === regId);
            const paidAmount = relatedReceipts.reduce((sum, r) => sum + (parseFloat(r.amount) || 0), 0);

            // CÃ²n ná»£
            const debtAmount = Math.max(0, totalAmount - paidAmount);

            return { totalAmount, paidAmount, debtAmount };
        }

        function getDebtStatus(debtAmount, paidAmount) {
            if (debtAmount === 0 && paidAmount > 0) return 'paid';      // ÄÃ£ Ä‘Ã³ng Ä‘á»§
            if (debtAmount > 0 && paidAmount > 0) return 'partial';     // ÄÃ³ng 1 pháº§n
            if (paidAmount === 0) return 'unpaid';                       // ChÆ°a Ä‘Ã³ng
            return 'unknown';
        }

        function getDebtStatusBadge(status) {
            const badges = {
                'paid': '<span class="status-badge da-dk">ğŸŸ¢ ÄÃ£ Ä‘Ã³ng Ä‘á»§</span>',
                'partial': '<span class="status-badge cho-dk">ğŸŸ¡ ÄÃ³ng 1 pháº§n</span>',
                'unpaid': '<span class="status-badge cancel">ğŸ”´ ChÆ°a Ä‘Ã³ng</span>'
            };
            return badges[status] || '';
        }

        // ===== 29.2 Render báº£ng cÃ´ng ná»£ (CÃ“ PHÃ‚N TRANG) =====
        let currentDebtFilter = 'all';

        function renderDebtsTable() {
            updateDebtStats();
            loadDebtWarnings();

            const tbody = document.getElementById('debtsTableBody');
            const searchTerm = document.getElementById('searchDebt')?.value?.toLowerCase() || '';

            // Láº¥y táº¥t cáº£ phiáº¿u ÄK
            let debtList = registrations.map(reg => {
                const student = students.find(s => s.id === reg.studentId);
                const debt = calculateDebtForRegistration(reg.id);
                const status = getDebtStatus(debt.debtAmount, debt.paidAmount);

                // Láº¥y thÃ´ng tin buá»•i cÃ²n láº¡i tá»« classStudents
                const cs = classStudents.find(c => c.registrationId === reg.id);
                const remainingSessions = cs ? cs.remainingSessions : null;

                // Kiá»ƒm tra cáº§n cáº£nh bÃ¡o khÃ´ng
                const needWarning = (debt.debtAmount > 0 && remainingSessions !== null && remainingSessions <= warningSettings.threshold1);

                return {
                    ...reg,
                    studentName: student ? student.name : 'N/A',
                    ...debt,
                    status,
                    remainingSessions,
                    needWarning
                };
            });

            // Ãp dá»¥ng filter
            if (currentDebtFilter === 'unpaid') {
                debtList = debtList.filter(d => d.status === 'unpaid');
            } else if (currentDebtFilter === 'partial') {
                debtList = debtList.filter(d => d.status === 'partial');
            } else if (currentDebtFilter === 'paid') {
                debtList = debtList.filter(d => d.status === 'paid');
            } else if (currentDebtFilter === 'warning') {
                debtList = debtList.filter(d => d.needWarning);
            }

            // TÃ¬m kiáº¿m
            if (searchTerm) {
                debtList = debtList.filter(d =>
                    d.studentName.toLowerCase().includes(searchTerm) ||
                    d.regCode.toLowerCase().includes(searchTerm) ||
                    d.subject.toLowerCase().includes(searchTerm)
                );
            }

            // Sáº¯p xáº¿p: Cáº§n cáº£nh bÃ¡o lÃªn trÆ°á»›c, sau Ä‘Ã³ theo ná»£ giáº£m dáº§n
            debtList.sort((a, b) => {
                if (a.needWarning && !b.needWarning) return -1;
                if (!a.needWarning && b.needWarning) return 1;
                return b.debtAmount - a.debtAmount;
            });

            // PHÃ‚N TRANG
            const { data, total, totalPages, currentPage } = getPaginatedData(debtList, 'debts');

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">KhÃ´ng cÃ³ dá»¯ liá»‡u cÃ´ng ná»£</td></tr>';
                renderPagination('debtsPagination', 'debts', 0, 0, 1);
                return;
            }

            tbody.innerHTML = data.map(d => {
                const sessionWarningClass = getSessionWarningClass(d.remainingSessions);
                const rowClass = d.needWarning ? 'style="background: #FEF9E7;"' : '';

                return `
                <tr ${rowClass}>
                    <td><strong>${d.studentName}</strong></td>
                    <td><span class="text-primary">${d.regCode}</span></td>
                    <td><span class="subject-tag">${d.subject}</span></td>
                    <td>${formatCurrency(d.totalAmount)}</td>
                    <td><span class="text-success">${formatCurrency(d.paidAmount)}</span></td>
                    <td><strong class="${d.debtAmount > 0 ? 'text-danger' : 'text-success'}">${formatCurrency(d.debtAmount)}</strong></td>
                    <td><span class="${sessionWarningClass}">${d.remainingSessions !== null ? d.remainingSessions + ' buá»•i' : '-'}</span></td>
                    <td>${getDebtStatusBadge(d.status)}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn view" onclick="viewDebtDetail('${d.id}')" title="Xem chi tiáº¿t">ğŸ‘ï¸</button>
                            ${d.debtAmount > 0 ? `<button class="action-btn receipt" onclick="openDebtPaymentModal('${d.id}')" title="Thanh toÃ¡n">ğŸ’°</button>` : ''}
                            ${canEdit('debts') ? `<button class="action-btn edit" onclick="openAdjustDebtModal('${d.id}')" title="Äiá»u chá»‰nh">âœï¸</button>` : ''}
                        </div>
                    </td>
                </tr>
            `;
            }).join('');

            // RENDER PHÃ‚N TRANG
            renderPagination('debtsPagination', 'debts', total, totalPages, currentPage);
        }

        // Cáº­p nháº­t hÃ m filter Ä‘á»ƒ reset page
        function filterDebts(filter) {
            currentDebtFilter = filter;
            paginationState.debts.page = 1; // Reset vá» trang 1
            document.querySelectorAll('#debts .filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
            });
            renderDebtsTable();
        }

        // Cáº­p nháº­t hÃ m search Ä‘á»ƒ reset page
        function searchDebts() {
            paginationState.debts.page = 1; // Reset vá» trang 1
            renderDebtsTable();
        }

        function filterDebts(filter) {
            currentDebtFilter = filter;
            document.querySelectorAll('#debts .filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
            });
            renderDebtsTable();
        }

        function searchDebts() {
            renderDebtsTable();
        }

        // ===== 29.3 Thá»‘ng kÃª cÃ´ng ná»£ =====
        function updateDebtStats() {
            let totalAmount = 0;
            let paidAmount = 0;
            let debtAmount = 0;
            let debtStudentCount = 0;

            const studentWithDebt = new Set();

            registrations.forEach(reg => {
                const debt = calculateDebtForRegistration(reg.id);
                totalAmount += debt.totalAmount;
                paidAmount += debt.paidAmount;
                debtAmount += debt.debtAmount;

                if (debt.debtAmount > 0) {
                    studentWithDebt.add(reg.studentId);
                }
            });

            debtStudentCount = studentWithDebt.size;

            document.getElementById('debtTotalAmount').textContent = formatCurrencyShort(totalAmount);
            document.getElementById('debtPaidAmount').textContent = formatCurrencyShort(paidAmount);
            document.getElementById('debtRemainingAmount').textContent = formatCurrencyShort(debtAmount);
            document.getElementById('debtStudentCount').textContent = debtStudentCount;
        }

        // ===== 29.4 Cáº£nh bÃ¡o cÃ´ng ná»£ =====
        function loadDebtWarnings() {
            const warnings = [];

            registrations.forEach(reg => {
                const student = students.find(s => s.id === reg.studentId);
                const debt = calculateDebtForRegistration(reg.id);
                const cs = classStudents.find(c => c.registrationId === reg.id);

                if (!cs || !student) return;

                const remaining = cs.remainingSessions;

                // Cáº£nh bÃ¡o cÃ²n ná»£ + Ã­t buá»•i
                if (debt.debtAmount > 0) {
                    let level = null;
                    let message = '';

                    if (remaining === 0) {
                        level = 'critical';
                        message = `ğŸ”´ <strong>${student.name}</strong> - Háº¾T BUá»”I + CÃ²n ná»£ <strong>${formatCurrency(debt.debtAmount)}</strong>`;
                    } else if (remaining <= warningSettings.threshold3) {
                        level = 'high';
                        message = `ğŸŸ  <strong>${student.name}</strong> - CÃ²n ${remaining} buá»•i + Ná»£ <strong>${formatCurrency(debt.debtAmount)}</strong>`;
                    } else if (remaining <= warningSettings.threshold2) {
                        level = 'medium';
                        message = `ğŸŸ¡ <strong>${student.name}</strong> - CÃ²n ${remaining} buá»•i + Ná»£ <strong>${formatCurrency(debt.debtAmount)}</strong>`;
                    } else if (remaining <= warningSettings.threshold1) {
                        level = 'low';
                        message = `âšª <strong>${student.name}</strong> - CÃ²n ${remaining} buá»•i + Ná»£ <strong>${formatCurrency(debt.debtAmount)}</strong>`;
                    }

                    if (level) {
                        warnings.push({ level, message, regId: reg.id, studentName: student.name, remaining, debtAmount: debt.debtAmount });
                    }
                }

                // Cáº£nh bÃ¡o Ã­t buá»•i (khÃ´ng ná»£)
                if (debt.debtAmount === 0 && remaining <= warningSettings.threshold2 && remaining > 0) {
                    warnings.push({
                        level: 'info',
                        message: `â„¹ï¸ <strong>${student.name}</strong> - CÃ²n ${remaining} buá»•i (ÄÃ£ Ä‘Ã³ng Ä‘á»§ há»c phÃ­)`,
                        regId: reg.id,
                        studentName: student.name,
                        remaining,
                        debtAmount: 0
                    });
                }
            });

            // Sáº¯p xáº¿p theo má»©c Ä‘á»™
            const levelOrder = { critical: 0, high: 1, medium: 2, low: 3, info: 4 };
            warnings.sort((a, b) => levelOrder[a.level] - levelOrder[b.level]);

            const container = document.getElementById('debtWarningsList');

            if (warnings.length === 0) {
                container.innerHTML = '<p class="text-success">âœ… KhÃ´ng cÃ³ cáº£nh bÃ¡o nÃ o</p>';
                return;
            }

            container.innerHTML = warnings.slice(0, 10).map(w => {
                const bgColor = {
                    critical: '#FDEDEC',
                    high: '#FEF5E7',
                    medium: '#FEF9E7',
                    low: '#F8F9FA',
                    info: '#EBF5FB'
                }[w.level];

                return `
                    <div style="background: ${bgColor}; padding: 10px 15px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-size: 13px;">${w.message}</span>
                        <button class="btn btn-sm btn-primary" onclick="openDebtPaymentModal('${w.regId}')">ğŸ’° Thu</button>
                    </div>
                `;
            }).join('');

            if (warnings.length > 10) {
                container.innerHTML += `<p class="text-muted text-center">... vÃ  ${warnings.length - 10} cáº£nh bÃ¡o khÃ¡c</p>`;
            }
        }

        function refreshDebtWarnings() {
            loadDebtWarnings();
            showNotification('ÄÃ£ lÃ m má»›i danh sÃ¡ch cáº£nh bÃ¡o!', 'success');
        }

        // ===== 29.5 Modal thanh toÃ¡n =====
        let currentPaymentRegId = null;

        function openDebtPaymentModal(regId) {
            const reg = registrations.find(r => r.id === regId);
            if (!reg) return;

            currentPaymentRegId = regId;

            const student = students.find(s => s.id === reg.studentId);
            const debt = calculateDebtForRegistration(regId);

            document.getElementById('paymentRegistrationId').value = regId;
            document.getElementById('paymentStudentName').textContent = student ? student.name : 'N/A';
            document.getElementById('paymentRegCode').textContent = reg.regCode;
            document.getElementById('paymentTotalAmount').textContent = formatCurrency(debt.totalAmount);
            document.getElementById('paymentPaidAmount').textContent = formatCurrency(debt.paidAmount);
            document.getElementById('paymentDebtAmount').textContent = formatCurrency(debt.debtAmount);

            document.getElementById('paymentAmount').value = formatNumberInput(debt.debtAmount);
            document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('paymentNotes').value = '';

            calculateRemainingDebt();

            openModal('debtPaymentModal');
        }

        function calculateRemainingDebt() {
            const regId = document.getElementById('paymentRegistrationId').value;
            const debt = calculateDebtForRegistration(regId);
            const paymentAmount = parseCurrencyInput(document.getElementById('paymentAmount').value);

            const remaining = Math.max(0, debt.debtAmount - paymentAmount);
            document.getElementById('paymentRemainingPreview').textContent = formatCurrency(remaining);

            if (remaining === 0) {
                document.getElementById('paymentPreview').style.background = '#E8F8F0';
                document.getElementById('paymentRemainingPreview').className = 'text-success';
            } else {
                document.getElementById('paymentPreview').style.background = '#FEF9E7';
                document.getElementById('paymentRemainingPreview').className = 'text-warning';
            }
        }

        function saveDebtPayment(event) {
            event.preventDefault();

            const regId = document.getElementById('paymentRegistrationId').value;
            const amount = parseCurrencyInput(document.getElementById('paymentAmount').value);
            const receiptType = document.getElementById('paymentReceiptType').value;
            const date = document.getElementById('paymentDate').value;
            const notes = document.getElementById('paymentNotes').value.trim();

            if (amount <= 0) {
                showNotification('Sá»‘ tiá»n thanh toÃ¡n pháº£i lá»›n hÆ¡n 0!', 'error');
                return;
            }

            const reg = registrations.find(r => r.id === regId);
            const student = students.find(s => s.id === reg.studentId);

            // Táº¡o biÃªn lai
            receipts.push({
                id: generateId(),
                studentId: reg.studentId,
                registrationId: regId,
                type: receiptType,
                description: `Thanh toÃ¡n há»c phÃ­ - ${reg.subject} - ${reg.regCode}`,
                amount: amount,
                date: date,
                notes: notes,
                parentName: student ? student.parentName : '',
                parentPhone: student ? student.parentPhone : '',
                createdBy: currentUser.id,
                createdAt: new Date().toISOString()
            });

            saveData('receipts', receipts);

            closeModal('debtPaymentModal');
            renderDebtsTable();
            renderReceiptsTable();

            const newDebt = calculateDebtForRegistration(regId);
            if (newDebt.debtAmount === 0) {
                showNotification('Thanh toÃ¡n thÃ nh cÃ´ng! Há»c viÃªn Ä‘Ã£ Ä‘Ã³ng Ä‘á»§ há»c phÃ­.', 'success');
            } else {
                showNotification(`Thanh toÃ¡n thÃ nh cÃ´ng! CÃ²n ná»£: ${formatCurrency(newDebt.debtAmount)}`, 'success');
            }
        }

        // ===== 29.6 Xem chi tiáº¿t cÃ´ng ná»£ =====
        function viewDebtDetail(regId) {
            const reg = registrations.find(r => r.id === regId);
            if (!reg) return;

            currentPaymentRegId = regId;

            const student = students.find(s => s.id === reg.studentId);
            const debt = calculateDebtForRegistration(regId);
            const relatedReceipts = receipts.filter(r => r.registrationId === regId);
            const cs = classStudents.find(c => c.registrationId === regId);
            const cls = cs ? classes.find(c => c.id === cs.classId) : null;

            document.getElementById('debtDetailContent').innerHTML = `
                <div class="d-flex gap-20 flex-wrap">
                    <div class="flex-1" style="min-width: 280px;">
                        <div class="quick-view-section">
                            <h4>ğŸ‘¤ ThÃ´ng tin há»c viÃªn</h4>
                            <div class="quick-view-row"><span class="quick-view-label">Há» tÃªn:</span><span class="quick-view-value"><strong>${student ? student.name : 'N/A'}</strong></span></div>
                            <div class="quick-view-row"><span class="quick-view-label">Phá»¥ huynh:</span><span class="quick-view-value">${student ? student.parentName : ''}</span></div>
                            <div class="quick-view-row"><span class="quick-view-label">SÄT:</span><span class="quick-view-value">${student ? student.parentPhone : ''}</span></div>
                        </div>
                        
                        <div class="quick-view-section">
                            <h4>ğŸ“‹ ThÃ´ng tin Ä‘Äƒng kÃ½</h4>
                            <div class="quick-view-row"><span class="quick-view-label">MÃ£ phiáº¿u:</span><span class="quick-view-value"><strong>${reg.regCode}</strong></span></div>
                            <div class="quick-view-row"><span class="quick-view-label">MÃ´n há»c:</span><span class="quick-view-value">${reg.subject}</span></div>
                            <div class="quick-view-row"><span class="quick-view-label">Lá»›p:</span><span class="quick-view-value">${cls ? cls.className : 'ChÆ°a gÃ¡n'}</span></div>
                            <div class="quick-view-row"><span class="quick-view-label">NgÃ y ÄK:</span><span class="quick-view-value">${formatDate(reg.registrationDate)}</span></div>
                        </div>
                    </div>
                    
                    <div class="flex-1" style="min-width: 280px;">
                        <div class="quick-view-section">
                            <h4>ğŸ’° ThÃ´ng tin cÃ´ng ná»£</h4>
                            <div class="quick-view-row"><span class="quick-view-label">Há»c phÃ­ gá»‘c:</span><span class="quick-view-value">${formatCurrency(reg.tuitionFee)}</span></div>
                            <div class="quick-view-row"><span class="quick-view-label">Giáº£m giÃ¡:</span><span class="quick-view-value text-danger">-${formatCurrency(reg.discountAmount || 0)}</span></div>
                            <div class="quick-view-row"><span class="quick-view-label">ThÃ nh tiá»n:</span><span class="quick-view-value"><strong>${formatCurrency(debt.totalAmount)}</strong></span></div>
                            <div class="quick-view-row"><span class="quick-view-label">ÄÃ£ Ä‘Ã³ng:</span><span class="quick-view-value text-success">${formatCurrency(debt.paidAmount)}</span></div>
                            <div class="quick-view-row"><span class="quick-view-label">CÃ²n ná»£:</span><span class="quick-view-value text-danger fw-700">${formatCurrency(debt.debtAmount)}</span></div>
                        </div>
                        
                        <div class="quick-view-section">
                            <h4>ğŸ“š Tiáº¿n Ä‘á»™ há»c</h4>
                            <div class="quick-view-row"><span class="quick-view-label">Tá»•ng buá»•i:</span><span class="quick-view-value">${cs ? cs.totalSessions : '-'}</span></div>
                            <div class="quick-view-row"><span class="quick-view-label">ÄÃ£ há»c:</span><span class="quick-view-value">${cs ? cs.completedSessions : '-'}</span></div>
                            <div class="quick-view-row"><span class="quick-view-label">CÃ²n láº¡i:</span><span class="quick-view-value ${cs ? getSessionWarningClass(cs.remainingSessions) : ''}">${cs ? cs.remainingSessions + ' buá»•i' : '-'}</span></div>
                        </div>
                    </div>
                </div>
                
                <div class="quick-view-section mt-15">
                    <h4>ğŸ§¾ Lá»‹ch sá»­ thanh toÃ¡n (${relatedReceipts.length})</h4>
                    ${relatedReceipts.length === 0 ? '<p class="text-muted">ChÆ°a cÃ³ thanh toÃ¡n nÃ o</p>' : `
                        <table style="width: 100%; font-size: 13px;">
                            <thead><tr><th>NgÃ y</th><th>Loáº¡i</th><th>Sá»‘ tiá»n</th><th>Ghi chÃº</th></tr></thead>
                            <tbody>
                                ${relatedReceipts.map(r => `
                                    <tr>
                                        <td>${formatDate(r.date)}</td>
                                        <td>${r.type}</td>
                                        <td class="text-success"><strong>${formatCurrency(r.amount)}</strong></td>
                                        <td>${r.notes || '-'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `}
                </div>
            `;

            // áº¨n/hiá»‡n nÃºt thanh toÃ¡n
            document.getElementById('debtDetailPayBtn').style.display = debt.debtAmount > 0 ? '' : 'none';

            openModal('debtDetailModal');
        }

        function openPaymentFromDetail() {
            closeModal('debtDetailModal');
            openDebtPaymentModal(currentPaymentRegId);
        }

        // ===== 29.7 Äiá»u chá»‰nh cÃ´ng ná»£ =====
        function openAdjustDebtModal(regId) {
            const reg = registrations.find(r => r.id === regId);
            if (!reg) return;

            const student = students.find(s => s.id === reg.studentId);
            const debt = calculateDebtForRegistration(regId);

            document.getElementById('adjustRegistrationId').value = regId;
            document.getElementById('adjustStudentName').textContent = student ? student.name : 'N/A';
            document.getElementById('adjustOriginalAmount').textContent = formatCurrency(debt.totalAmount);
            document.getElementById('adjustNewAmount').value = formatNumberInput(debt.totalAmount);
            document.getElementById('adjustReason').value = '';

            openModal('adjustDebtModal');
        }

        function saveAdjustedDebt(event) {
            event.preventDefault();

            const regId = document.getElementById('adjustRegistrationId').value;
            const newAmount = parseCurrencyInput(document.getElementById('adjustNewAmount').value);
            const reason = document.getElementById('adjustReason').value.trim();

            if (newAmount < 0) {
                showNotification('Sá»‘ tiá»n khÃ´ng há»£p lá»‡!', 'error');
                return;
            }

            const reg = registrations.find(r => r.id === regId);
            if (!reg) return;

            // LÆ°u lá»‹ch sá»­ Ä‘iá»u chá»‰nh
            if (!reg.adjustmentHistory) reg.adjustmentHistory = [];
            reg.adjustmentHistory.push({
                oldAmount: reg.adjustedAmount !== undefined ? reg.adjustedAmount : reg.finalAmount,
                newAmount: newAmount,
                reason: reason,
                adjustedBy: currentUser.id,
                adjustedAt: new Date().toISOString()
            });

            // Cáº­p nháº­t sá»‘ tiá»n
            reg.adjustedAmount = newAmount;

            saveData('registrations', registrations);
            closeModal('adjustDebtModal');
            renderDebtsTable();
            showNotification('ÄÃ£ Ä‘iá»u chá»‰nh cÃ´ng ná»£ thÃ nh cÃ´ng!', 'success');
        }

        // ===== 29.8 Export Excel =====
        function exportDebtsToExcel() {
            const data = registrations.map(reg => {
                const student = students.find(s => s.id === reg.studentId);
                const debt = calculateDebtForRegistration(reg.id);
                const cs = classStudents.find(c => c.registrationId === reg.id);

                return {
                    'Há»c viÃªn': student ? student.name : '',
                    'MÃ£ Phiáº¿u ÄK': reg.regCode,
                    'MÃ´n há»c': reg.subject,
                    'Tá»•ng tiá»n': debt.totalAmount,
                    'ÄÃ£ Ä‘Ã³ng': debt.paidAmount,
                    'CÃ²n ná»£': debt.debtAmount,
                    'CÃ²n buá»•i': cs ? cs.remainingSessions : '',
                    'Tráº¡ng thÃ¡i': debt.debtAmount === 0 ? 'ÄÃ£ Ä‘Ã³ng Ä‘á»§' : debt.paidAmount > 0 ? 'ÄÃ³ng 1 pháº§n' : 'ChÆ°a Ä‘Ã³ng'
                };
            });

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data), 'CÃ´ng ná»£');
            XLSX.writeFile(wb, `CongNo_${formatDateFile()}.xlsx`);
            showNotification('Xuáº¥t Excel thÃ nh cÃ´ng!', 'success');
        }

        // ===== 29.9 CÃ i Ä‘áº·t cáº£nh bÃ¡o =====
        function loadWarningSettings() {
            document.getElementById('warningThreshold1').value = warningSettings.threshold1;
            document.getElementById('warningThreshold2').value = warningSettings.threshold2;
            document.getElementById('warningThreshold3').value = warningSettings.threshold3;
            document.getElementById('showWarningOnDashboard').value = warningSettings.showOnDashboard ? 'true' : 'false';
        }

        function saveWarningSettings(event) {
            event.preventDefault();

            warningSettings.threshold1 = parseInt(document.getElementById('warningThreshold1').value) || 5;
            warningSettings.threshold2 = parseInt(document.getElementById('warningThreshold2').value) || 3;
            warningSettings.threshold3 = parseInt(document.getElementById('warningThreshold3').value) || 1;
            warningSettings.showOnDashboard = document.getElementById('showWarningOnDashboard').value === 'true';

            localStorage.setItem('warningSettings', JSON.stringify(warningSettings));
            showNotification('ÄÃ£ lÆ°u cÃ i Ä‘áº·t cáº£nh bÃ¡o!', 'success');

            // Refresh cáº£nh bÃ¡o
            if (document.getElementById('debts').classList.contains('active')) {
                renderDebtsTable();
            }
            renderDashboard();
        }

        // ===== 29.10 Cáº£nh bÃ¡o trÃªn Dashboard =====
        function renderDashboardWarnings() {
            if (!warningSettings.showOnDashboard) return '';

            const warnings = [];

            registrations.forEach(reg => {
                const student = students.find(s => s.id === reg.studentId);
                const debt = calculateDebtForRegistration(reg.id);
                const cs = classStudents.find(c => c.registrationId === reg.id);

                if (!cs || !student) return;

                const remaining = cs.remainingSessions;

                if (debt.debtAmount > 0 && remaining <= warningSettings.threshold2) {
                    warnings.push({
                        studentName: student.name,
                        remaining,
                        debtAmount: debt.debtAmount,
                        regId: reg.id
                    });
                }
            });

            if (warnings.length === 0) return '';

            return `
                <div class="card mt-20">
                    <div class="card-header">
                        <h3>âš ï¸ Cáº£nh bÃ¡o cÃ´ng ná»£ (${warnings.length})</h3>
                        <a href="#" onclick="switchTab('debts'); return false;" class="text-primary" style="font-size: 13px;">Xem táº¥t cáº£ â†’</a>
                    </div>
                    <div class="card-body">
                        ${warnings.slice(0, 5).map(w => `
                            <div style="background: #FEF9E7; padding: 10px 15px; border-radius: 8px; margin-bottom: 8px; font-size: 13px;">
                                <strong>${w.studentName}</strong> - CÃ²n ${w.remaining} buá»•i, ná»£ <strong class="text-danger">${formatCurrency(w.debtAmount)}</strong>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        /* ============================================================
           ğŸ¬ PHáº¦N 22: APP INITIALIZATION (Khá»Ÿi cháº¡y á»©ng dá»¥ng)
           ============================================================ */

        function initApp() {
            console.log('ğŸš€ Khá»Ÿi cháº¡y á»©ng dá»¥ng Profile 001 - V4.0');

            // 1. Khá»Ÿi táº¡o users máº·c Ä‘á»‹nh náº¿u chÆ°a cÃ³
            initializeDefaultUsers();

            // 2. LÆ°u subjects máº·c Ä‘á»‹nh náº¿u chÆ°a cÃ³
            if (!localStorage.getItem('subjects')) {
                saveData('subjects', subjects);
            }

            // 3. Kiá»ƒm tra Ä‘Äƒng nháº­p
            if (checkAuth()) {
                // ÄÃ£ Ä‘Äƒng nháº­p
                showApp();
                console.log('âœ… ÄÃ£ Ä‘Äƒng nháº­p:', currentUser.username);
            } else {
                // ChÆ°a Ä‘Äƒng nháº­p
                hideApp();
                console.log('ğŸ”’ ChÆ°a Ä‘Äƒng nháº­p, hiá»‡n mÃ n hÃ¬nh Login');
            }
        }

        // ===== Cháº¡y khi trang load xong =====
        document.addEventListener('DOMContentLoaded', function () {
            initApp();
        });

        // ===== Xá»­ lÃ½ khi nháº¥n Enter trong form login =====
        document.getElementById('loginForm').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                handleLogin(e);
            }
        });

        // ===== ÄÃ³ng modal khi click bÃªn ngoÃ i =====
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function (e) {
                if (e.target === this) {
                    this.classList.remove('active');
                }
            });
        });

        // ===== Keyboard shortcuts =====
        document.addEventListener('keydown', function (e) {
            // ESC Ä‘á»ƒ Ä‘Ã³ng modal
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal.active').forEach(modal => {
                    modal.classList.remove('active');
                });
            }
        });



        /* ============================================================
        ğŸ–¨ï¸ PHáº¦N 32: IN PHIáº¾U ÄÄ‚NG KÃ & BIÃŠN LAI (V2 - FIX)
        ============================================================ */

        // ===== 32.1 Chuyá»ƒn sá»‘ thÃ nh chá»¯ tiáº¿ng Viá»‡t =====
        function convertNumberToWords(number) {
            if (number === 0) return 'KhÃ´ng Ä‘á»“ng';
            if (!number || isNaN(number)) return '';

            const ones = ['', 'má»™t', 'hai', 'ba', 'bá»‘n', 'nÄƒm', 'sÃ¡u', 'báº£y', 'tÃ¡m', 'chÃ­n'];
            const tens = ['', 'mÆ°á»i', 'hai mÆ°Æ¡i', 'ba mÆ°Æ¡i', 'bá»‘n mÆ°Æ¡i', 'nÄƒm mÆ°Æ¡i', 'sÃ¡u mÆ°Æ¡i', 'báº£y mÆ°Æ¡i', 'tÃ¡m mÆ°Æ¡i', 'chÃ­n mÆ°Æ¡i'];

            function readThreeDigits(n) {
                let str = '';
                const hundred = Math.floor(n / 100);
                const ten = Math.floor((n % 100) / 10);
                const one = n % 10;

                if (hundred > 0) {
                    str += ones[hundred] + ' trÄƒm ';
                    if (ten === 0 && one > 0) str += 'láº» ';
                }

                if (ten > 1) {
                    str += tens[ten] + ' ';
                    if (one === 1) str += 'má»‘t ';
                    else if (one === 5) str += 'lÄƒm ';
                    else if (one > 0) str += ones[one] + ' ';
                } else if (ten === 1) {
                    str += 'mÆ°á»i ';
                    if (one === 5) str += 'lÄƒm ';
                    else if (one > 0) str += ones[one] + ' ';
                } else if (one > 0) {
                    str += ones[one] + ' ';
                }

                return str.trim();
            }

            let num = Math.abs(Math.floor(number));
            let result = '';

            if (num >= 1000000000) {
                result += readThreeDigits(Math.floor(num / 1000000000)) + ' tá»· ';
                num %= 1000000000;
            }

            if (num >= 1000000) {
                result += readThreeDigits(Math.floor(num / 1000000)) + ' triá»‡u ';
                num %= 1000000;
            }

            if (num >= 1000) {
                result += readThreeDigits(Math.floor(num / 1000)) + ' nghÃ¬n ';
                num %= 1000;
            }

            if (num > 0) {
                result += readThreeDigits(num);
            }

            result = result.trim();
            return result.charAt(0).toUpperCase() + result.slice(1) + ' Ä‘á»“ng';
        }

        // ===== 32.2 Táº¡o mÃ£ biÃªn lai cÃ³ ngÃ y =====
        function generateReceiptCode() {
            const date = new Date();
            const y = date.getFullYear().toString().slice(2);
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            const todayStr = `${y}${m}${d}`;

            const todayReceipts = receipts.filter(r => {
                const code = r.receiptCode || '';
                return code.includes(todayStr);
            });
            const seq = String(todayReceipts.length + 1).padStart(4, '0');

            return `BL${todayStr}-${seq}`;
        }

        // ===== 32.3 Generate QR Code =====
        function generateQRCodeImage(data, size = 50) {
            // Táº¡o QR code base64 URL Ä‘Æ¡n giáº£n
            // Sá»­ dá»¥ng API miá»…n phÃ­
            const encodedData = encodeURIComponent(data);
            return `https://api.qrserver.com/v1/create-qr-code/?size=${size}x${size}&data=${encodedData}&color=1e40af`;
        }

        // ===== 32.4 Generate HTML cho Phiáº¿u ÄÄƒng KÃ½ =====
        // ===== GENERATE HTML CHO PHIáº¾U ÄÄ‚NG KÃ - Cáº¬P NHáº¬T =====
        function generateRegistrationHTML(regId) {
            const reg = registrations.find(r => r.id === regId);
            if (!reg) return '';

            const student = students.find(s => s.id === reg.studentId);
            const pkg = reg.packageId ? packages.find(p => p.id === reg.packageId) : null;

            // Láº¥y sá»‘ buá»•i tá»« phiáº¿u ÄK hoáº·c tá»« gÃ³i
            const totalSessions = reg.totalSessions || (pkg ? pkg.sessions : 8);

            const qrData = `DK:${reg.regCode}|${student?.name || ''}|${reg.finalAmount}`;
            const qrImageUrl = generateQRCodeImage(qrData, 50);

            return `
                <div class="print-document">
                    <!-- Header -->
                    <div class="print-header">
                        <div class="print-header-left">
                            <div class="print-logo">
                                ${centerInfo.logo ? `<img src="${centerInfo.logo}" alt="Logo">` : 'ğŸ“š'}
                            </div>
                            <div class="print-company-info">
                                <h2>${centerInfo.name || 'TRUNG TÃ‚M Dáº Y Há»ŒC'}</h2>
                                <p>ğŸ“ ${centerInfo.address || 'Äá»‹a chá»‰ trung tÃ¢m'}</p>
                                <p>ğŸ“ ${centerInfo.phone || '0909.xxx.xxx'}${centerInfo.email ? ' | ' + centerInfo.email : ''}</p>
                            </div>
                        </div>
                        <div class="print-qr-code">
                            <img src="${qrImageUrl}" alt="QR Code">
                        </div>
                    </div>
                    
                    <!-- Title -->
                    <div class="print-title">
                        <h1>ğŸ“‹ PHIáº¾U ÄÄ‚NG KÃ Há»ŒC</h1>
                        <div class="doc-number">Sá»‘: <strong>${reg.regCode}</strong></div>
                    </div>
                    
                    <!-- ThÃ´ng tin há»c viÃªn -->
                    <div class="print-section">
                        <div class="print-section-title">ThÃ´ng tin há»c viÃªn</div>
                        <div class="print-row">
                            <span class="print-label">Há» tÃªn HV:</span>
                            <span class="print-value highlight">${student?.name || 'N/A'}</span>
                        </div>
                        ${student?.age ? `
                        <div class="print-row">
                            <span class="print-label">Tuá»•i:</span>
                            <span class="print-value">${student.age}</span>
                        </div>
                        ` : ''}
                        <div class="print-row">
                            <span class="print-label">Phá»¥ huynh:</span>
                            <span class="print-value">${reg.parentName || student?.parentName || ''}</span>
                        </div>
                        <div class="print-row">
                            <span class="print-label">Äiá»‡n thoáº¡i:</span>
                            <span class="print-value">${reg.parentPhone || student?.parentPhone || ''}</span>
                        </div>
                        ${student?.parentEmail ? `
                        <div class="print-row">
                            <span class="print-label">Email:</span>
                            <span class="print-value">${student.parentEmail}</span>
                        </div>
                        ` : ''}
                    </div>
                    
                    <!-- ThÃ´ng tin khÃ³a há»c -->
                    <div class="print-section">
                        <div class="print-section-title">ThÃ´ng tin khÃ³a há»c</div>
                        <div class="print-row">
                            <span class="print-label">MÃ´n há»c:</span>
                            <span class="print-value highlight">${reg.subject}</span>
                        </div>
                        ${pkg ? `
                        <div class="print-row">
                            <span class="print-label">GÃ³i há»c:</span>
                            <span class="print-value">${pkg.name}</span>
                        </div>
                        ` : ''}
                        <div class="print-row">
                            <span class="print-label">Sá»‘ buá»•i:</span>
                            <span class="print-value highlight">${totalSessions} buá»•i</span>
                        </div>
                        ${reg.startDate ? `
                        <div class="print-row">
                            <span class="print-label">NgÃ y báº¯t Ä‘áº§u:</span>
                            <span class="print-value">${formatDate(reg.startDate)}</span>
                        </div>
                        ` : ''}
                    </div>
                    
                    <!-- Chi tiáº¿t há»c phÃ­ -->
                    <div class="print-section">
                        <div class="print-section-title">Chi tiáº¿t há»c phÃ­</div>
                        <div class="print-amount-row">
                            <span class="print-amount-label">Há»c phÃ­ gá»‘c:</span>
                            <span class="print-amount-value">${formatCurrency(reg.tuitionFee)}</span>
                        </div>
                        ${reg.discountAmount > 0 ? `
                        <div class="print-amount-row">
                            <span class="print-amount-label">Khuyáº¿n mÃ£i/Giáº£m giÃ¡:</span>
                            <span class="print-amount-value negative">-${formatCurrency(reg.discountAmount)}</span>
                        </div>
                        ` : ''}
                    </div>
                    
                    <!-- ThÃ nh tiá»n -->
                    <div class="print-total">
                        <div class="print-total-row">
                            <span class="print-total-label">â–¶ THÃ€NH TIá»€N:</span>
                            <span class="print-total-value">${formatCurrency(reg.finalAmount)}</span>
                        </div>
                        <div class="print-total-words">(${convertNumberToWords(reg.finalAmount)})</div>
                    </div>
                    
                    <!-- ThÃ´ng tin thÃªm -->
                    <div class="print-info-grid">
                        <div class="print-info-item">
                            <span class="print-label">NgÃ y Ä‘Äƒng kÃ½:</span>
                            <span class="print-value">${formatDate(reg.registrationDate)}</span>
                        </div>
                    </div>
                    
                    ${reg.notes ? `
                    <div class="print-notes">
                        <span class="print-notes-label">Ghi chÃº: </span>
                        <span class="print-notes-content">${reg.notes}</span>
                    </div>
                    ` : ''}
                    
                    <!-- Chá»¯ kÃ½ -->
                    <div class="print-footer">
                        <div class="print-signatures">
                            <div class="print-signature-block">
                                <div class="print-signature-title">Chá»¯ kÃ½ Phá»¥ huynh</div>
                                <div class="print-signature-line">(KÃ½ vÃ  ghi rÃµ há» tÃªn)</div>
                            </div>
                            <div class="print-signature-block">
                                <div class="print-signature-title">NhÃ¢n viÃªn tiáº¿p nháº­n</div>
                                <div class="print-signature-line">(KÃ½, Ä‘Ã³ng dáº¥u)</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }


        // ===== 32.5 Generate HTML cho BiÃªn Lai =====
        function generateReceiptHTML(receiptId, options = {}) {
            const receipt = receipts.find(r => r.id === receiptId);
            if (!receipt) return '';

            const student = students.find(s => s.id === receipt.studentId);
            const reg = receipt.registrationId ? registrations.find(r => r.id === receipt.registrationId) : null;
            const cs = reg ? classStudents.find(c => c.registrationId === reg.id) : null;

            const showDebtInfo = options.showDebtInfo || false;
            const showBankInfo = options.showBankInfo || false;
            const showSessions = options.showSessions || false;

            let debtInfo = null;
            if (reg && showDebtInfo) {
                debtInfo = calculateDebtForRegistration(reg.id);
            }

            const receiptCode = receipt.receiptCode || `BL-${String(receipts.indexOf(receipt) + 1).padStart(4, '0')}`;
            const isTransfer = receipt.type === 'BiÃªn Lai Äiá»‡n Tá»­';
            const isCash = receipt.type === 'Phiáº¿u Thu';

            const qrData = `BL:${receiptCode}|${student?.name || ''}|${receipt.amount}`;
            const qrImageUrl = generateQRCodeImage(qrData, 50);

            return `
                <div class="print-document">
                    <!-- Header -->
                    <div class="print-header">
                        <div class="print-header-left">
                            <div class="print-logo">
                                ${centerInfo.logo ? `<img src="${centerInfo.logo}" alt="Logo">` : 'ğŸ“š'}
                            </div>
                            <div class="print-company-info">
                                <h2>${centerInfo.name || 'TRUNG TÃ‚M Dáº Y Há»ŒC'}</h2>
                                <p>ğŸ“ ${centerInfo.address || 'Äá»‹a chá»‰ trung tÃ¢m'}</p>
                                <p>ğŸ“ ${centerInfo.phone || '0909.xxx.xxx'}${centerInfo.email ? ' | ' + centerInfo.email : ''}</p>
                            </div>
                        </div>
                        <div class="print-qr-code">
                            <img src="${qrImageUrl}" alt="QR Code">
                        </div>
                    </div>
                    
                    <!-- Title -->
                    <div class="print-title">
                        <h1>ğŸ§¾ BIÃŠN LAI THU Há»ŒC PHÃ</h1>
                        <div class="doc-number">Sá»‘: <strong>${receiptCode}</strong></div>
                    </div>
                    
                    <!-- ThÃ´ng tin ngÆ°á»i ná»™p -->
                    <div class="print-section">
                        <div class="print-section-title">ThÃ´ng tin ngÆ°á»i ná»™p</div>
                        <div class="print-row">
                            <span class="print-label">NgÆ°á»i ná»™p:</span>
                            <span class="print-value">${receipt.parentName || student?.parentName || ''}</span>
                        </div>
                        <div class="print-row">
                            <span class="print-label">Äiá»‡n thoáº¡i:</span>
                            <span class="print-value">${receipt.parentPhone || student?.parentPhone || ''}</span>
                        </div>
                        <div class="print-row">
                            <span class="print-label">Ná»™p cho HV:</span>
                            <span class="print-value highlight">${student?.name || 'N/A'}</span>
                        </div>
                    </div>
                    
                    <!-- Ná»™i dung thu -->
                    <div class="print-section">
                        <div class="print-section-title">Ná»™i dung thu</div>
                        <div class="print-row">
                            <span class="print-label">Ná»™i dung:</span>
                            <span class="print-value">${receipt.description}</span>
                        </div>
                        ${reg ? `
                        <div class="print-row">
                            <span class="print-label">MÃ£ phiáº¿u ÄK:</span>
                            <span class="print-value">${reg.regCode}</span>
                        </div>
                        ` : ''}
                        ${showSessions && cs ? `
                        <div class="print-row">
                            <span class="print-label">Sá»‘ buá»•i:</span>
                            <span class="print-value">${cs.totalSessions} buá»•i</span>
                        </div>
                        ` : ''}
                    </div>
                    
                    <!-- Thanh toÃ¡n -->
                    ${showDebtInfo && debtInfo ? `
                    <div class="print-section">
                        <div class="print-section-title">Chi tiáº¿t thanh toÃ¡n</div>
                        <div class="print-amount-row">
                            <span class="print-amount-label">Tá»•ng há»c phÃ­:</span>
                            <span class="print-amount-value">${formatCurrency(debtInfo.totalAmount)}</span>
                        </div>
                        <div class="print-amount-row">
                            <span class="print-amount-label">ÄÃ£ TT trÆ°á»›c:</span>
                            <span class="print-amount-value">${formatCurrency(Math.max(0, debtInfo.paidAmount - receipt.amount))}</span>
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- Sá»‘ tiá»n thu -->
                    <div class="print-total">
                        <div class="print-total-row">
                            <span class="print-total-label">â–¶ Sá» TIá»€N${showDebtInfo ? ' THU Láº¦N NÃ€Y' : ''}:</span>
                            <span class="print-total-value">${formatCurrency(receipt.amount)}</span>
                        </div>
                        <div class="print-total-words">(${convertNumberToWords(receipt.amount)})</div>
                    </div>
                    
                    ${showDebtInfo && debtInfo ? `
                    <div class="print-debt-row ${debtInfo.debtAmount === 0 ? 'paid' : ''}">
                        <div class="print-total-row">
                            <span class="print-total-label">â–¶ CÃ’N Ná»¢:</span>
                            <span class="print-total-value">${formatCurrency(debtInfo.debtAmount)}</span>
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- HÃ¬nh thá»©c & NgÃ y -->
                    <div class="print-info-grid">
                        <div class="print-info-item">
                            <span class="print-label">HÃ¬nh thá»©c:</span>
                            <span class="print-value">
                                <span class="print-checkbox">
                                    <span class="print-checkbox-box ${isTransfer ? 'checked' : ''}">${isTransfer ? 'âœ“' : ''}</span> CK
                                </span>
                                &nbsp;
                                <span class="print-checkbox">
                                    <span class="print-checkbox-box ${isCash ? 'checked' : ''}">${isCash ? 'âœ“' : ''}</span> TM
                                </span>
                            </span>
                        </div>
                        <div class="print-info-item">
                            <span class="print-label">NgÃ y thu:</span>
                            <span class="print-value">${formatDate(receipt.date)}</span>
                        </div>
                    </div>
                    
                    ${showBankInfo && bankInfo.accountNumber ? `
                    <div class="print-bank-info">
                        <div class="print-bank-info-title">ThÃ´ng tin chuyá»ƒn khoáº£n:</div>
                        <div class="print-bank-info-content">
                            <strong>${bankInfo.bankName || ''}</strong> | STK: <strong>${bankInfo.accountNumber}</strong> | ${bankInfo.accountName || ''}
                        </div>
                    </div>
                    ` : ''}
                    
                    ${receipt.notes ? `
                    <div class="print-notes">
                        <span class="print-notes-label">Ghi chÃº: </span>
                        <span class="print-notes-content">${receipt.notes}</span>
                    </div>
                    ` : ''}
                    
                    <!-- Chá»¯ kÃ½ -->
                    <div class="print-footer">
                        <div class="print-signatures">
                            <div class="print-signature-block">
                                <div class="print-signature-title">NgÆ°á»i ná»™p tiá»n</div>
                                <div class="print-signature-line">(KÃ½ vÃ  ghi rÃµ há» tÃªn)</div>
                            </div>
                            <div class="print-signature-block">
                                <div class="print-signature-title">NgÆ°á»i thu tiá»n</div>
                                <div class="print-signature-line">(KÃ½, Ä‘Ã³ng dáº¥u)</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // ===== 32.6 Xem Phiáº¿u ÄÄƒng KÃ½ =====
        function viewRegistration(id) {
            const reg = registrations.find(r => r.id === id);
            if (!reg) return;

            const previewHTML = generateRegistrationHTML(id);

            document.getElementById('registrationPreviewContent').innerHTML = `
                <div class="print-preview-wrapper">
                    ${previewHTML}
                </div>
            `;

            openModal('viewRegistrationModal');
        }

        // ===== 32.7 Xem BiÃªn Lai =====
        let currentViewReceiptId = null;

        function viewReceipt(id) {
            currentViewReceiptId = id;
            const receipt = receipts.find(r => r.id === id);
            if (!receipt) return;

            const previewHTML = generateReceiptHTML(id, {
                showDebtInfo: false,
                showBankInfo: false,
                showSessions: false
            });

            document.getElementById('receiptPreviewContent').innerHTML = `
                <!-- Options á»Ÿ cuá»‘i, trÆ°á»›c nÃºt In -->
                <div class="print-preview-wrapper" id="receiptPreviewArea">
                    ${previewHTML}
                </div>
                
                <div class="print-options" style="margin-top: 15px; margin-bottom: 0;">
                    <div class="print-options-title">ğŸ“‹ TÃ¹y chá»n hiá»ƒn thá»‹ khi in:</div>
                    <div class="print-options-grid">
                        <label class="print-option-item">
                            <input type="checkbox" id="optShowDebtInfo" onchange="updateReceiptPreview()">
                            Hiá»‡n thÃ´ng tin cÃ´ng ná»£
                        </label>
                        <label class="print-option-item">
                            <input type="checkbox" id="optShowBankInfo" onchange="updateReceiptPreview()">
                            Hiá»‡n thÃ´ng tin ngÃ¢n hÃ ng
                        </label>
                        <label class="print-option-item">
                            <input type="checkbox" id="optShowSessions" onchange="updateReceiptPreview()">
                            Hiá»‡n sá»‘ buá»•i há»c
                        </label>
                    </div>
                </div>
            `;

            openModal('viewReceiptModal');
        }

        function updateReceiptPreview() {
            if (!currentViewReceiptId) return;

            const options = {
                showDebtInfo: document.getElementById('optShowDebtInfo')?.checked || false,
                showBankInfo: document.getElementById('optShowBankInfo')?.checked || false,
                showSessions: document.getElementById('optShowSessions')?.checked || false
            };

            const previewHTML = generateReceiptHTML(currentViewReceiptId, options);
            document.getElementById('receiptPreviewArea').innerHTML = previewHTML;
        }

        // ===== 32.8 In Phiáº¿u ÄÄƒng KÃ½ =====
        function printRegistration() {
            const modal = document.getElementById('viewRegistrationModal');
            const printDoc = modal.querySelector('.print-document');
            if (!printDoc) return;

            openPrintWindow(printDoc.outerHTML, 'Phiáº¿u ÄÄƒng KÃ½');
        }

        // ===== 32.9 In BiÃªn Lai =====
        function printReceipt() {
            if (!currentViewReceiptId) return;

            const options = {
                showDebtInfo: document.getElementById('optShowDebtInfo')?.checked || false,
                showBankInfo: document.getElementById('optShowBankInfo')?.checked || false,
                showSessions: document.getElementById('optShowSessions')?.checked || false
            };

            const printContent = generateReceiptHTML(currentViewReceiptId, options);
            openPrintWindow(printContent, 'BiÃªn Lai');
        }


        // ===== 32.10 Má»Ÿ cá»­a sá»• in (ÄÃƒ Sá»¬A CÄ‚N GIá»®A PDF) =====
        function openPrintWindow(content, title) {
            const printWindow = window.open('', '_blank', 'width=900,height=700');

            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${title}</title>
                    <meta charset="UTF-8">
                    <style>
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        
                        html, body {
                            width: 100%;
                            height: 100%;
                        }
                        
                        body { 
                            font-family: 'Times New Roman', Times, serif; 
                            font-size: 14px; 
                            color: #1a1a1a; 
                            line-height: 1.6; 
                            background: #f0f0f0;
                            padding: 20px;
                            display: flex;
                            justify-content: center;
                            align-items: flex-start;
                            min-height: 100vh;
                        }
                        
                        .print-document {
                            width: 210mm;
                            min-height: 297mm;
                            padding: 15mm 20mm;
                            margin: 0 auto;
                            background: white;
                            box-shadow: 0 0 10px rgba(0,0,0,0.1);
                        }
                        
                        .print-header { display: flex; justify-content: space-between; align-items: flex-start; padding-bottom: 15px; border-bottom: 2px solid #1e40af; margin-bottom: 20px; }
                        .print-header-left { display: flex; align-items: center; gap: 15px; flex: 1; }
                        .print-logo { width: 60px; height: 60px; background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 32px; color: white; flex-shrink: 0; }
                        .print-logo img { max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 10px; }
                        .print-company-info h2 { color: #1e40af; font-size: 18px; font-weight: 700; margin-bottom: 4px; text-transform: uppercase; }
                        .print-company-info p { font-size: 12px; color: #475569; margin: 2px 0; }
                        .print-qr-code { width: 70px; height: 70px; border: 1px solid #e2e8f0; border-radius: 8px; padding: 5px; flex-shrink: 0; }
                        .print-qr-code img { width: 100%; height: 100%; }
                        .print-title { text-align: center; margin: 25px 0; }
                        .print-title h1 { color: #1e40af; font-size: 22px; font-weight: 700; text-transform: uppercase; margin-bottom: 8px; }
                        .print-title .doc-number { font-size: 15px; color: #475569; }
                        .print-section { margin-bottom: 20px; }
                        .print-section-title { font-size: 13px; font-weight: 700; color: #1e40af; text-transform: uppercase; padding-bottom: 8px; border-bottom: 1px solid #e2e8f0; margin-bottom: 12px; }
                        .print-row { display: flex; padding: 6px 0; border-bottom: 1px dotted #e5e7eb; }
                        .print-row:last-child { border-bottom: none; }
                        .print-label { width: 140px; font-weight: 500; color: #64748b; flex-shrink: 0; }
                        .print-value { flex: 1; color: #1a1a1a; }
                        .print-value.highlight { font-weight: 700; color: #1e40af; }
                        .print-amount-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dotted #e5e7eb; }
                        .print-amount-row:last-child { border-bottom: none; }
                        .print-amount-label { color: #64748b; }
                        .print-amount-value { font-weight: 500; min-width: 150px; text-align: right; }
                        .print-amount-value.negative { color: #dc2626; }
                        .print-total { background: #eff6ff; border: 2px solid #1e40af; border-radius: 8px; padding: 15px 20px; margin: 15px 0; }
                        .print-total-row { display: flex; justify-content: space-between; align-items: center; }
                        .print-total-label { font-size: 15px; font-weight: 700; color: #1e40af; }
                        .print-total-value { font-size: 18px; font-weight: 700; color: #1e40af; }
                        .print-total-words { font-size: 13px; color: #64748b; font-style: italic; margin-top: 5px; text-align: right; }
                        .print-debt-row { background: #fef2f2; border: 1px solid #fecaca; border-radius: 6px; padding: 10px 15px; margin-top: 10px; }
                        .print-debt-row.paid { background: #f0fdf4; border-color: #bbf7d0; }
                        .print-debt-row .print-total-label, .print-debt-row .print-total-value { color: #dc2626; font-size: 14px; }
                        .print-debt-row.paid .print-total-label, .print-debt-row.paid .print-total-value { color: #16a34a; }
                        .print-info-grid { display: flex; flex-wrap: wrap; gap: 20px; margin: 15px 0; }
                        .print-info-item { display: flex; gap: 10px; }
                        .print-checkbox { display: inline-flex; align-items: center; gap: 5px; font-size: 13px; }
                        .print-checkbox-box { width: 14px; height: 14px; border: 1.5px solid #64748b; border-radius: 3px; display: inline-flex; align-items: center; justify-content: center; font-size: 10px; }
                        .print-checkbox-box.checked { background: #1e40af; border-color: #1e40af; color: white; }
                        .print-bank-info { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px 15px; margin: 15px 0; font-size: 13px; }
                        .print-bank-info-title { font-weight: 600; color: #475569; margin-bottom: 5px; }
                        .print-notes { background: #fffbeb; border: 1px solid #fde68a; border-radius: 6px; padding: 10px 15px; margin: 15px 0; font-size: 13px; }
                        .print-notes-label { font-weight: 600; color: #92400e; }
                        .print-notes-content { color: #78350f; }
                        .print-footer { margin-top: 40px; padding-top: 20px; }
                        .print-signatures { display: flex; justify-content: space-between; text-align: center; }
                        .print-signature-block { width: 45%; }
                        .print-signature-title { font-weight: 600; color: #475569; margin-bottom: 60px; }
                        .print-signature-line { border-top: 1px solid #1a1a1a; padding-top: 5px; font-size: 12px; color: #64748b; }
                        
                        @media print {
                            @page {
                                size: A4;
                                margin: 0;
                            }
                            
                            html, body { 
                                background: white !important; 
                                padding: 0 !important;
                                margin: 0 !important;
                                display: block !important;
                                width: 210mm !important;
                                height: 297mm !important;
                            }
                            
                            body {
                                display: flex !important;
                                justify-content: center !important;
                                align-items: flex-start !important;
                                padding-top: 0 !important;
                            }
                            
                            .print-document { 
                                box-shadow: none !important; 
                                margin: 0 auto !important;
                                width: 100% !important;
                                max-width: 210mm !important;
                                min-height: auto !important;
                                padding: 10mm 15mm !important;
                            }
                        }
                    </style>
                </head>
                <body>
                    ${content}
                    <script>
                        window.onload = function() {
                            setTimeout(function() { window.print(); }, 300);
                        }
                    <\/script>
                </body>
                </html>
            `);

            printWindow.document.close();
        }


        // ===== 32.11 Táº£i PDF Phiáº¿u ÄÄƒng KÃ½ =====
        function downloadRegistrationPDF() {
            const modal = document.getElementById('viewRegistrationModal');
            const printDoc = modal.querySelector('.print-document');
            if (!printDoc) {
                showNotification('KhÃ´ng tÃ¬m tháº¥y ná»™i dung!', 'error');
                return;
            }

            // TÃ¬m mÃ£ phiáº¿u
            const regCodeMatch = printDoc.innerHTML.match(/DK\d{6}-[A-Z0-9]+/);
            const filename = regCodeMatch ? `PhieuDK_${regCodeMatch[0]}.pdf` : 'PhieuDangKy.pdf';

            downloadPDF(printDoc, filename);
        }

        // ===== 32.12 Táº£i PDF BiÃªn Lai =====
        function downloadReceiptPDF() {
            if (!currentViewReceiptId) return;

            const options = {
                showDebtInfo: document.getElementById('optShowDebtInfo')?.checked || false,
                showBankInfo: document.getElementById('optShowBankInfo')?.checked || false,
                showSessions: document.getElementById('optShowSessions')?.checked || false
            };

            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = generateReceiptHTML(currentViewReceiptId, options);
            tempDiv.style.position = 'absolute';
            tempDiv.style.left = '-9999px';
            document.body.appendChild(tempDiv);

            const receipt = receipts.find(r => r.id === currentViewReceiptId);
            const filename = receipt?.receiptCode ? `BienLai_${receipt.receiptCode}.pdf` : 'BienLai.pdf';

            downloadPDF(tempDiv.querySelector('.print-document'), filename, () => {
                document.body.removeChild(tempDiv);
            });
        }

        // ===== 32.13 Download PDF Helper =====
        function downloadPDF(element, filename, callback) {
            if (typeof html2pdf === 'undefined') {
                showNotification('ThÆ° viá»‡n html2pdf chÆ°a Ä‘Æ°á»£c táº£i!', 'error');
                if (callback) callback();
                return;
            }

            showNotification('Äang táº¡o PDF...', 'info');

            const opt = {
                margin: [10, 10, 10, 10],
                filename: filename,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true, logging: false },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(element).save().then(() => {
                showNotification('ÄÃ£ táº£i PDF thÃ nh cÃ´ng!', 'success');
                if (callback) callback();
            }).catch(err => {
                console.error('PDF Error:', err);
                showNotification('CÃ³ lá»—i khi táº¡o PDF!', 'error');
                if (callback) callback();
            });
        }

        console.log('ğŸ“„ Module In Phiáº¿u ÄK & BiÃªn Lai V2 Ä‘Ã£ Ä‘Æ°á»£c táº£i!');


        /* ============================================================
           ğŸ« PHáº¦N 34: QUáº¢N LÃ PHÃ’NG Há»ŒC
           ============================================================ */

        // ===== 34.1 Render báº£ng phÃ²ng há»c =====
        function renderRoomsTable() {
            updateRoomStats();
            loadRoomScheduleToday();

            const tbody = document.getElementById('roomsTableBody');

            if (rooms.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6"><div class="empty-state"><div class="empty-state-icon">ğŸ«</div><p>ChÆ°a cÃ³ phÃ²ng há»c nÃ o</p></div></td></tr>`;
                return;
            }

            tbody.innerHTML = rooms.map(room => `
                <tr>
                    <td><strong>${room.name}</strong></td>
                    <td>${room.capacity} ngÆ°á»i</td>
                    <td>${room.equipment || '<span class="text-muted">-</span>'}</td>
                    <td>${getRoomStatusBadge(room.status)}</td>
                    <td>${room.notes || '<span class="text-muted">-</span>'}</td>
                    <td>
                        <div class="action-buttons">
                            ${canEdit('rooms') ? `<button class="action-btn edit" onclick="editRoom('${room.id}')" title="Sá»­a">âœï¸</button>` : ''}
                            ${canDelete('rooms') ? `<button class="action-btn delete" onclick="deleteRoom('${room.id}')" title="XÃ³a">ğŸ—‘ï¸</button>` : ''}
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function getRoomStatusBadge(status) {
            const badges = {
                'active': '<span class="status-badge da-dk">ğŸŸ¢ Hoáº¡t Ä‘á»™ng</span>',
                'maintenance': '<span class="status-badge cho-dk">ğŸŸ  Báº£o trÃ¬</span>',
                'inactive': '<span class="status-badge cancel">âš« NgÆ°ng</span>'
            };
            return badges[status] || status;
        }

        // ===== 34.2 Thá»‘ng kÃª phÃ²ng há»c =====
        function updateRoomStats() {
            const total = rooms.length;
            const active = rooms.filter(r => r.status === 'active').length;
            const maintenance = rooms.filter(r => r.status === 'maintenance').length;
            const totalCapacity = rooms.filter(r => r.status === 'active').reduce((sum, r) => sum + (r.capacity || 0), 0);

            document.getElementById('roomTotalCount').textContent = total;
            document.getElementById('roomActiveCount').textContent = active;
            document.getElementById('roomMaintenanceCount').textContent = maintenance;
            document.getElementById('roomTotalCapacity').textContent = totalCapacity;
        }

        // ===== 34.3 Lá»‹ch sá»­ dá»¥ng phÃ²ng hÃ´m nay =====
        function loadRoomScheduleToday() {
            const today = new Date();
            const dayOfWeek = today.getDay() === 0 ? 7 : today.getDay();
            const container = document.getElementById('roomScheduleToday');

            // Láº¥y cÃ¡c ca há»c hÃ´m nay
            const todaySchedules = classSchedules.filter(s => s.dayOfWeek === dayOfWeek && s.isActive);

            if (todaySchedules.length === 0) {
                container.innerHTML = '<p class="text-muted">KhÃ´ng cÃ³ lá»‹ch há»c hÃ´m nay</p>';
                return;
            }

            // NhÃ³m theo phÃ²ng
            const byRoom = {};
            todaySchedules.forEach(s => {
                const roomName = s.roomId ? (rooms.find(r => r.id === s.roomId)?.name || s.room || 'ChÆ°a gÃ¡n') : (s.room || 'ChÆ°a gÃ¡n');
                if (!byRoom[roomName]) byRoom[roomName] = [];

                const cls = classes.find(c => c.id === s.classId);
                byRoom[roomName].push({
                    time: `${s.startTime} - ${s.endTime}`,
                    className: cls ? cls.className : 'N/A'
                });
            });

            // Sáº¯p xáº¿p theo giá»
            Object.keys(byRoom).forEach(room => {
                byRoom[room].sort((a, b) => a.time.localeCompare(b.time));
            });

            container.innerHTML = `
                <div class="table-container" style="box-shadow: none; border: none;">
                    <table>
                        <thead>
                            <tr>
                                <th>PhÃ²ng</th>
                                <th>Giá» há»c</th>
                                <th>Lá»›p</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.entries(byRoom).map(([roomName, schedules]) =>
                schedules.map((s, idx) => `
                                    <tr>
                                        ${idx === 0 ? `<td rowspan="${schedules.length}"><strong>${roomName}</strong></td>` : ''}
                                        <td>${s.time}</td>
                                        <td>${s.className}</td>
                                    </tr>
                                `).join('')
            ).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function refreshRoomScheduleToday() {
            loadRoomScheduleToday();
            showNotification('ÄÃ£ lÃ m má»›i lá»‹ch sá»­ dá»¥ng phÃ²ng!', 'success');
        }

        // ===== 34.4 Modal ThÃªm/Sá»­a phÃ²ng =====
        function openRoomModal() {
            document.getElementById('editRoomId').value = '';
            document.getElementById('roomForm').reset();
            document.getElementById('roomStatus').value = 'active';
            document.getElementById('roomModalTitle').textContent = 'ğŸ« ThÃªm PhÃ²ng Há»c';
            openModal('roomModal');
        }

        function editRoom(id) {
            const room = rooms.find(r => r.id === id);
            if (!room) return;

            document.getElementById('editRoomId').value = room.id;
            document.getElementById('roomName').value = room.name;
            document.getElementById('roomCapacity').value = room.capacity;
            document.getElementById('roomEquipment').value = room.equipment || '';
            document.getElementById('roomStatus').value = room.status;
            document.getElementById('roomNotes').value = room.notes || '';
            document.getElementById('roomModalTitle').textContent = 'âœï¸ Sá»­a PhÃ²ng Há»c';
            openModal('roomModal');
        }

        function saveRoom(event) {
            event.preventDefault();

            const editId = document.getElementById('editRoomId').value;
            const roomData = {
                name: document.getElementById('roomName').value.trim(),
                capacity: parseInt(document.getElementById('roomCapacity').value),
                equipment: document.getElementById('roomEquipment').value.trim(),
                status: document.getElementById('roomStatus').value,
                notes: document.getElementById('roomNotes').value.trim()
            };

            // Kiá»ƒm tra trÃ¹ng tÃªn
            const existingRoom = rooms.find(r => r.name.toLowerCase() === roomData.name.toLowerCase() && r.id !== editId);
            if (existingRoom) {
                showNotification('TÃªn phÃ²ng Ä‘Ã£ tá»“n táº¡i!', 'error');
                return;
            }

            if (editId) {
                // Cáº­p nháº­t
                const index = rooms.findIndex(r => r.id === editId);
                if (index !== -1) {
                    rooms[index] = { ...rooms[index], ...roomData, updatedAt: new Date().toISOString() };
                    showNotification('Cáº­p nháº­t phÃ²ng há»c thÃ nh cÃ´ng!', 'success');
                }
            } else {
                // ThÃªm má»›i
                rooms.push({
                    id: generateId(),
                    ...roomData,
                    createdAt: new Date().toISOString()
                });
                showNotification('ThÃªm phÃ²ng há»c thÃ nh cÃ´ng!', 'success');
            }

            saveData('rooms', rooms);
            closeModal('roomModal');
            renderRoomsTable();
        }

        function deleteRoom(id) {
            const room = rooms.find(r => r.id === id);
            if (!room) return;

            // Kiá»ƒm tra phÃ²ng cÃ³ Ä‘ang Ä‘Æ°á»£c sá»­ dá»¥ng khÃ´ng
            const usingSchedules = classSchedules.filter(s => s.roomId === id || s.room === room.name);
            if (usingSchedules.length > 0) {
                showNotification(`KhÃ´ng thá»ƒ xÃ³a! PhÃ²ng Ä‘ang Ä‘Æ°á»£c sá»­ dá»¥ng trong ${usingSchedules.length} ca há»c.`, 'error');
                return;
            }

            if (!confirm(`XÃ³a phÃ²ng "${room.name}"?`)) return;

            rooms = rooms.filter(r => r.id !== id);
            saveData('rooms', rooms);
            showNotification('ÄÃ£ xÃ³a phÃ²ng há»c!', 'success');
            renderRoomsTable();
        }

        // ===== 34.5 Láº¥y danh sÃ¡ch phÃ²ng cho dropdown =====
        function getActiveRooms() {
            return rooms.filter(r => r.status === 'active');
        }

        // ===== 34.6 Kiá»ƒm tra trÃ¹ng lá»‹ch phÃ²ng =====
        function checkRoomConflict(roomId, dayOfWeek, startTime, endTime, excludeScheduleId = null) {
            if (!roomId) return null;

            const conflictSchedule = classSchedules.find(s => {
                if (s.id === excludeScheduleId) return false;
                if (s.roomId !== roomId) return false;
                if (s.dayOfWeek !== dayOfWeek) return false;
                if (!s.isActive) return false;

                // Kiá»ƒm tra trÃ¹ng giá»
                const sStart = s.startTime;
                const sEnd = s.endTime;

                // TrÃ¹ng náº¿u: (start1 < end2) && (end1 > start2)
                if (startTime < sEnd && endTime > sStart) {
                    return true;
                }
                return false;
            });

            if (conflictSchedule) {
                const cls = classes.find(c => c.id === conflictSchedule.classId);
                return {
                    schedule: conflictSchedule,
                    className: cls ? cls.className : 'N/A'
                };
            }

            return null;
        }

        console.log('ğŸ« Module Quáº£n lÃ½ PhÃ²ng há»c Ä‘Ã£ Ä‘Æ°á»£c táº£i!');


        /* ============================================================
        ğŸ“‹ PHáº¦N 33: Sá»¬A PHIáº¾U ÄÄ‚NG KÃ & BIÃŠN LAI + PHÃ‚N TRANG ÄÃ€O Táº O
        ============================================================ */

        // ===== Cáº­p nháº­t paginationState - ThÃªm cÃ¡c tab má»›i =====
        paginationState.teachers = { page: 1, pageSize: 10 };
        paginationState.classes = { page: 1, pageSize: 10 };
        paginationState.makeup = { page: 1, pageSize: 10 };
        paginationState.attendanceHistory = { page: 1, pageSize: 10 };


        // ===== Sá»¬A PHIáº¾U ÄÄ‚NG KÃ - Cáº¬P NHáº¬T =====
        function editRegistration(id) {
            const reg = registrations.find(r => r.id === id);
            if (!reg) return;

            const student = students.find(s => s.id === reg.studentId);

            // Äiá»n ID Ä‘ang sá»­a
            document.getElementById('editRegId').value = id;
            document.getElementById('regStudentId').value = reg.studentId;

            // Populate dropdown há»c viÃªn
            const allStudents = students.filter(s =>
                s.status === 'Chá» ÄÄƒng KÃ½' ||
                s.status === 'ÄÃ£ ÄÄƒng KÃ½' ||
                s.id === reg.studentId
            );
            document.getElementById('regStudentSelect').innerHTML = '<option value="">-- Chá»n há»c viÃªn --</option>' +
                allStudents.map(s => `<option value="${s.id}" ${s.id === reg.studentId ? 'selected' : ''}>${s.name} - ${s.parentPhone}</option>`).join('');

            // Populate dropdown mÃ´n há»c
            if (student) {
                document.getElementById('regSubject').innerHTML = '<option value="">-- Chá»n mÃ´n --</option>' +
                    student.subjects.map(s => `<option value="${s}" ${s === reg.subject ? 'selected' : ''}>${s}</option>`).join('');
            }

            // Populate vÃ  chá»n gÃ³i há»c phÃ­
            const subjectPackages = packages.filter(p => p.subjectName === reg.subject);
            document.getElementById('regPackage').innerHTML = '<option value="">-- Chá»n gÃ³i --</option>' +
                subjectPackages.map(p => `<option value="${p.id}" ${p.id === reg.packageId ? 'selected' : ''}>${p.name} - ${p.sessions} buá»•i - ${formatCurrency(p.fee)}</option>`).join('');

            // Äiá»n sá»‘ buá»•i
            document.getElementById('regTotalSessions').value = reg.totalSessions || '';

            // Äiá»n ngÃ y báº¯t Ä‘áº§u
            document.getElementById('regStartDate').value = reg.startDate || '';

            // Äiá»n há»c phÃ­
            document.getElementById('regTuitionFee').value = formatNumberInput(reg.tuitionFee);

            // Äiá»n ngÃ y Ä‘Äƒng kÃ½
            document.getElementById('regDate').value = reg.registrationDate || '';

            // Äiá»n ghi chÃº
            document.getElementById('regNotes').value = reg.notes || '';

            // Render khuyáº¿n mÃ£i vÃ  tick cÃ¡c khuyáº¿n mÃ£i Ä‘Ã£ chá»n
            renderPromotionCheckboxes();
            setTimeout(() => {
                if (reg.promotionIds && reg.promotionIds.length > 0) {
                    reg.promotionIds.forEach(promoId => {
                        const cb = document.querySelector(`input[name="regPromotions"][value="${promoId}"]`);
                        if (cb) cb.checked = true;
                    });
                }
                calculateFinalAmount();
            }, 100);

            // Äá»•i tiÃªu Ä‘á» modal
            const modalTitle = document.querySelector('#registrationModal .modal-header h2');
            if (modalTitle) modalTitle.textContent = 'âœï¸ Sá»­a Phiáº¿u ÄÄƒng KÃ½';

            openModal('registrationModal');
        }


        // ===== Sá»¬A BIÃŠN LAI =====
        function editReceipt(id) {
            const receipt = receipts.find(r => r.id === id);
            if (!receipt) return;

            const student = students.find(s => s.id === receipt.studentId);

            // Äiá»n ID Ä‘ang sá»­a
            document.getElementById('editReceiptId').value = receipt.id;

            // Äiá»n loáº¡i
            document.getElementById('receiptType').value = receipt.type;

            // Populate dropdown há»c viÃªn (bao gá»“m cáº£ HV Ä‘Ã£ Ä‘Äƒng kÃ½)
            const eligibleStudents = students.filter(s => s.status === 'ÄÃ£ ÄÄƒng KÃ½' || s.id === receipt.studentId);
            document.getElementById('receiptStudentId').innerHTML = '<option value="">-- Chá»n há»c viÃªn --</option>' +
                eligibleStudents.map(s => `<option value="${s.id}" ${s.id === receipt.studentId ? 'selected' : ''}>${s.name} - ${s.parentPhone}</option>`).join('');

            // Äiá»n thÃ´ng tin phá»¥ huynh
            document.getElementById('receiptParentName').value = receipt.parentName || student?.parentName || '';
            document.getElementById('receiptParentPhone').value = receipt.parentPhone || student?.parentPhone || '';

            // Populate dropdown phiáº¿u ÄK
            if (receipt.studentId) {
                const studentRegs = registrations.filter(r => r.studentId === receipt.studentId);
                document.getElementById('receiptRegistrationSelect').innerHTML = '<option value="">-- Chá»n phiáº¿u ÄK --</option>' +
                    studentRegs.map(r => `<option value="${r.id}" ${r.id === receipt.registrationId ? 'selected' : ''}>${r.regCode} - ${formatCurrency(r.finalAmount)}</option>`).join('');
            }

            // Äiá»n cÃ¡c trÆ°á»ng khÃ¡c
            document.getElementById('receiptDescription').value = receipt.description;
            document.getElementById('receiptAmount').value = formatNumberInput(receipt.amount);
            document.getElementById('receiptDate').value = receipt.date;
            document.getElementById('receiptNotes').value = receipt.notes || '';

            // Äá»•i tiÃªu Ä‘á» modal
            const modalTitle = document.querySelector('#receiptModal .modal-header h2');
            if (modalTitle) modalTitle.textContent = 'âœï¸ Sá»­a BiÃªn Lai';

            openModal('receiptModal');
        }

        // ===== Cáº¬P NHáº¬T HÃ€M SAVE REGISTRATION (há»— trá»£ Sá»­a) =====
        const originalSaveRegistration = saveRegistration;
        saveRegistration = function (event) {
            event.preventDefault();

            const editId = document.getElementById('editRegId')?.value;
            const studentId = document.getElementById('regStudentId').value;

            if (!studentId) {
                showNotification('Vui lÃ²ng chá»n há»c viÃªn!', 'error');
                return;
            }

            const student = students.find(s => s.id === studentId);
            const tuition = parseCurrencyInput(document.getElementById('regTuitionFee').value);
            const selectedPromoIds = Array.from(document.querySelectorAll('input[name="regPromotions"]:checked')).map(cb => cb.value);

            let discount = 0;
            selectedPromoIds.forEach(promoId => {
                const promo = promotions.find(p => p.id === promoId);
                if (promo) discount += promo.type === 'percent' ? tuition * promo.value / 100 : promo.value;
            });

            const finalAmount = Math.max(tuition - discount, 0);

            const regData = {
                studentId,
                studentName: student ? student.name : '',
                parentName: student ? student.parentName : '',
                parentPhone: student ? student.parentPhone : '',
                subject: document.getElementById('regSubject').value,
                packageId: document.getElementById('regPackage').value || null,
                tuitionFee: tuition,
                promotionIds: selectedPromoIds,
                discountAmount: discount,
                finalAmount
            };

            if (editId) {
                // Cáº¬P NHáº¬T
                const index = registrations.findIndex(r => r.id === editId);
                if (index !== -1) {
                    registrations[index] = {
                        ...registrations[index],
                        ...regData,
                        updatedAt: new Date().toISOString()
                    };
                    showNotification('Cáº­p nháº­t phiáº¿u ÄK thÃ nh cÃ´ng!', 'success');
                }
                // XÃ³a editId
                document.getElementById('editRegId').value = '';
            } else {
                // THÃŠM Má»šI
                const regCode = generateRegCode();
                registrations.push({
                    id: generateId(),
                    regCode,
                    ...regData,
                    registrationDate: new Date().toISOString().split('T')[0],
                    createdAt: new Date().toISOString()
                });

                // Cáº­p nháº­t tráº¡ng thÃ¡i há»c viÃªn
                if (student && student.status === 'Chá» ÄÄƒng KÃ½') {
                    student.status = 'ÄÃ£ ÄÄƒng KÃ½';
                    saveData('students', students);
                }

                showNotification(`Táº¡o phiáº¿u ÄK thÃ nh cÃ´ng! MÃ£: ${regCode}`, 'success');
            }

            saveData('registrations', registrations);
            closeModal('registrationModal');

            // Reset tiÃªu Ä‘á»
            const modalTitle = document.querySelector('#registrationModal .modal-header h2');
            if (modalTitle) modalTitle.textContent = 'ğŸ“‹ Táº¡o Phiáº¿u ÄÄƒng KÃ½';

            renderAll();
        };

        // ===== Cáº¬P NHáº¬T HÃ€M RENDER Báº¢NG PHIáº¾U ÄK (thÃªm nÃºt Sá»­a) =====
        renderRegistrationsTable = function () {
            const filtered = getFilteredRegistrations();
            const { data, total, totalPages, currentPage } = getPaginatedData(filtered, 'registrations');
            const tbody = document.getElementById('registrationsTableBody');

            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7"><div class="empty-state"><div class="empty-state-icon">ğŸ“‹</div><p>KhÃ´ng cÃ³ phiáº¿u ÄK</p></div></td></tr>`;
                renderPagination('registrationsPagination', 'registrations', 0, 0, 1);
                return;
            }

            tbody.innerHTML = data.map(r => `
                <tr>
                    <td><strong class="text-primary">${r.regCode}</strong></td>
                    <td>${r.studentName || 'N/A'}</td>
                    <td><span class="subject-tag">${r.subject}</span><br><small class="text-muted">${formatCurrency(r.tuitionFee)}</small></td>
                    <td class="text-danger">${r.discountAmount > 0 ? '-' + formatCurrency(r.discountAmount) : '-'}</td>
                    <td><strong class="text-success">${formatCurrency(r.finalAmount)}</strong></td>
                    <td>${formatDate(r.registrationDate)}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn view" onclick="viewRegistration('${r.id}')" title="Xem">ğŸ‘ï¸</button>
                            ${canEdit('registrations') ? `<button class="action-btn edit" onclick="editRegistration('${r.id}')" title="Sá»­a">âœï¸</button>` : ''}
                            ${canDelete('registrations') ? `<button class="action-btn delete" onclick="deleteRegistration('${r.id}')" title="XÃ³a">ğŸ—‘ï¸</button>` : ''}
                        </div>
                    </td>
                </tr>
            `).join('');

            renderPagination('registrationsPagination', 'registrations', total, totalPages, currentPage);
        };

        // ===== Cáº¬P NHáº¬T HÃ€M RENDER Báº¢NG BIÃŠN LAI (thÃªm nÃºt Sá»­a) =====
        renderReceiptsTable = function () {
            const filtered = getFilteredReceipts();
            const { data, total, totalPages, currentPage } = getPaginatedData(filtered, 'receipts');
            const tbody = document.getElementById('receiptsTableBody');

            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7"><div class="empty-state"><div class="empty-state-icon">ğŸ§¾</div><p>KhÃ´ng cÃ³ biÃªn lai</p></div></td></tr>`;
                renderPagination('receiptsPagination', 'receipts', 0, 0, 1);
                return;
            }

            tbody.innerHTML = data.map((r, idx) => {
                const student = students.find(s => s.id === r.studentId);
                const displayCode = r.receiptCode || `#${String(total - (currentPage - 1) * paginationState.receipts.pageSize - idx).padStart(4, '0')}`;

                return `
                    <tr>
                        <td><strong>${displayCode}</strong></td>
                        <td><span class="subject-tag">${r.type}</span></td>
                        <td>${student?.name || 'N/A'}</td>
                        <td>${r.description}</td>
                        <td><strong class="text-success">${formatCurrency(r.amount)}</strong></td>
                        <td>${formatDate(r.date)}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="action-btn view" onclick="viewReceipt('${r.id}')" title="Xem">ğŸ‘ï¸</button>
                                ${canEdit('receipts') ? `<button class="action-btn edit" onclick="editReceipt('${r.id}')" title="Sá»­a">âœï¸</button>` : ''}
                                ${canDelete('receipts') ? `<button class="action-btn delete" onclick="deleteReceipt('${r.id}')" title="XÃ³a">ğŸ—‘ï¸</button>` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            renderPagination('receiptsPagination', 'receipts', total, totalPages, currentPage);
        };

        // ===== Cáº¬P NHáº¬T HÃ€M RENDER Báº¢NG GIÃO VIÃŠN (cÃ³ phÃ¢n trang) =====
        renderTeachersTable = function () {
            const searchTerm = document.getElementById('searchTeacher')?.value?.toLowerCase() || '';

            let filtered = teachers.filter(t =>
                t.fullName.toLowerCase().includes(searchTerm) ||
                t.phone.includes(searchTerm)
            );

            const { data, total, totalPages, currentPage } = getPaginatedData(filtered, 'teachers');
            const tbody = document.getElementById('teachersTableBody');

            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6"><div class="empty-state"><div class="empty-state-icon">ğŸ‘¨â€ğŸ«</div><p>ChÆ°a cÃ³ giÃ¡o viÃªn nÃ o</p></div></td></tr>`;
                renderPagination('teachersPagination', 'teachers', 0, 0, 1);
                return;
            }

            tbody.innerHTML = data.map(t => `
                <tr>
                    <td><strong>${t.fullName}</strong></td>
                    <td>${t.phone}</td>
                    <td>${t.subjects.map(s => `<span class="subject-tag">${getSubjectIcon(s)} ${s}</span>`).join(' ')}</td>
                    <td>${getSalaryTypeLabel(t.salaryType)}</td>
                    <td><span class="status-badge ${t.status === 'active' ? 'active' : 'locked'}">${t.status === 'active' ? 'ğŸŸ¢ Äang dáº¡y' : 'âš« Nghá»‰'}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn view" onclick="viewTeacher('${t.id}')" title="Xem">ğŸ‘ï¸</button>
                            ${canEdit('teachers') ? `<button class="action-btn edit" onclick="editTeacher('${t.id}')" title="Sá»­a">âœï¸</button>` : ''}
                            ${canDelete('teachers') ? `<button class="action-btn delete" onclick="deleteTeacher('${t.id}')" title="XÃ³a">ğŸ—‘ï¸</button>` : ''}
                        </div>
                    </td>
                </tr>
            `).join('');

            renderPagination('teachersPagination', 'teachers', total, totalPages, currentPage);
        };

        // ===== Cáº¬P NHáº¬T HÃ€M SEARCH GIÃO VIÃŠN =====
        searchTeachers = function () {
            paginationState.teachers.page = 1;
            renderTeachersTable();
        };

        // ===== Cáº¬P NHáº¬T HÃ€M RENDER Báº¢NG Lá»šP Há»ŒC (cÃ³ phÃ¢n trang) =====
        renderClassesTable = function () {
            const searchTerm = document.getElementById('searchClass')?.value?.toLowerCase() || '';
            const filterSubject = document.getElementById('filterClassSubject')?.value || '';
            const filterTeacher = document.getElementById('filterClassTeacher')?.value || '';
            const filterStatus = document.getElementById('filterClassStatus')?.value || '';

            let filtered = classes.filter(c => {
                if (searchTerm && !c.className.toLowerCase().includes(searchTerm)) return false;
                if (filterSubject && c.subjectId !== filterSubject) return false;
                if (filterTeacher && c.teacherId !== filterTeacher) return false;
                if (filterStatus && c.status !== filterStatus) return false;
                return true;
            });

            const { data, total, totalPages, currentPage } = getPaginatedData(filtered, 'classes');
            const tbody = document.getElementById('classesTableBody');

            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8"><div class="empty-state"><div class="empty-state-icon">ğŸ“š</div><p>ChÆ°a cÃ³ lá»›p há»c nÃ o</p></div></td></tr>`;
                renderPagination('classesPagination', 'classes', 0, 0, 1);
                return;
            }

            tbody.innerHTML = data.map(c => {
                const subject = subjects.find(s => s.id === c.subjectId);
                const teacher = teachers.find(t => t.id === c.teacherId);
                const clsSchedules = classSchedules.filter(s => s.classId === c.id && s.isActive);
                const studentCount = classStudents.filter(cs => cs.classId === c.id && cs.status === 'active').length;

                return `
                    <tr>
                        <td><strong>${c.className}</strong></td>
                        <td>${subject ? `${subject.icon} ${subject.name}` : '-'}</td>
                        <td>${teacher ? teacher.fullName : '<span class="text-muted">ChÆ°a cÃ³</span>'}</td>
                        <td>${c.classType === 'group' ? 'ğŸ‘¥ NhÃ³m' : 'ğŸ‘¤ 1-1'}</td>
                        <td><strong>${studentCount}</strong>/${c.maxStudents}</td>
                        <td>${formatSchedules(clsSchedules)}</td>
                        <td>${getClassStatusBadge(c.status)}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="action-btn view" onclick="viewClass('${c.id}')" title="Xem">ğŸ‘ï¸</button>
                                ${canEdit('classes') ? `<button class="action-btn edit" onclick="editClass('${c.id}')" title="Sá»­a">âœï¸</button>` : ''}
                                ${canDelete('classes') ? `<button class="action-btn delete" onclick="deleteClass('${c.id}')" title="XÃ³a">ğŸ—‘ï¸</button>` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            renderPagination('classesPagination', 'classes', total, totalPages, currentPage);
        };

        // ===== Cáº¬P NHáº¬T HÃ€M SEARCH/FILTER Lá»šP Há»ŒC =====
        searchClasses = function () {
            paginationState.classes.page = 1;
            renderClassesTable();
        };

        filterClasses = function () {
            paginationState.classes.page = 1;
            renderClassesTable();
        };

        // ===== Cáº¬P NHáº¬T HÃ€M RENDER Báº¢NG Há»ŒC BÃ™ (cÃ³ phÃ¢n trang) =====
        renderMakeupRequests = function () {
            updateMakeupStats();

            const today = new Date().toISOString().split('T')[0];

            let filtered = [...makeupRequests];

            // Ãp dá»¥ng filter
            if (currentMakeupFilter === 'pending') {
                filtered = filtered.filter(m => m.status === 'pending');
            } else if (currentMakeupFilter === 'approved') {
                filtered = filtered.filter(m => m.status === 'approved');
            } else if (currentMakeupFilter === 'expiring') {
                const in7Days = new Date();
                in7Days.setDate(in7Days.getDate() + 7);
                filtered = filtered.filter(m =>
                    (m.status === 'pending' || m.status === 'approved') &&
                    new Date(m.expiryDate) <= in7Days
                );
            } else if (currentMakeupFilter === 'completed') {
                filtered = filtered.filter(m => m.status === 'completed');
            } else if (currentMakeupFilter === 'expired') {
                filtered = filtered.filter(m => m.status === 'expired');
            }

            // Sáº¯p xáº¿p theo háº¡n gáº§n nháº¥t
            filtered.sort((a, b) => new Date(a.expiryDate) - new Date(b.expiryDate));

            const { data, total, totalPages, currentPage } = getPaginatedData(filtered, 'makeup');
            const tbody = document.getElementById('makeupRequestsBody');

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">KhÃ´ng cÃ³ yÃªu cáº§u há»c bÃ¹</td></tr>';
                renderPagination('makeupPagination', 'makeup', 0, 0, 1);
                return;
            }

            tbody.innerHTML = data.map(m => {
                const student = students.find(s => s.id === m.studentId);
                const originalClass = classes.find(c => c.id === m.originalClassId);
                const makeupClass = m.makeupClassId ? classes.find(c => c.id === m.makeupClassId) : null;

                const daysLeft = Math.ceil((new Date(m.expiryDate) - new Date(today)) / (1000 * 60 * 60 * 24));
                const expiryClass = daysLeft <= 3 ? 'text-danger fw-700' : daysLeft <= 7 ? 'text-warning fw-600' : '';

                return `
                    <tr>
                        <td><strong>${student ? student.name : 'N/A'}</strong></td>
                        <td>${originalClass ? originalClass.className : 'N/A'}</td>
                        <td>${formatDate(m.originalDate)}</td>
                        <td><span class="${expiryClass}">${formatDate(m.expiryDate)} ${daysLeft > 0 ? `(${daysLeft} ngÃ y)` : ''}</span></td>
                        <td>${makeupClass ? makeupClass.className : '<span class="text-muted">ChÆ°a xáº¿p</span>'}</td>
                        <td>${m.makeupDate ? formatDate(m.makeupDate) : '-'}</td>
                        <td>${getMakeupStatusBadge(m.status)}</td>
                        <td>
                            <div class="action-buttons">
                                ${m.status === 'pending' ? `<button class="action-btn schedule" onclick="openScheduleMakeupModal('${m.id}')" title="Xáº¿p lá»‹ch">ğŸ“…</button>` : ''}
                                ${m.status === 'approved' ? `<button class="action-btn edit" onclick="openConfirmMakeupModal('${m.id}')" title="XÃ¡c nháº­n hoÃ n thÃ nh">âœ…</button>` : ''}
                                ${(m.status === 'pending' || m.status === 'approved') ? `<button class="action-btn delete" onclick="cancelMakeupRequest('${m.id}')" title="Há»§y">ğŸ—‘ï¸</button>` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            renderPagination('makeupPagination', 'makeup', total, totalPages, currentPage);
        };

        // ===== Cáº¬P NHáº¬T HÃ€M FILTER Há»ŒC BÃ™ =====
        filterMakeupRequests = function (filter) {
            currentMakeupFilter = filter;
            paginationState.makeup.page = 1;
            document.querySelectorAll('#makeup .filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
            });
            renderMakeupRequests();
        };

        // ===== Cáº¬P NHáº¬T HÃ€M LOAD Lá»ŠCH Sá»¬ ÄIá»‚M DANH (cÃ³ phÃ¢n trang) =====
        loadAttendanceHistory = function () {
            // NhÃ³m theo ngÃ y + lá»›p + ca
            const grouped = {};

            attendances.forEach(a => {
                const key = `${a.attendanceDate}_${a.classId}_${a.scheduleId}`;
                if (!grouped[key]) {
                    grouped[key] = {
                        date: a.attendanceDate,
                        classId: a.classId,
                        scheduleId: a.scheduleId,
                        records: []
                    };
                }
                grouped[key].records.push(a);
            });

            // Sáº¯p xáº¿p theo ngÃ y má»›i nháº¥t
            const sortedGroups = Object.values(grouped).sort((a, b) =>
                new Date(b.date) - new Date(a.date)
            );

            const { data, total, totalPages, currentPage } = getPaginatedData(sortedGroups, 'attendanceHistory');
            const tbody = document.getElementById('attendanceHistoryBody');

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">ChÆ°a cÃ³ dá»¯ liá»‡u Ä‘iá»ƒm danh</td></tr>';
                renderPagination('attendanceHistoryPagination', 'attendanceHistory', 0, 0, 1);
                return;
            }

            tbody.innerHTML = data.map(g => {
                const cls = classes.find(c => c.id === g.classId);
                const schedule = classSchedules.find(s => s.id === g.scheduleId);

                const totalStudents = g.records.length;
                const presentCount = g.records.filter(r => r.status === 'present' || r.status === 'late').length;
                const absentCount = g.records.filter(r => r.status === 'absent' || r.status === 'excused').length;

                return `
                    <tr>
                        <td><strong>${formatDate(g.date)}</strong></td>
                        <td>${cls ? cls.className : 'N/A'}</td>
                        <td>${schedule ? schedule.startTime + '-' + schedule.endTime : 'N/A'}</td>
                        <td>${totalStudents}</td>
                        <td><span class="text-success">${presentCount}</span></td>
                        <td><span class="text-danger">${absentCount}</span></td>
                        <td>
                            <button class="action-btn view" onclick="viewAttendanceDetail('${g.date}', '${g.classId}', '${g.scheduleId}')" title="Xem chi tiáº¿t">ğŸ‘ï¸</button>
                        </td>
                    </tr>
                `;
            }).join('');

            renderPagination('attendanceHistoryPagination', 'attendanceHistory', total, totalPages, currentPage);
        };

        // ===== RESET TIÃŠU Äá»€ KHI Má» MODAL Táº O Má»šI =====
        const originalOpenNewRegistrationModal = openNewRegistrationModal;
        openNewRegistrationModal = function () {
            // Reset editId náº¿u cÃ³
            if (document.getElementById('editRegId')) {
                document.getElementById('editRegId').value = '';
            }

            // Reset tiÃªu Ä‘á»
            const modalTitle = document.querySelector('#registrationModal .modal-header h2');
            if (modalTitle) modalTitle.textContent = 'ğŸ“‹ Táº¡o Phiáº¿u ÄÄƒng KÃ½';

            // Gá»i hÃ m gá»‘c
            document.getElementById('regStudentId').value = '';
            document.getElementById('registrationForm').reset();
            populateRegStudentDropdown();
            renderPromotionCheckboxes();
            openModal('registrationModal');
        };

        const originalOpenReceiptModal = openReceiptModal;
        openReceiptModal = function () {
            // Reset editId
            document.getElementById('editReceiptId').value = '';

            // Reset tiÃªu Ä‘á»
            const modalTitle = document.querySelector('#receiptModal .modal-header h2');
            if (modalTitle) modalTitle.textContent = 'ğŸ§¾ Táº¡o BiÃªn Lai';

            // Reset form
            document.getElementById('receiptForm').reset();
            document.getElementById('receiptDate').value = new Date().toISOString().split('T')[0];
            populateReceiptStudentDropdown();
            openModal('receiptModal');
        };

        console.log('ğŸ“‹ Module Sá»­a Phiáº¿u ÄK/BiÃªn Lai + PhÃ¢n trang ÄÃ o táº¡o Ä‘Ã£ Ä‘Æ°á»£c táº£i!');

        /* ============================================================
        ğŸ§¾ MODULE 2: BIÃŠN LAI - Cáº¬P NHáº¬T LOGIC
        ============================================================ */

        // ===== 2.1 Biáº¿n lÆ°u trá»¯ filter biÃªn lai =====
        let receiptFilterState = {
            fromDate: null,
            toDate: null,
            type: 'all',
            period: 'thisMonth'
        };

        // ===== 2.2 Xá»­ lÃ½ khi Ä‘á»•i loáº¡i biÃªn lai =====
        function onReceiptTypeChange() {
            const type = document.getElementById('receiptType').value;
            const descriptionInput = document.getElementById('receiptDescription');
            const registrationGroup = document.getElementById('receiptRegistrationSelect')?.parentElement;

            if (type === 'Phiáº¿u Chi') {
                // BiÃªn lai chi - Thay Ä‘á»•i placeholder vÃ  label
                descriptionInput.placeholder = 'Nháº­p lÃ½ do hoÃ n tiá»n (báº¯t buá»™c)';
                descriptionInput.setAttribute('required', 'required');

                // CÃ³ thá»ƒ áº©n dropdown phiáº¿u ÄK náº¿u muá»‘n (tÃ¹y chá»n)
                // if (registrationGroup) registrationGroup.style.display = 'none';
            } else {
                descriptionInput.placeholder = 'VD: Há»c phÃ­ thÃ¡ng 1';

                // if (registrationGroup) registrationGroup.style.display = 'block';
            }
        }

        // ===== 2.3 Populate dropdown Phiáº¿u ÄK - CHá»ˆ HIá»†N PHIáº¾U CHÆ¯A THU Äá»¦ =====
        function fillReceiptStudentInfo() {
            const studentId = document.getElementById('receiptStudentId').value;
            const student = students.find(s => s.id === studentId);

            document.getElementById('receiptParentName').value = student?.parentName || '';
            document.getElementById('receiptParentPhone').value = student?.parentPhone || '';

            if (studentId) {
                // Láº¥y cÃ¡c phiáº¿u ÄK cá»§a há»c viÃªn
                const studentRegs = registrations.filter(r => r.studentId === studentId);

                // Lá»c chá»‰ hiá»‡n phiáº¿u chÆ°a thu Ä‘á»§
                const unpaidRegs = studentRegs.filter(reg => {
                    const debt = calculateDebtForRegistration(reg.id);
                    // Chá»‰ hiá»‡n náº¿u cÃ²n ná»£ > 0
                    return debt.debtAmount > 0;
                });

                // Render dropdown vá»›i thÃ´ng tin chi tiáº¿t
                document.getElementById('receiptRegistrationSelect').innerHTML =
                    '<option value="">-- Chá»n phiáº¿u ÄK (chá»‰ hiá»‡n phiáº¿u chÆ°a thu Ä‘á»§) --</option>' +
                    unpaidRegs.map(r => {
                        const debt = calculateDebtForRegistration(r.id);
                        const statusText = debt.paidAmount > 0
                            ? `ÄÃ£ thu: ${formatCurrencyShort(debt.paidAmount)}, CÃ²n: ${formatCurrencyShort(debt.debtAmount)}`
                            : `ChÆ°a thu - Tá»•ng: ${formatCurrencyShort(debt.totalAmount)}`;
                        return `<option value="${r.id}">${r.regCode} - ${r.subject} | ${statusText}</option>`;
                    }).join('');

                // ThÃ´ng bÃ¡o náº¿u khÃ´ng cÃ³ phiáº¿u nÃ o cáº§n thu
                if (unpaidRegs.length === 0 && studentRegs.length > 0) {
                    document.getElementById('receiptRegistrationSelect').innerHTML =
                        '<option value="">âœ… Táº¥t cáº£ phiáº¿u ÄK Ä‘Ã£ thu Ä‘á»§ tiá»n</option>';
                }
            } else {
                document.getElementById('receiptRegistrationSelect').innerHTML =
                    '<option value="">-- Chá»n phiáº¿u ÄK --</option>';
            }
        }

        // ===== 2.4 Khi chá»n Phiáº¿u ÄK - Tá»± Ä‘á»™ng Ä‘iá»n sá»‘ tiá»n cÃ²n ná»£ =====
        function fillFromRegistration() {
            const regId = document.getElementById('receiptRegistrationSelect').value;
            const reg = registrations.find(r => r.id === regId);
            const receiptType = document.getElementById('receiptType').value;

            if (reg && receiptType !== 'Phiáº¿u Chi') {
                const debt = calculateDebtForRegistration(regId);

                // Tá»± Ä‘á»™ng Ä‘iá»n ná»™i dung
                document.getElementById('receiptDescription').value = `Thanh toÃ¡n há»c phÃ­ - ${reg.subject} - ${reg.regCode}`;

                // Tá»± Ä‘á»™ng Ä‘iá»n sá»‘ tiá»n CÃ’N Ná»¢ (khÃ´ng pháº£i tá»•ng tiá»n)
                document.getElementById('receiptAmount').value = formatNumberInput(debt.debtAmount);

                // LÆ°u registrationId áº©n
                document.getElementById('receiptRegistrationId').value = regId;
            }
        }

        // ===== 2.5 LÆ°u biÃªn lai - Cáº­p nháº­t xá»­ lÃ½ biÃªn lai chi =====
        function saveReceipt(event) {
            event.preventDefault();

            const studentId = document.getElementById('receiptStudentId').value;
            const student = students.find(s => s.id === studentId);
            const editId = document.getElementById('editReceiptId').value;
            const receiptType = document.getElementById('receiptType').value;
            const description = document.getElementById('receiptDescription').value.trim();
            const amount = parseCurrencyInput(document.getElementById('receiptAmount').value);

            // Validation
            if (!studentId) {
                showNotification('Vui lÃ²ng chá»n há»c viÃªn!', 'error');
                return;
            }

            if (!receiptType) {
                showNotification('Vui lÃ²ng chá»n loáº¡i biÃªn lai!', 'error');
                return;
            }

            if (amount <= 0) {
                showNotification('Sá»‘ tiá»n pháº£i lá»›n hÆ¡n 0!', 'error');
                return;
            }

            // Validation riÃªng cho Phiáº¿u Chi
            if (receiptType === 'Phiáº¿u Chi' && !description) {
                showNotification('Vui lÃ²ng nháº­p lÃ½ do hoÃ n tiá»n!', 'error');
                return;
            }

            const data = {
                studentId,
                type: receiptType,
                isRefund: receiptType === 'Phiáº¿u Chi', // Flag Ä‘á»ƒ phÃ¢n biá»‡t thu/chi
                parentName: student?.parentName || '',
                parentPhone: student?.parentPhone || '',
                registrationId: document.getElementById('receiptRegistrationSelect')?.value || null,
                description: description,
                amount: amount,
                date: document.getElementById('receiptDate').value,
                notes: document.getElementById('receiptNotes').value.trim()
            };

            if (editId) {
                // Cáº¬P NHáº¬T - Giá»¯ nguyÃªn receiptCode cÅ©
                const index = receipts.findIndex(r => r.id === editId);
                if (index !== -1) {
                    receipts[index] = {
                        ...receipts[index],
                        ...data,
                        receiptCode: receipts[index].receiptCode,
                        updatedAt: new Date().toISOString()
                    };
                    showNotification('Cáº­p nháº­t biÃªn lai thÃ nh cÃ´ng!', 'success');
                }
            } else {
                // THÃŠM Má»šI
                const prefix = receiptType === 'Phiáº¿u Chi' ? 'PC' : 'BL';
                const newReceipt = {
                    id: generateId(),
                    receiptCode: generateReceiptCodeWithPrefix(prefix),
                    ...data,
                    createdBy: currentUser?.id || null,
                    createdAt: new Date().toISOString()
                };
                receipts.push(newReceipt);

                const typeLabel = receiptType === 'Phiáº¿u Chi' ? 'Phiáº¿u chi' : 'BiÃªn lai';
                showNotification(`Táº¡o ${typeLabel} thÃ nh cÃ´ng!`, 'success');
            }

            saveData('receipts', receipts);
            closeModal('receiptModal');

            // Reset form title
            const modalTitle = document.querySelector('#receiptModal .modal-header h2');
            if (modalTitle) modalTitle.textContent = 'ğŸ§¾ Táº¡o BiÃªn Lai';

            renderReceiptsTable();

            // Cáº­p nháº­t cÃ´ng ná»£ náº¿u Ä‘ang á»Ÿ tab Ä‘Ã³
            if (document.getElementById('debts').classList.contains('active')) {
                renderDebtsTable();
            }
        }

        // ===== 2.6 Táº¡o mÃ£ biÃªn lai vá»›i prefix =====
        function generateReceiptCodeWithPrefix(prefix = 'BL') {
            const date = new Date();
            const y = date.getFullYear().toString().slice(2);
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            const todayStr = `${y}${m}${d}`;

            // Äáº¿m sá»‘ biÃªn lai cÃ¹ng prefix trong ngÃ y
            const todayReceipts = receipts.filter(r => {
                const code = r.receiptCode || '';
                return code.startsWith(prefix) && code.includes(todayStr);
            });
            const seq = String(todayReceipts.length + 1).padStart(4, '0');

            return `${prefix}${todayStr}-${seq}`;
        }

        // ===== 2.7 Cáº­p nháº­t tÃ­nh cÃ´ng ná»£ - Trá»« biÃªn lai chi =====
        function calculateDebtForRegistration(regId) {
            const reg = registrations.find(r => r.id === regId);
            if (!reg) return { totalAmount: 0, paidAmount: 0, debtAmount: 0 };

            // Tá»•ng tiá»n = finalAmount (hoáº·c adjustedAmount náº¿u Ä‘Ã£ Ä‘iá»u chá»‰nh)
            const totalAmount = reg.adjustedAmount !== undefined ? reg.adjustedAmount : reg.finalAmount;

            // Láº¥y táº¥t cáº£ biÃªn lai liÃªn káº¿t vá»›i phiáº¿u ÄK nÃ y
            const relatedReceipts = receipts.filter(r => r.registrationId === regId);

            // TÃ­nh tá»•ng thu vÃ  tá»•ng chi
            let totalIncome = 0;  // BiÃªn lai thu
            let totalRefund = 0;  // BiÃªn lai chi (hoÃ n tiá»n)

            relatedReceipts.forEach(r => {
                const amount = parseFloat(r.amount) || 0;
                if (r.isRefund || r.type === 'Phiáº¿u Chi') {
                    totalRefund += amount;
                } else {
                    totalIncome += amount;
                }
            });

            // ÄÃ£ Ä‘Ã³ng = Thu - Chi
            const paidAmount = Math.max(0, totalIncome - totalRefund);

            // CÃ²n ná»£
            const debtAmount = Math.max(0, totalAmount - paidAmount);

            return {
                totalAmount,
                paidAmount,
                debtAmount,
                totalIncome,
                totalRefund
            };
        }

        // ===== 2.8 Xá»­ lÃ½ filter theo thá»i gian =====
        function onReceiptPeriodChange() {
            const period = document.getElementById('receiptPeriodFilter').value;
            const now = new Date();
            let fromDate, toDate;

            switch (period) {
                case 'all':
                    fromDate = null;
                    toDate = null;
                    break;
                case 'thisMonth':
                    fromDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    toDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    break;
                case 'lastMonth':
                    fromDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    toDate = new Date(now.getFullYear(), now.getMonth(), 0);
                    break;
                case 'thisQuarter':
                    const quarter = Math.floor(now.getMonth() / 3);
                    fromDate = new Date(now.getFullYear(), quarter * 3, 1);
                    toDate = new Date(now.getFullYear(), quarter * 3 + 3, 0);
                    break;
                case 'thisYear':
                    fromDate = new Date(now.getFullYear(), 0, 1);
                    toDate = new Date(now.getFullYear(), 11, 31);
                    break;
                case 'custom':
                    // Giá»¯ nguyÃªn giÃ¡ trá»‹ hiá»‡n táº¡i, cho user tá»± chá»n
                    return;
            }

            if (fromDate) {
                document.getElementById('receiptFilterFromDate').value = fromDate.toISOString().split('T')[0];
            } else {
                document.getElementById('receiptFilterFromDate').value = '';
            }

            if (toDate) {
                document.getElementById('receiptFilterToDate').value = toDate.toISOString().split('T')[0];
            } else {
                document.getElementById('receiptFilterToDate').value = '';
            }

            receiptFilterState.period = period;
            filterReceiptsByDate();
        }

        function filterReceiptsByDate() {
            receiptFilterState.fromDate = document.getElementById('receiptFilterFromDate').value || null;
            receiptFilterState.toDate = document.getElementById('receiptFilterToDate').value || null;
            receiptFilterState.type = document.getElementById('receiptTypeFilter').value || 'all';

            paginationState.receipts.page = 1;
            renderReceiptsTable();
        }

        // ===== 2.9 Lá»c biÃªn lai theo Ä‘iá»u kiá»‡n =====
        function getFilteredReceipts() {
            const searchTerm = document.getElementById('searchReceipt')?.value?.toLowerCase() || '';
            let filtered = [...receipts];

            // Lá»c theo thá»i gian
            if (receiptFilterState.fromDate) {
                filtered = filtered.filter(r => r.date >= receiptFilterState.fromDate);
            }
            if (receiptFilterState.toDate) {
                filtered = filtered.filter(r => r.date <= receiptFilterState.toDate);
            }

            // Lá»c theo loáº¡i (thu/chi)
            if (receiptFilterState.type === 'thu') {
                filtered = filtered.filter(r => !r.isRefund && r.type !== 'Phiáº¿u Chi');
            } else if (receiptFilterState.type === 'chi') {
                filtered = filtered.filter(r => r.isRefund || r.type === 'Phiáº¿u Chi');
            }

            // Lá»c theo tá»« khÃ³a
            if (searchTerm) {
                filtered = filtered.filter(r => {
                    const student = students.find(s => s.id === r.studentId);
                    return r.description.toLowerCase().includes(searchTerm) ||
                        student?.name.toLowerCase().includes(searchTerm) ||
                        (r.receiptCode || '').toLowerCase().includes(searchTerm);
                });
            }

            return filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
        }

        // ===== 2.10 Render tá»•ng há»£p biÃªn lai =====
        function renderReceiptSummary(filteredReceipts) {
            let totalIncome = 0;
            let totalExpense = 0;

            filteredReceipts.forEach(r => {
                const amount = parseFloat(r.amount) || 0;
                if (r.isRefund || r.type === 'Phiáº¿u Chi') {
                    totalExpense += amount;
                } else {
                    totalIncome += amount;
                }
            });

            const balance = totalIncome - totalExpense;

            document.getElementById('receiptTotalIncome').textContent = formatCurrencyShort(totalIncome);
            document.getElementById('receiptTotalExpense').textContent = formatCurrencyShort(totalExpense);
            document.getElementById('receiptBalance').textContent = formatCurrencyShort(balance);
            document.getElementById('receiptTotalCount').textContent = filteredReceipts.length;

            // Äá»•i mÃ u sá»‘ dÆ°
            const balanceEl = document.getElementById('receiptBalance');
            balanceEl.style.color = balance >= 0 ? 'var(--btn-success)' : 'var(--btn-danger)';
        }

        // ===== 2.11 Cáº­p nháº­t render báº£ng biÃªn lai =====
        function renderReceiptsTable() {
            const filtered = getFilteredReceipts();

            // Render tá»•ng há»£p
            renderReceiptSummary(filtered);

            const { data, total, totalPages, currentPage } = getPaginatedData(filtered, 'receipts');
            const tbody = document.getElementById('receiptsTableBody');

            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7"><div class="empty-state"><div class="empty-state-icon">ğŸ§¾</div><p>KhÃ´ng cÃ³ biÃªn lai</p></div></td></tr>`;
                renderPagination('receiptsPagination', 'receipts', 0, 0, 1);
                return;
            }

            tbody.innerHTML = data.map((r, idx) => {
                const student = students.find(s => s.id === r.studentId);
                const displayCode = r.receiptCode || `#${String(total - (currentPage - 1) * paginationState.receipts.pageSize - idx).padStart(4, '0')}`;
                const isRefund = r.isRefund || r.type === 'Phiáº¿u Chi';

                // Style khÃ¡c biá»‡t cho biÃªn lai chi
                const rowStyle = isRefund ? 'background: #FEF2F2;' : '';
                const amountClass = isRefund ? 'text-danger' : 'text-success';
                const amountPrefix = isRefund ? '-' : '+';

                // Badge loáº¡i
                const typeBadge = isRefund
                    ? '<span class="status-badge cancel">ğŸ”´ Phiáº¿u Chi</span>'
                    : r.type === 'BiÃªn Lai Äiá»‡n Tá»­'
                        ? '<span class="status-badge da-dk">ğŸ’³ CK</span>'
                        : '<span class="status-badge hoc-thu">ğŸ’µ TM</span>';

                return `
                    <tr style="${rowStyle}">
                        <td><strong>${displayCode}</strong></td>
                        <td>${typeBadge}</td>
                        <td>${student?.name || 'N/A'}</td>
                        <td>${r.description}</td>
                        <td><strong class="${amountClass}">${amountPrefix}${formatCurrency(r.amount)}</strong></td>
                        <td>${formatDate(r.date)}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="action-btn view" onclick="viewReceipt('${r.id}')" title="Xem">ğŸ‘ï¸</button>
                                ${canEdit('receipts') ? `<button class="action-btn edit" onclick="editReceipt('${r.id}')" title="Sá»­a">âœï¸</button>` : ''}
                                ${canDelete('receipts') ? `<button class="action-btn delete" onclick="deleteReceipt('${r.id}')" title="XÃ³a">ğŸ—‘ï¸</button>` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            renderPagination('receiptsPagination', 'receipts', total, totalPages, currentPage);
        }

        // ===== 2.12 Khá»Ÿi táº¡o filter máº·c Ä‘á»‹nh khi vÃ o tab =====
        function initReceiptFilters() {
            // Set máº·c Ä‘á»‹nh lÃ  thÃ¡ng nÃ y
            const now = new Date();
            const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
            const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);

            document.getElementById('receiptFilterFromDate').value = firstDay.toISOString().split('T')[0];
            document.getElementById('receiptFilterToDate').value = lastDay.toISOString().split('T')[0];
            document.getElementById('receiptPeriodFilter').value = 'thisMonth';
            document.getElementById('receiptTypeFilter').value = 'all';

            receiptFilterState = {
                fromDate: firstDay.toISOString().split('T')[0],
                toDate: lastDay.toISOString().split('T')[0],
                type: 'all',
                period: 'thisMonth'
            };
        }

        console.log('ğŸ§¾ Module BiÃªn lai (Thu/Chi + Tá»•ng há»£p) Ä‘Ã£ Ä‘Æ°á»£c táº£i!');
        /* ============================================================
        âœ… MODULE 3: ÄIá»‚M DANH - Sá»¬A & THá»NG KÃŠ
        ============================================================ */

        // ===== 3.1 Biáº¿n lÆ°u trá»¯ tráº¡ng thÃ¡i sá»­a Ä‘iá»ƒm danh =====
        let editAttendanceMode = false;
        let editAttendanceData = {
            date: null,
            classId: null,
            scheduleId: null,
            originalRecords: [],
            changedRecords: []
        };

        let attendanceStatsState = {
            page: 1,
            pageSize: 10,
            classFilter: '',
            periodFilter: 'thisMonth',
            fromDate: null,
            toDate: null
        };

        // ===== 3.2 Xem chi tiáº¿t Ä‘iá»ƒm danh - Cáº¬P NHáº¬T cÃ³ nÃºt sá»­a =====
        function viewAttendanceDetail(date, classId, scheduleId) {
            const cls = classes.find(c => c.id === classId);
            const schedule = classSchedules.find(s => s.id === scheduleId);
            const records = attendances.filter(a =>
                a.attendanceDate === date &&
                a.classId === classId &&
                a.scheduleId === scheduleId
            );

            // LÆ°u thÃ´ng tin Ä‘á»ƒ sá»­a
            editAttendanceData = {
                date,
                classId,
                scheduleId,
                originalRecords: JSON.parse(JSON.stringify(records)),
                changedRecords: []
            };
            editAttendanceMode = false;

            const content = `
                <div class="quick-view-section">
                    <h4>ğŸ“‹ ThÃ´ng tin buá»•i há»c</h4>
                    <div class="quick-view-row"><span class="quick-view-label">Lá»›p:</span><span class="quick-view-value"><strong>${cls ? cls.className : 'N/A'}</strong></span></div>
                    <div class="quick-view-row"><span class="quick-view-label">NgÃ y:</span><span class="quick-view-value">${formatDate(date)}</span></div>
                    <div class="quick-view-row"><span class="quick-view-label">Ca há»c:</span><span class="quick-view-value">${schedule ? schedule.startTime + ' - ' + schedule.endTime : 'N/A'}</span></div>
                    <div class="quick-view-row"><span class="quick-view-label">SÄ© sá»‘:</span><span class="quick-view-value">${records.length} há»c viÃªn</span></div>
                </div>
                <div class="quick-view-section">
                    <h4>ğŸ“Š Chi tiáº¿t Ä‘iá»ƒm danh</h4>
                    <table style="width: 100%; font-size: 13px;" id="attendanceDetailTable">
                        <thead>
                            <tr>
                                <th style="width: 30%;">Há»c viÃªn</th>
                                <th style="width: 35%;">Tráº¡ng thÃ¡i</th>
                                <th style="width: 35%;">Ghi chÃº</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${records.map(r => {
                const student = students.find(s => s.id === r.studentId);
                return `
                                    <tr data-attendance-id="${r.id}">
                                        <td><strong>${student ? student.name : 'N/A'}</strong></td>
                                        <td>
                                            <span class="attendance-status-display">${getAttendanceStatusBadge(r.status)}</span>
                                            <div class="attendance-status-edit d-none">
                                                <select class="edit-attendance-status" data-original="${r.status}" onchange="onAttendanceStatusSelectChange(this, '${r.id}')">
                                                    <option value="present" ${r.status === 'present' ? 'selected' : ''}>âœ… CÃ³ máº·t</option>
                                                    <option value="late" ${r.status === 'late' ? 'selected' : ''}>ğŸŸ¡ Muá»™n</option>
                                                    <option value="absent" ${r.status === 'absent' ? 'selected' : ''}>âŒ Váº¯ng KP</option>
                                                    <option value="excused" ${r.status === 'excused' ? 'selected' : ''}>ğŸ“ CÃ³ phÃ©p</option>
                                                </select>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="attendance-note-display">${r.notes || '<span class="text-muted">-</span>'}</span>
                                            <input type="text" class="attendance-note-edit d-none" value="${r.notes || ''}" placeholder="Ghi chÃº..." style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
                                        </td>
                                    </tr>
                                `;
            }).join('')}
                        </tbody>
                    </table>
                </div>
                <div id="attendanceChangeWarning" class="d-none" style="background: #FEF5E7; padding: 12px; border-radius: 8px; margin-top: 15px; border-left: 4px solid #F39C12;">
                    <p style="margin: 0; font-size: 13px; color: #9A7B0A;">
                        <strong>âš ï¸ LÆ°u Ã½:</strong> Thay Ä‘á»•i tráº¡ng thÃ¡i Ä‘iá»ƒm danh cÃ³ thá»ƒ áº£nh hÆ°á»Ÿng Ä‘áº¿n sá»‘ buá»•i há»c vÃ  yÃªu cáº§u há»c bÃ¹.
                    </p>
                </div>
            `;

            document.getElementById('viewAttendanceContent').innerHTML = content;

            // Reset buttons
            document.getElementById('btnEditAttendanceBatch').classList.remove('d-none');
            document.getElementById('btnSaveAttendanceBatch').classList.add('d-none');
            document.getElementById('btnCancelEditAttendance').classList.add('d-none');
            document.getElementById('btnCloseAttendanceDetail').classList.remove('d-none');

            openModal('viewAttendanceModal');
        }

        // ===== 3.3 Báº­t cháº¿ Ä‘á»™ sá»­a Ä‘iá»ƒm danh =====
        function enableEditAttendanceMode() {
            editAttendanceMode = true;
            editAttendanceData.changedRecords = [];

            // Hiá»‡n cÃ¡c input sá»­a, áº©n display
            document.querySelectorAll('.attendance-status-display').forEach(el => el.classList.add('d-none'));
            document.querySelectorAll('.attendance-status-edit').forEach(el => el.classList.remove('d-none'));
            document.querySelectorAll('.attendance-note-display').forEach(el => el.classList.add('d-none'));
            document.querySelectorAll('.attendance-note-edit').forEach(el => el.classList.remove('d-none'));

            // Hiá»‡n cáº£nh bÃ¡o
            document.getElementById('attendanceChangeWarning').classList.remove('d-none');

            // Äá»•i buttons
            document.getElementById('btnEditAttendanceBatch').classList.add('d-none');
            document.getElementById('btnSaveAttendanceBatch').classList.remove('d-none');
            document.getElementById('btnCancelEditAttendance').classList.remove('d-none');
            document.getElementById('btnCloseAttendanceDetail').classList.add('d-none');

            showNotification('ÄÃ£ báº­t cháº¿ Ä‘á»™ sá»­a. Chá»n tráº¡ng thÃ¡i má»›i vÃ  nháº¥n "LÆ°u thay Ä‘á»•i".', 'info');
        }

        // ===== 3.4 Há»§y sá»­a Ä‘iá»ƒm danh =====
        function cancelEditAttendance() {
            editAttendanceMode = false;
            editAttendanceData.changedRecords = [];

            // Load láº¡i modal
            viewAttendanceDetail(
                editAttendanceData.date,
                editAttendanceData.classId,
                editAttendanceData.scheduleId
            );

            showNotification('ÄÃ£ há»§y thay Ä‘á»•i.', 'info');
        }

        // ===== 3.5 Xá»­ lÃ½ khi thay Ä‘á»•i dropdown tráº¡ng thÃ¡i =====
        function onAttendanceStatusSelectChange(selectEl, attendanceId) {
            const newStatus = selectEl.value;
            const originalStatus = selectEl.dataset.original;

            // TÃ¬m xem Ä‘Ã£ cÃ³ trong changedRecords chÆ°a
            const existingIndex = editAttendanceData.changedRecords.findIndex(r => r.id === attendanceId);

            if (newStatus === originalStatus) {
                // Náº¿u quay láº¡i tráº¡ng thÃ¡i gá»‘c, xÃ³a khá»i changedRecords
                if (existingIndex !== -1) {
                    editAttendanceData.changedRecords.splice(existingIndex, 1);
                }
                selectEl.style.background = '';
            } else {
                // ThÃªm hoáº·c cáº­p nháº­t changedRecords
                const row = selectEl.closest('tr');
                const noteInput = row.querySelector('.attendance-note-edit');

                const changeRecord = {
                    id: attendanceId,
                    oldStatus: originalStatus,
                    newStatus: newStatus,
                    newNotes: noteInput ? noteInput.value : ''
                };

                if (existingIndex !== -1) {
                    editAttendanceData.changedRecords[existingIndex] = changeRecord;
                } else {
                    editAttendanceData.changedRecords.push(changeRecord);
                }

                // Highlight dÃ²ng Ä‘Ã£ thay Ä‘á»•i
                selectEl.style.background = '#FEF9E7';
            }
        }

        // ===== 3.6 LÆ°u thay Ä‘á»•i Ä‘iá»ƒm danh =====
        function saveEditedAttendance() {
            // Cáº­p nháº­t notes cho táº¥t cáº£ cÃ¡c dÃ²ng (ká»ƒ cáº£ khÃ´ng Ä‘á»•i status)
            const rows = document.querySelectorAll('#attendanceDetailTable tbody tr');
            rows.forEach(row => {
                const attendanceId = row.dataset.attendanceId;
                const noteInput = row.querySelector('.attendance-note-edit');
                const statusSelect = row.querySelector('.edit-attendance-status');

                if (!attendanceId) return;

                const newNotes = noteInput ? noteInput.value.trim() : '';
                const newStatus = statusSelect ? statusSelect.value : null;
                const originalStatus = statusSelect ? statusSelect.dataset.original : null;

                // Cáº­p nháº­t notes vÃ o changedRecords náº¿u chÆ°a cÃ³
                const existingIndex = editAttendanceData.changedRecords.findIndex(r => r.id === attendanceId);
                if (existingIndex !== -1) {
                    editAttendanceData.changedRecords[existingIndex].newNotes = newNotes;
                }
            });

            // Náº¿u khÃ´ng cÃ³ thay Ä‘á»•i status nÃ o
            if (editAttendanceData.changedRecords.length === 0) {
                // Váº«n lÆ°u notes
                rows.forEach(row => {
                    const attendanceId = row.dataset.attendanceId;
                    const noteInput = row.querySelector('.attendance-note-edit');
                    if (attendanceId && noteInput) {
                        const att = attendances.find(a => a.id === attendanceId);
                        if (att) {
                            att.notes = noteInput.value.trim();
                        }
                    }
                });

                saveData('attendances', attendances);
                closeModal('viewAttendanceModal');
                loadAttendanceHistory();
                showNotification('ÄÃ£ lÆ°u ghi chÃº!', 'success');
                return;
            }

            // Kiá»ƒm tra cÃ³ thay Ä‘á»•i Ä‘áº·c biá»‡t khÃ´ng (cáº§n confirm)
            const specialChanges = editAttendanceData.changedRecords.filter(r => {
                const toExcused = r.newStatus === 'excused' && r.oldStatus !== 'excused';
                const fromExcused = r.oldStatus === 'excused' && r.newStatus !== 'excused';
                return toExcused || fromExcused;
            });

            if (specialChanges.length > 0) {
                // Xá»­ lÃ½ tá»«ng thay Ä‘á»•i Ä‘áº·c biá»‡t
                processSpecialAttendanceChanges(specialChanges, 0);
            } else {
                // KhÃ´ng cÃ³ thay Ä‘á»•i Ä‘áº·c biá»‡t, lÆ°u trá»±c tiáº¿p
                applyAttendanceChanges(editAttendanceData.changedRecords);
            }
        }

        // ===== 3.7 Xá»­ lÃ½ tá»«ng thay Ä‘á»•i Ä‘áº·c biá»‡t (cáº§n confirm) =====
        function processSpecialAttendanceChanges(changes, index) {
            if (index >= changes.length) {
                // ÄÃ£ xá»­ lÃ½ háº¿t, lÆ°u táº¥t cáº£ thay Ä‘á»•i
                applyAttendanceChanges(editAttendanceData.changedRecords);
                return;
            }

            const change = changes[index];
            const attendance = attendances.find(a => a.id === change.id);
            const student = attendance ? students.find(s => s.id === attendance.studentId) : null;
            const studentName = student ? student.name : 'Há»c viÃªn';

            let title, content, btnText;

            if (change.newStatus === 'excused' && change.oldStatus !== 'excused') {
                // Chuyá»ƒn sang CÃ³ phÃ©p â†’ Táº¡o yÃªu cáº§u há»c bÃ¹
                title = 'ğŸ“ Táº¡o yÃªu cáº§u há»c bÃ¹?';
                content = `
                    <p>Báº¡n Ä‘ang chuyá»ƒn tráº¡ng thÃ¡i cá»§a <strong>${studentName}</strong> tá»« <strong>${getStatusLabel(change.oldStatus)}</strong> sang <strong>CÃ³ phÃ©p</strong>.</p>
                    <div style="background: #E8F4FD; padding: 12px; border-radius: 8px; margin: 15px 0;">
                        <p style="margin: 0; font-size: 13px; color: #1A5276;">
                            âœ… Há»‡ thá»‘ng sáº½:<br>
                            â€¢ Cá»™ng láº¡i 1 buá»•i há»c (náº¿u trÆ°á»›c Ä‘Ã³ Ä‘Ã£ trá»«)<br>
                            â€¢ Táº¡o yÃªu cáº§u há»c bÃ¹ cho há»c viÃªn
                        </p>
                    </div>
                    <p><strong>Báº¡n cÃ³ muá»‘n tiáº¿p tá»¥c?</strong></p>
                `;
                btnText = 'âœ… XÃ¡c nháº­n & Táº¡o há»c bÃ¹';
            } else if (change.oldStatus === 'excused' && change.newStatus !== 'excused') {
                // Tá»« CÃ³ phÃ©p â†’ Tráº¡ng thÃ¡i khÃ¡c â†’ XÃ³a yÃªu cáº§u há»c bÃ¹
                title = 'âš ï¸ XÃ³a yÃªu cáº§u há»c bÃ¹?';
                content = `
                    <p>Báº¡n Ä‘ang chuyá»ƒn tráº¡ng thÃ¡i cá»§a <strong>${studentName}</strong> tá»« <strong>CÃ³ phÃ©p</strong> sang <strong>${getStatusLabel(change.newStatus)}</strong>.</p>
                    <div style="background: #FDEDEC; padding: 12px; border-radius: 8px; margin: 15px 0;">
                        <p style="margin: 0; font-size: 13px; color: #922B21;">
                            âš ï¸ Há»‡ thá»‘ng sáº½:<br>
                            â€¢ Trá»« 1 buá»•i há»c<br>
                            â€¢ <strong>XÃ“A</strong> yÃªu cáº§u há»c bÃ¹ Ä‘Ã£ táº¡o (náº¿u cÃ³)
                        </p>
                    </div>
                    <p><strong>Báº¡n cÃ³ muá»‘n tiáº¿p tá»¥c?</strong></p>
                `;
                btnText = 'âš ï¸ XÃ¡c nháº­n & XÃ³a há»c bÃ¹';
            }

            // LÆ°u thÃ´ng tin Ä‘á»ƒ xá»­ lÃ½ sau khi confirm
            document.getElementById('confirmAttendanceId').value = change.id;
            document.getElementById('confirmAttendanceOldStatus').value = change.oldStatus;
            document.getElementById('confirmAttendanceNewStatus').value = change.newStatus;

            document.getElementById('confirmAttendanceChangeTitle').textContent = title;
            document.getElementById('confirmAttendanceChangeContent').innerHTML = content;
            document.getElementById('btnConfirmAttendanceChange').textContent = btnText;

            // LÆ°u index Ä‘á»ƒ tiáº¿p tá»¥c xá»­ lÃ½
            document.getElementById('btnConfirmAttendanceChange').onclick = function () {
                closeModal('confirmAttendanceChangeModal');
                // ÄÃ¡nh dáº¥u change nÃ y Ä‘Ã£ Ä‘Æ°á»£c confirm
                change.confirmed = true;
                // Xá»­ lÃ½ tiáº¿p
                processSpecialAttendanceChanges(changes, index + 1);
            };

            openModal('confirmAttendanceChangeModal');
        }

        // ===== 3.8 Helper: Láº¥y label tráº¡ng thÃ¡i =====
        function getStatusLabel(status) {
            const labels = {
                'present': 'CÃ³ máº·t',
                'late': 'Muá»™n',
                'absent': 'Váº¯ng khÃ´ng phÃ©p',
                'excused': 'CÃ³ phÃ©p'
            };
            return labels[status] || status;
        }

        // ===== 3.9 Ãp dá»¥ng táº¥t cáº£ thay Ä‘á»•i Ä‘iá»ƒm danh =====
        function applyAttendanceChanges(changes) {
            let makeupCreated = 0;
            let makeupDeleted = 0;

            changes.forEach(change => {
                const attendance = attendances.find(a => a.id === change.id);
                if (!attendance) return;

                const oldStatus = change.oldStatus;
                const newStatus = change.newStatus;

                // Cáº­p nháº­t tráº¡ng thÃ¡i vÃ  ghi chÃº
                attendance.status = newStatus;
                attendance.notes = change.newNotes || attendance.notes;
                attendance.updatedAt = new Date().toISOString();
                attendance.updatedBy = currentUser?.id || null;

                // Xá»­ lÃ½ logic sá»‘ buá»•i vÃ  há»c bÃ¹
                const cs = classStudents.find(c => c.id === attendance.classStudentId);

                if (cs) {
                    // XÃ¡c Ä‘á»‹nh nhÃ³m tráº¡ng thÃ¡i
                    const deductGroup = ['present', 'late', 'absent'];
                    const wasDeducted = deductGroup.includes(oldStatus);
                    const willDeduct = deductGroup.includes(newStatus);
                    const wasExcused = oldStatus === 'excused';
                    const willExcuse = newStatus === 'excused';

                    // CASE 1: Tá»« trá»« buá»•i â†’ CÃ³ phÃ©p (cá»™ng láº¡i 1 buá»•i, táº¡o há»c bÃ¹)
                    if (wasDeducted && willExcuse) {
                        cs.completedSessions = Math.max(0, cs.completedSessions - 1);
                        cs.remainingSessions++;
                        if (cs.status === 'completed') cs.status = 'active';

                        // Táº¡o yÃªu cáº§u há»c bÃ¹
                        createMakeupRequestForAttendance(attendance);
                        makeupCreated++;
                    }

                    // CASE 2: Tá»« CÃ³ phÃ©p â†’ Trá»« buá»•i (trá»« 1 buá»•i, xÃ³a há»c bÃ¹)
                    else if (wasExcused && willDeduct) {
                        cs.completedSessions++;
                        cs.remainingSessions = Math.max(0, cs.remainingSessions - 1);
                        if (cs.remainingSessions === 0) cs.status = 'completed';

                        // XÃ³a yÃªu cáº§u há»c bÃ¹ liÃªn quan
                        const deleted = deleteMakeupRequestForAttendance(attendance.id);
                        if (deleted) makeupDeleted++;
                    }

                    // CASE 3: Chuyá»ƒn trong cÃ¹ng nhÃ³m (khÃ´ng thay Ä‘á»•i sá»‘ buá»•i)
                    // KhÃ´ng cáº§n xá»­ lÃ½ gÃ¬ thÃªm
                }
            });

            // LÆ°u táº¥t cáº£
            saveData('attendances', attendances);
            saveData('classStudents', classStudents);
            saveData('makeupRequests', makeupRequests);

            // ÄÃ³ng modal vÃ  refresh
            closeModal('viewAttendanceModal');
            loadAttendanceHistory();
            loadTodaySchedules();

            // ThÃ´ng bÃ¡o káº¿t quáº£
            let msg = `âœ… ÄÃ£ lÆ°u ${changes.length} thay Ä‘á»•i Ä‘iá»ƒm danh!`;
            if (makeupCreated > 0) msg += ` Táº¡o ${makeupCreated} yÃªu cáº§u há»c bÃ¹.`;
            if (makeupDeleted > 0) msg += ` XÃ³a ${makeupDeleted} yÃªu cáº§u há»c bÃ¹.`;
            showNotification(msg, 'success');

            // Refresh tab há»c bÃ¹ náº¿u cáº§n
            if (makeupCreated > 0 || makeupDeleted > 0) {
                if (typeof renderMakeupRequests === 'function') {
                    renderMakeupRequests();
                }
            }
        }

        // ===== 3.10 Táº¡o yÃªu cáº§u há»c bÃ¹ tá»« Ä‘iá»ƒm danh =====
        function createMakeupRequestForAttendance(attendance) {
            // Kiá»ƒm tra Ä‘Ã£ cÃ³ yÃªu cáº§u chÆ°a
            const existing = makeupRequests.find(m => m.originalAttendanceId === attendance.id);
            if (existing) {
                console.log('YÃªu cáº§u há»c bÃ¹ Ä‘Ã£ tá»“n táº¡i:', existing.id);
                return existing;
            }

            const cs = classStudents.find(c => c.id === attendance.classStudentId);
            if (!cs) return null;

            // TÃ­nh ngÃ y háº¿t háº¡n (30 ngÃ y tá»« ngÃ y nghá»‰)
            const expiryDate = new Date(attendance.attendanceDate);
            expiryDate.setDate(expiryDate.getDate() + 30);

            const newRequest = {
                id: generateId(),
                studentId: cs.studentId,
                classStudentId: attendance.classStudentId,
                originalAttendanceId: attendance.id,
                originalClassId: attendance.classId,
                originalScheduleId: attendance.scheduleId,
                originalDate: attendance.attendanceDate,
                requestDate: new Date().toISOString().split('T')[0],
                expiryDate: expiryDate.toISOString().split('T')[0],
                makeupClassId: null,
                makeupScheduleId: null,
                makeupDate: null,
                status: 'pending',
                approvedBy: null,
                approvedAt: null,
                completedAt: null,
                notes: 'Táº¡o tá»« sá»­a Ä‘iá»ƒm danh',
                isPreCreated: false,
                createdAt: new Date().toISOString()
            };

            makeupRequests.push(newRequest);
            console.log('ÄÃ£ táº¡o yÃªu cáº§u há»c bÃ¹:', newRequest.id);
            return newRequest;
        }

        // ===== 3.11 XÃ³a yÃªu cáº§u há»c bÃ¹ theo attendanceId =====
        function deleteMakeupRequestForAttendance(attendanceId) {
            const index = makeupRequests.findIndex(m => m.originalAttendanceId === attendanceId);
            if (index !== -1) {
                const deleted = makeupRequests[index];
                makeupRequests.splice(index, 1);
                console.log('ÄÃ£ xÃ³a yÃªu cáº§u há»c bÃ¹:', deleted.id);
                return true;
            }
            return false;
        }

        // ===== 3.12 Thá»‘ng kÃª Ä‘iá»ƒm danh theo há»c viÃªn =====
        function loadAttendanceStatsByStudent() {
            const classFilter = document.getElementById('attendanceStatClassFilter')?.value || '';
            const tbody = document.getElementById('attendanceStatsByStudentBody');

            // TÃ­nh toÃ¡n khoáº£ng thá»i gian
            const { fromDate, toDate } = getAttendanceStatDateRange();

            // Lá»c Ä‘iá»ƒm danh theo thá»i gian
            let filteredAttendances = attendances.filter(a => {
                if (fromDate && a.attendanceDate < fromDate) return false;
                if (toDate && a.attendanceDate > toDate) return false;
                return true;
            });

            // Lá»c theo lá»›p náº¿u cÃ³
            if (classFilter) {
                filteredAttendances = filteredAttendances.filter(a => a.classId === classFilter);
            }

            // NhÃ³m theo há»c viÃªn + lá»›p
            const statsMap = {};

            filteredAttendances.forEach(a => {
                const key = `${a.studentId}_${a.classId}`;
                if (!statsMap[key]) {
                    statsMap[key] = {
                        studentId: a.studentId,
                        classId: a.classId,
                        total: 0,
                        present: 0,
                        late: 0,
                        absent: 0,
                        excused: 0
                    };
                }

                statsMap[key].total++;
                if (a.status === 'present') statsMap[key].present++;
                else if (a.status === 'late') statsMap[key].late++;
                else if (a.status === 'absent') statsMap[key].absent++;
                else if (a.status === 'excused') statsMap[key].excused++;
            });

            const statsList = Object.values(statsMap);

            if (statsList.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">KhÃ´ng cÃ³ dá»¯ liá»‡u Ä‘iá»ƒm danh trong khoáº£ng thá»i gian nÃ y</td></tr>';
                document.getElementById('attendanceStatsPagination').innerHTML = '';
                return;
            }

            // Sáº¯p xáº¿p theo tÃªn há»c viÃªn
            statsList.sort((a, b) => {
                const studentA = students.find(s => s.id === a.studentId);
                const studentB = students.find(s => s.id === b.studentId);
                return (studentA?.name || '').localeCompare(studentB?.name || '');
            });

            // PhÃ¢n trang
            const pageSize = attendanceStatsState.pageSize;
            const currentPage = attendanceStatsState.page;
            const total = statsList.length;
            const totalPages = Math.ceil(total / pageSize);
            const startIndex = (currentPage - 1) * pageSize;
            const pageData = statsList.slice(startIndex, startIndex + pageSize);

            tbody.innerHTML = pageData.map(stat => {
                const student = students.find(s => s.id === stat.studentId);
                const cls = classes.find(c => c.id === stat.classId);
                const attendanceRate = stat.total > 0
                    ? Math.round(((stat.present + stat.late) / stat.total) * 100)
                    : 0;

                const rateClass = attendanceRate >= 80 ? 'text-success' : attendanceRate >= 60 ? 'text-warning' : 'text-danger';

                return `
                    <tr>
                        <td><strong>${student ? student.name : 'N/A'}</strong></td>
                        <td>${cls ? cls.className : 'N/A'}</td>
                        <td>${stat.total}</td>
                        <td class="text-success">${stat.present}</td>
                        <td class="text-warning">${stat.late}</td>
                        <td class="text-danger">${stat.absent}</td>
                        <td class="text-primary">${stat.excused}</td>
                        <td><strong class="${rateClass}">${attendanceRate}%</strong></td>
                        <td>
                            <button class="action-btn view" onclick="viewStudentAttendanceDetail('${stat.studentId}', '${stat.classId}')" title="Xem chi tiáº¿t">ğŸ‘ï¸</button>
                        </td>
                    </tr>
                `;
            }).join('');

            // Render phÃ¢n trang
            renderAttendanceStatsPagination(total, totalPages, currentPage);
        }

        // ===== 3.13 Láº¥y khoáº£ng thá»i gian thá»‘ng kÃª =====
        function getAttendanceStatDateRange() {
            const period = document.getElementById('attendanceStatPeriodFilter')?.value || 'thisMonth';
            const now = new Date();
            let fromDate, toDate;

            switch (period) {
                case 'thisMonth':
                    fromDate = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
                    toDate = new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString().split('T')[0];
                    break;
                case 'lastMonth':
                    fromDate = new Date(now.getFullYear(), now.getMonth() - 1, 1).toISOString().split('T')[0];
                    toDate = new Date(now.getFullYear(), now.getMonth(), 0).toISOString().split('T')[0];
                    break;
                case 'thisQuarter':
                    const quarter = Math.floor(now.getMonth() / 3);
                    fromDate = new Date(now.getFullYear(), quarter * 3, 1).toISOString().split('T')[0];
                    toDate = new Date(now.getFullYear(), quarter * 3 + 3, 0).toISOString().split('T')[0];
                    break;
                case 'all':
                    fromDate = null;
                    toDate = null;
                    break;
            }

            return { fromDate, toDate };
        }

        function onAttendanceStatPeriodChange() {
            attendanceStatsState.page = 1;
            loadAttendanceStatsByStudent();
        }

        // ===== 3.14 PhÃ¢n trang thá»‘ng kÃª =====
        function renderAttendanceStatsPagination(total, totalPages, currentPage) {
            const container = document.getElementById('attendanceStatsPagination');
            if (!container) return;

            const pageSize = attendanceStatsState.pageSize;
            const startItem = total === 0 ? 0 : (currentPage - 1) * pageSize + 1;
            const endItem = Math.min(currentPage * pageSize, total);

            let html = `<button ${currentPage <= 1 ? 'disabled' : ''} onclick="changeAttendanceStatsPage(${currentPage - 1})">â€¹</button>`;

            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                    html += `<button class="${i === currentPage ? 'active' : ''}" onclick="changeAttendanceStatsPage(${i})">${i}</button>`;
                } else if (i === currentPage - 2 || i === currentPage + 2) {
                    html += `<button disabled>...</button>`;
                }
            }

            html += `<button ${currentPage >= totalPages ? 'disabled' : ''} onclick="changeAttendanceStatsPage(${currentPage + 1})">â€º</button>`;

            container.innerHTML = `
                <div class="pagination-info">Hiá»ƒn thá»‹ ${startItem}-${endItem} / ${total}</div>
                <div class="pagination">${html}</div>
            `;
        }

        function changeAttendanceStatsPage(page) {
            attendanceStatsState.page = page;
            loadAttendanceStatsByStudent();
        }

        // ===== 3.15 Xem chi tiáº¿t Ä‘iá»ƒm danh cá»§a 1 há»c viÃªn trong 1 lá»›p =====
        function viewStudentAttendanceDetail(studentId, classId) {
            const student = students.find(s => s.id === studentId);
            const cls = classes.find(c => c.id === classId);
            const { fromDate, toDate } = getAttendanceStatDateRange();

            // Lá»c Ä‘iá»ƒm danh cá»§a há»c viÃªn nÃ y trong lá»›p nÃ y
            let studentAttendances = attendances.filter(a =>
                a.studentId === studentId &&
                a.classId === classId
            );

            if (fromDate) {
                studentAttendances = studentAttendances.filter(a => a.attendanceDate >= fromDate);
            }
            if (toDate) {
                studentAttendances = studentAttendances.filter(a => a.attendanceDate <= toDate);
            }

            // Sáº¯p xáº¿p theo ngÃ y má»›i nháº¥t
            studentAttendances.sort((a, b) => new Date(b.attendanceDate) - new Date(a.attendanceDate));

            const content = `
                <div class="quick-view-section">
                    <h4>ğŸ‘¤ ThÃ´ng tin</h4>
                    <div class="quick-view-row"><span class="quick-view-label">Há»c viÃªn:</span><span class="quick-view-value"><strong>${student ? student.name : 'N/A'}</strong></span></div>
                    <div class="quick-view-row"><span class="quick-view-label">Lá»›p:</span><span class="quick-view-value">${cls ? cls.className : 'N/A'}</span></div>
                    <div class="quick-view-row"><span class="quick-view-label">Khoáº£ng thá»i gian:</span><span class="quick-view-value">${fromDate ? formatDate(fromDate) : 'Äáº§u'} - ${toDate ? formatDate(toDate) : 'Nay'}</span></div>
                </div>
                <div class="quick-view-section">
                    <h4>ğŸ“‹ Chi tiáº¿t ${studentAttendances.length} buá»•i</h4>
                    <div style="max-height: 400px; overflow-y: auto;">
                        <table style="width: 100%; font-size: 13px;">
                            <thead>
                                <tr><th>NgÃ y</th><th>Ca há»c</th><th>Tráº¡ng thÃ¡i</th><th>Ghi chÃº</th></tr>
                            </thead>
                            <tbody>
                                ${studentAttendances.map(a => {
                const schedule = classSchedules.find(s => s.id === a.scheduleId);
                return `
                                        <tr>
                                            <td>${formatDate(a.attendanceDate)}</td>
                                            <td>${schedule ? schedule.startTime + '-' + schedule.endTime : '-'}</td>
                                            <td>${getAttendanceStatusBadge(a.status)}</td>
                                            <td>${a.notes || '-'}</td>
                                        </tr>
                                    `;
            }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            document.getElementById('viewAttendanceContent').innerHTML = content;

            // áº¨n cÃ¡c nÃºt sá»­a
            document.getElementById('btnEditAttendanceBatch').classList.add('d-none');
            document.getElementById('btnSaveAttendanceBatch').classList.add('d-none');
            document.getElementById('btnCancelEditAttendance').classList.add('d-none');
            document.getElementById('btnCloseAttendanceDetail').classList.remove('d-none');

            openModal('viewAttendanceModal');
        }

        // ===== 3.16 Populate dropdown lá»›p cho filter thá»‘ng kÃª =====
        function populateAttendanceStatClassFilter() {
            const select = document.getElementById('attendanceStatClassFilter');
            if (!select) return;

            const activeClasses = classes.filter(c => c.status === 'active' || c.status === 'new');
            select.innerHTML = '<option value="">Táº¥t cáº£ lá»›p</option>' +
                activeClasses.map(c => {
                    const subject = subjects.find(s => s.id === c.subjectId);
                    return `<option value="${c.id}">${c.className}${subject ? ' - ' + subject.name : ''}</option>`;
                }).join('');
        }

        // ===== 3.17 Export thá»‘ng kÃª Ä‘iá»ƒm danh theo há»c viÃªn =====
        function exportAttendanceStatsByStudent() {
            const classFilter = document.getElementById('attendanceStatClassFilter')?.value || '';
            const { fromDate, toDate } = getAttendanceStatDateRange();

            let filteredAttendances = attendances.filter(a => {
                if (fromDate && a.attendanceDate < fromDate) return false;
                if (toDate && a.attendanceDate > toDate) return false;
                if (classFilter && a.classId !== classFilter) return false;
                return true;
            });

            // NhÃ³m theo há»c viÃªn + lá»›p
            const statsMap = {};
            filteredAttendances.forEach(a => {
                const key = `${a.studentId}_${a.classId}`;
                if (!statsMap[key]) {
                    statsMap[key] = {
                        studentId: a.studentId,
                        classId: a.classId,
                        total: 0,
                        present: 0,
                        late: 0,
                        absent: 0,
                        excused: 0
                    };
                }
                statsMap[key].total++;
                if (a.status === 'present') statsMap[key].present++;
                else if (a.status === 'late') statsMap[key].late++;
                else if (a.status === 'absent') statsMap[key].absent++;
                else if (a.status === 'excused') statsMap[key].excused++;
            });

            const data = Object.values(statsMap).map(stat => {
                const student = students.find(s => s.id === stat.studentId);
                const cls = classes.find(c => c.id === stat.classId);
                const rate = stat.total > 0 ? Math.round(((stat.present + stat.late) / stat.total) * 100) : 0;

                return {
                    'Há»c viÃªn': student ? student.name : '',
                    'Lá»›p': cls ? cls.className : '',
                    'Tá»•ng buá»•i': stat.total,
                    'CÃ³ máº·t': stat.present,
                    'Muá»™n': stat.late,
                    'Váº¯ng KP': stat.absent,
                    'CÃ³ phÃ©p': stat.excused,
                    'Tá»· lá»‡ CM (%)': rate
                };
            });

            if (data.length === 0) {
                showNotification('KhÃ´ng cÃ³ dá»¯ liá»‡u Ä‘á»ƒ xuáº¥t!', 'warning');
                return;
            }

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data), 'Thá»‘ng kÃª Ä‘iá»ƒm danh');
            XLSX.writeFile(wb, `ThongKeDiemDanh_${formatDateFile()}.xlsx`);
            showNotification('Xuáº¥t Excel thÃ nh cÃ´ng!', 'success');
        }

        // ===== 3.18 Cáº­p nháº­t initAttendanceTab Ä‘á»ƒ load thá»‘ng kÃª =====
        const originalInitAttendanceTab = typeof initAttendanceTab === 'function' ? initAttendanceTab : null;

        function initAttendanceTab() {
            // Set ngÃ y máº·c Ä‘á»‹nh lÃ  hÃ´m nay
            document.getElementById('attendanceDate').value = new Date().toISOString().split('T')[0];

            // Populate dropdown lá»›p há»c
            populateAttendanceClassDropdown();

            // Load lá»‹ch há»c hÃ´m nay
            loadTodaySchedules();

            // Load lá»‹ch sá»­ Ä‘iá»ƒm danh
            loadAttendanceHistory();

            // Populate filter cho thá»‘ng kÃª
            populateAttendanceStatClassFilter();

            // Load thá»‘ng kÃª theo há»c viÃªn
            loadAttendanceStatsByStudent();
        }

        console.log('âœ… Module Äiá»ƒm danh (Sá»­a & Thá»‘ng kÃª) Ä‘Ã£ Ä‘Æ°á»£c táº£i!');

        console.log('ğŸ“¦ Profile 001 - Code loaded successfully!');